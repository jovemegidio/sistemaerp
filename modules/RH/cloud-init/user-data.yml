#cloud-config
# User-data para criar um droplet pronto para executar a app RH
# Uso: coloque este conteúdo no campo "User data" ao criar o Droplet (DigitalOcean)

users:
  - name: deploy
    gecos: Deploy User
    sudo: ['ALL=(ALL) NOPASSWD:ALL']
    shell: /bin/bash
    lock_passwd: true
    ssh_authorized_keys:
      - ssh-rsa AAAA...REPLACE_WITH_YOUR_PUBLIC_KEY... user@host

package_update: true
package_upgrade: true
packages:
  - git
  - curl
  - nginx
  - ufw

write_files:
  - path: /etc/motd
    content: |
      Portal RH Aluforce - provisioned by cloud-init

runcmd:
  # criar diretórios e permissões
  - [ mkdir, -p, /var/www/rh-app ]
  - [ chown, -R, deploy:deploy, /var/www ]

  # instalar Node.js LTS (NodeSource)
  - curl -fsSL https://deb.nodesource.com/setup_18.x | bash -
  - apt-get install -y nodejs build-essential

  # instalar pm2 globalmente
  - npm install -g pm2

  # configurar firewall básico
  - ufw allow OpenSSH
  - ufw allow 'Nginx Full'
  - ufw --force enable

  # clonar repositório (substitua OWNER/REPO abaixo)
  - su - deploy -c "git clone https://github.com/<OWNER>/<REPO>.git /var/www/rh-app || (cd /var/www/rh-app && git fetch --all --prune && git reset --hard origin/main)"

  # instalar dependências como usuário deploy
  - su - deploy -c "cd /var/www/rh-app && npm ci --production"

  # criar arquivo .env mínimo (substitua valores sensíveis)
  - |
    cat > /var/www/rh-app/.env <<'EOF'
    DB_HOST=localhost
    DB_USER=root
    DB_PASS=@dminalu
    DB_NAME=aluforce_vendas
    JWT_SECRET=change-this-secret
    PORT=3000
    EOF
  - chown deploy:deploy /var/www/rh-app/.env
  - chmod 600 /var/www/rh-app/.env

  # iniciar app com PM2
  - su - deploy -c "cd /var/www/rh-app && pm2 start ecosystem.config.js --env production || pm2 restart rh-app || pm2 start ecosystem.config.js --env production"
  - su - deploy -c "pm2 save"
  - su - deploy -c "pm2 startup systemd -u deploy --hp /home/deploy | sed -n '1,200p'"

  # configurar e reiniciar nginx (assume server_name será configurado depois)
  - rm -f /etc/nginx/sites-enabled/default
  - |
    cat > /etc/nginx/sites-available/rh-app <<'NGINX'
    server {
      listen 80;
      server_name exemplo.com; # <-- substitua pelo seu domínio

      location / {
        proxy_pass http://127.0.0.1:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
      }
    }
    NGINX
  - ln -s /etc/nginx/sites-available/rh-app /etc/nginx/sites-enabled/rh-app || true
  - nginx -t && systemctl reload nginx

  # observação: TLS (Let's Encrypt) requer domínio apontado; executar manualmente quando estiver pronto
  - echo "Para obter TLS com Certbot: sudo apt install -y certbot python3-certbot-nginx && sudo certbot --nginx -d seu-dominio.com"

final_message: "Cloud-init finished. Aceda ao droplet e verifique /var/www/rh-app e pm2 status. Substitua valores placeholders no .env e no nginx server_name."
