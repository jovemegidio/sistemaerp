<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <link rel="icon" type="image/x-icon" href="/favicon-aluforce.webp">
    
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Relatórios Financeiros - Aluforce</title>
    <link rel="stylesheet" href="../../_shared/modern-saas.cssv=3.0">
    <link rel="stylesheet" href="../../_shared/header-sidebar.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        .report-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
            background: white;
            padding: 10px;
            border-radius: 12px;
            box-shaçãow: 0 2px 8px rgba(0,0,0,0.05);
            overflow-x: auto;
        }

        .report-tab {
            padding: 14px 28px;
            border: none;
            background: transparent;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
            color: #64748b;
            white-space: nowrap;
        }

        .report-tab:hover {
            background: #f3f4f6;
            color: #1f2937;
        }

        .report-tab.active {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
            box-shaçãow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        .report-content {
            display: none;
        }

        .report-content.active {
            display: block;
        }

        .filters-section {
            background: white;
            padding: 24px;
            border-radius: 12px;
            margin-bottom: 24px;
            box-shaçãow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 16px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .filter-label {
            font-size: 13px;
            font-weight: 600;
            color: #374151;
        }

        .filter-input, .filter-select {
            padding: 10px 12px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 14px;
        }

        .actions-bar {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #1e40af, #1e3a8a);
            color: white;
        }

        .btn-secondary {
            background: #f3f4f6;
            color: #374151;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shaçãow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
            gap: 24px;
            margin-bottom: 24px;
        }

        .chart-card {
            background: white;
            padding: 28px;
            border-radius: 12px;
            box-shaçãow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .chart-header {
            margin-bottom: 20px;
        }

        .chart-title {
            font-size: 18px;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 4px;
        }

        .chart-subtitle {
            font-size: 13px;
            color: #6b7280;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: white;
            padding: 24px;
            border-radius: 12px;
            box-shaçãow: 0 2px 8px rgba(0,0,0,0.05);
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: var(--stat-color);
        }

        .stat-icon {
            width: 48px;
            height: 48px;
            border-radius: 10px;
            background: var(--stat-bg);
            color: var(--stat-color);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            margin-bottom: 16px;
        }

        .stat-value {
            font-size: 26px;
            font-weight: 800;
            color: #1f2937;
            margin-bottom: 6px;
        }

        .stat-label {
            font-size: 13px;
            color: #6b7280;
            font-weight: 600;
        }

        .report-cards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }

        .report-card {
            background: white;
            padding: 24px;
            border-radius: 12px;
            box-shaçãow: 0 2px 8px rgba(0,0,0,0.05);
            cursor: pointer;
            transition: all 0.3s;
            border-left: 4px solid var(--card-color);
        }

        .report-card:hover {
            transform: translateY(-4px);
            box-shaçãow: 0 8px 20px rgba(0,0,0,0.12);
        }

        .report-card-icon {
            width: 56px;
            height: 56px;
            border-radius: 12px;
            background: var(--card-bg);
            color: var(--card-color);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 26px;
            margin-bottom: 16px;
        }

        .report-card-title {
            font-size: 16px;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 8px;
        }

        .report-card-desc {
            font-size: 13px;
            color: #6b7280;
            line-height: 1.5;
        }
    </style></head>
<body>
    <div class="container-principal">
        <!-- Sidebar padrão PCP -->
        <aside class="sidebar">
            <nav class="sidebar-nav">
                <ul>
                    <li>
                        <a href="index.html" class="nav-link" title="Dashboard">
                            <span class="nav-icon"><i class="fas fa-chart-pie"></i></span>
                            <span class="nav-tooltip">Dashboard</span>
                        </a>
                    </li>
                    <li>
                        <a href="contas_receber.html" class="nav-link" title="Contas a Receber">
                            <span class="nav-icon"><i class="fas fa-arrow-down"></i></span>
                            <span class="nav-tooltip">Contas a Receber</span>
                        </a>
                    </li>
                    <li>
                        <a href="contas_pagar.html" class="nav-link" title="Contas a Pagar">
                            <span class="nav-icon"><i class="fas fa-arrow-up"></i></span>
                            <span class="nav-tooltip">Contas a Pagar</span>
                        </a>
                    </li>
                    <li>
                        <a href="fluxo_caixa.html" class="nav-link" title="Fluxo de Caixa">
                            <span class="nav-icon"><i class="fas fa-chart-line"></i></span>
                            <span class="nav-tooltip">Fluxo de Caixa</span>
                        </a>
                    </li>
                    <li>
                        <a href="contas_bancarias.html" class="nav-link" title="Bancos">
                            <span class="nav-icon"><i class="fas fa-university"></i></span>
                            <span class="nav-tooltip">Bancos</span>
                        </a>
                    </li>
                    <li>
                        <a href="../conciliacao_bancaria.html" class="nav-link" title="Conciliação">
                            <span class="nav-icon"><i class="fas fa-check-double"></i></span>
                            <span class="nav-tooltip">Conciliação</span>
                        </a>
                    </li>
                    <li>
                        <a href="relatorios.html" class="nav-link active" title="Relatórios">
                            <span class="nav-icon"><i class="fas fa-file-alt"></i></span>
                            <span class="nav-tooltip">Relatórios</span>
                        </a>
                    </li>
                    <li>
                        <a href="../centros_custo_categorias.html" class="nav-link" title="Configurações">
                            <span class="nav-icon"><i class="fas fa-cog"></i></span>
                            <span class="nav-tooltip">Configurações</span>
                        </a>
                    </li>
                    <li>
                        <a href="" class="nav-link" title="Painel de Controle">
                            <span class="nav-icon"><i class="fas fa-home"></i></span>
                            <span class="nav-tooltip">Painel de Controle</span>
                        </a>
                    </li>
                </ul>
            </nav>
        </aside>

        <div id="sidebar-overlay"></div>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Topbar -->
            <header class="topbar">
    <link rel="icon" type="image/x-icon" href="/favicon-aluforce.webp">
                <div class="topbar-left">
                    <button id="toggle-sidebar" class="btn-toggle-sidebar">
                        <i class="fas fa-bars"></i>
                    </button>
                    <img src="/images/Logo Monocromatico - Azul - Aluforce.webp" alt="Aluforce" class="header-logo" style="height: 32px;">
                </div>
                
                <div class="topbar-center">
                    <h1 class="page-title">Relatórios Financeiros</h1>
                </div>
                
                <div class="topbar-right">
                    <!-- Sistema de Notificações -->
                    <div class="notification-center" style="position: relative; margin-right: 12px;">
                        <button id="notification-bell" class="notification-bell" title="Notificações" style="background: none; border: none; font-size: 18px; color: #64748b; cursor: pointer; padding: 10px; border-radius: 8px; transition: all 0.2s; position: relative;">
                            <i class="fas fa-bell"></i>
                            <span class="notification-badge" id="notification-count" style="display: none; position: absolute; top: 2px; right: 2px; background: #ef4444; color: white; font-size: 10px; padding: 2px 6px; border-radius: 10px; min-width: 18px;">0</span>
                        </button>
                    </div>
                    
                    <!-- Saudação do Usuário -->
                    <div class="user-greeting" style="display: flex; align-items: center; gap: 10px; margin-right: 16px;">
                        <span style="color: #64748b; font-size: 13px;"><span id="greeting-text">Bom dia</span>, <strong id="user-name" style="color: #1e293b;">Usuário</strong></span>
                        <div class="user-avatar" id="user-avatar" style="width: 36px; height: 36px; border-radius: 50%; background: linear-gradient(135deg, #3b82f6, #1d4ed8); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; overflow: hidden;">
                            <img src="" alt="Foto" id="user-photo" style="width: 100%; height: 100%; object-fit: cover; display: none;">
                            <span id="user-initial">U</span>
                        </div>
                    </div>
                    
                    <button class="topbar-btn" onclick="exportarRelatorio()">
                        <i class="fas fa-download"></i> Exportar
                    </button>
                </div>
            </header>

            <!-- Content Area -->
            <div class="content-area">
                <!-- Tabs -->
                <div class="report-tabs">
                    <button class="report-tab active" onclick="trocarAba('geral', this)">
                        <i class="fas fa-chart-pie"></i> Visão Geral
                    </button>
                    <button class="report-tab" onclick="trocarAba('receitas', this)">
                        <i class="fas fa-arrow-up"></i> Receitas
                    </button>
                    <button class="report-tab" onclick="trocarAba('despesas', this)">
                        <i class="fas fa-arrow-down"></i> Despesas
                    </button>
                    <button class="report-tab" onclick="trocarAba('dre', this)">
                        <i class="fas fa-file-invoice"></i> DRE
                    </button>
                </div>

                <!-- Aba Visão Geral -->
                <div id="aba-geral" class="report-content active">
                    <div class="filters-section">
                        <div class="filters-grid">
                            <div class="filter-group">
                                <label class="filter-label">Período</label>
                                <select class="filter-select" id="periodo-geral" onchange="setPeriodoGeral()">
                                    <option value="mes">Este Mês</option>
                                    <option value="trimestre">Últimos 3 Meses</option>
                                    <option value="semestre">Últimos 6 Meses</option>
                                    <option value="ano">Este Ano</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label class="filter-label">Data Início</label>
                                <input type="date" class="filter-input" id="data-inicio-geral">
                            </div>
                            <div class="filter-group">
                                <label class="filter-label">Data Fim</label>
                                <input type="date" class="filter-input" id="data-fim-geral">
                            </div>
                        </div>
                        <div class="actions-bar">
                            <button class="btn btn-primary" onclick="gerarRelatorioGeral()">
                                <i class="fas fa-search"></i> Gerar Relatório
                            </button>
                        </div>
                    </div>

                    <div class="stats-grid">
                        <div class="stat-card" style="--stat-color: #1e40af; --stat-bg: rgba(16, 185, 129, 0.1);">
                            <div class="stat-icon"><i class="fas fa-arrow-up"></i></div>
                            <div class="stat-value" id="stat-receitas">R$ 0,00</div>
                            <div class="stat-label">Total de Receitas</div>
                        </div>
                        <div class="stat-card" style="--stat-color: #ef4444; --stat-bg: rgba(239, 68, 68, 0.1);">
                            <div class="stat-icon"><i class="fas fa-arrow-down"></i></div>
                            <div class="stat-value" id="stat-despesas">R$ 0,00</div>
                            <div class="stat-label">Total de Despesas</div>
                        </div>
                        <div class="stat-card" style="--stat-color: #3b82f6; --stat-bg: rgba(59, 130, 246, 0.1);">
                            <div class="stat-icon"><i class="fas fa-balance-scale"></i></div>
                            <div class="stat-value" id="stat-resultação">R$ 0,00</div>
                            <div class="stat-label">Resultação Líquido</div>
                        </div>
                        <div class="stat-card" style="--stat-color: #f59e0b; --stat-bg: rgba(245, 158, 11, 0.1);">
                            <div class="stat-icon"><i class="fas fa-percent"></i></div>
                            <div class="stat-value" id="stat-margem">0%</div>
                            <div class="stat-label">Margem Líquida</div>
                        </div>
                    </div>

                    <div class="charts-grid">
                        <div class="chart-card">
                            <div class="chart-header">
                                <h3 class="chart-title">Receitas vs Despesas</h3>
                                <p class="chart-subtitle">Comparativo mensal</p>
                            </div>
                            <canvas id="chart-comparativo" height="250"></canvas>
                        </div>
                        <div class="chart-card">
                            <div class="chart-header">
                                <h3 class="chart-title">Despesas por Categoria</h3>
                                <p class="chart-subtitle">Distribuição percentual</p>
                            </div>
                            <canvas id="chart-categorias" height="250"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Aba Receitas -->
                <div id="aba-receitas" class="report-content">
                    <div class="report-cards">
                        <div class="report-card" style="--card-color: #1e40af; --card-bg: rgba(16, 185, 129, 0.1);" onclick="gerarRelatorio('receitas-clientes')">
                            <div class="report-card-icon"><i class="fas fa-users"></i></div>
                            <div class="report-card-title">Receitas por Cliente</div>
                            <div class="report-card-desc">Análise detalhada de faturamento por cliente</div>
                        </div>
                        <div class="report-card" style="--card-color: #3b82f6; --card-bg: rgba(59, 130, 246, 0.1);" onclick="gerarRelatorio('receitas-periodo')">
                            <div class="report-card-icon"><i class="fas fa-calendar"></i></div>
                            <div class="report-card-title">Receitas por Período</div>
                            <div class="report-card-desc">Evolução temporal das receitas</div>
                        </div>
                        <div class="report-card" style="--card-color: #8b5cf6; --card-bg: rgba(139, 92, 246, 0.1);" onclick="gerarRelatorio('receitas-categoria')">
                            <div class="report-card-icon"><i class="fas fa-tags"></i></div>
                            <div class="report-card-title">Receitas por Categoria</div>
                            <div class="report-card-desc">Distribuição por tipo de receita</div>
                        </div>
                        <div class="report-card" style="--card-color: #f59e0b; --card-bg: rgba(245, 158, 11, 0.1);" onclick="gerarRelatorio('inadimplencia')">
                            <div class="report-card-icon"><i class="fas fa-exclamation-triangle"></i></div>
                            <div class="report-card-title">Análise de Inadimplência</div>
                            <div class="report-card-desc">Contas vencidas e inadimplentes</div>
                        </div>
                    </div>
                </div>

                <!-- Aba Despesas -->
                <div id="aba-despesas" class="report-content">
                    <div class="report-cards">
                        <div class="report-card" style="--card-color: #ef4444; --card-bg: rgba(239, 68, 68, 0.1);" onclick="gerarRelatorio('despesas-fornecedor')">
                            <div class="report-card-icon"><i class="fas fa-truck"></i></div>
                            <div class="report-card-title">Despesas por Fornecedor</div>
                            <div class="report-card-desc">Análise de gastos por fornecedor</div>
                        </div>
                        <div class="report-card" style="--card-color: #f59e0b; --card-bg: rgba(245, 158, 11, 0.1);" onclick="gerarRelatorio('despesas-categoria')">
                            <div class="report-card-icon"><i class="fas fa-chart-pie"></i></div>
                            <div class="report-card-title">Despesas por Categoria</div>
                            <div class="report-card-desc">Distribuição por tipo de despesa</div>
                        </div>
                        <div class="report-card" style="--card-color: #8b5cf6; --card-bg: rgba(139, 92, 246, 0.1);" onclick="gerarRelatorio('despesas-centro-custo')">
                            <div class="report-card-icon"><i class="fas fa-building"></i></div>
                            <div class="report-card-title">Despesas por Centro de Custo</div>
                            <div class="report-card-desc">Gastos por departamento/setor</div>
                        </div>
                        <div class="report-card" style="--card-color: #3b82f6; --card-bg: rgba(59, 130, 246, 0.1);" onclick="gerarRelatorio('despesas-periodo')">
                            <div class="report-card-icon"><i class="fas fa-calendar-alt"></i></div>
                            <div class="report-card-title">Evolução de Despesas</div>
                            <div class="report-card-desc">Tendência temporal de gastos</div>
                        </div>
                    </div>
                </div>

                <!-- Aba DRE -->
                <div id="aba-dre" class="report-content">
                    <div class="filters-section">
                        <h3 style="margin-bottom: 20px; font-size: 18px; font-weight: 700;">Demonstração do Resultação do Exercício</h3>
                        <div class="filters-grid">
                            <div class="filter-group">
                                <label class="filter-label">Mês/Ano</label>
                                <input type="month" class="filter-input" id="mes-dre">
                            </div>
                        </div>
                        <div class="actions-bar">
                            <button class="btn btn-primary" onclick="gerarDRE()">
                                <i class="fas fa-file-invoice"></i> Gerar DRE
                            </button>
                            <button class="btn btn-success" onclick="exportarDRE()">
                                <i class="fas fa-file-excel"></i> Exportar
                            </button>
                        </div>
                    </div>

                    <div style="background: white; border-radius: 12px; padding: 32px; box-shaçãow: 0 2px 8px rgba(0,0,0,0.05);">
                        <div style="text-align: center; padding: 60px; color: #9ca3af;">
                            <i class="fas fa-file-invoice" style="font-size: 64px; margin-bottom: 20px; display: block;"></i>
                            <p style="font-size: 18px; font-weight: 600; margin-bottom: 8px;">Demonstração do Resultação</p>
                            <p style="font-size: 14px;">Selecione um período e clique em "Gerar DRE"</p>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // Toggle sidebar
        document.getElementById('toggle-sidebar').addEventListener('click', () => {
            document.querySelector('.sidebar').classList.toggle('active');
            document.getElementById('sidebar-overlay').classList.toggle('active');
        });

        document.getElementById('sidebar-overlay').addEventListener('click', () => {
            document.querySelector('.sidebar').classList.remove('active');
            document.getElementById('sidebar-overlay').classList.remove('active');
        });

        let chartComp, chartCat;

        function trocarAba(aba, btn) {
            document.querySelectorAll('.report-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.report-content').forEach(content => content.classList.remove('active'));
            
            btn.classList.add('active');
            document.getElementById(`aba-${aba}`).classList.add('active');
        }

        function setPeriodoGeral() {
            const periodo = document.getElementById('periodo-geral').value;
            const hoje = new Date();
            let dataInicio;

            switch(periodo) {
                case 'mes':
                    dataInicio = new Date(hoje.getFullYear(), hoje.getMonth(), 1);
                    break;
                case 'trimestre':
                    dataInicio = new Date(hoje.setMonth(hoje.getMonth() - 3));
                    break;
                case 'semestre':
                    dataInicio = new Date(hoje.setMonth(hoje.getMonth() - 6));
                    break;
                case 'ano':
                    dataInicio = new Date(hoje.getFullYear(), 0, 1);
                    break;
            }

            document.getElementById('data-inicio-geral').value = dataInicio.toISOString().split('T')[0];
            document.getElementById('data-fim-geral').value = new Date().toISOString().split('T')[0];
        }

        async function gerarRelatorioGeral() {
            const dataInicio = document.getElementById('data-inicio-geral').value;
            const dataFim = document.getElementById('data-fim-geral').value;

            try {
                const response = await fetch(`/api/financeiro/relatorios/geralinicio=${dataInicio}&fim=${dataFim}`, {
                    credentials: 'include'
                });

                if (response.ok) {
                    const daçãos = await response.json();
                    atualizarEstatisticas(daçãos);
                    renderizarGraficos(daçãos);
                }
            } catch (error) {
                console.error('Erro ao gerar relatório:', error);
                alert('Funcionalidade em desenvolvimento');
            }
        }

        function atualizarEstatisticas(daçãos) {
            document.getElementById('stat-receitas').textContent = 
                $ ${(daçãos.receitas || 0).toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
            document.getElementById('stat-despesas').textContent = 
                $ ${(daçãos.despesas || 0).toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
            
            const resultação = (daçãos.receitas || 0) - (daçãos.despesas || 0);
            document.getElementById('stat-resultação').textContent = 
                $ ${resultação.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
            document.getElementById('stat-resultação').style.color = resultação >= 0 ? '#1e40af' : '#ef4444';
            
            const margem = daçãos.receitas > 0  ((resultação / daçãos.receitas) * 100).toFixed(1) : 0;
            document.getElementById('stat-margem').textContent = `${margem}%`;
        }

        function renderizarGraficos(daçãos) {
            // Gráfico Comparativo
            const ctxComp = document.getElementById('chart-comparativo');
            if (chartComp) chartComp.destroy();
            
            chartComp = new Chart(ctxComp, {
                type: 'bar',
                data: {
                    labels: daçãos.labels || ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun'],
                    datasets: [
                        {
                            label: 'Receitas',
                            data: daçãos.receitas_mes || [50000, 45000, 60000, 55000, 70000, 65000],
                            backgroundColor: '#1e40af'
                        },
                        {
                            label: 'Despesas',
                            data: daçãos.despesas_mes || [35000, 38000, 42000, 40000, 45000, 43000],
                            backgroundColor: '#ef4444'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { display: true, position: 'top' }
                    }
                }
            });

            // Gráfico Categorias
            const ctxCat = document.getElementById('chart-categorias');
            if (chartCat) chartCat.destroy();
            
            chartCat = new Chart(ctxCat, {
                type: 'doughnut',
                data: {
                    labels: daçãos.categorias_labels || ['Operacionais', 'Pessoal', 'Administrativas', 'Impostos', 'Outras'],
                    datasets: [{
                        data: daçãos.categorias_valores || [35, 25, 20, 15, 5],
                        backgroundColor: ['#3b82f6', '#1e40af', '#f59e0b', '#ef4444', '#8b5cf6']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { display: true, position: 'bottom' }
                    }
                }
            });
        }

        function gerarRelatorio(tipo) {
            alert(elatório "${tipo}" em desenvolvimento`);
        }

        function gerarDRE() {
            alert('Funcionalidade DRE em desenvolvimento');
        }

        function exportarDRE() {
            alert('Exportação em desenvolvimento');
        }

        function exportarRelatorio() {
            // Função para exportar relatório profissional
            const dataAtual = new Date().toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' });
            const periodo = document.getElementById('periodo-geral').options[document.getElementById('periodo-geral').selectedIndex].text || 'Período Selecionação';
            
            const janelaImpressao = window.open('', '_blank');
            janelaImpressao.document.write(`<!DOCTYPE html>
<html>
<head>
    <link rel="icon" type="image/x-icon" href="/favicon-aluforce.webp">
    <meta charset="UTF-8">
    <title>Relatório Financeiro - ALUFORCE</title>
    <style>
        @page { size: A4; margin: 15mm; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Arial, sans-serif; color: #1e293b; font-size: 11px; line-height: 1.4; }
        
        .header-institucional {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            border-bottom: 3px solid #1e40af;
            padding-bottom: 15px;
            margin-bottom: 20px;
        }
        .logo-area {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .logo-circle {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #1e40af, #3b82f6);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .logo-circle svg {
            width: 35px;
            height: 35px;
            fill: white;
        }
        .empresa-info h1 {
            font-size: 14px;
            font-weight: 700;
            color: #1e40af;
            letter-spacing: 1px;
        }
        .empresa-info p {
            font-size: 9px;
            color: #64748b;
            margin-top: 2px;
        }
        .daçãos-empresa {
            text-align: right;
            font-size: 9px;
            color: #475569;
            line-height: 1.5;
        }
        .daçãos-empresa strong { color: #1e293b; }
        
        .titulo-relatorio {
            background: linear-gradient(135deg, #1e40af, #3b82f6);
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .titulo-relatorio h2 {
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .titulo-relatorio .data {
            font-size: 10px;
            opacity: 0.9;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 25px;
        }
        .stat-box {
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
        }
        .stat-box.verde { border-left: 4px solid #10b981; }
        .stat-box.vermelho { border-left: 4px solid #ef4444; }
        .stat-box.azul { border-left: 4px solid #3b82f6; }
        .stat-box.amarelo { border-left: 4px solid #f59e0b; }
        .stat-label { font-size: 9px; color: #64748b; text-transform: uppercase; }
        .stat-value { font-size: 16px; font-weight: 700; color: #1e293b; margin-top: 5px; }
        
        .footer {
            margin-top: 30px;
            padding-top: 15px;
            border-top: 2px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            font-size: 8px;
            color: #94a3b8;
        }
        .footer .confidencial {
            font-weight: 600;
            color: #ef4444;
        }
        
        @media print {
            body { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
        }
    </style></head>
<body>
    <div class="header-institucional">
        <div class="logo-area">
            <div class="logo-circle">
                <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" stroke="white" stroke-width="2" fill="none"/><path d="M12 2 L12 22 M2 12 L22 12" stroke="white" stroke-width="1.5"/></svg>
            </div>
            <div class="empresa-info">
                <h1>ALUFORCE</h1>
                <p>CABOS DE ALUMÍNIO</p>
            </div>
        </div>
        <div class="daçãos-empresa">
            <strong>I. M. DOS REIS - ALUFORCE INDÚSTRIA E COMÉRCIO DE CONDUTORES</strong><br>
            CNPJ: 08.192.479/0001-60 | IE: 103.385.861-110<br>
            RUA ERNESTINA, 270 - VILA SÃO JOÃO<br>
            Ferraz de Vasconcelos - SP | CEP: 08527-400<br>
            Tel: (11) 94723-8729
        </div>
    </div>
    
    <div class="titulo-relatorio">
        <h2>RELATÓRIO FINANCEIRO - ${periodo.toUpperCase()}</h2>
        <span class="data">Emitido em: ${dataAtual}</span>
    </div>
    
    <div class="stats-grid">
        <div class="stat-box verde">
            <div class="stat-label">Total Receitas</div>
            <div class="stat-value">${document.getElementById('stat-receitas').textContent || 'R$ 0,00'}</div>
        </div>
        <div class="stat-box vermelho">
            <div class="stat-label">Total Despesas</div>
            <div class="stat-value">${document.getElementById('stat-despesas').textContent || 'R$ 0,00'}</div>
        </div>
        <div class="stat-box azul">
            <div class="stat-label">Resultação Líquido</div>
            <div class="stat-value">${document.getElementById('stat-resultação').textContent || 'R$ 0,00'}</div>
        </div>
        <div class="stat-box amarelo">
            <div class="stat-label">Margem Líquida</div>
            <div class="stat-value">${document.getElementById('stat-margem').textContent || '0%'}</div>
        </div>
    </div>
    
    <p style="text-align: center; color: #64748b; font-size: 10px; margin: 30px 0;">
        Para relatórios detalhaçãos com gráficos, acesse o sistema ALUFORCE ERP.
    </p>
    
    <div class="footer">
        <span class="confidencial">DOCUMENTO CONFIDENCIAL - USO INTERNO</span>
        <span>ALUFORCE ERP - Sistema de Gestão Empresarial</span>
        <span>Página 1 de 1</span>
    </div></body>
</html>`);
            janelaImpressao.document.close();
            setTimeout(() => janelaImpressao.print(), 500);
        }
        
        // Carregar daçãos do usuário
        async function carregarUsuarioLogação() {
            try {
                const response = await fetch('/api/me', { credentials: 'include' });
                if (response.ok) {
                    const user = await response.json();
                    // Usar apelido se disponível, senão primeiro nome
                    const userName = user.apelido || user.nome || 'Usuário';
                    const primeiroNome = user.apelido || (user.nome  user.nome.split(' ')[0] : 'Usuário');

                    // Atualizar saudação dinâmica baseada na hora
                    const greetingTextEl = document.getElementById('greeting-text');
                    if (greetingTextEl) {
                        const hour = new Date().getHours();
                        let greeting = 'Bom dia';
                        if (hour >= 12 && hour < 18) greeting = 'Boa tarde';
                        else if (hour >= 18 || hour < 5) greeting = 'Boa noite';
                        greetingTextEl.textContent = greeting;
                    }
                    
                    document.getElementById('user-name').textContent = primeiroNome;
                    
                    // Mapeamento de avatares por nome/email
                    const avatarNameMap = {
                        'clemerson': '/avatars/Clemerson.webp',
                        'isabela': '/avatars/Isabela.webp',
                        'thaina': '/avatars/Thaina.webp',
                        'thiago': '/avatars/Thiago.webp',
                        'nicolas': '/avatars/NicolasDaniel.webp',
                        'nicolasdaniel': '/avatars/NicolasDaniel.webp',
                        'rh': '/avatars/Rh.webp',
                        'admin': '/avatars/admin.webp',
                        'ti': '/avatars/TI.webp',
                        'tialuforce': '/avatars/TI.webp',
                        'antonio': '/avatars/Antonio.webp',
                        'antônio': '/avatars/Antonio.webp',
                        'andreia': '/avatars/Andreia.webp',
                        'guilherme': '/avatars/Guilherme.webp',
                        'marcelo': '/avatars/Marcelo.webp',
                        'financeiro': '/avatars/Financeiro.webp',
                        'douglas': '/avatars/Douglas.webp',
                        'hellen': '/avatars/Hellen.webp',
                        'helen': '/avatars/Hellen.webp'
                    };
                    
                    // Determinar avatar
                    let avatarUrl = null;
                    if (user.avatar && user.avatar !== '/avatars/default.webp') {
                        avatarUrl = user.avatar;
                    } else if (user.foto && user.foto !== '/avatars/default.webp') {
                        avatarUrl = user.foto;
                    } else if (user.email) {
                        const username = user.email.split('@')[0].split('.')[0].toLowerCase();
                        avatarUrl = avatarNameMap[username];
                    }
                    if (!avatarUrl && nome) {
                        const firstNameLower = nome.split(' ')[0].toLowerCase();
                        avatarUrl = avatarNameMap[firstNameLower];
                    }
                    
                    // Atualizar avatar/foto
                    const userPhotoEl = document.getElementById('user-photo');
                    const userInitialEl = document.getElementById('user-initial');
                    
                    if (avatarUrl && userPhotoEl) {
                        userPhotoEl.src = avatarUrl;
                        userPhotoEl.style.display = 'block';
                        userPhotoEl.onerror = function() {
                            this.style.display = 'none';
                            if (userInitialEl) {
                                userInitialEl.textContent = primeiroNome.charAt(0).toUpperCase();
                                userInitialEl.style.display = 'flex';
                            }
                        };
                        if (userInitialEl) userInitialEl.style.display = 'none';
                    } else if (userInitialEl) {
                        userInitialEl.textContent = primeiroNome.charAt(0).toUpperCase();
                        userInitialEl.style.display = 'flex';
                        if (userPhotoEl) userPhotoEl.style.display = 'none';
                    }
                }
            } catch (error) {
                console.error('Erro ao carregar usuário:', error);
            }
        }

        // Inicializar
        document.addEventListener('DOMContentLoaded', () => {
            const hoje = new Date();
            const primeiroDia = new Date(hoje.getFullYear(), hoje.getMonth(), 1);
            
            document.getElementById('data-inicio-geral').value = primeiroDia.toISOString().split('T')[0];
            document.getElementById('data-fim-geral').value = hoje.toISOString().split('T')[0];
            document.getElementById('mes-dre').value = `${hoje.getFullYear()}-${String(hoje.getMonth() + 1).padStart(2, '0')}`;
            
            // Carregar daçãos iniciais
            setTimeout(() => {
                renderizarGraficos({ labels: ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun'] });
            }, 500);
            
            carregarUsuarioLogação();
        });
    </script>
    
    <!-- Sistema de Notificações -->
    <script src="js/notifications-manager.jsv=20251208"></script>
    <script src="js/notification-button.jsv=20251208"></script>

    <!-- Sistema de Chat e Suporte (widgets condicionais por usuário) -->
    <!-- ti@aluforce.ind.br = Central de Suporte | Outros usuários = Chat normal -->
    <!-- Sistema de Monitoramento de Conexão -->
    <script src="../../_shared/connection-monitor.jsv=20251223"></script></body>
</html>

