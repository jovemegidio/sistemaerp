<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <link rel="icon" type="image/x-icon" href="/favicon-aluforce.webp">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ALUFORCE - Gestão de Vendas</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2family=Outfit:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        :root {
            --sidebar-width: 56px;
            --header-height: 48px;
            --tab-height: 40px;
            --primary-orange: #225cfa;
            --primary-dark: #1a1a2e;
            --bg-dark: #0f0f1a;
            --text-light: #e2e8f0;
            --text-muted: #94a3b8;
            --border-color: rgba(255,255,255,0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #f5f6f8;
            min-height: 100vh;
            overflow: hidden;
        }

        /* ==================== APP CONTAINER ==================== */
        .app-container {
            display: flex;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
        }

        /* ==================== SIDEBAR ==================== */
        .sidebar {
            width: var(--sidebar-width);
            height: 100vh;
            background: var(--primary-dark);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 12px 0;
            flex-shrink: 0;
            z-index: 100;
        }

        .sidebar-logo {
            width: 36px;
            height: 36px;
            background: var(--primary-orange);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 16px;
            margin-bottom: 20px;
            text-decoration: none;
            transition: transform 0.2s;
        }

        .sidebar-logo:hover {
            transform: scale(1.05);
        }

        .sidebar-nav {
            display: flex;
            flex-direction: column;
            gap: 4px;
            flex: 1;
        }

        .sidebar-btn {
            width: 40px;
            height: 40px;
            border: none;
            background: transparent;
            color: var(--text-muted);
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            transition: all 0.2s;
            position: relative;
        }

        .sidebar-btn:hover {
            background: rgba(255,255,255,0.1);
            color: white;
        }

        .sidebar-btn.active {
            background: var(--primary-orange);
            color: white;
        }

        .sidebar-btn::after {
            content: attr(title);
            position: absolute;
            left: 100%;
            margin-left: 10px;
            padding: 6px 10px;
            background: #1e293b;
            color: white;
            font-size: 12px;
            border-radius: 4px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
            z-index: 1000;
        }

        .sidebar-btn:hover::after {
            opacity: 1;
        }

        .sidebar-bottom {
            margin-top: auto;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        /* ==================== MAIN AREA ==================== */
        .main-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background: #f5f6f8;
        }

        /* ==================== HEADER ==================== */
        .header {
            height: var(--header-height);
            background: var(--primary-dark);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 16px;
            flex-shrink: 0;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 24px;
        }

        .header-brand {
            display: flex;
            align-items: center;
            gap: 8px;
            color: white;
        }

        .header-brand img {
            height: 24px;
        }

        .header-brand span {
            font-size: 14px;
            font-weight: 600;
            color: #8b8b9a;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .header-btn {
            width: 36px;
            height: 36px;
            border: none;
            background: transparent;
            color: #8b8b9a;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            transition: all 0.2s;
        }

        .header-btn:hover {
            background: rgba(255,255,255,0.1);
            color: white;
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            margin-left: 8px;
            overflow: hidden;
        }

        .user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: none;
        }

        .user-avatar img.visible {
            display: block;
        }

        .user-greeting {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-left: 16px;
            color: #8b8b9a;
            font-size: 13px;
        }

        .user-greeting strong {
            color: white;
        }

        /* ==================== TABS BAR ==================== */
        .tabs-bar {
            height: var(--tab-height);
            background: white;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            align-items: center;
            padding: 0 16px;
            gap: 8px;
            flex-shrink: 0;
        }

        .tab-btn {
            padding: 8px 16px;
            border: none;
            background: transparent;
            color: #64748b;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .tab-btn:hover {
            background: #f1f5f9;
            color: #334155;
        }

        .tab-btn.active {
            background: var(--primary-orange);
            color: white;
        }

        .tabs-spacer {
            flex: 1;
        }

        /* ==================== PAGE CONTENT ==================== */
        .page-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        /* ==================== PAGE HEADER ==================== */
        .page-header {
            background: white;
            border-radius: 12px;
            padding: 20px 24px;
            margin-bottom: 20px;
            box-shaçãow: 0 1px 3px rgba(0,0,0,0.08);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .page-header-left h1 {
            font-size: 24px;
            font-weight: 700;
            color: #1a1a1a;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .page-header-left p {
            font-size: 14px;
            color: #7f8c8d;
        }

        .page-header-actions {
            display: flex;
            gap: 12px;
        }

        .btn-primary {
            background: var(--primary-orange);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
        }

        .btn-primary:hover {
            background: #ea580c;
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: white;
            color: #374151;
            border: 1px solid #e5e7eb;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
        }

        .btn-secondary:hover {
            background: #f9fafb;
            border-color: #d1d5db;
        }

        /* ==================== STATS GRID ==================== */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 16px;
            margin-bottom: 24px;
        }

        @media (max-width: 1400px) {
            .stats-grid { grid-template-columns: repeat(3, 1fr); }
        }

        @media (max-width: 900px) {
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
        }

        @media (max-width: 600px) {
            .stats-grid { grid-template-columns: 1fr; }
        }

        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shaçãow: 0 1px 3px rgba(0,0,0,0.08);
        }

        .stat-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .stat-icon {
            width: 44px;
            height: 44px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .stat-icon.orange { background: #fff7ed; color: #f97316; }
        .stat-icon.green { background: #f0fdf4; color: #22c55e; }
        .stat-icon.blue { background: #eff6ff; color: #3b82f6; }
        .stat-icon.purple { background: #faf5ff; color: #a855f7; }
        .stat-icon.red { background: #fef2f2; color: #ef4444; }

        .stat-value {
            font-size: 28px;
            font-weight: 700;
            color: #1a1a1a;
        }

        .stat-label {
            font-size: 13px;
            color: #7f8c8d;
            margin-top: 4px;
        }

        .stat-trend {
            display: flex;
            align-items: center;
            gap: 4px;
            margin-top: 8px;
            font-size: 12px;
        }

        .stat-trend.up { color: #22c55e; }
        .stat-trend.down { color: #ef4444; }

        /* ==================== CONTENT GRID ==================== */
        .content-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        @media (max-width: 1200px) {
            .content-grid { grid-template-columns: 1fr; }
        }

        .section-card {
            background: white;
            border-radius: 12px;
            box-shaçãow: 0 1px 3px rgba(0,0,0,0.08);
            overflow: hidden;
        }

        .section-header {
            padding: 16px 20px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .section-header h3 {
            font-size: 16px;
            font-weight: 600;
            color: #1a1a1a;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .section-header h3 i {
            color: var(--primary-orange);
        }

        .section-content {
            padding: 20px;
        }

        .full-width-section {
            grid-column: 1 / -1;
        }

        /* ==================== RANKING TABLE ==================== */
        .ranking-table {
            width: 100%;
            border-collapse: collapse;
        }

        .ranking-table th, .ranking-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }

        .ranking-table th {
            font-size: 12px;
            font-weight: 600;
            color: #6b7280;
            text-transform: uppercase;
        }

        .ranking-table tr:last-child td {
            border-bottom: none;
        }

        .ranking-table tr:hover {
            background: #f9fafb;
        }

        .vendedor-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .vendedor-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-orange), #ea580c);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 14px;
            flex-shrink: 0;
        }
        
        .vendedor-avatar-img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            flex-shrink: 0;
            border: 2px solid #e5e7eb;
        }

        .vendedor-nome {
            font-weight: 600;
            color: #1a1a1a;
        }

        .vendedor-email {
            font-size: 12px;
            color: #6b7280;
        }

        .progress-mini {
            width: 100px;
            height: 8px;
            background: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-mini-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-orange), #fb923c);
            border-radius: 4px;
        }

        .progress-mini-fill.success {
            background: linear-gradient(90deg, #22c55e, #16a34a);
        }

        .badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge.gold { background: #fef3c7; color: #d97706; }
        .badge.silver { background: #e5e7eb; color: #4b5563; }
        .badge.bronze { background: #fed7aa; color: #c2410c; }

        /* ==================== METAS GRID ==================== */
        .metas-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .meta-item {
            background: #f9fafb;
            border-radius: 10px;
            padding: 16px;
            border: 1px solid #e5e7eb;
        }

        .meta-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .meta-title {
            font-weight: 600;
            color: #1a1a1a;
        }

        .meta-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary-orange);
        }

        .meta-progress {
            margin-top: 12px;
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 6px;
            font-size: 12px;
            color: #6b7280;
        }

        .progress-bar {
            height: 8px;
            background: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-orange), #fb923c);
            border-radius: 4px;
        }

        .progress-fill.success {
            background: linear-gradient(90deg, #22c55e, #16a34a);
        }

        /* ==================== VENDAS LIST ==================== */
        .vendas-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .venda-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: #f9fafb;
            border-radius: 8px;
        }

        .venda-info {
            display: flex;
            flex-direction: column;
        }

        .venda-cliente {
            font-weight: 600;
            color: #1a1a1a;
        }

        .venda-vendedor {
            font-size: 12px;
            color: #6b7280;
        }

        .venda-valor {
            font-size: 18px;
            font-weight: 700;
            color: #059669;
        }

        /* ==================== MODAL ==================== */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: white;
            border-radius: 16px;
            max-width: 500px;
            width: 90%;
            overflow: hidden;
        }

        .modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            font-size: 18px;
            font-weight: 600;
            color: #1a1a1a;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            color: #6b7280;
            cursor: pointer;
            padding: 0;
            line-height: 1;
        }

        .modal-close:hover {
            color: #1a1a1a;
        }

        .modal-body {
            padding: 24px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 8px;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.2s;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: var(--primary-orange);
        }

        .modal-footer {
            padding: 16px 24px;
            border-top: 1px solid #e5e7eb;
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }
    </style></head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <a href="/dashboard" class="sidebar-logo" title="Voltar ao Painel">
                <i class="fas fa-home"></i>
            </a>
            <nav class="sidebar-nav">
                <button class="sidebar-btn" title="Kanban" onclick="window.location.href='index.html'">
                    <i class="fas fa-columns"></i>
                </button>
                <button class="sidebar-btn" title="Pedidos" onclick="window.location.href='pedidos.html'">
                    <i class="fas fa-clipboard-list"></i>
                </button>
                <button class="sidebar-btn" title="Clientes" onclick="window.location.href='clientes.html'">
                    <i class="fas fa-users"></i>
                </button>
                <button class="sidebar-btn" title="Estoque" onclick="window.location.href='estoque.html'">
                    <i class="fas fa-boxes-stacked"></i>
                </button>
                <button class="sidebar-btn" title="Meu Dashboard" onclick="window.location.href='dashboard.html'">
                    <i class="fas fa-chart-pie"></i>
                </button>
                <button class="sidebar-btn active" title="Gestão de Vendas" onclick="window.location.href='dashboard-admin.html'">
                    <i class="fas fa-chart-line"></i>
                </button>
                <button class="sidebar-btn" title="Relatórios" onclick="window.location.href='relatorios.html'">
                    <i class="fas fa-chart-bar"></i>
                </button>
            </nav>
            <div class="sidebar-bottom">
                <button class="sidebar-btn" title="Configurações">
                    <i class="fas fa-cog"></i>
                </button>
            </div>
        </aside>

        <!-- Main Area -->
        <main class="main-area">
            <!-- Header -->
            <header class="header">
    <link rel="icon" type="image/x-icon" href="/favicon-aluforce.webp">
                <div class="header-left">
                    <div class="header-brand">
                        <img src="/images/Logo Monocromatico - Branco - Aluforce.webp" alt="ALUFORCE">
                        <span>|</span>
                        <span>ALUFORCE</span>
                    </div>
                </div>
                <div class="header-right">
                    <button class="header-btn" title="Notificações">
                        <i class="fas fa-bell"></i>
                    </button>
                    <div class="user-greeting">
                        <span><span id="greeting-text">Bom dia</span>, <strong id="user-name">Usuário</strong></span>
                        <div class="user-avatar" id="user-avatar">
                            <img src="" alt="Foto do usuário" id="user-photo">
                            <span id="user-initial">U</span>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Tabs Bar -->
            <div class="tabs-bar">
                <button class="tab-btn" onclick="window.location.href='index.html'">
                    <i class="fas fa-columns"></i> Kanban
                </button>
                <button class="tab-btn" onclick="window.location.href='pedidos.html'">
                    <i class="fas fa-clipboard-list"></i> Pedidos
                </button>
                <button class="tab-btn" onclick="window.location.href='clientes.html'">
                    <i class="fas fa-users"></i> Clientes
                </button>
                <button class="tab-btn active">
                    <i class="fas fa-chart-line"></i> Gestão de Vendas
                </button>
                <button class="tab-btn" onclick="window.location.href='relatorios.html'">
                    <i class="fas fa-chart-bar"></i> Relatórios
                </button>
                <div class="tabs-spacer"></div>
            </div>

            <!-- Page Content -->
            <div class="page-content">
                <!-- Page Header -->
                <div class="page-header">
                    <div class="page-header-left">
                        <h1>
                            <i class="fas fa-chart-line" style="color: var(--primary-orange);"></i>
                            Gestão de Vendas
                        </h1>
                        <p>Acompanhe a performance da equipe e gerencie metas</p>
                    </div>
                    <div class="page-header-actions">
                        <button class="btn-secondary" onclick="exportarRelatorio()">
                            <i class="fas fa-file-export"></i> Exportar
                        </button>
                        <button class="btn-primary" onclick="abrirModalMeta()">
                            <i class="fas fa-bullseye"></i> Definir Meta
                        </button>
                    </div>
                </div>

                <!-- Stats Grid -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <div class="stat-icon orange">
                                <i class="fas fa-dollar-sign"></i>
                            </div>
                        </div>
                        <div class="stat-value" id="totalVendasMes">Carregando...</div>
                        <div class="stat-label">Vendas do Mês</div>
                        <div class="stat-trend" id="trendVendasMes">
                            <i class="fas fa-spinner fa-spin"></i>
                            <span>calculando...</span>
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-card-header">
                            <div class="stat-icon green">
                                <i class="fas fa-check-circle"></i>
                            </div>
                        </div>
                        <div class="stat-value" id="metaEquipe">--</div>
                        <div class="stat-label">Meta da Equipe</div>
                        <div class="stat-trend" id="trendMetaEquipe">
                            <i class="fas fa-spinner fa-spin"></i>
                            <span>calculando...</span>
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-card-header">
                            <div class="stat-icon blue">
                                <i class="fas fa-users"></i>
                            </div>
                        </div>
                        <div class="stat-value" id="totalVendedores">--</div>
                        <div class="stat-label">Vendedores Ativos</div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-card-header">
                            <div class="stat-icon purple">
                                <i class="fas fa-file-invoice"></i>
                            </div>
                        </div>
                        <div class="stat-value" id="pedidosMes">--</div>
                        <div class="stat-label">Pedidos no Mês</div>
                        <div class="stat-trend" id="trendPedidosMes">
                            <i class="fas fa-spinner fa-spin"></i>
                            <span>calculando...</span>
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-card-header">
                            <div class="stat-icon red">
                                <i class="fas fa-exclamation-triangle"></i>
                            </div>
                        </div>
                        <div class="stat-value" id="abaixoMeta">--</div>
                        <div class="stat-label">Abaixo da Meta</div>
                    </div>
                </div>

                <!-- Content Grid -->
                <div class="content-grid">
                    <!-- Ranking de Vendedores -->
                    <div class="section-card full-width-section">
                        <div class="section-header">
                            <h3><i class="fas fa-trophy"></i> Ranking de Vendedores - <span id="rankingMesAno">Carregando...</span></h3>
                        </div>
                        <div class="section-content" style="padding: 0; overflow-x: auto;">
                            <table class="ranking-table">
                                <thead>
                                    <tr>
                                        <th>Pos.</th>
                                        <th>Vendedor</th>
                                        <th>Vendas</th>
                                        <th>Meta</th>
                                        <th>Progresso</th>
                                        <th>Pedidos</th>
                                        <th>Ticket Médio</th>
                                    </tr>
                                </thead>
                                <tbody id="rankingTableBody">
                                    <tr>
                                        <td colspan="7" style="text-align: center; padding: 40px;">
                                            <i class="fas fa-spinner fa-spin" style="font-size: 24px; color: #94a3b8;"></i>
                                            <p style="margin-top: 10px; color: #94a3b8;">Carregando ranking...</p>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Metas do Mês -->
                    <div class="section-card">
                        <div class="section-header">
                            <h3><i class="fas fa-bullseye"></i> Metas do Mês</h3>
                            <button class="btn-secondary" style="padding: 8px 16px; font-size: 12px;" onclick="abrirModalMeta()">
                                <i class="fas fa-plus"></i> Nova Meta
                            </button>
                        </div>
                        <div class="section-content">
                            <div class="metas-grid" id="metasGrid">
                                <div class="meta-item">
                                    <div class="meta-header">
                                        <span class="meta-title">Meta Geral</span>
                                        <span class="meta-value" id="metaGeralValor">R$ 0</span>
                                    </div>
                                    <div class="meta-progress">
                                        <div class="progress-header">
                                            <span id="metaGeralAtingido">R$ 0 atingidos</span>
                                            <span id="metaGeralPercent">0%</span>
                                        </div>
                                        <div class="progress-bar">
                                            <div class="progress-fill" id="metaGeralFill" style="width: 0%"></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="meta-item">
                                    <div class="meta-header">
                                        <span class="meta-title">Novos Clientes</span>
                                        <span class="meta-value" id="metaClientesValor">0</span>
                                    </div>
                                    <div class="meta-progress">
                                        <div class="progress-header">
                                            <span id="metaClientesAtingido">0 conquistaçãos</span>
                                            <span id="metaClientesPercent">0%</span>
                                        </div>
                                        <div class="progress-bar">
                                            <div class="progress-fill" id="metaClientesFill" style="width: 0%"></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="meta-item">
                                    <div class="meta-header">
                                        <span class="meta-title">Ticket Médio</span>
                                        <span class="meta-value" id="metaTicketValor">R$ 0</span>
                                    </div>
                                    <div class="meta-progress">
                                        <div class="progress-header">
                                            <span id="metaTicketAtingido">R$ 0 atual</span>
                                            <span id="metaTicketPercent">0%</span>
                                        </div>
                                        <div class="progress-bar">
                                            <div class="progress-fill" id="metaTicketFill" style="width: 0%"></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="meta-item">
                                    <div class="meta-header">
                                        <span class="meta-title">Conversão</span>
                                        <span class="meta-value" id="metaConversaoValor">0%</span>
                                    </div>
                                    <div class="meta-progress">
                                        <div class="progress-header">
                                            <span id="metaConversaoAtingido">0% atual</span>
                                            <span id="metaConversaoPercent">0%</span>
                                        </div>
                                        <div class="progress-bar">
                                            <div class="progress-fill success" id="metaConversaoFill" style="width: 0%"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Últimas Vendas -->
                    <div class="section-card">
                        <div class="section-header">
                            <h3><i class="fas fa-clock"></i> Últimas Vendas da Equipe</h3>
                        </div>
                        <div class="section-content">
                            <div class="vendas-list" id="ultimasVendas">
                                <div style="text-align: center; padding: 30px; color: #94a3b8;">
                                    <i class="fas fa-spinner fa-spin" style="font-size: 24px;"></i>
                                    <p style="margin-top: 10px;">Carregando vendas...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal Definir Meta -->
    <div class="modal-overlay" id="modalMeta">
        <div class="modal">
            <div class="modal-header">
                <h2><i class="fas fa-bullseye" style="color: var(--primary-orange); margin-right: 8px;"></i> Definir Nova Meta</h2>
                <button class="modal-close" onclick="fecharModalMeta()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Tipo de Meta</label>
                    <select id="tipoMeta">
                        <option value="vendedor">Meta Individual (Vendedor)</option>
                        <option value="equipe">Meta da Equipe</option>
                        <option value="geral">Meta Geral</option>
                    </select>
                </div>
                <div class="form-group" id="selectVendedorGroup">
                    <label>Vendedor</label>
                    <select id="selectVendedor">
                        <option value="">Selecione um vendedor</option>
                        <option value="1">João Silva</option>
                        <option value="2">Maria Santos</option>
                        <option value="3">Pedro Costa</option>
                        <option value="4">Ana Ferreira</option>
                        <option value="5">Ricardo Lima</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Valor da Meta (R$)</label>
                    <input type="text" id="valorMeta" placeholder="Ex: 50.000">
                </div>
                <div class="form-group">
                    <label>Período</label>
                    <select id="periodoMeta">
                        <option value="mensal">Mensal</option>
                        <option value="trimestral">Trimestral</option>
                        <option value="anual">Anual</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="fecharModalMeta()">Cancelar</button>
                <button class="btn-primary" onclick="salvarMeta()">
                    <i class="fas fa-save"></i> Salvar Meta
                </button>
            </div>
        </div>
    </div>

    <script>
        // Mapeamento de avatares por nome de usuário
        const avatarNameMap = {
            'clemerson': '/avatars/Clemerson.webp',
            'isabela': '/avatars/Isabela.webp',
            'thaina': '/avatars/Thaina.webp',
            'thiago': '/avatars/Thiago.webp',
            'nicolas': '/avatars/NicolasDaniel.webp',
            'nicolasdaniel': '/avatars/NicolasDaniel.webp',
            'rh': '/avatars/Rh.webp',
            'admin': '/avatars/admin.webp',
            'ti': '/avatars/TI.webp',
            'tialuforce': '/avatars/TI.webp',
            'antonio': '/avatars/Antonio.webp',
            'andreia': '/avatars/Andreia.webp',
            'guilherme': '/avatars/Guilherme.webp'
        };

        function getAvatarFromEmail(email, nome) {
            if (!email) return null;
            const username = email.split('@')[0].split('.')[0].toLowerCase();
            if (avatarNameMap[username]) return avatarNameMap[username];
            if (nome) {
                const firstName = nome.split(' ')[0].toLowerCase();
                if (avatarNameMap[firstName]) return avatarNameMap[firstName];
            }
            return null;
        }

        // Carregar daçãos do usuário logação via API
        async function carregarUsuario() {
            try {
                const response = await fetch('/api/me', { credentials: 'include' });
                if (response.ok) {
                    const user = await response.json();
                    // Usar apelido se disponível, senão primeiro nome
                    const userName = user.apelido || user.nome || 'Usuário';
                    const primeiroNome = user.apelido || (user.nome  user.nome.split(' ')[0] : 'Usuário');
                    let userAvatar = user.avatar && user.avatar !== '/avatars/default.webp'  user.avatar : null;
                    if (!userAvatar) {
                        userAvatar = getAvatarFromEmail(user.email, userName);
                    }
                    
                    // Atualizar saudação dinâmica baseada na hora
                    const greetingTextEl = document.getElementById('greeting-text');
                    if (greetingTextEl) {
                        const hour = new Date().getHours();
                        let greeting = 'Bom dia';
                        if (hour >= 12 && hour < 18) greeting = 'Boa tarde';
                        else if (hour >= 18 || hour < 5) greeting = 'Boa noite';
                        greetingTextEl.textContent = greeting;
                    }
                    
                    // Atualizar nome na saudação do header
                    const userNameEl = document.getElementById('user-name');
                    if (userNameEl) {
                        userNameEl.textContent = primeiroNome;
                    }
                    
                    // Atualizar avatar/foto
                    const userPhotoEl = document.getElementById('user-photo');
                    const userInitialEl = document.getElementById('user-initial');
                    
                    if (userAvatar && userPhotoEl) {
                        userPhotoEl.src = userAvatar;
                        userPhotoEl.classList.add('visible');
                        userPhotoEl.style.display = 'block';
                        if (userInitialEl) userInitialEl.style.display = 'none';
                    } else if (userInitialEl) {
                        userInitialEl.textContent = userName.charAt(0).toUpperCase();
                        userInitialEl.style.display = 'flex';
                        if (userPhotoEl) userPhotoEl.style.display = 'none';
                    }
                }
            } catch (error) {
                console.error('Erro ao carregar usuário:', error);
            }
        }

        // Modal de Meta
        function abrirModalMeta() {
            document.getElementById('modalMeta').classList.add('active');
        }

        function fecharModalMeta() {
            document.getElementById('modalMeta').classList.remove('active');
        }

        function salvarMeta() {
            const tipo = document.getElementById('tipoMeta').value;
            const vendedor = document.getElementById('selectVendedor').value;
            const valor = document.getElementById('valorMeta').value;
            const periodo = document.getElementById('periodoMeta').value;

            if (!valor) {
                alert('Informe o valor da meta');
                return;
            }

            if (tipo === 'vendedor' && !vendedor) {
                alert('Selecione um vendedor');
                return;
            }

            // Aqui seria enviação para a API
            console.log('Meta a salvar:', { tipo, vendedor, valor, periodo });
            alert('Meta definida com sucesso!');
            fecharModalMeta();
        }

        // Toggle vendedor select
        document.getElementById('tipoMeta').addEventListener('change', function() {
            const vendedorGroup = document.getElementById('selectVendedorGroup');
            vendedorGroup.style.display = this.value === 'vendedor'  'block' : 'none';
        });

        function exportarRelatorio() {
            alert('Funcionalidade de exportação será implementada em breve.');
        }

        // ====================================
        // DADOS EM TEMPO REAL
        // ====================================

        // Formatar moeda
        function formatarMoeda(valor) {
            if (valor >= 1000000) {
                return 'R$ ' + (valor / 1000000).toFixed(1) + 'M';
            } else if (valor >= 1000) {
                return 'R$ ' + (valor / 1000).toFixed(0) + 'K';
            }
            return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL', maximumFractionDigits: 0 }).format(valor || 0);
        }

        // Formatar tempo relativo
        function formatarTempoRelativo(data) {
            const agora = new Date();
            const dataVenda = new Date(data);
            const diffMs = agora - dataVenda;
            const diffMin = Math.floor(diffMs / 60000);
            const diffHoras = Math.floor(diffMs / 3600000);
            const diffDias = Math.floor(diffMs / 86400000);

            if (diffMin < 60) return `Há ${diffMin} minuto${diffMin !== 1  's' : ''}`;
            if (diffHoras < 24) return `Há ${diffHoras} hora${diffHoras !== 1  's' : ''}`;
            if (diffDias === 1) return 'Há 1 dia';
            if (diffDias < 7) return `Há ${diffDias} dias`;
            return dataVenda.toLocaleDateString('pt-BR');
        }

        // Carregar Metas do Mês
        async function carregarMetas() {
            try {
                // Buscar daçãos de vendas do mês atual
                const agora = new Date();
                const inicioMes = new Date(agora.getFullYear(), agora.getMonth(), 1).toISOString().split('T')[0];
                const fimMes = new Date(agora.getFullYear(), agora.getMonth() + 1, 0).toISOString().split('T')[0];

                const [pedidosRes, clientesRes, metasRes] = await Promise.all([
                    fetch(`/api/vendas/pedidosdata_inicio=${inicioMes}&data_fim=${fimMes}`, { credentials: 'include' }),
                    fetch('/api/vendas/empresasativas=true', { credentials: 'include' }),
                    fetch('/api/vendas/metas', { credentials: 'include' }).catch(() => null)
                ]);

                const pedidos = pedidosRes.ok  await pedidosRes.json() : [];
                const clientes = clientesRes.ok  await clientesRes.json() : [];

                // Metas padrão (podem vir do banco)
                let metas = { geral: 300000, clientes: 20, ticketMedio: 2500, conversao: 40 };
                if (metasRes && metasRes.ok) {
                    const metasData = await metasRes.json();
                    if (metasData) metas = { ...metas, ...metasData };
                }

                // Calcular valores reais
                const pedidosFaturaçãos = pedidos.filter(p => p.status === 'faturação');
                const faturamentoTotal = pedidosFaturaçãos.reduce((sum, p) => sum + (parseFloat(p.valor) || 0), 0);
                const totalPedidos = pedidos.length;
                const pedidosAprovaçãos = pedidos.filter(p => ['faturação', 'aprovação', 'pedido_aprovação', 'faturar'].includes(p.status)).length;
                const ticketMedioAtual = totalPedidos > 0  faturamentoTotal / pedidosFaturaçãos.length || 0 : 0;
                const taxaConversao = totalPedidos > 0  ((pedidosAprovaçãos / totalPedidos) * 100) : 0;

                // Clientes novos no mês (criaçãos este mês)
                const clientesNovosMes = clientes.filter(c => {
                    const created = new Date(c.created_at || c.data_cadastro);
                    return created >= new Date(inicioMes);
                }).length;

                // Atualizar Meta Geral
                const percentGeral = Math.min(100, ((faturamentoTotal / metas.geral) * 100).toFixed(0));
                document.getElementById('metaGeralValor').textContent = formatarMoeda(metas.geral);
                document.getElementById('metaGeralAtingido').textContent = formatarMoeda(faturamentoTotal) + ' atingidos';
                document.getElementById('metaGeralPercent').textContent = percentGeral + '%';
                document.getElementById('metaGeralFill').style.width = percentGeral + '%';

                // Atualizar Novos Clientes
                const percentClientes = Math.min(100, ((clientesNovosMes / metas.clientes) * 100).toFixed(0));
                document.getElementById('metaClientesValor').textContent = metas.clientes;
                document.getElementById('metaClientesAtingido').textContent = clientesNovosMes + ' conquistaçãos';
                document.getElementById('metaClientesPercent').textContent = percentClientes + '%';
                document.getElementById('metaClientesFill').style.width = percentClientes + '%';

                // Atualizar Ticket Médio
                const percentTicket = Math.min(100, ((ticketMedioAtual / metas.ticketMedio) * 100).toFixed(0));
                document.getElementById('metaTicketValor').textContent = formatarMoeda(metas.ticketMedio);
                document.getElementById('metaTicketAtingido').textContent = formatarMoeda(ticketMedioAtual) + ' atual';
                document.getElementById('metaTicketPercent').textContent = percentTicket + '%';
                document.getElementById('metaTicketFill').style.width = percentTicket + '%';

                // Atualizar Conversão
                const percentConversao = Math.min(100, ((taxaConversao / metas.conversao) * 100).toFixed(0));
                document.getElementById('metaConversaoValor').textContent = metas.conversao + '%';
                document.getElementById('metaConversaoAtingido').textContent = taxaConversao.toFixed(0) + '% atual';
                document.getElementById('metaConversaoPercent').textContent = percentConversao + '%';
                document.getElementById('metaConversaoFill').style.width = percentConversao + '%';

            } catch (error) {
                console.error('Erro ao carregar metas:', error);
            }
        }

        // Carregar Últimas Vendas da Equipe
        async function carregarUltimasVendas() {
            const container = document.getElementById('ultimasVendas');
            
            try {
                // Buscar últimos pedidos
                const response = await fetch('/api/vendas/pedidoslimit=10', { credentials: 'include' });
                
                if (!response.ok) throw new Error('Erro ao buscar pedidos');
                
                let pedidos = await response.json();
                
                // Ordenar por data mais recente e pegar os últimos 5
                pedidos = pedidos
                    .sort((a, b) => new Date(b.created_at || b.data) - new Date(a.created_at || a.data))
                    .slice(0, 5);

                if (pedidos.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 30px; color: #94a3b8;">
                            <i class="fas fa-shopping-cart" style="font-size: 32px; margin-bottom: 10px;"></i>
                            <p>Nenhuma venda recente</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = pedidos.map(p => {
                    const cliente = p.cliente || p.empresa_nome || p.nome_fantasia || p.razao_social || 'Cliente';
                    const vendedor = p.vendedor_nome || p.vendedor || p.created_by_nome || 'Vendedor';
                    const tempo = formatarTempoRelativo(p.created_at || p.data);
                    const valor = parseFloat(p.valor) || parseFloat(p.valor_total) || 0;
                    
                    return `
                        <div class="venda-item">
                            <div class="venda-info">
                                <span class="venda-cliente">${cliente}</span>
                                <span class="venda-vendedor">${vendedor.split(' ')[0]} • ${tempo}</span>
                            </div>
                            <span class="venda-valor">${formatarMoeda(valor)}</span>
                        </div>
                    `;
                }).join('');

            } catch (error) {
                console.error('Erro ao carregar últimas vendas:', error);
                container.innerHTML = `
                    <div style="text-align: center; padding: 30px; color: #ef4444;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 24px; margin-bottom: 10px;"></i>
                        <p>Erro ao carregar vendas</p>
                    </div>
                `;
            }
        }

        // Atualização automática a cada 30 segundos
        function iniciarAtualizacaoAutomatica() {
            // Carregar daçãos iniciais
            carregarMetas();
            carregarUltimasVendas();
            carregarRankingVendedores();
            carregarContaçãores();

            // Atualizar a cada 30 segundos
            setInterval(() => {
                carregarMetas();
                carregarUltimasVendas();
                carregarRankingVendedores();
                carregarContaçãores();
            }, 30000);
        }

        // Carregar Contaçãores do Dashboard (5 cards principais)
        async function carregarContaçãores() {
            const META_POR_VENDEDOR = 50000; // Meta mensal por vendedor

            try {
                const agora = new Date();
                
                // Datas do mês atual
                const inicioMesAtual = new Date(agora.getFullYear(), agora.getMonth(), 1).toISOString().split('T')[0];
                const fimMesAtual = new Date(agora.getFullYear(), agora.getMonth() + 1, 0).toISOString().split('T')[0];
                
                // Datas do mês anterior
                const inicioMesAnterior = new Date(agora.getFullYear(), agora.getMonth() - 1, 1).toISOString().split('T')[0];
                const fimMesAnterior = new Date(agora.getFullYear(), agora.getMonth(), 0).toISOString().split('T')[0];

                // Buscar pedidos do mês atual, mês anterior e vendedores
                const [pedidosAtualRes, pedidosAnteriorRes, vendedoresRes] = await Promise.all([
                    fetch(`/api/vendas/pedidosdata_inicio=${inicioMesAtual}&data_fim=${fimMesAtual}`, { credentials: 'include' }),
                    fetch(`/api/vendas/pedidosdata_inicio=${inicioMesAnterior}&data_fim=${fimMesAnterior}`, { credentials: 'include' }),
                    fetch('/api/vendas/vendedores', { credentials: 'include' })
                ]);

                const pedidosAtual = pedidosAtualRes.ok  await pedidosAtualRes.json() : [];
                const pedidosAnterior = pedidosAnteriorRes.ok  await pedidosAnteriorRes.json() : [];
                const vendedores = vendedoresRes.ok  await vendedoresRes.json() : [];

                // 1. VENDAS DO MÊS
                const totalVendasAtual = pedidosAtual.reduce((sum, p) => sum + (parseFloat(p.valor) || parseFloat(p.valor_total) || 0), 0);
                const totalVendasAnterior = pedidosAnterior.reduce((sum, p) => sum + (parseFloat(p.valor) || parseFloat(p.valor_total) || 0), 0);
                
                const variacaoVendas = totalVendasAnterior > 0 
                     ((totalVendasAtual - totalVendasAnterior) / totalVendasAnterior * 100).toFixed(0)
                    : 100;

                document.getElementById('totalVendasMes').textContent = formatarMoeda(totalVendasAtual);
                
                const trendVendas = document.getElementById('trendVendasMes');
                const isUpVendas = parseFloat(variacaoVendas) >= 0;
                trendVendas.className = `stat-trend ${isUpVendas  'up' : 'down'}`;
                trendVendas.innerHTML = `
                    <i class="fas fa-arrow-${isUpVendas  'up' : 'down'}"></i>
                    <span>${Math.abs(variacaoVendas)}% vs mês anterior</span>
                `;

                // 2. META DA EQUIPE
                const totalVendedores = vendedores.length || 5;
                const metaTotal = totalVendedores * META_POR_VENDEDOR;
                const percentualMeta = metaTotal > 0  ((totalVendasAtual / metaTotal) * 100).toFixed(0) : 0;
                
                document.getElementById('metaEquipe').textContent = `${percentualMeta}%`;
                
                const trendMeta = document.getElementById('trendMetaEquipe');
                trendMeta.className = `stat-trend ${percentualMeta >= 80  'up' : 'down'}`;
                trendMeta.innerHTML = `
                    <i class="fas fa-arrow-${percentualMeta >= 80  'up' : 'down'}"></i>
                    <span>${formatarMoeda(metaTotal)} objetivo</span>
                `;

                // 3. VENDEDORES ATIVOS (que fizeram pelo menos 1 venda no mês)
                const vendedoresAtivos = new Set();
                pedidosAtual.forEach(p => {
                    const vendedorId = p.vendedor_id || p.created_by;
                    if (vendedorId) vendedoresAtivos.add(vendedorId);
                });
                
                document.getElementById('totalVendedores').textContent = vendedoresAtivos.size || totalVendedores;

                // 4. PEDIDOS NO MÊS
                const totalPedidosAtual = pedidosAtual.length;
                const totalPedidosAnterior = pedidosAnterior.length;
                
                const variacaoPedidos = totalPedidosAnterior > 0 
                     ((totalPedidosAtual - totalPedidosAnterior) / totalPedidosAnterior * 100).toFixed(0)
                    : 100;

                document.getElementById('pedidosMes').textContent = totalPedidosAtual;
                
                const trendPedidos = document.getElementById('trendPedidosMes');
                const isUpPedidos = parseFloat(variacaoPedidos) >= 0;
                trendPedidos.className = `stat-trend ${isUpPedidos  'up' : 'down'}`;
                trendPedidos.innerHTML = `
                    <i class="fas fa-arrow-${isUpPedidos  'up' : 'down'}"></i>
                    <span>${Math.abs(variacaoPedidos)}% vs mês anterior</span>
                `;

                // 5. VENDEDORES ABAIXO DA META
                const vendasPorVendedor = {};
                pedidosAtual.forEach(p => {
                    const vendedorId = p.vendedor_id || p.created_by;
                    if (vendedorId) {
                        if (!vendasPorVendedor[vendedorId]) vendasPorVendedor[vendedorId] = 0;
                        vendasPorVendedor[vendedorId] += parseFloat(p.valor) || parseFloat(p.valor_total) || 0;
                    }
                });

                let abaixoMeta = 0;
                // Verificar todos os vendedores cadastraçãos
                vendedores.forEach(v => {
                    const vendasVendedor = vendasPorVendedor[v.id] || 0;
                    // Considera abaixo da meta quem está com menos de 80% da meta
                    if (vendasVendedor < (META_POR_VENDEDOR * 0.8)) {
                        abaixoMeta++;
                    }
                });

                document.getElementById('abaixoMeta').textContent = abaixoMeta;

            } catch (error) {
                console.error('Erro ao carregar contaçãores:', error);
                // Mostrar erro nos contaçãores
                document.getElementById('totalVendasMes').textContent = 'Erro';
                document.getElementById('metaEquipe').textContent = '--';
                document.getElementById('totalVendedores').textContent = '--';
                document.getElementById('pedidosMes').textContent = '--';
                document.getElementById('abaixoMeta').textContent = '--';
            }
        }

        // Carregar Ranking de Vendedores
        async function carregarRankingVendedores() {
            const tbody = document.getElementById('rankingTableBody');
            const mesAnoEl = document.getElementById('rankingMesAno');
            
            // Atualizar título com mês/ano atual
            const agora = new Date();
            const meses = ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho', 
                          'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
            if (mesAnoEl) {
                mesAnoEl.textContent = `${meses[agora.getMonth()]} ${agora.getFullYear()}`;
            }

            try {
                // Datas do mês atual
                const inicioMes = new Date(agora.getFullYear(), agora.getMonth(), 1).toISOString().split('T')[0];
                const fimMes = new Date(agora.getFullYear(), agora.getMonth() + 1, 0).toISOString().split('T')[0];

                // Buscar pedidos do mês e vendedores
                const [pedidosRes, vendedoresRes] = await Promise.all([
                    fetch(`/api/vendas/pedidosdata_inicio=${inicioMes}&data_fim=${fimMes}`, { credentials: 'include' }),
                    fetch('/api/vendas/vendedores', { credentials: 'include' })
                ]);

                const pedidos = pedidosRes.ok  await pedidosRes.json() : [];
                const vendedoresList = vendedoresRes.ok  await vendedoresRes.json() : [];

                // Mapeamento de nomes dos vendedores reais da equipe comercial
                const vendedoresReais = {
                    'Marcia Oliveira do Nascimento Scarcella': { apelido: 'Márcia Scarcella', email: 'marcia.scarcella@aluforce.com.br' },
                    'Márcia Scarcella': { apelido: 'Márcia Scarcella', email: 'marcia.scarcella@aluforce.com.br' },
                    'Augusto Ladeira dos Santos': { apelido: 'Augusto Ladeira', email: 'augusto.ladeira@aluforce.com.br' },
                    'Augusto Ladeira': { apelido: 'Augusto Ladeira', email: 'augusto.ladeira@aluforce.com.br' },
                    'Renata Maria Batista do Nascimento': { apelido: 'Renata Nascimento', email: 'renata.nascimento@aluforce.com.br' },
                    'Renata Nascimento': { apelido: 'Renata Nascimento', email: 'renata.nascimento@aluforce.com.br' },
                    'Fabiano Marques de Oliveira': { apelido: 'Fabiano Marques', email: 'fabiano.marques@aluforce.com.br' },
                    'Fabiano Marques': { apelido: 'Fabiano Marques', email: 'fabiano.marques@aluforce.com.br' },
                    'Fabiola de Souza Santos': { apelido: 'Fabíola Souza', email: 'fabiola.souza@aluforce.com.br' },
                    'Fabíola Souza': { apelido: 'Fabíola Souza', email: 'fabiola.souza@aluforce.com.br' },
                    'Vendedor': { apelido: 'Sem Vendedor', email: 'comercial@aluforce.com.br' }
                };

                // Agregar daçãos por vendedor
                const vendedoresMap = {};
                
                // Inicializar com vendedores da lista (apenas ativos)
                vendedoresList.forEach(v => {
                    const nomeOriginal = v.nome || 'Vendedor';
                    const vendedorInfo = vendedoresReais[nomeOriginal] || { apelido: nomeOriginal, email: v.email };
                    vendedoresMap[v.id] = {
                        id: v.id,
                        nome: vendedorInfo.apelido,
                        email: v.email || vendedorInfo.email || `vendedor@aluforce.com.br`,
                        avatar: v.avatar || v.foto || null,
                        vendas: 0,
                        pedidos: 0,
                        meta: 50000 // Meta padrão - pode vir do banco
                    };
                });

                // Agregar pedidos por vendedor (somente se o vendedor está na lista de ativos)
                pedidos.forEach(p => {
                    const vendedorId = p.vendedor_id || p.created_by;
                    
                    // Só processar se o vendedor estiver na lista de ativos
                    if (!vendedoresMap[vendedorId]) {
                        return; // Pular pedidos de vendedores inativos
                    }
                    
                    vendedoresMap[vendedorId].vendas += parseFloat(p.valor) || parseFloat(p.valor_total) || 0;
                    vendedoresMap[vendedorId].pedidos++;
                });

                // Converter para array, ordenar por vendas e calcular métricas
                const ranking = Object.values(vendedoresMap)
                    .filter(v => v.vendas > 0 || v.pedidos > 0)
                    .sort((a, b) => b.vendas - a.vendas)
                    .map((v, index) => ({
                        ...v,
                        posicao: index + 1,
                        progresso: Math.min(150, ((v.vendas / v.meta) * 100)),
                        ticketMedio: v.pedidos > 0  v.vendas / v.pedidos : 0
                    }));

                if (ranking.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="7" style="text-align: center; padding: 40px; color: #94a3b8;">
                                <i class="fas fa-trophy" style="font-size: 32px; margin-bottom: 10px;"></i>
                                <p>Nenhuma venda registrada neste mês</p>
                            </td>
                        </tr>
                    `;
                    return;
                }

                tbody.innerHTML = ranking.slice(0, 10).map(v => {
                    const iniciais = v.nome.split(' ')
                        .filter((_, i, arr) => i === 0 || i === arr.length - 1)
                        .map(n => n.charAt(0).toUpperCase())
                        .join('');
                    
                    // Construir avatar: usar imagem se disponível, senão iniciais
                    const avatarHtml = v.avatar 
                         `<img src="${v.avatar}" alt="${v.nome}" class="vendedor-avatar-img" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                           <div class="vendedor-avatar" style="display:none;">${iniciais}</div>`
                        : `<div class="vendedor-avatar">${iniciais}</div>`;
                    
                    const badgeClass = v.posicao === 1  'gold' : v.posicao === 2  'silver' : v.posicao === 3  'bronze' : '';
                    const badgeStyle = v.posicao > 3  'background: #f3f4f6; color: #6b7280;' : '';
                    
                    const progressColor = v.progresso >= 100  '#22c55e' : v.progresso >= 80  '#f97316' : '#ef4444';
                    const progressClass = v.progresso >= 100  'success' : '';
                    const progressWidth = Math.min(100, v.progresso);

                    return `
                        <tr>
                            <td><span class="badge ${badgeClass}" style="${badgeStyle}">${v.posicao}º</span></td>
                            <td>
                                <div class="vendedor-info">
                                    ${avatarHtml}
                                    <div>
                                        <div class="vendedor-nome">${v.nome}</div>
                                        <div class="vendedor-email">${v.email}</div>
                                    </div>
                                </div>
                            </td>
                            <td><strong>${formatarMoeda(v.vendas)}</strong></td>
                            <td>${formatarMoeda(v.meta)}</td>
                            <td>
                                <div class="progress-mini">
                                    <div class="progress-mini-fill ${progressClass}" style="width: ${progressWidth}%"></div>
                                </div>
                                <span style="font-size: 12px; color: ${progressColor};">${v.progresso.toFixed(0)}%</span>
                            </td>
                            <td>${v.pedidos}</td>
                            <td>${formatarMoeda(v.ticketMedio)}</td>
                        </tr>
                    `;
                }).join('');

            } catch (error) {
                console.error('Erro ao carregar ranking:', error);
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 40px; color: #ef4444;">
                            <i class="fas fa-exclamation-triangle" style="font-size: 24px; margin-bottom: 10px;"></i>
                            <p>Erro ao carregar ranking</p>
                        </td>
                    </tr>
                `;
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            carregarUsuario();
            iniciarAtualizacaoAutomatica();
        });
    </script>
    
    <!-- Sistema de Chat e Suporte (widgets condicionais por usuário) --></body>
</html>

