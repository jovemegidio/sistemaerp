<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <link rel="icon" type="image/x-icon" href="/favicon-aluforce.webp">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>ALUFORCE - Vendas e NF-e</title>
    
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --sidebar-width: 56px;
            --header-height: 48px;
            --tab-height: 0px;
            --primary-orange: #225cfa;
            --primary-dark: #1a1a2e;
            --bg-gray: #ffffff;
            --border-color: #e5e5e5;
            --text-primary: #1a1a1a;
            --text-secondary: #666;
            --success-green: #22c55e;
            --warning-yellow: #eab308;
            --danger-red: #ef4444;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #ffffff;
            color: var(--text-primary);
            overflow: hidden;
        }

        /* ========================================
           LAYOUT PRINCIPAL
           ======================================== */
        .app-container {
            display: flex;
            height: 100vh;
        }

        /* ========================================
           SIDEBAR LATERAL (Estilo Omie)
           ======================================== */
        .sidebar {
            width: var(--sidebar-width);
            background: var(--primary-dark);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 12px 0;
            z-index: 100;
        }

        .sidebar-logo {
            width: 36px;
            height: 36px;
            background: var(--primary-orange);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
            cursor: pointer;
        }

        .sidebar-logo i {
            color: white;
            font-size: 18px;
        }

        .sidebar-nav {
            display: flex;
            flex-direction: column;
            gap: 4px;
            flex: 1;
        }

        .sidebar-btn {
            width: 40px;
            height: 40px;
            border: none;
            background: transparent;
            color: #8b8b9a;
            border-radius: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: all 0.2s;
            position: relative;
        }

        .sidebar-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .sidebar-btn.active {
            background: var(--primary-orange);
            color: white;
        }

        .sidebar-btn .badge {
            position: absolute;
            top: 4px;
            right: 4px;
            background: var(--danger-red);
            color: white;
            font-size: 10px;
            padding: 2px 5px;
            border-radius: 10px;
            font-weight: 600;
        }

        .sidebar-bottom {
            margin-top: auto;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        /* ========================================
           MAIN CONTENT AREA
           ======================================== */
        .main-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* ========================================
           HEADER SUPERIOR
           ======================================== */
        .header {
            height: var(--header-height);
            background: var(--primary-dark);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 16px;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 24px;
        }

        .header-brand {
            display: flex;
            align-items: center;
            gap: 8px;
            color: white;
        }

        .header-brand img {
            height: 24px;
        }

        .header-brand span {
            font-size: 14px;
            font-weight: 600;
            color: #8b8b9a;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .header-btn {
            width: 36px;
            height: 36px;
            border: none;
            background: transparent;
            color: #8b8b9a;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            transition: all 0.2s;
        }

        .header-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            margin-left: 8px;
            overflow: hidden;
        }

        .user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: none;
        }

        .user-avatar img.visible {
            display: block;
        }

        .user-greeting {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-left: 16px;
            color: #8b8b9a;
            font-size: 13px;
        }

        .user-greeting strong {
            color: white;
        }

        /* ========================================
           TABS BAR - Estilo Omie
           ======================================== */
        .tabs-bar {
            display: flex;
            align-items: center;
            background: #f5f5f5;
            padding: 8px 16px;
            gap: 4px;
            border-bottom: 1px solid var(--border-color);
        }

        .tab {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: transparent;
            border: none;
            border-radius: 6px 6px 0 0;
            color: var(--text-secondary);
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

        .tab:hover {
            background: #e5e5e5;
        }

        .tab.active {
            background: var(--primary-orange);
            color: white;
        }

        .tab .close-tab {
            margin-left: 4px;
            opacity: 0.7;
            font-size: 12px;
            width: 16px;
            height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        .tab .close-tab:hover {
            opacity: 1;
            background: rgba(255,255,255,0.2);
        }

        .tabs-actions {
            margin-left: auto;
            display: flex;
            gap: 8px;
        }

        .tab-action-btn {
            width: 32px;
            height: 32px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            transition: all 0.2s;
        }

        .tab-action-btn:hover {
            background: #e5e5e5;
        }

        /* ========================================
           WHATSAPP BUTTON
           ======================================== */
        .whatsapp-btn {
            position: fixed;
            bottom: 24px;
            right: 24px;
            width: 56px;
            height: 56px;
            background: #25D366;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(37, 211, 102, 0.4);
            cursor: pointer;
            z-index: 1000;
            transition: all 0.3s ease;
            border: none;
        }

        .whatsapp-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(37, 211, 102, 0.5);
        }

        .whatsapp-btn i {
            color: white;
            font-size: 28px;
        }

        /* ========================================
           FILTROS BAR
           ======================================== */
        .filters-bar {
            background: white;
            padding: 12px 16px;
            display: flex;
            align-items: center;
            gap: 16px;
            border-bottom: 1px solid var(--border-color);
        }

        .search-box {
            display: flex;
            align-items: center;
            background: #f5f5f5;
            border-radius: 8px;
            padding: 0 12px;
            width: 300px;
        }

        .search-box i {
            color: #999;
            font-size: 14px;
        }

        .search-box input {
            border: none;
            background: transparent;
            padding: 10px 12px;
            font-size: 14px;
            width: 100%;
            outline: none;
        }

        .filter-link {
            color: var(--primary-orange);
            font-size: 13px;
            font-weight: 500;
            text-decoration: none;
            cursor: pointer;
        }

        .filter-link:hover {
            text-decoration: underline;
        }

        /* ========================================
           KANBAN BOARD
           ======================================== */
        .kanban-container {
            flex: 1;
            overflow-x: auto;
            overflow-y: hidden;
            padding: 12px;
            background: var(--bg-gray);
            height: calc(100vh - var(--header-height) - 60px);
        }

        .kanban-board {
            display: flex;
            gap: 12px;
            height: 100%;
            width: 100%;
        }

        .kanban-column {
            flex: 1;
            min-width: 200px;
            max-width: none;
            background: white;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        .kanban-column-header {
            padding: 16px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .column-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .column-count {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 2px;
        }

        .column-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .column-indicator.orcamento { background: #94a3b8; }
        .column-indicator.analise { background: #f59e0b; }
        .column-indicator.aprovado { background: #10b981; }
        .column-indicator.faturar { background: #f97316; }
        .column-indicator.faturado { background: #22c55e; }
        .column-indicator.entregue { background: #06b6d4; }

        .kanban-column-content {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .kanban-column-footer {
            padding: 12px 16px;
            border-top: 1px solid var(--border-color);
        }

        .btn-new-card {
            width: 100%;
            padding: 10px;
            background: var(--primary-orange);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            transition: all 0.2s;
        }

        .btn-new-card:hover {
            background: #ea580c;
        }

        .btn-action-card {
            width: 100%;
            padding: 10px;
            background: #22c55e;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            transition: all 0.2s;
        }

        .btn-action-card:hover {
            background: #16a34a;
        }

        .btn-action-card.teal {
            background: #06b6d4;
        }

        .btn-action-card.teal:hover {
            background: #0891b2;
        }

        /* ========================================
           KANBAN CARDS
           ======================================== */
        .kanban-card {
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 14px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

        .kanban-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

        .kanban-card.dragging {
            opacity: 0.5;
            transform: rotate(2deg);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }

        .card-number {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .card-menu {
            width: 24px;
            height: 24px;
            border: none;
            background: transparent;
            color: #999;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .card-menu:hover {
            background: #f5f5f5;
            color: var(--text-primary);
        }

        .card-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
            line-height: 1.4;
        }

        .card-status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 500;
            margin-bottom: 10px;
        }

        .card-status.atrasado {
            background: #fef2f2;
            color: #dc2626;
        }

        .card-status.faturado {
            background: #f0fdf4;
            color: #16a34a;
        }

        .card-status.cancelado {
            background: #fef2f2;
            color: #dc2626;
        }

        .card-status.em-dia {
            background: #eff6ff;
            color: #2563eb;
        }

        /* Cards na coluna Faturado têm borda verde à direita */
        .kanban-column[data-status="faturado"] .kanban-card {
            border-right: 4px solid #22c55e;
        }

        .card-value {
            font-size: 15px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 6px;
        }

        .card-meta {
            font-size: 11px;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .card-origin {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 11px;
            color: #22c55e;
            margin-top: 8px;
        }

        .card-origin i {
            font-size: 10px;
        }

        .card-transport {
            font-size: 10px;
            color: var(--text-secondary);
            margin-top: 6px;
            padding-top: 6px;
            border-top: 1px solid #f0f0f0;
        }

        .card-badge {
            position: absolute;
            top: 8px;
            right: 8px;
        }

        .card-badge.nf {
            background: #22c55e;
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 600;
        }

        .card-message {
            display: flex;
            align-items: flex-start;
            gap: 6px;
            margin-top: 8px;
            padding: 8px;
            background: #fef3c7;
            border-radius: 6px;
            font-size: 11px;
            color: #92400e;
        }

        .card-message i {
            margin-top: 2px;
        }

        /* Empty State */
        .empty-column {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-secondary);
        }

        .empty-column i {
            font-size: 32px;
            opacity: 0.3;
            margin-bottom: 12px;
        }

        .empty-column p {
            font-size: 13px;
        }

        /* ========================================
           RESPONSIVO
           ======================================== */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: #f5f5f5;
        }

        ::-webkit-scrollbar-thumb {
            background: #ccc;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #aaa;
        }

        /* ========================================
           MODAL EDITAR PEDIDO - ESTILO OMIE PROFISSIONAL
           ======================================== */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            padding: 0;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            width: 100%;
            max-width: 700px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 25px 60px rgba(0, 0, 0, 0.4);
            animation: modalSlideIn 0.3s ease;
        }

        /* Modal Grande Estilo Omie */
        .modal-content-omie {
            background: #f8f8f8;
            border-radius: 12px;
            width: 95%;
            max-width: 1200px;
            height: auto;
            max-height: 90vh;
            overflow: hidden;
            box-shadow: 0 25px 60px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.2s ease;
            display: flex;
            flex-direction: column;
        }

        @keyframes modalSlideIn {
            from { opacity: 0; transform: scale(0.98); }
            to { opacity: 1; transform: scale(1); }
        }

        /* Header Omie */
        .modal-header-omie {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 20px;
            background: white;
            border-bottom: 1px solid #e0e0e0;
            min-height: 50px;
        }

        .modal-header-omie h2 {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .modal-header-omie .close-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            background: none;
            border: none;
            color: #555;
            font-size: 13px;
            cursor: pointer;
            padding: 8px 14px;
            border-radius: 4px;
            transition: all 0.15s;
        }

        .modal-header-omie .close-btn:hover {
            background: #f0f0f0;
            color: #333;
        }

        /* Container Principal com Sidebar */
        .modal-container-omie {
            display: flex;
            flex: 1;
            overflow: hidden;
            max-height: calc(90vh - 60px);
        }

        /* Área de Conteúdo Principal */
        .modal-main-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px 24px;
            background: white;
            border-right: 1px solid #e5e5e5;
        }

        /* Sidebar de Ações - Estilo Omie */
        .modal-sidebar-actions {
            width: 160px;
            background: white;
            padding: 16px 12px;
            display: flex;
            flex-direction: column;
            gap: 2px;
            overflow-y: auto;
        }

        .sidebar-action-btn {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            background: none;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            color: #444;
            cursor: pointer;
            transition: all 0.15s;
            text-align: left;
            width: 100%;
        }

        .sidebar-action-btn:hover {
            background: #f5f5f5;
            color: #222;
        }

        .sidebar-action-btn i {
            width: 16px;
            text-align: center;
            color: var(--primary-orange);
            font-size: 13px;
        }

        .sidebar-action-btn.primary {
            background: var(--primary-orange);
            color: white;
            font-weight: 500;
        }

        .sidebar-action-btn.primary:hover {
            background: #ea580c;
        }

        .sidebar-action-btn.primary i {
            color: white;
        }

        .sidebar-action-btn.danger {
            color: #666;
        }

        .sidebar-action-btn.danger i {
            color: #999;
        }

        .sidebar-action-btn.danger:hover {
            background: #fef2f2;
            color: #dc2626;
        }

        .sidebar-action-btn.danger:hover i {
            color: #dc2626;
        }

        .sidebar-action-btn.outline-primary {
            border: 1px solid var(--primary-orange);
            color: var(--primary-orange);
            font-weight: 500;
            background: white;
        }

        .sidebar-action-btn.outline-primary:hover {
            background: #fff7ed;
        }

        /* Botão Faturar Agora - Destaque especial */
        .sidebar-action-btn.btn-faturar {
            background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
            color: white;
            border: none;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(249, 115, 22, 0.4);
            position: relative;
            overflow: hidden;
        }
        
        .sidebar-action-btn.btn-faturar::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }
        
        .sidebar-action-btn.btn-faturar:hover {
            background: linear-gradient(135deg, #ea580c 0%, #c2410c 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(249, 115, 22, 0.5);
        }
        
        .sidebar-action-btn.btn-faturar:hover::before {
            left: 100%;
        }
        
        .sidebar-action-btn.btn-faturar i {
            color: white;
        }

        /* Modal Histórico de Alterações - Profissional */
        .modal-historico-content {
            background: white;
            border-radius: 12px;
            width: 600px;
            max-width: 95vw;
            max-height: 85vh;
            overflow: hidden;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            animation: modalSlideIn 0.3s ease;
        }
        
        .modal-historico-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .modal-historico-header h2 {
            margin: 0;
            font-size: 18px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .modal-historico-header .close-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .modal-historico-header .close-btn:hover {
            background: rgba(255,255,255,0.3);
        }
        
        .modal-historico-body {
            padding: 24px;
            max-height: 60vh;
            overflow-y: auto;
        }
        
        .historico-timeline-pro {
            position: relative;
            padding-left: 30px;
        }
        
        .historico-timeline-pro::before {
            content: '';
            position: absolute;
            left: 10px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: linear-gradient(180deg, #667eea 0%, #764ba2 50%, #e0e7ff 100%);
        }
        
        .historico-item-pro {
            position: relative;
            padding: 16px 20px;
            background: #f8fafc;
            border-radius: 10px;
            margin-bottom: 16px;
            border-left: 3px solid #667eea;
            transition: all 0.2s;
        }
        
        .historico-item-pro:hover {
            background: #f1f5f9;
            transform: translateX(4px);
        }
        
        .historico-item-pro::before {
            content: '';
            position: absolute;
            left: -24px;
            top: 20px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #667eea;
            border: 3px solid white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .historico-item-pro.tipo-faturamento { border-left-color: #10b981; }
        .historico-item-pro.tipo-faturamento::before { background: #10b981; }
        
        .historico-item-pro.tipo-status { border-left-color: #8b5cf6; }
        .historico-item-pro.tipo-status::before { background: #8b5cf6; }
        
        .historico-item-pro.tipo-edicao { border-left-color: #f97316; }
        .historico-item-pro.tipo-edicao::before { background: #f97316; }
        
        .historico-item-pro.tipo-criacao { border-left-color: #06b6d4; }
        .historico-item-pro.tipo-criacao::before { background: #06b6d4; }
        
        .historico-item-pro.tipo-item { border-left-color: #ec4899; }
        .historico-item-pro.tipo-item::before { background: #ec4899; }
        
        .historico-header-pro {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
        }
        
        .historico-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .historico-badge.badge-faturamento {
            background: #d1fae5;
            color: #059669;
        }
        
        .historico-badge.badge-status {
            background: #ede9fe;
            color: #7c3aed;
        }
        
        .historico-badge.badge-edicao {
            background: #ffedd5;
            color: #c2410c;
        }
        
        .historico-badge.badge-criacao {
            background: #cffafe;
            color: #0891b2;
        }
        
        .historico-badge.badge-item {
            background: #fce7f3;
            color: #be185d;
        }
        
        .historico-data-pro {
            font-size: 12px;
            color: #94a3b8;
        }
        
        .historico-descricao-pro {
            font-size: 14px;
            color: #334155;
            line-height: 1.5;
            margin-bottom: 8px;
        }
        
        .historico-usuario-pro {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            color: #64748b;
        }
        
        .historico-usuario-pro i {
            font-size: 10px;
        }
        
        .historico-empty {
            text-align: center;
            padding: 40px 20px;
            color: #94a3b8;
        }
        
        .historico-empty i {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }
        
        .historico-empty p {
            margin: 0;
            font-size: 14px;
        }

        .sidebar-divider {
            height: 1px;
            background: #eee;
            margin: 8px 0;
        }

        /* Seção do Cliente - Melhorado */
        .cliente-section {
            display: flex;
            align-items: flex-start;
            gap: 16px;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid #eee;
        }

        .cliente-avatar {
            width: 44px;
            height: 44px;
            background: var(--primary-orange);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 16px;
            font-weight: 700;
            flex-shrink: 0;
        }

        .cliente-info {
            flex: 1;
        }

        .cliente-info-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 6px;
        }

        .cliente-nome-input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
            font-weight: 500;
            background: white;
        }

        .cliente-nome-input:focus {
            outline: none;
            border-color: var(--primary-orange);
            box-shadow: 0 0 0 2px rgba(249, 115, 22, 0.1);
        }

        /* Autocomplete Dropdown para Cliente/Empresa */
        .cliente-autocomplete-wrapper {
            position: relative;
            flex: 1;
        }

        .cliente-autocomplete-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
            max-height: 300px;
            overflow-y: auto;
            z-index: 9999;
            display: none;
            margin-top: 4px;
        }

        .cliente-autocomplete-dropdown.active {
            display: block;
        }

        .autocomplete-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            cursor: pointer;
            border-bottom: 1px solid #f1f5f9;
            transition: all 0.15s;
        }

        .autocomplete-item:last-child {
            border-bottom: none;
        }

        .autocomplete-item:hover {
            background: #f8fafc;
        }

        .autocomplete-item.selected {
            background: #eff6ff;
        }

        .autocomplete-avatar {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 14px;
            flex-shrink: 0;
        }

        .autocomplete-avatar.empresa {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
        }

        .autocomplete-avatar.cliente {
            background: linear-gradient(135deg, #22c55e, #16a34a);
            color: white;
        }

        .autocomplete-info {
            flex: 1;
            min-width: 0;
        }

        .autocomplete-nome {
            font-weight: 600;
            color: #1e293b;
            font-size: 14px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .autocomplete-subtitulo {
            font-size: 12px;
            color: #64748b;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .autocomplete-tipo-badge {
            font-size: 10px;
            padding: 2px 8px;
            border-radius: 4px;
            font-weight: 500;
            flex-shrink: 0;
        }

        .autocomplete-tipo-badge.empresa {
            background: #dbeafe;
            color: #1d4ed8;
        }

        .autocomplete-tipo-badge.cliente {
            background: #dcfce7;
            color: #16a34a;
        }

        .autocomplete-loading {
            padding: 20px;
            text-align: center;
            color: #64748b;
        }

        .autocomplete-empty {
            padding: 20px;
            text-align: center;
            color: #94a3b8;
        }

        .autocomplete-empty i {
            font-size: 24px;
            margin-bottom: 8px;
            display: block;
        }

        .btn-consulta-credito {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 12px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 11px;
            color: #555;
            cursor: pointer;
            white-space: nowrap;
        }

        .btn-consulta-credito:hover {
            background: #f5f5f5;
            border-color: #ccc;
        }

        .previsao-faturamento {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .previsao-label {
            font-size: 11px;
            color: #666;
        }

        .previsao-input {
            padding: 7px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 12px;
            width: 130px;
        }

        .previsao-badge {
            width: 16px;
            height: 16px;
            background: var(--primary-orange);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 9px;
        }

        /* Grid de Valores - Melhorado */
        .valores-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
            margin-bottom: 16px;
        }

        .valor-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .valor-label {
            font-size: 10px;
            color: #777;
            display: flex;
            align-items: center;
            gap: 3px;
            text-transform: capitalize;
        }

        .valor-input {
            padding: 8px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
            font-weight: 500;
            background: #fafafa;
            color: #333;
        }

        .valor-input:focus {
            outline: none;
            border-color: var(--primary-orange);
            background: white;
        }

        .valor-input.highlight {
            background: #fff7ed;
            border-color: var(--primary-orange);
            color: var(--primary-orange);
            font-weight: 600;
        }

        /* Linha de Vendedor, Parcelas, Cenário - Melhorado */
        .info-row {
            display: grid;
            grid-template-columns: 1.5fr 1fr 1fr auto;
            gap: 12px;
            align-items: end;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid #eee;
        }

        .info-field {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .info-field label {
            font-size: 10px;
            color: #777;
            display: flex;
            align-items: center;
            gap: 3px;
        }

        .info-field input,
        .info-field select {
            padding: 8px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 12px;
            background: white;
        }

        .info-field input:focus,
        .info-field select:focus {
            outline: none;
            border-color: var(--primary-orange);
        }

        .btn-atualizar-impostos {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 8px 10px;
            background: none;
            border: none;
            color: #0891b2;
            font-size: 11px;
            cursor: pointer;
            white-space: nowrap;
        }

        .btn-atualizar-impostos:hover {
            color: #0e7490;
            text-decoration: underline;
        }

        /* Tabs do Modal - Estilo Omie */
        .modal-tabs {
            display: flex;
            gap: 0;
            border-bottom: 1px solid #ddd;
            margin-bottom: 16px;
            overflow-x: auto;
            background: #fafafa;
            margin-left: -24px;
            margin-right: -24px;
            padding-left: 24px;
            padding-right: 24px;
        }

        .modal-tab {
            padding: 10px 16px;
            background: none;
            border: none;
            font-size: 12px;
            color: #555;
            cursor: pointer;
            position: relative;
            white-space: nowrap;
            transition: all 0.15s;
        }

        .modal-tab:hover {
            color: #333;
            background: rgba(0,0,0,0.03);
        }

        .modal-tab.active {
            color: var(--primary-orange);
            font-weight: 600;
            background: white;
        }

        .modal-tab.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--primary-orange);
        }

        /* Botões de Ação da Tabela - Estilo Omie */
        .table-actions {
            display: flex;
            gap: 6px;
            margin-bottom: 12px;
        }

        .btn-table-action {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s;
            border: none;
        }

        .btn-table-action.success {
            background: #22c55e;
            color: white;
        }

        .btn-table-action.success:hover {
            background: #16a34a;
        }

        .btn-table-action.warning {
            background: #f59e0b;
            color: white;
        }

        .btn-table-action.warning:hover {
            background: #d97706;
        }

        .btn-table-action.danger {
            background: #ef4444;
            color: white;
        }

        .btn-table-action.danger:hover {
            background: #dc2626;
        }

        /* Tabela de Itens - Estilo Omie */
        .items-table-container {
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 12px;
            background: white;
        }

        .items-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }

        .items-table th {
            background: #fafafa;
            padding: 10px 14px;
            text-align: left;
            font-weight: 600;
            color: #555;
            border-bottom: 1px solid #e0e0e0;
            position: relative;
            font-size: 11px;
        }

        .items-table th .filter-icon {
            color: #bbb;
            font-size: 9px;
            margin-left: 4px;
            cursor: pointer;
        }

        .items-table td {
            padding: 12px 14px;
            border-bottom: 1px solid #f0f0f0;
            color: #333;
            font-size: 12px;
        }

        .items-table tr:last-child td {
            border-bottom: none;
        }

        .items-table tr:hover {
            background: #f9f9f9;
        }

        .items-table tr.selected {
            background: #fff7ed;
        }

        .items-table .produto-code {
            font-weight: 600;
            color: #333;
        }

        .items-table .produto-desc {
            color: #555;
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* Paginação - Estilo Omie */
        .table-pagination {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 0;
            font-size: 11px;
            color: #777;
        }

        .pagination-info {
            color: #555;
        }

        .pagination-controls {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .pagination-btn {
            padding: 5px 8px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 3px;
            font-size: 10px;
            color: #555;
            cursor: pointer;
        }

        .pagination-btn:hover {
            background: #f5f5f5;
        }

        .pagination-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .pagination-current {
            background: var(--primary-orange);
            color: white;
            padding: 4px 8px;
            border-radius: 3px;
            font-weight: 600;
            font-size: 11px;
        }

        /* Alerta de Status - Estilo Omie */
        .status-alert {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 16px;
            border-radius: 4px;
            font-size: 13px;
            font-weight: 500;
            margin-top: 16px;
        }

        .status-alert.warning {
            background: linear-gradient(90deg, #f59e0b 0%, #fbbf24 100%);
            color: white;
            border: none;
            border-radius: 6px;
        }

        .status-alert.success {
            background: linear-gradient(90deg, #22c55e 0%, #4ade80 100%);
            color: white;
            border: none;
            border-radius: 6px;
        }

        .status-alert.info {
            background: linear-gradient(90deg, #3b82f6 0%, #60a5fa 100%);
            color: white;
            border: none;
            border-radius: 6px;
        }

        .status-alert i {
            font-size: 14px;
        }

        /* ========================== */
        /* ESTILOS MODAL NOVO ORÇAMENTO */
        /* ========================== */
        
        /* Cliente Section */
        .orcamento-cliente-section {
            display: flex;
            align-items: flex-start;
            gap: 16px;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid #eee;
        }

        .orcamento-cliente-avatar {
            width: 52px;
            height: 52px;
            background: linear-gradient(135deg, #e2e8f0, #cbd5e1);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #94a3b8;
            font-size: 22px;
            flex-shrink: 0;
        }

        .orcamento-cliente-info {
            flex: 1;
        }

        .orcamento-cliente-row {
            display: flex;
            align-items: flex-end;
            gap: 12px;
            flex-wrap: wrap;
        }

        .orcamento-field-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .orcamento-field-group label {
            font-size: 11px;
            color: #666;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .orcamento-input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 12px;
            min-width: 180px;
            background: white;
        }

        .orcamento-input:focus {
            outline: none;
            border-color: var(--primary-orange);
            box-shadow: 0 0 0 2px rgba(249, 115, 22, 0.1);
        }

        .input-with-btn {
            display: flex;
            align-items: center;
            gap: 0;
        }

        .input-with-btn .orcamento-input {
            border-radius: 4px 0 0 4px;
            border-right: none;
        }

        .input-with-btn .btn-input-action {
            padding: 8px 10px;
            background: #f5f5f5;
            border: 1px solid #ddd;
            border-left: none;
            border-radius: 0 4px 4px 0;
            cursor: pointer;
            color: #666;
            transition: all 0.15s;
        }

        .input-with-btn .btn-input-action:hover {
            background: #e5e5e5;
            color: #333;
        }

        .input-with-btn .btn-input-action:last-child {
            border-radius: 0 4px 4px 0;
        }

        .input-with-btn .btn-input-action:not(:last-child) {
            border-radius: 0;
            border-right: none;
        }

        /* Valores Row */
        .orcamento-valores-row {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }

        .orcamento-valor-box {
            flex: 1;
            min-width: 140px;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .orcamento-valor-box label {
            font-size: 10px;
            color: #777;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .orcamento-valor-input {
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
            font-weight: 600;
            text-align: right;
            background: #fafafa;
            color: #333;
        }

        .orcamento-valor-input:focus {
            outline: none;
            border-color: var(--primary-orange);
            background: white;
        }

        .orcamento-valor-box.destaque .orcamento-valor-input,
        .orcamento-valor-input.destaque {
            background: #fff7ed;
            border-color: var(--primary-orange);
            color: var(--primary-orange);
            font-weight: 700;
        }

        /* Info Row */
        .orcamento-info-row {
            display: flex;
            gap: 16px;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid #eee;
            flex-wrap: wrap;
        }

        .orcamento-info-row .orcamento-field-group {
            flex: 1;
            min-width: 200px;
        }

        /* Tabs */
        .orcamento-tabs {
            display: flex;
            gap: 0;
            border-bottom: 1px solid #ddd;
            margin-bottom: 16px;
            overflow-x: auto;
            background: #fafafa;
            margin-left: -20px;
            margin-right: -20px;
            padding-left: 20px;
            padding-right: 20px;
        }

        .orcamento-tab {
            padding: 10px 16px;
            background: none;
            border: none;
            font-size: 11px;
            color: #555;
            cursor: pointer;
            position: relative;
            white-space: nowrap;
            transition: all 0.15s;
        }

        .orcamento-tab:hover {
            color: #333;
            background: rgba(0,0,0,0.03);
        }

        .orcamento-tab.active {
            color: var(--primary-orange);
            font-weight: 600;
            background: white;
        }

        .orcamento-tab.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--primary-orange);
        }

        /* Tab Content */
        .orcamento-tab-content {
            display: none;
        }

        .orcamento-tab-content.active {
            display: block;
        }

        .orcamento-tab-placeholder {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .orcamento-tab-placeholder i {
            font-size: 32px;
            margin-bottom: 12px;
            display: block;
        }

        /* Itens Actions */
        .orcamento-itens-actions {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }

        .btn-orcamento-action {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 14px;
            border: none;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 500;
            cursor: pointer;
            color: white;
            transition: all 0.15s;
        }

        .btn-orcamento-action.verde {
            background: #22c55e;
        }

        .btn-orcamento-action.verde:hover {
            background: #16a34a;
        }

        .btn-orcamento-action.laranja {
            background: #f59e0b;
        }

        .btn-orcamento-action.laranja:hover {
            background: #d97706;
        }

        .btn-orcamento-action.vermelho {
            background: #ef4444;
        }

        .btn-orcamento-action.vermelho:hover {
            background: #dc2626;
        }

        /* Tabela de Orçamento */
        .orcamento-tabela-container {
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
            background: white;
            margin-bottom: 12px;
        }

        .orcamento-tabela {
            width: 100%;
            border-collapse: collapse;
            font-size: 11px;
        }

        .orcamento-tabela thead th {
            background: #fafafa;
            padding: 10px 12px;
            text-align: left;
            font-weight: 600;
            color: #555;
            border-bottom: 1px solid #e0e0e0;
            font-size: 10px;
            text-transform: uppercase;
        }

        .orcamento-tabela thead th i {
            color: #bbb;
            margin-left: 4px;
            font-size: 8px;
        }

        .orcamento-tabela thead tr.filter-row th {
            background: #f5f5f5;
            padding: 6px 8px;
        }

        .orcamento-tabela .filter-input {
            width: 100%;
            padding: 6px 8px;
            border: 1px solid #ddd;
            border-radius: 3px;
            font-size: 10px;
            background: white;
        }

        .orcamento-tabela tbody td {
            padding: 10px 12px;
            border-bottom: 1px solid #f0f0f0;
            color: #333;
        }

        .orcamento-tabela tbody tr:hover {
            background: #f9f9f9;
        }

        .orcamento-tabela tbody tr.selected {
            background: #fff7ed;
        }

        .orcamento-tabela-empty {
            text-align: center;
            padding: 40px;
            color: #999;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .orcamento-tabela-empty i {
            font-size: 28px;
            color: #ddd;
        }

        /* Paginação */
        .orcamento-paginacao {
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 11px;
            color: #777;
        }

        .paginacao-controls {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .pag-btn {
            padding: 5px 8px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 3px;
            font-size: 10px;
            color: #555;
            cursor: pointer;
        }

        .pag-btn:hover:not(:disabled) {
            background: #f5f5f5;
        }

        .pag-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .pag-current {
            background: var(--primary-orange);
            color: white;
            padding: 4px 8px;
            border-radius: 3px;
            font-weight: 600;
        }

        .pag-text {
            color: #999;
            font-size: 10px;
        }

        /* Textarea */
        .orcamento-textarea {
            width: 100%;
            min-height: 150px;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 12px;
            font-family: inherit;
            resize: vertical;
        }

        .orcamento-textarea:focus {
            outline: none;
            border-color: var(--primary-orange);
        }

        /* Frete Section */
        .orcamento-frete-section {
            padding: 10px 0;
        }

        /* Seção de Formulário Orçamento */
        .orcamento-section-form {
            padding: 10px 0;
        }

        .orcamento-form-row {
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
        }

        .orcamento-textarea {
            width: 100%;
            min-height: 100px;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 12px;
            font-family: inherit;
            resize: vertical;
            line-height: 1.5;
        }

        .orcamento-textarea:focus {
            outline: none;
            border-color: var(--primary-orange);
            box-shadow: 0 0 0 2px rgba(249, 115, 22, 0.1);
        }

        .field-hint {
            display: block;
            font-size: 10px;
            color: #888;
            margin-top: 4px;
        }

        /* Checkbox Label */
        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            font-size: 12px;
            color: #555;
        }

        .checkbox-label input[type="checkbox"] {
            width: 16px;
            height: 16px;
            accent-color: var(--primary-orange);
        }

        /* Status Badge */
        .status-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-badge.pendente {
            background: #fef3c7;
            color: #92400e;
        }

        .status-badge.pago {
            background: #d1fae5;
            color: #065f46;
        }

        .status-badge.vencido {
            background: #fee2e2;
            color: #991b1b;
        }

        /* Estilos originais mantidos para compatibilidade */
        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px 24px;
            border-bottom: 1px solid var(--border-color);
            background: var(--primary-dark);
            border-radius: 16px 16px 0 0;
        }

        .modal-header h2 {
            color: white;
            font-size: 18px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .modal-header h2 i {
            color: var(--primary-orange);
        }

        .modal-close {
            background: none;
            border: none;
            color: #8b8b9a;
            font-size: 24px;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .modal-close:hover {
            color: white;
            background: rgba(255, 255, 255, 0.1);
        }

        .modal-body {
            padding: 24px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px 14px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.2s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary-orange);
            box-shadow: 0 0 0 3px rgba(249, 115, 22, 0.1);
        }

        .form-group textarea {
            min-height: 80px;
            resize: vertical;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .form-row-3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 16px;
        }

        .modal-footer {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 12px;
            padding: 16px 24px;
            border-top: 1px solid var(--border-color);
            background: #f9f9f9;
            border-radius: 0 0 16px 16px;
        }

        .btn-modal {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-modal-cancel {
            background: #e5e5e5;
            color: var(--text-primary);
        }

        .btn-modal-cancel:hover {
            background: #d5d5d5;
        }

        .btn-modal-save {
            background: var(--primary-orange);
            color: white;
        }

        .btn-modal-save:hover {
            background: #ea580c;
        }

        .btn-modal-delete {
            background: var(--danger-red);
            color: white;
            margin-right: auto;
        }

        .btn-modal-delete:hover {
            background: #dc2626;
        }

        .info-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: #f0f9ff;
            color: #0369a1;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            margin-bottom: 20px;
        }

        /* Tab Content */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* ========================================
           ESTILOS DOS MODAIS AUXILIARES
           ======================================== */
        
        /* Área de Upload de Anexos */
        .anexos-upload-area {
            border: 2px dashed #d1d5db;
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            background: #f9fafb;
            transition: all 0.2s;
            cursor: pointer;
        }

        .anexos-upload-area:hover,
        .anexos-upload-area.dragover {
            border-color: #6366f1;
            background: #eef2ff;
        }

        .btn-upload-anexo {
            background: #6366f1;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 13px;
            cursor: pointer;
            margin-top: 15px;
            transition: all 0.2s;
        }

        .btn-upload-anexo:hover {
            background: #4f46e5;
        }

        .anexo-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .anexo-item i {
            font-size: 24px;
            color: #6366f1;
        }

        .anexo-info {
            flex: 1;
        }

        .anexo-nome {
            font-weight: 500;
            color: #333;
        }

        .anexo-tamanho {
            font-size: 12px;
            color: #888;
        }

        .anexo-actions button {
            background: none;
            border: none;
            color: #888;
            cursor: pointer;
            padding: 5px;
            transition: all 0.2s;
        }

        .anexo-actions button:hover {
            color: #333;
        }

        .anexo-actions button.delete:hover {
            color: #ef4444;
        }

        /* Timeline do Histórico */
        .historico-timeline {
            position: relative;
            padding-left: 30px;
        }

        .historico-timeline::before {
            content: '';
            position: absolute;
            left: 10px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: #e5e7eb;
        }

        .historico-item {
            position: relative;
            padding: 15px;
            margin-bottom: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 3px solid #8b5cf6;
        }

        .historico-item::before {
            content: '';
            position: absolute;
            left: -24px;
            top: 20px;
            width: 10px;
            height: 10px;
            background: #8b5cf6;
            border-radius: 50%;
            border: 2px solid white;
        }

        .historico-data {
            font-size: 11px;
            color: #888;
            margin-bottom: 5px;
        }

        .historico-usuario {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }

        .historico-descricao {
            font-size: 13px;
            color: #555;
        }

        /* Lista de Emails */
        .email-item {
            padding: 15px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            margin-bottom: 10px;
            transition: all 0.2s;
        }

        .email-item:hover {
            border-color: #0ea5e9;
            background: #f0f9ff;
        }

        .email-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .email-destinatario {
            font-weight: 600;
            color: #333;
        }

        .email-data {
            font-size: 12px;
            color: #888;
        }

        .email-assunto {
            font-size: 14px;
            color: #555;
            margin-bottom: 5px;
        }

        .email-status {
            font-size: 11px;
            padding: 3px 8px;
            border-radius: 10px;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .email-status.enviado {
            background: #dcfce7;
            color: #166534;
        }

        .email-status.lido {
            background: #dbeafe;
            color: #1e40af;
        }

        .btn-enviar-email {
            background: #0ea5e9;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-enviar-email:hover {
            background: #0284c7;
        }

        /* Lista de Tarefas */
        .nova-tarefa-form {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .input-tarefa {
            flex: 1;
            padding: 12px 15px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
        }

        .input-tarefa:focus {
            outline: none;
            border-color: #10b981;
        }

        .btn-add-tarefa {
            background: #10b981;
            color: white;
            border: none;
            width: 44px;
            height: 44px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-add-tarefa:hover {
            background: #059669;
        }

        .tarefa-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            margin-bottom: 8px;
            transition: all 0.2s;
        }

        .tarefa-item:hover {
            border-color: #10b981;
        }

        .tarefa-item.concluida {
            background: #f0fdf4;
            border-color: #86efac;
        }

        .tarefa-item.concluida .tarefa-texto {
            text-decoration: line-through;
            color: #888;
        }

        .tarefa-checkbox {
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: #10b981;
        }

        .tarefa-texto {
            flex: 1;
            font-size: 14px;
            color: #333;
        }

        .tarefa-delete {
            background: none;
            border: none;
            color: #888;
            cursor: pointer;
            padding: 5px;
        }

        .tarefa-delete:hover {
            color: #ef4444;
        }

        /* Opções de Impressão */
        .opcoes-impressao {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .opcao-impressao {
            cursor: pointer;
        }

        .opcao-impressao input {
            display: none;
        }

        .opcao-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            padding: 20px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            transition: all 0.2s;
        }

        .opcao-content i {
            font-size: 32px;
            color: #64748b;
        }

        .opcao-content span {
            font-size: 13px;
            color: #333;
            font-weight: 500;
        }

        .opcao-impressao input:checked + .opcao-content {
            border-color: #f97316;
            background: #fff7ed;
        }

        .opcao-impressao input:checked + .opcao-content i {
            color: #f97316;
        }

        /* Itens Pedido Parcial */
        .item-parcial {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 12px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .item-parcial-checkbox {
            width: 20px;
            height: 20px;
            accent-color: #f97316;
        }

        .item-parcial-info {
            flex: 1;
        }

        .item-parcial-nome {
            font-weight: 500;
            color: #333;
        }

        .item-parcial-qtd-original {
            font-size: 12px;
            color: #888;
        }

        .item-parcial-qtd-input {
            width: 100px;
            padding: 8px 10px;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            text-align: center;
        }

        /* Botões gerais */
        .btn-primary {
            background: var(--primary-orange);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 13px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
        }

        .btn-primary:hover {
            background: #ea580c;
        }

        .btn-secondary {
            background: #e5e7eb;
            color: #333;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-secondary:hover {
            background: #d1d5db;
        }

        /* Empty State para tabela */
        .empty-table-state {
            text-align: center;
            padding: 40px 20px;
            color: #999;
        }

        .empty-table-state i {
            font-size: 48px;
            margin-bottom: 12px;
            color: #ddd;
        }

        .empty-table-state p {
            font-size: 14px;
        }

        /* ========================================
           RESPONSIVO
           ======================================== */
        @media (max-width: 768px) {
            .sidebar {
                width: 48px;
            }

            .form-row,
            .form-row-3 {
                grid-template-columns: 1fr;
            }
            
            .kanban-column {
                width: 260px;
                min-width: 260px;
            }

            .search-box {
                width: 200px;
            }
        }

        /* ========================================
           MODAL FILTROS KANBAN (Estilo Omie)
           ======================================== */
        .modal-filtros-content {
            background: white;
            border-radius: 8px;
            width: 95%;
            max-width: 900px;
            max-height: 85vh;
            overflow: hidden;
            box-shadow: 0 20px 50px rgba(0,0,0,0.3);
            animation: modalSlideIn 0.2s ease;
        }

        .modal-filtros-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 24px;
            border-bottom: 1px solid #e5e5e5;
        }

        .modal-filtros-header h2 {
            font-size: 18px;
            font-weight: 600;
            color: #333;
        }

        .modal-filtros-header .close-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            background: none;
            border: none;
            color: #666;
            font-size: 14px;
            cursor: pointer;
            padding: 8px 16px;
            border-radius: 6px;
            transition: all 0.2s;
        }

        .modal-filtros-header .close-btn:hover {
            background: #f5f5f5;
            color: #333;
        }

        .modal-filtros-body {
            padding: 24px;
        }

        .filtros-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 24px;
        }

        .filtro-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .filtro-group label {
            font-size: 13px;
            font-weight: 500;
            color: #555;
        }

        .filtro-select {
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            color: #333;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
        }

        .filtro-select:focus {
            outline: none;
            border-color: #f97316;
            box-shadow: 0 0 0 3px rgba(249,115,22,0.1);
        }

        .filtros-row-2 {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 24px;
        }

        .filtro-input-search {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .filtro-input-search input {
            flex: 1;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }

        .filtro-input-search input:focus {
            outline: none;
            border-color: #f97316;
        }

        .filtro-input-search button {
            width: 40px;
            height: 40px;
            border: none;
            background: #f5f5f5;
            border-radius: 6px;
            cursor: pointer;
            color: #666;
            transition: all 0.2s;
        }

        .filtro-input-search button:hover {
            background: #f97316;
            color: white;
        }

        .filtros-toggles {
            display: flex;
            gap: 24px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }

        .toggle-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .toggle-switch {
            position: relative;
            width: 44px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: 0.3s;
            border-radius: 24px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
        }

        .toggle-switch input:checked + .toggle-slider {
            background-color: #f97316;
        }

        .toggle-switch input:checked + .toggle-slider:before {
            transform: translateX(20px);
        }

        .toggle-label {
            font-size: 13px;
            color: #555;
        }

        .filtros-info-box {
            background: #fff9e6;
            border: 1px solid #ffe58f;
            border-radius: 6px;
            padding: 16px;
            margin-bottom: 24px;
        }

        .filtros-info-box p {
            font-size: 13px;
            color: #7a5a00;
            line-height: 1.5;
        }

        .filtros-info-box strong {
            color: #b38600;
        }

        .modal-filtros-footer {
            display: flex;
            justify-content: center;
            gap: 16px;
            padding: 20px 24px;
            border-top: 1px solid #e5e5e5;
            background: #fafafa;
        }

        .btn-desfazer {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 32px;
            background: #f97316;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-desfazer:hover {
            background: #ea580c;
        }

        .btn-atualizar-filtro {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 32px;
            background: #10b981;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-atualizar-filtro:hover {
            background: #059669;
        }

        /* Modal Selecionar Vendedor */
        .modal-vendedor-content {
            background: white;
            border-radius: 8px;
            width: 95%;
            max-width: 700px;
            max-height: 80vh;
            overflow: hidden;
            box-shadow: 0 20px 50px rgba(0,0,0,0.3);
        }

        .vendedor-search-bar {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            border-bottom: 1px solid #e5e5e5;
            gap: 12px;
        }

        .vendedor-search-bar .filter-icon {
            width: 40px;
            height: 40px;
            background: #f97316;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }

        .vendedor-search-bar input {
            flex: 1;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            color: #f97316;
        }

        .vendedor-search-bar input::placeholder {
            color: #f97316;
        }

        .vendedor-search-bar .search-btn {
            width: 40px;
            height: 40px;
            background: #f97316;
            border: none;
            border-radius: 6px;
            color: white;
            cursor: pointer;
        }

        .vendedor-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .vendedor-item {
            padding: 14px 20px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
            color: #333;
        }

        .vendedor-item:hover {
            background: #f5f5f5;
        }

        .vendedor-item.selected {
            background: #fff7ed;
            color: #f97316;
            font-weight: 500;
        }

        .vendedor-item:nth-child(odd) {
            background: #fafafa;
        }

        .vendedor-item:nth-child(odd):hover {
            background: #f0f0f0;
        }

        /* ========================================
           MODAL CONFIRMAÇÃO ALTERAÇÕES
           ======================================== */
        .modal-confirm-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.4);
            z-index: 99999;
            justify-content: center;
            align-items: center;
        }

        .modal-confirm-overlay.active {
            display: flex;
        }

        .modal-confirm-content {
            background: white;
            border-radius: 12px;
            padding: 32px 48px;
            text-align: center;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            animation: modalSlideIn 0.2s ease;
            max-width: 400px;
            width: 90%;
            position: relative;
            z-index: 100000;
        }

        .modal-confirm-content h3 {
            font-size: 16px;
            font-weight: 500;
            color: #333;
            margin-bottom: 16px;
        }

        .modal-confirm-content .link-alteracoes {
            color: #14b8a6;
            font-size: 14px;
            text-decoration: none;
            cursor: pointer;
            display: block;
            margin-bottom: 24px;
        }

        .modal-confirm-content .link-alteracoes:hover {
            text-decoration: underline;
        }

        .modal-confirm-buttons {
            display: flex;
            justify-content: center;
            gap: 12px;
            position: relative;
            z-index: 100001;
        }

        .btn-confirm-sim {
            padding: 10px 32px;
            background: #e5e7eb;
            color: #333;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            pointer-events: auto;
        }

        .btn-confirm-sim:hover {
            background: #d1d5db;
        }

        .btn-confirm-nao {
            padding: 10px 32px;
            background: white;
            color: #14b8a6;
            border: 2px solid #14b8a6;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            pointer-events: auto;
        }

        .btn-confirm-nao:hover {
            background: #f0fdfa;
        }

        /* Lista de alterações */
        .alteracoes-lista {
            display: none;
            background: #f9fafb;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 20px;
            text-align: left;
            max-height: 200px;
            overflow-y: auto;
        }

        .alteracoes-lista.show {
            display: block;
        }

        .alteracoes-lista ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .alteracoes-lista li {
            font-size: 13px;
            color: #555;
            padding: 6px 0;
            border-bottom: 1px solid #e5e7eb;
        }

        .alteracoes-lista li:last-child {
            border-bottom: none;
        }

        .alteracoes-lista li i {
            color: #f97316;
            margin-right: 8px;
        }

        /* ========================================
           MODAL CONFIGURAÇÃO ETAPAS KANBAN
           ======================================== */
        .btn-config-etapas {
            border: 2px solid #f97316 !important;
            border-radius: 4px !important;
            margin-right: 8px;
        }

        .btn-config-etapas:hover {
            background: rgba(249,115,22,0.2) !important;
        }

        .modal-etapas-content {
            background: white;
            border-radius: 12px;
            width: 98%;
            max-width: 1100px;
            max-height: 90vh;
            overflow: hidden;
            box-shadow: 0 25px 60px rgba(0,0,0,0.3);
            animation: modalSlideIn 0.25s ease;
        }

        .modal-etapas-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 18px 28px;
            border-bottom: 2px solid #3b82f6;
            background: linear-gradient(135deg, #eff6ff 0%, #fff 100%);
        }

        .modal-etapas-header h2 {
            font-size: 20px;
            font-weight: 600;
            color: #3b82f6;
            display: flex;
            align-items: center;
        }

        .modal-etapas-header .close-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            background: none;
            border: none;
            color: #666;
            font-size: 14px;
            cursor: pointer;
            padding: 10px 18px;
            border-radius: 8px;
            transition: all 0.2s;
        }

        .modal-etapas-header .close-btn:hover {
            background: #fee2e2;
            color: #dc2626;
        }

        .modal-etapas-body {
            padding: 28px;
            max-height: calc(90vh - 180px);
            overflow-y: auto;
        }

        .modal-etapas-body > p {
            font-size: 14px;
            color: #555;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px dashed #e5e5e5;
        }

        /* Container de etapas dinâmico */
        .etapas-container {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            margin-bottom: 20px;
            padding: 16px;
            background: #fafafa;
            border-radius: 10px;
            border: 1px solid #e5e5e5;
            min-height: 100px;
        }

        .etapa-item {
            display: flex;
            flex-direction: column;
            gap: 6px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 12px;
            min-width: 150px;
            max-width: 180px;
            flex: 1 1 150px;
            position: relative;
            transition: all 0.2s ease;
            cursor: grab;
        }

        .etapa-item:hover {
            border-color: #3b82f6;
            box-shadow: 0 4px 12px rgba(59,130,246,0.15);
            transform: translateY(-2px);
        }

        .etapa-item.dragging {
            opacity: 0.6;
            transform: scale(1.02);
            box-shadow: 0 8px 20px rgba(0,0,0,0.2);
        }

        .etapa-item.drag-over {
            border-color: #22c55e;
            background: #f0fdf4;
        }

        .etapa-item-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 4px;
        }

        .etapa-item-number {
            font-size: 11px;
            font-weight: 600;
            color: #3b82f6;
            background: #eff6ff;
            padding: 2px 8px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .etapa-item-number i {
            font-size: 10px;
            cursor: grab;
        }

        .etapa-item-actions {
            display: flex;
            gap: 4px;
        }

        .etapa-item-actions button {
            width: 22px;
            height: 22px;
            border: none;
            background: #f5f5f5;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            color: #888;
            transition: all 0.15s;
        }

        .etapa-item-actions button:hover {
            background: #fee2e2;
            color: #dc2626;
        }

        .etapa-item-actions button.btn-mover:hover {
            background: #dbeafe;
            color: #2563eb;
        }

        .etapa-item input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #e5e5e5;
            border-radius: 6px;
            font-size: 13px;
            color: #333;
            background: #fafafa;
            transition: all 0.2s;
        }

        .etapa-item input:focus {
            outline: none;
            border-color: #3b82f6;
            background: white;
            box-shadow: 0 0 0 3px rgba(59,130,246,0.1);
        }

        .etapa-item.etapa-destaque {
            background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
            border-color: #60a5fa;
        }

        .etapa-item.etapa-destaque input {
            background: white;
            border-color: #60a5fa;
        }

        /* Ações de etapas */
        .etapas-actions {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .btn-adicionar-etapa {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 24px;
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 2px 8px rgba(34,197,94,0.3);
        }

        .btn-adicionar-etapa:hover {
            background: linear-gradient(135deg, #16a34a 0%, #15803d 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(34,197,94,0.4);
        }

        .btn-adicionar-etapa i {
            font-size: 16px;
        }

        .etapas-counter {
            font-size: 13px;
            color: #888;
            font-style: italic;
        }

        .etapas-info-box {
            background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
            border: 1px solid #86efac;
            border-radius: 10px;
            padding: 16px 20px;
            margin-bottom: 0;
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }

        .etapas-info-box i {
            color: #22c55e;
            font-size: 18px;
            margin-top: 1px;
        }

        .etapas-info-box p {
            font-size: 13px;
            color: #166534;
            line-height: 1.6;
            margin: 0;
        }

        .modal-etapas-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 18px 28px;
            border-top: 1px solid #e5e5e5;
            background: #f8fafc;
        }

        .alterar-numeracao {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 13px;
            color: #555;
        }

        .alterar-numeracao .checkbox-container {
            position: relative;
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .alterar-numeracao .checkbox-container input {
            position: absolute;
            opacity: 0;
            cursor: pointer;
            height: 0;
            width: 0;
        }

        .alterar-numeracao .checkmark {
            position: absolute;
            top: 0;
            left: 0;
            height: 20px;
            width: 20px;
            background-color: #fff;
            border: 2px solid #ddd;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .alterar-numeracao .checkbox-container:hover input ~ .checkmark {
            border-color: #3b82f6;
        }

        .alterar-numeracao .checkbox-container input:checked ~ .checkmark {
            background-color: #3b82f6;
            border-color: #3b82f6;
        }

        .alterar-numeracao .checkmark:after {
            content: "";
            position: absolute;
            display: none;
        }

        .alterar-numeracao .checkbox-container input:checked ~ .checkmark:after {
            display: block;
        }

        .alterar-numeracao .checkbox-container .checkmark:after {
            left: 6px;
            top: 2px;
            width: 5px;
            height: 10px;
            border: solid white;
            border-width: 0 2px 2px 0;
            transform: rotate(45deg);
        }

        .alterar-numeracao i {
            color: #3b82f6;
        }

        .alterar-numeracao strong {
            color: #3b82f6;
        }

        .modal-etapas-buttons {
            display: flex;
            gap: 12px;
        }

        .btn-cancelar-etapas {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 24px;
            background: #f5f5f5;
            color: #666;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-cancelar-etapas:hover {
            background: #fee2e2;
            border-color: #fca5a5;
            color: #dc2626;
        }

        .btn-confirmar-etapas {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 32px;
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 2px 8px rgba(34,197,94,0.3);
        }

        .btn-confirmar-etapas:hover {
            background: linear-gradient(135deg, #ea580c 0%, #c2410c 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(249,115,22,0.4);
        }

        @media (max-width: 768px) {
            .etapas-container {
                flex-direction: column;
            }
            
            .etapa-item {
                max-width: 100%;
            }
            
            .modal-etapas-footer {
                flex-direction: column;
                gap: 16px;
            }
            
            .alterar-numeracao {
                text-align: center;
            }
        }
    </style>
    
    `n</head>
<body>
    <div class="app-container">
        <!-- Sidebar Lateral -->
        <aside class="sidebar">
            <a href="/dashboard" class="sidebar-logo" title="Voltar ao Painel">
                <i class="fas fa-home"></i>
            </a>
            
            <nav class="sidebar-nav">
                <button class="sidebar-btn active" title="Kanban" onclick="window.location.href='index.html'">
                    <i class="fas fa-columns"></i>
                </button>
                <button class="sidebar-btn" title="Pedidos" onclick="window.location.href='pedidos.html'">
                    <i class="fas fa-clipboard-list"></i>
                </button>
                <button class="sidebar-btn" title="Clientes" onclick="window.location.href='clientes.html'">
                    <i class="fas fa-users"></i>
                </button>
                <button class="sidebar-btn" title="Estoque" onclick="window.location.href='estoque.html'">
                    <i class="fas fa-boxes-stacked"></i>
                </button>
                <button class="sidebar-btn" title="Meu Dashboard" onclick="window.location.href='dashboard.html'">
                    <i class="fas fa-chart-pie"></i>
                </button>
                <button class="sidebar-btn" title="Gestão de Vendas" onclick="window.location.href='dashboard-admin.html'">
                    <i class="fas fa-chart-line"></i>
                </button>
                <button class="sidebar-btn" title="Relatórios" onclick="window.location.href='relatorios.html'">
                    <i class="fas fa-chart-bar"></i>
                </button>
            </nav>

            <div class="sidebar-bottom">
                <button class="sidebar-btn" title="Configurações">
                    <i class="fas fa-cog"></i>
                </button>
            </div>
        </aside>

        <!-- Main Area -->
        <main class="main-area">
            <!-- Header -->
            <header class="header">
    <link rel="icon" type="image/x-icon" href="/favicon-aluforce.webp">
                <div class="header-left">
                    <div class="header-brand">
                        <span>Vendas</span>
                        <span>|</span>
                        <span style="color: white;">Kanban</span>
                    </div>
                </div>
                <div class="header-right">
                    <button class="header-btn btn-config-etapas" title="Configurar Etapas do Kanban" onclick="abrirModalEtapas()">
                        <i class="fas fa-cog"></i>
                    </button>
                    <button class="header-btn" title="Notificações">
                        <i class="fas fa-bell"></i>
                    </button>
                    <div class="user-greeting">
                        <span><span id="greeting-text">Bom dia</span>, <strong id="user-name">Usuário</strong></span>
                        <div class="user-avatar" id="user-avatar">
                            <img src="" alt="Foto do usuário" id="user-photo">
                            <span id="user-initial">U</span>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Tabs Bar - Estilo Omie -->
            <div class="tabs-bar">
                <button class="tab" onclick="window.location.href='/nfe'">
                    Vendas e NF-e
                </button>
                <button class="tab active">
                    Vendas
                    <span class="close-tab" title="Fechar">×</span>
                </button>
                <div class="tabs-actions">
                    <button class="tab-action-btn" title="Atualizar Kanban" onclick="carregarPedidosKanban()">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                    <button class="tab-action-btn" title="Mais opções">
                        <i class="fas fa-ellipsis-h"></i>
                    </button>
                    <button class="tab-action-btn" title="Configurações">
                        <i class="fas fa-cog"></i>
                    </button>
                    <button class="tab-action-btn" title="Layout">
                        <i class="fas fa-th-large"></i>
                    </button>
                </div>
            </div>

            <!-- Filtros -->
            <div class="filters-bar">
                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" placeholder="Digite o que deseja pesquisar" id="search-input">
                </div>
                <a class="filter-link" id="filter-toggle">Exibindo tudo</a>
            </div>

            <!-- Kanban Board -->
            <div class="kanban-container">
                <div class="kanban-board" id="kanban-board">
                    
                    <!-- Coluna: Orçamento -->
                    <div class="kanban-column" data-status="orcamento">
                        <div class="kanban-column-header">
                            <div>
                                <div class="column-title">Orçamento</div>
                                <div class="column-count">Mais de 50 registros</div>
                            </div>
                            <div class="column-indicator orcamento"></div>
                        </div>
                        <div class="kanban-column-content" id="col-orcamento">
                            <!-- Cards serão inseridos aqui -->
                        </div>
                        <div class="kanban-column-footer">
                            <button class="btn-new-card" onclick="novoOrcamento()">
                                <i class="fas fa-plus"></i> Novo Orçamento
                            </button>
                        </div>
                    </div>

                    <!-- Coluna: Pedido Aprovado -->
                    <div class="kanban-column" data-status="aprovado">
                        <div class="kanban-column-header">
                            <div>
                                <div class="column-title">Pedido Aprovado</div>
                                <div class="column-count" id="count-aprovado">5 registros</div>
                            </div>
                            <div class="column-indicator aprovado"></div>
                        </div>
                        <div class="kanban-column-content" id="col-aprovado">
                            <!-- Cards -->
                        </div>
                    </div>

                    <!-- Coluna: Análise de Crédito -->
                    <div class="kanban-column" data-status="analise">
                        <div class="kanban-column-header">
                            <div>
                                <div class="column-title">Análise de Crédito</div>
                                <div class="column-count" id="count-analise">12 registros</div>
                            </div>
                            <div class="column-indicator analise"></div>
                        </div>
                        <div class="kanban-column-content" id="col-analise">
                            <!-- Cards -->
                        </div>
                    </div>

                    <!-- Coluna: Faturar -->
                    <div class="kanban-column" data-status="faturar">
                        <div class="kanban-column-header">
                            <div>
                                <div class="column-title">Faturar</div>
                                <div class="column-count" id="count-faturar">23 registros</div>
                            </div>
                            <div class="column-indicator faturar"></div>
                        </div>
                        <div class="kanban-column-content" id="col-faturar">
                            <!-- Cards -->
                        </div>
                        <div class="kanban-column-footer">
                            <button class="btn-action-card" onclick="faturarTodos()">
                                <i class="fas fa-bolt"></i> Faturar Todos
                            </button>
                        </div>
                    </div>

                    <!-- Coluna: Faturado -->
                    <div class="kanban-column" data-status="faturado">
                        <div class="kanban-column-header">
                            <div>
                                <div class="column-title">Faturado</div>
                                <div class="column-count" id="count-faturado">52 registros</div>
                            </div>
                            <div class="column-indicator faturado"></div>
                        </div>
                        <div class="kanban-column-content" id="col-faturado">
                            <!-- Cards -->
                        </div>
                        <div class="kanban-column-footer">
                            <button class="btn-action-card teal" onclick="comunicarSefaz()">
                                <i class="fas fa-sync"></i> Comunicar com a SEFAZ
                            </button>
                        </div>
                    </div>

                    <!-- Coluna: Entregue -->
                    <div class="kanban-column" data-status="entregue">
                        <div class="kanban-column-header">
                            <div>
                                <div class="column-title">Entregue</div>
                                <div class="column-count" id="count-entregue">Nenhum registro</div>
                            </div>
                            <div class="column-indicator entregue"></div>
                        </div>
                        <div class="kanban-column-content" id="col-entregue">
                            <div class="empty-column">
                                <i class="fas fa-truck"></i>
                                <p>Nenhuma entrega pendente</p>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </main>
    </div>

    <!-- Modal Editar Pedido -->
    <!-- Modal Editar Pedido - Estilo Omie Profissional -->
    <div class="modal-overlay" id="modal-editar-pedido">
        <div class="modal-content-omie">
            <!-- Header -->
            <div class="modal-header-omie">
                <h2 id="modal-titulo-pedido">Orçamento Nº 233</h2>
                <button class="close-btn" onclick="fecharModalEditar()">
                    Fechar <i class="fas fa-times"></i>
                </button>
            </div>

            <!-- Container Principal -->
            <div class="modal-container-omie">
                <!-- Área de Conteúdo Principal -->
                <div class="modal-main-content">
                    <!-- Seção do Cliente -->
                    <div class="cliente-section">
                        <div class="cliente-avatar" id="modal-cliente-avatar">IE</div>
                        <div class="cliente-info">
                            <div class="cliente-info-header">
                                <label style="font-size: 11px; color: #888; margin-bottom: 0;">Cliente <i class="fas fa-external-link-alt" style="font-size: 9px;"></i></label>
                            </div>
                            <div style="display: flex; gap: 12px; align-items: center; margin-bottom: 12px;">
                                <div class="cliente-autocomplete-wrapper">
                                    <input type="text" class="cliente-nome-input" id="edit-cliente" placeholder="Digite para buscar cliente ou empresa..." autocomplete="off">
                                    <input type="hidden" id="edit-cliente-id">
                                    <input type="hidden" id="edit-empresa-id">
                                    <input type="hidden" id="edit-cliente-tipo">
                                    <div class="cliente-autocomplete-dropdown" id="cliente-autocomplete-dropdown"></div>
                                </div>
                                <button type="button" class="btn-consulta-credito">
                                    <i class="fas fa-search"></i> Consulta de Crédito
                                </button>
                                <div class="previsao-faturamento">
                                    <span class="previsao-label">Previsão de Faturamento</span>
                                    <div class="previsao-badge"><i class="fas fa-exclamation" style="font-size: 8px;"></i></div>
                                    <input type="date" class="previsao-input" id="edit-previsao-faturamento">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Grid de Valores -->
                    <div class="valores-grid">
                        <div class="valor-item">
                            <label class="valor-label">Total de Mercadorias</label>
                            <input type="text" class="valor-input" id="edit-total-mercadorias" value="0,00" readonly>
                        </div>
                        <div class="valor-item">
                            <label class="valor-label">Valor do Desconto <i class="fas fa-pen" style="font-size: 9px;"></i></label>
                            <input type="text" class="valor-input" id="edit-desconto" value="0,00">
                        </div>
                        <div class="valor-item">
                            <label class="valor-label">Total de IPI</label>
                            <input type="text" class="valor-input" id="edit-ipi" value="0,00" readonly>
                        </div>
                        <div class="valor-item">
                            <label class="valor-label">Total de ICMS ST</label>
                            <input type="text" class="valor-input" id="edit-icms-st" value="0,00" readonly>
                        </div>
                        <div class="valor-item">
                            <label class="valor-label">Valor Total do Pedido</label>
                            <input type="text" class="valor-input highlight" id="edit-valor-total" value="0,00" readonly>
                        </div>
                    </div>

                    <!-- Linha de Vendedor, Parcelas, Cenário -->
                    <div class="info-row">
                        <div class="info-field">
                            <label>Vendedor +</label>
                            <input type="text" id="edit-vendedor" placeholder="Buscar vendedor...">
                        </div>
                        <div class="info-field">
                            <label>Número de Parcelas <i class="fas fa-pen" style="font-size: 9px;"></i> +</label>
                            <input type="text" id="edit-parcelas" value="28/35/42/49">
                        </div>
                        <div class="info-field">
                            <label>Cenário Fiscal</label>
                            <select id="edit-cenario-fiscal">
                                <option value="Padrão">Padrão</option>
                                <option value="Simples Nacional">Simples Nacional</option>
                                <option value="Lucro Presumido">Lucro Presumido</option>
                                <option value="Lucro Real">Lucro Real</option>
                            </select>
                        </div>
                        <button type="button" class="btn-atualizar-impostos">
                            <i class="fas fa-sync-alt"></i> Atualizar os impostos dos itens
                        </button>
                    </div>

                    <!-- Tabs -->
                    <div class="modal-tabs">
                        <button class="modal-tab active" data-tab="itens" onclick="switchModalTab('itens')">Itens da Venda</button>
                        <button class="modal-tab" data-tab="departamentos" onclick="switchModalTab('departamentos')">Departamentos</button>
                        <button class="modal-tab" data-tab="frete" onclick="switchModalTab('frete')">Frete e Outras Despesas</button>
                        <button class="modal-tab" data-tab="informacoes" onclick="switchModalTab('informacoes')">Informações Adicionais</button>
                        <button class="modal-tab" data-tab="parcelas" onclick="switchModalTab('parcelas')">Parcelas</button>
                        <button class="modal-tab" data-tab="observacoes" onclick="switchModalTab('observacoes')">Observações</button>
                        <button class="modal-tab" data-tab="email" onclick="switchModalTab('email')">E-mail para o Cliente</button>
                    </div>

                    <!-- Tab Content: Itens da Venda -->
                    <div class="tab-content active" id="tab-itens">
                        <!-- Botões de Ação -->
                        <div class="table-actions">
                            <button type="button" class="btn-table-action success" onclick="adicionarItem()">
                                <i class="fas fa-plus"></i> Novo Item
                            </button>
                            <button type="button" class="btn-table-action warning" onclick="editarItemSelecionado()">
                                <i class="fas fa-pen"></i> Editar Item
                            </button>
                            <button type="button" class="btn-table-action danger" onclick="excluirItemSelecionado()">
                                <i class="fas fa-trash"></i> Excluir Item
                            </button>
                        </div>

                        <!-- Tabela de Itens -->
                        <div class="items-table-container">
                            <table class="items-table">
                                <thead>
                                    <tr>
                                        <th>Produto <i class="fas fa-sort filter-icon"></i></th>
                                        <th>Descrição do Produto</th>
                                        <th>Quantidade</th>
                                        <th>Quantidade (Parcial)</th>
                                        <th>Local de Estoque</th>
                                        <th>Preço Unitário</th>
                                    </tr>
                                </thead>
                                <tbody id="itens-pedido-tbody">
                                    <tr>
                                        <td class="produto-code">ITEM001</td>
                                        <td class="produto-desc">AL CONESUL VALVULAS INDUST...</td>
                                        <td>1.000 M</td>
                                        <td>0 M</td>
                                        <td>PADRAO - Local de Estoque Padrão</td>
                                        <td>R$ 11.540,00</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- Paginação -->
                        <div class="table-pagination">
                            <span class="pagination-info" id="pagination-info">1 - 1 de 1 registros</span>
                            <div class="pagination-controls">
                                <button class="pagination-btn" disabled><i class="fas fa-angle-double-left"></i></button>
                                <button class="pagination-btn" disabled><i class="fas fa-angle-left"></i> anterior</button>
                                <span class="pagination-current">1</span>
                                <button class="pagination-btn" disabled>próximo <i class="fas fa-angle-right"></i></button>
                                <button class="pagination-btn" disabled><i class="fas fa-angle-double-right"></i></button>
                            </div>
                        </div>
                    </div>

                    <!-- Tab Content: Departamentos -->
                    <div class="tab-content" id="tab-departamentos">
                        <div class="empty-table-state">
                            <i class="fas fa-building"></i>
                            <p>Nenhum departamento configurado</p>
                        </div>
                    </div>

                    <!-- Tab Content: Frete -->
                    <div class="tab-content" id="tab-frete">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Transportadora</label>
                                <input type="text" id="edit-transportadora" placeholder="Nome da transportadora">
                            </div>
                            <div class="form-group">
                                <label>Tipo de Frete</label>
                                <select id="edit-tipo-frete">
                                    <option value="CIF">CIF - Por conta do remetente</option>
                                    <option value="FOB">FOB - Por conta do destinatário</option>
                                    <option value="Terceiros">Por conta de terceiros</option>
                                    <option value="Proprio-Remetente">Próprio por conta do remetente</option>
                                    <option value="Proprio-Destinatario">Próprio por conta do destinatário</option>
                                    <option value="Sem-Frete">Sem frete</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Valor do Frete (R$)</label>
                                <input type="number" id="edit-valor-frete" step="0.01" placeholder="0,00">
                            </div>
                            <div class="form-group">
                                <label>Outras Despesas (R$)</label>
                                <input type="number" id="edit-outras-despesas" step="0.01" placeholder="0,00">
                            </div>
                        </div>
                    </div>

                    <!-- Tab Content: Informações Adicionais -->
                    <div class="tab-content" id="tab-informacoes">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Nota Fiscal</label>
                                <input type="text" id="edit-nf" placeholder="Número da NF">
                            </div>
                            <div class="form-group">
                                <label>Origem</label>
                                <select id="edit-origem">
                                    <option value="Omie">Omie</option>
                                    <option value="Sistema">Sistema</option>
                                    <option value="Manual">Manual</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Informações Complementares</label>
                            <textarea id="edit-info-complementar" placeholder="Informações adicionais para a nota fiscal..." style="min-height: 100px;"></textarea>
                        </div>
                    </div>

                    <!-- Tab Content: Parcelas -->
                    <div class="tab-content" id="tab-parcelas">
                        <div class="form-group">
                            <label>Condição de Pagamento</label>
                            <select id="edit-condicao-pagamento">
                                <option value="a vista">À Vista</option>
                                <option value="28/35/42/49">28/35/42/49 dias</option>
                                <option value="30/60">30/60 dias</option>
                                <option value="30/60/90">30/60/90 dias</option>
                                <option value="30/60/90/120">30/60/90/120 dias</option>
                            </select>
                        </div>
                        <div class="items-table-container">
                            <table class="items-table">
                                <thead>
                                    <tr>
                                        <th>Parcela</th>
                                        <th>Vencimento</th>
                                        <th>Valor</th>
                                        <th>Forma de Pagamento</th>
                                    </tr>
                                </thead>
                                <tbody id="parcelas-tbody">
                                    <tr>
                                        <td>1/4</td>
                                        <td>14/01/2026</td>
                                        <td>R$ 20.195,00</td>
                                        <td>Boleto</td>
                                    </tr>
                                    <tr>
                                        <td>2/4</td>
                                        <td>21/01/2026</td>
                                        <td>R$ 20.195,00</td>
                                        <td>Boleto</td>
                                    </tr>
                                    <tr>
                                        <td>3/4</td>
                                        <td>28/01/2026</td>
                                        <td>R$ 20.195,00</td>
                                        <td>Boleto</td>
                                    </tr>
                                    <tr>
                                        <td>4/4</td>
                                        <td>04/02/2026</td>
                                        <td>R$ 20.195,00</td>
                                        <td>Boleto</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Tab Content: Observações -->
                    <div class="tab-content" id="tab-observacoes">
                        <div class="form-group">
                            <label>Observações Internas</label>
                            <textarea id="edit-observacoes" placeholder="Observações internas (não aparecem na NF)..." style="min-height: 120px;"></textarea>
                        </div>
                        <div class="form-group">
                            <label>Observações para o Cliente</label>
                            <textarea id="edit-observacoes-cliente" placeholder="Observações que aparecerão para o cliente..." style="min-height: 120px;"></textarea>
                        </div>
                    </div>

                    <!-- Tab Content: E-mail -->
                    <div class="tab-content" id="tab-email">
                        <div class="form-group">
                            <label>E-mail do Cliente</label>
                            <input type="email" id="edit-email-cliente" placeholder="email@cliente.com.br">
                        </div>
                        <div class="form-group">
                            <label>Assunto</label>
                            <input type="text" id="edit-email-assunto" placeholder="Orçamento Nº 233 - ALUFORCE">
                        </div>
                        <div class="form-group">
                            <label>Mensagem</label>
                            <textarea id="edit-email-mensagem" placeholder="Mensagem personalizada para o cliente..." style="min-height: 120px;"></textarea>
                        </div>
                        <button type="button" class="btn-table-action success" style="margin-top: 12px;">
                            <i class="fas fa-paper-plane"></i> Enviar E-mail
                        </button>
                    </div>

                    <!-- Alerta de Status -->
                    <div class="status-alert warning" id="status-alert">
                        <i class="fas fa-exclamation-circle"></i>
                        <span id="status-alert-text">Faturamento atrasado</span>
                    </div>

                    <!-- Campo oculto para ID -->
                    <input type="hidden" id="edit-pedido-id">
                </div>

                <!-- Sidebar de Ações -->
                <div class="modal-sidebar-actions">
                    <button class="sidebar-action-btn primary" onclick="salvarPedido()">
                        <i class="fas fa-save"></i> Salvar
                    </button>
                    <button class="sidebar-action-btn" onclick="incluirPedido()">
                        <i class="fas fa-plus-circle"></i> Incluir
                    </button>
                    <button class="sidebar-action-btn" onclick="imprimirPedido()">
                        <i class="fas fa-print"></i> Imprimir
                    </button>
                    <button class="sidebar-action-btn" onclick="duplicarPedido()">
                        <i class="fas fa-copy"></i> Duplicar
                    </button>
                    <button class="sidebar-action-btn" onclick="conferirPedido()">
                        <i class="fas fa-check-circle"></i> Conferir
                    </button>
                    <button class="sidebar-action-btn btn-faturar" onclick="faturarPedido()">
                        <i class="fas fa-file-invoice-dollar"></i> Faturar Agora
                    </button>
                    
                    <div class="sidebar-divider"></div>
                    
                    <button class="sidebar-action-btn" onclick="verAnexos()">
                        <i class="fas fa-paperclip"></i> Anexos
                    </button>
                    <button class="sidebar-action-btn" onclick="verEmailsEnviados()">
                        <i class="fas fa-envelope"></i> Emails Enviados
                    </button>
                    <button class="sidebar-action-btn" onclick="verHistorico()">
                        <i class="fas fa-history"></i> Histórico de Alterações
                    </button>
                    <button class="sidebar-action-btn" onclick="verTarefas()">
                        <i class="fas fa-tasks"></i> Tarefas
                    </button>
                    
                    <button class="sidebar-action-btn outline-primary" onclick="pedidoParcial()">
                        <i class="fas fa-random"></i> Pedido Parcial
                    </button>
                    
                    <div class="sidebar-divider"></div>
                    
                    <button class="sidebar-action-btn danger" onclick="excluirPedido()">
                        <i class="fas fa-trash"></i> Excluir
                    </button>
                    <button class="sidebar-action-btn danger" onclick="cancelarPedido()">
                        <i class="fas fa-ban"></i> Cancelar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Anexos -->
    <div class="modal-overlay" id="modal-anexos">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #6366f1, #4f46e5);">
                <h2><i class="fas fa-paperclip"></i> Anexos do Pedido</h2>
                <button class="modal-close" onclick="fecharModalAnexos()"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <div class="anexos-upload-area" id="anexos-upload-area">
                    <i class="fas fa-cloud-upload-alt" style="font-size: 48px; color: #6366f1; margin-bottom: 10px;"></i>
                    <p style="color: #666;">Arraste arquivos aqui ou clique para selecionar</p>
                    <input type="file" id="input-anexo" multiple style="display: none;" onchange="processarAnexos(this.files)">
                    <button type="button" class="btn-upload-anexo" onclick="document.getElementById('input-anexo').click()">
                        <i class="fas fa-folder-open"></i> Selecionar Arquivos
                    </button>
                </div>
                <div class="anexos-lista" id="anexos-lista">
                    <h4 style="margin: 15px 0 10px; color: #333;">Arquivos Anexados</h4>
                    <div id="lista-anexos-container">
                        <p style="color: #888; font-size: 13px;">Nenhum anexo encontrado para este pedido.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Histórico de Alterações - Profissional -->
    <div class="modal-overlay" id="modal-historico">
        <div class="modal-historico-content">
            <div class="modal-historico-header">
                <h2><i class="fas fa-history"></i> Histórico de Alterações</h2>
                <button class="close-btn" onclick="fecharModalHistorico()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-historico-body">
                <div class="historico-timeline-pro" id="historico-timeline">
                    <!-- Será preenchido dinamicamente -->
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Emails Enviados -->
    <div class="modal-overlay" id="modal-emails">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #0ea5e9, #0284c7);">
                <h2><i class="fas fa-envelope"></i> Emails Enviados</h2>
                <button class="modal-close" onclick="fecharModalEmails()"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <div class="emails-lista" id="emails-lista">
                    <!-- Será preenchido dinamicamente -->
                </div>
                <div style="margin-top: 15px; text-align: right;">
                    <button type="button" class="btn-enviar-email" onclick="abrirEnviarEmail()">
                        <i class="fas fa-paper-plane"></i> Enviar Novo Email
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Tarefas -->
    <div class="modal-overlay" id="modal-tarefas">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #10b981, #059669);">
                <h2><i class="fas fa-tasks"></i> Tarefas do Pedido</h2>
                <button class="modal-close" onclick="fecharModalTarefas()"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <div class="nova-tarefa-form">
                    <input type="text" id="input-nova-tarefa" placeholder="Adicionar nova tarefa..." class="input-tarefa">
                    <button type="button" class="btn-add-tarefa" onclick="adicionarTarefa()">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
                <div class="tarefas-lista" id="tarefas-lista">
                    <!-- Será preenchido dinamicamente -->
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Pedido Parcial -->
    <div class="modal-overlay" id="modal-pedido-parcial">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #f97316, #ea580c);">
                <h2><i class="fas fa-random"></i> Pedido Parcial</h2>
                <button class="modal-close" onclick="fecharModalPedidoParcial()"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <p style="color: #666; margin-bottom: 15px;">Selecione os itens que deseja faturar parcialmente:</p>
                <div class="itens-parcial-lista" id="itens-parcial-lista">
                    <!-- Será preenchido com itens do pedido -->
                </div>
                <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: flex-end;">
                    <button type="button" class="btn-secondary" onclick="fecharModalPedidoParcial()">Cancelar</button>
                    <button type="button" class="btn-primary" onclick="gerarPedidoParcial()">
                        <i class="fas fa-check"></i> Gerar Pedido Parcial
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Imprimir -->
    <div class="modal-overlay" id="modal-imprimir">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #64748b, #475569);">
                <h2><i class="fas fa-print"></i> Opções de Impressão</h2>
                <button class="modal-close" onclick="fecharModalImprimir()"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <div class="opcoes-impressao">
                    <label class="opcao-impressao">
                        <input type="radio" name="tipo-impressao" value="orcamento" checked>
                        <span class="opcao-content">
                            <i class="fas fa-file-alt"></i>
                            <span>Orçamento Completo</span>
                        </span>
                    </label>
                    <label class="opcao-impressao">
                        <input type="radio" name="tipo-impressao" value="resumo">
                        <span class="opcao-content">
                            <i class="fas fa-file"></i>
                            <span>Resumo do Pedido</span>
                        </span>
                    </label>
                    <label class="opcao-impressao">
                        <input type="radio" name="tipo-impressao" value="romaneio">
                        <span class="opcao-content">
                            <i class="fas fa-list-alt"></i>
                            <span>Romaneio de Entrega</span>
                        </span>
                    </label>
                    <label class="opcao-impressao">
                        <input type="radio" name="tipo-impressao" value="etiqueta">
                        <span class="opcao-content">
                            <i class="fas fa-tag"></i>
                            <span>Etiquetas</span>
                        </span>
                    </label>
                </div>
                <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: flex-end;">
                    <button type="button" class="btn-secondary" onclick="fecharModalImprimir()">Cancelar</button>
                    <button type="button" class="btn-primary" onclick="executarImpressao()">
                        <i class="fas fa-print"></i> Imprimir
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Critérios de Seleção (Filtros do Kanban) -->
    <div class="modal-overlay" id="modal-filtros-kanban">
        <div class="modal-filtros-content">
            <div class="modal-filtros-header">
                <h2>Critérios de Seleção</h2>
                <button class="close-btn" onclick="fecharModalFiltros()">
                    Fechar <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-filtros-body">
                <div class="filtros-grid">
                    <div class="filtro-group">
                        <label>Considerar Data de Inclusão</label>
                        <select class="filtro-select" id="filtro-data-inclusao">
                            <option value="tudo">Tudo</option>
                            <option value="hoje">Hoje</option>
                            <option value="ontem">Ontem</option>
                            <option value="ultimos-3">Últimos 3 dias</option>
                            <option value="ultimos-7">Últimos 7 dias</option>
                            <option value="ultimos-15">Últimos 15 dias</option>
                            <option value="ultimos-30">Últimos 30 dias</option>
                            <option value="ultimos-90">Últimos 90 dias</option>
                        </select>
                    </div>
                    <div class="filtro-group">
                        <label>Considerar Data de Previsão</label>
                        <select class="filtro-select" id="filtro-data-previsao">
                            <option value="tudo">Tudo</option>
                            <option value="hoje">Hoje</option>
                            <option value="amanha">Amanhã</option>
                            <option value="proximos-3">Próximos 3 dias</option>
                            <option value="proximos-7">Próximos 7 dias</option>
                            <option value="proximos-15">Próximos 15 dias</option>
                            <option value="proximos-30">Próximos 30 dias</option>
                            <option value="proximos-90">Próximos 90 dias</option>
                            <option value="ontem">Ontem</option>
                            <option value="ultimos-3">Últimos 3 dias</option>
                            <option value="ultimos-7">Últimos 7 dias</option>
                            <option value="ultimos-15">Últimos 15 dias</option>
                            <option value="ultimos-30">Últimos 30 dias</option>
                            <option value="ultimos-60">Últimos 60 dias</option>
                            <option value="ultimos-90">Últimos 90 dias</option>
                        </select>
                    </div>
                    <div class="filtro-group">
                        <label>Considerar Data de Faturamento</label>
                        <select class="filtro-select" id="filtro-data-faturamento">
                            <option value="ultimos-30" selected>Últimos 30 dias</option>
                            <option value="ultimos-60">Últimos 60 dias</option>
                            <option value="ultimos-90">Últimos 90 dias</option>
                            <option value="ultimos-120">Últimos 120 dias</option>
                            <option value="ultimo-ano">Último 1 ano</option>
                        </select>
                    </div>
                </div>

                <div class="filtros-row-2">
                    <div class="filtro-group">
                        <label>Exibir Vendedor</label>
                        <div class="filtro-input-search">
                            <input type="text" id="filtro-vendedor" placeholder="Todos os Vendedores" readonly>
                            <button type="button" onclick="abrirModalVendedor()"><i class="fas fa-search"></i></button>
                        </div>
                    </div>
                    <div class="filtro-group">
                        <label>Exibir Projeto</label>
                        <div class="filtro-input-search">
                            <input type="text" id="filtro-projeto" placeholder="Todos os Projetos" readonly>
                            <button type="button" onclick="abrirModalProjeto()"><i class="fas fa-search"></i></button>
                        </div>
                    </div>
                </div>

                <div class="filtros-toggles">
                    <div class="toggle-item">
                        <label class="toggle-switch">
                            <input type="checkbox" id="toggle-cancelados">
                            <span class="toggle-slider"></span>
                        </label>
                        <span class="toggle-label">Exibir Cancelados</span>
                    </div>
                    <div class="toggle-item">
                        <label class="toggle-switch">
                            <input type="checkbox" id="toggle-denegados">
                            <span class="toggle-slider"></span>
                        </label>
                        <span class="toggle-label">Exibir Denegados</span>
                    </div>
                    <div class="toggle-item">
                        <label class="toggle-switch">
                            <input type="checkbox" id="toggle-encerrados">
                            <span class="toggle-slider"></span>
                        </label>
                        <span class="toggle-label">Exibir Encerrados</span>
                    </div>
                </div>

                <div class="filtros-info-box">
                    <p>Para localizar pedidos de venda faturados antes desse período utilize a opção <strong>"Exibir Todos"</strong> em <strong>"Venda de Produto"</strong> no menu.</p>
                </div>
            </div>
            <div class="modal-filtros-footer">
                <button type="button" class="btn-desfazer" onclick="desfazerFiltros()">
                    <i class="fas fa-undo"></i> Desfazer
                </button>
                <button type="button" class="btn-atualizar-filtro" onclick="aplicarFiltros()">
                    <i class="fas fa-sync"></i> Atualizar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Selecionar Vendedor -->
    <div class="modal-overlay" id="modal-selecionar-vendedor">
        <div class="modal-vendedor-content">
            <div class="modal-filtros-header">
                <h2 style="color: #f97316;">Exibir Vendedor</h2>
                <button class="close-btn" onclick="fecharModalVendedor()">
                    Fechar <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="vendedor-search-bar">
                <div class="filter-icon"><i class="fas fa-filter"></i></div>
                <input type="text" id="busca-vendedor" placeholder="Pesquisar por Nome">
                <button class="search-btn"><i class="fas fa-search"></i></button>
            </div>
            <div class="vendedor-list" id="vendedor-list">
                <div class="vendedor-item selected" data-id="todos">Todos os Vendedores</div>
                <div class="vendedor-item" data-id="139">Augusto Ladeira</div>
                <div class="vendedor-item" data-id="146">Fabiano Marques</div>
                <div class="vendedor-item" data-id="147">Fabíola Souza</div>
                <div class="vendedor-item" data-id="156">Márcia Scarcella</div>
                <div class="vendedor-item" data-id="162">Renata Nascimento</div>
            </div>
        </div>
    </div>

    <!-- Modal Confirmação de Alterações Não Salvas -->
    <div class="modal-confirm-overlay" id="modal-confirmar-alteracoes">
        <div class="modal-confirm-content">
            <h3>Desprezar as alterações realizadas?</h3>
            <a class="link-alteracoes" onclick="toggleListaAlteracoes()">quais alterações?</a>
            <div class="alteracoes-lista" id="lista-alteracoes">
                <ul id="alteracoes-itens">
                    <!-- Será preenchido dinamicamente -->
                </ul>
            </div>
            <div class="modal-confirm-buttons">
                <button type="button" class="btn-confirm-sim" id="btn-confirmar-sim">Sim</button>
                <button type="button" class="btn-confirm-nao" id="btn-confirmar-nao">Não</button>
            </div>
        </div>
    </div>

    <!-- Modal Configurar Etapas do Kanban -->
    <div class="modal-overlay" id="modal-etapas-kanban">
        <div class="modal-etapas-content">
            <div class="modal-etapas-header">
                <h2><i class="fas fa-tasks" style="margin-right: 10px;"></i>Alterar as Etapas deste Processo</h2>
                <button class="close-btn" onclick="fecharModalEtapas()">
                    Fechar <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-etapas-body">
                <p>Aqui você pode modificar o nome de cada etapa do seu processo de venda</p>
                
                <div class="etapas-container" id="etapas-container">
                    <!-- Etapas serão carregadas dinamicamente -->
                </div>

                <div class="etapas-actions">
                    <button type="button" class="btn-adicionar-etapa" onclick="adicionarNovaEtapa()">
                        <i class="fas fa-plus-circle"></i> Adicionar Nova Etapa
                    </button>
                    <span class="etapas-counter" id="etapas-counter">6 etapas configuradas</span>
                </div>

                <div class="etapas-info-box">
                    <i class="fas fa-info-circle"></i>
                    <p>As etapas podem deixar de ser usadas somente quando não houver mais Orçamentos nela. Arraste as etapas para reordenar.</p>
                </div>
            </div>
            <div class="modal-etapas-footer">
                <div class="alterar-numeracao">
                    <label class="checkbox-container">
                        <input type="checkbox" id="checkbox-alterar-numeracao">
                        <span class="checkmark"></span>
                    </label>
                    <i class="fas fa-edit"></i>
                    <span>Alterar o <strong>número dos próximos</strong> Pedidos de Venda e Remessas de Produto</span>
                </div>
                <div class="modal-etapas-buttons">
                    <button type="button" class="btn-cancelar-etapas" onclick="fecharModalEtapas()">
                        <i class="fas fa-times"></i> Cancelar
                    </button>
                    <button type="button" class="btn-confirmar-etapas" onclick="confirmarEtapas()">
                        <i class="fas fa-check"></i> Confirmar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Novo Orçamento - Estilo Omie Profissional -->
    <div class="modal-overlay" id="modal-novo-orcamento">
        <div class="modal-content-omie" style="max-width: 1100px;">
            <!-- Header -->
            <div class="modal-header-omie">
                <h2><i class="fas fa-file-invoice" style="color: #f97316;"></i> Incluir Orçamento</h2>
                <div style="display: flex; align-items: center; gap: 12px;">
                    <button class="close-btn" onclick="fecharModalNovoOrcamento()">
                        Fechar <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>

            <!-- Container Principal -->
            <div class="modal-container-omie">
                <!-- Área Principal -->
                <div class="modal-main-content" style="padding: 20px;">
                    <!-- Seção Cliente -->
                    <div class="orcamento-cliente-section">
                        <div class="orcamento-cliente-avatar">
                            <i class="fas fa-user"></i>
                        </div>
                        <div class="orcamento-cliente-info">
                            <div class="orcamento-cliente-row">
                                <div class="orcamento-field-group" style="flex: 1;">
                                    <label>Cliente <i class="fas fa-link" style="color: #999; font-size: 10px;"></i></label>
                                    <div class="input-with-btn">
                                        <input type="text" id="novo-cliente" placeholder="Digite o nome ou código do cliente" class="orcamento-input">
                                        <button type="button" class="btn-input-action"><i class="fas fa-search"></i></button>
                                    </div>
                                </div>
                                <button type="button" class="btn-consulta-credito">
                                    <i class="fas fa-search"></i> Consulta de Crédito
                                </button>
                                <div class="orcamento-field-group">
                                    <label>Previsão de Faturamento</label>
                                    <div class="input-with-btn">
                                        <input type="date" id="novo-previsao-faturamento" class="orcamento-input" value="">
                                        <button type="button" class="btn-input-action"><i class="fas fa-calendar"></i></button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Linha de Valores -->
                    <div class="orcamento-valores-row">
                        <div class="orcamento-valor-box">
                            <label>Total de Mercadorias <i class="fas fa-pencil-alt" style="color: #999; font-size: 9px;"></i></label>
                            <input type="text" id="novo-total-mercadorias" class="orcamento-valor-input" value="0,00" readonly>
                        </div>
                        <div class="orcamento-valor-box">
                            <label>Valor do Desconto <i class="fas fa-pencil-alt" style="color: #999; font-size: 9px;"></i></label>
                            <input type="text" id="novo-desconto" class="orcamento-valor-input" value="0,00">
                        </div>
                        <div class="orcamento-valor-box">
                            <label>Total de IPI</label>
                            <input type="text" id="novo-total-ipi" class="orcamento-valor-input" value="0,00" readonly>
                        </div>
                        <div class="orcamento-valor-box">
                            <label>Total de ICMS ST</label>
                            <input type="text" id="novo-total-icms" class="orcamento-valor-input" value="0,00" readonly>
                        </div>
                        <div class="orcamento-valor-box destaque">
                            <label>Valor Total do Pedido</label>
                            <input type="text" id="novo-valor-total" class="orcamento-valor-input destaque" value="0,00" readonly>
                        </div>
                    </div>

                    <!-- Linha Vendedor e Parcelas -->
                    <div class="orcamento-info-row">
                        <div class="orcamento-field-group">
                            <label>Vendedor <i class="fas fa-plus" style="color: #f97316; font-size: 10px; cursor: pointer;"></i></label>
                            <div class="input-with-btn">
                                <input type="text" id="novo-vendedor" placeholder="Selecione o vendedor" class="orcamento-input">
                                <button type="button" class="btn-input-action"><i class="fas fa-search"></i></button>
                            </div>
                        </div>
                        <div class="orcamento-field-group">
                            <label>Número de Parcelas <i class="fas fa-pencil-alt" style="color: #999; font-size: 9px;"></i> <i class="fas fa-plus" style="color: #f97316; font-size: 10px; cursor: pointer;"></i></label>
                            <div class="input-with-btn">
                                <select id="novo-parcelas" class="orcamento-input">
                                    <option value="a_vista">A Vista</option>
                                    <option value="30">30 dias</option>
                                    <option value="30_60">30/60 dias</option>
                                    <option value="30_60_90">30/60/90 dias</option>
                                    <option value="personalizado">Personalizado</option>
                                </select>
                                <button type="button" class="btn-input-action"><i class="fas fa-search"></i></button>
                                <button type="button" class="btn-input-action"><i class="fas fa-redo"></i></button>
                            </div>
                        </div>
                        <div class="orcamento-field-group">
                            <label>Cenário Fiscal</label>
                            <select id="novo-cenario-fiscal" class="orcamento-input">
                                <option value="">Selecione o cenário na lista</option>
                                <option value="venda_normal">Venda Normal</option>
                                <option value="venda_fora_estado">Venda Fora do Estado</option>
                                <option value="venda_zona_franca">Venda Zona Franca</option>
                            </select>
                        </div>
                    </div>

                    <!-- Abas -->
                    <div class="orcamento-tabs">
                        <button class="orcamento-tab active" data-tab="itens">Itens da Venda</button>
                        <button class="orcamento-tab" data-tab="departamentos">Departamentos</button>
                        <button class="orcamento-tab" data-tab="frete">Frete e Outras Despesas</button>
                        <button class="orcamento-tab" data-tab="info">Informações Adicionais</button>
                        <button class="orcamento-tab" data-tab="parcelas">Parcelas</button>
                        <button class="orcamento-tab" data-tab="obs">Observações</button>
                        <button class="orcamento-tab" data-tab="email">E-mail para o Cliente</button>
                    </div>

                    <!-- Conteúdo das Abas -->
                    <div class="orcamento-tab-content active" id="tab-itens">
                        <!-- Botões de Ação -->
                        <div class="orcamento-itens-actions">
                            <button type="button" class="btn-orcamento-action verde" onclick="adicionarItemOrcamento()">
                                <i class="fas fa-plus"></i> Novo Item
                            </button>
                            <button type="button" class="btn-orcamento-action laranja">
                                <i class="fas fa-edit"></i> Editar Item
                            </button>
                            <button type="button" class="btn-orcamento-action vermelho">
                                <i class="fas fa-trash"></i> Excluir Item
                            </button>
                        </div>

                        <!-- Tabela de Itens -->
                        <div class="orcamento-tabela-container">
                            <table class="orcamento-tabela">
                                <thead>
                                    <tr>
                                        <th style="width: 100px;">Produto <i class="fas fa-sort"></i></th>
                                        <th>Descrição do Produto <i class="fas fa-sort"></i></th>
                                        <th style="width: 100px;">Quantidade <i class="fas fa-sort"></i></th>
                                        <th style="width: 100px;">Qtd. Pendente <i class="fas fa-sort"></i></th>
                                        <th style="width: 120px;">Local de Estoque <i class="fas fa-sort"></i></th>
                                        <th style="width: 120px;">Preço Unitário <i class="fas fa-sort"></i></th>
                                        <th style="width: 120px;">Valor Total <i class="fas fa-sort"></i></th>
                                    </tr>
                                    <tr class="filter-row">
                                        <th><input type="text" placeholder="🔍" class="filter-input"></th>
                                        <th><input type="text" placeholder="🔍" class="filter-input"></th>
                                        <th><input type="text" placeholder="🔍" class="filter-input"></th>
                                        <th><input type="text" placeholder="🔍" class="filter-input"></th>
                                        <th><input type="text" placeholder="🔍" class="filter-input"></th>
                                        <th><input type="text" placeholder="🔍" class="filter-input"></th>
                                        <th><input type="text" placeholder="🔍" class="filter-input"></th>
                                    </tr>
                                </thead>
                                <tbody id="tbody-itens-orcamento">
                                    <!-- Itens serão adicionados aqui -->
                                </tbody>
                            </table>
                            <div class="orcamento-tabela-empty" id="empty-itens">
                                <i class="fas fa-inbox"></i>
                                <p>Nenhum registro encontrado</p>
                            </div>
                        </div>

                        <!-- Paginação -->
                        <div class="orcamento-paginacao">
                            <span class="paginacao-info">Nenhum registro encontrado</span>
                            <div class="paginacao-controls">
                                <button class="pag-btn" disabled><i class="fas fa-angle-double-left"></i></button>
                                <button class="pag-btn" disabled><i class="fas fa-angle-left"></i></button>
                                <span class="pag-text">anterior</span>
                                <span class="pag-current">1</span>
                                <span class="pag-text">próximo</span>
                                <button class="pag-btn" disabled><i class="fas fa-angle-right"></i></button>
                                <button class="pag-btn" disabled><i class="fas fa-angle-double-right"></i></button>
                            </div>
                        </div>
                    </div>

                    <!-- Aba Departamentos -->
                    <div class="orcamento-tab-content" id="tab-departamentos">
                        <div class="orcamento-section-form">
                            <div class="orcamento-form-row">
                                <div class="orcamento-field-group" style="flex: 1;">
                                    <label>Departamento Principal</label>
                                    <select id="novo-departamento" class="orcamento-input">
                                        <option value="">Selecione o departamento</option>
                                        <option value="comercial">Comercial</option>
                                        <option value="vendas">Vendas</option>
                                        <option value="atacado">Atacado</option>
                                        <option value="varejo">Varejo</option>
                                        <option value="e-commerce">E-commerce</option>
                                    </select>
                                </div>
                                <div class="orcamento-field-group" style="flex: 1;">
                                    <label>Centro de Custo</label>
                                    <select id="novo-centro-custo" class="orcamento-input">
                                        <option value="">Selecione o centro de custo</option>
                                        <option value="matriz">Matriz</option>
                                        <option value="filial1">Filial 01</option>
                                        <option value="filial2">Filial 02</option>
                                    </select>
                                </div>
                            </div>
                            <div class="orcamento-form-row">
                                <div class="orcamento-field-group" style="flex: 1;">
                                    <label>Projeto</label>
                                    <div class="input-with-btn">
                                        <input type="text" id="novo-projeto" placeholder="Vincular a um projeto (opcional)" class="orcamento-input">
                                        <button type="button" class="btn-input-action"><i class="fas fa-search"></i></button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Aba Frete -->
                    <div class="orcamento-tab-content" id="tab-frete">
                        <div class="orcamento-frete-section">
                            <div class="orcamento-field-group">
                                <label>Transportadora</label>
                                <div class="input-with-btn">
                                    <input type="text" id="novo-transportadora" placeholder="Selecione a transportadora" class="orcamento-input">
                                    <button type="button" class="btn-input-action"><i class="fas fa-search"></i></button>
                                </div>
                            </div>
                            <div class="orcamento-valores-row" style="margin-top: 16px;">
                                <div class="orcamento-valor-box">
                                    <label>Valor do Frete</label>
                                    <input type="text" id="novo-frete" class="orcamento-valor-input" value="0,00">
                                </div>
                                <div class="orcamento-valor-box">
                                    <label>Outras Despesas</label>
                                    <input type="text" id="novo-outras-despesas" class="orcamento-valor-input" value="0,00">
                                </div>
                                <div class="orcamento-valor-box">
                                    <label>Seguro</label>
                                    <input type="text" id="novo-seguro" class="orcamento-valor-input" value="0,00">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Aba Informações Adicionais -->
                    <div class="orcamento-tab-content" id="tab-info">
                        <div class="orcamento-section-form">
                            <div class="orcamento-field-group">
                                <label><i class="fas fa-file-alt"></i> Observações para Nota Fiscal</label>
                                <textarea id="novo-obs-nf" class="orcamento-textarea" placeholder="Estas observações serão impressas na Nota Fiscal..."></textarea>
                            </div>
                            <div class="orcamento-form-row" style="margin-top: 16px;">
                                <div class="orcamento-field-group" style="flex: 1;">
                                    <label>Número do Pedido do Cliente</label>
                                    <input type="text" id="novo-pedido-cliente" placeholder="Nº do pedido de compra do cliente" class="orcamento-input">
                                </div>
                                <div class="orcamento-field-group" style="flex: 1;">
                                    <label>Código de Rastreamento</label>
                                    <input type="text" id="novo-rastreamento" placeholder="Código de rastreio (opcional)" class="orcamento-input">
                                </div>
                            </div>
                            <div class="orcamento-form-row" style="margin-top: 16px;">
                                <div class="orcamento-field-group" style="flex: 1;">
                                    <label>Referência Interna</label>
                                    <input type="text" id="novo-ref-interna" placeholder="Referência para controle interno" class="orcamento-input">
                                </div>
                                <div class="orcamento-field-group" style="flex: 1;">
                                    <label>Ordem de Compra</label>
                                    <input type="text" id="novo-ordem-compra" placeholder="Nº da ordem de compra" class="orcamento-input">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Aba Parcelas -->
                    <div class="orcamento-tab-content" id="tab-parcelas">
                        <div class="orcamento-section-form">
                            <div class="orcamento-form-row">
                                <div class="orcamento-field-group" style="flex: 1;">
                                    <label><i class="fas fa-credit-card"></i> Forma de Pagamento</label>
                                    <select id="novo-forma-pagamento" class="orcamento-input" onchange="atualizarParcelas()">
                                        <option value="">Selecione a forma de pagamento</option>
                                        <option value="dinheiro">Dinheiro</option>
                                        <option value="pix">PIX</option>
                                        <option value="cartao_credito">Cartão de Crédito</option>
                                        <option value="cartao_debito">Cartão de Débito</option>
                                        <option value="boleto">Boleto Bancário</option>
                                        <option value="transferencia">Transferência Bancária</option>
                                        <option value="cheque">Cheque</option>
                                        <option value="crediario">Crediário</option>
                                    </select>
                                </div>
                                <div class="orcamento-field-group" style="flex: 1;">
                                    <label><i class="fas fa-list-ol"></i> Quantidade de Parcelas</label>
                                    <select id="novo-qtd-parcelas" class="orcamento-input" onchange="gerarTabelaParcelas()">
                                        <option value="1">1x (À Vista)</option>
                                        <option value="2">2x</option>
                                        <option value="3">3x</option>
                                        <option value="4">4x</option>
                                        <option value="5">5x</option>
                                        <option value="6">6x</option>
                                        <option value="10">10x</option>
                                        <option value="12">12x</option>
                                    </select>
                                </div>
                                <div class="orcamento-field-group" style="flex: 1;">
                                    <label><i class="fas fa-calendar"></i> Primeiro Vencimento</label>
                                    <input type="date" id="novo-primeiro-vencimento" class="orcamento-input">
                                </div>
                            </div>
                            <div class="orcamento-form-row" style="margin-top: 16px;">
                                <div class="orcamento-field-group" style="flex: 1;">
                                    <label><i class="fas fa-clock"></i> Intervalo entre Parcelas (dias)</label>
                                    <select id="novo-intervalo-parcelas" class="orcamento-input">
                                        <option value="30">30 dias</option>
                                        <option value="28">28 dias</option>
                                        <option value="15">15 dias</option>
                                        <option value="7">7 dias</option>
                                    </select>
                                </div>
                                <div class="orcamento-field-group" style="flex: 1;">
                                    <label><i class="fas fa-university"></i> Conta Bancária</label>
                                    <select id="novo-conta-bancaria" class="orcamento-input">
                                        <option value="">Selecione a conta</option>
                                        <option value="principal">Conta Principal</option>
                                        <option value="secundaria">Conta Secundária</option>
                                    </select>
                                </div>
                            </div>
                            
                            <!-- Tabela de Parcelas -->
                            <div class="orcamento-parcelas-tabela" style="margin-top: 20px;">
                                <h4 style="font-size: 12px; color: #555; margin-bottom: 12px;"><i class="fas fa-table"></i> Detalhamento das Parcelas</h4>
                                <div class="orcamento-tabela-container">
                                    <table class="orcamento-tabela">
                                        <thead>
                                            <tr>
                                                <th style="width: 80px;">Parcela</th>
                                                <th>Vencimento</th>
                                                <th>Valor</th>
                                                <th style="width: 120px;">Forma Pgto</th>
                                                <th style="width: 80px;">Status</th>
                                            </tr>
                                        </thead>
                                        <tbody id="tbody-parcelas">
                                            <tr>
                                                <td>1/1</td>
                                                <td>--/--/----</td>
                                                <td>R$ 0,00</td>
                                                <td>-</td>
                                                <td><span class="status-badge pendente">Pendente</span></td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Aba Observações -->
                    <div class="orcamento-tab-content" id="tab-obs">
                        <div class="orcamento-section-form">
                            <div class="orcamento-field-group">
                                <label><i class="fas fa-comment-alt"></i> Observações Internas</label>
                                <textarea id="novo-observacoes" class="orcamento-textarea" placeholder="Observações internas - não aparecem para o cliente..."></textarea>
                                <small class="field-hint">Estas observações são apenas para controle interno da empresa.</small>
                            </div>
                            <div class="orcamento-field-group" style="margin-top: 16px;">
                                <label><i class="fas fa-user"></i> Observações para o Cliente</label>
                                <textarea id="novo-obs-cliente" class="orcamento-textarea" placeholder="Observações que serão enviadas ao cliente..."></textarea>
                                <small class="field-hint">Estas observações aparecerão no orçamento enviado ao cliente.</small>
                            </div>
                            <div class="orcamento-field-group" style="margin-top: 16px;">
                                <label><i class="fas fa-truck"></i> Instruções de Entrega</label>
                                <textarea id="novo-instrucoes-entrega" class="orcamento-textarea" placeholder="Instruções especiais para entrega..." style="min-height: 80px;"></textarea>
                            </div>
                        </div>
                    </div>

                    <!-- Aba E-mail -->
                    <div class="orcamento-tab-content" id="tab-email">
                        <div class="orcamento-section-form">
                            <div class="orcamento-form-row">
                                <div class="orcamento-field-group" style="flex: 2;">
                                    <label><i class="fas fa-envelope"></i> E-mail do Destinatário</label>
                                    <input type="email" id="novo-email-cliente" placeholder="cliente@email.com" class="orcamento-input">
                                </div>
                                <div class="orcamento-field-group" style="flex: 1;">
                                    <label><i class="fas fa-copy"></i> Enviar Cópia (CC)</label>
                                    <input type="email" id="novo-email-copia" placeholder="copia@email.com" class="orcamento-input">
                                </div>
                            </div>
                            <div class="orcamento-field-group" style="margin-top: 16px;">
                                <label><i class="fas fa-heading"></i> Assunto do E-mail</label>
                                <input type="text" id="novo-email-assunto" placeholder="Orçamento Nº XXXXX - [Nome da Empresa]" class="orcamento-input">
                            </div>
                            <div class="orcamento-field-group" style="margin-top: 16px;">
                                <label><i class="fas fa-align-left"></i> Mensagem Personalizada</label>
                                <textarea id="novo-email-mensagem" class="orcamento-textarea" placeholder="Prezado cliente,

Segue em anexo o orçamento solicitado.

Agradecemos a preferência!

Atenciosamente,
[Nome do Vendedor]"></textarea>
                            </div>
                            <div class="orcamento-form-row" style="margin-top: 16px;">
                                <div class="orcamento-field-group">
                                    <label class="checkbox-label">
                                        <input type="checkbox" id="novo-email-anexar-pdf" checked>
                                        <span>Anexar PDF do Orçamento</span>
                                    </label>
                                </div>
                                <div class="orcamento-field-group">
                                    <label class="checkbox-label">
                                        <input type="checkbox" id="novo-email-notificar">
                                        <span>Notificar quando cliente visualizar</span>
                                    </label>
                                </div>
                            </div>
                            <div class="orcamento-email-actions" style="margin-top: 20px; display: flex; gap: 10px;">
                                <button type="button" class="btn-orcamento-action verde" onclick="enviarEmailOrcamento()">
                                    <i class="fas fa-paper-plane"></i> Enviar E-mail
                                </button>
                                <button type="button" class="btn-orcamento-action laranja" onclick="visualizarEmailOrcamento()">
                                    <i class="fas fa-eye"></i> Visualizar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sidebar de Ações -->
                <div class="modal-sidebar-actions">
                    <button class="sidebar-action-btn primary" onclick="salvarNovoOrcamento()">
                        <i class="fas fa-save"></i> Salvar
                    </button>
                    <div class="sidebar-divider"></div>
                    <button class="sidebar-action-btn" onclick="fecharModalNovoOrcamento()">
                        <i class="fas fa-times"></i> Cancelar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Adicionar/Editar Item do Pedido -->
    <div class="modal-overlay" id="modal-item-pedido">
        <div class="modal-content modal-item-pedido" style="max-width: 700px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #f97316, #ea580c);">
                <h2 id="modal-item-titulo"><i class="fas fa-box"></i> Novo Item</h2>
                <button class="modal-close" onclick="fecharModalItemPedido()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="item-pedido-id">
                <div class="form-row">
                    <div class="form-group">
                        <label>Código do Produto *</label>
                        <input type="text" id="item-pedido-codigo" placeholder="Ex: ITEM001">
                    </div>
                    <div class="form-group">
                        <label>Unidade</label>
                        <select id="item-pedido-unidade">
                            <option value="UN">UN - Unidade</option>
                            <option value="M">M - Metro</option>
                            <option value="M2">M² - Metro Quadrado</option>
                            <option value="KG">KG - Quilograma</option>
                            <option value="CX">CX - Caixa</option>
                            <option value="PC">PC - Peça</option>
                            <option value="LT">LT - Litro</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>Descrição do Produto *</label>
                    <input type="text" id="item-pedido-descricao" placeholder="Digite a descrição do produto">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Quantidade *</label>
                        <input type="number" id="item-pedido-quantidade" value="1" min="0.001" step="0.001">
                    </div>
                    <div class="form-group">
                        <label>Quantidade (Parcial)</label>
                        <input type="number" id="item-pedido-qtd-parcial" value="0" min="0" step="0.001">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Preço Unitário (R$) *</label>
                        <input type="text" id="item-pedido-preco" placeholder="0,00">
                    </div>
                    <div class="form-group">
                        <label>Desconto (R$)</label>
                        <input type="text" id="item-pedido-desconto" placeholder="0,00" value="0,00">
                    </div>
                </div>
                <div class="form-group">
                    <label>Local de Estoque</label>
                    <select id="item-pedido-estoque">
                        <option value="PADRAO - Local de Estoque Padrão">PADRAO - Local de Estoque Padrão</option>
                        <option value="SECUNDARIO - Estoque Secundário">SECUNDARIO - Estoque Secundário</option>
                        <option value="EXPEDICAO - Expedição">EXPEDICAO - Expedição</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-modal btn-modal-cancel" onclick="fecharModalItemPedido()">
                    Cancelar
                </button>
                <button type="button" class="btn-modal btn-modal-save" style="background: #f97316;" onclick="salvarItemPedido()">
                    <i class="fas fa-save"></i> Salvar Item
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Adicionar Item ao Orçamento -->
    <div class="modal-overlay" id="modal-adicionar-item">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #22c55e, #16a34a);">
                <h2><i class="fas fa-plus-circle"></i> Adicionar Item</h2>
                <button class="modal-close" onclick="fecharModalAdicionarItem()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Produto *</label>
                    <div class="input-with-btn">
                        <input type="text" id="item-produto" placeholder="Código ou nome do produto" class="orcamento-input">
                        <button type="button" class="btn-input-action"><i class="fas fa-search"></i></button>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Quantidade *</label>
                        <input type="number" id="item-quantidade" value="1" min="1" class="orcamento-input">
                    </div>
                    <div class="form-group">
                        <label>Preço Unitário (R$) *</label>
                        <input type="text" id="item-preco" placeholder="0,00" class="orcamento-input">
                    </div>
                </div>
                <div class="form-group">
                    <label>Local de Estoque</label>
                    <select id="item-estoque" class="orcamento-input">
                        <option value="principal">Estoque Principal</option>
                        <option value="secundario">Estoque Secundário</option>
                        <option value="expedição">Expedição</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-modal btn-modal-cancel" onclick="fecharModalAdicionarItem()">
                    Cancelar
                </button>
                <button type="button" class="btn-modal btn-modal-save" style="background: #22c55e;" onclick="confirmarAdicionarItem()">
                    <i class="fas fa-plus"></i> Adicionar Item
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Confirmar Faturar Todos - Design Premium -->
    <div class="modal-overlay" id="modal-faturar-todos">
        <div class="modal-content" style="max-width: 520px; border-radius: 16px; overflow: hidden; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);">
            <!-- Header Premium -->
            <div class="modal-header" style="background: linear-gradient(135deg, #059669, #10b981); padding: 20px 24px; border: none;">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <div style="width: 42px; height: 42px; background: rgba(255,255,255,0.2); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                        <i class="fas fa-bolt" style="font-size: 20px;"></i>
                    </div>
                    <div>
                        <h2 style="margin: 0; font-size: 18px; font-weight: 600;">Faturar Pedidos</h2>
                        <span style="font-size: 12px; opacity: 0.9;">Geração de notas fiscais em lote</span>
                    </div>
                </div>
                <button class="modal-close" onclick="fecharModalFaturar()" style="background: rgba(255,255,255,0.15); border: none; width: 36px; height: 36px; border-radius: 10px; color: white; cursor: pointer; transition: all 0.2s;">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <!-- Body Premium -->
            <div class="modal-body" style="padding: 0;">
                <!-- Info Card -->
                <div style="background: linear-gradient(135deg, #ecfdf5, #d1fae5); padding: 20px 24px; border-bottom: 1px solid #a7f3d0;">
                    <div style="display: flex; align-items: center; gap: 16px;">
                        <div style="width: 56px; height: 56px; background: white; border-radius: 14px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.2);">
                            <i class="fas fa-file-invoice-dollar" style="font-size: 26px; color: #059669;"></i>
                        </div>
                        <div>
                            <h3 style="margin: 0 0 4px 0; font-size: 16px; color: #065f46; font-weight: 600;">Confirmar Faturamento</h3>
                            <p id="faturar-info" style="margin: 0; color: #047857; font-size: 14px;">Você está prestes a faturar X pedidos.</p>
                        </div>
                    </div>
                </div>
                
                <!-- Lista de Pedidos -->
                <div style="padding: 20px 24px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <span style="font-size: 13px; font-weight: 600; color: #374151; text-transform: uppercase; letter-spacing: 0.5px;">Pedidos Selecionados</span>
                        <span id="faturar-total" style="font-size: 13px; color: #059669; font-weight: 600;"></span>
                    </div>
                    <div id="faturar-lista" style="max-height: 220px; overflow-y: auto; border-radius: 12px; border: 1px solid #e5e7eb; background: #fafafa;"></div>
                </div>
                
                <!-- Alerta Info -->
                <div style="padding: 0 24px 20px 24px;">
                    <div style="background: #fffbeb; border: 1px solid #fcd34d; border-radius: 10px; padding: 12px 16px; display: flex; align-items: flex-start; gap: 12px;">
                        <i class="fas fa-info-circle" style="color: #d97706; font-size: 16px; margin-top: 2px;"></i>
                        <div>
                            <span style="font-size: 13px; color: #92400e; font-weight: 500;">Atenção:</span>
                            <span style="font-size: 13px; color: #a16207;"> Esta ação irá gerar as notas fiscais para todos os pedidos listados acima.</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Footer Premium -->
            <div class="modal-footer" style="background: #f9fafb; padding: 16px 24px; border-top: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center;">
                <button type="button" onclick="fecharModalFaturar()" style="padding: 10px 20px; border: 1px solid #d1d5db; background: white; color: #374151; border-radius: 10px; font-size: 14px; font-weight: 500; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 8px;">
                    <i class="fas fa-times"></i> Cancelar
                </button>
                <button type="button" onclick="confirmarFaturarTodos()" style="padding: 10px 24px; border: none; background: linear-gradient(135deg, #059669, #10b981); color: white; border-radius: 10px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 8px; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);">
                    <i class="fas fa-check-circle"></i> Confirmar Faturamento
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Comunicar SEFAZ -->
    <div class="modal-overlay" id="modal-sefaz">
        <div class="modal-content" style="max-width: 550px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #06b6d4, #0891b2);">
                <h2><i class="fas fa-sync"></i> Comunicar com a SEFAZ</h2>
                <button class="modal-close" onclick="fecharModalSefaz()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body" style="text-align: center; padding: 30px;">
                <div id="sefaz-loading" style="display: none;">
                    <i class="fas fa-spinner fa-spin" style="font-size: 48px; color: #06b6d4; margin-bottom: 20px;"></i>
                    <h3 style="margin-bottom: 10px;">Comunicando com a SEFAZ...</h3>
                    <p style="color: #666;">Aguarde enquanto enviamos os dados.</p>
                </div>
                <div id="sefaz-inicial">
                    <i class="fas fa-building" style="font-size: 48px; color: #06b6d4; margin-bottom: 20px;"></i>
                    <h3 style="margin-bottom: 10px;">Transmitir Notas Fiscais</h3>
                    <p id="sefaz-info" style="color: #666; margin-bottom: 20px;">X notas fiscais prontas para transmissão.</p>
                    <div id="sefaz-lista" style="text-align: left; max-height: 200px; overflow-y: auto; background: #f5f5f5; border-radius: 8px; padding: 12px; margin-bottom: 20px;"></div>
                </div>
                <div id="sefaz-resultado" style="display: none;">
                    <i class="fas fa-check-circle" style="font-size: 48px; color: #22c55e; margin-bottom: 20px;"></i>
                    <h3 style="margin-bottom: 10px;">Transmissão Concluída!</h3>
                    <p id="sefaz-resultado-info" style="color: #666;"></p>
                </div>
            </div>
            <div class="modal-footer" style="justify-content: center;">
                <button type="button" class="btn-modal btn-modal-cancel" onclick="fecharModalSefaz()">
                    Fechar
                </button>
                <button type="button" id="btn-transmitir-sefaz" class="btn-modal btn-modal-save" style="background: #06b6d4;" onclick="transmitirSefaz()">
                    <i class="fas fa-paper-plane"></i> Transmitir para SEFAZ
                </button>
            </div>
        </div>
    </div>

    <!-- Chat Button -->
    <!-- Removido - Chat agora é carregado via /js/chat-suporte-widgets.js -->

    <script>
        // DEBUG: Log imediato para verificar se o script está sendo executado
        console.log('===========================================');
        console.log('🔷 [KANBAN DEBUG] Script principal INICIADO!');
        console.log('🔷 [KANBAN DEBUG] Timestamp:', new Date().toISOString());
        console.log('🔷 [KANBAN DEBUG] URL:', window.location.href);
        console.log('===========================================');
        
        // ========================================
        // UTILITÁRIOS GLOBAIS
        // ========================================
        function showToast(message, type = 'info') {
            // Remover toast existente
            const existingToast = document.querySelector('.toast-notification');
            if (existingToast) existingToast.remove();
            
            // Criar toast
            const toast = document.createElement('div');
            toast.className = `toast-notification toast-${type}`;
            toast.innerHTML = `
                <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle'}"></i>
                <span>${message}</span>
            `;
            
            // Estilos inline para o toast
            toast.style.cssText = `
                position: fixed;
                bottom: 20px;
                right: 20px;
                background: ${type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : '#3b82f6'};
                color: white;
                padding: 14px 20px;
                border-radius: 8px;
                display: flex;
                align-items: center;
                gap: 10px;
                font-size: 14px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                z-index: 10000;
                animation: toastSlideIn 0.3s ease;
            `;
            
            document.body.appendChild(toast);
            
            // Auto-remover após 3 segundos
            setTimeout(() => {
                toast.style.animation = 'toastSlideOut 0.3s ease forwards';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Adicionar animações do toast
        if (!document.getElementById('toast-animations')) {
            const style = document.createElement('style');
            style.id = 'toast-animations';
            style.textContent = `
                @keyframes toastSlideIn {
                    from { transform: translateX(100%); opacity: 0; }
                    to { transform: translateX(0); opacity: 1; }
                }
                @keyframes toastSlideOut {
                    from { transform: translateX(0); opacity: 1; }
                    to { transform: translateX(100%); opacity: 0; }
                }
            `;
            document.head.appendChild(style);
        }
        
        // ========================================
        // DADOS DO KANBAN (carregados da API)
        // ========================================
        console.log('🔷 Kanban: Inicializando estrutura de dados...');
        
        // Estrutura dinâmica - será preenchida pela API
        let dadosVendas = {
            orcamento: [],
            analise: [],
            aprovado: [],
            faturar: [],
            faturado: [],
            entregue: []
        };
        
        // Dados de fallback caso a API falhe
        const dadosFallback = {
            orcamento: [
                { id: 9, cliente: 'TIÃO MATERIAIS PARA CONSTRUÇÃO LTDA', status: 'Faturamento atrasado', valor: 3700.00, parcelas: 'a vista', origem: 'Omie' },
                { id: 8, cliente: 'COMERCIAL ELETRICA PAPIRO LTDA', status: 'Faturamento atrasado', valor: 13084.67, parcelas: 'em 3x', origem: 'Omie' },
            ],
            analise: [
                { id: 233, cliente: 'IMPACTO ELETRICA', status: 'Faturamento atrasado', valor: 80780.00, parcelas: 'em 4x', origem: 'Omie' },
            ],
            aprovado: [
                { id: 1343, cliente: 'AL CONESUL VALVULAS INDUSTRIAIS LTDA', status: 'Faturamento atrasado', valor: 3000.00, parcelas: 'em 3x', origem: 'Omie' },
            ],
            faturar: [
                { id: 3, cliente: 'ILUMINACAO PAULISTANA SPE S/A', status: 'Faturamento atrasado', valor: 529.00, parcelas: 'p/ 11/06 Qua', origem: 'Omie' },
            ],
            faturado: [
                { id: 1387, cliente: 'SARAIVA MATERIAIS ELETRICOS', status: 'Faturado', valor: 34325.00, parcelas: 'em 4x', origem: 'Omie', nf: '00000251' },
            ],
            entregue: []
        };

        // Mapeamento de status da API para colunas do Kanban
        const statusParaColuna = {
            'orcamento': 'orcamento',
            'orçamento': 'orcamento',
            'analise': 'analise',
            'análise': 'analise',
            'analise_credito': 'analise',
            'aprovado': 'aprovado',
            'pedido_aprovado': 'aprovado',
            'faturar': 'faturar',
            'a_faturar': 'faturar',
            'faturado': 'faturado',
            'entregue': 'entregue',
            'recibo': 'entregue',
            'rejeitado': 'orcamento',
            'cancelado': 'orcamento'
        };

        // Função para carregar pedidos da API
        async function carregarPedidosKanban() {
            console.log('📡 [KANBAN] Iniciando carregamento de pedidos da API...');
            showToast('Carregando pedidos...', 'info');
            
            try {
                console.log('📡 [KANBAN] Fazendo fetch para /api/vendas/kanban/pedidos');
                const response = await fetch('/api/vendas/kanban/pedidos', {
                    method: 'GET',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                console.log('📡 [KANBAN] Response status:', response.status);
                
                if (!response.ok) {
                    throw new Error(`Erro ${response.status}: ${response.statusText}`);
                }
                
                const pedidosAPI = await response.json();
                console.log('✅ [KANBAN] Pedidos recebidos da API:', pedidosAPI.length || 0);
                console.log('✅ [KANBAN] Exemplo de pedido:', pedidosAPI[0]);
                
                // Se a API retornou dados válidos
                if (Array.isArray(pedidosAPI) && pedidosAPI.length > 0) {
                    // Limpar estrutura
                    dadosVendas = {
                        orcamento: [],
                        analise: [],
                        aprovado: [],
                        faturar: [],
                        faturado: [],
                        entregue: []
                    };
                    
                    // Organizar pedidos por coluna/status
                    pedidosAPI.forEach(pedido => {
                        const statusNormalizado = (pedido.status || 'orcamento').toLowerCase().trim();
                        const coluna = statusParaColuna[statusNormalizado] || 'orcamento';
                        
                        // Formatar pedido para o formato do kanban
                        const pedidoFormatado = {
                            id: pedido.id || pedido.numero,
                            cliente: pedido.cliente || pedido.cliente_nome || pedido.empresa_nome || 'Cliente não informado',
                            status: pedido.status || 'Pendente',
                            valor: parseFloat(pedido.valor || pedido.valor_total || 0),
                            parcelas: pedido.parcelas || pedido.condicao_pagamento || 'a vista',
                            origem: pedido.origem || 'Sistema',
                            vendedor: pedido.vendedor || pedido.vendedor_nome || '',
                            nf: pedido.nf || pedido.nota_fiscal || null,
                            transportadora: pedido.transportadora || null,
                            data: pedido.data || pedido.data_criacao || '',
                            observacoes: pedido.observacoes || pedido.faturamento || ''
                        };
                        
                        // Adicionar à coluna correta
                        if (dadosVendas[coluna]) {
                            dadosVendas[coluna].push(pedidoFormatado);
                        }
                    });
                    
                    console.log('📊 Pedidos organizados por coluna:', {
                        orcamento: dadosVendas.orcamento.length,
                        analise: dadosVendas.analise.length,
                        aprovado: dadosVendas.aprovado.length,
                        faturar: dadosVendas.faturar.length,
                        faturado: dadosVendas.faturado.length,
                        entregue: dadosVendas.entregue.length
                    });
                    
                    showToast(`${pedidosAPI.length} pedidos carregados com sucesso!`, 'success');
                } else {
                    console.log('⚠️ API retornou array vazio, usando dados de fallback');
                    dadosVendas = JSON.parse(JSON.stringify(dadosFallback));
                    showToast('Nenhum pedido encontrado no servidor. Exibindo dados de exemplo.', 'info');
                }
                
            } catch (error) {
                console.error('❌ Erro ao carregar pedidos:', error);
                dadosVendas = JSON.parse(JSON.stringify(dadosFallback));
                showToast('Erro ao conectar com servidor. Usando dados locais.', 'error');
            }
            
            // Renderizar o kanban com os dados
            renderKanban();
        }

        // ========================================
        // RENDER CARDS
        // ========================================
        function renderCard(item) {
            let statusClass = 'atrasado';
            if (item.status === 'Faturado') statusClass = 'faturado';
            else if (item.status === 'Cancelado') statusClass = 'cancelado';
            
            // Ícone para status Cancelado
            const statusIcon = item.status === 'Cancelado' ? '<i class="fas fa-times"></i> ' : '';
            
            let nfBadge = '';
            if (item.nf) {
                nfBadge = `<span class="card-badge nf">Nota Fiscal: ${item.nf}</span>`;
            }

            let transportadora = '';
            if (item.transportadora) {
                transportadora = `<div class="card-transport">Transportadora: ${item.transportadora}</div>`;
            }

            let mensagem = '';
            if (item.mensagem) {
                mensagem = `
                    <div class="card-message">
                        <i class="fas fa-comment"></i>
                        <span>${item.mensagem}</span>
                    </div>
                `;
            }

            return `
                <div class="kanban-card" draggable="true" data-id="${item.id}" ondblclick="abrirModalEditar(${item.id})">
                    ${nfBadge}
                    <div class="card-header">
                        <span class="card-number">Orçamento Nº ${item.id}</span>
                        <button class="card-menu" onclick="event.stopPropagation(); abrirModalEditar(${item.id})" title="Editar pedido">
                            <i class="fas fa-ellipsis-v"></i>
                        </button>
                    </div>
                    <div class="card-title">${item.cliente}</div>
                    <span class="card-status ${statusClass}">${statusIcon}${item.status}</span>
                    <div class="card-value">$ ${item.valor.toLocaleString('pt-BR', { minimumFractionDigits: 2 })} ${item.parcelas}</div>
                    <div class="card-origin">
                        <i class="fas fa-check-circle"></i>
                        Origem: ${item.origem}
                    </div>
                    ${transportadora}
                    ${mensagem}
                </div>
            `;
        }

        function renderKanban() {
            console.log('🔄 renderKanban() chamado');
            console.log('📊 dadosVendas:', dadosVendas);
            
            // Orçamento
            const colOrcamento = document.getElementById('col-orcamento');
            console.log('📍 col-orcamento elemento:', colOrcamento);
            if (!colOrcamento) {
                console.error('❌ Elemento col-orcamento não encontrado!');
                return;
            }
            colOrcamento.innerHTML = dadosVendas.orcamento.map(renderCard).join('');
            console.log('✅ Orçamento renderizado:', dadosVendas.orcamento.length, 'cards');

            // Análise
            const colAnalise = document.getElementById('col-analise');
            colAnalise.innerHTML = dadosVendas.analise.map(renderCard).join('');

            // Aprovado
            const colAprovado = document.getElementById('col-aprovado');
            colAprovado.innerHTML = dadosVendas.aprovado.map(renderCard).join('');

            // Faturar
            const colFaturar = document.getElementById('col-faturar');
            colFaturar.innerHTML = dadosVendas.faturar.map(renderCard).join('');

            // Faturado
            const colFaturado = document.getElementById('col-faturado');
            colFaturado.innerHTML = dadosVendas.faturado.map(renderCard).join('');

            // Adicionar eventos de drag
            initDragAndDrop();
        }

        // ========================================
        // DRAG AND DROP
        // ========================================
        function initDragAndDrop() {
            const cards = document.querySelectorAll('.kanban-card');
            const columns = document.querySelectorAll('.kanban-column-content');

            cards.forEach(card => {
                card.addEventListener('dragstart', handleDragStart);
                card.addEventListener('dragend', handleDragEnd);
            });

            columns.forEach(column => {
                column.addEventListener('dragover', handleDragOver);
                column.addEventListener('drop', function(e) { handleDrop.call(this, e); });
                column.addEventListener('dragleave', handleDragLeave);
            });
        }

        let draggedCard = null;

        function handleDragStart(e) {
            draggedCard = this;
            this.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
        }

        function handleDragEnd(e) {
            this.classList.remove('dragging');
            document.querySelectorAll('.kanban-column-content').forEach(col => {
                col.classList.remove('drag-over');
            });
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            this.classList.add('drag-over');
        }

        function handleDragLeave(e) {
            this.classList.remove('drag-over');
        }

        async function handleDrop(e) {
            e.preventDefault();
            this.classList.remove('drag-over');
            
            if (draggedCard) {
                // Capturar informações para histórico
                const pedidoId = draggedCard.getAttribute('data-id');
                const colunaOrigemEl = draggedCard.parentElement;
                const colunaDestinoId = this.id;
                
                // Mapear IDs para nomes e status do banco
                const colunaNomes = {
                    'col-orcamento': 'Orçamento',
                    'col-analise': 'Em análise',
                    'col-aprovado': 'Aprovado',
                    'col-faturar': 'Faturar',
                    'col-faturado': 'Faturado',
                    'col-entregue': 'Entregue'
                };
                
                // Mapear ID da coluna para status do banco
                const colunaParaStatus = {
                    'col-orcamento': 'orcamento',
                    'col-analise': 'analise',
                    'col-aprovado': 'aprovado',
                    'col-faturar': 'faturar',
                    'col-faturado': 'faturado',
                    'col-entregue': 'entregue'
                };
                
                const etapaOrigem = colunaNomes[colunaOrigemEl?.id] || 'Desconhecido';
                const etapaDestino = colunaNomes[colunaDestinoId] || 'Desconhecido';
                const novoStatus = colunaParaStatus[colunaDestinoId] || 'orcamento';
                
                // Remove empty state se existir
                const emptyState = this.querySelector('.empty-column');
                if (emptyState) {
                    emptyState.remove();
                }
                
                this.appendChild(draggedCard);
                
                // Atualizar contadores
                updateCounters();
                
                // Atualizar status e registrar no histórico
                if (pedidoId && etapaOrigem !== etapaDestino) {
                    try {
                        const token = localStorage.getItem('token');
                        
                        // 1. Atualizar o status do pedido no banco
                        const statusResponse = await fetch(`/api/vendas/pedidos/${pedidoId}`, {
                            method: 'PATCH',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${token}`
                            },
                            body: JSON.stringify({
                                status: novoStatus
                            })
                        });
                        
                        if (!statusResponse.ok) {
                            const err = await statusResponse.json().catch(() => ({}));
                            console.error('Erro ao atualizar status:', err);
                            showNotification(err.message || 'Erro ao atualizar status do pedido', 'error');
                            // Reverter o movimento visual
                            if (colunaOrigemEl) {
                                colunaOrigemEl.appendChild(draggedCard);
                                updateCounters();
                            }
                            return;
                        }
                        
                        // 2. Registrar no histórico
                        await fetch(`/api/vendas/pedidos/${pedidoId}/historico`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${token}`
                            },
                            body: JSON.stringify({
                                tipo: 'status',
                                descricao: `Etapa alterada de "${etapaOrigem}" para "${etapaDestino}"`,
                                usuario: 'Administrador'
                            })
                        });
                        
                        // Notificar sucesso
                        showNotification(`Pedido movido para ${etapaDestino}!`, 'success');
                    } catch (err) {
                        console.error('Erro ao mover pedido:', err);
                        showNotification('Erro ao mover pedido. Tente novamente.', 'error');
                        // Reverter o movimento visual
                        if (colunaOrigemEl) {
                            colunaOrigemEl.appendChild(draggedCard);
                            updateCounters();
                        }
                    }
                } else {
                    // Apenas moveu para a mesma coluna
                    showNotification(`Pedido movido para ${etapaDestino}!`, 'success');
                }
            }
        }

        function updateCounters() {
            const columns = {
                'col-orcamento': 'Mais de 50 registros',
                'col-analise': 'count-analise',
                'col-aprovado': 'count-aprovado',
                'col-faturar': 'count-faturar',
                'col-faturado': 'count-faturado',
                'col-entregue': 'count-entregue'
            };

            Object.entries(columns).forEach(([colId, countId]) => {
                if (countId.startsWith('count-')) {
                    const col = document.getElementById(colId);
                    const counter = document.getElementById(countId);
                    const count = col.querySelectorAll('.kanban-card').length;
                    counter.textContent = count === 0 ? 'Nenhum registro' : `${count} registro${count > 1 ? 's' : ''}`;
                }
            });
        }

        // ========================================
        // MODAL EDITAR PEDIDO
        // ========================================
        let pedidoAtual = null;
        
        function encontrarPedido(id) {
            // Busca em todas as colunas
            for (const coluna of Object.keys(dadosVendas)) {
                const pedido = dadosVendas[coluna].find(p => p.id == id);
                if (pedido) {
                    pedido._coluna = coluna;
                    return pedido;
                }
            }
            return null;
        }
        
        function abrirModalEditar(id) {
            const pedido = encontrarPedido(id);
            if (!pedido) {
                showNotification('Pedido não encontrado', 'error');
                return;
            }
            
            pedidoAtual = pedido;
            
            // Atualizar título do modal
            document.getElementById('modal-titulo-pedido').textContent = `Orçamento Nº ${pedido.id}`;
            
            // Atualizar avatar do cliente (primeiras 2 letras)
            const clienteNome = pedido.cliente || 'Cliente';
            const iniciais = clienteNome.split(' ').map(n => n.charAt(0).toUpperCase()).slice(0, 2).join('');
            document.getElementById('modal-cliente-avatar').textContent = iniciais;
            
            // Preencher campos principais
            document.getElementById('edit-pedido-id').value = pedido.id;
            document.getElementById('edit-cliente').value = pedido.cliente || '';
            document.getElementById('edit-valor-total').value = formatarMoeda(pedido.valor || 0);
            document.getElementById('edit-total-mercadorias').value = formatarMoeda(pedido.valor || 0);
            document.getElementById('edit-vendedor').value = pedido.vendedor || '';
            document.getElementById('edit-parcelas').value = pedido.parcelas || '28/35/42/49';
            document.getElementById('edit-observacoes').value = pedido.mensagem || '';
            
            // Campos de frete
            if (document.getElementById('edit-transportadora')) {
                document.getElementById('edit-transportadora').value = pedido.transportadora || '';
            }
            if (document.getElementById('edit-nf')) {
                document.getElementById('edit-nf').value = pedido.nf || '';
            }
            if (document.getElementById('edit-origem')) {
                document.getElementById('edit-origem').value = pedido.origem || 'Omie';
            }
            
            // Atualizar alerta de status
            const statusAlert = document.getElementById('status-alert');
            const statusAlertText = document.getElementById('status-alert-text');
            if (pedido.status) {
                statusAlertText.textContent = pedido.status;
                statusAlert.className = 'status-alert';
                if (pedido.status.toLowerCase().includes('atrasado')) {
                    statusAlert.classList.add('warning');
                } else if (pedido.status.toLowerCase().includes('faturado') || pedido.status.toLowerCase().includes('aprovado')) {
                    statusAlert.classList.add('success');
                } else {
                    statusAlert.classList.add('info');
                }
            }
            
            // Limpar seleção de item
            itemSelecionado = null;
            itemSelecionadoIdx = null;
            
            // Carregar itens do pedido da API
            carregarItensPedido(pedido.id);
            
            // Resetar tabs para primeira aba
            switchModalTab('itens');
            
            // Limpar alterações anteriores e preparar rastreamento
            limparAlteracoes();
            
            // Mostrar modal
            document.getElementById('modal-editar-pedido').classList.add('active');
            
            // Rastrear alterações após um pequeno delay para garantir que os campos estão preenchidos
            setTimeout(() => {
                const form = document.getElementById('modal-editar-pedido');
                const inputs = form.querySelectorAll('input, select, textarea');
                formOriginalData['modal-editar-pedido'] = {};
                inputs.forEach(input => {
                    const name = input.name || input.id;
                    if (name) {
                        formOriginalData['modal-editar-pedido'][name] = input.type === 'checkbox' ? input.checked : input.value;
                        input.addEventListener('change', () => marcarAlteracao('modal-editar-pedido', input));
                        input.addEventListener('input', () => marcarAlteracao('modal-editar-pedido', input));
                    }
                });
            }, 100);
        }
        
        function switchModalTab(tabId) {
            // Remover active de todas as tabs
            document.querySelectorAll('.modal-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            // Ocultar todos os conteúdos
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            // Ativar tab e conteúdo selecionados
            document.querySelector(`.modal-tab[data-tab="${tabId}"]`).classList.add('active');
            document.getElementById(`tab-${tabId}`).classList.add('active');
        }
        
        function formatarMoeda(valor) {
            return 'R$ ' + parseFloat(valor || 0).toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }
        
        function fecharModalEditar() {
            if (temAlteracoesNaoSalvas()) {
                mostrarConfirmacaoAlteracoes(() => {
                    document.getElementById('modal-editar-pedido').classList.remove('active');
                    pedidoAtual = null;
                });
            } else {
                document.getElementById('modal-editar-pedido').classList.remove('active');
                pedidoAtual = null;
            }
        }
        
        async function salvarPedido() {
            if (!pedidoAtual) {
                showNotification('Nenhum pedido selecionado', 'error');
                return;
            }
            
            // Limpar alterações após salvar
            limparAlteracoes();
            
            // Capturar alterações para histórico
            const alteracoes = [];
            
            const novoCliente = document.getElementById('edit-cliente').value;
            const novoClienteId = document.getElementById('edit-cliente-id')?.value || null;
            const novoEmpresaId = document.getElementById('edit-empresa-id')?.value || null;
            
            if (novoCliente !== pedidoAtual.cliente) {
                alteracoes.push(`Cliente alterado de "${pedidoAtual.cliente}" para "${novoCliente}"`);
            }
            
            const novasParcelas = document.getElementById('edit-parcelas').value;
            if (novasParcelas !== pedidoAtual.parcelas) {
                alteracoes.push(`Parcelas alteradas para "${novasParcelas}"`);
            }
            
            const novoVendedor = document.getElementById('edit-vendedor').value;
            if (novoVendedor !== pedidoAtual.vendedor) {
                alteracoes.push(`Vendedor alterado para "${novoVendedor}"`);
            }
            
            // Atualizar dados do pedido localmente
            pedidoAtual.cliente = novoCliente;
            pedidoAtual.cliente_id = novoClienteId ? parseInt(novoClienteId) : pedidoAtual.cliente_id;
            pedidoAtual.empresa_id = novoEmpresaId ? parseInt(novoEmpresaId) : pedidoAtual.empresa_id;
            pedidoAtual.parcelas = novasParcelas;
            pedidoAtual.vendedor = novoVendedor;
            
            if (document.getElementById('edit-origem')) {
                pedidoAtual.origem = document.getElementById('edit-origem').value;
            }
            if (document.getElementById('edit-transportadora')) {
                const novaTransp = document.getElementById('edit-transportadora').value;
                if (novaTransp !== pedidoAtual.transportadora) {
                    alteracoes.push(`Transportadora alterada para "${novaTransp}"`);
                }
                pedidoAtual.transportadora = novaTransp;
            }
            if (document.getElementById('edit-nf')) {
                pedidoAtual.nf = document.getElementById('edit-nf').value;
            }
            if (document.getElementById('edit-observacoes')) {
                const novaObs = document.getElementById('edit-observacoes').value;
                if (novaObs !== pedidoAtual.mensagem) {
                    alteracoes.push('Observações atualizadas');
                }
                pedidoAtual.mensagem = novaObs;
            }
            
            // Salvar no backend via API
            try {
                const dadosAtualizar = {
                    cliente_id: pedidoAtual.cliente_id || null,
                    empresa_id: pedidoAtual.empresa_id || null,
                    observacao: pedidoAtual.mensagem || ''
                };
                
                const token = localStorage.getItem('token');
                const response = await fetch(`/api/vendas/pedidos/${pedidoAtual.id}`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    credentials: 'include',
                    body: JSON.stringify(dadosAtualizar)
                });
                
                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.message || 'Erro ao salvar');
                }
                
                // Registrar histórico se houve alterações
                if (alteracoes.length > 0) {
                    await registrarHistoricoLocal('edicao', alteracoes.join('; '));
                }
                
                // Re-renderizar kanban
                renderKanban();
                
                // Fechar modal e notificar
                fecharModalEditar();
                showNotification('Pedido atualizado com sucesso!', 'success');
                
            } catch (error) {
                console.error('Erro ao salvar pedido:', error);
                showNotification('Erro ao salvar: ' + error.message, 'error');
            }
        }
        
        // Funções adicionais da sidebar de ações
        function duplicarPedido() {
            if (!pedidoAtual) return;
            
            // Criar cópia do pedido
            const novoPedido = {
                ...pedidoAtual,
                id: Math.floor(Math.random() * 9000) + 1000,
                status: 'Novo',
                nf: null
            };
            
            // Adicionar à coluna de negociação
            dadosVendas.negociacao.push(novoPedido);
            
            // Re-renderizar kanban
            renderKanban();
            
            showNotification(`Pedido duplicado! Novo Orçamento Nº ${novoPedido.id}`, 'success');
        }
        
        function imprimirPedido() {
            if (!pedidoAtual) return;
            // Abrir modal de opções de impressão
            document.getElementById('modal-imprimir').classList.add('active');
        }

        function fecharModalImprimir() {
            document.getElementById('modal-imprimir').classList.remove('active');
        }

        function executarImpressao() {
            const tipoImpressao = document.querySelector('input[name="tipo-impressao"]:checked').value;
            fecharModalImprimir();
            
            showNotification(`Preparando ${tipoImpressao}...`, 'info');
            
            // Criar conteúdo para impressão baseado no tipo
            setTimeout(() => {
                const printWindow = window.open('', '_blank');
                printWindow.document.write(`
                    <html>
                    <head>
    <link rel="icon" type="image/x-icon" href="/favicon-aluforce.webp">
                        <title>Orçamento Nº ${pedidoAtual.id}</title>
                        <style>
                            body { font-family: Arial, sans-serif; padding: 40px; }
                            h1 { color: #f97316; border-bottom: 2px solid #f97316; padding-bottom: 10px; }
                            .info { margin: 20px 0; }
                            .info strong { display: inline-block; width: 150px; }
                            table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                            th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
                            th { background: #f5f5f5; }
                            .total { font-size: 18px; font-weight: bold; text-align: right; margin-top: 20px; }
                        </style>
                        
    `n</head>
                    <body>
                        <h1>Orçamento Nº ${pedidoAtual.id}</h1>
                        <div class="info"><strong>Cliente:</strong> ${pedidoAtual.cliente}</div>
                        <div class="info"><strong>Status:</strong> ${pedidoAtual.status}</div>
                        <div class="info"><strong>Vendedor:</strong> ${pedidoAtual.vendedor || 'Não definido'}</div>
                        <div class="info"><strong>Parcelas:</strong> ${pedidoAtual.parcelas}</div>
                        <div class="info"><strong>Origem:</strong> ${pedidoAtual.origem}</div>
                        ${pedidoAtual.transportadora ? `<div class="info"><strong>Transportadora:</strong> ${pedidoAtual.transportadora}</div>` : ''}
                        <table>
                            <thead>
                                <tr>
                                    <th>Produto</th>
                                    <th>Descrição</th>
                                    <th>Qtd</th>
                                    <th>Valor Unit.</th>
                                    <th>Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>ITEM001</td>
                                    <td>${pedidoAtual.cliente} - Descrição do produto</td>
                                    <td>1.000</td>
                                    <td>R$ ${formatarMoeda(pedidoAtual.valor)}</td>
                                    <td>R$ ${formatarMoeda(pedidoAtual.valor)}</td>
                                </tr>
                            </tbody>
                        </table>
                        <p class="total">Valor Total: R$ ${formatarMoeda(pedidoAtual.valor)}</p>
                        <scr` + `ipt>window.print(); window.close();<\/scr` + `ipt>
                        `n</body>
                    </html>
                `);
                printWindow.document.close();
            }, 500);
        }
        
        function conferirPedido() {
            if (!pedidoAtual) return;
            
            // Simular conferência - verificar campos obrigatórios
            const erros = [];
            if (!pedidoAtual.cliente) erros.push('Cliente não informado');
            if (!pedidoAtual.valor || pedidoAtual.valor <= 0) erros.push('Valor inválido');
            
            if (erros.length > 0) {
                showNotification('Problemas encontrados: ' + erros.join(', '), 'error');
            } else {
                showNotification('Pedido conferido! Todos os dados estão corretos.', 'success');
            }
        }
        
        async function faturarPedido() {
            if (!pedidoAtual) return;
            
            // Modal de confirmação personalizado
            const valorFormatado = formatarMoeda(pedidoAtual.valor);
            const confirmar = confirm(`Deseja faturar o Orçamento Nº ${pedidoAtual.id}?\n\nValor: ${valorFormatado}\nCliente: ${pedidoAtual.cliente}`);
            if (!confirmar) return;
            
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`/api/vendas/pedidos/${pedidoAtual.id}/faturar`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    
                    // Atualizar status localmente
                    const colunaAtual = pedidoAtual._coluna;
                    const idx = dadosVendas[colunaAtual]?.findIndex(p => p.id === pedidoAtual.id);
                    
                    if (idx !== undefined && idx !== -1) {
                        dadosVendas[colunaAtual].splice(idx, 1);
                    }
                    
                    pedidoAtual.status = 'Faturado';
                    pedidoAtual.nf = result.nf_numero;
                    pedidoAtual._coluna = 'faturado';
                    
                    if (!dadosVendas.faturado) dadosVendas.faturado = [];
                    dadosVendas.faturado.push(pedidoAtual);
                    
                    // Re-renderizar kanban
                    renderKanban();
                    
                    // Fechar modal
                    fecharModalEditar();
                    
                    showNotification(`Pedido faturado com sucesso! NF: ${result.nf_numero}`, 'success');
                } else {
                    const error = await response.json();
                    showNotification(error.message || 'Erro ao faturar pedido', 'error');
                }
            } catch (error) {
                console.error('Erro ao faturar:', error);
                
                // Fallback: faturar localmente
                const colunaAtual = pedidoAtual._coluna;
                const idx = dadosVendas[colunaAtual]?.findIndex(p => p.id === pedidoAtual.id);
                
                if (idx !== undefined && idx !== -1) {
                    dadosVendas[colunaAtual].splice(idx, 1);
                }
                
                pedidoAtual.status = 'Faturado';
                pedidoAtual.nf = '0000' + Math.floor(Math.random() * 9000 + 1000);
                pedidoAtual._coluna = 'faturado';
                
                if (!dadosVendas.faturado) dadosVendas.faturado = [];
                dadosVendas.faturado.push(pedidoAtual);
                
                renderKanban();
                fecharModalEditar();
                
                showNotification(`Pedido faturado! NF: ${pedidoAtual.nf}`, 'success');
            }
        }
        
        // ========================================
        // MODAL ANEXOS
        // ========================================
        let anexosPedido = {};

        function verAnexos() {
            if (!pedidoAtual) return;
            
            // Carregar anexos do pedido
            const anexos = anexosPedido[pedidoAtual.id] || [];
            renderizarAnexos(anexos);
            
            document.getElementById('modal-anexos').classList.add('active');
        }

        function fecharModalAnexos() {
            document.getElementById('modal-anexos').classList.remove('active');
        }

        function renderizarAnexos(anexos) {
            const container = document.getElementById('lista-anexos-container');
            
            if (anexos.length === 0) {
                container.innerHTML = '<p style="color: #888; font-size: 13px;">Nenhum anexo encontrado para este pedido.</p>';
                return;
            }
            
            container.innerHTML = anexos.map((anexo, idx) => `
                <div class="anexo-item">
                    <i class="fas ${getIconeArquivo(anexo.tipo)}"></i>
                    <div class="anexo-info">
                        <div class="anexo-nome">${anexo.nome}</div>
                        <div class="anexo-tamanho">${anexo.tamanho}</div>
                    </div>
                    <div class="anexo-actions">
                        <button onclick="downloadAnexo(${idx})" title="Baixar"><i class="fas fa-download"></i></button>
                        <button class="delete" onclick="excluirAnexo(${idx})" title="Excluir"><i class="fas fa-trash"></i></button>
                    </div>
                </div>
            `).join('');
        }

        function getIconeArquivo(tipo) {
            const icones = {
                'pdf': 'fa-file-pdf',
                'doc': 'fa-file-word',
                'docx': 'fa-file-word',
                'xls': 'fa-file-excel',
                'xlsx': 'fa-file-excel',
                'jpg': 'fa-file-image',
                'jpeg': 'fa-file-image',
                'png': 'fa-file-image',
                'default': 'fa-file'
            };
            return icones[tipo] || icones['default'];
        }

        function processarAnexos(files) {
            if (!pedidoAtual) return;
            
            if (!anexosPedido[pedidoAtual.id]) {
                anexosPedido[pedidoAtual.id] = [];
            }
            
            Array.from(files).forEach(file => {
                const extensao = file.name.split('.').pop().toLowerCase();
                anexosPedido[pedidoAtual.id].push({
                    nome: file.name,
                    tipo: extensao,
                    tamanho: formatarTamanhoArquivo(file.size),
                    data: new Date().toLocaleString('pt-BR')
                });
            });
            
            renderizarAnexos(anexosPedido[pedidoAtual.id]);
            showNotification(`${files.length} arquivo(s) anexado(s)!`, 'success');
        }

        function formatarTamanhoArquivo(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }

        function downloadAnexo(idx) {
            showNotification('Iniciando download...', 'info');
        }

        function excluirAnexo(idx) {
            if (!pedidoAtual) return;
            if (confirm('Tem certeza que deseja excluir este anexo?')) {
                anexosPedido[pedidoAtual.id].splice(idx, 1);
                renderizarAnexos(anexosPedido[pedidoAtual.id]);
                showNotification('Anexo excluído!', 'success');
            }
        }

        // Drag and drop para anexos
        document.addEventListener('DOMContentLoaded', function() {
            const uploadArea = document.getElementById('anexos-upload-area');
            if (uploadArea) {
                uploadArea.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    uploadArea.classList.add('dragover');
                });
                uploadArea.addEventListener('dragleave', () => {
                    uploadArea.classList.remove('dragover');
                });
                uploadArea.addEventListener('drop', (e) => {
                    e.preventDefault();
                    uploadArea.classList.remove('dragover');
                    processarAnexos(e.dataTransfer.files);
                });
            }
        });

        // ========================================
        // AUTOCOMPLETE CLIENTE/EMPRESA
        // ========================================
        
        let autocompleteTimeout = null;
        let autocompleteResultados = [];
        let autocompleteIndex = -1;

        // Inicializar autocomplete quando DOM carregar
        document.addEventListener('DOMContentLoaded', function() {
            const inputCliente = document.getElementById('edit-cliente');
            const dropdown = document.getElementById('cliente-autocomplete-dropdown');
            
            if (inputCliente && dropdown) {
                // Evento de digitação
                inputCliente.addEventListener('input', function(e) {
                    const query = e.target.value.trim();
                    
                    // Limpar timeout anterior
                    if (autocompleteTimeout) {
                        clearTimeout(autocompleteTimeout);
                    }
                    
                    // Se menos de 1 caractere, fechar dropdown
                    if (query.length < 1) {
                        fecharAutocomplete();
                        return;
                    }
                    
                    // Debounce de 300ms
                    autocompleteTimeout = setTimeout(() => {
                        buscarClientesEmpresas(query);
                    }, 300);
                });
                
                // Navegação por teclado
                inputCliente.addEventListener('keydown', function(e) {
                    if (!dropdown.classList.contains('active')) return;
                    
                    const itens = dropdown.querySelectorAll('.autocomplete-item');
                    
                    if (e.key === 'ArrowDown') {
                        e.preventDefault();
                        autocompleteIndex = Math.min(autocompleteIndex + 1, itens.length - 1);
                        atualizarSelecaoAutocomplete(itens);
                    } else if (e.key === 'ArrowUp') {
                        e.preventDefault();
                        autocompleteIndex = Math.max(autocompleteIndex - 1, 0);
                        atualizarSelecaoAutocomplete(itens);
                    } else if (e.key === 'Enter') {
                        e.preventDefault();
                        if (autocompleteIndex >= 0 && itens[autocompleteIndex]) {
                            itens[autocompleteIndex].click();
                        }
                    } else if (e.key === 'Escape') {
                        fecharAutocomplete();
                    }
                });
                
                // Fechar dropdown ao clicar fora
                document.addEventListener('click', function(e) {
                    if (!inputCliente.contains(e.target) && !dropdown.contains(e.target)) {
                        fecharAutocomplete();
                    }
                });
                
                // Abrir dropdown ao focar no input se tiver valor
                inputCliente.addEventListener('focus', function() {
                    if (this.value.length >= 1 && autocompleteResultados.length > 0) {
                        dropdown.classList.add('active');
                    }
                });
            }
        });

        async function buscarClientesEmpresas(query) {
            const dropdown = document.getElementById('cliente-autocomplete-dropdown');
            
            // Mostrar loading
            dropdown.innerHTML = '<div class="autocomplete-loading"><i class="fas fa-spinner fa-spin"></i> Buscando...</div>';
            dropdown.classList.add('active');
            
            try {
                const response = await fetch(`/api/vendas/clientes-empresas/search?q=${encodeURIComponent(query)}`, {
                    credentials: 'include'
                });
                
                if (!response.ok) throw new Error('Erro na busca');
                
                const resultados = await response.json();
                autocompleteResultados = resultados;
                autocompleteIndex = -1;
                
                if (resultados.length === 0) {
                    dropdown.innerHTML = `
                        <div class="autocomplete-empty">
                            <i class="fas fa-search"></i>
                            Nenhum cliente ou empresa encontrado
                        </div>
                    `;
                    return;
                }
                
                // Renderizar resultados
                dropdown.innerHTML = resultados.map((item, index) => {
                    const iniciais = item.nome.split(' ')
                        .filter((_, i, arr) => i === 0 || i === arr.length - 1)
                        .map(n => n.charAt(0).toUpperCase())
                        .join('');
                    
                    return `
                        <div class="autocomplete-item" data-index="${index}" onclick="selecionarClienteEmpresa(${index})">
                            <div class="autocomplete-avatar ${item.tipo}">${iniciais}</div>
                            <div class="autocomplete-info">
                                <div class="autocomplete-nome">${item.nome}</div>
                                <div class="autocomplete-subtitulo">${item.subtitulo || ''}</div>
                            </div>
                            <span class="autocomplete-tipo-badge ${item.tipo}">
                                ${item.tipo === 'empresa' ? 'Empresa' : 'Cliente'}
                            </span>
                        </div>
                    `;
                }).join('');
                
            } catch (error) {
                console.error('Erro ao buscar clientes/empresas:', error);
                dropdown.innerHTML = `
                    <div class="autocomplete-empty">
                        <i class="fas fa-exclamation-triangle"></i>
                        Erro ao buscar. Tente novamente.
                    </div>
                `;
            }
        }

        function selecionarClienteEmpresa(index) {
            const item = autocompleteResultados[index];
            if (!item) return;
            
            const inputCliente = document.getElementById('edit-cliente');
            const inputClienteId = document.getElementById('edit-cliente-id');
            const inputEmpresaId = document.getElementById('edit-empresa-id');
            const inputClienteTipo = document.getElementById('edit-cliente-tipo');
            const avatarCliente = document.getElementById('modal-cliente-avatar');
            
            // Preencher o campo de texto
            inputCliente.value = item.nome;
            
            // Preencher os campos ocultos
            if (item.tipo === 'empresa') {
                inputEmpresaId.value = item.empresa_id || item.id;
                inputClienteId.value = '';
            } else {
                inputClienteId.value = item.cliente_id || item.id;
                inputEmpresaId.value = item.empresa_id || '';
            }
            inputClienteTipo.value = item.tipo;
            
            // Atualizar avatar
            const iniciais = item.nome.split(' ')
                .filter((_, i, arr) => i === 0 || i === arr.length - 1)
                .map(n => n.charAt(0).toUpperCase())
                .join('');
            avatarCliente.textContent = iniciais;
            
            // Atualizar pedidoAtual se existir
            if (pedidoAtual) {
                pedidoAtual.cliente = item.nome;
                pedidoAtual.cliente_id = item.cliente_id || null;
                pedidoAtual.empresa_id = item.empresa_id || item.id;
            }
            
            // Fechar dropdown
            fecharAutocomplete();
            
            // Mostrar notificação
            showNotification(`${item.tipo === 'empresa' ? 'Empresa' : 'Cliente'} selecionado: ${item.nome}`, 'success');
        }

        function atualizarSelecaoAutocomplete(itens) {
            itens.forEach((item, index) => {
                if (index === autocompleteIndex) {
                    item.classList.add('selected');
                    item.scrollIntoView({ block: 'nearest' });
                } else {
                    item.classList.remove('selected');
                }
            });
        }

        function fecharAutocomplete() {
            const dropdown = document.getElementById('cliente-autocomplete-dropdown');
            if (dropdown) {
                dropdown.classList.remove('active');
            }
            autocompleteIndex = -1;
        }
        
        // ========================================
        // MODAL CONFIRMAÇÃO ALTERAÇÕES NÃO SALVAS
        // ========================================
        
        // Função showToast para compatibilidade
        function showToast(message, type = 'info') {
            if (typeof showNotification === 'function') {
                showNotification(message, type);
            } else {
                console.log(`[${type}] ${message}`);
            }
        }
        
        let alteracoesNaoSalvas = [];
        let onConfirmCallback = null;
        let onCancelCallback = null;
        let formOriginalData = {};

        // Rastrear alterações em formulários
        function rastrearAlteracoes(formId) {
            const form = document.getElementById(formId);
            if (!form) return;
            
            // Salvar estado original
            const inputs = form.querySelectorAll('input, select, textarea');
            formOriginalData[formId] = {};
            inputs.forEach(input => {
                const name = input.name || input.id;
                if (name) {
                    formOriginalData[formId][name] = input.type === 'checkbox' ? input.checked : input.value;
                }
            });
            
            // Adicionar listeners para detectar mudanças
            inputs.forEach(input => {
                input.addEventListener('change', () => marcarAlteracao(formId, input));
                input.addEventListener('input', () => marcarAlteracao(formId, input));
            });
        }

        function marcarAlteracao(formId, input) {
            const name = input.name || input.id;
            const label = input.closest('.form-group')?.querySelector('label')?.textContent || name;
            const valorOriginal = formOriginalData[formId]?.[name];
            const valorAtual = input.type === 'checkbox' ? input.checked : input.value;
            
            // Verificar se o valor mudou
            if (valorOriginal !== valorAtual) {
                // Adicionar à lista se não existir
                const existe = alteracoesNaoSalvas.find(a => a.campo === name);
                if (!existe) {
                    alteracoesNaoSalvas.push({
                        campo: name,
                        label: label,
                        de: valorOriginal,
                        para: valorAtual
                    });
                } else {
                    existe.para = valorAtual;
                }
            } else {
                // Remover da lista se voltou ao original
                alteracoesNaoSalvas = alteracoesNaoSalvas.filter(a => a.campo !== name);
            }
        }

        function temAlteracoesNaoSalvas() {
            return alteracoesNaoSalvas.length > 0;
        }

        function limparAlteracoes() {
            alteracoesNaoSalvas = [];
        }

        // Mostrar modal de confirmação
        function mostrarConfirmacaoAlteracoes(onConfirm, onCancel) {
            if (!temAlteracoesNaoSalvas()) {
                if (onConfirm) onConfirm();
                return;
            }
            
            onConfirmCallback = onConfirm;
            onCancelCallback = onCancel;
            
            // Preencher lista de alterações
            const lista = document.getElementById('alteracoes-itens');
            lista.innerHTML = alteracoesNaoSalvas.map(alt => `
                <li><i class="fas fa-edit"></i> ${alt.label}</li>
            `).join('');
            
            // Esconder lista inicialmente
            document.getElementById('lista-alteracoes').classList.remove('show');
            
            document.getElementById('modal-confirmar-alteracoes').classList.add('active');
        }

        function toggleListaAlteracoes() {
            document.getElementById('lista-alteracoes').classList.toggle('show');
        }

        function confirmarDesprezarAlteracoes() {
            document.getElementById('modal-confirmar-alteracoes').classList.remove('active');
            limparAlteracoes();
            if (onConfirmCallback) onConfirmCallback();
            onConfirmCallback = null;
            onCancelCallback = null;
        }

        function cancelarDesprezarAlteracoes() {
            document.getElementById('modal-confirmar-alteracoes').classList.remove('active');
            if (onCancelCallback) onCancelCallback();
            onConfirmCallback = null;
            onCancelCallback = null;
        }

        // Interceptar fechamento de modais
        function fecharModalComVerificacao(modalId, fecharFn) {
            if (temAlteracoesNaoSalvas()) {
                mostrarConfirmacaoAlteracoes(() => {
                    fecharFn();
                });
            } else {
                fecharFn();
            }
        }

        // Interceptar navegação
        window.addEventListener('beforeunload', function(e) {
            if (temAlteracoesNaoSalvas()) {
                e.preventDefault();
                e.returnValue = 'Você tem alterações não salvas. Deseja sair?';
                return e.returnValue;
            }
        });

        // Fechar modal de confirmação ao clicar fora
        document.addEventListener('DOMContentLoaded', function() {
            const modalConfirm = document.getElementById('modal-confirmar-alteracoes');
            if (modalConfirm) {
                modalConfirm.addEventListener('click', function(e) {
                    if (e.target === this) {
                        cancelarDesprezarAlteracoes();
                    }
                });
            }
            
            // Event listeners para os botões do modal de confirmação
            const btnSim = document.getElementById('btn-confirmar-sim');
            const btnNao = document.getElementById('btn-confirmar-nao');
            
            if (btnSim) {
                btnSim.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('Botão SIM clicado');
                    confirmarDesprezarAlteracoes();
                });
            }
            
            if (btnNao) {
                btnNao.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('Botão NÃO clicado');
                    cancelarDesprezarAlteracoes();
                });
            }
        });
        
        // ========================================
        // MODAL CONFIGURAÇÃO ETAPAS KANBAN
        // ========================================
        let etapasKanban = [
            { id: 'orcamento', nome: 'Orçamento', status: 'orcamento' },
            { id: 'aprovado', nome: 'Pedido Aprovado', status: 'aprovado' },
            { id: 'analise', nome: 'Análise de Crédito', status: 'analise' },
            { id: 'faturar', nome: 'Faturar', status: 'faturar' },
            { id: 'faturado', nome: 'Faturado', status: 'faturado', destaque: true },
            { id: 'entregue', nome: 'Entregue', status: 'entregue' }
        ];

        let etapasTemp = []; // Cópia temporária para edição

        function abrirModalEtapas() {
            // Criar cópia para edição
            etapasTemp = JSON.parse(JSON.stringify(etapasKanban));
            renderizarEtapas();
            document.getElementById('modal-etapas-kanban').classList.add('active');
        }

        function renderizarEtapas() {
            const container = document.getElementById('etapas-container');
            const ordinais = ['Primeira', 'Segunda', 'Terceira', 'Quarta', 'Quinta', 'Sexta', 'Sétima', 'Oitava', 'Nona', 'Décima'];
            
            container.innerHTML = etapasTemp.map((etapa, index) => `
                <div class="etapa-item ${etapa.destaque ? 'etapa-destaque' : ''}" 
                     data-index="${index}" 
                     draggable="true"
                     ondragstart="handleEtapaDragStart(event)"
                     ondragend="handleEtapaDragEnd(event)"
                     ondragover="handleEtapaDragOver(event)"
                     ondrop="handleEtapaDrop(event)">
                    <div class="etapa-item-header">
                        <span class="etapa-item-number">
                            <i class="fas fa-grip-vertical"></i>
                            ${ordinais[index] || (index + 1) + 'ª'} Etapa
                        </span>
                        <div class="etapa-item-actions">
                            ${etapasTemp.length > 2 ? `
                                <button type="button" class="btn-remover" onclick="removerEtapa(${index})" title="Remover etapa">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            ` : ''}
                        </div>
                    </div>
                    <input type="text" 
                           value="${etapa.nome}" 
                           placeholder="Nome da etapa"
                           onchange="atualizarNomeEtapa(${index}, this.value)"
                           data-etapa-index="${index}">
                </div>
            `).join('');
            
            atualizarContadorEtapas();
        }

        function atualizarContadorEtapas() {
            const counter = document.getElementById('etapas-counter');
            const total = etapasTemp.length;
            counter.textContent = `${total} etapa${total !== 1 ? 's' : ''} configurada${total !== 1 ? 's' : ''}`;
        }

        function atualizarNomeEtapa(index, novoNome) {
            if (etapasTemp[index]) {
                etapasTemp[index].nome = novoNome.trim() || etapasTemp[index].nome;
            }
        }

        function adicionarNovaEtapa() {
            if (etapasTemp.length >= 10) {
                showNotification('Máximo de 10 etapas permitidas!', 'warning');
                return;
            }
            
            const novoId = 'etapa_' + Date.now();
            const novaEtapa = {
                id: novoId,
                nome: 'Nova Etapa',
                status: novoId,
                destaque: false
            };
            
            etapasTemp.push(novaEtapa);
            renderizarEtapas();
            
            // Focar no novo input
            setTimeout(() => {
                const inputs = document.querySelectorAll('.etapa-item input');
                const ultimoInput = inputs[inputs.length - 1];
                if (ultimoInput) {
                    ultimoInput.focus();
                    ultimoInput.select();
                }
            }, 100);
            
            showNotification('Nova etapa adicionada!', 'success');
        }

        function removerEtapa(index) {
            if (etapasTemp.length <= 2) {
                showNotification('É necessário ter pelo menos 2 etapas!', 'warning');
                return;
            }
            
            const etapa = etapasTemp[index];
            
            // Confirmar remoção
            if (confirm(`Deseja remover a etapa "${etapa.nome}"?`)) {
                etapasTemp.splice(index, 1);
                renderizarEtapas();
                showNotification('Etapa removida!', 'info');
            }
        }

        // Drag and Drop para reordenar etapas (funções separadas para não conflitar com Kanban)
        let draggedEtapa = null;
        
        function handleEtapaDragStart(e) {
            draggedEtapa = e.target.closest('.etapa-item');
            if (draggedEtapa) {
                draggedEtapa.classList.add('dragging');
                e.dataTransfer.effectAllowed = 'move';
            }
        }

        function handleEtapaDragEnd(e) {
            if (draggedEtapa) {
                draggedEtapa.classList.remove('dragging');
            }
            document.querySelectorAll('.etapa-item').forEach(item => {
                item.classList.remove('drag-over');
            });
            draggedEtapa = null;
        }

        function handleEtapaDragOver(e) {
            e.preventDefault();
            const target = e.target.closest('.etapa-item');
            if (target && target !== draggedEtapa) {
                target.classList.add('drag-over');
            }
        }

        function handleEtapaDrop(e) {
            e.preventDefault();
            const target = e.target.closest('.etapa-item');
            
            if (target && draggedEtapa && target !== draggedEtapa) {
                const fromIndex = parseInt(draggedEtapa.dataset.index);
                const toIndex = parseInt(target.dataset.index);
                
                // Reordenar array
                const [movedItem] = etapasTemp.splice(fromIndex, 1);
                etapasTemp.splice(toIndex, 0, movedItem);
                
                renderizarEtapas();
            }
            
            target?.classList.remove('drag-over');
        }

        function fecharModalEtapas() {
            document.getElementById('modal-etapas-kanban').classList.remove('active');
        }

        function confirmarEtapas() {
            // Atualizar valores dos inputs antes de salvar
            document.querySelectorAll('.etapa-item input').forEach((input, index) => {
                if (etapasTemp[index]) {
                    etapasTemp[index].nome = input.value.trim() || etapasTemp[index].nome;
                }
            });
            
            // Validar que todas as etapas têm nome
            const etapaSemNome = etapasTemp.find(e => !e.nome || e.nome.trim() === '');
            if (etapaSemNome) {
                showNotification('Todas as etapas precisam ter um nome!', 'warning');
                return;
            }
            
            // Salvar etapas
            etapasKanban = JSON.parse(JSON.stringify(etapasTemp));
            
            // Reconstruir o Kanban Board completamente
            reconstruirKanbanBoard();
            
            // Fechar modal
            fecharModalEtapas();
            
            // Notificação de sucesso
            showNotification('Etapas do processo atualizadas com sucesso!', 'success');
            
            // Salvar no localStorage para persistência
            localStorage.setItem('etapasKanban', JSON.stringify(etapasKanban));
        }

        // Cores para as colunas do Kanban (rotativas)
        const coresKanban = [
            '#94a3b8', // cinza
            '#f59e0b', // amarelo
            '#10b981', // verde claro
            '#f97316', // laranja
            '#22c55e', // verde
            '#06b6d4', // ciano
            '#8b5cf6', // roxo
            '#ec4899', // rosa
            '#ef4444', // vermelho
            '#14b8a6'  // teal
        ];

        function reconstruirKanbanBoard() {
            const kanbanBoard = document.getElementById('kanban-board');
            if (!kanbanBoard) return;
            
            // Guardar os cards existentes por status antes de reconstruir
            const cardsExistentes = {};
            document.querySelectorAll('.kanban-column').forEach(coluna => {
                const status = coluna.dataset.status;
                const content = coluna.querySelector('.kanban-column-content');
                if (content) {
                    cardsExistentes[status] = content.innerHTML;
                }
            });
            
            // Limpar o board
            kanbanBoard.innerHTML = '';
            
            // Reconstruir colunas baseado nas etapas
            etapasKanban.forEach((etapa, index) => {
                const cor = coresKanban[index % coresKanban.length];
                const isFirstColumn = index === 0;
                const hasFooter = etapa.footer || isFirstColumn;
                
                // Recuperar cards existentes ou usar vazio
                const cardsHtml = cardsExistentes[etapa.status] || '';
                const hasCards = cardsHtml && cardsHtml.trim() !== '' && !cardsHtml.includes('empty-column');
                
                const colunaHtml = `
                    <div class="kanban-column" data-status="${etapa.status}">
                        <div class="kanban-column-header">
                            <div>
                                <div class="column-title">${etapa.nome}</div>
                                <div class="column-count" id="count-${etapa.status}">${hasCards ? 'Carregando...' : 'Nenhum registro'}</div>
                            </div>
                            <div class="column-indicator" style="background: ${cor};"></div>
                        </div>
                        <div class="kanban-column-content" id="col-${etapa.status}">
                            ${cardsHtml || `
                                <div class="empty-column">
                                    <i class="fas fa-inbox"></i>
                                    <p>Nenhum registro</p>
                                </div>
                            `}
                        </div>
                        ${isFirstColumn ? `
                            <div class="kanban-column-footer">
                                <button class="btn-new-card" onclick="novoOrcamento()">
                                    <i class="fas fa-plus"></i> Novo Orçamento
                                </button>
                            </div>
                        ` : ''}
                    </div>
                `;
                
                kanbanBoard.insertAdjacentHTML('beforeend', colunaHtml);
            });
            
            // Reinicializar drag and drop para cards
            inicializarDragDropCards();
            
            // Atualizar contadores
            atualizarContadoresKanban();
        }

        function atualizarTitulosKanban() {
            // Atualizar cada coluna baseado nas etapas ou reconstruir se necessário
            const colunasAtuais = document.querySelectorAll('.kanban-column').length;
            
            if (colunasAtuais !== etapasKanban.length) {
                // Número de colunas diferente, reconstruir
                reconstruirKanbanBoard();
            } else {
                // Apenas atualizar títulos e reordenar se necessário
                const kanbanBoard = document.getElementById('kanban-board');
                const colunasEl = Array.from(document.querySelectorAll('.kanban-column'));
                
                // Verificar se precisa reordenar
                let precisaReordenar = false;
                etapasKanban.forEach((etapa, index) => {
                    if (colunasEl[index]?.dataset.status !== etapa.status) {
                        precisaReordenar = true;
                    }
                });
                
                if (precisaReordenar) {
                    reconstruirKanbanBoard();
                } else {
                    // Apenas atualizar títulos
                    etapasKanban.forEach((etapa, index) => {
                        const coluna = document.querySelector(`.kanban-column[data-status="${etapa.status}"]`);
                        if (coluna) {
                            const titulo = coluna.querySelector('.column-title');
                            if (titulo) {
                                titulo.textContent = etapa.nome;
                            }
                            // Atualizar cor do indicador
                            const indicator = coluna.querySelector('.column-indicator');
                            if (indicator) {
                                indicator.style.background = coresKanban[index % coresKanban.length];
                            }
                        }
                    });
                }
            }
        }

        function inicializarDragDropCards() {
            // Reinicializar eventos de drag/drop para os cards do kanban
            document.querySelectorAll('.kanban-column-content').forEach(content => {
                content.addEventListener('dragover', handleCardDragOver);
                content.addEventListener('dragleave', handleCardDragLeave);
                content.addEventListener('drop', handleCardDrop);
            });
            
            document.querySelectorAll('.kanban-card').forEach(card => {
                card.setAttribute('draggable', 'true');
                card.addEventListener('dragstart', handleCardDragStart);
                card.addEventListener('dragend', handleCardDragEnd);
            });
        }

        function atualizarContadoresKanban() {
            // Atualizar contagem de cards em cada coluna
            etapasKanban.forEach(etapa => {
                const content = document.getElementById(`col-${etapa.status}`);
                const counter = document.getElementById(`count-${etapa.status}`);
                if (content && counter) {
                    const cards = content.querySelectorAll('.kanban-card');
                    const total = cards.length;
                    if (total === 0) {
                        counter.textContent = 'Nenhum registro';
                    } else if (total === 1) {
                        counter.textContent = '1 registro';
                    } else {
                        counter.textContent = `${total} registros`;
                    }
                }
            });
        }

        // Funções de Drag/Drop para cards (se não existirem)
        function handleCardDragOver(e) {
            e.preventDefault();
            e.currentTarget.classList.add('drag-over');
        }

        function handleCardDragLeave(e) {
            e.currentTarget.classList.remove('drag-over');
        }

        function handleCardDrop(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('drag-over');
            // Implementar lógica de mover card entre colunas
        }

        function handleCardDragStart(e) {
            e.target.classList.add('dragging');
            e.dataTransfer.setData('text/plain', e.target.dataset.id);
        }

        function handleCardDragEnd(e) {
            e.target.classList.remove('dragging');
            document.querySelectorAll('.kanban-column-content').forEach(col => {
                col.classList.remove('drag-over');
            });
        }

        // Função para compatibilidade com código legado
        function getEtapaByStatus(status) {
            return etapasKanban.find(e => e.status === status) || null;
        }

        // Carregar etapas salvas ao iniciar
        document.addEventListener('DOMContentLoaded', function() {
            const etapasSalvas = localStorage.getItem('etapasKanban');
            if (etapasSalvas) {
                try {
                    const parsed = JSON.parse(etapasSalvas);
                    // Verificar se é o formato novo (array) ou antigo (objeto)
                    if (Array.isArray(parsed)) {
                        etapasKanban = parsed;
                    } else {
                        // Converter formato antigo para novo
                        etapasKanban = [
                            { id: 'orcamento', nome: parsed.orcamento || 'Orçamento', status: 'orcamento' },
                            { id: 'aprovado', nome: parsed.aprovado || 'Pedido Aprovado', status: 'aprovado' },
                            { id: 'analise', nome: parsed.analise || 'Análise de Crédito', status: 'analise' },
                            { id: 'faturar', nome: parsed.faturar || 'Faturar', status: 'faturar' },
                            { id: 'faturado', nome: parsed.faturado || 'Faturado', status: 'faturado', destaque: true },
                            { id: 'entregue', nome: parsed.entregue || parsed.recibo || 'Entregue', status: 'entregue' }
                        ];
                    }
                    // Reconstruir o kanban com as etapas salvas
                    reconstruirKanbanBoard();
                } catch (e) {
                    console.error('Erro ao carregar etapas salvas:', e);
                }
            }
            
            // Fechar modal ao clicar fora
            document.getElementById('modal-etapas-kanban').addEventListener('click', function(e) {
                if (e.target === this) fecharModalEtapas();
            });
            
            // Inicializar drag/drop para cards existentes
            inicializarDragDropCards();
        });
        
        // ========================================
        // MODAL FILTROS KANBAN
        // ========================================
        const filtrosState = {
            dataInclusao: 'tudo',
            dataPrevisao: 'tudo',
            dataFaturamento: 'ultimos-30',
            vendedor: 'todos',
            vendedorNome: 'Todos os Vendedores',
            projeto: 'todos',
            projetoNome: 'Todos os Projetos',
            exibirCancelados: false,
            exibirDenegados: false,
            exibirEncerrados: false
        };

        // Abrir modal de filtros
        function abrirModalFiltros() {
            document.getElementById('modal-filtros-kanban').classList.add('active');
        }

        // Fechar modal de filtros
        function fecharModalFiltros() {
            document.getElementById('modal-filtros-kanban').classList.remove('active');
        }

        // Desfazer filtros (restaurar padrões)
        function desfazerFiltros() {
            document.getElementById('filtro-data-inclusao').value = 'tudo';
            document.getElementById('filtro-data-previsao').value = 'tudo';
            document.getElementById('filtro-data-faturamento').value = 'ultimos-30';
            document.getElementById('filtro-vendedor').value = 'Todos os Vendedores';
            document.getElementById('filtro-projeto').value = 'Todos os Projetos';
            document.getElementById('toggle-cancelados').checked = false;
            document.getElementById('toggle-denegados').checked = false;
            document.getElementById('toggle-encerrados').checked = false;
            
            // Atualizar estado
            filtrosState.dataInclusao = 'tudo';
            filtrosState.dataPrevisao = 'tudo';
            filtrosState.dataFaturamento = 'ultimos-30';
            filtrosState.vendedor = 'todos';
            filtrosState.vendedorNome = 'Todos os Vendedores';
            filtrosState.projeto = 'todos';
            filtrosState.projetoNome = 'Todos os Projetos';
            filtrosState.exibirCancelados = false;
            filtrosState.exibirDenegados = false;
            filtrosState.exibirEncerrados = false;
            
            showToast('Filtros restaurados para os valores padrão', 'info');
        }

        // Aplicar filtros
        function aplicarFiltros() {
            filtrosState.dataInclusao = document.getElementById('filtro-data-inclusao').value;
            filtrosState.dataPrevisao = document.getElementById('filtro-data-previsao').value;
            filtrosState.dataFaturamento = document.getElementById('filtro-data-faturamento').value;
            filtrosState.exibirCancelados = document.getElementById('toggle-cancelados').checked;
            filtrosState.exibirDenegados = document.getElementById('toggle-denegados').checked;
            filtrosState.exibirEncerrados = document.getElementById('toggle-encerrados').checked;
            
            // Atualizar texto do link de filtro
            const filterLink = document.getElementById('filter-toggle');
            if (filterLink) {
                const filtrosAtivos = [];
                if (filtrosState.dataInclusao !== 'tudo') filtrosAtivos.push('Data Inclusão');
                if (filtrosState.dataPrevisao !== 'tudo') filtrosAtivos.push('Data Previsão');
                if (filtrosState.vendedor !== 'todos') filtrosAtivos.push('Vendedor');
                if (filtrosState.projeto !== 'todos') filtrosAtivos.push('Projeto');
                
                if (filtrosAtivos.length > 0) {
                    filterLink.textContent = `Filtrado: ${filtrosAtivos.join(', ')}`;
                    filterLink.style.color = '#f97316';
                } else {
                    filterLink.textContent = 'Exibindo tudo';
                    filterLink.style.color = '';
                }
            }
            
            fecharModalFiltros();
            showToast('Filtros aplicados com sucesso!', 'success');
            
            // Aqui você pode chamar a função para recarregar o kanban com os filtros
            // recarregarKanban(filtrosState);
        }

        // Modal Selecionar Vendedor
        function abrirModalVendedor() {
            document.getElementById('modal-selecionar-vendedor').classList.add('active');
        }

        function fecharModalVendedor() {
            document.getElementById('modal-selecionar-vendedor').classList.remove('active');
        }

        // Selecionar vendedor da lista
        function selecionarVendedor(item) {
            const vendedorId = item.dataset.id;
            const vendedorNome = item.textContent;
            
            // Atualizar estado
            filtrosState.vendedor = vendedorId;
            filtrosState.vendedorNome = vendedorNome;
            
            // Atualizar input
            document.getElementById('filtro-vendedor').value = vendedorNome;
            
            // Marcar como selecionado
            document.querySelectorAll('.vendedor-item').forEach(el => el.classList.remove('selected'));
            item.classList.add('selected');
            
            fecharModalVendedor();
        }

        // Modal Selecionar Projeto
        function abrirModalProjeto() {
            // Mesma lógica do vendedor, pode ser implementado depois
            showToast('Seleção de projetos em desenvolvimento', 'info');
        }

        // Inicializar eventos do modal de filtros
        document.addEventListener('DOMContentLoaded', function() {
            // Click no link "Exibindo tudo" para abrir modal
            const filterToggle = document.getElementById('filter-toggle');
            if (filterToggle) {
                filterToggle.addEventListener('click', function(e) {
                    e.preventDefault();
                    abrirModalFiltros();
                });
            }
            
            // Click nos vendedores da lista
            document.querySelectorAll('.vendedor-item').forEach(item => {
                item.addEventListener('click', function() {
                    selecionarVendedor(this);
                });
            });
            
            // Busca de vendedor
            const buscaVendedor = document.getElementById('busca-vendedor');
            if (buscaVendedor) {
                buscaVendedor.addEventListener('input', function() {
                    const termo = this.value.toLowerCase();
                    document.querySelectorAll('.vendedor-item').forEach(item => {
                        const nome = item.textContent.toLowerCase();
                        item.style.display = nome.includes(termo) ? 'block' : 'none';
                    });
                });
            }
            
            // Fechar modais ao clicar fora
            document.getElementById('modal-filtros-kanban').addEventListener('click', function(e) {
                if (e.target === this) fecharModalFiltros();
            });
            
            document.getElementById('modal-selecionar-vendedor').addEventListener('click', function(e) {
                if (e.target === this) fecharModalVendedor();
            });
        });
        
        // ========================================
        // MODAL EMAILS ENVIADOS
        // ========================================
        let emailsPedido = {};

        function verEmailsEnviados() {
            if (!pedidoAtual) return;
            
            // Carregar emails do pedido (simular dados)
            if (!emailsPedido[pedidoAtual.id]) {
                emailsPedido[pedidoAtual.id] = [
                    {
                        destinatario: 'cliente@empresa.com',
                        assunto: `Orçamento Nº ${pedidoAtual.id} - Aluforce`,
                        data: '15/12/2025 14:30',
                        status: 'lido'
                    }
                ];
            }
            
            renderizarEmails(emailsPedido[pedidoAtual.id]);
            document.getElementById('modal-emails').classList.add('active');
        }

        function fecharModalEmails() {
            document.getElementById('modal-emails').classList.remove('active');
        }

        function renderizarEmails(emails) {
            const container = document.getElementById('emails-lista');
            
            if (emails.length === 0) {
                container.innerHTML = '<p style="color: #888; font-size: 13px; text-align: center; padding: 20px;">Nenhum email enviado para este pedido.</p>';
                return;
            }
            
            container.innerHTML = emails.map(email => `
                <div class="email-item">
                    <div class="email-header">
                        <span class="email-destinatario"><i class="fas fa-user"></i> ${email.destinatario}</span>
                        <span class="email-data">${email.data}</span>
                    </div>
                    <div class="email-assunto">${email.assunto}</div>
                    <span class="email-status ${email.status}">
                        <i class="fas ${email.status === 'lido' ? 'fa-check-double' : 'fa-check'}"></i>
                        ${email.status === 'lido' ? 'Lido' : 'Enviado'}
                    </span>
                </div>
            `).join('');
        }

        function abrirEnviarEmail() {
            fecharModalEmails();
            // Ir para a aba de email no modal principal
            switchModalTab('email');
        }
        
        // ========================================
        // MODAL HISTÓRICO
        // ========================================
        // MODAL HISTÓRICO - PROFISSIONAL
        // ========================================
        async function verHistorico() {
            if (!pedidoAtual) return;
            
            const container = document.getElementById('historico-timeline');
            container.innerHTML = '<div class="historico-empty"><i class="fas fa-spinner fa-spin"></i><p>Carregando histórico...</p></div>';
            document.getElementById('modal-historico').classList.add('active');
            
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`/api/vendas/pedidos/${pedidoAtual.id}/historico`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    const historico = await response.json();
                    renderizarHistoricoPro(historico);
                } else {
                    // Se não tiver histórico na API, mostrar histórico simulado
                    renderizarHistoricoSimulado();
                }
            } catch (error) {
                console.error('Erro ao carregar histórico:', error);
                renderizarHistoricoSimulado();
            }
        }

        function fecharModalHistorico() {
            document.getElementById('modal-historico').classList.remove('active');
        }

        function renderizarHistoricoPro(historico) {
            const container = document.getElementById('historico-timeline');
            
            if (!historico || historico.length === 0) {
                container.innerHTML = `
                    <div class="historico-empty">
                        <i class="fas fa-clock"></i>
                        <p>Nenhum histórico registrado para este pedido.</p>
                    </div>
                `;
                return;
            }
            
            // Ordenar por data (mais recente primeiro)
            const historicoOrdenado = [...historico].sort((a, b) => 
                new Date(b.created_at) - new Date(a.created_at)
            );
            
            container.innerHTML = historicoOrdenado.map(item => {
                const data = new Date(item.created_at);
                const dataFormatada = data.toLocaleDateString('pt-BR') + ' às ' + data.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                const tipoClasse = getTipoClasse(item.action);
                const badge = getBadgeHtml(item.action);
                
                return `
                    <div class="historico-item-pro tipo-${tipoClasse}">
                        <div class="historico-header-pro">
                            ${badge}
                            <span class="historico-data-pro">${dataFormatada}</span>
                        </div>
                        <div class="historico-descricao-pro">${item.descricao || item.action}</div>
                        <div class="historico-usuario-pro">
                            <i class="fas fa-user-circle"></i>
                            ${item.user_name || 'Sistema'}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderizarHistoricoSimulado() {
            const historico = [
                {
                    created_at: new Date().toISOString(),
                    user_name: localStorage.getItem('userName') || 'Usuário',
                    action: 'criacao',
                    descricao: 'Pedido criado no sistema'
                }
            ];
            
            // Adicionar evento de status se existir
            if (pedidoAtual.status) {
                historico.push({
                    created_at: new Date(Date.now() - 3600000).toISOString(),
                    user_name: 'Sistema',
                    action: 'status',
                    descricao: `Status atual: ${pedidoAtual.status}`
                });
            }
            
            renderizarHistoricoPro(historico);
        }

        function getTipoClasse(action) {
            const tipos = {
                'faturamento': 'faturamento',
                'faturar': 'faturamento',
                'status': 'status',
                'status_alterado': 'status',
                'edicao': 'edicao',
                'item_added': 'edicao',
                'item_updated': 'edicao',
                'item_deleted': 'edicao',
                'criacao': 'criacao',
                'pedido_criado': 'criacao'
            };
            return tipos[action] || 'edicao';
        }

        function getBadgeHtml(action) {
            const badges = {
                'faturamento': '<span class="historico-badge badge-faturamento"><i class="fas fa-check-circle"></i> Faturamento</span>',
                'faturar': '<span class="historico-badge badge-faturamento"><i class="fas fa-check-circle"></i> Faturamento</span>',
                'status': '<span class="historico-badge badge-status"><i class="fas fa-exchange-alt"></i> Etapa</span>',
                'status_alterado': '<span class="historico-badge badge-status"><i class="fas fa-exchange-alt"></i> Etapa</span>',
                'edicao': '<span class="historico-badge badge-edicao"><i class="fas fa-edit"></i> Edição</span>',
                'item_added': '<span class="historico-badge badge-item"><i class="fas fa-plus"></i> Item</span>',
                'item_updated': '<span class="historico-badge badge-item"><i class="fas fa-edit"></i> Item</span>',
                'item_deleted': '<span class="historico-badge badge-item"><i class="fas fa-trash"></i> Item</span>',
                'criacao': '<span class="historico-badge badge-criacao"><i class="fas fa-file-alt"></i> Criação</span>',
                'pedido_criado': '<span class="historico-badge badge-criacao"><i class="fas fa-file-alt"></i> Criação</span>'
            };
            return badges[action] || '<span class="historico-badge badge-edicao"><i class="fas fa-info"></i> Alteração</span>';
        }

        // Registrar histórico localmente (quando API não disponível)
        async function registrarHistoricoLocal(action, descricao) {
            if (!pedidoAtual) return;
            
            try {
                const token = localStorage.getItem('token');
                await fetch(`/api/vendas/pedidos/${pedidoAtual.id}/historico`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ action, descricao })
                });
            } catch (error) {
                console.warn('Erro ao registrar histórico:', error);
            }
        }
        
        // ========================================
        // MODAL TAREFAS
        // ========================================
        let tarefasPedido = {};

        function verTarefas() {
            if (!pedidoAtual) return;
            
            // Carregar tarefas do pedido
            if (!tarefasPedido[pedidoAtual.id]) {
                tarefasPedido[pedidoAtual.id] = [
                    { id: 1, texto: 'Confirmar pagamento com cliente', concluida: true },
                    { id: 2, texto: 'Aguardar aprovação de crédito', concluida: false },
                    { id: 3, texto: 'Enviar documentação fiscal', concluida: false }
                ];
            }
            
            renderizarTarefas(tarefasPedido[pedidoAtual.id]);
            document.getElementById('modal-tarefas').classList.add('active');
        }

        function fecharModalTarefas() {
            document.getElementById('modal-tarefas').classList.remove('active');
        }

        function renderizarTarefas(tarefas) {
            const container = document.getElementById('tarefas-lista');
            
            if (tarefas.length === 0) {
                container.innerHTML = '<p style="color: #888; font-size: 13px; text-align: center; padding: 20px;">Nenhuma tarefa cadastrada.</p>';
                return;
            }
            
            container.innerHTML = tarefas.map((tarefa, idx) => `
                <div class="tarefa-item ${tarefa.concluida ? 'concluida' : ''}">
                    <input type="checkbox" class="tarefa-checkbox" ${tarefa.concluida ? 'checked' : ''} onchange="toggleTarefa(${idx})">
                    <span class="tarefa-texto">${tarefa.texto}</span>
                    <button class="tarefa-delete" onclick="excluirTarefa(${idx})"><i class="fas fa-trash"></i></button>
                </div>
            `).join('');
        }

        function adicionarTarefa() {
            if (!pedidoAtual) return;
            
            const input = document.getElementById('input-nova-tarefa');
            const texto = input.value.trim();
            
            if (!texto) {
                showNotification('Digite a descrição da tarefa', 'warning');
                return;
            }
            
            if (!tarefasPedido[pedidoAtual.id]) {
                tarefasPedido[pedidoAtual.id] = [];
            }
            
            tarefasPedido[pedidoAtual.id].push({
                id: Date.now(),
                texto: texto,
                concluida: false
            });
            
            input.value = '';
            renderizarTarefas(tarefasPedido[pedidoAtual.id]);
            showNotification('Tarefa adicionada!', 'success');
        }

        function toggleTarefa(idx) {
            if (!pedidoAtual) return;
            tarefasPedido[pedidoAtual.id][idx].concluida = !tarefasPedido[pedidoAtual.id][idx].concluida;
            renderizarTarefas(tarefasPedido[pedidoAtual.id]);
        }

        function excluirTarefa(idx) {
            if (!pedidoAtual) return;
            tarefasPedido[pedidoAtual.id].splice(idx, 1);
            renderizarTarefas(tarefasPedido[pedidoAtual.id]);
            showNotification('Tarefa removida!', 'success');
        }
        
        // ========================================
        // MODAL PEDIDO PARCIAL
        // ========================================
        function pedidoParcial() {
            if (!pedidoAtual) return;
            
            // Mostrar itens do pedido para seleção parcial
            const container = document.getElementById('itens-parcial-lista');
            
            // Simular itens do pedido
            const itens = [
                { codigo: 'ITEM001', nome: pedidoAtual.cliente + ' - Produto 1', qtd: 5, qtdDisp: 5 },
                { codigo: 'ITEM002', nome: pedidoAtual.cliente + ' - Produto 2', qtd: 3, qtdDisp: 3 }
            ];
            
            container.innerHTML = itens.map((item, idx) => `
                <div class="item-parcial">
                    <input type="checkbox" class="item-parcial-checkbox" id="item-parcial-${idx}" checked>
                    <div class="item-parcial-info">
                        <div class="item-parcial-nome">${item.codigo} - ${item.nome}</div>
                        <div class="item-parcial-qtd-original">Qtd Original: ${item.qtd} | Disponível: ${item.qtdDisp}</div>
                    </div>
                    <input type="number" class="item-parcial-qtd-input" value="${item.qtdDisp}" min="0" max="${item.qtdDisp}">
                </div>
            `).join('');
            
            document.getElementById('modal-pedido-parcial').classList.add('active');
        }

        function fecharModalPedidoParcial() {
            document.getElementById('modal-pedido-parcial').classList.remove('active');
        }

        function gerarPedidoParcial() {
            showNotification('Pedido parcial gerado com sucesso!', 'success');
            fecharModalPedidoParcial();
        }
        
        async function cancelarPedido() {
            if (!pedidoAtual) return;
            
            const confirmar = confirm(`Tem certeza que deseja cancelar o Orçamento Nº ${pedidoAtual.id}?\n\nO pedido será marcado como cancelado.`);
            if (!confirmar) return;
            
            try {
                const token = localStorage.getItem('token');
                
                // Atualizar status no backend
                const response = await fetch(`/api/vendas/pedidos/${pedidoAtual.id}`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        status: 'cancelado'
                    })
                });
                
                if (!response.ok) {
                    const err = await response.json().catch(() => ({}));
                    throw new Error(err.message || 'Erro ao cancelar pedido');
                }
                
                // Atualizar status localmente
                pedidoAtual.status = 'Cancelado';
                pedidoAtual.statusAnterior = pedidoAtual.status;
                
                // Re-renderizar kanban
                renderKanban();
                
                // Fechar modal
                fecharModalEditar();
                showNotification(`Orçamento Nº ${pedidoAtual.id} cancelado!`, 'warning');
            } catch (error) {
                console.error('Erro ao cancelar pedido:', error);
                showNotification('Erro ao cancelar pedido: ' + error.message, 'error');
            }
        }

        // Função Incluir (Criar novo pedido a partir do modal)
        function incluirPedido() {
            // Abrir modal de novo orçamento
            novoOrcamento();
        }
        
        function adicionarItem() {
        // ========================================
        // CRUD ITENS DO PEDIDO
        // ========================================
        let itensPedidoAtual = [];
        let itemSelecionado = null;
        let itemSelecionadoIdx = null;
        let modoEdicaoItem = false;

        // Carregar itens do pedido da API
        async function carregarItensPedido(pedidoId) {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`/api/vendas/pedidos/${pedidoId}/itens`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (response.ok) {
                    itensPedidoAtual = await response.json();
                } else {
                    itensPedidoAtual = [];
                }
            } catch (error) {
                console.error('Erro ao carregar itens:', error);
                itensPedidoAtual = [];
            }
            renderizarTabelaItens();
        }

        // Renderizar tabela de itens
        function renderizarTabelaItens() {
            const tbody = document.getElementById('itens-pedido-tbody');
            const paginationInfo = document.getElementById('pagination-info');
            
            if (!tbody) return;
            
            if (itensPedidoAtual.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; color: #888; padding: 40px;">
                            <i class="fas fa-box-open" style="font-size: 32px; margin-bottom: 10px; display: block;"></i>
                            Nenhum item adicionado. Clique em "Novo Item" para adicionar.
                        </td>
                    </tr>
                `;
                paginationInfo.textContent = '0 registros';
                return;
            }
            
            tbody.innerHTML = itensPedidoAtual.map((item, idx) => `
                <tr data-index="${idx}" data-id="${item.id}" onclick="selecionarItemTabela(${idx})" ondblclick="editarItemPorIndice(${idx})">
                    <td class="produto-code">${item.codigo || ''}</td>
                    <td class="produto-desc">${item.descricao || ''}</td>
                    <td>${formatarQuantidade(item.quantidade)} ${item.unidade || 'UN'}</td>
                    <td>${formatarQuantidade(item.quantidade_parcial)} ${item.unidade || 'UN'}</td>
                    <td>${item.local_estoque || 'PADRAO'}</td>
                    <td>${formatarMoeda(item.preco_unitario)}</td>
                </tr>
            `).join('');
            
            paginationInfo.textContent = `1 - ${itensPedidoAtual.length} de ${itensPedidoAtual.length} registros`;
        }

        function formatarQuantidade(valor) {
            return parseFloat(valor || 0).toLocaleString('pt-BR', { minimumFractionDigits: 0, maximumFractionDigits: 3 });
        }

        // Selecionar item na tabela
        function selecionarItemTabela(idx) {
            // Remover seleção anterior
            document.querySelectorAll('#itens-pedido-tbody tr').forEach(tr => tr.classList.remove('selected'));
            
            // Adicionar seleção
            const tr = document.querySelector(`#itens-pedido-tbody tr[data-index="${idx}"]`);
            if (tr) {
                tr.classList.add('selected');
                itemSelecionadoIdx = idx;
                itemSelecionado = itensPedidoAtual[idx];
            }
        }

        // Adicionar novo item
        function adicionarItem() {
            if (!pedidoAtual) {
                showNotification('Nenhum pedido selecionado', 'error');
                return;
            }
            
            modoEdicaoItem = false;
            itemSelecionado = null;
            
            // Limpar campos
            document.getElementById('item-pedido-id').value = '';
            document.getElementById('item-pedido-codigo').value = '';
            document.getElementById('item-pedido-descricao').value = '';
            document.getElementById('item-pedido-quantidade').value = '1';
            document.getElementById('item-pedido-qtd-parcial').value = '0';
            document.getElementById('item-pedido-preco').value = '';
            document.getElementById('item-pedido-desconto').value = '0,00';
            document.getElementById('item-pedido-unidade').value = 'UN';
            document.getElementById('item-pedido-estoque').value = 'PADRAO - Local de Estoque Padrão';
            
            document.getElementById('modal-item-titulo').innerHTML = '<i class="fas fa-plus-circle"></i> Novo Item';
            document.getElementById('modal-item-pedido').classList.add('active');
        }

        // Editar item selecionado
        function editarItemSelecionado() {
            if (itemSelecionadoIdx === null || !itemSelecionado) {
                showNotification('Selecione um item na tabela para editar', 'info');
                return;
            }
            editarItemPorIndice(itemSelecionadoIdx);
        }

        // Editar item por índice (duplo clique)
        function editarItemPorIndice(idx) {
            const item = itensPedidoAtual[idx];
            if (!item) return;
            
            modoEdicaoItem = true;
            itemSelecionado = item;
            
            // Preencher campos
            document.getElementById('item-pedido-id').value = item.id;
            document.getElementById('item-pedido-codigo').value = item.codigo || '';
            document.getElementById('item-pedido-descricao').value = item.descricao || '';
            document.getElementById('item-pedido-quantidade').value = item.quantidade || 1;
            document.getElementById('item-pedido-qtd-parcial').value = item.quantidade_parcial || 0;
            document.getElementById('item-pedido-preco').value = formatarDecimal(item.preco_unitario);
            document.getElementById('item-pedido-desconto').value = formatarDecimal(item.desconto || 0);
            document.getElementById('item-pedido-unidade').value = item.unidade || 'UN';
            document.getElementById('item-pedido-estoque').value = item.local_estoque || 'PADRAO - Local de Estoque Padrão';
            
            document.getElementById('modal-item-titulo').innerHTML = '<i class="fas fa-edit"></i> Editar Item';
            document.getElementById('modal-item-pedido').classList.add('active');
        }

        function formatarDecimal(valor) {
            return parseFloat(valor || 0).toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        function parseDecimal(str) {
            if (!str) return 0;
            return parseFloat(str.replace(/\./g, '').replace(',', '.')) || 0;
        }

        // Fechar modal de item
        function fecharModalItemPedido() {
            document.getElementById('modal-item-pedido').classList.remove('active');
        }

        // Salvar item (criar ou atualizar)
        async function salvarItemPedido() {
            const codigo = document.getElementById('item-pedido-codigo').value.trim();
            const descricao = document.getElementById('item-pedido-descricao').value.trim();
            const quantidade = parseFloat(document.getElementById('item-pedido-quantidade').value) || 1;
            const quantidadeParcial = parseFloat(document.getElementById('item-pedido-qtd-parcial').value) || 0;
            const precoUnitario = parseDecimal(document.getElementById('item-pedido-preco').value);
            const desconto = parseDecimal(document.getElementById('item-pedido-desconto').value);
            const unidade = document.getElementById('item-pedido-unidade').value;
            const localEstoque = document.getElementById('item-pedido-estoque').value;
            
            if (!codigo) {
                showNotification('O código do produto é obrigatório', 'warning');
                return;
            }
            
            if (!descricao) {
                showNotification('A descrição do produto é obrigatória', 'warning');
                return;
            }
            
            const token = localStorage.getItem('token');
            const itemData = {
                codigo,
                descricao,
                quantidade,
                quantidade_parcial: quantidadeParcial,
                preco_unitario: precoUnitario,
                desconto,
                unidade,
                local_estoque: localEstoque
            };
            
            try {
                let response;
                if (modoEdicaoItem && itemSelecionado) {
                    // Atualizar item existente
                    response = await fetch(`/api/vendas/pedidos/${pedidoAtual.id}/itens/${itemSelecionado.id}`, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(itemData)
                    });
                } else {
                    // Criar novo item
                    response = await fetch(`/api/vendas/pedidos/${pedidoAtual.id}/itens`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(itemData)
                    });
                }
                
                if (response.ok) {
                    showNotification(modoEdicaoItem ? 'Item atualizado com sucesso!' : 'Item adicionado com sucesso!', 'success');
                    fecharModalItemPedido();
                    // Recarregar itens
                    await carregarItensPedido(pedidoAtual.id);
                    // Atualizar total no modal
                    atualizarTotalModalEditar();
                } else {
                    // Tratar erros de autenticação
                    if (response.status === 401 || response.status === 403) {
                        const errorText = await response.text();
                        try {
                            const errorJson = JSON.parse(errorText);
                            showNotification(errorJson.message || 'Erro de autenticação. Faça login novamente.', 'error');
                        } catch {
                            showNotification('Sessão expirada. Faça login novamente.', 'error');
                        }
                        if (response.status === 401) {
                            setTimeout(() => { window.location.href = '/login.html'; }, 2000);
                        }
                        return;
                    }
                    const error = await response.json();
                    showNotification(error.message || 'Erro ao salvar item', 'error');
                }
            } catch (error) {
                console.error('Erro ao salvar item:', error);
                showNotification('Erro de conexão ao salvar item', 'error');
            }
        }

        // Excluir item selecionado
        async function excluirItemSelecionado() {
            if (itemSelecionadoIdx === null || !itemSelecionado) {
                showNotification('Selecione um item na tabela para excluir', 'warning');
                return;
            }
            
            const confirmar = confirm(`Deseja realmente excluir o item "${itemSelecionado.codigo}"?\n\nEsta ação não pode ser desfeita.`);
            if (!confirmar) return;
            
            const token = localStorage.getItem('token');
            
            try {
                const response = await fetch(`/api/vendas/pedidos/${pedidoAtual.id}/itens/${itemSelecionado.id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok || response.status === 204) {
                    showNotification('Item excluído com sucesso!', 'success');
                    itemSelecionado = null;
                    itemSelecionadoIdx = null;
                    // Recarregar itens
                    await carregarItensPedido(pedidoAtual.id);
                    // Atualizar total no modal
                    atualizarTotalModalEditar();
                } else {
                    const error = await response.json();
                    showNotification(error.message || 'Erro ao excluir item', 'error');
                }
            } catch (error) {
                console.error('Erro ao excluir item:', error);
                showNotification('Erro de conexão ao excluir item', 'error');
            }
        }

        // Atualizar totais no modal de editar
        function atualizarTotalModalEditar() {
            const totalItens = itensPedidoAtual.reduce((sum, item) => {
                return sum + ((parseFloat(item.quantidade) || 0) * (parseFloat(item.preco_unitario) || 0) - (parseFloat(item.desconto) || 0));
            }, 0);
            
            const valorTotalInput = document.getElementById('edit-valor-total');
            const totalMercadoriasInput = document.getElementById('edit-total-mercadorias');
            
            if (valorTotalInput) valorTotalInput.value = formatarMoeda(totalItens);
            if (totalMercadoriasInput) totalMercadoriasInput.value = formatarMoeda(totalItens);
            
            // Atualizar o valor no pedidoAtual
            if (pedidoAtual) {
                pedidoAtual.valor = totalItens;
            }
        }

        // Fechar modal de item ao clicar fora
        document.addEventListener('DOMContentLoaded', function() {
            const modalItemPedido = document.getElementById('modal-item-pedido');
            if (modalItemPedido) {
                modalItemPedido.addEventListener('click', function(e) {
                    if (e.target === this) fecharModalItemPedido();
                });
            }
        });
        
        function excluirPedido() {
            if (!pedidoAtual) {
                showNotification('Nenhum pedido selecionado', 'error');
                return;
            }
            
            const confirmar = confirm(`Tem certeza que deseja excluir o Orçamento Nº ${pedidoAtual.id}?\n\nEsta ação não pode ser desfeita.`);
            if (!confirmar) return;
            
            // Remover da lista
            const coluna = pedidoAtual._coluna;
            const idx = dadosVendas[coluna].findIndex(p => p.id === pedidoAtual.id);
            if (idx !== -1) {
                dadosVendas[coluna].splice(idx, 1);
            }
            
            // Re-renderizar kanban
            renderKanban();
            
            // Fechar modal e notificar
            fecharModalEditar();
            showNotification('Pedido excluído com sucesso!', 'success');
            
            // TODO: Excluir no backend via API
            // excluirPedidoAPI(pedidoAtual.id);
        }
        
        // Fechar modal ao clicar fora
        document.getElementById('modal-editar-pedido').addEventListener('click', function(e) {
            if (e.target === this) {
                fecharModalEditar();
            }
        });
        
        // Fechar modal com ESC
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                fecharModalEditar();
            }
        });

        // ========================================
        // AÇÕES - NOVO ORÇAMENTO (MODAL PROFISSIONAL)
        // ========================================
        
        // Dados temporários dos itens do orçamento
        let itensOrcamento = [];
        
        function novoOrcamento() {
            // Limpar alterações anteriores
            limparAlteracoes();
            
            // Limpar dados
            itensOrcamento = [];
            
            // Limpar campos do formulário
            document.getElementById('novo-cliente').value = '';
            document.getElementById('novo-previsao-faturamento').value = new Date().toISOString().split('T')[0];
            document.getElementById('novo-total-mercadorias').value = '0,00';
            document.getElementById('novo-desconto').value = '0,00';
            document.getElementById('novo-total-ipi').value = '0,00';
            document.getElementById('novo-total-icms').value = '0,00';
            document.getElementById('novo-valor-total').value = '0,00';
            document.getElementById('novo-vendedor').value = '';
            document.getElementById('novo-parcelas').value = 'a_vista';
            document.getElementById('novo-cenario-fiscal').value = '';
            document.getElementById('novo-observacoes').value = '';
            
            // Limpar tabela de itens
            renderTabelaItens();
            
            // Ativar primeira aba
            ativarAbaOrcamento('itens');
            
            // Abrir modal
            document.getElementById('modal-novo-orcamento').classList.add('active');
            
            // Rastrear alterações após um pequeno delay
            setTimeout(() => {
                const form = document.getElementById('modal-novo-orcamento');
                const inputs = form.querySelectorAll('input, select, textarea');
                formOriginalData['modal-novo-orcamento'] = {};
                inputs.forEach(input => {
                    const name = input.name || input.id;
                    if (name) {
                        formOriginalData['modal-novo-orcamento'][name] = input.type === 'checkbox' ? input.checked : input.value;
                        input.addEventListener('change', () => marcarAlteracao('modal-novo-orcamento', input));
                        input.addEventListener('input', () => marcarAlteracao('modal-novo-orcamento', input));
                    }
                });
            }, 100);
        }
        
        function fecharModalNovoOrcamento() {
            if (temAlteracoesNaoSalvas()) {
                mostrarConfirmacaoAlteracoes(() => {
                    document.getElementById('modal-novo-orcamento').classList.remove('active');
                });
            } else {
                document.getElementById('modal-novo-orcamento').classList.remove('active');
            }
        }
        
        // Sistema de Abas do Orçamento
        function ativarAbaOrcamento(tabId) {
            // Desativar todas as abas
            document.querySelectorAll('.orcamento-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.orcamento-tab-content').forEach(content => content.classList.remove('active'));
            
            // Ativar aba selecionada
            document.querySelector(`.orcamento-tab[data-tab="${tabId}"]`).classList.add('active');
            document.getElementById(`tab-${tabId}`).classList.add('active');
        }
        
        // Inicializar eventos das abas
        document.querySelectorAll('.orcamento-tab').forEach(tab => {
            tab.addEventListener('click', function() {
                ativarAbaOrcamento(this.dataset.tab);
            });
        });
        
        // Renderizar tabela de itens
        function renderTabelaItens() {
            const tbody = document.getElementById('tbody-itens-orcamento');
            const emptyState = document.getElementById('empty-itens');
            const paginacao = document.querySelector('.paginacao-info');
            
            if (itensOrcamento.length === 0) {
                tbody.innerHTML = '';
                emptyState.style.display = 'flex';
                paginacao.textContent = 'Nenhum registro encontrado';
            } else {
                emptyState.style.display = 'none';
                paginacao.textContent = `1 a ${itensOrcamento.length} de ${itensOrcamento.length} registros`;
                
                tbody.innerHTML = itensOrcamento.map((item, idx) => `
                    <tr data-index="${idx}" onclick="selecionarItemOrcamento(${idx})">
                        <td class="produto-code">${item.codigo}</td>
                        <td class="produto-desc">${item.descricao}</td>
                        <td>${item.quantidade}</td>
                        <td>${item.qtdPendente || item.quantidade}</td>
                        <td>${item.localEstoque}</td>
                        <td>R$ ${item.precoUnitario.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</td>
                        <td>R$ ${(item.quantidade * item.precoUnitario).toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</td>
                    </tr>
                `).join('');
            }
            
            calcularTotaisOrcamento();
        }
        
        function selecionarItemOrcamento(idx) {
            document.querySelectorAll('.orcamento-tabela tbody tr').forEach(tr => tr.classList.remove('selected'));
            const row = document.querySelector(`.orcamento-tabela tbody tr[data-index="${idx}"]`);
            if (row) row.classList.add('selected');
        }
        
        // Calcular totais
        function calcularTotaisOrcamento() {
            const totalMercadorias = itensOrcamento.reduce((sum, item) => sum + (item.quantidade * item.precoUnitario), 0);
            const desconto = parseFloat(document.getElementById('novo-desconto').value.replace(',', '.')) || 0;
            const totalIpi = totalMercadorias * 0.05; // Exemplo: 5% de IPI
            const totalIcms = 0; // ICMS ST zerado por padrão
            const valorTotal = totalMercadorias - desconto + totalIpi + totalIcms;
            
            document.getElementById('novo-total-mercadorias').value = totalMercadorias.toLocaleString('pt-BR', { minimumFractionDigits: 2 });
            document.getElementById('novo-total-ipi').value = totalIpi.toLocaleString('pt-BR', { minimumFractionDigits: 2 });
            document.getElementById('novo-total-icms').value = totalIcms.toLocaleString('pt-BR', { minimumFractionDigits: 2 });
            document.getElementById('novo-valor-total').value = valorTotal.toLocaleString('pt-BR', { minimumFractionDigits: 2 });
        }
        
        // Modal Adicionar Item
        function adicionarItemOrcamento() {
            document.getElementById('item-produto').value = '';
            document.getElementById('item-quantidade').value = 1;
            document.getElementById('item-preco').value = '';
            document.getElementById('item-estoque').value = 'principal';
            document.getElementById('modal-adicionar-item').classList.add('active');
        }
        
        function fecharModalAdicionarItem() {
            document.getElementById('modal-adicionar-item').classList.remove('active');
        }
        
        function confirmarAdicionarItem() {
            const produto = document.getElementById('item-produto').value.trim();
            const quantidade = parseInt(document.getElementById('item-quantidade').value) || 1;
            const preco = parseFloat(document.getElementById('item-preco').value.replace(',', '.')) || 0;
            const estoque = document.getElementById('item-estoque').value;
            
            if (!produto) {
                showNotification('Por favor, informe o produto.', 'warning');
                return;
            }
            if (preco <= 0) {
                showNotification('Por favor, informe um preço válido.', 'warning');
                return;
            }
            
            const estoqueLabels = {
                'principal': 'Estoque Principal',
                'secundario': 'Estoque Secundário',
                'expedição': 'Expedição'
            };
            
            // Gerar código de produto
            const codigo = 'PROD' + String(Math.floor(Math.random() * 9000) + 1000);
            
            itensOrcamento.push({
                codigo: codigo,
                descricao: produto,
                quantidade: quantidade,
                qtdPendente: quantidade,
                localEstoque: estoqueLabels[estoque] || estoque,
                precoUnitario: preco
            });
            
            renderTabelaItens();
            fecharModalAdicionarItem();
            showNotification('Item adicionado ao orçamento!', 'success');
        }
        
        // Evento desconto
        document.getElementById('novo-desconto').addEventListener('input', calcularTotaisOrcamento);
        
        // Salvar Orçamento
        function salvarNovoOrcamento() {
            const cliente = document.getElementById('novo-cliente').value.trim();
            const valorTotal = parseFloat(document.getElementById('novo-valor-total').value.replace('.', '').replace(',', '.')) || 0;
            const parcelas = document.getElementById('novo-parcelas').value;
            const vendedor = document.getElementById('novo-vendedor').value.trim();
            const transportadora = document.getElementById('novo-transportadora')?.value?.trim() || '';
            const observacoes = document.getElementById('novo-observacoes').value.trim();
            
            // Validação
            if (!cliente) {
                showNotification('Por favor, informe o nome do cliente.', 'warning');
                return;
            }
            if (itensOrcamento.length === 0) {
                showNotification('Adicione pelo menos um item ao orçamento.', 'warning');
                ativarAbaOrcamento('itens');
                return;
            }
            
            // Mapear parcelas
            const parcelasMap = {
                'a_vista': 'À Vista',
                '30': '30 dias',
                '30_60': '30/60 dias',
                '30_60_90': '30/60/90 dias',
                'personalizado': 'Personalizado'
            };
            
            // Gerar novo ID
            const novoId = Math.max(...Object.values(dadosVendas).flat().map(p => p.id || 0), 0) + 1;
            
            // Criar novo orçamento
            const novoOrc = {
                id: novoId,
                cliente: cliente.toUpperCase(),
                status: 'Aguardando aprovação',
                valor: valorTotal,
                parcelas: parcelasMap[parcelas] || parcelas,
                origem: 'Sistema',
                vendedor: vendedor,
                transportadora: transportadora || null,
                mensagem: observacoes || null,
                itens: [...itensOrcamento]
            };
            
            // Adicionar na coluna de orçamento
            dadosVendas.orcamento.unshift(novoOrc);
            
            // Re-renderizar kanban
            renderKanban();
            
            // Fechar modal e notificar
            fecharModalNovoOrcamento();
            showNotification(`Orçamento Nº ${novoId} criado com sucesso!`, 'success');
            
            // TODO: Salvar no backend via API
            // salvarOrcamentoAPI(novoOrc);
        }
        
        // Eventos do modal novo orçamento
        document.getElementById('modal-novo-orcamento').addEventListener('click', function(e) {
            if (e.target === this) fecharModalNovoOrcamento();
        });
        
        // Eventos do modal adicionar item
        document.getElementById('modal-adicionar-item').addEventListener('click', function(e) {
            if (e.target === this) fecharModalAdicionarItem();
        });

        // ========================================
        // FUNÇÕES DA ABA PARCELAS
        // ========================================
        function atualizarParcelas() {
            const forma = document.getElementById('novo-forma-pagamento').value;
            const selectParcelas = document.getElementById('novo-qtd-parcelas');
            
            // Se for à vista (dinheiro, PIX, débito), limitar a 1 parcela
            if (['dinheiro', 'pix', 'cartao_debito'].includes(forma)) {
                selectParcelas.value = '1';
                selectParcelas.disabled = true;
            } else {
                selectParcelas.disabled = false;
            }
            
            gerarTabelaParcelas();
        }
        
        function gerarTabelaParcelas() {
            const qtdParcelas = parseInt(document.getElementById('novo-qtd-parcelas').value) || 1;
            const forma = document.getElementById('novo-forma-pagamento').value;
            const intervalo = parseInt(document.getElementById('novo-intervalo-parcelas').value) || 30;
            const primeiroVencimento = document.getElementById('novo-primeiro-vencimento').value;
            const valorTotal = parseFloat(document.getElementById('novo-valor-total').value.replace('.', '').replace(',', '.')) || 0;
            
            const tbody = document.getElementById('tbody-parcelas');
            const valorParcela = valorTotal / qtdParcelas;
            
            const formaLabels = {
                'dinheiro': 'Dinheiro',
                'pix': 'PIX',
                'cartao_credito': 'Cartão Crédito',
                'cartao_debito': 'Cartão Débito',
                'boleto': 'Boleto',
                'transferencia': 'Transferência',
                'cheque': 'Cheque',
                'crediario': 'Crediário'
            };
            
            let html = '';
            let dataBase = primeiroVencimento ? new Date(primeiroVencimento + 'T00:00:00') : new Date();
            
            for (let i = 1; i <= qtdParcelas; i++) {
                const dataVencimento = new Date(dataBase);
                dataVencimento.setDate(dataBase.getDate() + (intervalo * (i - 1)));
                
                const dataFormatada = dataVencimento.toLocaleDateString('pt-BR');
                
                html += `
                    <tr>
                        <td>${i}/${qtdParcelas}</td>
                        <td>${dataFormatada}</td>
                        <td>R$ ${valorParcela.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</td>
                        <td>${formaLabels[forma] || '-'}</td>
                        <td><span class="status-badge pendente">Pendente</span></td>
                    </tr>
                `;
            }
            
            tbody.innerHTML = html || '<tr><td colspan="5" style="text-align: center; color: #999;">Nenhuma parcela</td></tr>';
        }
        
        // Inicializar data do primeiro vencimento
        document.addEventListener('DOMContentLoaded', function() {
            const hoje = new Date();
            hoje.setDate(hoje.getDate() + 30); // 30 dias a partir de hoje
            const primeiroVenc = document.getElementById('novo-primeiro-vencimento');
            if (primeiroVenc) {
                primeiroVenc.value = hoje.toISOString().split('T')[0];
            }
        });
        
        // Eventos para atualizar parcelas
        document.getElementById('novo-primeiro-vencimento')?.addEventListener('change', gerarTabelaParcelas);
        document.getElementById('novo-intervalo-parcelas')?.addEventListener('change', gerarTabelaParcelas);
        
        // ========================================
        // FUNÇÕES DA ABA E-MAIL
        // ========================================
        function enviarEmailOrcamento() {
            const email = document.getElementById('novo-email-cliente').value.trim();
            const assunto = document.getElementById('novo-email-assunto').value.trim();
            const mensagem = document.getElementById('novo-email-mensagem').value.trim();
            
            if (!email) {
                showNotification('Por favor, informe o e-mail do destinatário.', 'warning');
                return;
            }
            
            if (!assunto) {
                showNotification('Por favor, informe o assunto do e-mail.', 'warning');
                return;
            }
            
            // Simular envio
            showNotification('E-mail enviado com sucesso para ' + email, 'success');
            
            // TODO: Integrar com API de envio de e-mail
        }
        
        function visualizarEmailOrcamento() {
            const assunto = document.getElementById('novo-email-assunto').value.trim() || 'Orçamento';
            const mensagem = document.getElementById('novo-email-mensagem').value.trim() || 'Sem mensagem personalizada.';
            
            // Abrir preview simples
            const previewContent = `
                <div style="padding: 20px; font-family: Arial, sans-serif;">
                    <h3 style="color: #333; border-bottom: 2px solid #f97316; padding-bottom: 10px;">${assunto}</h3>
                    <div style="white-space: pre-wrap; color: #555; line-height: 1.6;">${mensagem}</div>
                    <div style="margin-top: 20px; padding: 15px; background: #f5f5f5; border-radius: 8px;">
                        <p style="margin: 0; font-size: 12px; color: #888;">
                            <i class="fas fa-paperclip"></i> Anexo: Orçamento.pdf
                        </p>
                    </div>
                </div>
            `;
            
            showNotification('Visualização de e-mail aberta!', 'info');
        }

        // ========================================
        // AÇÕES - FATURAR TODOS
        // ========================================
        function faturarTodos() {
            const cards = document.getElementById('col-faturar').querySelectorAll('.kanban-card');
            const count = cards.length;
            
            if (count === 0) {
                showNotification('Não há pedidos para faturar', 'warning');
                return;
            }
            
            // Atualizar info do modal
            document.getElementById('faturar-info').textContent = 
                `Você está prestes a faturar ${count} pedido${count > 1 ? 's' : ''}.`;
            
            // Calcular total
            let total = 0;
            dadosVendas.faturar.forEach(p => total += p.valor);
            document.getElementById('faturar-total').textContent = `Total: R$ ${total.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}`;
            
            // Listar pedidos com design premium
            let listaHTML = '';
            dadosVendas.faturar.forEach((p, index) => {
                listaHTML += `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 14px 16px; background: ${index % 2 === 0 ? '#ffffff' : '#f9fafb'}; border-bottom: 1px solid #f3f4f6; transition: background 0.2s;">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <div style="width: 32px; height: 32px; background: linear-gradient(135deg, #dbeafe, #bfdbfe); border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                                <i class="fas fa-file-alt" style="font-size: 14px; color: #2563eb;"></i>
                            </div>
                            <div>
                                <div style="font-weight: 600; color: #1f2937; font-size: 14px;">Nº ${p.id}</div>
                                <div style="font-size: 12px; color: #6b7280;">${p.cliente.substring(0, 28)}${p.cliente.length > 28 ? '...' : ''}</div>
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-weight: 700; color: #059669; font-size: 14px;">R$ ${p.valor.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</div>
                        </div>
                    </div>
                `;
            });
            document.getElementById('faturar-lista').innerHTML = listaHTML || '<p style="text-align: center; color: #999; padding: 20px;">Nenhum pedido</p>';
            
            // Abrir modal
            document.getElementById('modal-faturar-todos').classList.add('active');
        }
        
        function fecharModalFaturar() {
            document.getElementById('modal-faturar-todos').classList.remove('active');
        }
        
        function confirmarFaturarTodos() {
            const pedidosParaFaturar = [...dadosVendas.faturar];
            const count = pedidosParaFaturar.length;
            
            if (count === 0) {
                fecharModalFaturar();
                return;
            }
            
            // Mover pedidos para coluna "faturado"
            pedidosParaFaturar.forEach(pedido => {
                // Gerar número de NF fictício
                const nfNumero = String(Math.floor(Math.random() * 900000) + 100000).padStart(8, '0');
                pedido.status = 'Faturado';
                pedido.nf = nfNumero;
                
                // Adicionar na coluna faturado
                dadosVendas.faturado.unshift(pedido);
            });
            
            // Limpar coluna faturar
            dadosVendas.faturar = [];
            
            // Re-renderizar kanban
            renderKanban();
            
            // Fechar modal e notificar
            fecharModalFaturar();
            showNotification(`${count} pedido${count > 1 ? 's' : ''} faturado${count > 1 ? 's' : ''} com sucesso!`, 'success');
            
            // TODO: Salvar no backend via API
            // faturarPedidosAPI(pedidosParaFaturar);
        }
        
        // Eventos do modal faturar
        document.getElementById('modal-faturar-todos').addEventListener('click', function(e) {
            if (e.target === this) fecharModalFaturar();
        });

        // ========================================
        // AÇÕES - COMUNICAR SEFAZ
        // ========================================
        function comunicarSefaz() {
            const notasFaturadas = dadosVendas.faturado.filter(p => p.nf);
            const count = notasFaturadas.length;
            
            if (count === 0) {
                showNotification('Não há notas fiscais para transmitir', 'warning');
                return;
            }
            
            // Reset do modal
            document.getElementById('sefaz-loading').style.display = 'none';
            document.getElementById('sefaz-inicial').style.display = 'block';
            document.getElementById('sefaz-resultado').style.display = 'none';
            document.getElementById('btn-transmitir-sefaz').style.display = 'inline-flex';
            
            // Atualizar info
            document.getElementById('sefaz-info').textContent = 
                `${count} nota${count > 1 ? 's' : ''} fiscal${count > 1 ? 'is' : ''} pronta${count > 1 ? 's' : ''} para transmissão.`;
            
            // Listar notas
            let listaHTML = '';
            notasFaturadas.forEach(p => {
                listaHTML += `
                    <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #e5e5e5;">
                        <span><i class="fas fa-file-invoice" style="color: #06b6d4; margin-right: 8px;"></i> NF ${p.nf}</span>
                        <span>${p.cliente.substring(0, 25)}${p.cliente.length > 25 ? '...' : ''}</span>
                    </div>
                `;
            });
            document.getElementById('sefaz-lista').innerHTML = listaHTML;
            
            // Abrir modal
            document.getElementById('modal-sefaz').classList.add('active');
        }
        
        function fecharModalSefaz() {
            document.getElementById('modal-sefaz').classList.remove('active');
        }
        
        function transmitirSefaz() {
            // Esconder tela inicial, mostrar loading
            document.getElementById('sefaz-inicial').style.display = 'none';
            document.getElementById('sefaz-loading').style.display = 'block';
            document.getElementById('btn-transmitir-sefaz').style.display = 'none';
            
            // Simular transmissão (2-3 segundos)
            setTimeout(() => {
                const notasFaturadas = dadosVendas.faturado.filter(p => p.nf);
                const count = notasFaturadas.length;
                
                // Esconder loading, mostrar resultado
                document.getElementById('sefaz-loading').style.display = 'none';
                document.getElementById('sefaz-resultado').style.display = 'block';
                document.getElementById('sefaz-resultado-info').textContent = 
                    `${count} nota${count > 1 ? 's' : ''} fiscal${count > 1 ? 'is' : ''} transmitida${count > 1 ? 's' : ''} com sucesso para a SEFAZ!`;
                
                // Marcar notas como transmitidas (adicionar protocolo fictício)
                notasFaturadas.forEach(p => {
                    p.protocolo = 'SEFAZ-' + Date.now() + '-' + p.id;
                    if (!p.mensagem) {
                        p.mensagem = 'NF-e autorizada pela SEFAZ';
                    }
                });
                
                // Re-renderizar para atualizar visual
                renderKanban();
                
                showNotification(`Transmissão SEFAZ concluída! ${count} NF-e${count > 1 ? 's' : ''} autorizadas.`, 'success');
                
                // TODO: Enviar para SEFAZ real via API
                // transmitirSefazAPI(notasFaturadas);
            }, 2500);
        }
        
        // Eventos do modal SEFAZ
        document.getElementById('modal-sefaz').addEventListener('click', function(e) {
            if (e.target === this) fecharModalSefaz();
        });

        function toggleChat() {
            showNotification('Assistente Bob será aberto em breve!', 'info');
        }

        // ========================================
        // PESQUISA
        // ========================================
        document.getElementById('search-input').addEventListener('input', function(e) {
            const termo = e.target.value.toLowerCase();
            const cards = document.querySelectorAll('.kanban-card');
            
            cards.forEach(card => {
                const titulo = card.querySelector('.card-title').textContent.toLowerCase();
                const numero = card.querySelector('.card-number').textContent.toLowerCase();
                
                if (titulo.includes(termo) || numero.includes(termo)) {
                    card.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            });
        });

        // ========================================
        // NOTIFICAÇÕES
        // ========================================
        function showNotification(message, type = 'info') {
            const colors = {
                info: '#3b82f6',
                success: '#22c55e',
                warning: '#f59e0b',
                error: '#ef4444'
            };

            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 70px;
                right: 20px;
                background: ${colors[type]};
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                font-size: 14px;
                font-weight: 500;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 10000;
                animation: slideIn 0.3s ease;
            `;
            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // Adicionar keyframes
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
        `;
        document.head.appendChild(style);

        // ========================================
        // CARREGAR DADOS DO USUÁRIO LOGADO
        // ========================================
        // Mapeamento de avatares por nome de usuário
        const avatarNameMap = {
            'clemerson': '/avatars/Clemerson.webp',
            'isabela': '/avatars/Isabela.webp',
            'thaina': '/avatars/Thaina.webp',
            'thiago': '/avatars/Thiago.webp',
            'nicolas': '/avatars/NicolasDaniel.webp',
            'nicolasdaniel': '/avatars/NicolasDaniel.webp',
            'rh': '/avatars/Rh.webp',
            'admin': '/avatars/admin.webp',
            'ti': '/avatars/TI.webp',
            'tialuforce': '/avatars/TI.webp',
            'antonio': '/avatars/Antonio.webp',
            'andreia': '/avatars/Andreia.webp',
            'guilherme': '/avatars/Guilherme.webp'
        };

        function getAvatarFromEmail(email, nome) {
            if (!email) return null;
            const username = email.split('@')[0].split('.')[0].toLowerCase();
            if (avatarNameMap[username]) return avatarNameMap[username];
            // Tentar pelo primeiro nome
            if (nome) {
                const firstName = nome.split(' ')[0].toLowerCase();
                if (avatarNameMap[firstName]) return avatarNameMap[firstName];
            }
            return null;
        }

        async function carregarUsuarioLogado() {
            try {
                const response = await fetch('/api/me', { credentials: 'include' });
                if (!response.ok) return;
                
                const user = await response.json();
                // Usar apelido se disponível, senão primeiro nome
                const userName = user.apelido || user.nome || 'Usuário';
                const primeiroNome = user.apelido || (user.nome ? user.nome.split(' ')[0] : 'Usuário');
                
                // Prioridade: avatar do banco > mapeamento por email/nome
                let userAvatar = user.avatar && user.avatar !== '/avatars/default.webp' ? user.avatar : null;
                if (!userAvatar) {
                    userAvatar = getAvatarFromEmail(user.email, userName);
                }
                
                // Atualizar saudação dinâmica baseada na hora
                const greetingTextEl = document.getElementById('greeting-text');
                if (greetingTextEl) {
                    const hour = new Date().getHours();
                    let greeting = 'Bom dia';
                    if (hour >= 12 && hour < 18) greeting = 'Boa tarde';
                    else if (hour >= 18 || hour < 5) greeting = 'Boa noite';
                    greetingTextEl.textContent = greeting;
                }
                
                // Atualizar nome na saudação
                const userNameEl = document.getElementById('user-name');
                if (userNameEl) {
                    userNameEl.textContent = primeiroNome;
                }
                
                // Atualizar avatar/foto
                const userPhotoEl = document.getElementById('user-photo');
                const userInitialEl = document.getElementById('user-initial');
                
                if (userAvatar && userPhotoEl) {
                    userPhotoEl.src = userAvatar;
                    userPhotoEl.classList.add('visible');
                    userPhotoEl.style.display = 'block';
                    if (userInitialEl) userInitialEl.style.display = 'none';
                } else if (userInitialEl) {
                    userInitialEl.textContent = userName.charAt(0).toUpperCase();
                    userInitialEl.style.display = 'flex';
                    if (userPhotoEl) userPhotoEl.style.display = 'none';
                }
            } catch (error) {
                console.error('Erro ao carregar usuário:', error);
            }
        }

        // ========================================
        // INIT
        // ========================================
        document.addEventListener('DOMContentLoaded', () => {
            console.log('🚀 [KANBAN] DOMContentLoaded - Iniciando Kanban v2.0...');
            console.log('🚀 [KANBAN] Timestamp:', new Date().toISOString());
            
            // Carregar dados do usuário logado via API
            carregarUsuarioLogado();

            // Carregar pedidos da API e renderizar o Kanban
            console.log('📋 [KANBAN] Chamando carregarPedidosKanban()...');
            carregarPedidosKanban().then(() => {
                console.log('✅ [KANBAN] carregarPedidosKanban() concluído!');
            }).catch(err => {
                console.error('❌ [KANBAN] Erro em carregarPedidosKanban():', err);
            });
        });
    </script>
    
    <!-- Font Awesome para ícones do chat/suporte -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    
    <!-- Botão WhatsApp Flutuante -->
    <button class="whatsapp-btn" title="Contato via WhatsApp" onclick="window.open('https://wa.me/5511999999999', '_blank')">
        <i class="fab fa-whatsapp"></i>
    </button>
    
    <!-- Sistema de Chat e Suporte (widgets condicionais por usuário) -->
    <!-- Sistema de Monitoramento de Conexão -->
    `n</body>
</html>

