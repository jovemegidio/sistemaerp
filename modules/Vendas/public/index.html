<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <title>ALUFORCE - Vendas e NF-e</title>
    
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- CSP Fix -->
    <script src="/js/csp-fix.js"></script>
    
    <style>
        :root {
            --sidebar-width: 56px;
            --header-height: 48px;
            --tab-height: 0px;
            --primary-orange: #225cfa;
            --primary-dark: #1a1a2e;
            --bg-gray: #f5f5f5;
            --border-color: #e5e5e5;
            --text-primary: #1a1a1a;
            --text-secondary: #666;
            --success-green: #22c55e;
            --warning-yellow: #eab308;
            --danger-red: #ef4444;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-gray);
            color: var(--text-primary);
            overflow: hidden;
        }

        /* ========================================
           LAYOUT PRINCIPAL
           ======================================== */
        .app-container {
            display: flex;
            height: 100vh;
        }

        /* ========================================
           SIDEBAR LATERAL (Estilo Omie)
           ======================================== */
        .sidebar {
            width: var(--sidebar-width);
            background: var(--primary-dark);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 12px 0;
            z-index: 100;
        }

        .sidebar-logo {
            width: 36px;
            height: 36px;
            background: var(--primary-orange);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
            cursor: pointer;
        }

        .sidebar-logo i {
            color: white;
            font-size: 18px;
        }

        .sidebar-nav {
            display: flex;
            flex-direction: column;
            gap: 4px;
            flex: 1;
        }

        .sidebar-btn {
            width: 40px;
            height: 40px;
            border: none;
            background: transparent;
            color: #8b8b9a;
            border-radius: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: all 0.2s;
            position: relative;
        }

        .sidebar-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .sidebar-btn.active {
            background: var(--primary-orange);
            color: white;
        }

        .sidebar-btn .badge {
            position: absolute;
            top: 4px;
            right: 4px;
            background: var(--danger-red);
            color: white;
            font-size: 10px;
            padding: 2px 5px;
            border-radius: 10px;
            font-weight: 600;
        }

        .sidebar-bottom {
            margin-top: auto;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        /* ========================================
           MAIN CONTENT AREA
           ======================================== */
        .main-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* ========================================
           HEADER SUPERIOR
           ======================================== */
        .header {
            height: var(--header-height);
            background: var(--primary-dark);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 16px;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 24px;
        }

        .header-brand {
            display: flex;
            align-items: center;
            gap: 8px;
            color: white;
        }

        .header-brand img {
            height: 24px;
        }

        .header-brand span {
            font-size: 14px;
            font-weight: 600;
            color: #8b8b9a;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .header-btn {
            width: 36px;
            height: 36px;
            border: none;
            background: transparent;
            color: #8b8b9a;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            transition: all 0.2s;
        }

        .header-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            margin-left: 8px;
            overflow: hidden;
        }

        .user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: none;
        }

        .user-avatar img.visible {
            display: block;
        }

        .user-greeting {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-left: 16px;
            color: #8b8b9a;
            font-size: 13px;
        }

        .user-greeting strong {
            color: white;
        }

        /* ========================================
           SISTEMA DE NOTIFICAÇÕES
           ======================================== */
        .notification-container {
            position: relative;
        }

        .notification-btn {
            position: relative;
        }

        .notification-badge {
            position: absolute;
            top: 2px;
            right: 2px;
            min-width: 18px;
            height: 18px;
            background: #ef4444;
            color: white;
            font-size: 10px;
            font-weight: 600;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 5px;
            box-shadow: 0 2px 4px rgba(239, 68, 68, 0.4);
            animation: pulse-badge 2s infinite;
        }

        .notification-badge.hidden {
            display: none;
        }

        @keyframes pulse-badge {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .notification-panel {
            position: absolute;
            top: calc(100% + 12px);
            right: 0;
            width: 380px;
            max-height: 500px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            z-index: 99999;
            display: none;
            overflow: hidden;
            animation: slideDown 0.2s ease;
        }

        .notification-panel.active {
            display: block;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .notification-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            background: linear-gradient(135deg, #f97316, #ea580c);
            color: white;
        }

        .notification-header h3 {
            margin: 0;
            font-size: 16px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .notification-actions {
            display: flex;
            gap: 8px;
        }

        .notification-actions button {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .notification-actions button:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .notification-tabs {
            display: flex;
            border-bottom: 1px solid #e5e5e5;
            background: #f8f8f8;
        }

        .notif-tab {
            flex: 1;
            padding: 12px;
            background: none;
            border: none;
            font-size: 12px;
            color: #666;
            cursor: pointer;
            transition: all 0.2s;
            border-bottom: 2px solid transparent;
        }

        .notif-tab:hover {
            color: #f97316;
        }

        .notif-tab.active {
            color: #f97316;
            border-bottom-color: #f97316;
            font-weight: 600;
        }

        .notification-list {
            max-height: 340px;
            overflow-y: auto;
        }

        .notification-item {
            display: flex;
            gap: 12px;
            padding: 14px 20px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: all 0.2s;
        }

        .notification-item:hover {
            background: #f8f8f8;
        }

        .notification-item.unread {
            background: #fff7ed;
            border-left: 3px solid #f97316;
        }

        .notification-item.important {
            border-left: 3px solid #ef4444;
        }

        .notification-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .notification-icon.success { background: #dcfce7; color: #22c55e; }
        .notification-icon.warning { background: #fef3c7; color: #f59e0b; }
        .notification-icon.error { background: #fee2e2; color: #ef4444; }
        .notification-icon.info { background: #dbeafe; color: #3b82f6; }
        .notification-icon.order { background: #f3e8ff; color: #8b5cf6; }
        .notification-icon.payment { background: #d1fae5; color: #10b981; }

        .notification-content {
            flex: 1;
            min-width: 0;
        }

        .notification-title {
            font-size: 13px;
            font-weight: 600;
            color: #333;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .notification-title .badge-new {
            background: #f97316;
            color: white;
            font-size: 9px;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 500;
        }

        .notification-message {
            font-size: 12px;
            color: #666;
            line-height: 1.4;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .notification-time {
            font-size: 11px;
            color: #999;
            margin-top: 6px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .notification-empty {
            padding: 40px 20px;
            text-align: center;
            color: #999;
        }

        .notification-empty i {
            font-size: 40px;
            margin-bottom: 12px;
            opacity: 0.5;
        }

        .notification-footer {
            padding: 12px 20px;
            background: #f8f8f8;
            text-align: center;
            border-top: 1px solid #e5e5e5;
        }

        .notification-footer a {
            color: #f97316;
            text-decoration: none;
            font-size: 13px;
            font-weight: 500;
        }

        .notification-footer a:hover {
            text-decoration: underline;
        }

        /* ========================================
           TABS (removido - kanban ocupa todo espaço)
           ======================================== */
        .tabs-bar {
            display: none;
        }

        .tab {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: #f5f5f5;
            border: none;
            border-radius: 6px;
            color: var(--text-secondary);
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .tab:hover {
            background: #e5e5e5;
        }

        .tab.active {
            background: var(--primary-orange);
            color: white;
        }

        .tab .close-tab {
            margin-left: 4px;
            opacity: 0.7;
            font-size: 12px;
        }

        .tab .close-tab:hover {
            opacity: 1;
        }

        .tabs-actions {
            margin-left: auto;
            display: flex;
            gap: 8px;
        }

        .tab-action-btn {
            width: 32px;
            height: 32px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            transition: all 0.2s;
        }

        .tab-action-btn:hover {
            background: #f5f5f5;
        }

        /* ========================================
           FILTROS BAR
           ======================================== */
        .filters-bar {
            background: white;
            padding: 12px 16px;
            display: flex;
            align-items: center;
            gap: 16px;
            border-bottom: 1px solid var(--border-color);
        }

        .search-box {
            display: flex;
            align-items: center;
            background: #f5f5f5;
            border-radius: 8px;
            padding: 0 12px;
            width: 300px;
        }

        .search-box i {
            color: #999;
            font-size: 14px;
        }

        .search-box input {
            border: none;
            background: transparent;
            padding: 10px 12px;
            font-size: 14px;
            width: 100%;
            outline: none;
        }

        .filter-link {
            color: var(--primary-orange);
            font-size: 13px;
            font-weight: 500;
            text-decoration: none;
            cursor: pointer;
        }

        .filter-link:hover {
            text-decoration: underline;
        }

        /* ========================================
           KANBAN BOARD
           ======================================== */
        .kanban-container {
            flex: 1;
            overflow-x: auto;
            overflow-y: hidden;
            padding: 12px;
            background: var(--bg-gray);
            height: calc(100vh - var(--header-height) - 60px);
        }

        .kanban-board {
            display: flex;
            gap: 12px;
            height: 100%;
            width: 100%;
        }

        .kanban-column {
            flex: 1;
            min-width: 200px;
            max-width: none;
            background: white;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        .kanban-column-header {
            padding: 16px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .column-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .column-count {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 2px;
        }

        .column-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .column-indicator.orcamento { background: #94a3b8; }
        .column-indicator.analise { background: #f59e0b; }
        .column-indicator.aprovado { background: #10b981; }
        .column-indicator.faturar { background: #f97316; }
        .column-indicator.faturado { background: #22c55e; }
        .column-indicator.recibo { background: #06b6d4; }

        .kanban-column-content {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .kanban-column-footer {
            padding: 12px 16px;
            border-top: 1px solid var(--border-color);
        }

        .btn-new-card {
            width: 100%;
            padding: 10px;
            background: var(--primary-orange);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            transition: all 0.2s;
        }

        .btn-new-card:hover {
            background: #ea580c;
        }

        .btn-action-card {
            width: 100%;
            padding: 10px;
            background: #22c55e;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            transition: all 0.2s;
        }

        .btn-action-card:hover {
            background: #16a34a;
        }

        .btn-action-card.teal {
            background: #06b6d4;
        }

        .btn-action-card.teal:hover {
            background: #0891b2;
        }

        /* ========================================
           KANBAN CARDS
           ======================================== */
        .kanban-card {
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 14px;
            cursor: grab;
            transition: all 0.2s;
            position: relative;
            user-select: none;
        }

        .kanban-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

        .kanban-card.dragging {
            opacity: 0.5;
            transform: rotate(2deg);
            cursor: grabbing;
            box-shadow: 0 8px 20px rgba(0,0,0,0.2);
        }
        
        /* Estilo da coluna quando card está sendo arrastado sobre ela */
        .kanban-column-content.drag-over {
            background: #e0f2fe;
            border: 2px dashed #0ea5e9;
            border-radius: 8px;
        }
        
        /* Placeholder visual para onde o card vai */
        .kanban-column-content.drag-over::after {
            content: 'Solte aqui';
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            background: rgba(14, 165, 233, 0.1);
            border-radius: 8px;
            color: #0ea5e9;
            font-size: 13px;
            font-weight: 500;
            margin-top: 8px;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }

        .card-number {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .card-menu {
            width: 24px;
            height: 24px;
            border: none;
            background: transparent;
            color: #999;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .card-menu:hover {
            background: #f5f5f5;
            color: var(--text-primary);
        }

        .card-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
            line-height: 1.4;
        }

        /* === Produtos no Card === */
        .card-produtos {
            margin: 8px 0;
            padding: 8px;
            background: #f8fafc;
            border-radius: 6px;
            border: 1px solid #e5e5e5;
        }

        .card-produto-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 4px 0;
            border-bottom: 1px dashed #e5e5e5;
            font-size: 11px;
        }

        .card-produto-item:last-child {
            border-bottom: none;
        }

        .produto-codigo {
            font-weight: 600;
            color: #f97316;
            font-size: 10px;
            background: #fff7ed;
            padding: 2px 6px;
            border-radius: 4px;
            flex-shrink: 0;
        }

        .produto-desc {
            flex: 1;
            color: #333;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .produto-qtd {
            font-weight: 500;
            color: #555;
            font-size: 10px;
            flex-shrink: 0;
        }

        .card-produtos-mais {
            text-align: center;
            font-size: 10px;
            color: #888;
            padding-top: 6px;
            margin-top: 4px;
            border-top: 1px dashed #e5e5e5;
        }

        .card-produto-vazio {
            text-align: center;
            color: #999;
            font-size: 11px;
            padding: 8px;
        }

        .card-produto-vazio i {
            margin-right: 6px;
            color: #ccc;
        }

        .card-status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 500;
            margin-bottom: 10px;
        }

        .card-status.atrasado {
            background: #fef2f2;
            color: #dc2626;
        }

        .card-status.faturado {
            background: #f0fdf4;
            color: #16a34a;
        }

        .card-status.em-dia {
            background: #eff6ff;
            color: #2563eb;
        }

        .card-value {
            font-size: 15px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 6px;
        }

        .card-meta {
            font-size: 11px;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .card-origin {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 11px;
            color: #22c55e;
            margin-top: 8px;
        }

        .card-origin i {
            font-size: 10px;
        }

        .card-transport {
            font-size: 10px;
            color: var(--text-secondary);
            margin-top: 6px;
            padding-top: 6px;
            border-top: 1px solid #f0f0f0;
        }

        .card-badge {
            position: absolute;
            top: 8px;
            right: 8px;
        }

        .card-badge.nf {
            background: #22c55e;
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 600;
        }

        .card-message {
            display: flex;
            align-items: flex-start;
            gap: 6px;
            margin-top: 8px;
            padding: 8px;
            background: #fef3c7;
            border-radius: 6px;
            font-size: 11px;
            color: #92400e;
        }

        .card-message i {
            margin-top: 2px;
        }

        /* Empty State */
        .empty-column {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-secondary);
        }

        .empty-column i {
            font-size: 32px;
            opacity: 0.3;
            margin-bottom: 12px;
        }

        .empty-column p {
            font-size: 13px;
        }

        /* ========================================
           RESPONSIVO
           ======================================== */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: #f5f5f5;
        }

        ::-webkit-scrollbar-thumb {
            background: #ccc;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #aaa;
        }

        /* ========================================
           MODAL EDITAR PEDIDO - ESTILO OMIE PROFISSIONAL
           ======================================== */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            padding: 0;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            width: 100%;
            max-width: 700px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 25px 60px rgba(0, 0, 0, 0.4);
            animation: modalSlideIn 0.3s ease;
        }

        /* Modal Grande Estilo Omie */
        .modal-content-omie {
            background: #f8f8f8;
            border-radius: 12px;
            width: 95%;
            max-width: 1200px;
            height: auto;
            max-height: 90vh;
            overflow: hidden;
            box-shadow: 0 25px 60px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.2s ease;
            display: flex;
            flex-direction: column;
        }

        @keyframes modalSlideIn {
            from { opacity: 0; transform: scale(0.98); }
            to { opacity: 1; transform: scale(1); }
        }

        /* ===== MODAL NOVO ITEM - ESTILO OMIE ===== */
        .modal-header-item-omie {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 24px;
            background: white;
            border-bottom: 1px solid #e5e5e5;
        }

        .modal-header-item-omie h2 {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin: 0;
        }

        .modal-body-item-omie {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
            background: #f8f9fa;
        }

        .produto-section-omie {
            display: flex;
            gap: 20px;
            align-items: flex-start;
            background: white;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #e5e5e5;
            margin-bottom: 20px;
        }

        .barcode-icon {
            flex-shrink: 0;
            width: 60px;
            height: 60px;
            background: #f5f5f5;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid #e0e0e0;
        }

        .produto-fields-omie {
            flex: 1;
        }

        .produto-row {
            display: flex;
            gap: 16px;
            align-items: flex-end;
        }

        .field-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .field-group label {
            font-size: 12px;
            font-weight: 500;
            color: #555;
        }

        .field-group input,
        .field-group select,
        .field-group textarea {
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 13px;
            background: white;
            transition: border-color 0.2s;
        }

        .field-group input:focus,
        .field-group select:focus,
        .field-group textarea:focus {
            outline: none;
            border-color: #f97316;
            box-shadow: 0 0 0 3px rgba(249, 115, 22, 0.1);
        }

        .input-autocomplete-container {
            position: relative;
        }

        .input-autocomplete-container input {
            width: 100%;
        }

        .autocomplete-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-top: none;
            border-radius: 0 0 8px 8px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
        }

        .autocomplete-dropdown.active {
            display: block;
        }

        .autocomplete-item {
            padding: 12px 16px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            flex-direction: column;
            gap: 4px;
            transition: background 0.15s;
        }

        .autocomplete-item:hover,
        .autocomplete-item.selected {
            background: #fff7ed;
        }

        .autocomplete-item:last-child {
            border-bottom: none;
        }

        .autocomplete-item-code {
            font-size: 12px;
            font-weight: 600;
            color: #f97316;
        }

        .autocomplete-item-desc {
            font-size: 13px;
            color: #333;
        }

        .autocomplete-item-info {
            font-size: 11px;
            color: #888;
            display: flex;
            gap: 12px;
        }

        .autocomplete-no-results {
            padding: 20px;
            text-align: center;
            color: #999;
            font-size: 13px;
        }

        .btn-pesquisar-produto {
            padding: 10px 16px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            color: #555;
            white-space: nowrap;
            transition: all 0.2s;
        }

        .btn-pesquisar-produto:hover {
            background: #f5f5f5;
            border-color: #ccc;
        }

        .input-with-search {
            position: relative;
            display: flex;
        }

        .input-with-search input {
            flex: 1;
            border-radius: 6px 0 0 6px;
        }

        .input-with-search .btn-input-search {
            padding: 10px 14px;
            background: #f5f5f5;
            border: 1px solid #ddd;
            border-left: none;
            border-radius: 0 6px 6px 0;
            cursor: pointer;
            color: #666;
        }

        .input-with-search .btn-input-search:hover {
            background: #e5e5e5;
        }

        .section-omie {
            background: white;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #e5e5e5;
            margin-bottom: 16px;
        }

        .section-title-omie {
            font-size: 14px;
            font-weight: 600;
            color: #333;
            margin: 0 0 16px 0;
        }

        .section-row {
            display: flex;
            gap: 16px;
            align-items: flex-end;
            flex-wrap: wrap;
        }

        .section-row-split {
            display: flex;
            gap: 16px;
            margin-bottom: 16px;
        }

        .input-number {
            text-align: right;
        }

        .checkbox-field {
            display: flex;
            align-items: center;
        }

        .toggle-label {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 12px;
            color: #555;
            cursor: pointer;
        }

        .toggle-label input {
            display: none;
        }

        .toggle-switch {
            width: 36px;
            height: 20px;
            background: #ddd;
            border-radius: 10px;
            position: relative;
            transition: background 0.2s;
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 16px;
            height: 16px;
            background: white;
            border-radius: 50%;
            transition: transform 0.2s;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .toggle-label input:checked + .toggle-switch {
            background: #f97316;
        }

        .toggle-label input:checked + .toggle-switch::after {
            transform: translateX(16px);
        }

        .valores-calculados-table {
            display: flex;
            background: white;
            border-radius: 8px;
            border: 1px solid #e5e5e5;
            overflow: hidden;
            margin-bottom: 16px;
        }

        .valor-calc-item {
            flex: 1;
            padding: 16px;
            text-align: center;
            border-right: 1px solid #e5e5e5;
        }

        .valor-calc-item:last-child {
            border-right: none;
        }

        .valor-calc-item.destaque {
            background: #fff7ed;
        }

        .valor-calc-label {
            display: block;
            font-size: 11px;
            color: #888;
            margin-bottom: 4px;
        }

        .valor-calc-value {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: #f97316;
        }

        .valor-calc-item.destaque .valor-calc-value {
            font-size: 16px;
            color: #ea580c;
        }

        .observacoes-link {
            margin-bottom: 16px;
        }

        .btn-link-obs {
            background: none;
            border: none;
            color: #555;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 0;
        }

        .btn-link-obs:hover {
            color: #f97316;
        }

        .observacoes-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #e5e5e5;
            margin-bottom: 16px;
        }

        .modal-footer-item-omie {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 24px;
            padding: 16px 24px;
            background: white;
            border-top: 1px solid #e5e5e5;
        }

        .footer-toggle {
            margin-right: auto;
        }

        .btn-incluir-item {
            padding: 12px 32px;
            background: linear-gradient(135deg, #f97316, #ea580c);
            color: white;
            border: none;
            border-radius: 24px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-incluir-item:hover {
            background: linear-gradient(135deg, #ea580c, #dc2626);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(249, 115, 22, 0.3);
        }

        @media (max-width: 900px) {
            .produto-row {
                flex-direction: column;
                align-items: stretch;
            }
            .section-row-split {
                flex-direction: column;
            }
            .valores-calculados-table {
                flex-wrap: wrap;
            }
            .valor-calc-item {
                flex: 1 1 30%;
                border-bottom: 1px solid #e5e5e5;
            }
        }

        /* Header Omie */
        .modal-header-omie {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 20px;
            background: white;
            border-bottom: 1px solid #e0e0e0;
            min-height: 50px;
        }

        .modal-header-omie h2 {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .modal-header-omie .close-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            background: #f3f4f6;
            border: 1px solid #e5e7eb;
            color: #374151;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            padding: 10px 18px;
            border-radius: 8px;
            transition: all 0.2s ease;
        }

        .modal-header-omie .close-btn:hover {
            background: #fee2e2;
            border-color: #fca5a5;
            color: #dc2626;
        }

        .modal-header-omie .close-btn i {
            font-size: 12px;
        }

        /* Container Principal com Sidebar */
        .modal-container-omie {
            display: flex;
            flex: 1;
            overflow: hidden;
            max-height: calc(90vh - 60px);
        }

        /* Área de Conteúdo Principal */
        .modal-main-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px 24px;
            background: white;
            border-right: 1px solid #e5e5e5;
        }

        /* Sidebar de Ações - Estilo Omie */
        .modal-sidebar-actions {
            width: 160px;
            background: white;
            padding: 16px 12px;
            display: flex;
            flex-direction: column;
            gap: 2px;
            overflow-y: auto;
        }

        .sidebar-action-btn {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            background: none;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            color: #444;
            cursor: pointer;
            transition: all 0.15s;
            text-align: left;
            width: 100%;
        }

        .sidebar-action-btn:hover {
            background: #f5f5f5;
            color: #222;
        }

        .sidebar-action-btn i {
            width: 16px;
            text-align: center;
            color: var(--primary-orange);
            font-size: 13px;
        }

        .sidebar-action-btn.primary {
            background: var(--primary-orange);
            color: white;
            font-weight: 500;
        }

        .sidebar-action-btn.primary:hover {
            background: #0011ac;
        }

        .sidebar-action-btn.primary i {
            color: white;
        }

        .sidebar-action-btn.danger {
            color: #666;
        }

        .sidebar-action-btn.danger i {
            color: #999;
        }

        .sidebar-action-btn.danger:hover {
            background: #fef2f2;
            color: #dc2626;
        }

        .sidebar-action-btn.danger:hover i {
            color: #dc2626;
        }

        .sidebar-action-btn.outline-primary {
            border: 1px solid var(--primary-orange);
            color: var(--primary-orange);
            font-weight: 500;
            background: white;
        }

        .sidebar-action-btn.outline-primary:hover {
            background: #fff7ed;
        }

        /* Botão Faturar Agora - Destaque especial */
        .sidebar-action-btn.btn-faturar {
            background: linear-gradient(135deg, #023197 0%, #0b58ff 100%);
            color: white;
            border: none;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(249, 115, 22, 0.4);
            position: relative;
            overflow: hidden;
        }
        
        .sidebar-action-btn.btn-faturar::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }
        
        .sidebar-action-btn.btn-faturar:hover {
            background: linear-gradient(135deg, #0c86ea 0%, #063b80 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(249, 115, 22, 0.5);
        }
        
        .sidebar-action-btn.btn-faturar:hover::before {
            left: 100%;
        }
        
        .sidebar-action-btn.btn-faturar i {
            color: white;
        }

        /* Modal Histórico de Alterações - Profissional */
        .modal-historico-content {
            background: white;
            border-radius: 12px;
            width: 600px;
            max-width: 95vw;
            max-height: 85vh;
            overflow: hidden;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            animation: modalSlideIn 0.3s ease;
        }
        
        .modal-historico-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .modal-historico-header h2 {
            margin: 0;
            font-size: 18px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .modal-historico-header .close-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .modal-historico-header .close-btn:hover {
            background: rgba(255,255,255,0.3);
        }
        
        .modal-historico-body {
            padding: 24px;
            max-height: 60vh;
            overflow-y: auto;
        }
        
        .historico-timeline-pro {
            position: relative;
            padding-left: 30px;
        }
        
        .historico-timeline-pro::before {
            content: '';
            position: absolute;
            left: 10px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: linear-gradient(180deg, #667eea 0%, #764ba2 50%, #e0e7ff 100%);
        }
        
        .historico-item-pro {
            position: relative;
            padding: 16px 20px;
            background: #f8fafc;
            border-radius: 10px;
            margin-bottom: 16px;
            border-left: 3px solid #667eea;
            transition: all 0.2s;
        }
        
        .historico-item-pro:hover {
            background: #f1f5f9;
            transform: translateX(4px);
        }
        
        .historico-item-pro::before {
            content: '';
            position: absolute;
            left: -24px;
            top: 20px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #667eea;
            border: 3px solid white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .historico-item-pro.tipo-faturamento { border-left-color: #10b981; }
        .historico-item-pro.tipo-faturamento::before { background: #10b981; }
        
        .historico-item-pro.tipo-status { border-left-color: #8b5cf6; }
        .historico-item-pro.tipo-status::before { background: #8b5cf6; }
        
        .historico-item-pro.tipo-edicao { border-left-color: #f97316; }
        .historico-item-pro.tipo-edicao::before { background: #f97316; }
        
        .historico-item-pro.tipo-criacao { border-left-color: #06b6d4; }
        .historico-item-pro.tipo-criacao::before { background: #06b6d4; }
        
        .historico-item-pro.tipo-item { border-left-color: #ec4899; }
        .historico-item-pro.tipo-item::before { background: #ec4899; }
        
        .historico-header-pro {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
        }
        
        .historico-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .historico-badge.badge-faturamento {
            background: #d1fae5;
            color: #059669;
        }
        
        .historico-badge.badge-status {
            background: #ede9fe;
            color: #7c3aed;
        }
        
        .historico-badge.badge-edicao {
            background: #ffedd5;
            color: #c2410c;
        }
        
        .historico-badge.badge-criacao {
            background: #cffafe;
            color: #0891b2;
        }
        
        .historico-badge.badge-item {
            background: #fce7f3;
            color: #be185d;
        }
        
        .historico-data-pro {
            font-size: 12px;
            color: #94a3b8;
        }
        
        .historico-descricao-pro {
            font-size: 14px;
            color: #334155;
            line-height: 1.5;
            margin-bottom: 8px;
        }
        
        .historico-usuario-pro {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            color: #64748b;
        }
        
        .historico-usuario-pro i {
            font-size: 10px;
        }
        
        .historico-empty {
            text-align: center;
            padding: 40px 20px;
            color: #94a3b8;
        }
        
        .historico-empty i {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }
        
        .historico-empty p {
            margin: 0;
            font-size: 14px;
        }

        .sidebar-divider {
            height: 1px;
            background: #eee;
            margin: 8px 0;
        }

        /* Seção do Cliente - Melhorado */
        .cliente-section {
            display: flex;
            align-items: flex-start;
            gap: 16px;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid #eee;
        }

        .cliente-avatar {
            width: 44px;
            height: 44px;
            background: var(--primary-orange);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 16px;
            font-weight: 700;
            flex-shrink: 0;
        }

        .cliente-info {
            flex: 1;
        }

        .cliente-info-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 6px;
        }

        .cliente-nome-input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
            font-weight: 500;
            background: white;
        }

        .cliente-nome-input:focus {
            outline: none;
            border-color: var(--primary-orange);
            box-shadow: 0 0 0 2px rgba(249, 115, 22, 0.1);
        }

        .btn-consulta-credito {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 12px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 11px;
            color: #555;
            cursor: pointer;
            white-space: nowrap;
        }

        .btn-consulta-credito:hover {
            background: #f5f5f5;
            border-color: #ccc;
        }

        .previsao-faturamento {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .previsao-label {
            font-size: 11px;
            color: #666;
        }

        .previsao-input {
            padding: 7px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 12px;
            width: 130px;
        }

        .previsao-badge {
            width: 16px;
            height: 16px;
            background: var(--primary-orange);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 9px;
        }

        /* Grid de Valores - Melhorado */
        .valores-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
            margin-bottom: 16px;
        }

        .valor-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .valor-label {
            font-size: 10px;
            color: #777;
            display: flex;
            align-items: center;
            gap: 3px;
            text-transform: capitalize;
        }

        .valor-input {
            padding: 8px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
            font-weight: 500;
            background: #fafafa;
            color: #333;
        }

        .valor-input:focus {
            outline: none;
            border-color: var(--primary-orange);
            background: white;
        }

        .valor-input.highlight {
            background: #fff7ed;
            border-color: var(--primary-orange);
            color: var(--primary-orange);
            font-weight: 600;
        }

        /* Linha de Vendedor, Parcelas, Cenário - Melhorado */
        .info-row {
            display: grid;
            grid-template-columns: 1.5fr 1fr 1fr auto;
            gap: 12px;
            align-items: end;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid #eee;
        }

        .info-field {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .info-field label {
            font-size: 10px;
            color: #777;
            display: flex;
            align-items: center;
            gap: 3px;
        }

        .info-field input,
        .info-field select {
            padding: 8px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 12px;
            background: white;
        }

        .info-field input:focus,
        .info-field select:focus {
            outline: none;
            border-color: var(--primary-orange);
        }

        .btn-atualizar-impostos {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 8px 10px;
            background: none;
            border: none;
            color: #0891b2;
            font-size: 11px;
            cursor: pointer;
            white-space: nowrap;
        }

        .btn-atualizar-impostos:hover {
            color: #0e7490;
            text-decoration: underline;
        }

        /* Tabs do Modal - Estilo Omie */
        .modal-tabs {
            display: flex;
            gap: 0;
            border-bottom: 1px solid #ddd;
            margin-bottom: 16px;
            overflow-x: auto;
            background: #fafafa;
            margin-left: -24px;
            margin-right: -24px;
            padding-left: 24px;
            padding-right: 24px;
        }

        .modal-tab {
            padding: 10px 16px;
            background: none;
            border: none;
            font-size: 12px;
            color: #555;
            cursor: pointer;
            position: relative;
            white-space: nowrap;
            transition: all 0.15s;
        }

        .modal-tab:hover {
            color: #333;
            background: rgba(0,0,0,0.03);
        }

        .modal-tab.active {
            color: var(--primary-orange);
            font-weight: 600;
            background: white;
        }

        .modal-tab.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--primary-orange);
        }

        /* Botões de Ação da Tabela - Estilo Omie */
        .table-actions {
            display: flex;
            gap: 6px;
            margin-bottom: 12px;
        }

        .btn-table-action {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s;
            border: none;
        }

        .btn-table-action.success {
            background: #22c55e;
            color: white;
        }

        .btn-table-action.success:hover {
            background: #16a34a;
        }

        .btn-table-action.warning {
            background: #f59e0b;
            color: white;
        }

        .btn-table-action.warning:hover {
            background: #d97706;
        }

        .btn-table-action.danger {
            background: #ef4444;
            color: white;
        }

        .btn-table-action.danger:hover {
            background: #dc2626;
        }

        /* Tabela de Itens - Estilo Omie */
        .items-table-container {
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 12px;
            background: white;
        }

        .items-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }

        .items-table th {
            background: #fafafa;
            padding: 10px 14px;
            text-align: left;
            font-weight: 600;
            color: #555;
            border-bottom: 1px solid #e0e0e0;
            position: relative;
            font-size: 11px;
        }

        .items-table th .filter-icon {
            color: #bbb;
            font-size: 9px;
            margin-left: 4px;
            cursor: pointer;
        }

        .items-table td {
            padding: 12px 14px;
            border-bottom: 1px solid #f0f0f0;
            color: #333;
            font-size: 12px;
        }

        .items-table tr:last-child td {
            border-bottom: none;
        }

        .items-table tbody tr {
            cursor: pointer;
            transition: background-color 0.15s ease;
        }

        .items-table tr:hover {
            background: #f9f9f9;
        }

        .items-table tr.selected {
            background: #fff7ed;
        }

        .items-table .produto-code {
            font-weight: 600;
            color: #333;
        }

        .items-table .produto-desc {
            color: #555;
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* Paginação - Estilo Omie */
        .table-pagination {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 0;
            font-size: 11px;
            color: #777;
        }

        .pagination-info {
            color: #555;
        }

        .pagination-controls {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .pagination-btn {
            padding: 5px 8px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 3px;
            font-size: 10px;
            color: #555;
            cursor: pointer;
        }

        .pagination-btn:hover {
            background: #f5f5f5;
        }

        .pagination-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .pagination-current {
            background: var(--primary-orange);
            color: white;
            padding: 4px 8px;
            border-radius: 3px;
            font-weight: 600;
            font-size: 11px;
        }

        /* Alerta de Status - Estilo Omie */
        .status-alert {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 16px;
            border-radius: 4px;
            font-size: 13px;
            font-weight: 500;
            margin-top: 16px;
        }

        .status-alert.warning {
            background: linear-gradient(90deg, #f59e0b 0%, #fbbf24 100%);
            color: white;
            border: none;
            border-radius: 6px;
        }

        .status-alert.success {
            background: linear-gradient(90deg, #22c55e 0%, #4ade80 100%);
            color: white;
            border: none;
            border-radius: 6px;
        }

        .status-alert.info {
            background: linear-gradient(90deg, #3b82f6 0%, #60a5fa 100%);
            color: white;
            border: none;
            border-radius: 6px;
        }

        .status-alert i {
            font-size: 14px;
        }

        /* ========================== */
        /* ESTILOS MODAL NOVO ORÇAMENTO */
        /* ========================== */
        
        /* Cliente Section */
        .orcamento-cliente-section {
            display: flex;
            align-items: flex-start;
            gap: 16px;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid #eee;
        }

        .orcamento-cliente-avatar {
            width: 52px;
            height: 52px;
            background: linear-gradient(135deg, #e2e8f0, #cbd5e1);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #94a3b8;
            font-size: 22px;
            flex-shrink: 0;
        }

        .orcamento-cliente-info {
            flex: 1;
        }

        .orcamento-cliente-row {
            display: flex;
            align-items: flex-end;
            gap: 12px;
            flex-wrap: wrap;
        }

        .orcamento-field-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .orcamento-field-group label {
            font-size: 11px;
            color: #666;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .orcamento-input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 12px;
            min-width: 180px;
            background: white;
        }

        .orcamento-input:focus {
            outline: none;
            border-color: var(--primary-orange);
            box-shadow: 0 0 0 2px rgba(249, 115, 22, 0.1);
        }

        .input-with-btn {
            display: flex;
            align-items: center;
            gap: 0;
        }

        .input-with-btn .orcamento-input {
            border-radius: 4px 0 0 4px;
            border-right: none;
        }

        .input-with-btn .btn-input-action {
            padding: 8px 10px;
            background: #f5f5f5;
            border: 1px solid #ddd;
            border-left: none;
            border-radius: 0 4px 4px 0;
            cursor: pointer;
            color: #666;
            transition: all 0.15s;
        }

        .input-with-btn .btn-input-action:hover {
            background: #e5e5e5;
            color: #333;
        }

        .input-with-btn .btn-input-action:last-child {
            border-radius: 0 4px 4px 0;
        }

        .input-with-btn .btn-input-action:not(:last-child) {
            border-radius: 0;
            border-right: none;
        }

        /* Dropdown de Sugestões (Autocomplete) */
        .dropdown-sugestoes {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 0 0 4px 4px;
            max-height: 220px;
            overflow-y: auto;
            z-index: 9999;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            margin-top: -1px;
        }

        .dropdown-sugestoes .dropdown-item {
            padding: 10px 12px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.15s;
        }

        .dropdown-sugestoes .dropdown-item:last-child {
            border-bottom: none;
        }

        .dropdown-sugestoes .dropdown-item:hover {
            background: #f5f5f5;
        }

        .dropdown-sugestoes .dropdown-item.selected {
            background: #fff7ed;
            border-left: 3px solid #f97316;
        }

        .dropdown-sugestoes .dropdown-item .empresa-nome {
            font-weight: 500;
            color: #333;
        }

        .dropdown-sugestoes .dropdown-item .empresa-cnpj {
            font-size: 11px;
            color: #888;
        }

        /* Valores Row */
        .orcamento-valores-row {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }

        .orcamento-valor-box {
            flex: 1;
            min-width: 140px;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .orcamento-valor-box label {
            font-size: 10px;
            color: #777;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .orcamento-valor-input {
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
            font-weight: 600;
            text-align: right;
            background: #fafafa;
            color: #333;
        }

        .orcamento-valor-input:focus {
            outline: none;
            border-color: var(--primary-orange);
            background: white;
        }

        .orcamento-valor-box.destaque .orcamento-valor-input,
        .orcamento-valor-input.destaque {
            background: #fff7ed;
            border-color: var(--primary-orange);
            color: var(--primary-orange);
            font-weight: 700;
        }

        /* Info Row */
        .orcamento-info-row {
            display: flex;
            gap: 16px;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid #eee;
            flex-wrap: wrap;
        }

        .orcamento-info-row .orcamento-field-group {
            flex: 1;
            min-width: 200px;
        }

        /* Tabs */
        .orcamento-tabs {
            display: flex;
            gap: 0;
            border-bottom: 1px solid #ddd;
            margin-bottom: 16px;
            overflow-x: auto;
            background: #fafafa;
            margin-left: -20px;
            margin-right: -20px;
            padding-left: 20px;
            padding-right: 20px;
        }

        .orcamento-tab {
            padding: 10px 16px;
            background: none;
            border: none;
            font-size: 11px;
            color: #555;
            cursor: pointer;
            position: relative;
            white-space: nowrap;
            transition: all 0.15s;
        }

        .orcamento-tab:hover {
            color: #333;
            background: rgba(0,0,0,0.03);
        }

        .orcamento-tab.active {
            color: var(--primary-orange);
            font-weight: 600;
            background: white;
        }

        .orcamento-tab.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--primary-orange);
        }

        /* Tab Content */
        .orcamento-tab-content {
            display: none;
        }

        .orcamento-tab-content.active {
            display: block;
        }

        .orcamento-tab-placeholder {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .orcamento-tab-placeholder i {
            font-size: 32px;
            margin-bottom: 12px;
            display: block;
        }

        /* ===========================================
           ESTILOS PARA ABA DE IMPOSTOS
           =========================================== */
        
        .imposto-input {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 12px;
            transition: all 0.15s;
        }

        .imposto-input:focus {
            outline: none;
            border-color: #f97316;
            box-shadow: 0 0 0 3px rgba(249, 115, 22, 0.1);
        }

        .imposto-input.valor {
            text-align: right;
            font-family: 'Consolas', 'Monaco', monospace;
        }

        .imposto-input.valor.destaque {
            font-weight: 600;
        }

        .imposto-input:disabled {
            background: #f3f4f6;
            color: #9ca3af;
            cursor: not-allowed;
        }

        .imposto-field {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .imposto-field label {
            font-size: 11px;
            color: #64748b;
            font-weight: 500;
        }

        /* Toggle Mini para checkboxes de impostos */
        .toggle-mini {
            position: relative;
            display: inline-block;
            width: 36px;
            height: 20px;
        }

        .toggle-mini input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider-mini {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #e2e8f0;
            transition: 0.3s;
            border-radius: 20px;
        }

        .toggle-slider-mini:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 2px;
            bottom: 2px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }

        .toggle-mini input:checked + .toggle-slider-mini {
            background: linear-gradient(135deg, #f97316, #ea580c);
        }

        .toggle-mini input:checked + .toggle-slider-mini:before {
            transform: translateX(16px);
        }

        /* Impostos Grid responsivo */
        .impostos-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
        }

        @media (max-width: 1200px) {
            .impostos-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 800px) {
            .impostos-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Card de Imposto com animação */
        .imposto-card {
            transition: all 0.2s ease;
        }

        .imposto-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

        /* Resumo de Impostos */
        .impostos-resumo .resumo-item {
            text-align: center;
        }

        .impostos-resumo .resumo-item span {
            display: block;
        }

        /* Itens Actions */
        .orcamento-itens-actions {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }

        .btn-orcamento-action {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 14px;
            border: none;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 500;
            cursor: pointer;
            color: white;
            transition: all 0.15s;
        }

        .btn-orcamento-action.verde {
            background: #22c55e;
        }

        .btn-orcamento-action.verde:hover {
            background: #16a34a;
        }

        .btn-orcamento-action.laranja {
            background: #f59e0b;
        }

        .btn-orcamento-action.laranja:hover {
            background: #d97706;
        }

        .btn-orcamento-action.vermelho {
            background: #ef4444;
        }

        .btn-orcamento-action.vermelho:hover {
            background: #dc2626;
        }

        /* Tabela de Orçamento */
        .orcamento-tabela-container {
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
            background: white;
            margin-bottom: 12px;
        }

        .orcamento-tabela {
            width: 100%;
            border-collapse: collapse;
            font-size: 11px;
        }

        .orcamento-tabela thead th {
            background: #fafafa;
            padding: 10px 12px;
            text-align: left;
            font-weight: 600;
            color: #555;
            border-bottom: 1px solid #e0e0e0;
            font-size: 10px;
            text-transform: uppercase;
        }

        .orcamento-tabela thead th i {
            color: #bbb;
            margin-left: 4px;
            font-size: 8px;
        }

        .orcamento-tabela thead tr.filter-row th {
            background: #f5f5f5;
            padding: 6px 8px;
        }

        .orcamento-tabela .filter-input {
            width: 100%;
            padding: 6px 8px;
            border: 1px solid #ddd;
            border-radius: 3px;
            font-size: 10px;
            background: white;
        }

        .orcamento-tabela tbody td {
            padding: 10px 12px;
            border-bottom: 1px solid #f0f0f0;
            color: #333;
        }

        .orcamento-tabela tbody tr:hover {
            background: #f9f9f9;
        }

        .orcamento-tabela tbody tr.selected {
            background: #fff7ed;
        }

        .orcamento-tabela-empty {
            text-align: center;
            padding: 40px;
            color: #999;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .orcamento-tabela-empty i {
            font-size: 28px;
            color: #ddd;
        }

        /* Paginação */
        .orcamento-paginacao {
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 11px;
            color: #777;
        }

        .paginacao-controls {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .pag-btn {
            padding: 5px 8px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 3px;
            font-size: 10px;
            color: #555;
            cursor: pointer;
        }

        .pag-btn:hover:not(:disabled) {
            background: #f5f5f5;
        }

        .pag-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .pag-current {
            background: var(--primary-orange);
            color: white;
            padding: 4px 8px;
            border-radius: 3px;
            font-weight: 600;
        }

        .pag-text {
            color: #999;
            font-size: 10px;
        }

        /* Textarea */
        .orcamento-textarea {
            width: 100%;
            min-height: 150px;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 12px;
            font-family: inherit;
            resize: vertical;
        }

        .orcamento-textarea:focus {
            outline: none;
            border-color: var(--primary-orange);
        }

        /* Frete Section */
        .orcamento-frete-section {
            padding: 10px 0;
        }

        /* Seção de Formulário Orçamento */
        .orcamento-section-form {
            padding: 10px 0;
        }

        .orcamento-form-row {
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
        }

        .orcamento-textarea {
            width: 100%;
            min-height: 100px;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 12px;
            font-family: inherit;
            resize: vertical;
            line-height: 1.5;
        }

        .orcamento-textarea:focus {
            outline: none;
            border-color: var(--primary-orange);
            box-shadow: 0 0 0 2px rgba(249, 115, 22, 0.1);
        }

        .field-hint {
            display: block;
            font-size: 10px;
            color: #888;
            margin-top: 4px;
        }

        /* Checkbox Label */
        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            font-size: 12px;
            color: #555;
        }

        .checkbox-label input[type="checkbox"] {
            width: 16px;
            height: 16px;
            accent-color: var(--primary-orange);
        }

        /* Status Badge */
        .status-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-badge.pendente {
            background: #fef3c7;
            color: #92400e;
        }

        .status-badge.pago {
            background: #d1fae5;
            color: #065f46;
        }

        .status-badge.vencido {
            background: #fee2e2;
            color: #991b1b;
        }

        /* Estilos originais mantidos para compatibilidade */
        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px 24px;
            border-bottom: 1px solid var(--border-color);
            background: var(--primary-dark);
            border-radius: 16px 16px 0 0;
        }

        .modal-header h2 {
            color: white;
            font-size: 18px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .modal-header h2 i {
            color: var(--primary-orange);
        }

        .modal-close {
            background: none;
            border: none;
            color: #8b8b9a;
            font-size: 24px;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .modal-close:hover {
            color: white;
            background: rgba(255, 255, 255, 0.1);
        }

        .modal-body {
            padding: 24px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px 14px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.2s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary-orange);
            box-shadow: 0 0 0 3px rgba(249, 115, 22, 0.1);
        }

        .form-group textarea {
            min-height: 80px;
            resize: vertical;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .form-row-3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 16px;
        }

        .modal-footer {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 12px;
            padding: 16px 24px;
            border-top: 1px solid var(--border-color);
            background: #f9f9f9;
            border-radius: 0 0 16px 16px;
        }

        .btn-modal {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-modal-cancel {
            background: #e5e5e5;
            color: var(--text-primary);
        }

        .btn-modal-cancel:hover {
            background: #d5d5d5;
        }

        .btn-modal-save {
            background: var(--primary-orange);
            color: white;
        }

        .btn-modal-save:hover {
            background: #ea580c;
        }

        .btn-modal-delete {
            background: var(--danger-red);
            color: white;
            margin-right: auto;
        }

        .btn-modal-delete:hover {
            background: #dc2626;
        }

        .info-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: #f0f9ff;
            color: #0369a1;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            margin-bottom: 20px;
        }

        /* Tab Content */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* ========================================
           ESTILOS DOS MODAIS AUXILIARES
           ======================================== */
        
        /* Área de Upload de Anexos */
        .anexos-upload-area {
            border: 2px dashed #d1d5db;
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            background: #f9fafb;
            transition: all 0.2s;
            cursor: pointer;
        }

        .anexos-upload-area:hover,
        .anexos-upload-area.dragover {
            border-color: #6366f1;
            background: #eef2ff;
        }

        .btn-upload-anexo {
            background: #6366f1;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 13px;
            cursor: pointer;
            margin-top: 15px;
            transition: all 0.2s;
        }

        .btn-upload-anexo:hover {
            background: #4f46e5;
        }

        .anexo-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .anexo-item i {
            font-size: 24px;
            color: #6366f1;
        }

        .anexo-info {
            flex: 1;
        }

        .anexo-nome {
            font-weight: 500;
            color: #333;
        }

        .anexo-tamanho {
            font-size: 12px;
            color: #888;
        }

        .anexo-actions button {
            background: none;
            border: none;
            color: #888;
            cursor: pointer;
            padding: 5px;
            transition: all 0.2s;
        }

        .anexo-actions button:hover {
            color: #333;
        }

        .anexo-actions button.delete:hover {
            color: #ef4444;
        }

        /* Timeline do Histórico */
        .historico-timeline {
            position: relative;
            padding-left: 30px;
        }

        .historico-timeline::before {
            content: '';
            position: absolute;
            left: 10px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: #e5e7eb;
        }

        .historico-item {
            position: relative;
            padding: 15px;
            margin-bottom: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 3px solid #8b5cf6;
        }

        .historico-item::before {
            content: '';
            position: absolute;
            left: -24px;
            top: 20px;
            width: 10px;
            height: 10px;
            background: #8b5cf6;
            border-radius: 50%;
            border: 2px solid white;
        }

        .historico-data {
            font-size: 11px;
            color: #888;
            margin-bottom: 5px;
        }

        .historico-usuario {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }

        .historico-descricao {
            font-size: 13px;
            color: #555;
        }

        /* Lista de Emails */
        .email-item {
            padding: 15px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            margin-bottom: 10px;
            transition: all 0.2s;
        }

        .email-item:hover {
            border-color: #0ea5e9;
            background: #f0f9ff;
        }

        .email-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .email-destinatario {
            font-weight: 600;
            color: #333;
        }

        .email-data {
            font-size: 12px;
            color: #888;
        }

        .email-assunto {
            font-size: 14px;
            color: #555;
            margin-bottom: 5px;
        }

        .email-status {
            font-size: 11px;
            padding: 3px 8px;
            border-radius: 10px;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .email-status.enviado {
            background: #dcfce7;
            color: #166534;
        }

        .email-status.lido {
            background: #dbeafe;
            color: #1e40af;
        }

        .btn-enviar-email {
            background: #0ea5e9;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-enviar-email:hover {
            background: #0284c7;
        }

        /* Lista de Tarefas */
        .nova-tarefa-form {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .input-tarefa {
            flex: 1;
            padding: 12px 15px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
        }

        .input-tarefa:focus {
            outline: none;
            border-color: #10b981;
        }

        .btn-add-tarefa {
            background: #10b981;
            color: white;
            border: none;
            width: 44px;
            height: 44px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-add-tarefa:hover {
            background: #059669;
        }

        .tarefa-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            margin-bottom: 8px;
            transition: all 0.2s;
        }

        .tarefa-item:hover {
            border-color: #10b981;
        }

        .tarefa-item.concluida {
            background: #f0fdf4;
            border-color: #86efac;
        }

        .tarefa-item.concluida .tarefa-texto {
            text-decoration: line-through;
            color: #888;
        }

        .tarefa-checkbox {
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: #10b981;
        }

        .tarefa-texto {
            flex: 1;
            font-size: 14px;
            color: #333;
        }

        .tarefa-delete {
            background: none;
            border: none;
            color: #888;
            cursor: pointer;
            padding: 5px;
        }

        .tarefa-delete:hover {
            color: #ef4444;
        }

        /* Opções de Impressão */
        .opcoes-impressao {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .opcao-impressao {
            cursor: pointer;
        }

        .opcao-impressao input {
            display: none;
        }

        .opcao-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            padding: 20px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            transition: all 0.2s;
        }

        .opcao-content i {
            font-size: 32px;
            color: #64748b;
        }

        .opcao-content span {
            font-size: 13px;
            color: #333;
            font-weight: 500;
        }

        .opcao-impressao input:checked + .opcao-content {
            border-color: #f97316;
            background: #fff7ed;
        }

        .opcao-impressao input:checked + .opcao-content i {
            color: #f97316;
        }

        /* Itens Pedido Parcial */
        .item-parcial {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 12px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .item-parcial-checkbox {
            width: 20px;
            height: 20px;
            accent-color: #f97316;
        }

        .item-parcial-info {
            flex: 1;
        }

        .item-parcial-nome {
            font-weight: 500;
            color: #333;
        }

        .item-parcial-qtd-original {
            font-size: 12px;
            color: #888;
        }

        .item-parcial-qtd-input {
            width: 100px;
            padding: 8px 10px;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            text-align: center;
        }

        /* Botões gerais */
        .btn-primary {
            background: var(--primary-orange);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 13px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
        }

        .btn-primary:hover {
            background: #ea580c;
        }

        .btn-secondary {
            background: #e5e7eb;
            color: #333;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-secondary:hover {
            background: #d1d5db;
        }

        /* Empty State para tabela */
        .empty-table-state {
            text-align: center;
            padding: 40px 20px;
            color: #999;
        }

        .empty-table-state i {
            font-size: 48px;
            margin-bottom: 12px;
            color: #ddd;
        }

        .empty-table-state p {
            font-size: 14px;
        }

        /* ========================================
           RESPONSIVO
           ======================================== */
        @media (max-width: 768px) {
            .sidebar {
                width: 48px;
            }

            .form-row,
            .form-row-3 {
                grid-template-columns: 1fr;
            }
            
            .kanban-column {
                width: 260px;
                min-width: 260px;
            }

            .search-box {
                width: 200px;
            }
        }

        /* ========================================
           MODAL FILTROS KANBAN (Estilo Omie)
           ======================================== */
        .modal-filtros-content {
            background: white;
            border-radius: 8px;
            width: 95%;
            max-width: 900px;
            max-height: 85vh;
            overflow: hidden;
            box-shadow: 0 20px 50px rgba(0,0,0,0.3);
            animation: modalSlideIn 0.2s ease;
        }

        .modal-filtros-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 24px;
            border-bottom: 1px solid #e5e5e5;
        }

        .modal-filtros-header h2 {
            font-size: 18px;
            font-weight: 600;
            color: #333;
        }

        .modal-filtros-header .close-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            background: #f3f4f6;
            border: 1px solid #e5e7eb;
            color: #374151;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            padding: 10px 18px;
            border-radius: 8px;
            transition: all 0.2s ease;
        }

        .modal-filtros-header .close-btn:hover {
            background: #fee2e2;
            border-color: #fca5a5;
            color: #dc2626;
        }

        .modal-filtros-header .close-btn i {
            font-size: 12px;
        }

        .modal-filtros-body {
            padding: 24px;
        }

        .filtros-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 24px;
        }

        .filtro-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .filtro-group label {
            font-size: 13px;
            font-weight: 500;
            color: #555;
        }

        .filtro-select {
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            color: #333;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
        }

        .filtro-select:focus {
            outline: none;
            border-color: #f97316;
            box-shadow: 0 0 0 3px rgba(249,115,22,0.1);
        }

        .filtros-row-2 {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 24px;
        }

        .filtro-input-search {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .filtro-input-search input {
            flex: 1;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }

        .filtro-input-search input:focus {
            outline: none;
            border-color: #f97316;
        }

        .filtro-input-search button {
            width: 40px;
            height: 40px;
            border: none;
            background: #f5f5f5;
            border-radius: 6px;
            cursor: pointer;
            color: #666;
            transition: all 0.2s;
        }

        .filtro-input-search button:hover {
            background: #f97316;
            color: white;
        }

        .filtros-toggles {
            display: flex;
            gap: 24px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }

        .toggle-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .toggle-switch {
            position: relative;
            width: 44px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: 0.3s;
            border-radius: 24px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
        }

        .toggle-switch input:checked + .toggle-slider {
            background-color: #f97316;
        }

        .toggle-switch input:checked + .toggle-slider:before {
            transform: translateX(20px);
        }

        .toggle-label {
            font-size: 13px;
            color: #555;
        }

        .filtros-info-box {
            background: #fff9e6;
            border: 1px solid #ffe58f;
            border-radius: 6px;
            padding: 16px;
            margin-bottom: 24px;
        }

        .filtros-info-box p {
            font-size: 13px;
            color: #7a5a00;
            line-height: 1.5;
        }

        .filtros-info-box strong {
            color: #b38600;
        }

        .modal-filtros-footer {
            display: flex;
            justify-content: center;
            gap: 16px;
            padding: 20px 24px;
            border-top: 1px solid #e5e5e5;
            background: #fafafa;
        }

        .btn-desfazer {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 32px;
            background: #f97316;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-desfazer:hover {
            background: #ea580c;
        }

        .btn-atualizar-filtro {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 32px;
            background: #10b981;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-atualizar-filtro:hover {
            background: #059669;
        }

        /* Modal Selecionar Vendedor */
        .modal-vendedor-content {
            background: white;
            border-radius: 8px;
            width: 95%;
            max-width: 700px;
            max-height: 80vh;
            overflow: hidden;
            box-shadow: 0 20px 50px rgba(0,0,0,0.3);
        }

        .vendedor-search-bar {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            border-bottom: 1px solid #e5e5e5;
            gap: 12px;
        }

        .vendedor-search-bar .filter-icon {
            width: 40px;
            height: 40px;
            background: #f97316;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }

        .vendedor-search-bar input {
            flex: 1;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            color: #f97316;
        }

        .vendedor-search-bar input::placeholder {
            color: #f97316;
        }

        .vendedor-search-bar .search-btn {
            width: 40px;
            height: 40px;
            background: #f97316;
            border: none;
            border-radius: 6px;
            color: white;
            cursor: pointer;
        }

        .vendedor-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .vendedor-item {
            padding: 14px 20px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
            color: #333;
        }

        .vendedor-item:hover {
            background: #f5f5f5;
        }

        .vendedor-item.selected {
            background: #fff7ed;
            color: #f97316;
            font-weight: 500;
        }

        .vendedor-item:nth-child(odd) {
            background: #fafafa;
        }

        .vendedor-item:nth-child(odd):hover {
            background: #f0f0f0;
        }

        /* ========================================
           MODAL CONFIRMAÇÃO ALTERAÇÕES
           ======================================== */
        .modal-confirm-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.4);
            z-index: 99999;
            justify-content: center;
            align-items: center;
        }

        .modal-confirm-overlay.active {
            display: flex;
        }

        .modal-confirm-content {
            background: white;
            border-radius: 12px;
            padding: 32px 48px;
            text-align: center;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            animation: modalSlideIn 0.2s ease;
            max-width: 400px;
            width: 90%;
            position: relative;
            z-index: 100000;
        }

        .modal-confirm-content h3 {
            font-size: 16px;
            font-weight: 500;
            color: #333;
            margin-bottom: 16px;
        }

        .modal-confirm-content .link-alteracoes {
            color: #14b8a6;
            font-size: 14px;
            text-decoration: none;
            cursor: pointer;
            display: block;
            margin-bottom: 24px;
        }

        .modal-confirm-content .link-alteracoes:hover {
            text-decoration: underline;
        }

        .modal-confirm-buttons {
            display: flex;
            justify-content: center;
            gap: 12px;
            position: relative;
            z-index: 100001;
        }

        .btn-confirm-sim {
            padding: 10px 32px;
            background: #e5e7eb;
            color: #333;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            pointer-events: auto;
        }

        .btn-confirm-sim:hover {
            background: #d1d5db;
        }

        .btn-confirm-nao {
            padding: 10px 32px;
            background: white;
            color: #14b8a6;
            border: 2px solid #14b8a6;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            pointer-events: auto;
        }

        .btn-confirm-nao:hover {
            background: #f0fdfa;
        }

        /* Lista de alterações */
        .alteracoes-lista {
            display: none;
            background: #f9fafb;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 20px;
            text-align: left;
            max-height: 200px;
            overflow-y: auto;
        }

        .alteracoes-lista.show {
            display: block;
        }

        .alteracoes-lista ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .alteracoes-lista li {
            font-size: 13px;
            color: #555;
            padding: 6px 0;
            border-bottom: 1px solid #e5e7eb;
        }

        .alteracoes-lista li:last-child {
            border-bottom: none;
        }

        .alteracoes-lista li i {
            color: #f97316;
            margin-right: 8px;
        }

        /* ========================================
           MODAL CONFIGURAÇÃO ETAPAS KANBAN
           ======================================== */
        .btn-config-etapas {
            border: 2px solid #f97316 !important;
            border-radius: 4px !important;
            margin-right: 8px;
        }

        .btn-config-etapas:hover {
            background: rgba(249,115,22,0.2) !important;
        }

        .modal-etapas-content {
            background: white;
            border-radius: 12px;
            width: 98%;
            max-width: 1100px;
            max-height: 90vh;
            overflow: hidden;
            box-shadow: 0 25px 60px rgba(0,0,0,0.3);
            animation: modalSlideIn 0.25s ease;
        }

        .modal-etapas-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 18px 28px;
            border-bottom: 2px solid #3b82f6;
            background: linear-gradient(135deg, #eff6ff 0%, #fff 100%);
        }

        .modal-etapas-header h2 {
            font-size: 20px;
            font-weight: 600;
            color: #3b82f6;
            display: flex;
            align-items: center;
        }

        .modal-etapas-header .close-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            background: #f3f4f6;
            border: 1px solid #e5e7eb;
            color: #374151;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            padding: 10px 18px;
            border-radius: 8px;
            transition: all 0.2s ease;
        }

        .modal-etapas-header .close-btn:hover {
            background: #fee2e2;
            border-color: #fca5a5;
            color: #dc2626;
        }

        .modal-etapas-header .close-btn i {
            font-size: 12px;
        }

        .modal-etapas-body {
            padding: 28px;
            max-height: calc(90vh - 180px);
            overflow-y: auto;
        }

        .modal-etapas-body > p {
            font-size: 14px;
            color: #555;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px dashed #e5e5e5;
        }

        /* Container de etapas dinâmico */
        .etapas-container {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            margin-bottom: 20px;
            padding: 16px;
            background: #fafafa;
            border-radius: 10px;
            border: 1px solid #e5e5e5;
            min-height: 100px;
        }

        .etapa-item {
            display: flex;
            flex-direction: column;
            gap: 6px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 12px;
            min-width: 150px;
            max-width: 180px;
            flex: 1 1 150px;
            position: relative;
            transition: all 0.2s ease;
            cursor: grab;
        }

        .etapa-item:hover {
            border-color: #3b82f6;
            box-shadow: 0 4px 12px rgba(59,130,246,0.15);
            transform: translateY(-2px);
        }

        .etapa-item.dragging {
            opacity: 0.6;
            transform: scale(1.02);
            box-shadow: 0 8px 20px rgba(0,0,0,0.2);
        }

        .etapa-item.drag-over {
            border-color: #22c55e;
            background: #f0fdf4;
        }

        .etapa-item-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 4px;
        }

        .etapa-item-number {
            font-size: 11px;
            font-weight: 600;
            color: #3b82f6;
            background: #eff6ff;
            padding: 2px 8px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .etapa-item-number i {
            font-size: 10px;
            cursor: grab;
        }

        .etapa-item-actions {
            display: flex;
            gap: 4px;
        }

        .etapa-item-actions button {
            width: 22px;
            height: 22px;
            border: none;
            background: #f5f5f5;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            color: #888;
            transition: all 0.15s;
        }

        .etapa-item-actions button:hover {
            background: #fee2e2;
            color: #dc2626;
        }

        .etapa-item-actions button.btn-mover:hover {
            background: #dbeafe;
            color: #2563eb;
        }

        .etapa-item input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #e5e5e5;
            border-radius: 6px;
            font-size: 13px;
            color: #333;
            background: #fafafa;
            transition: all 0.2s;
        }

        .etapa-item input:focus {
            outline: none;
            border-color: #3b82f6;
            background: white;
            box-shadow: 0 0 0 3px rgba(59,130,246,0.1);
        }

        .etapa-item.etapa-destaque {
            background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
            border-color: #60a5fa;
        }

        .etapa-item.etapa-destaque input {
            background: white;
            border-color: #60a5fa;
        }

        /* Ações de etapas */
        .etapas-actions {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .btn-adicionar-etapa {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 24px;
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 2px 8px rgba(34,197,94,0.3);
        }

        .btn-adicionar-etapa:hover {
            background: linear-gradient(135deg, #16a34a 0%, #15803d 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(34,197,94,0.4);
        }

        .btn-adicionar-etapa i {
            font-size: 16px;
        }

        .etapas-counter {
            font-size: 13px;
            color: #888;
            font-style: italic;
        }

        .etapas-info-box {
            background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
            border: 1px solid #86efac;
            border-radius: 10px;
            padding: 16px 20px;
            margin-bottom: 0;
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }

        .etapas-info-box i {
            color: #22c55e;
            font-size: 18px;
            margin-top: 1px;
        }

        .etapas-info-box p {
            font-size: 13px;
            color: #166534;
            line-height: 1.6;
            margin: 0;
        }

        .modal-etapas-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 18px 28px;
            border-top: 1px solid #e5e5e5;
            background: #f8fafc;
        }

        .alterar-numeracao {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 13px;
            color: #555;
        }

        .alterar-numeracao .checkbox-container {
            position: relative;
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .alterar-numeracao .checkbox-container input {
            position: absolute;
            opacity: 0;
            cursor: pointer;
            height: 0;
            width: 0;
        }

        .alterar-numeracao .checkmark {
            position: absolute;
            top: 0;
            left: 0;
            height: 20px;
            width: 20px;
            background-color: #fff;
            border: 2px solid #ddd;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .alterar-numeracao .checkbox-container:hover input ~ .checkmark {
            border-color: #f97316;
        }

        .alterar-numeracao .checkbox-container input:checked ~ .checkmark {
            background-color: #f97316;
            border-color: #f97316;
        }

        .alterar-numeracao .checkmark:after {
            content: "";
            position: absolute;
            display: none;
        }

        .alterar-numeracao .checkbox-container input:checked ~ .checkmark:after {
            display: block;
        }

        .alterar-numeracao .checkbox-container .checkmark:after {
            left: 6px;
            top: 2px;
            width: 5px;
            height: 10px;
            border: solid white;
            border-width: 0 2px 2px 0;
            transform: rotate(45deg);
        }

        .alterar-numeracao i {
            color: #3b82f6;
        }

        .alterar-numeracao strong {
            color: #3b82f6;
        }

        .modal-etapas-buttons {
            display: flex;
            gap: 12px;
        }

        .btn-cancelar-etapas {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 24px;
            background: #f5f5f5;
            color: #666;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-cancelar-etapas:hover {
            background: #fee2e2;
            border-color: #fca5a5;
            color: #dc2626;
        }

        .btn-confirmar-etapas {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 32px;
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 2px 8px rgba(34,197,94,0.3);
        }

        .btn-confirmar-etapas:hover {
            background: linear-gradient(135deg, #16a34a 0%, #15803d 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(34,197,94,0.4);
        }

        @media (max-width: 768px) {
            .etapas-container {
                flex-direction: column;
            }
            
            .etapa-item {
                max-width: 100%;
            }
            
            .modal-etapas-footer {
                flex-direction: column;
                gap: 16px;
            }
            
            .alterar-numeracao {
                text-align: center;
            }
        }
    </style>
    <script src="/js/anti-copy-protection.js"></script>
    <link rel="stylesheet" href="/css/popup-confirmacao.css">`n</head>
<body>
    <div class="app-container">
        <!-- Sidebar Lateral -->
        <aside class="sidebar">
            <a href="/dashboard" class="sidebar-logo" title="Voltar ao Painel">
                <i class="fas fa-home"></i>
            </a>
            
            <nav class="sidebar-nav">
                <button class="sidebar-btn active" title="Kanban" onclick="window.location.href='index.html'">
                    <i class="fas fa-columns"></i>
                </button>
                <button class="sidebar-btn" title="Pedidos" onclick="window.location.href='pedidos.html'">
                    <i class="fas fa-clipboard-list"></i>
                </button>
                <button class="sidebar-btn" title="Clientes" onclick="window.location.href='clientes.html'">
                    <i class="fas fa-users"></i>
                </button>
                <button class="sidebar-btn" title="Estoque" onclick="window.location.href='estoque.html'">
                    <i class="fas fa-boxes-stacked"></i>
                </button>
                <button class="sidebar-btn" title="Meu Dashboard" onclick="window.location.href='dashboard.html'">
                    <i class="fas fa-chart-pie"></i>
                </button>
                <button class="sidebar-btn" title="Gestão de Vendas" onclick="window.location.href='dashboard-admin.html'">
                    <i class="fas fa-chart-line"></i>
                </button>
                <button class="sidebar-btn" title="Relatórios" onclick="window.location.href='relatorios.html'">
                    <i class="fas fa-chart-bar"></i>
                </button>
            </nav>

            <div class="sidebar-bottom">
                <button class="sidebar-btn" title="Configurações">
                    <i class="fas fa-cog"></i>
                </button>
            </div>
        </aside>

        <!-- Main Area -->
        <main class="main-area">
            <!-- Header -->
            <header class="header">
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
                <div class="header-left">
                    <div class="header-brand">
                        <img src="/images/Logo Monocromatico - Branco - Aluforce.png" alt="ALUFORCE">
                        <span>|</span>
                        <span>Vendas</span>
                    </div>
                </div>
                <div class="header-right">
                    <button class="header-btn btn-config-etapas" title="Configurar Etapas do Kanban" onclick="abrirModalEtapas()">
                        <i class="fas fa-cog"></i>
                    </button>
                    <div class="notification-container">
                        <button class="header-btn notification-btn" title="Notificações" onclick="toggleNotificacoes()">
                            <i class="fas fa-bell"></i>
                            <span class="notification-badge" id="notification-count">3</span>
                        </button>
                        <div class="notification-panel" id="notification-panel">
                            <div class="notification-header">
                                <h3><i class="fas fa-bell"></i> Notificações</h3>
                                <div class="notification-actions">
                                    <button onclick="marcarTodasLidas()" title="Marcar todas como lidas">
                                        <i class="fas fa-check-double"></i>
                                    </button>
                                    <button onclick="limparNotificacoes()" title="Limpar todas">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="notification-tabs">
                                <button class="notif-tab active" onclick="filtrarNotificacoes('todas', this)">Todas</button>
                                <button class="notif-tab" onclick="filtrarNotificacoes('nao-lidas', this)">Não lidas</button>
                                <button class="notif-tab" onclick="filtrarNotificacoes('importantes', this)">Importantes</button>
                            </div>
                            <div class="notification-list" id="notification-list">
                                <!-- Notificações serão inseridas via JavaScript -->
                            </div>
                            <div class="notification-footer">
                                <a href="#" onclick="verTodasNotificacoes(); return false;">Ver histórico completo</a>
                            </div>
                        </div>
                    </div>
                    <div class="user-greeting">
                        <span><span id="greeting-text">Bom dia</span>, <strong id="user-name">Usuário</strong></span>
                        <div class="user-avatar" id="user-avatar">
                            <img src="" alt="Foto do usuário" id="user-photo">
                            <span id="user-initial">U</span>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Tabs removidas conforme solicitação -->

            <!-- Barra de Ações Rápidas -->
            <div class="quick-actions-bar" style="display: flex; align-items: center; gap: 12px; padding: 12px 20px; background: #f8fafc; border-bottom: 1px solid #e2e8f0;">
                <button class="btn-action-primary" onclick="abrirModalNovoPedido()" style="display: flex; align-items: center; gap: 8px; padding: 10px 20px; background: linear-gradient(135deg, #10b981, #059669); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3); transition: all 0.2s;">
                    <i class="fas fa-plus"></i>
                    <span>Novo Pedido</span>
                </button>
                <button class="btn-action-secondary" onclick="abrirModalNovoCliente()" style="display: flex; align-items: center; gap: 8px; padding: 10px 16px; background: white; color: #475569; border: 1px solid #e2e8f0; border-radius: 8px; font-weight: 500; cursor: pointer; transition: all 0.2s;">
                    <i class="fas fa-user-plus"></i>
                    <span>Novo Cliente</span>
                </button>
                <button class="btn-action-secondary" onclick="abrirModalNovoProduto()" style="display: flex; align-items: center; gap: 8px; padding: 10px 16px; background: white; color: #475569; border: 1px solid #e2e8f0; border-radius: 8px; font-weight: 500; cursor: pointer; transition: all 0.2s;">
                    <i class="fas fa-box-open"></i>
                    <span>Novo Produto</span>
                </button>
                <div style="flex: 1;"></div>
                <button class="btn-action-icon" onclick="abrirModalExportar()" title="Exportar Dados" style="display: flex; align-items: center; justify-content: center; width: 40px; height: 40px; background: white; color: #475569; border: 1px solid #e2e8f0; border-radius: 8px; cursor: pointer; transition: all 0.2s;">
                    <i class="fas fa-download"></i>
                </button>
            </div>

            <!-- Filtros -->
            <div class="filters-bar">
                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" placeholder="Digite o que deseja pesquisar" id="search-input">
                </div>
                <a class="filter-link" id="filter-toggle">Exibindo tudo</a>
            </div>

            <!-- Kanban Board -->
            <div class="kanban-container">
                <div class="kanban-board" id="kanban-board">
                    
                    <!-- Coluna: Orçamento -->
                    <div class="kanban-column" data-status="orcamento">
                        <div class="kanban-column-header">
                            <div>
                                <div class="column-title">Orçamento</div>
                                <div class="column-count" id="count-orcamento">Carregando...</div>
                            </div>
                            <div class="column-indicator orcamento"></div>
                        </div>
                        <div class="kanban-column-content" id="col-orcamento">
                            <!-- Cards serão inseridos aqui -->
                        </div>
                        <div class="kanban-column-footer">
                            <button class="btn-new-card" onclick="novoOrcamento()">
                                <i class="fas fa-plus"></i> Novo Orçamento
                            </button>
                        </div>
                    </div>

                    <!-- Coluna: Análise de Crédito -->
                    <div class="kanban-column" data-status="analise">
                        <div class="kanban-column-header">
                            <div>
                                <div class="column-title">Análise de Crédito</div>
                                <div class="column-count" id="count-analise">12 registros</div>
                            </div>
                            <div class="column-indicator analise"></div>
                        </div>
                        <div class="kanban-column-content" id="col-analise">
                            <!-- Cards -->
                        </div>
                    </div>

                    <!-- Coluna: Pedido Aprovado -->
                    <div class="kanban-column" data-status="aprovado">
                        <div class="kanban-column-header">
                            <div>
                                <div class="column-title">Pedido Aprovado</div>
                                <div class="column-count" id="count-aprovado">5 registros</div>
                            </div>
                            <div class="column-indicator aprovado"></div>
                        </div>
                        <div class="kanban-column-content" id="col-aprovado">
                            <!-- Cards -->
                        </div>
                    </div>

                    <!-- Coluna: Faturar -->
                    <div class="kanban-column" data-status="faturar">
                        <div class="kanban-column-header">
                            <div>
                                <div class="column-title">Faturar</div>
                                <div class="column-count" id="count-faturar">23 registros</div>
                            </div>
                            <div class="column-indicator faturar"></div>
                        </div>
                        <div class="kanban-column-content" id="col-faturar">
                            <!-- Cards -->
                        </div>
                        <div class="kanban-column-footer">
                            <button class="btn-action-card" onclick="faturarTodos()">
                                <i class="fas fa-bolt"></i> Faturar Todos
                            </button>
                        </div>
                    </div>

                    <!-- Coluna: Faturado -->
                    <div class="kanban-column" data-status="faturado">
                        <div class="kanban-column-header">
                            <div>
                                <div class="column-title">Faturado</div>
                                <div class="column-count" id="count-faturado">52 registros</div>
                            </div>
                            <div class="column-indicator faturado"></div>
                        </div>
                        <div class="kanban-column-content" id="col-faturado">
                            <!-- Cards -->
                        </div>
                        <div class="kanban-column-footer">
                            <button class="btn-action-card teal" onclick="comunicarSefaz()">
                                <i class="fas fa-sync"></i> Comunicar com a SEFAZ
                            </button>
                        </div>
                    </div>

                    <!-- Coluna: Recibo -->
                    <div class="kanban-column" data-status="recibo">
                        <div class="kanban-column-header">
                            <div>
                                <div class="column-title">Recibo</div>
                                <div class="column-count" id="count-recibo">Nenhum registro</div>
                            </div>
                            <div class="column-indicator recibo"></div>
                        </div>
                        <div class="kanban-column-content" id="col-recibo">
                            <div class="empty-column">
                                <i class="fas fa-receipt"></i>
                                <p>Nenhum recibo pendente</p>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </main>
    </div>

    <!-- Modal Editar Pedido -->
    <!-- Modal Editar Pedido - Estilo Omie Profissional -->
    <div class="modal-overlay" id="modal-editar-pedido">
        <div class="modal-content-omie">
            <!-- Header -->
            <div class="modal-header-omie">
                <h2 id="modal-titulo-pedido">Orçamento Nº 233</h2>
                <button class="close-btn" onclick="fecharModalEditar()">
                    Fechar <i class="fas fa-times"></i>
                </button>
            </div>

            <!-- Container Principal -->
            <div class="modal-container-omie">
                <!-- Área de Conteúdo Principal -->
                <div class="modal-main-content">
                    <!-- Seção do Cliente -->
                    <div class="cliente-section">
                        <div class="cliente-avatar" id="modal-cliente-avatar">IE</div>
                        <div class="cliente-info">
                            <div class="cliente-info-header">
                                <label style="font-size: 11px; color: #888; margin-bottom: 0;">Cliente <i class="fas fa-external-link-alt" style="font-size: 9px;"></i></label>
                            </div>
                            <div style="display: flex; gap: 12px; align-items: center; margin-bottom: 12px;">
                                <input type="text" class="cliente-nome-input" id="edit-cliente" placeholder="Nome do cliente" style="flex: 1;">
                                <button type="button" class="btn-consulta-credito">
                                    <i class="fas fa-search"></i> Consulta de Crédito
                                </button>
                                <div class="previsao-faturamento">
                                    <span class="previsao-label">Previsão de Faturamento</span>
                                    <div class="previsao-badge"><i class="fas fa-exclamation" style="font-size: 8px;"></i></div>
                                    <input type="date" class="previsao-input" id="edit-previsao-faturamento">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Grid de Valores -->
                    <div class="valores-grid">
                        <div class="valor-item">
                            <label class="valor-label">Total de Mercadorias</label>
                            <input type="text" class="valor-input" id="edit-total-mercadorias" value="0,00" readonly>
                        </div>
                        <div class="valor-item">
                            <label class="valor-label">Valor do Desconto <i class="fas fa-pen" style="font-size: 9px;"></i></label>
                            <input type="text" class="valor-input" id="edit-desconto" value="0,00">
                        </div>
                        <div class="valor-item">
                            <label class="valor-label">Total de IPI</label>
                            <input type="text" class="valor-input" id="edit-ipi" value="0,00" readonly>
                        </div>
                        <div class="valor-item">
                            <label class="valor-label">Total de ICMS ST</label>
                            <input type="text" class="valor-input" id="edit-icms-st" value="0,00" readonly>
                        </div>
                        <div class="valor-item">
                            <label class="valor-label">Valor Total do Pedido</label>
                            <input type="text" class="valor-input highlight" id="edit-valor-total" value="0,00" readonly>
                        </div>
                    </div>

                    <!-- Linha de Vendedor, Parcelas, Cenário -->
                    <div class="info-row">
                        <div class="info-field">
                            <label>Vendedor +</label>
                            <select id="edit-vendedor">
                                <option value="">Selecione o vendedor...</option>
                                <option value="Augusto Ladeira dos Santos">Augusto Ladeira</option>
                                <option value="Renata Maria Batista do Nascimento">Renata Nascimento</option>
                                <option value="Marcia Oliveira do Nascimento Scarcella">Marcia Scarcella</option>
                                <option value="Fabiano Marques de Oliveira">Fabiano Marques</option>
                                <option value="Andreia">Andreia</option>
                                <option value="Fabiola de Souza Santos">Fabiola Souza</option>
                            </select>
                        </div>
                        <div class="info-field">
                            <label>Número de Parcelas <i class="fas fa-pen" style="font-size: 9px;"></i> +</label>
                            <input type="text" id="edit-parcelas" value="28/35/42/49">
                        </div>
                        <div class="info-field">
                            <label>Cenário Fiscal</label>
                            <select id="edit-cenario-fiscal">
                                <option value="Padrão">Padrão</option>
                                <option value="Simples Nacional">Simples Nacional</option>
                                <option value="Lucro Presumido">Lucro Presumido</option>
                                <option value="Lucro Real">Lucro Real</option>
                            </select>
                        </div>
                        <button type="button" class="btn-atualizar-impostos">
                            <i class="fas fa-sync-alt"></i> Atualizar os impostos dos itens
                        </button>
                    </div>

                    <!-- Tabs -->
                    <div class="modal-tabs">
                        <button class="modal-tab active" data-tab="itens" onclick="switchModalTab('itens')">Itens da Venda</button>
                        <button class="modal-tab" data-tab="departamentos" onclick="switchModalTab('departamentos')">Departamentos</button>
                        <button class="modal-tab" data-tab="frete" onclick="switchModalTab('frete')">Frete e Outras Despesas</button>
                        <button class="modal-tab" data-tab="informacoes" onclick="switchModalTab('informacoes')">Informações Adicionais</button>
                        <button class="modal-tab" data-tab="parcelas" onclick="switchModalTab('parcelas')">Parcelas</button>
                        <button class="modal-tab" data-tab="observacoes" onclick="switchModalTab('observacoes')">Observações</button>
                        <button class="modal-tab" data-tab="email" onclick="switchModalTab('email')">E-mail para o Cliente</button>
                    </div>

                    <!-- Tab Content: Itens da Venda -->
                    <div class="tab-content active" id="tab-itens">
                        <!-- Botões de Ação -->
                        <div class="table-actions">
                            <button type="button" class="btn-table-action success" onclick="adicionarItem()">
                                <i class="fas fa-plus"></i> Novo Item
                            </button>
                            <button type="button" class="btn-table-action warning" onclick="editarItemSelecionado()">
                                <i class="fas fa-pen"></i> Editar Item
                            </button>
                            <button type="button" class="btn-table-action danger" onclick="excluirItemSelecionado()">
                                <i class="fas fa-trash"></i> Excluir Item
                            </button>
                        </div>

                        <!-- Tabela de Itens -->
                        <div class="items-table-container">
                            <table class="items-table">
                                <thead>
                                    <tr>
                                        <th>Produto <i class="fas fa-sort filter-icon"></i></th>
                                        <th>Descrição do Produto</th>
                                        <th>Quantidade</th>
                                        <th>Quantidade (Parcial)</th>
                                        <th>Local de Estoque</th>
                                        <th>Preço Unitário</th>
                                    </tr>
                                </thead>
                                <tbody id="itens-pedido-tbody">
                                    <tr>
                                        <td class="produto-code">ITEM001</td>
                                        <td class="produto-desc">AL CONESUL VALVULAS INDUST...</td>
                                        <td>1.000 M</td>
                                        <td>0 M</td>
                                        <td>PADRAO - Local de Estoque Padrão</td>
                                        <td>R$ 11.540,00</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- Paginação -->
                        <div class="table-pagination">
                            <span class="pagination-info" id="pagination-info">1 - 1 de 1 registros</span>
                            <div class="pagination-controls">
                                <button class="pagination-btn" disabled><i class="fas fa-angle-double-left"></i></button>
                                <button class="pagination-btn" disabled><i class="fas fa-angle-left"></i> anterior</button>
                                <span class="pagination-current">1</span>
                                <button class="pagination-btn" disabled>próximo <i class="fas fa-angle-right"></i></button>
                                <button class="pagination-btn" disabled><i class="fas fa-angle-double-right"></i></button>
                            </div>
                        </div>
                    </div>

                    <!-- Tab Content: Departamentos -->
                    <div class="tab-content" id="tab-departamentos">
                        <div class="empty-table-state">
                            <i class="fas fa-building"></i>
                            <p>Nenhum departamento configurado</p>
                        </div>
                    </div>

                    <!-- Tab Content: Frete -->
                    <div class="tab-content" id="tab-frete">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Transportadora</label>
                                <input type="text" id="edit-transportadora" placeholder="Nome da transportadora">
                            </div>
                            <div class="form-group">
                                <label>Tipo de Frete</label>
                                <select id="edit-tipo-frete">
                                    <option value="CIF">CIF - Por conta do remetente</option>
                                    <option value="FOB">FOB - Por conta do destinatário</option>
                                    <option value="Terceiros">Por conta de terceiros</option>
                                    <option value="Proprio-Remetente">Próprio por conta do remetente</option>
                                    <option value="Proprio-Destinatario">Próprio por conta do destinatário</option>
                                    <option value="Sem-Frete">Sem frete</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Valor do Frete (R$)</label>
                                <input type="number" id="edit-valor-frete" step="0.01" placeholder="0,00">
                            </div>
                            <div class="form-group">
                                <label>Outras Despesas (R$)</label>
                                <input type="number" id="edit-outras-despesas" step="0.01" placeholder="0,00">
                            </div>
                        </div>
                    </div>

                    <!-- Tab Content: Informações Adicionais -->
                    <div class="tab-content" id="tab-informacoes">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Nota Fiscal</label>
                                <input type="text" id="edit-nf" placeholder="Número da NF">
                            </div>
                            <div class="form-group">
                                <label>Origem</label>
                                <select id="edit-origem">
                                    <option value="Omie">Omie</option>
                                    <option value="Sistema">Sistema</option>
                                    <option value="Manual">Manual</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Informações Complementares</label>
                            <textarea id="edit-info-complementar" placeholder="Informações adicionais para a nota fiscal..." style="min-height: 100px;"></textarea>
                        </div>
                    </div>

                    <!-- Tab Content: Parcelas -->
                    <div class="tab-content" id="tab-parcelas">
                        <div class="form-group">
                            <label>Condição de Pagamento</label>
                            <select id="edit-condicao-pagamento">
                                <option value="a vista">À Vista</option>
                                <option value="28/35/42/49">28/35/42/49 dias</option>
                                <option value="30/60">30/60 dias</option>
                                <option value="30/60/90">30/60/90 dias</option>
                                <option value="30/60/90/120">30/60/90/120 dias</option>
                            </select>
                        </div>
                        <div class="items-table-container">
                            <table class="items-table">
                                <thead>
                                    <tr>
                                        <th>Parcela</th>
                                        <th>Vencimento</th>
                                        <th>Valor</th>
                                        <th>Forma de Pagamento</th>
                                    </tr>
                                </thead>
                                <tbody id="parcelas-tbody">
                                    <tr>
                                        <td>1/4</td>
                                        <td>14/01/2026</td>
                                        <td>R$ 20.195,00</td>
                                        <td>Boleto</td>
                                    </tr>
                                    <tr>
                                        <td>2/4</td>
                                        <td>21/01/2026</td>
                                        <td>R$ 20.195,00</td>
                                        <td>Boleto</td>
                                    </tr>
                                    <tr>
                                        <td>3/4</td>
                                        <td>28/01/2026</td>
                                        <td>R$ 20.195,00</td>
                                        <td>Boleto</td>
                                    </tr>
                                    <tr>
                                        <td>4/4</td>
                                        <td>04/02/2026</td>
                                        <td>R$ 20.195,00</td>
                                        <td>Boleto</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Tab Content: Observações -->
                    <div class="tab-content" id="tab-observacoes">
                        <div class="form-group">
                            <label>Observações Internas</label>
                            <textarea id="edit-observacoes" placeholder="Observações internas (não aparecem na NF)..." style="min-height: 120px;"></textarea>
                        </div>
                        <div class="form-group">
                            <label>Observações para o Cliente</label>
                            <textarea id="edit-observacoes-cliente" placeholder="Observações que aparecerão para o cliente..." style="min-height: 120px;"></textarea>
                        </div>
                    </div>

                    <!-- Tab Content: E-mail -->
                    <div class="tab-content" id="tab-email">
                        <div class="form-group">
                            <label>E-mail do Cliente</label>
                            <input type="email" id="edit-email-cliente" placeholder="email@cliente.com.br">
                        </div>
                        <div class="form-group">
                            <label>Assunto</label>
                            <input type="text" id="edit-email-assunto" placeholder="Orçamento Nº 233 - ALUFORCE">
                        </div>
                        <div class="form-group">
                            <label>Mensagem</label>
                            <textarea id="edit-email-mensagem" placeholder="Mensagem personalizada para o cliente..." style="min-height: 120px;"></textarea>
                        </div>
                        <button type="button" class="btn-table-action success" style="margin-top: 12px;">
                            <i class="fas fa-paper-plane"></i> Enviar E-mail
                        </button>
                    </div>

                    <!-- Alerta de Status -->
                    <div class="status-alert warning" id="status-alert">
                        <i class="fas fa-exclamation-circle"></i>
                        <span id="status-alert-text">Faturamento atrasado</span>
                    </div>

                    <!-- Campo oculto para ID -->
                    <input type="hidden" id="edit-pedido-id">
                </div>

                <!-- Sidebar de Ações -->
                <div class="modal-sidebar-actions">
                    <button class="sidebar-action-btn primary" onclick="salvarPedido()">
                        <i class="fas fa-save"></i> Salvar
                    </button>
                    <button class="sidebar-action-btn" onclick="incluirPedido()">
                        <i class="fas fa-plus-circle"></i> Incluir
                    </button>
                    <button class="sidebar-action-btn" onclick="imprimirPedido()">
                        <i class="fas fa-print"></i> Imprimir
                    </button>
                    <button class="sidebar-action-btn" onclick="duplicarPedido()">
                        <i class="fas fa-copy"></i> Duplicar
                    </button>
                    <button class="sidebar-action-btn" onclick="conferirPedido()">
                        <i class="fas fa-check-circle"></i> Conferir
                    </button>
                    <button class="sidebar-action-btn btn-faturar" onclick="faturarPedido()">
                        <i class="fas fa-file-invoice-dollar"></i> Faturar Agora
                    </button>
                    
                    <div class="sidebar-divider"></div>
                    
                    <button class="sidebar-action-btn" onclick="verAnexos()">
                        <i class="fas fa-paperclip"></i> Anexos
                    </button>
                    <button class="sidebar-action-btn" onclick="verEmailsEnviados()">
                        <i class="fas fa-envelope"></i> Emails Enviados
                    </button>
                    <button class="sidebar-action-btn" onclick="verHistorico()">
                        <i class="fas fa-history"></i> Histórico de Alterações
                    </button>
                    <button class="sidebar-action-btn" onclick="verTarefas()">
                        <i class="fas fa-tasks"></i> Tarefas
                    </button>
                    
                    <button class="sidebar-action-btn outline-primary" onclick="pedidoParcial()">
                        <i class="fas fa-random"></i> Pedido Parcial
                    </button>
                    
                    <div class="sidebar-divider"></div>
                    
                    <button class="sidebar-action-btn danger" onclick="excluirPedido()">
                        <i class="fas fa-trash"></i> Excluir
                    </button>
                    <button class="sidebar-action-btn danger" onclick="cancelarPedido()">
                        <i class="fas fa-ban"></i> Cancelar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Anexos -->
    <div class="modal-overlay" id="modal-anexos">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #6366f1, #4f46e5);">
                <h2><i class="fas fa-paperclip"></i> Anexos do Pedido</h2>
                <button class="modal-close" onclick="fecharModalAnexos()"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <div class="anexos-upload-area" id="anexos-upload-area">
                    <i class="fas fa-cloud-upload-alt" style="font-size: 48px; color: #6366f1; margin-bottom: 10px;"></i>
                    <p style="color: #666;">Arraste arquivos aqui ou clique para selecionar</p>
                    <input type="file" id="input-anexo" multiple style="display: none;" onchange="processarAnexos(this.files)">
                    <button type="button" class="btn-upload-anexo" onclick="document.getElementById('input-anexo').click()">
                        <i class="fas fa-folder-open"></i> Selecionar Arquivos
                    </button>
                </div>
                <div class="anexos-lista" id="anexos-lista">
                    <h4 style="margin: 15px 0 10px; color: #333;">Arquivos Anexados</h4>
                    <div id="lista-anexos-container">
                        <p style="color: #888; font-size: 13px;">Nenhum anexo encontrado para este pedido.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Histórico de Alterações - Profissional -->
    <div class="modal-overlay" id="modal-historico">
        <div class="modal-historico-content">
            <div class="modal-historico-header">
                <h2><i class="fas fa-history"></i> Histórico de Alterações</h2>
                <button class="close-btn" onclick="fecharModalHistorico()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-historico-body">
                <div class="historico-timeline-pro" id="historico-timeline">
                    <!-- Será preenchido dinamicamente -->
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Emails Enviados -->
    <div class="modal-overlay" id="modal-emails">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #0ea5e9, #0284c7);">
                <h2><i class="fas fa-envelope"></i> Emails Enviados</h2>
                <button class="modal-close" onclick="fecharModalEmails()"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <div class="emails-lista" id="emails-lista">
                    <!-- Será preenchido dinamicamente -->
                </div>
                <div style="margin-top: 15px; text-align: right;">
                    <button type="button" class="btn-enviar-email" onclick="abrirEnviarEmail()">
                        <i class="fas fa-paper-plane"></i> Enviar Novo Email
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Tarefas -->
    <div class="modal-overlay" id="modal-tarefas">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #10b981, #059669);">
                <h2><i class="fas fa-tasks"></i> Tarefas do Pedido</h2>
                <button class="modal-close" onclick="fecharModalTarefas()"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <div class="nova-tarefa-form">
                    <input type="text" id="input-nova-tarefa" placeholder="Adicionar nova tarefa..." class="input-tarefa">
                    <button type="button" class="btn-add-tarefa" onclick="adicionarTarefa()">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
                <div class="tarefas-lista" id="tarefas-lista">
                    <!-- Será preenchido dinamicamente -->
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Pedido Parcial -->
    <div class="modal-overlay" id="modal-pedido-parcial">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #f97316, #ea580c);">
                <h2><i class="fas fa-random"></i> Pedido Parcial</h2>
                <button class="modal-close" onclick="fecharModalPedidoParcial()"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <p style="color: #666; margin-bottom: 15px;">Selecione os itens que deseja faturar parcialmente:</p>
                <div class="itens-parcial-lista" id="itens-parcial-lista">
                    <!-- Será preenchido com itens do pedido -->
                </div>
                <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: flex-end;">
                    <button type="button" class="btn-secondary" onclick="fecharModalPedidoParcial()">Cancelar</button>
                    <button type="button" class="btn-primary" onclick="gerarPedidoParcial()">
                        <i class="fas fa-check"></i> Gerar Pedido Parcial
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Imprimir -->
    <div class="modal-overlay" id="modal-imprimir">
        <div class="modal-content" style="max-width: 420px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #f97316, #ea580c);">
                <h2><i class="fas fa-file-pdf"></i> Gerar PDF do Orçamento</h2>
                <button class="modal-close" onclick="fecharModalImprimir()"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <div style="text-align: center; padding: 30px 20px;">
                    <div style="width: 80px; height: 80px; background: linear-gradient(135deg, #fff5f0 0%, #ffede5 100%); border-radius: 20px; margin: 0 auto 20px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 15px rgba(249, 115, 22, 0.15);">
                        <i class="fas fa-file-pdf" style="font-size: 40px; color: #f97316;"></i>
                    </div>
                    <p style="font-size: 18px; color: #1e293b; margin-bottom: 8px; font-weight: 600;" id="pdf-numero-orcamento">Orçamento</p>
                    <p style="font-size: 14px; color: #64748b; line-height: 1.5;">
                        O PDF completo será gerado com todos os dados do cliente, itens, valores e observações.
                    </p>
                </div>
                
                <div style="display: flex; gap: 12px; justify-content: center; padding-top: 10px; border-top: 1px solid #e2e8f0;">
                    <button type="button" class="btn-secondary" onclick="fecharModalImprimir()" style="padding: 12px 24px;">
                        <i class="fas fa-times"></i> Cancelar
                    </button>
                    <button type="button" class="btn-primary" onclick="executarImpressaoCompleta()" style="background: linear-gradient(135deg, #f97316, #ea580c); padding: 12px 24px;">
                        <i class="fas fa-download"></i> Gerar PDF
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Critérios de Seleção (Filtros do Kanban) -->
    <div class="modal-overlay" id="modal-filtros-kanban">
        <div class="modal-filtros-content">
            <div class="modal-filtros-header">
                <h2>Critérios de Seleção</h2>
                <button class="close-btn" onclick="fecharModalFiltros()">
                    Fechar <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-filtros-body">
                <div class="filtros-grid">
                    <div class="filtro-group">
                        <label>Considerar Data de Inclusão</label>
                        <select class="filtro-select" id="filtro-data-inclusao">
                            <option value="tudo">Tudo</option>
                            <option value="hoje">Hoje</option>
                            <option value="ontem">Ontem</option>
                            <option value="ultimos-3">Últimos 3 dias</option>
                            <option value="ultimos-7">Últimos 7 dias</option>
                            <option value="ultimos-15">Últimos 15 dias</option>
                            <option value="ultimos-30">Últimos 30 dias</option>
                            <option value="ultimos-90">Últimos 90 dias</option>
                        </select>
                    </div>
                    <div class="filtro-group">
                        <label>Considerar Data de Previsão</label>
                        <select class="filtro-select" id="filtro-data-previsao">
                            <option value="tudo">Tudo</option>
                            <option value="hoje">Hoje</option>
                            <option value="amanha">Amanhã</option>
                            <option value="proximos-3">Próximos 3 dias</option>
                            <option value="proximos-7">Próximos 7 dias</option>
                            <option value="proximos-15">Próximos 15 dias</option>
                            <option value="proximos-30">Próximos 30 dias</option>
                            <option value="proximos-90">Próximos 90 dias</option>
                            <option value="ontem">Ontem</option>
                            <option value="ultimos-3">Últimos 3 dias</option>
                            <option value="ultimos-7">Últimos 7 dias</option>
                            <option value="ultimos-15">Últimos 15 dias</option>
                            <option value="ultimos-30">Últimos 30 dias</option>
                            <option value="ultimos-60">Últimos 60 dias</option>
                            <option value="ultimos-90">Últimos 90 dias</option>
                        </select>
                    </div>
                    <div class="filtro-group">
                        <label>Considerar Data de Faturamento</label>
                        <select class="filtro-select" id="filtro-data-faturamento">
                            <option value="ultimos-30" selected>Últimos 30 dias</option>
                            <option value="ultimos-60">Últimos 60 dias</option>
                            <option value="ultimos-90">Últimos 90 dias</option>
                            <option value="ultimos-120">Últimos 120 dias</option>
                            <option value="ultimo-ano">Último 1 ano</option>
                        </select>
                    </div>
                </div>

                <div class="filtros-row-2">
                    <div class="filtro-group">
                        <label>Exibir Vendedor</label>
                        <div class="filtro-input-search">
                            <input type="text" id="filtro-vendedor" placeholder="Todos os Vendedores" readonly>
                            <button type="button" onclick="abrirModalVendedor()"><i class="fas fa-search"></i></button>
                        </div>
                    </div>
                    <div class="filtro-group">
                        <label>Exibir Projeto</label>
                        <div class="filtro-input-search">
                            <input type="text" id="filtro-projeto" placeholder="Todos os Projetos" readonly>
                            <button type="button" onclick="abrirModalProjeto()"><i class="fas fa-search"></i></button>
                        </div>
                    </div>
                </div>

                <div class="filtros-toggles">
                    <div class="toggle-item">
                        <label class="toggle-switch">
                            <input type="checkbox" id="toggle-cancelados">
                            <span class="toggle-slider"></span>
                        </label>
                        <span class="toggle-label">Exibir Cancelados</span>
                    </div>
                    <div class="toggle-item">
                        <label class="toggle-switch">
                            <input type="checkbox" id="toggle-denegados">
                            <span class="toggle-slider"></span>
                        </label>
                        <span class="toggle-label">Exibir Denegados</span>
                    </div>
                    <div class="toggle-item">
                        <label class="toggle-switch">
                            <input type="checkbox" id="toggle-encerrados">
                            <span class="toggle-slider"></span>
                        </label>
                        <span class="toggle-label">Exibir Encerrados</span>
                    </div>
                </div>

                <div class="filtros-info-box">
                    <p>Para localizar pedidos de venda faturados antes desse período utilize a opção <strong>"Exibir Todos"</strong> em <strong>"Venda de Produto"</strong> no menu.</p>
                </div>
            </div>
            <div class="modal-filtros-footer">
                <button type="button" class="btn-desfazer" onclick="desfazerFiltros()">
                    <i class="fas fa-undo"></i> Desfazer
                </button>
                <button type="button" class="btn-atualizar-filtro" onclick="aplicarFiltros()">
                    <i class="fas fa-sync"></i> Atualizar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Selecionar Vendedor -->
    <div class="modal-overlay" id="modal-selecionar-vendedor">
        <div class="modal-vendedor-content">
            <div class="modal-filtros-header">
                <h2 style="color: #f97316;">Exibir Vendedor</h2>
                <button class="close-btn" onclick="fecharModalVendedor()">
                    Fechar <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="vendedor-search-bar">
                <div class="filter-icon"><i class="fas fa-filter"></i></div>
                <input type="text" id="busca-vendedor" placeholder="Pesquisar por Nome">
                <button class="search-btn"><i class="fas fa-search"></i></button>
            </div>
            <div class="vendedor-list" id="vendedor-list">
                <div class="vendedor-item selected" data-id="todos">Todos os Vendedores</div>
                <div class="vendedor-item" data-id="1">Andreia Trovão</div>
                <div class="vendedor-item" data-id="2">Ariel Silva</div>
                <div class="vendedor-item" data-id="3">Augusto Santos</div>
                <div class="vendedor-item" data-id="4">Elaine Freitas</div>
                <div class="vendedor-item" data-id="5">Fabiano Marques</div>
                <div class="vendedor-item" data-id="6">Fabíola Souza</div>
                <div class="vendedor-item" data-id="7">Lais da Silva</div>
                <div class="vendedor-item" data-id="8">Lorena Silva</div>
            </div>
        </div>
    </div>

    <!-- Modal Confirmação de Alterações Não Salvas -->
    <div class="modal-confirm-overlay" id="modal-confirmar-alteracoes">
        <div class="modal-confirm-content">
            <h3>Desprezar as alterações realizadas?</h3>
            <a class="link-alteracoes" onclick="toggleListaAlteracoes()">quais alterações?</a>
            <div class="alteracoes-lista" id="lista-alteracoes">
                <ul id="alteracoes-itens">
                    <!-- Será preenchido dinamicamente -->
                </ul>
            </div>
            <div class="modal-confirm-buttons">
                <button type="button" class="btn-confirm-sim" id="btn-confirmar-sim">Sim</button>
                <button type="button" class="btn-confirm-nao" id="btn-confirmar-nao">Não</button>
            </div>
        </div>
    </div>

    <!-- Modal Configurar Etapas do Kanban -->
    <div class="modal-overlay" id="modal-etapas-kanban">
        <div class="modal-etapas-content">
            <div class="modal-etapas-header">
                <h2><i class="fas fa-tasks" style="margin-right: 10px;"></i>Alterar as Etapas deste Processo</h2>
                <button class="close-btn" onclick="fecharModalEtapas()">
                    Fechar <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-etapas-body">
                <p>Aqui você pode modificar o nome de cada etapa do seu processo de venda</p>
                
                <div class="etapas-container" id="etapas-container">
                    <!-- Etapas serão carregadas dinamicamente -->
                </div>

                <div class="etapas-actions">
                    <button type="button" class="btn-adicionar-etapa" onclick="adicionarNovaEtapa()">
                        <i class="fas fa-plus-circle"></i> Adicionar Nova Etapa
                    </button>
                    <span class="etapas-counter" id="etapas-counter">6 etapas configuradas</span>
                </div>

                <div class="etapas-info-box">
                    <i class="fas fa-info-circle"></i>
                    <p>As etapas podem deixar de ser usadas somente quando não houver mais Orçamentos nela. Arraste as etapas para reordenar.</p>
                </div>
            </div>
            <div class="modal-etapas-footer">
                <div class="alterar-numeracao">
                    <label class="checkbox-container">
                        <input type="checkbox" id="checkbox-alterar-numeracao">
                        <span class="checkmark"></span>
                    </label>
                    <i class="fas fa-edit"></i>
                    <span>Alterar o <strong>número dos próximos</strong> Pedidos de Venda e Remessas de Produto</span>
                </div>
                <div class="modal-etapas-buttons">
                    <button type="button" class="btn-cancelar-etapas" onclick="fecharModalEtapas()">
                        <i class="fas fa-times"></i> Cancelar
                    </button>
                    <button type="button" class="btn-confirmar-etapas" onclick="confirmarEtapas()">
                        <i class="fas fa-check"></i> Confirmar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Novo Orçamento - Estilo Omie Profissional -->
    <div class="modal-overlay" id="modal-novo-orcamento">
        <div class="modal-content-omie" style="max-width: 1100px; height: 95vh; display: flex; flex-direction: column; position: relative;">
            <!-- Header -->
            <div class="modal-header-omie" style="flex-shrink: 0;">
                <h2><i class="fas fa-file-invoice" style="color: #f97316;"></i> Incluir Orçamento</h2>
                <div style="display: flex; align-items: center; gap: 12px;">
                    <button class="close-btn" onclick="fecharModalNovoOrcamento()">
                        Fechar <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>

            <!-- Container Principal -->
            <div class="modal-container-omie">
                <!-- Área Principal -->
                <div class="modal-main-content" style="padding: 20px;">
                    <!-- Seção Cliente -->
                    <div class="orcamento-cliente-section">
                        <div class="orcamento-cliente-avatar">
                            <i class="fas fa-user"></i>
                        </div>
                        <div class="orcamento-cliente-info">
                            <div class="orcamento-cliente-row">
                                <div class="orcamento-field-group" style="flex: 1; position: relative;">
                                    <label>Cliente <i class="fas fa-link" style="color: #999; font-size: 10px;"></i></label>
                                    <div class="input-with-btn">
                                        <input type="text" id="novo-cliente" placeholder="Digite o nome ou código do cliente" class="orcamento-input" autocomplete="off">
                                        <input type="hidden" id="novo-cliente-id">
                                        <button type="button" class="btn-input-action" onclick="buscarClientes()"><i class="fas fa-search"></i></button>
                                    </div>
                                    <!-- Dropdown de sugestões -->
                                    <div id="dropdown-clientes" class="dropdown-sugestoes" style="display: none; position: absolute; top: 100%; left: 0; right: 40px; background: #fff; border: 1px solid #ddd; border-radius: 4px; max-height: 200px; overflow-y: auto; z-index: 9999; box-shadow: 0 4px 12px rgba(0,0,0,0.15);"></div>
                                </div>
                                <button type="button" class="btn-consulta-credito" onclick="consultarCredito()">
                                    <i class="fas fa-search"></i> Consulta de Crédito
                                </button>
                                <div class="orcamento-field-group">
                                    <label>Previsão de Faturamento</label>
                                    <div class="input-with-btn">
                                        <input type="date" id="novo-previsao-faturamento" class="orcamento-input" value="">
                                        <button type="button" class="btn-input-action"><i class="fas fa-calendar"></i></button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Linha de Valores -->
                    <div class="orcamento-valores-row">
                        <div class="orcamento-valor-box">
                            <label>Total de Mercadorias <i class="fas fa-pencil-alt" style="color: #999; font-size: 9px;"></i></label>
                            <input type="text" id="novo-total-mercadorias" class="orcamento-valor-input" value="0,00" readonly>
                        </div>
                        <div class="orcamento-valor-box">
                            <label>Valor do Desconto <i class="fas fa-pencil-alt" style="color: #999; font-size: 9px;"></i></label>
                            <input type="text" id="novo-desconto" class="orcamento-valor-input" value="0,00">
                        </div>
                        <div class="orcamento-valor-box">
                            <label>Total de IPI</label>
                            <input type="text" id="novo-total-ipi" class="orcamento-valor-input" value="0,00" readonly>
                        </div>
                        <div class="orcamento-valor-box">
                            <label>Total de ICMS ST</label>
                            <input type="text" id="novo-total-icms" class="orcamento-valor-input" value="0,00" readonly>
                        </div>
                        <div class="orcamento-valor-box destaque">
                            <label>Valor Total do Pedido</label>
                            <input type="text" id="novo-valor-total" class="orcamento-valor-input destaque" value="0,00" readonly>
                        </div>
                    </div>

                    <!-- Linha Vendedor e Parcelas -->
                    <div class="orcamento-info-row">
                        <div class="orcamento-field-group" style="position: relative;">
                            <label>Vendedor <i class="fas fa-plus" style="color: #f97316; font-size: 10px; cursor: pointer;"></i></label>
                            <div class="input-with-btn">
                                <input type="text" id="novo-vendedor" placeholder="Selecione o vendedor" class="orcamento-input" readonly style="cursor: pointer;" onclick="toggleDropdownVendedores()">
                                <input type="hidden" id="novo-vendedor-id">
                                <button type="button" class="btn-input-action" onclick="toggleDropdownVendedores()"><i class="fas fa-chevron-down"></i></button>
                            </div>
                            <!-- Dropdown de vendedores -->
                            <div id="dropdown-vendedores" class="dropdown-sugestoes" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: #fff; border: 1px solid #ddd; border-radius: 4px; max-height: 200px; overflow-y: auto; z-index: 9999; box-shadow: 0 4px 12px rgba(0,0,0,0.15);"></div>
                        </div>
                        <div class="orcamento-field-group">
                            <label>Número de Parcelas <i class="fas fa-pencil-alt" style="color: #999; font-size: 9px;"></i> <i class="fas fa-plus" style="color: #f97316; font-size: 10px; cursor: pointer;"></i></label>
                            <div class="input-with-btn">
                                <select id="novo-parcelas" class="orcamento-input" onchange="sincronizarParcelasAba()">
                                    <option value="a_vista">A Vista</option>
                                    <option value="30">30 dias</option>
                                    <option value="30_60">30/60 dias</option>
                                    <option value="30_60_90">30/60/90 dias</option>
                                    <option value="personalizado">Personalizado</option>
                                </select>
                                <button type="button" class="btn-input-action" onclick="ativarAbaOrcamento('parcelas')"><i class="fas fa-cog"></i></button>
                            </div>
                        </div>
                        <div class="orcamento-field-group">
                            <label>Cenário Fiscal</label>
                            <select id="novo-cenario-fiscal" class="orcamento-input" onchange="aplicarCenarioFiscal()">
                                <option value="">Selecione o cenário na lista</option>
                                <option value="venda_normal">Venda Normal (Dentro do Estado)</option>
                                <option value="venda_fora_estado">Venda Fora do Estado</option>
                                <option value="venda_zona_franca">Venda Zona Franca</option>
                                <option value="exportacao">Exportação</option>
                                <option value="simples_nacional">Simples Nacional</option>
                            </select>
                        </div>
                    </div>

                    <!-- Abas -->
                    <div class="orcamento-tabs">
                        <button class="orcamento-tab active" data-tab="itens">Itens da Venda</button>
                        <button class="orcamento-tab" data-tab="impostos">Impostos</button>
                        <button class="orcamento-tab" data-tab="departamentos">Departamentos</button>
                        <button class="orcamento-tab" data-tab="frete">Frete e Outras Despesas</button>
                        <button class="orcamento-tab" data-tab="info">Informações Adicionais</button>
                        <button class="orcamento-tab" data-tab="parcelas">Parcelas</button>
                        <button class="orcamento-tab" data-tab="obs">Observações</button>
                        <button class="orcamento-tab" data-tab="email">E-mail para o Cliente</button>
                    </div>

                    <!-- Conteúdo das Abas -->
                    <div class="orcamento-tab-content active" id="tab-itens">
                        <!-- Botões de Ação -->
                        <div class="orcamento-itens-actions">
                            <button type="button" class="btn-orcamento-action verde" onclick="adicionarItemOrcamento()">
                                <i class="fas fa-plus"></i> Novo Item
                            </button>
                            <button type="button" class="btn-orcamento-action laranja">
                                <i class="fas fa-edit"></i> Editar Item
                            </button>
                            <button type="button" class="btn-orcamento-action vermelho">
                                <i class="fas fa-trash"></i> Excluir Item
                            </button>
                        </div>

                        <!-- Tabela de Itens -->
                        <div class="orcamento-tabela-container">
                            <table class="orcamento-tabela">
                                <thead>
                                    <tr>
                                        <th style="width: 100px;">Produto <i class="fas fa-sort"></i></th>
                                        <th>Descrição do Produto <i class="fas fa-sort"></i></th>
                                        <th style="width: 100px;">Quantidade <i class="fas fa-sort"></i></th>
                                        <th style="width: 100px;">Qtd. Pendente <i class="fas fa-sort"></i></th>
                                        <th style="width: 120px;">Local de Estoque <i class="fas fa-sort"></i></th>
                                        <th style="width: 120px;">Preço Unitário <i class="fas fa-sort"></i></th>
                                        <th style="width: 120px;">Valor Total <i class="fas fa-sort"></i></th>
                                    </tr>
                                    <tr class="filter-row">
                                        <th><input type="text" placeholder="🔍" class="filter-input"></th>
                                        <th><input type="text" placeholder="🔍" class="filter-input"></th>
                                        <th><input type="text" placeholder="🔍" class="filter-input"></th>
                                        <th><input type="text" placeholder="🔍" class="filter-input"></th>
                                        <th><input type="text" placeholder="🔍" class="filter-input"></th>
                                        <th><input type="text" placeholder="🔍" class="filter-input"></th>
                                        <th><input type="text" placeholder="🔍" class="filter-input"></th>
                                    </tr>
                                </thead>
                                <tbody id="tbody-itens-orcamento">
                                    <!-- Itens serão adicionados aqui -->
                                </tbody>
                            </table>
                            <div class="orcamento-tabela-empty" id="empty-itens">
                                <i class="fas fa-inbox"></i>
                                <p>Nenhum registro encontrado</p>
                            </div>
                        </div>

                        <!-- Paginação -->
                        <div class="orcamento-paginacao">
                            <span class="paginacao-info">Nenhum registro encontrado</span>
                            <div class="paginacao-controls">
                                <button class="pag-btn" disabled><i class="fas fa-angle-double-left"></i></button>
                                <button class="pag-btn" disabled><i class="fas fa-angle-left"></i></button>
                                <span class="pag-text">anterior</span>
                                <span class="pag-current">1</span>
                                <span class="pag-text">próximo</span>
                                <button class="pag-btn" disabled><i class="fas fa-angle-right"></i></button>
                                <button class="pag-btn" disabled><i class="fas fa-angle-double-right"></i></button>
                            </div>
                        </div>
                    </div>

                    <!-- Aba Impostos -->
                    <div class="orcamento-tab-content" id="tab-impostos">
                        <div class="orcamento-section-form">
                            <!-- Cabeçalho: Cenário Fiscal e Botão Calcular -->
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 16px; border-bottom: 1px solid #e5e7eb;">
                                <div style="display: flex; align-items: center; gap: 16px;">
                                    <div class="orcamento-field-group" style="margin: 0; width: 350px;">
                                        <label style="font-weight: 600;">Cenário Fiscal</label>
                                        <select id="impostos-cenario-fiscal" class="orcamento-input" onchange="carregarCenarioFiscal()">
                                            <option value="">Selecione o cenário fiscal</option>
                                            <option value="venda_normal">Venda Normal (Dentro do Estado)</option>
                                            <option value="venda_fora_estado">Venda Fora do Estado</option>
                                            <option value="venda_zona_franca">Venda Zona Franca</option>
                                            <option value="exportacao">Exportação</option>
                                            <option value="simples_nacional">Simples Nacional</option>
                                            <option value="industrializacao">Industrialização (com IPI)</option>
                                            <option value="revenda">Revenda de Mercadorias</option>
                                        </select>
                                    </div>
                                    <button type="button" class="btn-orcamento-action laranja" onclick="calcularImpostos()" style="padding: 10px 20px; margin-top: 18px;">
                                        <i class="fas fa-calculator"></i> Calcular Impostos
                                    </button>
                                </div>
                                <div style="display: flex; gap: 12px;">
                                    <label class="checkbox-label" style="display: flex; align-items: center; gap: 8px;">
                                        <input type="checkbox" id="impostos-destacar-nf" checked>
                                        <span style="font-size: 13px; color: #333;">Destacar Impostos na NF</span>
                                    </label>
                                </div>
                            </div>

                            <!-- Grid de Impostos -->
                            <div class="impostos-grid" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 24px;">
                                
                                <!-- Card ICMS -->
                                <div class="imposto-card" style="background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 12px; padding: 16px;">
                                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px; padding-bottom: 10px; border-bottom: 1px solid #e2e8f0;">
                                        <i class="fas fa-percentage" style="color: #3b82f6; font-size: 18px;"></i>
                                        <h4 style="margin: 0; color: #1e40af; font-weight: 600;">ICMS</h4>
                                    </div>
                                    <div class="imposto-campos" style="display: grid; gap: 10px;">
                                        <div class="imposto-field">
                                            <label style="font-size: 11px; color: #64748b;">CST</label>
                                            <select id="impostos-icms-cst" class="imposto-input" onchange="atualizarImpostos()">
                                                <option value="00">00 - Tributada Integralmente</option>
                                                <option value="10">10 - Tributada com ICMS ST</option>
                                                <option value="20">20 - Com Redução de Base</option>
                                                <option value="30">30 - Isenta com ICMS ST</option>
                                                <option value="40">40 - Isenta</option>
                                                <option value="41">41 - Não Tributada</option>
                                                <option value="50">50 - Suspensão</option>
                                                <option value="51">51 - Diferimento</option>
                                                <option value="60">60 - ICMS Cobrado Anteriormente</option>
                                                <option value="70">70 - Redução + ICMS ST</option>
                                                <option value="90">90 - Outras</option>
                                            </select>
                                        </div>
                                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                            <div class="imposto-field">
                                                <label style="font-size: 11px; color: #64748b;">Alíquota (%)</label>
                                                <input type="text" id="impostos-icms-aliquota" class="imposto-input" value="18,00" onchange="atualizarImpostos()">
                                            </div>
                                            <div class="imposto-field">
                                                <label style="font-size: 11px; color: #64748b;">Red. Base (%)</label>
                                                <input type="text" id="impostos-icms-reducao" class="imposto-input" value="0,00" onchange="atualizarImpostos()">
                                            </div>
                                        </div>
                                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                            <div class="imposto-field">
                                                <label style="font-size: 11px; color: #64748b;">Base Cálculo</label>
                                                <input type="text" id="impostos-icms-base" class="imposto-input valor" value="0,00" readonly style="background: #f1f5f9;">
                                            </div>
                                            <div class="imposto-field">
                                                <label style="font-size: 11px; color: #64748b; font-weight: 600;">Valor ICMS</label>
                                                <input type="text" id="impostos-icms-valor" class="imposto-input valor destaque" value="0,00" readonly style="background: #dbeafe; color: #1e40af; font-weight: 600;">
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Card ICMS ST -->
                                <div class="imposto-card" style="background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 12px; padding: 16px;">
                                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px; padding-bottom: 10px; border-bottom: 1px solid #e2e8f0;">
                                        <i class="fas fa-truck" style="color: #7c3aed; font-size: 18px;"></i>
                                        <h4 style="margin: 0; color: #5b21b6; font-weight: 600;">ICMS ST</h4>
                                        <label class="toggle-mini" style="margin-left: auto;">
                                            <input type="checkbox" id="impostos-icms-st-ativo" onchange="toggleICMSST()">
                                            <span class="toggle-slider-mini"></span>
                                        </label>
                                    </div>
                                    <div class="imposto-campos" style="display: grid; gap: 10px;">
                                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                            <div class="imposto-field">
                                                <label style="font-size: 11px; color: #64748b;">Alíquota (%)</label>
                                                <input type="text" id="impostos-icms-st-aliquota" class="imposto-input" value="0,00" disabled onchange="atualizarImpostos()">
                                            </div>
                                            <div class="imposto-field">
                                                <label style="font-size: 11px; color: #64748b;">MVA (%)</label>
                                                <input type="text" id="impostos-icms-st-mva" class="imposto-input" value="0,00" disabled onchange="atualizarImpostos()">
                                            </div>
                                        </div>
                                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                            <div class="imposto-field">
                                                <label style="font-size: 11px; color: #64748b;">Base ST</label>
                                                <input type="text" id="impostos-icms-st-base" class="imposto-input valor" value="0,00" readonly style="background: #f1f5f9;">
                                            </div>
                                            <div class="imposto-field">
                                                <label style="font-size: 11px; color: #64748b; font-weight: 600;">Valor ICMS ST</label>
                                                <input type="text" id="impostos-icms-st-valor" class="imposto-input valor destaque" value="0,00" readonly style="background: #ede9fe; color: #5b21b6; font-weight: 600;">
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Card IPI -->
                                <div class="imposto-card" style="background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 12px; padding: 16px;">
                                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px; padding-bottom: 10px; border-bottom: 1px solid #e2e8f0;">
                                        <i class="fas fa-industry" style="color: #059669; font-size: 18px;"></i>
                                        <h4 style="margin: 0; color: #047857; font-weight: 600;">IPI</h4>
                                        <label class="toggle-mini" style="margin-left: auto;">
                                            <input type="checkbox" id="impostos-ipi-ativo" onchange="toggleIPI()">
                                            <span class="toggle-slider-mini"></span>
                                        </label>
                                    </div>
                                    <div class="imposto-campos" style="display: grid; gap: 10px;">
                                        <div class="imposto-field">
                                            <label style="font-size: 11px; color: #64748b;">CST IPI</label>
                                            <select id="impostos-ipi-cst" class="imposto-input" disabled onchange="atualizarImpostos()">
                                                <option value="50">50 - Saída Tributada</option>
                                                <option value="51">51 - Saída Tributada com Alíquota Zero</option>
                                                <option value="52">52 - Saída Isenta</option>
                                                <option value="53">53 - Saída Não Tributada</option>
                                                <option value="54">54 - Saída Imune</option>
                                                <option value="55">55 - Saída com Suspensão</option>
                                                <option value="99">99 - Outras Saídas</option>
                                            </select>
                                        </div>
                                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                            <div class="imposto-field">
                                                <label style="font-size: 11px; color: #64748b;">Alíquota (%)</label>
                                                <input type="text" id="impostos-ipi-aliquota" class="imposto-input" value="0,00" disabled onchange="atualizarImpostos()">
                                            </div>
                                            <div class="imposto-field">
                                                <label style="font-size: 11px; color: #64748b;">Base Cálculo</label>
                                                <input type="text" id="impostos-ipi-base" class="imposto-input valor" value="0,00" readonly style="background: #f1f5f9;">
                                            </div>
                                        </div>
                                        <div class="imposto-field">
                                            <label style="font-size: 11px; color: #64748b; font-weight: 600;">Valor IPI</label>
                                            <input type="text" id="impostos-ipi-valor" class="imposto-input valor destaque" value="0,00" readonly style="background: #d1fae5; color: #047857; font-weight: 600;">
                                        </div>
                                    </div>
                                </div>

                                <!-- Card PIS -->
                                <div class="imposto-card" style="background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 12px; padding: 16px;">
                                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px; padding-bottom: 10px; border-bottom: 1px solid #e2e8f0;">
                                        <i class="fas fa-hand-holding-usd" style="color: #dc2626; font-size: 18px;"></i>
                                        <h4 style="margin: 0; color: #b91c1c; font-weight: 600;">PIS</h4>
                                    </div>
                                    <div class="imposto-campos" style="display: grid; gap: 10px;">
                                        <div class="imposto-field">
                                            <label style="font-size: 11px; color: #64748b;">CST PIS</label>
                                            <select id="impostos-pis-cst" class="imposto-input" onchange="atualizarImpostos()">
                                                <option value="01">01 - Operação Tributável (BC = Valor da Operação)</option>
                                                <option value="02">02 - Operação Tributável (BC = Valor da Operação - Alíquota Diferenciada)</option>
                                                <option value="04">04 - Operação Tributável (Monofásica - Revenda a Alíquota Zero)</option>
                                                <option value="06">06 - Operação Tributável (Alíquota Zero)</option>
                                                <option value="07">07 - Operação Isenta da Contribuição</option>
                                                <option value="08">08 - Operação sem Incidência da Contribuição</option>
                                                <option value="09">09 - Operação com Suspensão da Contribuição</option>
                                                <option value="49">49 - Outras Operações de Saída</option>
                                            </select>
                                        </div>
                                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                            <div class="imposto-field">
                                                <label style="font-size: 11px; color: #64748b;">Alíquota (%)</label>
                                                <input type="text" id="impostos-pis-aliquota" class="imposto-input" value="1,65" onchange="atualizarImpostos()">
                                            </div>
                                            <div class="imposto-field">
                                                <label style="font-size: 11px; color: #64748b;">Base Cálculo</label>
                                                <input type="text" id="impostos-pis-base" class="imposto-input valor" value="0,00" readonly style="background: #f1f5f9;">
                                            </div>
                                        </div>
                                        <div class="imposto-field">
                                            <label style="font-size: 11px; color: #64748b; font-weight: 600;">Valor PIS</label>
                                            <input type="text" id="impostos-pis-valor" class="imposto-input valor destaque" value="0,00" readonly style="background: #fee2e2; color: #b91c1c; font-weight: 600;">
                                        </div>
                                    </div>
                                </div>

                                <!-- Card COFINS -->
                                <div class="imposto-card" style="background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 12px; padding: 16px;">
                                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px; padding-bottom: 10px; border-bottom: 1px solid #e2e8f0;">
                                        <i class="fas fa-coins" style="color: #ea580c; font-size: 18px;"></i>
                                        <h4 style="margin: 0; color: #c2410c; font-weight: 600;">COFINS</h4>
                                    </div>
                                    <div class="imposto-campos" style="display: grid; gap: 10px;">
                                        <div class="imposto-field">
                                            <label style="font-size: 11px; color: #64748b;">CST COFINS</label>
                                            <select id="impostos-cofins-cst" class="imposto-input" onchange="atualizarImpostos()">
                                                <option value="01">01 - Operação Tributável (BC = Valor da Operação)</option>
                                                <option value="02">02 - Operação Tributável (BC = Valor da Operação - Alíquota Diferenciada)</option>
                                                <option value="04">04 - Operação Tributável (Monofásica - Revenda a Alíquota Zero)</option>
                                                <option value="06">06 - Operação Tributável (Alíquota Zero)</option>
                                                <option value="07">07 - Operação Isenta da Contribuição</option>
                                                <option value="08">08 - Operação sem Incidência da Contribuição</option>
                                                <option value="09">09 - Operação com Suspensão da Contribuição</option>
                                                <option value="49">49 - Outras Operações de Saída</option>
                                            </select>
                                        </div>
                                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                            <div class="imposto-field">
                                                <label style="font-size: 11px; color: #64748b;">Alíquota (%)</label>
                                                <input type="text" id="impostos-cofins-aliquota" class="imposto-input" value="7,60" onchange="atualizarImpostos()">
                                            </div>
                                            <div class="imposto-field">
                                                <label style="font-size: 11px; color: #64748b;">Base Cálculo</label>
                                                <input type="text" id="impostos-cofins-base" class="imposto-input valor" value="0,00" readonly style="background: #f1f5f9;">
                                            </div>
                                        </div>
                                        <div class="imposto-field">
                                            <label style="font-size: 11px; color: #64748b; font-weight: 600;">Valor COFINS</label>
                                            <input type="text" id="impostos-cofins-valor" class="imposto-input valor destaque" value="0,00" readonly style="background: #ffedd5; color: #c2410c; font-weight: 600;">
                                        </div>
                                    </div>
                                </div>

                                <!-- Card ISS -->
                                <div class="imposto-card" style="background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 12px; padding: 16px;">
                                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px; padding-bottom: 10px; border-bottom: 1px solid #e2e8f0;">
                                        <i class="fas fa-building" style="color: #0284c7; font-size: 18px;"></i>
                                        <h4 style="margin: 0; color: #0369a1; font-weight: 600;">ISS</h4>
                                        <label class="toggle-mini" style="margin-left: auto;">
                                            <input type="checkbox" id="impostos-iss-ativo" onchange="toggleISS()">
                                            <span class="toggle-slider-mini"></span>
                                        </label>
                                    </div>
                                    <div class="imposto-campos" style="display: grid; gap: 10px;">
                                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                            <div class="imposto-field">
                                                <label style="font-size: 11px; color: #64748b;">Alíquota (%)</label>
                                                <input type="text" id="impostos-iss-aliquota" class="imposto-input" value="0,00" disabled onchange="atualizarImpostos()">
                                            </div>
                                            <div class="imposto-field">
                                                <label style="font-size: 11px; color: #64748b;">Base Cálculo</label>
                                                <input type="text" id="impostos-iss-base" class="imposto-input valor" value="0,00" readonly style="background: #f1f5f9;">
                                            </div>
                                        </div>
                                        <div class="imposto-field">
                                            <label style="font-size: 11px; color: #64748b; font-weight: 600;">Valor ISS</label>
                                            <input type="text" id="impostos-iss-valor" class="imposto-input valor destaque" value="0,00" readonly style="background: #e0f2fe; color: #0369a1; font-weight: 600;">
                                        </div>
                                    </div>
                                </div>

                            </div>

                            <!-- Resumo de Valores -->
                            <div class="impostos-resumo" style="background: linear-gradient(135deg, #1e3a5f, #2d4a6f); border-radius: 12px; padding: 20px; color: white;">
                                <h4 style="margin: 0 0 16px 0; font-size: 14px; font-weight: 600; display: flex; align-items: center; gap: 8px;">
                                    <i class="fas fa-receipt"></i> Resumo dos Valores
                                </h4>
                                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px;">
                                    <div class="resumo-item">
                                        <span style="font-size: 11px; opacity: 0.8;">Total de Produtos</span>
                                        <strong id="impostos-total-produtos" style="font-size: 16px; display: block;">R$ 0,00</strong>
                                    </div>
                                    <div class="resumo-item">
                                        <span style="font-size: 11px; opacity: 0.8;">Total de Impostos</span>
                                        <strong id="impostos-total-impostos" style="font-size: 16px; display: block; color: #fbbf24;">R$ 0,00</strong>
                                    </div>
                                    <div class="resumo-item">
                                        <span style="font-size: 11px; opacity: 0.8;">Frete + Outras Despesas</span>
                                        <strong id="impostos-total-frete" style="font-size: 16px; display: block;">R$ 0,00</strong>
                                    </div>
                                    <div class="resumo-item" style="background: rgba(255,255,255,0.1); padding: 10px; border-radius: 8px;">
                                        <span style="font-size: 11px; opacity: 0.8;">Total da Nota Fiscal</span>
                                        <strong id="impostos-total-nf" style="font-size: 20px; display: block; color: #4ade80;">R$ 0,00</strong>
                                    </div>
                                </div>
                            </div>

                            <!-- Informações Complementares -->
                            <div style="margin-top: 20px;">
                                <div class="orcamento-field-group">
                                    <label style="color: #3b82f6; font-size: 13px;">
                                        <i class="fas fa-info-circle"></i> Informações Complementares para a NF-e
                                    </label>
                                    <textarea id="impostos-info-complementares" class="orcamento-textarea" style="min-height: 80px; margin-top: 8px;" placeholder="Informações adicionais de interesse do fisco que serão impressas na NF-e..."></textarea>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Aba Departamentos -->
                    <div class="orcamento-tab-content" id="tab-departamentos">
                        <div class="orcamento-empty-state" style="padding: 60px 20px; text-align: center;">
                            <div style="font-size: 48px; color: #ccc; margin-bottom: 16px;">=(</div>
                            <p style="color: #666; font-size: 14px;">Ainda não foi informada nenhuma distribuição por departamentos para esta venda.</p>
                        </div>
                    </div>

                    <!-- Aba Frete -->
                    <div class="orcamento-tab-content" id="tab-frete">
                        <div class="orcamento-frete-section">
                            <!-- Linha 1: Transportadora, Tipo do Frete, Placa, UF, RNTRC -->
                            <div class="orcamento-form-row" style="display: grid; grid-template-columns: 2fr 1.5fr 1fr 80px 1fr; gap: 12px; margin-bottom: 16px;">
                                <div class="orcamento-field-group">
                                    <label>Transportadora <i class="fas fa-link" style="color: #999; font-size: 10px;"></i></label>
                                    <div class="input-with-btn">
                                        <input type="text" id="novo-transportadora" placeholder="" class="orcamento-input">
                                        <button type="button" class="btn-input-action"><i class="fas fa-search"></i></button>
                                    </div>
                                </div>
                                <div class="orcamento-field-group">
                                    <label>Tipo do Frete</label>
                                    <select id="novo-tipo-frete" class="orcamento-input">
                                        <option value="9">9 - Sem Ocorrência de Transporte</option>
                                        <option value="0">0 - Contratação por conta do Remetente (CIF)</option>
                                        <option value="1">1 - Contratação por conta do Destinatário (FOB)</option>
                                        <option value="2">2 - Contratação por conta de Terceiros</option>
                                        <option value="3">3 - Transporte Próprio por conta do Remetente</option>
                                        <option value="4">4 - Transporte Próprio por conta do Destinatário</option>
                                    </select>
                                </div>
                                <div class="orcamento-field-group">
                                    <label>Placa do Veículo</label>
                                    <input type="text" id="novo-placa-veiculo" class="orcamento-input" placeholder="" maxlength="8">
                                </div>
                                <div class="orcamento-field-group">
                                    <label>UF</label>
                                    <select id="novo-placa-uf" class="orcamento-input">
                                        <option value=""></option>
                                        <option value="AC">AC</option><option value="AL">AL</option><option value="AP">AP</option>
                                        <option value="AM">AM</option><option value="BA">BA</option><option value="CE">CE</option>
                                        <option value="DF">DF</option><option value="ES">ES</option><option value="GO">GO</option>
                                        <option value="MA">MA</option><option value="MT">MT</option><option value="MS">MS</option>
                                        <option value="MG">MG</option><option value="PA">PA</option><option value="PB">PB</option>
                                        <option value="PR">PR</option><option value="PE">PE</option><option value="PI">PI</option>
                                        <option value="RJ">RJ</option><option value="RN">RN</option><option value="RS">RS</option>
                                        <option value="RO">RO</option><option value="RR">RR</option><option value="SC">SC</option>
                                        <option value="SP">SP</option><option value="SE">SE</option><option value="TO">TO</option>
                                    </select>
                                </div>
                                <div class="orcamento-field-group">
                                    <label>RNTRC (ANTT)</label>
                                    <input type="text" id="novo-rntrc" class="orcamento-input" placeholder="">
                                </div>
                            </div>

                            <!-- Linha 2: Volumes -->
                            <div class="orcamento-form-row" style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 12px; margin-bottom: 16px;">
                                <div class="orcamento-field-group">
                                    <label>Quantidade de Volumes</label>
                                    <input type="number" id="novo-qtd-volumes" class="orcamento-input" value="0" min="0">
                                </div>
                                <div class="orcamento-field-group">
                                    <label>Espécie dos Volumes</label>
                                    <input type="text" id="novo-especie-volumes" class="orcamento-input" placeholder="">
                                </div>
                                <div class="orcamento-field-group">
                                    <label>Marca dos Volumes</label>
                                    <input type="text" id="novo-marca-volumes" class="orcamento-input" placeholder="">
                                </div>
                                <div class="orcamento-field-group">
                                    <label>Numeração dos Volumes</label>
                                    <input type="text" id="novo-numeracao-volumes" class="orcamento-input" placeholder="">
                                </div>
                            </div>

                            <!-- Linha 3: Pesos e Valores + Link ICMS -->
                            <div class="orcamento-form-row" style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr 2fr; gap: 12px; margin-bottom: 16px; align-items: end;">
                                <div class="orcamento-field-group">
                                    <label>Peso Líquido (Kg)</label>
                                    <input type="text" id="novo-peso-liquido" class="orcamento-input" value="0,000" style="text-align: right;">
                                </div>
                                <div class="orcamento-field-group">
                                    <label>Peso Bruto (Kg)</label>
                                    <input type="text" id="novo-peso-bruto" class="orcamento-input" value="0,000" style="text-align: right;">
                                </div>
                                <div class="orcamento-field-group">
                                    <label>Valor do Frete</label>
                                    <input type="text" id="novo-frete" class="orcamento-input" value="0,00" style="text-align: right;">
                                </div>
                                <div class="orcamento-field-group">
                                    <label>Valor do Seguro</label>
                                    <input type="text" id="novo-seguro" class="orcamento-input" value="0,00" style="text-align: right;">
                                </div>
                                <div style="text-align: right; padding-bottom: 8px;">
                                    <a href="#" onclick="abrirModalICMSTransporte(); return false;" style="color: #3b82f6; font-size: 12px; text-decoration: none;">Informar os valores para o<br><strong>ICMS Retido do Serviço<br>de Transporte</strong></a>
                                </div>
                            </div>

                            <!-- Linha 4: Lacre e Outras Despesas -->
                            <div class="orcamento-form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
                                <div class="orcamento-field-group">
                                    <label>Número do Lacre</label>
                                    <input type="text" id="novo-numero-lacre" class="orcamento-input" placeholder="">
                                </div>
                                <div class="orcamento-field-group">
                                    <label>Outras Despesas Acessórias</label>
                                    <input type="text" id="novo-outras-despesas" class="orcamento-input" value="0,00" style="text-align: right;">
                                </div>
                            </div>

                            <!-- Linha 5: Previsão de Entrega e Rastreio -->
                            <div class="orcamento-form-row" style="display: grid; grid-template-columns: 1fr 1fr 2fr; gap: 12px; margin-bottom: 16px; align-items: end;">
                                <div class="orcamento-field-group">
                                    <label>Previsão de Entrega</label>
                                    <div class="input-with-btn">
                                        <input type="date" id="novo-previsao-entrega" class="orcamento-input">
                                        <button type="button" class="btn-input-action"><i class="fas fa-calendar"></i></button>
                                    </div>
                                </div>
                                <div class="orcamento-field-group">
                                    <label>Código de Rastreio</label>
                                    <input type="text" id="novo-codigo-rastreio" class="orcamento-input" placeholder="">
                                </div>
                                <div style="padding-bottom: 8px;">
                                    <label class="checkbox-label" style="display: flex; align-items: center; gap: 8px;">
                                        <input type="checkbox" id="novo-veiculo-proprio">
                                        <span style="font-size: 13px; color: #333;">O transporte será realizado com veículo próprio</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Aba Informações Adicionais -->
                    <div class="orcamento-tab-content" id="tab-info">
                        <div class="orcamento-section-form">
                            <!-- Linha 1: Categoria, Conta Corrente, Etapa -->
                            <div class="orcamento-form-row" style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; margin-bottom: 16px;">
                                <div class="orcamento-field-group">
                                    <label>Categoria</label>
                                    <select id="novo-categoria" class="orcamento-input">
                                        <option value=""></option>
                                        <option value="venda_mercadoria">Venda de Mercadoria</option>
                                        <option value="venda_servico">Venda de Serviço</option>
                                        <option value="revenda">Revenda</option>
                                        <option value="outros">Outros</option>
                                    </select>
                                </div>
                                <div class="orcamento-field-group">
                                    <label>Conta Corrente</label>
                                    <select id="novo-conta-corrente" class="orcamento-input">
                                        <option value=""></option>
                                        <option value="principal">Conta Principal</option>
                                        <option value="secundaria">Conta Secundária</option>
                                        <option value="caixa">Caixa</option>
                                    </select>
                                </div>
                                <div class="orcamento-field-group">
                                    <label>Etapa</label>
                                    <select id="novo-etapa" class="orcamento-input">
                                        <option value="orcamento">Orçamento</option>
                                        <option value="analise">Em Análise</option>
                                        <option value="aprovado">Aprovado</option>
                                        <option value="faturar">Faturar</option>
                                    </select>
                                </div>
                            </div>

                            <!-- Linha 2: Nº Pedido Cliente, Nº Contrato, Contato, Projeto, Origem -->
                            <div class="orcamento-form-row" style="display: grid; grid-template-columns: 1fr 1fr 1fr 1.5fr 1fr; gap: 12px; margin-bottom: 16px;">
                                <div class="orcamento-field-group">
                                    <label>Nº do Pedido do Cliente</label>
                                    <input type="text" id="novo-pedido-cliente" class="orcamento-input" placeholder="">
                                </div>
                                <div class="orcamento-field-group">
                                    <label>Nº do Contrato de Venda</label>
                                    <input type="text" id="novo-contrato-venda" class="orcamento-input" placeholder="">
                                </div>
                                <div class="orcamento-field-group">
                                    <label>Contato</label>
                                    <input type="text" id="novo-contato" class="orcamento-input" placeholder="">
                                </div>
                                <div class="orcamento-field-group">
                                    <label>Projeto <i class="fas fa-plus" style="color: #f97316; font-size: 10px; cursor: pointer;"></i></label>
                                    <div class="input-with-btn">
                                        <input type="text" id="novo-projeto" class="orcamento-input" placeholder="">
                                        <button type="button" class="btn-input-action"><i class="fas fa-search"></i></button>
                                    </div>
                                </div>
                                <div class="orcamento-field-group">
                                    <label>Origem do Pedido</label>
                                    <select id="novo-origem-pedido" class="orcamento-input">
                                        <option value="omie">Omie</option>
                                        <option value="site">Site</option>
                                        <option value="telefone">Telefone</option>
                                        <option value="whatsapp">WhatsApp</option>
                                        <option value="presencial">Presencial</option>
                                        <option value="marketplace">Marketplace</option>
                                    </select>
                                </div>
                            </div>

                            <!-- Dados Adicionais NF e Links -->
                            <div class="orcamento-form-row" style="display: grid; grid-template-columns: 1.5fr 1fr; gap: 24px; margin-bottom: 16px;">
                                <div class="orcamento-field-group">
                                    <label>Dados Adicionais para a Nota Fiscal</label>
                                    <textarea id="novo-dados-adicionais-nf" class="orcamento-textarea" style="min-height: 100px;" placeholder=""></textarea>
                                </div>
                                <div style="display: flex; flex-direction: column; gap: 12px; padding-top: 20px;">
                                    <a href="#" onclick="abrirModalNFsRelacionadas(); return false;" style="color: #3b82f6; font-size: 12px; text-decoration: none;">Clique aqui para <strong>Incluir<br>notas fiscais relacionadas</strong></a>
                                    <a href="#" onclick="abrirModalInfoFisco(); return false;" style="color: #3b82f6; font-size: 12px; text-decoration: none;">Clique aqui para <strong>Alterar</strong> as<br>informações adicionais de <strong>interesse do fisco</strong></a>
                                </div>
                            </div>

                            <!-- Checkbox e Links inferiores -->
                            <div style="display: flex; align-items: flex-start; gap: 24px; flex-wrap: wrap; margin-top: 16px; padding-top: 16px; border-top: 1px solid #e5e5e5;">
                                <label class="checkbox-label" style="display: flex; align-items: center; gap: 8px;">
                                    <input type="checkbox" id="novo-consumo-final">
                                    <span style="font-size: 13px; color: #333;">Nota Fiscal para Consumo Final</span>
                                </label>
                                <a href="#" onclick="abrirModalCamposObsNFe(); return false;" style="color: #3b82f6; font-size: 12px; text-decoration: none;">Incluir os <strong>campos adicionais de observação</strong><br>para a NF-e</a>
                                <a href="#" onclick="abrirModalEnderecoEntrega(); return false;" style="color: #3b82f6; font-size: 12px; text-decoration: none;">Alterar o <strong>endereço de entrega</strong><br>e outros detalhes da NF-e</a>
                                <a href="#" onclick="abrirModalAgropecuaria(); return false;" style="color: #3b82f6; font-size: 12px; text-decoration: none;">Dados de produtos da <strong>Agricultura,<br>Pecuária e Produção Florestal</strong></a>
                            </div>
                        </div>
                    </div>

                    <!-- Aba Parcelas -->
                    <div class="orcamento-tab-content" id="tab-parcelas">
                        <div class="orcamento-section-form">
                            <!-- Cabeçalho: Contas a Receber e Valor Total -->
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                                <div>
                                    <span style="font-size: 13px; color: #333;">Contas a Receber</span>
                                    <span style="font-size: 11px; color: #999; margin-left: 8px;">(clique duas vezes para modificar a parcela)</span>
                                </div>
                                <div style="display: flex; align-items: center; gap: 12px;">
                                    <div class="orcamento-valor-box destaque" style="margin: 0;">
                                        <label style="font-size: 11px;">Valor Total a Receber</label>
                                        <input type="text" id="novo-valor-total-receber" class="orcamento-valor-input destaque" value="0,00" readonly style="width: 120px;">
                                    </div>
                                    <button type="button" class="btn-orcamento-action laranja" onclick="refazerParcelas()" style="padding: 8px 16px;">
                                        <i class="fas fa-sync-alt"></i> Refazer Parcelas
                                    </button>
                                </div>
                            </div>

                            <!-- Tabela de Parcelas estilo Omie -->
                            <div class="orcamento-tabela-container">
                                <table class="orcamento-tabela">
                                    <thead>
                                        <tr>
                                            <th style="width: 80px;">Situação <span style="color: #999;">«</span></th>
                                            <th style="width: 80px;">Parcela <span style="color: #999;">«</span></th>
                                            <th style="width: 120px;">Vencimento <span style="color: #999;">«</span></th>
                                            <th style="width: 120px;">Valor a Receber <span style="color: #999;">«</span></th>
                                            <th style="width: 100px;">Percentual <span style="color: #999;">«</span></th>
                                            <th style="width: 140px;">Tipo de Documento <span style="color: #999;">«</span></th>
                                            <th style="width: 140px;">Meio de Pagamento <span style="color: #999;">«</span></th>
                                            <th style="width: 100px;">Gerar Boleto <span style="color: #999;">«</span></th>
                                        </tr>
                                    </thead>
                                    <tbody id="tbody-parcelas">
                                        <!-- Parcelas serão geradas dinamicamente -->
                                    </tbody>
                                </table>
                                <div class="orcamento-tabela-empty" id="empty-parcelas">
                                    <i class="fas fa-inbox"></i>
                                    <p>Nenhum registro encontrado</p>
                                </div>
                            </div>

                            <!-- Paginação -->
                            <div class="orcamento-paginacao">
                                <span class="paginacao-info">Nenhum registro encontrado</span>
                                <div class="paginacao-controls">
                                    <button class="pag-btn" disabled><i class="fas fa-angle-double-left"></i></button>
                                    <button class="pag-btn" disabled><i class="fas fa-angle-left"></i></button>
                                    <span class="pag-text">anterior</span>
                                    <span class="pag-current">1</span>
                                    <span class="pag-text">próximo</span>
                                    <button class="pag-btn" disabled><i class="fas fa-angle-right"></i></button>
                                    <button class="pag-btn" disabled><i class="fas fa-angle-double-right"></i></button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Aba Observações -->
                    <div class="orcamento-tab-content" id="tab-obs">
                        <div class="orcamento-section-form">
                            <div class="orcamento-field-group">
                                <label style="color: #3b82f6; font-size: 13px;">Preencha aqui as observações desta venda (elas não serão exibidas na Nota Fiscal)</label>
                                <textarea id="novo-observacoes" class="orcamento-textarea" style="min-height: 200px; margin-top: 8px;" placeholder=""></textarea>
                            </div>
                        </div>
                    </div>

                    <!-- Aba E-mail -->
                    <div class="orcamento-tab-content" id="tab-email">
                        <div class="orcamento-section-form">
                            <div class="orcamento-field-group">
                                <label style="color: #3b82f6; font-size: 13px;">Utilizar os seguintes endereços de e-mail</label>
                                <textarea id="novo-email-cliente" class="orcamento-textarea" style="min-height: 80px; margin-top: 8px;" placeholder="Digite os e-mails separados por vírgula ou ponto e vírgula"></textarea>
                            </div>
                            
                            <div style="margin-top: 20px; display: flex; flex-direction: column; gap: 12px;">
                                <label class="checkbox-label" style="display: flex; align-items: flex-start; gap: 8px;">
                                    <input type="checkbox" id="novo-email-boleto" style="margin-top: 2px;">
                                    <span style="font-size: 13px; color: #333;">Enviar e-mail com o boleto de cobrança (juntamente com o DANFE e o XML da NF-e)</span>
                                </label>
                                <label class="checkbox-label" style="display: flex; align-items: flex-start; gap: 8px;">
                                    <input type="checkbox" id="novo-email-pix" style="margin-top: 2px;">
                                    <span style="font-size: 13px; color: #333;">Enviar e-mail com o pix de cobrança (juntamente com o DANFE e o XML da NF-e)</span>
                                </label>
                            </div>

                            <!-- Aviso de Conta Corrente -->
                            <div id="aviso-conta-corrente" style="margin-top: 20px; padding: 12px 16px; background: #fef3c7; border-radius: 6px; display: none;">
                                <span style="color: #92400e; font-size: 13px;">A "Conta Corrente" precisa ser informada</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sidebar de Ações -->
                <div class="modal-sidebar-actions" style="display: flex; flex-direction: column; justify-content: space-between;">
                    <div>
                        <button class="sidebar-action-btn primary" onclick="salvarNovoOrcamento()" style="display: flex; align-items: center; gap: 8px;">
                            <i class="fas fa-cloud-upload-alt"></i> Salvar
                        </button>
                    </div>
                    
                    <!-- Botão de navegação circular -->
                    <div style="display: flex; justify-content: center; margin-top: auto; padding-top: 20px;">
                        <button type="button" class="btn-nav-circular" onclick="navegarProximoOrcamento()" title="Próximo registro" style="width: 40px; height: 40px; border-radius: 50%; border: 2px solid #f97316; background: white; color: #f97316; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s;">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Barra de informação inferior (estilo Omie) -->
            <div id="orcamento-info-bar" style="background: linear-gradient(135deg, #fef3c7, #fde68a); padding: 12px 24px; border-top: 1px solid #f59e0b; display: none;">
                <span id="orcamento-info-text" style="color: #92400e; font-size: 13px;"></span>
            </div>
            
            <!-- Botão WhatsApp flutuante -->
            <div style="position: fixed; bottom: 24px; right: 24px; z-index: 10001;">
                <button onclick="abrirWhatsAppOrcamento()" style="width: 56px; height: 56px; background: #25d366; border: none; border-radius: 50%; cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.15); display: flex; align-items: center; justify-content: center;">
                    <i class="fab fa-whatsapp" style="font-size: 28px; color: white;"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Adicionar/Editar Item do Pedido - Estilo Omie -->
    <div class="modal-overlay" id="modal-item-pedido">
        <div class="modal-content-omie" style="max-width: 1100px; height: auto; max-height: 95vh;">
            <!-- Header -->
            <div class="modal-header-item-omie">
                <h2 id="modal-item-titulo">Novo Item de Pedido de Venda</h2>
                <button class="close-btn" onclick="fecharModalItemPedido()">
                    Fechar <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="modal-body-item-omie">
                <input type="hidden" id="item-pedido-id">
                
                <!-- Seção Produto com Barcode -->
                <div class="produto-section-omie">
                    <div class="barcode-icon">
                        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#999" stroke-width="1.5">
                            <path d="M3 5v14M7 5v14M11 5v14M15 5v14M19 5v14M5 5v14M9 5v14M13 5v14M17 5v14M21 5v14"/>
                        </svg>
                    </div>
                    <div class="produto-fields-omie">
                        <div class="produto-row">
                            <div class="field-group" style="flex: 2;">
                                <label>Produto <i class="fas fa-link" style="font-size: 10px; color: #999;"></i></label>
                                <div class="input-autocomplete-container">
                                    <input type="text" id="item-pedido-produto" placeholder="Preencha aqui a Descrição, Código ou EAN do produto" autocomplete="off">
                                    <div class="autocomplete-dropdown" id="produto-autocomplete-dropdown"></div>
                                </div>
                            </div>
                            <div class="field-group" style="flex: 0 0 auto;">
                                <label>&nbsp;</label>
                                <button type="button" class="btn-pesquisar-produto" onclick="abrirPesquisaProduto()">
                                    <i class="fas fa-search"></i> Pesquisar Produto
                                </button>
                            </div>
                            <div class="field-group" style="flex: 1;">
                                <label>CFOP</label>
                                <div class="input-with-search">
                                    <input type="text" id="item-pedido-cfop" placeholder="Preencha aqui a CFOP de Venda">
                                    <button type="button" class="btn-input-search"><i class="fas fa-search"></i></button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Seção Movimentação de Estoque -->
                <div class="section-omie">
                    <h3 class="section-title-omie">Movimentação de Estoque</h3>
                    <div class="section-row">
                        <div class="field-group" style="flex: 0 0 100px;">
                            <label>Quantidade</label>
                            <input type="number" id="item-pedido-quantidade" value="1.0000" step="0.0001" min="0.0001" class="input-number">
                        </div>
                        <div class="field-group" style="flex: 1;">
                            <label>Local de Estoque</label>
                            <select id="item-pedido-estoque">
                                <option value="PADRAO - Local de Estoque Padrão">PADRAO - Local de Estoque Padrão</option>
                                <option value="SECUNDARIO - Estoque Secundário">SECUNDARIO - Estoque Secundário</option>
                                <option value="EXPEDICAO - Expedição">EXPEDICAO - Expedição</option>
                            </select>
                        </div>
                        <div class="field-group checkbox-field">
                            <label class="toggle-label">
                                <input type="checkbox" id="item-nao-gerar-saida">
                                <span class="toggle-switch"></span>
                                Não gerar a saída de estoque ao emitir a NF-e
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Seção Valores e Descontos -->
                <div class="section-omie">
                    <h3 class="section-title-omie">Valores e Descontos</h3>
                    <div class="section-row">
                        <div class="field-group" style="flex: 0 0 120px;">
                            <label>Preço Unitário de Venda</label>
                            <input type="text" id="item-pedido-preco" value="0,000000" class="input-number">
                        </div>
                        <div class="field-group" style="flex: 1;">
                            <label>Tabela de Preço</label>
                            <div class="input-with-search">
                                <input type="text" id="item-pedido-tabela-preco" placeholder="">
                                <button type="button" class="btn-input-search"><i class="fas fa-search"></i></button>
                            </div>
                        </div>
                        <div class="field-group" style="flex: 0 0 150px;">
                            <label>% do Desconto <i class="fas fa-exchange-alt" style="font-size: 10px; color: #999;"></i></label>
                            <input type="text" id="item-pedido-desconto-pct" value="0,0000000000" class="input-number">
                        </div>
                        <div class="field-group checkbox-field">
                            <label class="toggle-label">
                                <input type="checkbox" id="item-nao-gerar-conta">
                                <span class="toggle-switch"></span>
                                Não gerar conta a receber para este item
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Seção Impostos e Informações da NF-e -->
                <div class="section-row-split">
                    <div class="section-omie" style="flex: 1;">
                        <h3 class="section-title-omie">Impostos</h3>
                        <div class="field-group">
                            <label>Cenário Fiscal</label>
                            <div class="input-with-clear">
                                <select id="item-pedido-cenario">
                                    <option value="Padrão">Padrão</option>
                                    <option value="Simples Nacional">Simples Nacional</option>
                                    <option value="Lucro Presumido">Lucro Presumido</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="section-omie" style="flex: 1;">
                        <h3 class="section-title-omie">Informações da NF-e</h3>
                        <div class="section-row">
                            <div class="field-group">
                                <label>Número do Pedido de Compra</label>
                                <input type="text" id="item-pedido-npc">
                            </div>
                            <div class="field-group" style="flex: 0 0 80px;">
                                <label>Item do Pedido de Compra</label>
                                <input type="number" id="item-pedido-item-npc" value="0" class="input-number">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tabela de Valores Calculados -->
                <div class="valores-calculados-table">
                    <div class="valor-calc-item">
                        <span class="valor-calc-label">Valor da Mercadoria</span>
                        <span class="valor-calc-value" id="calc-valor-mercadoria">R$ 0,00</span>
                    </div>
                    <div class="valor-calc-item">
                        <span class="valor-calc-label">Valor do Desconto</span>
                        <span class="valor-calc-value" id="calc-valor-desconto">R$ 0,00</span>
                    </div>
                    <div class="valor-calc-item">
                        <span class="valor-calc-label">IPI</span>
                        <span class="valor-calc-value" id="calc-ipi">R$ 0,00</span>
                    </div>
                    <div class="valor-calc-item">
                        <span class="valor-calc-label">ICMS ST+FCP ST</span>
                        <span class="valor-calc-value" id="calc-icms-st">R$ 0,00</span>
                    </div>
                    <div class="valor-calc-item">
                        <span class="valor-calc-label">Total do Item</span>
                        <span class="valor-calc-value" id="calc-total-item">R$ 0,00</span>
                    </div>
                    <div class="valor-calc-item destaque">
                        <span class="valor-calc-label">Total do Pedido</span>
                        <span class="valor-calc-value" id="calc-total-pedido">R$ 0,00</span>
                    </div>
                </div>

                <!-- Link Observações -->
                <div class="observacoes-link">
                    <button type="button" class="btn-link-obs" onclick="toggleObservacoesItem()">
                        <i class="fas fa-pen"></i> Clique aqui para alterar as observações e informações adicionais da NF-e
                    </button>
                </div>

                <!-- Observações (oculto inicialmente) -->
                <div class="observacoes-container" id="item-observacoes-container" style="display: none;">
                    <div class="field-group">
                        <label>Observações do Item</label>
                        <textarea id="item-pedido-observacoes" rows="3" placeholder="Observações adicionais para este item..."></textarea>
                    </div>
                </div>
            </div>

            <!-- Footer -->
            <div class="modal-footer-item-omie">
                <div class="footer-toggle">
                    <label class="toggle-label">
                        <input type="checkbox" id="item-continuar-incluindo" checked>
                        <span class="toggle-switch"></span>
                        Continuar incluindo mais itens
                    </label>
                </div>
                <button type="button" class="btn-incluir-item" onclick="salvarItemPedido()">
                    Incluir Item
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Adicionar Item ao Orçamento -->
    <div class="modal-overlay" id="modal-adicionar-item">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #22c55e, #16a34a);">
                <h2><i class="fas fa-plus-circle"></i> Adicionar Item</h2>
                <button class="modal-close" onclick="fecharModalAdicionarItem()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Produto *</label>
                    <div class="input-with-btn">
                        <input type="text" id="item-produto" placeholder="Código ou nome do produto" class="orcamento-input">
                        <button type="button" class="btn-input-action"><i class="fas fa-search"></i></button>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Quantidade *</label>
                        <input type="number" id="item-quantidade" value="1" min="1" class="orcamento-input">
                    </div>
                    <div class="form-group">
                        <label>Preço Unitário (R$) *</label>
                        <input type="text" id="item-preco" placeholder="0,00" class="orcamento-input">
                    </div>
                </div>
                <div class="form-group">
                    <label>Local de Estoque</label>
                    <select id="item-estoque" class="orcamento-input">
                        <option value="principal">Estoque Principal</option>
                        <option value="secundario">Estoque Secundário</option>
                        <option value="expedição">Expedição</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-modal btn-modal-cancel" onclick="fecharModalAdicionarItem()">
                    Cancelar
                </button>
                <button type="button" class="btn-modal btn-modal-save" style="background: #22c55e;" onclick="confirmarAdicionarItem()">
                    <i class="fas fa-plus"></i> Adicionar Item
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Confirmar Faturar Todos - Design Premium -->
    <div class="modal-overlay" id="modal-faturar-todos">
        <div class="modal-content" style="max-width: 520px; border-radius: 16px; overflow: hidden; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);">
            <!-- Header Premium -->
            <div class="modal-header" style="background: linear-gradient(135deg, #059669, #10b981); padding: 20px 24px; border: none;">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <div style="width: 42px; height: 42px; background: rgba(255,255,255,0.2); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                        <i class="fas fa-bolt" style="font-size: 20px;"></i>
                    </div>
                    <div>
                        <h2 style="margin: 0; font-size: 18px; font-weight: 600;">Faturar Pedidos</h2>
                        <span style="font-size: 12px; opacity: 0.9;">Geração de notas fiscais em lote</span>
                    </div>
                </div>
                <button class="modal-close" onclick="fecharModalFaturar()" style="background: rgba(255,255,255,0.15); border: none; width: 36px; height: 36px; border-radius: 10px; color: white; cursor: pointer; transition: all 0.2s;">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <!-- Body Premium -->
            <div class="modal-body" style="padding: 0;">
                <!-- Info Card -->
                <div style="background: linear-gradient(135deg, #ecfdf5, #d1fae5); padding: 20px 24px; border-bottom: 1px solid #a7f3d0;">
                    <div style="display: flex; align-items: center; gap: 16px;">
                        <div style="width: 56px; height: 56px; background: white; border-radius: 14px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.2);">
                            <i class="fas fa-file-invoice-dollar" style="font-size: 26px; color: #059669;"></i>
                        </div>
                        <div>
                            <h3 style="margin: 0 0 4px 0; font-size: 16px; color: #065f46; font-weight: 600;">Confirmar Faturamento</h3>
                            <p id="faturar-info" style="margin: 0; color: #047857; font-size: 14px;">Você está prestes a faturar X pedidos.</p>
                        </div>
                    </div>
                </div>
                
                <!-- Lista de Pedidos -->
                <div style="padding: 20px 24px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <span style="font-size: 13px; font-weight: 600; color: #374151; text-transform: uppercase; letter-spacing: 0.5px;">Pedidos Selecionados</span>
                        <span id="faturar-total" style="font-size: 13px; color: #059669; font-weight: 600;"></span>
                    </div>
                    <div id="faturar-lista" style="max-height: 220px; overflow-y: auto; border-radius: 12px; border: 1px solid #e5e7eb; background: #fafafa;"></div>
                </div>
                
                <!-- Alerta Info -->
                <div style="padding: 0 24px 20px 24px;">
                    <div style="background: #fffbeb; border: 1px solid #fcd34d; border-radius: 10px; padding: 12px 16px; display: flex; align-items: flex-start; gap: 12px;">
                        <i class="fas fa-info-circle" style="color: #d97706; font-size: 16px; margin-top: 2px;"></i>
                        <div>
                            <span style="font-size: 13px; color: #92400e; font-weight: 500;">Atenção:</span>
                            <span style="font-size: 13px; color: #a16207;"> Esta ação irá gerar as notas fiscais para todos os pedidos listados acima.</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Footer Premium -->
            <div class="modal-footer" style="background: #f9fafb; padding: 16px 24px; border-top: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center;">
                <button type="button" onclick="fecharModalFaturar()" style="padding: 10px 20px; border: 1px solid #d1d5db; background: white; color: #374151; border-radius: 10px; font-size: 14px; font-weight: 500; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 8px;">
                    <i class="fas fa-times"></i> Cancelar
                </button>
                <button type="button" onclick="confirmarFaturarTodos()" style="padding: 10px 24px; border: none; background: linear-gradient(135deg, #059669, #10b981); color: white; border-radius: 10px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 8px; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);">
                    <i class="fas fa-check-circle"></i> Confirmar Faturamento
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Comunicar SEFAZ -->
    <div class="modal-overlay" id="modal-sefaz">
        <div class="modal-content" style="max-width: 550px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #06b6d4, #0891b2);">
                <h2><i class="fas fa-sync"></i> Comunicar com a SEFAZ</h2>
                <button class="modal-close" onclick="fecharModalSefaz()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body" style="text-align: center; padding: 30px;">
                <div id="sefaz-loading" style="display: none;">
                    <i class="fas fa-spinner fa-spin" style="font-size: 48px; color: #06b6d4; margin-bottom: 20px;"></i>
                    <h3 style="margin-bottom: 10px;">Comunicando com a SEFAZ...</h3>
                    <p style="color: #666;">Aguarde enquanto enviamos os dados.</p>
                </div>
                <div id="sefaz-inicial">
                    <i class="fas fa-building" style="font-size: 48px; color: #06b6d4; margin-bottom: 20px;"></i>
                    <h3 style="margin-bottom: 10px;">Transmitir Notas Fiscais</h3>
                    <p id="sefaz-info" style="color: #666; margin-bottom: 20px;">X notas fiscais prontas para transmissão.</p>
                    <div id="sefaz-lista" style="text-align: left; max-height: 200px; overflow-y: auto; background: #f5f5f5; border-radius: 8px; padding: 12px; margin-bottom: 20px;"></div>
                </div>
                <div id="sefaz-resultado" style="display: none;">
                    <i class="fas fa-check-circle" style="font-size: 48px; color: #22c55e; margin-bottom: 20px;"></i>
                    <h3 style="margin-bottom: 10px;">Transmissão Concluída!</h3>
                    <p id="sefaz-resultado-info" style="color: #666;"></p>
                </div>
            </div>
            <div class="modal-footer" style="justify-content: center;">
                <button type="button" class="btn-modal btn-modal-cancel" onclick="fecharModalSefaz()">
                    Fechar
                </button>
                <button type="button" id="btn-transmitir-sefaz" class="btn-modal btn-modal-save" style="background: #06b6d4;" onclick="transmitirSefaz()">
                    <i class="fas fa-paper-plane"></i> Transmitir para SEFAZ
                </button>
            </div>
        </div>
    </div>

    <!-- Chat Button -->
    <!-- Removido - Chat agora é carregado via /js/chat-suporte-widgets.js -->

    <!-- ========================================
         MODAIS SECUNDÁRIOS DO ORÇAMENTO
         ======================================== -->
    
    <!-- Modal NFs Relacionadas -->
    <div class="modal-overlay" id="modal-nfs-relacionadas">
        <div class="modal-content-omie" style="max-width: 700px; border-radius: 12px;">
            <div class="modal-header-omie" style="background: linear-gradient(135deg, #3b82f6, #2563eb);">
                <h2><i class="fas fa-file-alt"></i> Notas Fiscais Relacionadas</h2>
                <button class="close-btn" onclick="fecharModalNFsRelacionadas()">
                    Fechar <i class="fas fa-times"></i>
                </button>
            </div>
            <div style="padding: 24px;">
                <p style="color: #666; margin-bottom: 16px;">Vincule notas fiscais de compra ou outras NF-e relacionadas a este orçamento.</p>
                
                <div style="display: flex; gap: 12px; margin-bottom: 20px;">
                    <input type="text" id="nf-relacionada-numero" placeholder="Número da NF" style="flex: 1; padding: 10px 12px; border: 1px solid #ddd; border-radius: 8px;">
                    <input type="text" id="nf-relacionada-serie" placeholder="Série" style="width: 80px; padding: 10px 12px; border: 1px solid #ddd; border-radius: 8px;">
                    <input type="text" id="nf-relacionada-chave" placeholder="Chave de Acesso (44 dígitos)" style="flex: 2; padding: 10px 12px; border: 1px solid #ddd; border-radius: 8px;">
                    <button onclick="adicionarNFRelacionada()" style="background: #3b82f6; color: white; border: none; padding: 10px 16px; border-radius: 8px; cursor: pointer;">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
                
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="background: #f8fafc; border-bottom: 2px solid #e2e8f0;">
                            <th style="padding: 12px; text-align: left; font-weight: 600; color: #475569;">Número</th>
                            <th style="padding: 12px; text-align: left; font-weight: 600; color: #475569;">Série</th>
                            <th style="padding: 12px; text-align: left; font-weight: 600; color: #475569;">Chave de Acesso</th>
                            <th style="padding: 12px; text-align: center; font-weight: 600; color: #475569;">Ações</th>
                        </tr>
                    </thead>
                    <tbody id="nfs-relacionadas-lista">
                        <tr>
                            <td colspan="4" style="padding: 30px; text-align: center; color: #999;">
                                <i class="fas fa-file-invoice" style="font-size: 32px; margin-bottom: 8px; opacity: 0.5;"></i>
                                <p style="margin: 0;">Nenhuma NF relacionada</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div style="padding: 16px 24px; background: #f8fafc; border-top: 1px solid #e2e8f0; display: flex; justify-content: flex-end; gap: 12px;">
                <button onclick="fecharModalNFsRelacionadas()" style="background: white; color: #475569; border: 1px solid #e2e8f0; padding: 10px 20px; border-radius: 8px; cursor: pointer;">Cancelar</button>
                <button onclick="salvarNFsRelacionadas()" style="background: #3b82f6; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer;">Salvar</button>
            </div>
        </div>
    </div>

    <!-- Modal Info Fisco -->
    <div class="modal-overlay" id="modal-info-fisco">
        <div class="modal-content-omie" style="max-width: 600px; border-radius: 12px;">
            <div class="modal-header-omie" style="background: linear-gradient(135deg, #059669, #047857);">
                <h2><i class="fas fa-university"></i> Informações do Fisco</h2>
                <button class="close-btn" onclick="fecharModalInfoFisco()">
                    Fechar <i class="fas fa-times"></i>
                </button>
            </div>
            <div style="padding: 24px;">
                <p style="color: #666; margin-bottom: 16px;">Informações adicionais para o fisco que serão incluídas na NF-e.</p>
                
                <div style="margin-bottom: 16px;">
                    <label style="display: block; font-size: 13px; color: #475569; margin-bottom: 6px; font-weight: 500;">Informações ao Fisco</label>
                    <textarea id="info-fisco-texto" rows="4" placeholder="Informe dados relevantes para a fiscalização..." style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; resize: vertical;"></textarea>
                    <span style="font-size: 11px; color: #999;">Ex: Operação beneficiada por incentivo fiscal, isenção de ICMS conforme convênio X...</span>
                </div>
                
                <div style="background: #fef3c7; padding: 12px 16px; border-radius: 8px; border-left: 3px solid #f59e0b; margin-top: 16px;">
                    <p style="margin: 0; font-size: 12px; color: #92400e;">
                        <i class="fas fa-exclamation-triangle" style="margin-right: 8px;"></i>
                        Estas informações aparecerão no campo de Informações Complementares da NF-e e serão validadas pela SEFAZ.
                    </p>
                </div>
            </div>
            <div style="padding: 16px 24px; background: #f8fafc; border-top: 1px solid #e2e8f0; display: flex; justify-content: flex-end; gap: 12px;">
                <button onclick="fecharModalInfoFisco()" style="background: white; color: #475569; border: 1px solid #e2e8f0; padding: 10px 20px; border-radius: 8px; cursor: pointer;">Cancelar</button>
                <button onclick="salvarInfoFisco()" style="background: #059669; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer;">Salvar</button>
            </div>
        </div>
    </div>

    <!-- Modal Campos Obs NF-e -->
    <div class="modal-overlay" id="modal-campos-obs-nfe">
        <div class="modal-content-omie" style="max-width: 650px; border-radius: 12px;">
            <div class="modal-header-omie" style="background: linear-gradient(135deg, #7c3aed, #6d28d9);">
                <h2><i class="fas fa-sticky-note"></i> Campos de Observação NF-e</h2>
                <button class="close-btn" onclick="fecharModalCamposObsNFe()">
                    Fechar <i class="fas fa-times"></i>
                </button>
            </div>
            <div style="padding: 24px;">
                <div style="margin-bottom: 16px;">
                    <label style="display: block; font-size: 13px; color: #475569; margin-bottom: 6px; font-weight: 500;">Campo do Contribuinte</label>
                    <div style="display: flex; gap: 12px;">
                        <input type="text" id="obs-campo" placeholder="Nome do campo" style="flex: 1; padding: 10px 12px; border: 1px solid #ddd; border-radius: 8px;">
                        <input type="text" id="obs-valor" placeholder="Valor" style="flex: 2; padding: 10px 12px; border: 1px solid #ddd; border-radius: 8px;">
                        <button onclick="adicionarCampoObs()" style="background: #7c3aed; color: white; border: none; padding: 10px 16px; border-radius: 8px; cursor: pointer;">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                </div>
                
                <div id="campos-obs-lista" style="max-height: 200px; overflow-y: auto;">
                    <div style="padding: 20px; text-align: center; color: #999; background: #f8fafc; border-radius: 8px;">
                        <i class="fas fa-list" style="font-size: 24px; margin-bottom: 8px; opacity: 0.5;"></i>
                        <p style="margin: 0; font-size: 13px;">Nenhum campo adicional</p>
                    </div>
                </div>
                
                <div style="background: #dbeafe; padding: 12px 16px; border-radius: 8px; margin-top: 16px;">
                    <p style="margin: 0; font-size: 12px; color: #1e40af;">
                        <i class="fas fa-info-circle" style="margin-right: 8px;"></i>
                        Estes campos serão incluídos na tag obsCont da NF-e.
                    </p>
                </div>
            </div>
            <div style="padding: 16px 24px; background: #f8fafc; border-top: 1px solid #e2e8f0; display: flex; justify-content: flex-end; gap: 12px;">
                <button onclick="fecharModalCamposObsNFe()" style="background: white; color: #475569; border: 1px solid #e2e8f0; padding: 10px 20px; border-radius: 8px; cursor: pointer;">Cancelar</button>
                <button onclick="salvarCamposObsNFe()" style="background: #7c3aed; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer;">Salvar</button>
            </div>
        </div>
    </div>

    <!-- Modal Endereço de Entrega -->
    <div class="modal-overlay" id="modal-endereco-entrega">
        <div class="modal-content-omie" style="max-width: 700px; border-radius: 12px;">
            <div class="modal-header-omie" style="background: linear-gradient(135deg, #f97316, #ea580c);">
                <h2><i class="fas fa-truck"></i> Endereço de Entrega</h2>
                <button class="close-btn" onclick="fecharModalEnderecoEntrega()">
                    Fechar <i class="fas fa-times"></i>
                </button>
            </div>
            <div style="padding: 24px;">
                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 20px;">
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" id="usar-endereco-cliente" checked onchange="toggleEnderecoEntrega()">
                        <span style="font-size: 14px; color: #475569;">Usar mesmo endereço do cliente</span>
                    </label>
                </div>
                
                <div id="form-endereco-entrega" style="display: none;">
                    <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 12px; margin-bottom: 16px;">
                        <div>
                            <label style="display: block; font-size: 12px; color: #666; margin-bottom: 4px;">CEP</label>
                            <input type="text" id="entrega-cep" placeholder="00000-000" onblur="buscarCepEntrega()" style="width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 8px;">
                        </div>
                        <div>
                            <label style="display: block; font-size: 12px; color: #666; margin-bottom: 4px;">Logradouro</label>
                            <input type="text" id="entrega-logradouro" placeholder="Rua, Av..." style="width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 8px;">
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 100px 1fr 150px; gap: 12px; margin-bottom: 16px;">
                        <div>
                            <label style="display: block; font-size: 12px; color: #666; margin-bottom: 4px;">Número</label>
                            <input type="text" id="entrega-numero" placeholder="Nº" style="width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 8px;">
                        </div>
                        <div>
                            <label style="display: block; font-size: 12px; color: #666; margin-bottom: 4px;">Complemento</label>
                            <input type="text" id="entrega-complemento" placeholder="Apto, Sala..." style="width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 8px;">
                        </div>
                        <div>
                            <label style="display: block; font-size: 12px; color: #666; margin-bottom: 4px;">Bairro</label>
                            <input type="text" id="entrega-bairro" placeholder="Bairro" style="width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 8px;">
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 2fr 80px; gap: 12px;">
                        <div>
                            <label style="display: block; font-size: 12px; color: #666; margin-bottom: 4px;">Cidade</label>
                            <input type="text" id="entrega-cidade" placeholder="Cidade" style="width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 8px;">
                        </div>
                        <div>
                            <label style="display: block; font-size: 12px; color: #666; margin-bottom: 4px;">UF</label>
                            <input type="text" id="entrega-uf" placeholder="UF" maxlength="2" style="width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 8px;">
                        </div>
                    </div>
                </div>
            </div>
            <div style="padding: 16px 24px; background: #f8fafc; border-top: 1px solid #e2e8f0; display: flex; justify-content: flex-end; gap: 12px;">
                <button onclick="fecharModalEnderecoEntrega()" style="background: white; color: #475569; border: 1px solid #e2e8f0; padding: 10px 20px; border-radius: 8px; cursor: pointer;">Cancelar</button>
                <button onclick="salvarEnderecoEntrega()" style="background: #f97316; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer;">Salvar</button>
            </div>
        </div>
    </div>

    <!-- Modal ICMS Retido Transporte -->
    <div class="modal-overlay" id="modal-icms-transporte">
        <div class="modal-content-omie" style="max-width: 550px; border-radius: 12px;">
            <div class="modal-header-omie" style="background: linear-gradient(135deg, #0891b2, #0e7490);">
                <h2><i class="fas fa-percentage"></i> ICMS Retido no Transporte</h2>
                <button class="close-btn" onclick="fecharModalICMSTransporte()">
                    Fechar <i class="fas fa-times"></i>
                </button>
            </div>
            <div style="padding: 24px;">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <div>
                        <label style="display: block; font-size: 12px; color: #666; margin-bottom: 4px;">Valor Serviço (R$)</label>
                        <input type="text" id="icms-valor-servico" placeholder="0,00" style="width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 8px;">
                    </div>
                    <div>
                        <label style="display: block; font-size: 12px; color: #666; margin-bottom: 4px;">Base de Cálculo (R$)</label>
                        <input type="text" id="icms-base-calculo" placeholder="0,00" style="width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 8px;">
                    </div>
                    <div>
                        <label style="display: block; font-size: 12px; color: #666; margin-bottom: 4px;">Alíquota ICMS (%)</label>
                        <input type="text" id="icms-aliquota" placeholder="0,00" style="width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 8px;">
                    </div>
                    <div>
                        <label style="display: block; font-size: 12px; color: #666; margin-bottom: 4px;">Valor ICMS Retido (R$)</label>
                        <input type="text" id="icms-valor-retido" placeholder="0,00" style="width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 8px;">
                    </div>
                    <div>
                        <label style="display: block; font-size: 12px; color: #666; margin-bottom: 4px;">CFOP</label>
                        <input type="text" id="icms-cfop" placeholder="0000" style="width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 8px;">
                    </div>
                    <div>
                        <label style="display: block; font-size: 12px; color: #666; margin-bottom: 4px;">Código Município</label>
                        <input type="text" id="icms-cod-municipio" placeholder="0000000" style="width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 8px;">
                    </div>
                </div>
            </div>
            <div style="padding: 16px 24px; background: #f8fafc; border-top: 1px solid #e2e8f0; display: flex; justify-content: flex-end; gap: 12px;">
                <button onclick="fecharModalICMSTransporte()" style="background: white; color: #475569; border: 1px solid #e2e8f0; padding: 10px 20px; border-radius: 8px; cursor: pointer;">Cancelar</button>
                <button onclick="salvarICMSTransporte()" style="background: #0891b2; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer;">Salvar</button>
            </div>
        </div>
    </div>

    <!-- ========================================
         MODAL INCLUIR CLIENTE - ESTILO PROFISSIONAL
         ======================================== -->
    <div class="modal-overlay" id="modal-novo-cliente">
        <div class="modal-content-omie" style="max-width: 720px; border-radius: 16px; overflow: hidden; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);">
            <div class="modal-header-omie" style="background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%); padding: 24px 28px; position: relative;">
                <div>
                    <h2 style="color: white; font-size: 24px; font-weight: 600; margin: 0 0 4px 0;"><i class="fas fa-user-plus" style="margin-right: 10px;"></i>Incluir Cliente</h2>
                    <p style="font-size: 13px; color: rgba(255,255,255,0.85); margin: 0;">Utilize uma das opções de pesquisa abaixo para cadastrar rapidamente</p>
                </div>
                <button class="close-btn" onclick="verificarAlteracoesCliente()" style="color: white; background: rgba(255,255,255,0.15); border: none; font-size: 13px; padding: 8px 16px; border-radius: 8px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.25)'" onmouseout="this.style.background='rgba(255,255,255,0.15)'">
                    Fechar <i class="fas fa-times" style="margin-left: 6px;"></i>
                </button>
            </div>
            
            <div class="modal-body-cliente" style="padding: 24px 28px; max-height: calc(90vh - 140px); overflow-y: auto; background: #f8fafc;">
                <!-- Pesquisa Atômica -->
                <div class="cliente-opcao-pesquisa" style="margin-bottom: 16px; border-radius: 12px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                    <div style="background: linear-gradient(135deg, #1e40af 0%, #2563eb 100%); color: white; padding: 16px 20px; display: flex; justify-content: space-between; align-items: center;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <i class="fas fa-bolt" style="font-size: 18px;"></i>
                            <h3 style="margin: 0; font-size: 16px; font-weight: 600;">Pesquisa Inteligente</h3>
                        </div>
                        <div style="text-align: right; font-size: 11px; background: rgba(255,255,255,0.15); padding: 6px 12px; border-radius: 20px;">
                            <span><i class="fas fa-infinity" style="margin-right: 4px;"></i> Pesquisas ilimitadas</span>
                        </div>
                    </div>
                    <div style="background: #fff; border: 1px solid #e2e8f0; border-top: none; padding: 20px;">
                        <label style="display: block; font-size: 12px; color: #64748b; margin-bottom: 8px; font-weight: 500;">Digite aqui o que deseja pesquisar</label>
                        <div style="display: flex; gap: 10px;">
                            <input type="text" id="pesquisa-atomica" placeholder="CNPJ, CPF, Nome, Razão Social, Telefone ou E-mail" style="flex: 1; padding: 14px 16px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 14px; transition: all 0.2s;" onfocus="this.style.borderColor='#3b82f6'; this.style.boxShadow='0 0 0 3px rgba(59,130,246,0.1)'" onblur="this.style.borderColor='#e2e8f0'; this.style.boxShadow='none'">
                            <button onclick="pesquisarAtomico()" style="padding: 14px 20px; background: linear-gradient(135deg, #1e40af, #3b82f6); color: white; border: none; border-radius: 10px; cursor: pointer; font-weight: 500; transition: all 0.2s;" onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 12px rgba(59,130,246,0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Pesquisa por CNPJ/CPF -->
                <div class="cliente-opcao-pesquisa" onclick="expandirPesquisaCNPJ()" style="cursor: pointer; margin-bottom: 12px; background: linear-gradient(135deg, #0f766e 0%, #14b8a6 100%); color: white; padding: 18px 20px; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; transition: all 0.2s; box-shadow: 0 1px 3px rgba(0,0,0,0.1);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(20,184,166,0.3)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 1px 3px rgba(0,0,0,0.1)'">
                    <div>
                        <h3 style="margin: 0 0 4px 0; font-size: 15px; font-weight: 600; display: flex; align-items: center; gap: 8px;"><i class="fas fa-id-card"></i> Pesquisa por CNPJ / CPF</h3>
                        <p style="margin: 0; font-size: 12px; opacity: 0.9;">Consulta automática na Receita Federal</p>
                    </div>
                    <div style="display: flex; align-items: center; gap: 10px; background: rgba(255,255,255,0.2); padding: 8px 14px; border-radius: 8px;">
                        <i class="fas fa-search" style="font-size: 16px;"></i>
                        <span style="font-size: 18px; font-weight: 700;">CNPJ</span>
                    </div>
                </div>
                
                <!-- Campo CNPJ expandido -->
                <div id="pesquisa-cnpj-expandido" style="display: none; background: #fff; border: 2px solid #14b8a6; border-radius: 12px; padding: 20px; margin-bottom: 12px; margin-top: -8px; box-shadow: 0 4px 12px rgba(20,184,166,0.15);">
                    <div style="display: flex; gap: 12px; align-items: flex-end;">
                        <div style="flex: 1;">
                            <label style="display: block; font-size: 12px; color: #64748b; margin-bottom: 8px; font-weight: 500;">CNPJ ou CPF</label>
                            <input type="text" id="cliente-cnpj" placeholder="00.000.000/0000-00" style="width: 100%; padding: 14px 16px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 15px; transition: all 0.2s;" oninput="formatarCNPJ(this)" onfocus="this.style.borderColor='#14b8a6'" onblur="this.style.borderColor='#e2e8f0'">
                        </div>
                        <button onclick="consultarCNPJ()" style="padding: 14px 24px; background: linear-gradient(135deg, #0f766e, #14b8a6); color: white; border: none; border-radius: 10px; cursor: pointer; font-weight: 600; transition: all 0.2s;" onmouseover="this.style.transform='translateY(-1px)'" onmouseout="this.style.transform='translateY(0)'">
                            <i class="fas fa-search" style="margin-right: 6px;"></i> Consultar
                        </button>
                    </div>
                    <div id="cnpj-loading" style="display: none; padding: 12px; background: #eff6ff; border-radius: 8px; margin-top: 12px;">
                        <i class="fas fa-spinner fa-spin" style="color: #3b82f6;"></i>
                        <span style="margin-left: 8px; color: #1e40af;">Consultando na Receita Federal...</span>
                    </div>
                    <div id="cnpj-resultado" style="display: none; padding: 12px; background: #f0fdf4; border: 1px solid #86efac; border-radius: 8px; margin-top: 12px;">
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                            <i class="fas fa-check-circle" style="color: #22c55e;"></i>
                            <span style="font-weight: 600; color: #166534;">CNPJ encontrado!</span>
                        </div>
                        <p id="cnpj-info" style="font-size: 13px; color: #166534; margin: 0;"></p>
                    </div>
                </div>

                <!-- Pesquisa no Google -->
                <div class="cliente-opcao-pesquisa" onclick="expandirPesquisaGoogle()" style="cursor: pointer; margin-bottom: 12px; background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%); color: #334155; padding: 18px 20px; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; transition: all 0.2s; border: 1px solid #e2e8f0; box-shadow: 0 1px 3px rgba(0,0,0,0.05);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.1)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 1px 3px rgba(0,0,0,0.05)'">
                    <div>
                        <h3 style="margin: 0 0 4px 0; font-size: 15px; font-weight: 600; display: flex; align-items: center; gap: 8px;"><i class="fas fa-globe" style="color: #4285f4;"></i> Pesquisa no Google</h3>
                        <p style="margin: 0; font-size: 12px; color: #64748b;">Busque por nome, razão social ou endereço</p>
                    </div>
                    <div style="display: flex; align-items: center; gap: 6px; background: white; padding: 8px 14px; border-radius: 8px; border: 1px solid #e2e8f0;">
                        <span style="font-size: 11px; color: #94a3b8;">by</span>
                        <svg viewBox="0 0 272 92" width="60" height="20">
                            <path fill="#4285F4" d="M115.75 47.18c0 12.77-9.99 22.18-22.25 22.18s-22.25-9.41-22.25-22.18C71.25 34.32 81.24 25 93.5 25s22.25 9.32 22.25 22.18zm-9.74 0c0-7.98-5.79-13.44-12.51-13.44S80.99 39.2 80.99 47.18c0 7.9 5.79 13.44 12.51 13.44s12.51-5.55 12.51-13.44z"/>
                            <path fill="#EA4335" d="M163.75 47.18c0 12.77-9.99 22.18-22.25 22.18s-22.25-9.41-22.25-22.18c0-12.85 9.99-22.18 22.25-22.18s22.25 9.32 22.25 22.18zm-9.74 0c0-7.98-5.79-13.44-12.51-13.44s-12.51 5.46-12.51 13.44c0 7.9 5.79 13.44 12.51 13.44s12.51-5.55 12.51-13.44z"/>
                            <path fill="#FBBC05" d="M209.75 26.34v39.82c0 16.38-9.66 23.07-21.08 23.07-10.75 0-17.22-7.19-19.66-13.07l8.48-3.53c1.51 3.61 5.21 7.87 11.17 7.87 7.31 0 11.84-4.51 11.84-13v-3.19h-.34c-2.18 2.69-6.38 5.04-11.68 5.04-11.09 0-21.25-9.66-21.25-22.09 0-12.52 10.16-22.26 21.25-22.26 5.29 0 9.49 2.35 11.68 4.96h.34v-3.61h9.25zm-8.56 20.92c0-7.81-5.21-13.52-11.84-13.52-6.72 0-12.35 5.71-12.35 13.52 0 7.73 5.63 13.36 12.35 13.36 6.63 0 11.84-5.63 11.84-13.36z"/>
                            <path fill="#4285F4" d="M225 3v65h-9.5V3h9.5z"/>
                            <path fill="#34A853" d="M262.02 54.48l7.56 5.04c-2.44 3.61-8.32 9.83-18.48 9.83-12.6 0-22.01-9.74-22.01-22.18 0-13.19 9.49-22.18 20.92-22.18 11.51 0 17.14 9.16 18.98 14.11l1.01 2.52-29.65 12.28c2.27 4.45 5.8 6.72 10.75 6.72 4.96 0 8.4-2.44 10.92-6.14zm-23.27-7.98l19.82-8.23c-1.09-2.77-4.37-4.7-8.23-4.7-4.95 0-11.84 4.37-11.59 12.93z"/>
                            <path fill="#EA4335" d="M35.29 41.41V32H67c.31 1.64.47 3.58.47 5.68 0 7.06-1.93 15.79-8.15 22.01-6.05 6.3-13.78 9.66-24.02 9.66C16.32 69.35.36 53.89.36 34.91.36 15.93 16.32.47 35.3.47c10.5 0 17.98 4.12 23.6 9.49l-6.64 6.64c-4.03-3.78-9.49-6.72-16.97-6.72-13.86 0-24.7 11.17-24.7 25.03 0 13.86 10.84 25.03 24.7 25.03 8.99 0 14.11-3.61 17.39-6.89 2.66-2.66 4.41-6.46 5.1-11.65l-22.49.01z"/>
                        </svg>
                    </div>
                </div>

                <!-- Campo Google expandido -->
                <div id="pesquisa-google-expandido" style="display: none; background: #fff; border: 2px solid #4285f4; border-radius: 12px; padding: 20px; margin-bottom: 12px; margin-top: -8px; box-shadow: 0 4px 12px rgba(66,133,244,0.15);">
                    <div style="display: flex; gap: 12px; align-items: flex-end;">
                        <div style="flex: 1;">
                            <label style="display: block; font-size: 12px; color: #64748b; margin-bottom: 8px; font-weight: 500;">Pesquisar no Google</label>
                            <input type="text" id="pesquisa-google" placeholder="Nome da empresa, endereço, telefone..." style="width: 100%; padding: 14px 16px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 15px; transition: all 0.2s;" onfocus="this.style.borderColor='#4285f4'" onblur="this.style.borderColor='#e2e8f0'">
                        </div>
                        <button onclick="pesquisarGoogle()" style="padding: 14px 24px; background: #4285f4; color: white; border: none; border-radius: 10px; cursor: pointer; font-weight: 600; transition: all 0.2s; display: flex; align-items: center; gap: 8px;" onmouseover="this.style.background='#3367d6'" onmouseout="this.style.background='#4285f4'">
                            <i class="fas fa-search"></i> Pesquisar
                        </button>
                    </div>
                </div>

                <!-- Inserção Manual -->
                <div class="cliente-opcao-pesquisa" onclick="expandirInsercaoManual()" style="cursor: pointer; background: linear-gradient(135deg, #475569 0%, #64748b 100%); color: white; padding: 18px 20px; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; transition: all 0.2s; box-shadow: 0 1px 3px rgba(0,0,0,0.1);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(71,85,105,0.3)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 1px 3px rgba(0,0,0,0.1)'">
                    <div>
                        <h3 style="margin: 0 0 4px 0; font-size: 15px; font-weight: 600; display: flex; align-items: center; gap: 8px;"><i class="fas fa-edit"></i> Inserção Manual</h3>
                        <p style="margin: 0; font-size: 12px; opacity: 0.9;">Cadastre os dados manualmente ou pesquise pelo CEP</p>
                    </div>
                    <div style="background: rgba(255,255,255,0.15); padding: 10px; border-radius: 10px;">
                        <i class="fas fa-keyboard" style="font-size: 24px;"></i>
                    </div>
                </div>

                <!-- Formulário Manual Expandido -->
                <div id="insercao-manual-expandido" style="display: none; background: #fff; border: 2px solid #64748b; border-radius: 12px; padding: 24px; margin-top: 8px; box-shadow: 0 4px 12px rgba(71,85,105,0.15);">
                    <h4 style="font-size: 15px; color: #1e293b; margin: 0 0 20px 0; display: flex; align-items: center; gap: 10px; padding-bottom: 12px; border-bottom: 1px solid #e2e8f0;">
                        <i class="fas fa-building" style="color: #3b82f6;"></i> Dados do Cliente
                    </h4>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                        <div>
                            <label style="display: block; font-size: 12px; color: #64748b; margin-bottom: 6px; font-weight: 500;">CNPJ/CPF</label>
                            <input type="text" id="manual-cnpj" placeholder="00.000.000/0000-00" style="width: 100%; padding: 12px 14px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; transition: all 0.2s;" onfocus="this.style.borderColor='#3b82f6'; this.style.boxShadow='0 0 0 3px rgba(59,130,246,0.1)'" onblur="this.style.borderColor='#e2e8f0'; this.style.boxShadow='none'">
                        </div>
                        <div>
                            <label style="display: block; font-size: 12px; color: #64748b; margin-bottom: 6px; font-weight: 500;">Tipo de Pessoa</label>
                            <select id="manual-tipo-pessoa" style="width: 100%; padding: 12px 14px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; background: white; cursor: pointer; transition: all 0.2s;" onfocus="this.style.borderColor='#3b82f6'" onblur="this.style.borderColor='#e2e8f0'">
                                <option value="PJ">Pessoa Jurídica</option>
                                <option value="PF">Pessoa Física</option>
                            </select>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 16px;">
                        <label style="display: block; font-size: 12px; color: #64748b; margin-bottom: 6px; font-weight: 500;">Razão Social / Nome <span style="color: #ef4444;">*</span></label>
                        <input type="text" id="manual-razao-social" placeholder="Nome completo da empresa ou pessoa" style="width: 100%; padding: 12px 14px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; transition: all 0.2s;" onfocus="this.style.borderColor='#3b82f6'; this.style.boxShadow='0 0 0 3px rgba(59,130,246,0.1)'" onblur="this.style.borderColor='#e2e8f0'; this.style.boxShadow='none'">
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                        <div>
                            <label style="display: block; font-size: 12px; color: #64748b; margin-bottom: 6px; font-weight: 500;">Nome Fantasia</label>
                            <input type="text" id="manual-fantasia" placeholder="Nome fantasia" style="width: 100%; padding: 12px 14px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; transition: all 0.2s;" onfocus="this.style.borderColor='#3b82f6'" onblur="this.style.borderColor='#e2e8f0'">
                        </div>
                        <div>
                            <label style="display: block; font-size: 12px; color: #64748b; margin-bottom: 6px; font-weight: 500;">Inscrição Estadual</label>
                            <input type="text" id="manual-ie" placeholder="Isento ou nº IE" style="width: 100%; padding: 12px 14px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; transition: all 0.2s;" onfocus="this.style.borderColor='#3b82f6'" onblur="this.style.borderColor='#e2e8f0'">
                        </div>
                    </div>
                    
                    <h4 style="font-size: 15px; color: #1e293b; margin: 24px 0 16px 0; display: flex; align-items: center; gap: 10px; padding-bottom: 12px; border-bottom: 1px solid #e2e8f0;">
                        <i class="fas fa-map-marker-alt" style="color: #3b82f6;"></i> Endereço
                    </h4>
                    
                    <div style="display: grid; grid-template-columns: 150px 1fr 100px; gap: 12px; margin-bottom: 12px;">
                        <div>
                            <label style="display: block; font-size: 12px; color: #64748b; margin-bottom: 6px; font-weight: 500;">CEP</label>
                            <div style="display: flex; gap: 4px;">
                                <input type="text" id="manual-cep" placeholder="00000-000" style="flex: 1; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; transition: all 0.2s;" oninput="formatarCEP(this)" onfocus="this.style.borderColor='#3b82f6'" onblur="this.style.borderColor='#e2e8f0'">
                                <button onclick="consultarCEPManual()" style="padding: 12px; background: linear-gradient(135deg, #1e40af, #3b82f6); color: white; border: none; border-radius: 8px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                                    <i class="fas fa-search"></i>
                                </button>
                            </div>
                        </div>
                        <div>
                            <label style="display: block; font-size: 12px; color: #64748b; margin-bottom: 6px; font-weight: 500;">Logradouro</label>
                            <input type="text" id="manual-logradouro" placeholder="Rua, Avenida, etc." style="width: 100%; padding: 12px 14px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; transition: all 0.2s;" onfocus="this.style.borderColor='#3b82f6'" onblur="this.style.borderColor='#e2e8f0'">
                        </div>
                        <div>
                            <label style="display: block; font-size: 12px; color: #64748b; margin-bottom: 6px; font-weight: 500;">Número</label>
                            <input type="text" id="manual-numero" placeholder="Nº" style="width: 100%; padding: 12px 14px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; transition: all 0.2s;" onfocus="this.style.borderColor='#3b82f6'" onblur="this.style.borderColor='#e2e8f0'">
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 90px; gap: 16px; margin-bottom: 16px;">
                        <div>
                            <label style="display: block; font-size: 12px; color: #64748b; margin-bottom: 6px; font-weight: 500;">Complemento</label>
                            <input type="text" id="manual-complemento" placeholder="Sala, Bloco" style="width: 100%; padding: 12px 14px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; transition: all 0.2s;" onfocus="this.style.borderColor='#3b82f6'" onblur="this.style.borderColor='#e2e8f0'">
                        </div>
                        <div>
                            <label style="display: block; font-size: 12px; color: #64748b; margin-bottom: 6px; font-weight: 500;">Bairro</label>
                            <input type="text" id="manual-bairro" placeholder="Bairro" style="width: 100%; padding: 12px 14px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; transition: all 0.2s;" onfocus="this.style.borderColor='#3b82f6'" onblur="this.style.borderColor='#e2e8f0'">
                        </div>
                        <div>
                            <label style="display: block; font-size: 12px; color: #64748b; margin-bottom: 6px; font-weight: 500;">Cidade</label>
                            <input type="text" id="manual-cidade" placeholder="Cidade" style="width: 100%; padding: 12px 14px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; transition: all 0.2s;" onfocus="this.style.borderColor='#3b82f6'" onblur="this.style.borderColor='#e2e8f0'">
                        </div>
                        <div>
                            <label style="display: block; font-size: 12px; color: #64748b; margin-bottom: 6px; font-weight: 500;">UF</label>
                            <select id="manual-uf" style="width: 100%; padding: 12px 10px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; background: white; cursor: pointer; transition: all 0.2s;" onfocus="this.style.borderColor='#3b82f6'" onblur="this.style.borderColor='#e2e8f0'">
                                <option value="">UF</option>
                                <option value="AC">AC</option><option value="AL">AL</option><option value="AP">AP</option>
                                <option value="AM">AM</option><option value="BA">BA</option><option value="CE">CE</option>
                                <option value="DF">DF</option><option value="ES">ES</option><option value="GO">GO</option>
                                <option value="MA">MA</option><option value="MT">MT</option><option value="MS">MS</option>
                                <option value="MG">MG</option><option value="PA">PA</option><option value="PB">PB</option>
                                <option value="PR">PR</option><option value="PE">PE</option><option value="PI">PI</option>
                                <option value="RJ">RJ</option><option value="RN">RN</option><option value="RS">RS</option>
                                <option value="RO">RO</option><option value="RR">RR</option><option value="SC">SC</option>
                                <option value="SP">SP</option><option value="SE">SE</option><option value="TO">TO</option>
                            </select>
                        </div>
                    </div>
                    
                    <h4 style="font-size: 15px; color: #1e293b; margin: 24px 0 16px 0; display: flex; align-items: center; gap: 10px; padding-bottom: 12px; border-bottom: 1px solid #e2e8f0;">
                        <i class="fas fa-phone-alt" style="color: #3b82f6;"></i> Contato
                    </h4>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr 2fr; gap: 12px; margin-bottom: 16px;">
                        <div>
                            <label style="display: block; font-size: 12px; color: #64748b; margin-bottom: 6px; font-weight: 500;">Telefone</label>
                            <input type="text" id="manual-telefone" placeholder="(00) 0000-0000" style="width: 100%; padding: 12px 14px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; transition: all 0.2s;" onfocus="this.style.borderColor='#3b82f6'" onblur="this.style.borderColor='#e2e8f0'">
                        </div>
                        <div>
                            <label style="display: block; font-size: 12px; color: #64748b; margin-bottom: 6px; font-weight: 500;">Celular/WhatsApp</label>
                            <input type="text" id="manual-celular" placeholder="(00) 00000-0000" style="width: 100%; padding: 12px 14px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; transition: all 0.2s;" onfocus="this.style.borderColor='#3b82f6'" onblur="this.style.borderColor='#e2e8f0'">
                        </div>
                        <div>
                            <label style="display: block; font-size: 12px; color: #64748b; margin-bottom: 6px; font-weight: 500;">E-mail</label>
                            <input type="email" id="manual-email" placeholder="email@empresa.com.br" style="width: 100%; padding: 12px 14px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; transition: all 0.2s;" onfocus="this.style.borderColor='#3b82f6'" onblur="this.style.borderColor='#e2e8f0'">
                        </div>
                    </div>
                    
                    <div style="display: flex; justify-content: flex-end; gap: 12px; margin-top: 24px; padding-top: 20px; border-top: 1px solid #e2e8f0;">
                        <button onclick="fecharModalNovoCliente()" style="padding: 12px 28px; background: #f8fafc; color: #64748b; border: 2px solid #e2e8f0; border-radius: 10px; cursor: pointer; font-weight: 600; transition: all 0.2s;" onmouseover="this.style.background='#f1f5f9'; this.style.borderColor='#cbd5e1'" onmouseout="this.style.background='#f8fafc'; this.style.borderColor='#e2e8f0'">
                            <i class="fas fa-times" style="margin-right: 6px;"></i> Cancelar
                        </button>
                        <button onclick="salvarClienteManual()" style="padding: 12px 28px; background: linear-gradient(135deg, #1e40af, #3b82f6); color: white; border: none; border-radius: 10px; cursor: pointer; font-weight: 600; transition: all 0.2s; box-shadow: 0 2px 8px rgba(59,130,246,0.3);" onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 12px rgba(59,130,246,0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(59,130,246,0.3)'">
                            <i class="fas fa-check" style="margin-right: 6px;"></i> Salvar Cliente
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ========================================
         MODAL INCLUIR PRODUTO - ESTILO OMIE
         ======================================== -->
    <div class="modal-overlay" id="modal-novo-produto">
        <div class="modal-content-omie" style="max-width: 1200px; border-radius: 0; height: 95vh; display: flex; flex-direction: column;">
            <!-- Header -->
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 16px 24px; border-bottom: 1px solid #e5e5e5; background: white; flex-shrink: 0;">
                <h2 style="color: #333; font-size: 20px; font-weight: 400; margin: 0;">Incluir Produto</h2>
                <button class="close-btn" onclick="verificarAlteracoesProduto()" style="color: #666; background: none; border: none; font-size: 14px; cursor: pointer;">
                    Fechar <i class="fas fa-times"></i>
                </button>
            </div>
            
            <!-- Container Principal -->
            <div style="display: flex; flex: 1; overflow: hidden;">
                <!-- Área Principal -->
                <div style="flex: 1; padding: 24px; overflow-y: auto; background: #fafafa;">
                    <!-- Seção Superior: Imagem + Dados Básicos -->
                    <div style="display: flex; gap: 24px; margin-bottom: 24px;">
                        <!-- Upload de Imagem -->
                        <div style="flex-shrink: 0;">
                            <div id="produto-imagem-container" style="width: 100px; height: 100px; border: 2px dashed #ddd; border-radius: 8px; display: flex; flex-direction: column; align-items: center; justify-content: center; background: #f8f8f8; cursor: pointer; position: relative;" onclick="document.getElementById('produto-imagem-input').click()">
                                <img id="produto-imagem-preview" src="" style="display: none; width: 100%; height: 100%; object-fit: cover; border-radius: 6px;">
                                <i class="fas fa-image" id="produto-imagem-icon" style="font-size: 32px; color: #ccc;"></i>
                            </div>
                            <input type="file" id="produto-imagem-input" accept="image/*" style="display: none;" onchange="previewImagemProduto(this)">
                            <a href="#" onclick="document.getElementById('produto-imagem-input').click(); return false;" style="display: block; text-align: center; margin-top: 8px; font-size: 12px; color: #f97316;">
                                <i class="fas fa-pencil-alt"></i> Alterar
                            </a>
                            <p style="text-align: center; font-size: 11px; color: #999; margin-top: 4px;">Nenhuma<br>imagem</p>
                        </div>
                        
                        <!-- Dados Básicos -->
                        <div style="flex: 1;">
                            <div style="margin-bottom: 16px;">
                                <label style="display: block; font-size: 12px; color: #f97316; margin-bottom: 4px;">Descrição do Produto</label>
                                <input type="text" id="produto-descricao" placeholder="Preencha aqui a Descrição do Produto" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                                <div>
                                    <label style="display: block; font-size: 12px; color: #f97316; margin-bottom: 4px;">Código do Produto</label>
                                    <div style="position: relative;">
                                        <input type="text" id="produto-codigo" value="PRD00048" style="width: 100%; padding: 12px; padding-right: 36px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; background: #f8f8f8;">
                                        <i class="fas fa-info-circle" style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); color: #999; cursor: help;" title="Código único do produto"></i>
                                    </div>
                                </div>
                                <div>
                                    <label style="display: block; font-size: 12px; color: #f97316; margin-bottom: 4px;">Código EAN (GTIN)</label>
                                    <div style="position: relative;">
                                        <input type="text" id="produto-ean" placeholder="Opcional" style="width: 100%; padding: 12px; padding-right: 36px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                                        <i class="fas fa-globe" style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); color: #999;"></i>
                                    </div>
                                </div>
                                <div>
                                    <label style="display: block; font-size: 12px; color: #f97316; margin-bottom: 4px;">Unidade</label>
                                    <select id="produto-unidade" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; color: #999;">
                                        <option value="">Preencha aqui a Unidade</option>
                                        <option value="UN">UN - Unidade</option>
                                        <option value="M">M - Metro</option>
                                        <option value="M2">M² - Metro Quadrado</option>
                                        <option value="KG">KG - Quilograma</option>
                                        <option value="CX">CX - Caixa</option>
                                        <option value="PC">PC - Peça</option>
                                        <option value="RL">RL - Rolo</option>
                                        <option value="LT">LT - Litro</option>
                                    </select>
                                </div>
                                <div>
                                    <label style="display: block; font-size: 12px; color: #f97316; margin-bottom: 4px;">Preço Unitário de Venda</label>
                                    <input type="text" id="produto-preco-venda" value="0,000000" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; text-align: right;" oninput="formatarMoedaProduto(this)">
                                </div>
                                <div>
                                    <label style="display: block; font-size: 12px; color: #f97316; margin-bottom: 4px;">Código NCM</label>
                                    <div style="position: relative;">
                                        <input type="text" id="produto-ncm" placeholder="Selecione aqui o NCM" style="width: 100%; padding: 12px; padding-left: 36px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                                        <i class="fas fa-search" style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #999;"></i>
                                    </div>
                                </div>
                                <div>
                                    <label style="display: block; font-size: 12px; color: #f97316; margin-bottom: 4px;">Família de Produto</label>
                                    <div style="display: flex; gap: 8px; align-items: center;">
                                        <select id="produto-familia" style="flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; color: #999;">
                                            <option value="">Opcional (mas importante para os seus ▼</option>
                                        </select>
                                        <button style="padding: 12px; background: none; border: 1px solid #ddd; border-radius: 6px; cursor: pointer; color: #f97316;">
                                            <i class="fas fa-pencil-alt"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Definição do Produto -->
                        <div style="flex-shrink: 0; width: 180px;">
                            <h4 style="font-size: 13px; color: #333; margin: 0 0 16px 0; font-weight: 500;">Definição do Produto</h4>
                            
                            <div style="display: flex; flex-direction: column; gap: 12px;">
                                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                    <div class="toggle-switch-produto" data-active="true" onclick="toggleDefinicaoProduto(this, 'simples')">
                                        <div class="toggle-slider"></div>
                                    </div>
                                    <span style="font-size: 13px; color: #333;">Simples</span>
                                    <i class="fas fa-info-circle" style="color: #999; font-size: 12px;"></i>
                                </label>
                                
                                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                    <div class="toggle-switch-produto" onclick="toggleDefinicaoProduto(this, 'kit')">
                                        <div class="toggle-slider"></div>
                                    </div>
                                    <span style="font-size: 13px; color: #333;">Kit</span>
                                    <i class="fas fa-info-circle" style="color: #999; font-size: 12px;"></i>
                                </label>
                                
                                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                    <div class="toggle-switch-produto" onclick="toggleDefinicaoProduto(this, 'variacoes')">
                                        <div class="toggle-slider"></div>
                                    </div>
                                    <span style="font-size: 13px; color: #333;">Com Variações</span>
                                    <i class="fas fa-info-circle" style="color: #999; font-size: 12px;"></i>
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Abas -->
                    <div style="border-bottom: 1px solid #e5e5e5; margin-bottom: 20px;">
                        <div style="display: flex; gap: 0;">
                            <button class="produto-tab active" onclick="mudarAbaProduto('estoque', this)" style="padding: 12px 20px; background: none; border: none; border-bottom: 2px solid #f97316; color: #f97316; font-size: 13px; font-weight: 500; cursor: pointer;">Estoque</button>
                            <button class="produto-tab" onclick="mudarAbaProduto('custo', this)" style="padding: 12px 20px; background: none; border: none; border-bottom: 2px solid transparent; color: #666; font-size: 13px; cursor: pointer;">Custo do Estoque</button>
                            <button class="produto-tab" onclick="mudarAbaProduto('fornecedores', this)" style="padding: 12px 20px; background: none; border: none; border-bottom: 2px solid transparent; color: #666; font-size: 13px; cursor: pointer;">Fornecedores</button>
                            <button class="produto-tab" onclick="mudarAbaProduto('historico', this)" style="padding: 12px 20px; background: none; border: none; border-bottom: 2px solid transparent; color: #666; font-size: 13px; cursor: pointer;">Histórico de Compras</button>
                            <button class="produto-tab" onclick="mudarAbaProduto('adicionais', this)" style="padding: 12px 20px; background: none; border: none; border-bottom: 2px solid transparent; color: #666; font-size: 13px; cursor: pointer;">Informações Adicionais</button>
                            <button class="produto-tab" onclick="mudarAbaProduto('caracteristicas', this)" style="padding: 12px 20px; background: none; border: none; border-bottom: 2px solid transparent; color: #666; font-size: 13px; cursor: pointer;">Características</button>
                            <button class="produto-tab" onclick="mudarAbaProduto('fiscais', this)" style="padding: 12px 20px; background: none; border: none; border-bottom: 2px solid transparent; color: #666; font-size: 13px; cursor: pointer;">Recomendações Fiscais</button>
                            <button class="produto-tab" onclick="mudarAbaProduto('observacoes', this)" style="padding: 12px 20px; background: none; border: none; border-bottom: 2px solid transparent; color: #666; font-size: 13px; cursor: pointer;">Observações</button>
                        </div>
                    </div>
                    
                    <!-- Conteúdo das Abas -->
                    <div id="produto-tab-content">
                        <!-- Aba Estoque (Default) -->
                        <div id="tab-estoque" class="produto-tab-panel">
                            <h4 style="font-size: 14px; color: #333; margin: 0 0 8px 0; font-weight: 600;">Estoque Mínimo</h4>
                            <p style="font-size: 12px; color: #3b82f6; margin: 0 0 4px 0;">Clique diretamente em qualquer célula desta coluna para atualizar o estoque mínimo de cada local de estoque</p>
                            <p style="font-size: 12px; color: #666; margin: 0 0 16px 0;">Abaixo um resumo das informações de estoque deste produto.</p>
                            
                            <label style="display: flex; align-items: center; gap: 10px; margin-bottom: 20px; cursor: pointer;">
                                <div class="toggle-switch-produto" onclick="toggleControleLote(this)">
                                    <div class="toggle-slider"></div>
                                </div>
                                <span style="font-size: 13px; color: #333;">Este produto possui controle de lote</span>
                                <i class="fas fa-info-circle" style="color: #999; font-size: 12px;"></i>
                            </label>
                            
                            <!-- Tabela de Estoque -->
                            <div style="background: white; border: 1px solid #e5e5e5; border-radius: 8px; overflow: hidden;">
                                <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
                                    <thead>
                                        <tr style="background: #f8f8f8;">
                                            <th style="padding: 12px 16px; text-align: left; font-weight: 500; color: #333; border-bottom: 1px solid #e5e5e5;">
                                                Local de Estoque <span style="color: #999;">«</span>
                                                <i class="fas fa-filter" style="color: #ccc; margin-left: 4px; font-size: 10px;"></i>
                                            </th>
                                            <th style="padding: 12px 16px; text-align: right; font-weight: 500; color: #333; border-bottom: 1px solid #e5e5e5;">
                                                Estoque Disponível <span style="color: #999;">«</span>
                                                <i class="fas fa-filter" style="color: #ccc; margin-left: 4px; font-size: 10px;"></i>
                                            </th>
                                            <th style="padding: 12px 16px; text-align: right; font-weight: 500; color: #333; border-bottom: 1px solid #e5e5e5;">
                                                CMC Unitário <span style="color: #999;">«</span>
                                                <i class="fas fa-filter" style="color: #ccc; margin-left: 4px; font-size: 10px;"></i>
                                            </th>
                                            <th style="padding: 12px 16px; text-align: right; font-weight: 500; color: #333; border-bottom: 1px solid #e5e5e5;">
                                                CMC Total <span style="color: #999;">«</span>
                                                <i class="fas fa-filter" style="color: #ccc; margin-left: 4px; font-size: 10px;"></i>
                                            </th>
                                            <th style="padding: 12px 16px; text-align: right; font-weight: 500; color: #333; border-bottom: 1px solid #e5e5e5;">
                                                Estoque Mínimo <span style="color: #999;">«</span>
                                                <i class="fas fa-filter" style="color: #ccc; margin-left: 4px; font-size: 10px;"></i>
                                            </th>
                                            <th style="padding: 12px 16px; text-align: center; font-weight: 500; color: #333; border-bottom: 1px solid #e5e5e5;">
                                                Previsão de Entrada <span style="color: #999;">«</span>
                                                <i class="fas fa-filter" style="color: #ccc; margin-left: 4px; font-size: 10px;"></i>
                                            </th>
                                            <th style="padding: 12px 16px; text-align: center; font-weight: 500; color: #333; border-bottom: 1px solid #e5e5e5;">
                                                Previsão de Saída <span style="color: #999;">«</span>
                                                <i class="fas fa-filter" style="color: #ccc; margin-left: 4px; font-size: 10px;"></i>
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody id="tabela-estoque-body">
                                        <tr>
                                            <td colspan="7" style="padding: 40px; text-align: center; color: #999;">
                                                <i class="fas fa-inbox" style="font-size: 32px; margin-bottom: 8px; display: block;"></i>
                                                Nenhum registro de estoque
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <!-- Outras abas (escondidas por padrão) -->
                        <div id="tab-custo" class="produto-tab-panel" style="display: none;">
                            <h4 style="font-size: 14px; color: #333; margin: 0 0 16px 0;">Custo do Estoque</h4>
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px;">
                                <div>
                                    <label style="display: block; font-size: 12px; color: #666; margin-bottom: 4px;">Preço de Custo (R$)</label>
                                    <input type="text" id="produto-preco-custo" value="0,00" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                                </div>
                                <div>
                                    <label style="display: block; font-size: 12px; color: #666; margin-bottom: 4px;">CMC Médio (R$)</label>
                                    <input type="text" id="produto-cmc" value="0,00" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;" readonly>
                                </div>
                                <div>
                                    <label style="display: block; font-size: 12px; color: #666; margin-bottom: 4px;">Margem (%)</label>
                                    <input type="text" id="produto-margem" value="0,00" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;" readonly>
                                </div>
                            </div>
                        </div>
                        
                        <div id="tab-fornecedores" class="produto-tab-panel" style="display: none;">
                            <h4 style="font-size: 14px; color: #333; margin: 0 0 16px 0;">Fornecedores</h4>
                            <p style="color: #666; font-size: 13px;">Nenhum fornecedor vinculado a este produto.</p>
                            <button style="padding: 10px 20px; background: #f97316; color: white; border: none; border-radius: 6px; cursor: pointer; margin-top: 12px;">
                                <i class="fas fa-plus"></i> Adicionar Fornecedor
                            </button>
                        </div>
                        
                        <div id="tab-historico" class="produto-tab-panel" style="display: none;">
                            <h4 style="font-size: 14px; color: #333; margin: 0 0 16px 0;">Histórico de Compras</h4>
                            <p style="color: #666; font-size: 13px;">Nenhuma compra registrada para este produto.</p>
                        </div>
                        
                        <div id="tab-adicionais" class="produto-tab-panel" style="display: none;">
                            <h4 style="font-size: 14px; color: #333; margin: 0 0 16px 0;">Informações Adicionais</h4>
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px;">
                                <div>
                                    <label style="display: block; font-size: 12px; color: #666; margin-bottom: 4px;">Peso Bruto (kg)</label>
                                    <input type="number" id="produto-peso-bruto" placeholder="0.00" step="0.001" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                                </div>
                                <div>
                                    <label style="display: block; font-size: 12px; color: #666; margin-bottom: 4px;">Peso Líquido (kg)</label>
                                    <input type="number" id="produto-peso-liquido" placeholder="0.00" step="0.001" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                                </div>
                                <div>
                                    <label style="display: block; font-size: 12px; color: #666; margin-bottom: 4px;">Altura (cm)</label>
                                    <input type="number" id="produto-altura" placeholder="0.00" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                                </div>
                                <div>
                                    <label style="display: block; font-size: 12px; color: #666; margin-bottom: 4px;">Largura (cm)</label>
                                    <input type="number" id="produto-largura" placeholder="0.00" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                                </div>
                                <div>
                                    <label style="display: block; font-size: 12px; color: #666; margin-bottom: 4px;">Comprimento (cm)</label>
                                    <input type="number" id="produto-comprimento" placeholder="0.00" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                                </div>
                            </div>
                        </div>
                        
                        <div id="tab-caracteristicas" class="produto-tab-panel" style="display: none;">
                            <h4 style="font-size: 14px; color: #333; margin: 0 0 16px 0;">Características do Produto</h4>
                            <p style="color: #666; font-size: 13px;">Nenhuma característica definida.</p>
                            <button style="padding: 10px 20px; background: #f97316; color: white; border: none; border-radius: 6px; cursor: pointer; margin-top: 12px;">
                                <i class="fas fa-plus"></i> Adicionar Característica
                            </button>
                        </div>
                        
                        <div id="tab-fiscais" class="produto-tab-panel" style="display: none;">
                            <h4 style="font-size: 14px; color: #333; margin: 0 0 16px 0;">Recomendações Fiscais</h4>
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px;">
                                <div>
                                    <label style="display: block; font-size: 12px; color: #666; margin-bottom: 4px;">CFOP Padrão</label>
                                    <input type="text" id="produto-cfop" placeholder="5102" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                                </div>
                                <div>
                                    <label style="display: block; font-size: 12px; color: #666; margin-bottom: 4px;">Origem</label>
                                    <select id="produto-origem" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                                        <option value="0">0 - Nacional</option>
                                        <option value="1">1 - Estrangeira - Importação direta</option>
                                        <option value="2">2 - Estrangeira - Adquirida no mercado interno</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div id="tab-observacoes" class="produto-tab-panel" style="display: none;">
                            <h4 style="font-size: 14px; color: #333; margin: 0 0 16px 0;">Observações</h4>
                            <textarea id="produto-observacoes" placeholder="Observações sobre o produto..." style="width: 100%; min-height: 150px; padding: 12px; border: 1px solid #ddd; border-radius: 6px; resize: vertical;"></textarea>
                        </div>
                    </div>
                </div>
                
                <!-- Sidebar Direita - Ações -->
                <div style="width: 140px; background: #f8f8f8; border-left: 1px solid #e5e5e5; padding: 20px 16px; display: flex; flex-direction: column; flex-shrink: 0;">
                    <button onclick="salvarNovoProduto()" style="display: flex; align-items: center; gap: 8px; padding: 12px 16px; background: white; border: 1px solid #e5e5e5; border-radius: 6px; cursor: pointer; font-size: 13px; color: #333; margin-bottom: 12px;">
                        <i class="fas fa-save" style="color: #f97316;"></i> Salvar
                    </button>
                    
                    <!-- Navegação entre produtos -->
                    <div style="margin-top: auto; display: flex; justify-content: center;">
                        <button style="width: 36px; height: 36px; background: white; border: 1px solid #e5e5e5; border-radius: 50%; cursor: pointer; color: #f97316;">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- WhatsApp Button -->
            <div style="position: fixed; bottom: 24px; right: 24px; z-index: 1000;">
                <button style="width: 56px; height: 56px; background: #25d366; border: none; border-radius: 50%; cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
                    <i class="fab fa-whatsapp" style="font-size: 28px; color: white;"></i>
                </button>
            </div>
        </div>
    </div>
    
    <!-- Estilos do Toggle Switch para Produto -->
    <style>
        .toggle-switch-produto {
            width: 44px;
            height: 24px;
            background: #ddd;
            border-radius: 12px;
            position: relative;
            cursor: pointer;
            transition: all 0.3s;
        }
        .toggle-switch-produto[data-active="true"] {
            background: #f97316;
        }
        .toggle-switch-produto .toggle-slider {
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            position: absolute;
            top: 2px;
            left: 2px;
            transition: all 0.3s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .toggle-switch-produto[data-active="true"] .toggle-slider {
            left: 22px;
        }
        .produto-tab.active {
            color: #f97316 !important;
            border-bottom-color: #f97316 !important;
        }
    </style>

    <!-- ========================================
         MODAL EXPORTAÇÃO (Excel/PDF)
         ======================================== -->
    <div class="modal-overlay" id="modal-exportar">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #10b981, #059669);">
                <h2><i class="fas fa-file-export"></i> Exportar Dados</h2>
                <button class="modal-close" onclick="fecharModalExportar()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body" style="padding: 24px;">
                <h4 style="font-size: 14px; color: #333; margin-bottom: 16px;">Selecione o formato de exportação:</h4>
                
                <div class="opcoes-exportacao" style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 24px;">
                    <label class="opcao-export" style="cursor: pointer;">
                        <input type="radio" name="formato-export" value="excel" checked style="display: none;">
                        <div class="opcao-export-content" style="padding: 20px; border: 2px solid #e5e5e5; border-radius: 12px; text-align: center; transition: all 0.2s;">
                            <i class="fas fa-file-excel" style="font-size: 40px; color: #22c55e; margin-bottom: 10px;"></i>
                            <p style="font-weight: 600; color: #333;">Excel (.xlsx)</p>
                            <small style="color: #666;">Planilha completa</small>
                        </div>
                    </label>
                    <label class="opcao-export" style="cursor: pointer;">
                        <input type="radio" name="formato-export" value="pdf" style="display: none;">
                        <div class="opcao-export-content" style="padding: 20px; border: 2px solid #e5e5e5; border-radius: 12px; text-align: center; transition: all 0.2s;">
                            <i class="fas fa-file-pdf" style="font-size: 40px; color: #ef4444; margin-bottom: 10px;"></i>
                            <p style="font-weight: 600; color: #333;">PDF (.pdf)</p>
                            <small style="color: #666;">Relatório formatado</small>
                        </div>
                    </label>
                </div>
                
                <div class="opcoes-dados-export" style="margin-bottom: 24px;">
                    <h4 style="font-size: 14px; color: #333; margin-bottom: 12px;">Dados a exportar:</h4>
                    <div style="display: flex; flex-direction: column; gap: 10px;">
                        <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                            <input type="checkbox" id="export-pedidos" checked style="width: 18px; height: 18px; accent-color: #10b981;">
                            <span>Pedidos do Kanban</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                            <input type="checkbox" id="export-clientes" style="width: 18px; height: 18px; accent-color: #10b981;">
                            <span>Lista de Clientes</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                            <input type="checkbox" id="export-produtos" style="width: 18px; height: 18px; accent-color: #10b981;">
                            <span>Catálogo de Produtos</span>
                        </label>
                    </div>
                </div>
                
                <div class="filtros-export" style="padding: 16px; background: #f8fafc; border-radius: 8px;">
                    <h4 style="font-size: 13px; color: #555; margin-bottom: 12px;"><i class="fas fa-filter"></i> Filtros (opcional)</h4>
                    <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                        <div style="flex: 1; min-width: 150px;">
                            <label style="font-size: 11px; color: #666; display: block; margin-bottom: 4px;">Data Início</label>
                            <input type="date" id="export-data-inicio" class="orcamento-input" style="width: 100%;">
                        </div>
                        <div style="flex: 1; min-width: 150px;">
                            <label style="font-size: 11px; color: #666; display: block; margin-bottom: 4px;">Data Fim</label>
                            <input type="date" id="export-data-fim" class="orcamento-input" style="width: 100%;">
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer" style="justify-content: center; gap: 12px;">
                <button type="button" class="btn-modal btn-modal-cancel" onclick="fecharModalExportar()">
                    Cancelar
                </button>
                <button type="button" class="btn-modal btn-modal-save" style="background: #10b981;" onclick="executarExportacao()">
                    <i class="fas fa-download"></i> Exportar
                </button>
            </div>
        </div>
    </div>

    <script>
        // ========================================
        // UTILITÁRIOS GLOBAIS
        // ========================================
        function showToast(message, type = 'info') {
            // Remover toast existente
            const existingToast = document.querySelector('.toast-notification');
            if (existingToast) existingToast.remove();
            
            // Criar toast
            const toast = document.createElement('div');
            toast.className = `toast-notification toast-${type}`;
            toast.innerHTML = `
                <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle'}"></i>
                <span>${message}</span>
            `;
            
            // Estilos inline para o toast
            toast.style.cssText = `
                position: fixed;
                bottom: 20px;
                right: 20px;
                background: ${type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : '#3b82f6'};
                color: white;
                padding: 14px 20px;
                border-radius: 8px;
                display: flex;
                align-items: center;
                gap: 10px;
                font-size: 14px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                z-index: 10000;
                animation: toastSlideIn 0.3s ease;
            `;
            
            document.body.appendChild(toast);
            
            // Auto-remover após 3 segundos
            setTimeout(() => {
                toast.style.animation = 'toastSlideOut 0.3s ease forwards';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Adicionar animações do toast
        if (!document.getElementById('toast-animations')) {
            const style = document.createElement('style');
            style.id = 'toast-animations';
            style.textContent = `
                @keyframes toastSlideIn {
                    from { transform: translateX(100%); opacity: 0; }
                    to { transform: translateX(0); opacity: 1; }
                }
                @keyframes toastSlideOut {
                    from { transform: translateX(0); opacity: 1; }
                    to { transform: translateX(100%); opacity: 0; }
                }
            `;
            document.head.appendChild(style);
        }
        
        // ========================================
        // DADOS DO KANBAN (Carregados da API)
        // ========================================
        // Dados de fallback caso a API esteja indisponível
        const dadosFallback = {
            orcamento: [
                { id: 9, cliente: 'TIÃO MATERIAIS PARA CONSTRUÇÃO LTDA', status: 'Faturamento atrasado', valor: 3700.00, parcelas: 'a vista', origem: 'Omie' },
                { id: 8, cliente: 'COMERCIAL ELETRICA PAPIRO LTDA', status: 'Faturamento atrasado', valor: 13084.67, parcelas: 'em 3x', origem: 'Omie' },
            ],
            analise: [
                { id: 233, cliente: 'IMPACTO ELETRICA', status: 'Faturamento atrasado', valor: 80780.00, parcelas: 'em 4x', origem: 'Omie' },
            ],
            aprovado: [
                { id: 1343, cliente: 'AL CONESUL VALVULAS INDUSTRIAIS LTDA', status: 'Faturamento atrasado', valor: 3000.00, parcelas: 'em 3x', origem: 'Omie' },
            ],
            faturar: [
                { id: 3, cliente: 'ILUMINACAO PAULISTANA SPE S/A', status: 'Faturamento atrasado', valor: 529.00, parcelas: 'p/ 11/06 Qua', origem: 'Omie' },
            ],
            faturado: [
                { id: 1341, cliente: 'ATUALLED', status: 'Faturado', valor: 1944.25, parcelas: 'em 3x', origem: 'Omie', nf: '00000248' },
            ],
            recibo: []
        };
        
        // Dados dinâmicos carregados da API
        let dadosVendas = JSON.parse(JSON.stringify(dadosFallback));
        
        // Mapeamento de status da API para colunas do Kanban
        const statusParaColuna = {
            'orcamento': 'orcamento',
            'orçamento': 'orcamento',
            'analise-credito': 'analise',
            'analise': 'analise',
            'pedido-aprovado': 'aprovado',
            'aprovado': 'aprovado',
            'faturar': 'faturar',
            'faturado': 'faturado',
            'entregue': 'recibo',
            'recibo': 'recibo'
        };
        
        // Mapeamento de coluna para status da API
        const colunaParaStatus = {
            'orcamento': 'orcamento',
            'analise': 'analise-credito',
            'aprovado': 'pedido-aprovado',
            'faturar': 'faturar',
            'faturado': 'faturado',
            'recibo': 'recibo'
        };
        
        // Carregar dados da API com filtros
        async function carregarDadosKanban(filtros = null) {
            try {
                const token = localStorage.getItem('token');
                const headers = { 'Content-Type': 'application/json' };
                if (token) headers['Authorization'] = `Bearer ${token}`;
                
                // Construir query string com filtros
                let url = '/api/vendas/kanban/pedidos';
                if (filtros) {
                    const params = new URLSearchParams();
                    if (filtros.dataInclusao && filtros.dataInclusao !== 'tudo') {
                        params.append('dataInclusao', filtros.dataInclusao);
                    }
                    if (filtros.dataPrevisao && filtros.dataPrevisao !== 'tudo') {
                        params.append('dataPrevisao', filtros.dataPrevisao);
                    }
                    if (filtros.dataFaturamento && filtros.dataFaturamento !== 'tudo') {
                        params.append('dataFaturamento', filtros.dataFaturamento);
                    }
                    if (filtros.vendedor && filtros.vendedor !== 'todos') {
                        params.append('vendedor', filtros.vendedor);
                    }
                    if (filtros.projeto && filtros.projeto !== 'todos') {
                        params.append('projeto', filtros.projeto);
                    }
                    params.append('exibirCancelados', filtros.exibirCancelados ? 'true' : 'false');
                    params.append('exibirDenegados', filtros.exibirDenegados ? 'true' : 'false');
                    params.append('exibirEncerrados', filtros.exibirEncerrados ? 'true' : 'false');
                    
                    const queryString = params.toString();
                    if (queryString) url += '?' + queryString;
                }
                
                console.log('📋 Carregando Kanban:', url);
                
                const resp = await fetch(url, {
                    credentials: 'include',
                    headers: headers
                });
                
                if (!resp.ok) throw new Error(`Erro ${resp.status}`);
                
                const dados = await resp.json();
                
                // Resetar dados
                dadosVendas = {
                    orcamento: [],
                    analise: [],
                    aprovado: [],
                    faturar: [],
                    faturado: [],
                    recibo: []
                };
                
                // Organizar por coluna
                if (Array.isArray(dados) && dados.length > 0) {
                    dados.forEach(pedido => {
                        const colunaDestino = statusParaColuna[pedido.status] || 'orcamento';
                        const item = {
                            id: pedido.id,
                            cliente: pedido.cliente || pedido.cliente_nome || 'Cliente não informado',
                            status: pedido.faturamento || pedido.observacoes || 'Aguardando',
                            valor: pedido.valor || pedido.valor_total || 0,
                            parcelas: pedido.tipo || pedido.condicao_pagamento || 'a vista',
                            origem: pedido.origem || 'Omie',
                            vendedor: pedido.vendedor_nome || pedido.vendedor || '',
                            vendedor_id: pedido.vendedor_id,
                            transportadora: pedido.transportadora || null,
                            nf: pedido.notaFiscal || pedido.nf_numero || null,
                            mensagem: pedido.manifestacao || null,
                            itens: pedido.itens || [],
                            _statusOriginal: pedido.status
                        };
                        dadosVendas[colunaDestino].push(item);
                    });
                    console.log('✅ Dados do Kanban carregados da API:', dados.length, 'pedidos');
                } else {
                    console.log('⚠️ API retornou vazio, usando dados de fallback');
                    dadosVendas = JSON.parse(JSON.stringify(dadosFallback));
                }
                
                renderKanban();
                
            } catch (err) {
                console.error('❌ Erro ao carregar dados do Kanban:', err);
                showNotification('Não foi possível carregar dados do servidor. Exibindo dados locais.', 'error');
                dadosVendas = JSON.parse(JSON.stringify(dadosFallback));
                renderKanban();
            }
        }
        
        // Salvar status do pedido na API
        async function salvarStatusPedido(pedidoId, novoStatus) {
            try {
                const statusAPI = colunaParaStatus[novoStatus] || novoStatus;
                // Buscar token de múltiplas fontes possíveis
                const token = localStorage.getItem('authToken') || localStorage.getItem('token') || sessionStorage.getItem('authToken');
                
                const headers = { 'Content-Type': 'application/json' };
                // Só adicionar Authorization se tiver token válido
                if (token && token !== 'null' && token !== 'undefined') {
                    headers['Authorization'] = `Bearer ${token}`;
                }
                
                const resp = await fetch(`/api/vendas/pedidos/${pedidoId}/status`, {
                    method: 'PUT',
                    credentials: 'include', // Envia cookies automaticamente
                    headers: headers,
                    body: JSON.stringify({ status: statusAPI })
                });
                
                if (!resp.ok) {
                    const errorData = await resp.json().catch(() => ({}));
                    throw new Error(errorData.message || 'Erro ao salvar status');
                }
                console.log('✅ Status do pedido', pedidoId, 'atualizado para:', statusAPI);
                return true;
            } catch (err) {
                console.error('❌ Erro ao salvar status:', err);
                return false;
            }
        };

        // ========================================
        // RENDER CARDS
        // ========================================
        function renderCard(item) {
            const statusClass = item.status === 'Faturado' ? 'faturado' : 'atrasado';
            
            let nfBadge = '';
            if (item.nf) {
                nfBadge = `<span class="card-badge nf">Nota Fiscal: ${item.nf}</span>`;
            }

            let transportadora = '';
            if (item.transportadora) {
                transportadora = `<div class="card-transport">Transportadora: ${item.transportadora}</div>`;
            }

            let mensagem = '';
            if (item.mensagem) {
                mensagem = `
                    <div class="card-message">
                        <i class="fas fa-comment"></i>
                        <span>${item.mensagem}</span>
                    </div>
                `;
            }

            const parcelas = item.parcelas || item.tipo || 'a vista';
            const valorFormatado = (item.valor || 0).toLocaleString('pt-BR', { minimumFractionDigits: 2 });
            const origem = item.origem || 'Omie';
            
            return `
                <div class="kanban-card" draggable="true" data-id="${item.id}" data-vendedor-id="${item.vendedor_id || ''}" ondblclick="abrirModalEditar(${item.id})">
                    ${nfBadge}
                    <div class="card-header">
                        <span class="card-number">Orçamento Nº ${item.id}</span>
                        <button class="card-menu" onclick="event.stopPropagation(); abrirModalEditar(${item.id})" title="Editar pedido">
                            <i class="fas fa-ellipsis-v"></i>
                        </button>
                    </div>
                    <div class="card-title">${item.cliente || 'Cliente não informado'}</div>
                    <span class="card-status ${statusClass}">${item.status || 'Aguardando'}</span>
                    <div class="card-value">$ ${valorFormatado} ${parcelas}</div>
                    <div class="card-origin">
                        <i class="fas fa-check-circle"></i>
                        Origem: ${origem}
                    </div>
                    ${transportadora}
                    ${mensagem}
                </div>
            `;
        }

        function renderKanban() {
            // Orçamento
            const colOrcamento = document.getElementById('col-orcamento');
            colOrcamento.innerHTML = dadosVendas.orcamento.map(renderCard).join('');

            // Análise
            const colAnalise = document.getElementById('col-analise');
            colAnalise.innerHTML = dadosVendas.analise.map(renderCard).join('');

            // Aprovado
            const colAprovado = document.getElementById('col-aprovado');
            colAprovado.innerHTML = dadosVendas.aprovado.map(renderCard).join('');

            // Faturar
            const colFaturar = document.getElementById('col-faturar');
            colFaturar.innerHTML = dadosVendas.faturar.map(renderCard).join('');

            // Faturado
            const colFaturado = document.getElementById('col-faturado');
            colFaturado.innerHTML = dadosVendas.faturado.map(renderCard).join('');

            // Recibo
            const colRecibo = document.getElementById('col-recibo');
            if (dadosVendas.recibo && dadosVendas.recibo.length > 0) {
                colRecibo.innerHTML = dadosVendas.recibo.map(renderCard).join('');
            } else {
                colRecibo.innerHTML = '<div class="empty-column"><i class="fas fa-receipt"></i><p>Nenhum recibo pendente</p></div>';
            }

            // Adicionar eventos de drag
            initDragAndDrop();
            
            // Atualizar contadores
            updateCounters();
        }

        // ========================================
        // DRAG AND DROP
        // ========================================
        function initDragAndDrop() {
            const cards = document.querySelectorAll('.kanban-card');
            const columns = document.querySelectorAll('.kanban-column-content');

            cards.forEach(card => {
                card.addEventListener('dragstart', handleDragStart);
                card.addEventListener('dragend', handleDragEnd);
            });

            columns.forEach(column => {
                column.addEventListener('dragover', handleDragOver);
                column.addEventListener('drop', handleDrop);
                column.addEventListener('dragleave', handleDragLeave);
            });
        }

        let draggedCard = null;

        function handleDragStart(e) {
            draggedCard = this;
            this.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
        }

        function handleDragEnd(e) {
            this.classList.remove('dragging');
            document.querySelectorAll('.kanban-column-content').forEach(col => {
                col.classList.remove('drag-over');
            });
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            this.classList.add('drag-over');
        }

        function handleDragLeave(e) {
            this.classList.remove('drag-over');
        }

        async function handleDrop(e) {
            e.preventDefault();
            this.classList.remove('drag-over');
            
            if (draggedCard) {
                // Capturar informações para histórico
                const pedidoId = draggedCard.getAttribute('data-id');
                const vendedorId = draggedCard.getAttribute('data-vendedor-id');
                const colunaOrigemEl = draggedCard.parentElement;
                const colunaOrigemId = colunaOrigemEl?.id?.replace('col-', '') || '';
                const colunaDestinoId = this.id;
                const colunaDestino = colunaDestinoId.replace('col-', '');
                
                // ========================================
                // VERIFICAÇÃO DE PERMISSÕES
                // ========================================
                // Etapas em ordem: orcamento -> analise -> aprovado -> faturar -> faturado -> recibo
                const etapasOrdem = ['orcamento', 'analise', 'aprovado', 'faturar', 'faturado', 'recibo'];
                const etapaOrigemIdx = etapasOrdem.indexOf(colunaOrigemId);
                const etapaDestinoIdx = etapasOrdem.indexOf(colunaDestino);
                
                // Verificar se é admin
                const isAdmin = usuarioLogado.isAdmin;
                
                // Se NÃO é admin
                if (!isAdmin) {
                    // Verificar se é o dono do pedido
                    const isProprioPedido = vendedorId && usuarioLogado.id && vendedorId == usuarioLogado.id;
                    
                    if (!isProprioPedido) {
                        showToast('Você só pode mover seus próprios pedidos.', 'error');
                        return;
                    }
                    
                    // Vendedor só pode mover até "analise" (índice 1)
                    // Se destino for após "analise", bloquear
                    if (etapaDestinoIdx > 1) {
                        showToast('Apenas administradores podem mover pedidos após "Análise de Crédito".', 'warning');
                        return;
                    }
                    
                    // Também não pode voltar de etapas avançadas
                    if (etapaOrigemIdx > 1) {
                        showToast('Este pedido já passou da Análise de Crédito. Contate um administrador.', 'warning');
                        return;
                    }
                }
                
                // Mapear IDs para nomes
                const colunaNomes = {
                    'col-orcamento': 'Orçamento',
                    'col-analise': 'Em análise',
                    'col-aprovado': 'Aprovado',
                    'col-faturar': 'Faturar',
                    'col-faturado': 'Faturado',
                    'col-recibo': 'Recibo Enviado'
                };
                
                const etapaOrigem = colunaNomes[colunaOrigemEl?.id] || 'Desconhecido';
                const etapaDestino = colunaNomes[colunaDestinoId] || 'Desconhecido';
                
                // Não fazer nada se mesma coluna
                if (colunaOrigemId === colunaDestino) return;
                
                // Remove empty state se existir
                const emptyState = this.querySelector('.empty-column');
                if (emptyState) {
                    emptyState.remove();
                }
                
                this.appendChild(draggedCard);
                
                // Atualizar dados locais - mover pedido entre arrays
                const pedidoIdx = dadosVendas[colunaOrigemId]?.findIndex(p => p.id == pedidoId);
                if (pedidoIdx !== undefined && pedidoIdx !== -1) {
                    const [pedido] = dadosVendas[colunaOrigemId].splice(pedidoIdx, 1);
                    if (!dadosVendas[colunaDestino]) dadosVendas[colunaDestino] = [];
                    pedido._statusOriginal = colunaParaStatus[colunaDestino] || colunaDestino;
                    dadosVendas[colunaDestino].push(pedido);
                }
                
                // Atualizar contadores
                updateCounters();
                
                // Salvar status na API
                const salvoComSucesso = await salvarStatusPedido(pedidoId, colunaDestino);
                
                // Registrar mudança de etapa no histórico
                if (pedidoId && etapaOrigem !== etapaDestino) {
                    try {
                        const token = localStorage.getItem('token');
                        await fetch(`/api/vendas/pedidos/${pedidoId}/historico`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${token}`
                            },
                            credentials: 'include',
                            body: JSON.stringify({
                                tipo: 'status',
                                descricao: `Etapa alterada de "${etapaOrigem}" para "${etapaDestino}"`,
                                usuario: 'Administrador'
                            })
                        });
                    } catch (err) {
                        console.log('Erro ao registrar histórico:', err);
                    }
                }
                
                // Notificar mudança
                if (salvoComSucesso) {
                    showNotification(`Pedido movido para ${etapaDestino}!`, 'success');
                } else {
                    showNotification(`Pedido movido para ${etapaDestino} (offline - sincronizar depois)`, 'warning');
                }
            }
        }

        function updateCounters() {
            const columns = {
                'col-orcamento': 'count-orcamento',
                'col-analise': 'count-analise',
                'col-aprovado': 'count-aprovado',
                'col-faturar': 'count-faturar',
                'col-faturado': 'count-faturado',
                'col-recibo': 'count-recibo'
            };

            Object.entries(columns).forEach(([colId, countId]) => {
                const col = document.getElementById(colId);
                const counter = document.getElementById(countId);
                if (col && counter) {
                    const count = col.querySelectorAll('.kanban-card').length;
                    counter.textContent = count === 0 ? 'Nenhum registro' : `${count} registro${count > 1 ? 's' : ''}`;
                }
            });
        }

        // ========================================
        // MODAL EDITAR PEDIDO
        // ========================================
        let pedidoAtual = null;
        
        function encontrarPedido(id) {
            // Busca em todas as colunas
            for (const coluna of Object.keys(dadosVendas)) {
                const pedido = dadosVendas[coluna].find(p => p.id == id);
                if (pedido) {
                    pedido._coluna = coluna;
                    return pedido;
                }
            }
            return null;
        }
        
        function abrirModalEditar(id) {
            const pedido = encontrarPedido(id);
            if (!pedido) {
                showNotification('Pedido não encontrado', 'error');
                return;
            }
            
            pedidoAtual = pedido;
            
            // Atualizar título do modal
            document.getElementById('modal-titulo-pedido').textContent = `Orçamento Nº ${pedido.id}`;
            
            // Atualizar avatar do cliente (primeiras 2 letras)
            const clienteNome = pedido.cliente || 'Cliente';
            const iniciais = clienteNome.split(' ').map(n => n.charAt(0).toUpperCase()).slice(0, 2).join('');
            document.getElementById('modal-cliente-avatar').textContent = iniciais;
            
            // Preencher campos principais
            document.getElementById('edit-pedido-id').value = pedido.id;
            document.getElementById('edit-cliente').value = pedido.cliente || '';
            document.getElementById('edit-valor-total').value = formatarMoeda(pedido.valor || 0);
            document.getElementById('edit-total-mercadorias').value = formatarMoeda(pedido.valor || 0);
            document.getElementById('edit-vendedor').value = pedido.vendedor || '';
            document.getElementById('edit-parcelas').value = pedido.parcelas || '28/35/42/49';
            document.getElementById('edit-observacoes').value = pedido.mensagem || '';
            
            // Campos de frete
            if (document.getElementById('edit-transportadora')) {
                document.getElementById('edit-transportadora').value = pedido.transportadora || '';
            }
            if (document.getElementById('edit-nf')) {
                document.getElementById('edit-nf').value = pedido.nf || '';
            }
            if (document.getElementById('edit-origem')) {
                document.getElementById('edit-origem').value = pedido.origem || 'Omie';
            }
            
            // Atualizar alerta de status
            const statusAlert = document.getElementById('status-alert');
            const statusAlertText = document.getElementById('status-alert-text');
            if (pedido.status) {
                statusAlertText.textContent = pedido.status;
                statusAlert.className = 'status-alert';
                if (pedido.status.toLowerCase().includes('atrasado')) {
                    statusAlert.classList.add('warning');
                } else if (pedido.status.toLowerCase().includes('faturado') || pedido.status.toLowerCase().includes('aprovado')) {
                    statusAlert.classList.add('success');
                } else {
                    statusAlert.classList.add('info');
                }
            }
            
            // Limpar seleção de item
            itemSelecionado = null;
            itemSelecionadoIdx = null;
            
            // Carregar itens do pedido da API
            carregarItensPedido(pedido.id);
            
            // Resetar tabs para primeira aba
            switchModalTab('itens');
            
            // Limpar alterações anteriores e preparar rastreamento
            limparAlteracoes();
            
            // Mostrar modal
            document.getElementById('modal-editar-pedido').classList.add('active');
            
            // Rastrear alterações após um pequeno delay para garantir que os campos estão preenchidos
            setTimeout(() => {
                const form = document.getElementById('modal-editar-pedido');
                const inputs = form.querySelectorAll('input, select, textarea');
                formOriginalData['modal-editar-pedido'] = {};
                inputs.forEach(input => {
                    const name = input.name || input.id;
                    if (name) {
                        formOriginalData['modal-editar-pedido'][name] = input.type === 'checkbox' ? input.checked : input.value;
                        input.addEventListener('change', () => marcarAlteracao('modal-editar-pedido', input));
                        input.addEventListener('input', () => marcarAlteracao('modal-editar-pedido', input));
                    }
                });
            }, 100);
        }
        
        function switchModalTab(tabId) {
            // Remover active de todas as tabs
            document.querySelectorAll('.modal-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            // Ocultar todos os conteúdos
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            // Ativar tab e conteúdo selecionados
            document.querySelector(`.modal-tab[data-tab="${tabId}"]`).classList.add('active');
            document.getElementById(`tab-${tabId}`).classList.add('active');
        }
        
        function formatarMoeda(valor) {
            return 'R$ ' + parseFloat(valor || 0).toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }
        
        function fecharModalEditar() {
            if (temAlteracoesNaoSalvas()) {
                mostrarConfirmacaoAlteracoes(() => {
                    document.getElementById('modal-editar-pedido').classList.remove('active');
                    pedidoAtual = null;
                });
            } else {
                document.getElementById('modal-editar-pedido').classList.remove('active');
                pedidoAtual = null;
            }
        }
        
        async function salvarPedido() {
            if (!pedidoAtual) {
                showNotification('Nenhum pedido selecionado', 'error');
                return;
            }
            
            // Capturar alterações para histórico
            const alteracoes = [];
            
            const novoCliente = document.getElementById('edit-cliente').value;
            if (novoCliente !== pedidoAtual.cliente) {
                alteracoes.push(`Cliente alterado de "${pedidoAtual.cliente}" para "${novoCliente}"`);
            }
            
            const novasParcelas = document.getElementById('edit-parcelas').value;
            if (novasParcelas !== pedidoAtual.parcelas) {
                alteracoes.push(`Parcelas alteradas para "${novasParcelas}"`);
            }
            
            const novoVendedor = document.getElementById('edit-vendedor').value;
            if (novoVendedor !== pedidoAtual.vendedor) {
                alteracoes.push(`Vendedor alterado para "${novoVendedor}"`);
            }
            
            let novaTransp = '';
            if (document.getElementById('edit-transportadora')) {
                novaTransp = document.getElementById('edit-transportadora').value;
                if (novaTransp !== pedidoAtual.transportadora) {
                    alteracoes.push(`Transportadora alterada para "${novaTransp}"`);
                }
            }
            
            let novaNF = '';
            if (document.getElementById('edit-nf')) {
                novaNF = document.getElementById('edit-nf').value;
            }
            
            let novaOrigem = '';
            if (document.getElementById('edit-origem')) {
                novaOrigem = document.getElementById('edit-origem').value;
            }
            
            let novaObs = '';
            if (document.getElementById('edit-observacoes')) {
                novaObs = document.getElementById('edit-observacoes').value;
                if (novaObs !== pedidoAtual.mensagem) {
                    alteracoes.push('Observações atualizadas');
                }
            }
            
            // Preparar dados para enviar à API
            const dadosAtualizacao = {
                vendedor_nome: novoVendedor,
                parcelas: novasParcelas,
                observacao: novaObs,
                transportadora: novaTransp,
                nf: novaNF
            };
            
            console.log('📤 Enviando atualização para API:', dadosAtualizacao);
            
            try {
                // Obter token de autenticação
                const token = localStorage.getItem('token') || sessionStorage.getItem('token');
                
                // Salvar no backend via API
                const response = await fetch(`/api/vendas/pedidos/${pedidoAtual.id}`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': token ? `Bearer ${token}` : ''
                    },
                    credentials: 'include',
                    body: JSON.stringify(dadosAtualizacao)
                });
                
                if (!response.ok) {
                    // Verificar se a resposta é JSON antes de parsear
                    const contentType = response.headers.get('content-type');
                    if (contentType && contentType.includes('application/json')) {
                        const errorData = await response.json();
                        throw new Error(errorData.message || 'Erro ao salvar pedido');
                    } else {
                        throw new Error(`Erro ${response.status}: ${response.statusText || 'Erro ao salvar pedido'}`);
                    }
                }
                
                const result = await response.json();
                console.log('✅ Pedido salvo na API:', result);
                
                // Atualizar dados locais do pedido
                pedidoAtual.cliente = novoCliente;
                pedidoAtual.parcelas = novasParcelas;
                pedidoAtual.vendedor = novoVendedor;
                pedidoAtual.vendedor_nome = novoVendedor;
                pedidoAtual.transportadora = novaTransp;
                pedidoAtual.nf = novaNF;
                pedidoAtual.mensagem = novaObs;
                if (novaOrigem) pedidoAtual.origem = novaOrigem;
                
                // Registrar histórico se houve alterações
                if (alteracoes.length > 0) {
                    await registrarHistoricoLocal('edicao', alteracoes.join('; '));
                }
                
                // Limpar alterações após salvar
                limparAlteracoes();
                
                // Recarregar dados do Kanban da API para garantir sincronização
                await carregarPedidosKanban();
                
                // Fechar modal e notificar
                fecharModalEditar();
                showNotification('Pedido atualizado com sucesso!', 'success');
                
            } catch (error) {
                console.error('❌ Erro ao salvar pedido:', error);
                showNotification(error.message || 'Erro ao salvar pedido', 'error');
            }
        }
        
        // Funções adicionais da sidebar de ações
        function duplicarPedido() {
            if (!pedidoAtual) return;
            
            // Criar cópia do pedido
            const novoPedido = {
                ...pedidoAtual,
                id: Math.floor(Math.random() * 9000) + 1000,
                status: 'Novo',
                nf: null
            };
            
            // Adicionar à coluna de negociação
            dadosVendas.negociacao.push(novoPedido);
            
            // Re-renderizar kanban
            renderKanban();
            
            showNotification(`Pedido duplicado! Novo Orçamento Nº ${novoPedido.id}`, 'success');
        }
        
        function imprimirPedido() {
            if (!pedidoAtual) return;
            // Atualizar número do orçamento no modal
            const numOrc = document.getElementById('pdf-numero-orcamento');
            if (numOrc) {
                numOrc.textContent = `Orçamento Nº ${String(pedidoAtual.id).padStart(6, '0')}`;
            }
            // Abrir modal de opções de impressão
            document.getElementById('modal-imprimir').classList.add('active');
        }

        function fecharModalImprimir() {
            document.getElementById('modal-imprimir').classList.remove('active');
        }

        // Função simplificada - apenas PDF completo
        async function executarImpressaoCompleta() {
            fecharModalImprimir();
            showNotification(`Gerando PDF...`, 'info');
            
            try {
                let token = localStorage.getItem('token');
                if (!token) {
                    const cookies = document.cookie.split('; ');
                    for (const cookie of cookies) {
                        if (cookie.startsWith('authToken=') || cookie.startsWith('token=')) {
                            token = decodeURIComponent(cookie.split('=')[1]);
                            break;
                        }
                    }
                }
                
                const pdfUrl = `/api/vendas/pedidos/${pedidoAtual.id}/pdf`;
                const headers = { 'Content-Type': 'application/json' };
                if (token) headers['Authorization'] = `Bearer ${token}`;
                
                const response = await fetch(pdfUrl, {
                    method: 'GET',
                    headers: headers,
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    let errorMessage = 'Erro ao gerar PDF';
                    try { errorMessage = (await response.json()).error || errorMessage; } catch(e) {}
                    throw new Error(errorMessage);
                }
                
                const pdfBlob = await response.blob();
                if (pdfBlob.size === 0) throw new Error('PDF gerado está vazio');
                
                const blobUrl = URL.createObjectURL(pdfBlob);
                const pdfWindow = window.open(blobUrl, '_blank');
                
                if (!pdfWindow) {
                    const link = document.createElement('a');
                    link.href = blobUrl;
                    link.download = `orcamento_${pedidoAtual.id}.pdf`;
                    link.click();
                }
                showNotification('PDF gerado com sucesso!', 'success');
                setTimeout(() => URL.revokeObjectURL(blobUrl), 60000);
                
            } catch (error) {
                console.error('Erro ao gerar PDF:', error);
                showNotification(`Erro ao gerar PDF: ${error.message}`, 'error');
            }
        }

        async function executarImpressao() {
            // Redireciona para a função simplificada
            executarImpressaoCompleta();
        }
        
        // Fallback para impressão HTML
        function gerarImpressaoHTML() {
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                <head>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
                    <title>Orçamento Nº ${pedidoAtual.id}</title>
                    <style>
                        body { font-family: Arial, sans-serif; padding: 40px; }
                        h1 { color: #f97316; border-bottom: 2px solid #f97316; padding-bottom: 10px; }
                        .info { margin: 20px 0; }
                        .info strong { display: inline-block; width: 150px; }
                        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                        th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
                        th { background: #f5f5f5; }
                        .total { font-size: 18px; font-weight: bold; text-align: right; margin-top: 20px; }
                    </style>
                    <script src="/js/anti-copy-protection.js"></script>
    <link rel="stylesheet" href="/css/popup-confirmacao.css">`n</head>
                <body>
                    <h1>Orçamento Nº ${pedidoAtual.id}</h1>
                    <div class="info"><strong>Cliente:</strong> ${pedidoAtual.cliente}</div>
                    <div class="info"><strong>Status:</strong> ${pedidoAtual.status}</div>
                    <div class="info"><strong>Vendedor:</strong> ${pedidoAtual.vendedor || 'Não definido'}</div>
                    <div class="info"><strong>Parcelas:</strong> ${pedidoAtual.parcelas || 'A combinar'}</div>
                    <div class="info"><strong>Origem:</strong> ${pedidoAtual.origem}</div>
                    ${pedidoAtual.transportadora ? `<div class="info"><strong>Transportadora:</strong> ${pedidoAtual.transportadora}</div>` : ''}
                    <table>
                        <thead>
                            <tr>
                                <th>Código</th>
                                <th>Descrição</th>
                                <th>Qtd</th>
                                <th>Valor Unit.</th>
                                <th>Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${itensPedidoAtual.length > 0 ? itensPedidoAtual.map(item => {
                                const qtd = parseFloat(item.quantidade || 0);
                                const precoUnit = parseFloat(item.preco_unitario || 0);
                                const total = parseFloat(item.preco_total) || (qtd * precoUnit);
                                return `
                                <tr>
                                    <td>${item.codigo || '-'}</td>
                                    <td>${item.descricao || '-'}</td>
                                    <td>${qtd.toLocaleString('pt-BR')}</td>
                                    <td>R$ ${precoUnit.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
                                    <td>R$ ${total.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
                                </tr>`;
                            }).join('') : `
                                <tr>
                                    <td colspan="5" style="text-align: center; color: #888;">Nenhum item</td>
                                </tr>
                            `}
                        </tbody>
                    </table>
                    <p class="total">Valor Total: ${formatarMoeda(pedidoAtual.valor)}</p>
                    <scr` + `ipt>window.print();<\/scr` + `ipt>
                    <script src="/js/popup-confirmacao.js"></script>`n</body>
                </html>
            `);
            printWindow.document.close();
        }
        
        function conferirPedido() {
            if (!pedidoAtual) return;
            
            // Simular conferência - verificar campos obrigatórios
            const erros = [];
            if (!pedidoAtual.cliente) erros.push('Cliente não informado');
            if (!pedidoAtual.valor || pedidoAtual.valor <= 0) erros.push('Valor inválido');
            
            if (erros.length > 0) {
                showNotification('Problemas encontrados: ' + erros.join(', '), 'error');
            } else {
                showNotification('Pedido conferido! Todos os dados estão corretos.', 'success');
            }
        }
        
        async function faturarPedido() {
            if (!pedidoAtual) return;
            
            // Modal de confirmação com opção de gerar NFe
            const valorFormatado = formatarMoeda(pedidoAtual.valor);
            const gerarNFe = confirm(`Deseja faturar o Orçamento Nº ${pedidoAtual.id}?\n\nValor: ${valorFormatado}\nCliente: ${pedidoAtual.cliente}\n\n✅ NFe será gerada automaticamente no módulo fiscal`);
            if (!gerarNFe) return;
            
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`/api/vendas/pedidos/${pedidoAtual.id}/faturar`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({ gerarNFe: true })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    
                    // Atualizar status localmente
                    const colunaAtual = pedidoAtual._coluna;
                    const idx = dadosVendas[colunaAtual]?.findIndex(p => p.id === pedidoAtual.id);
                    
                    if (idx !== undefined && idx !== -1) {
                        dadosVendas[colunaAtual].splice(idx, 1);
                    }
                    
                    pedidoAtual.status = 'Faturado';
                    pedidoAtual.nf = result.nf_numero;
                    pedidoAtual.nfe_chave = result.nfe_data?.chave;
                    pedidoAtual.nfe_protocolo = result.nfe_data?.protocolo;
                    pedidoAtual._coluna = 'faturado';
                    
                    if (!dadosVendas.faturado) dadosVendas.faturado = [];
                    dadosVendas.faturado.push(pedidoAtual);
                    
                    // Re-renderizar kanban
                    renderKanban();
                    
                    // Fechar modal
                    fecharModalEditar();
                    
                    // Mensagem de sucesso diferenciada
                    if (result.nfe_gerada) {
                        showNotification(`✅ Pedido faturado com sucesso!\n📄 NFe ${result.nf_numero} gerada automaticamente\n🔑 Chave: ${result.nfe_data?.chave?.substring(0, 20)}...`, 'success');
                        
                        // Opção para visualizar NFe
                        setTimeout(() => {
                            if (confirm('Deseja visualizar a NFe no módulo fiscal?')) {
                                window.open(`/modules/NFe?nfe=${result.nf_numero}`, '_blank');
                            }
                        }, 1500);
                    } else {
                        showNotification(`Pedido faturado! NF: ${result.nf_numero}\n⚠️ NFe não foi gerada automaticamente - verifique o módulo fiscal`, 'warning');
                    }
                } else {
                    const error = await response.json();
                    showNotification(error.message || 'Erro ao faturar pedido', 'error');
                }
            } catch (error) {
                console.error('Erro ao faturar:', error);
                
                // Fallback: faturar localmente
                const colunaAtual = pedidoAtual._coluna;
                const idx = dadosVendas[colunaAtual]?.findIndex(p => p.id === pedidoAtual.id);
                
                if (idx !== undefined && idx !== -1) {
                    dadosVendas[colunaAtual].splice(idx, 1);
                }
                
                pedidoAtual.status = 'Faturado';
                pedidoAtual.nf = '0000' + Math.floor(Math.random() * 9000 + 1000);
                pedidoAtual._coluna = 'faturado';
                
                if (!dadosVendas.faturado) dadosVendas.faturado = [];
                dadosVendas.faturado.push(pedidoAtual);
                
                renderKanban();
                fecharModalEditar();
                
                showNotification(`Pedido faturado! NF: ${pedidoAtual.nf}\n⚠️ Erro na conexão - NFe não foi gerada`, 'warning');
            }
        }
        
        // ========================================
        // FUNÇÃO: CRIAR NOVO PEDIDO
        // ========================================
        function abrirModalNovoPedido() {
            // Gerar novo ID para o pedido
            const novoId = Math.floor(Math.random() * 9000) + 1000;
            
            // Limpar array de itens do pedido atual
            itensPedidoAtual = [];
            
            // Criar objeto de novo pedido
            pedidoAtual = {
                id: novoId,
                cliente: '',
                valor: 0,
                vendedor: '',
                parcelas: '',
                origem: 'Interno',
                status: 'Novo',
                nf: null,
                transportadora: '',
                mensagem: '',
                _coluna: 'negociacao',
                itens: []
            };
            
            // Atualizar título do modal
            document.getElementById('modal-titulo-pedido').textContent = `Novo Orçamento Nº ${novoId}`;
            
            // Limpar avatar do cliente
            document.getElementById('modal-cliente-avatar').textContent = 'NC';
            
            // Limpar campos principais
            document.getElementById('edit-pedido-id').value = novoId;
            document.getElementById('edit-cliente').value = '';
            document.getElementById('edit-valor-total').value = 'R$ 0,00';
            document.getElementById('edit-total-mercadorias').value = 'R$ 0,00';
            document.getElementById('edit-vendedor').value = '';
            document.getElementById('edit-parcelas').value = '';
            
            // Limpar campos de desconto e impostos
            if (document.getElementById('edit-desconto')) {
                document.getElementById('edit-desconto').value = '0,00';
            }
            if (document.getElementById('edit-ipi')) {
                document.getElementById('edit-ipi').value = '0,00';
            }
            if (document.getElementById('edit-icms-st')) {
                document.getElementById('edit-icms-st').value = '0,00';
            }
            
            // Limpar observações
            if (document.getElementById('edit-observacoes')) {
                document.getElementById('edit-observacoes').value = '';
            }
            if (document.getElementById('edit-observacoes-cliente')) {
                document.getElementById('edit-observacoes-cliente').value = '';
            }
            
            // Campos de frete
            if (document.getElementById('edit-transportadora')) {
                document.getElementById('edit-transportadora').value = '';
            }
            if (document.getElementById('edit-nf')) {
                document.getElementById('edit-nf').value = '';
            }
            if (document.getElementById('edit-origem')) {
                document.getElementById('edit-origem').value = 'Interno';
            }
            if (document.getElementById('edit-valor-frete')) {
                document.getElementById('edit-valor-frete').value = '';
            }
            if (document.getElementById('edit-outras-despesas')) {
                document.getElementById('edit-outras-despesas').value = '';
            }
            
            // Atualizar alerta de status para novo
            const statusAlert = document.getElementById('status-alert');
            const statusAlertText = document.getElementById('status-alert-text');
            if (statusAlert && statusAlertText) {
                statusAlertText.textContent = 'Novo Pedido';
                statusAlert.className = 'status-alert info';
            }
            
            // Limpar tabela de itens - ID CORRETO
            const tabelaItens = document.getElementById('itens-pedido-tbody');
            if (tabelaItens) {
                tabelaItens.innerHTML = '';
            }
            
            // Atualizar paginação
            const paginationInfo = document.getElementById('pagination-info');
            if (paginationInfo) {
                paginationInfo.textContent = '0 - 0 de 0 registros';
            }
            
            // Limpar seleção de item
            itemSelecionado = null;
            itemSelecionadoIdx = null;
            
            // Resetar tabs para primeira aba
            switchModalTab('itens');
            
            // Limpar alterações
            limparAlteracoes();
            
            // Mostrar modal
            document.getElementById('modal-editar-pedido').classList.add('active');
            
            // Focar no campo cliente
            setTimeout(() => {
                document.getElementById('edit-cliente').focus();
            }, 100);
            
            showNotification('Novo pedido iniciado! Preencha os dados.', 'info');
        }
        
        async function salvarNovoPedido() {
            if (!pedidoAtual || !pedidoAtual._coluna) return;
            
            const cliente = document.getElementById('edit-cliente').value;
            if (!cliente) {
                showNotification('Por favor, informe o cliente', 'error');
                return;
            }
            
            // Atualizar dados do pedido
            pedidoAtual.cliente = cliente;
            pedidoAtual.vendedor = document.getElementById('edit-vendedor').value;
            pedidoAtual.parcelas = document.getElementById('edit-parcelas').value;
            pedidoAtual.mensagem = document.getElementById('edit-observacoes').value;
            if (document.getElementById('edit-origem')) {
                pedidoAtual.origem = document.getElementById('edit-origem').value;
            }
            if (document.getElementById('edit-transportadora')) {
                pedidoAtual.transportadora = document.getElementById('edit-transportadora').value;
            }
            
            // Calcular valor total dos itens
            let valorTotal = 0;
            const linhasItens = document.querySelectorAll('#tabela-itens-modal tbody tr');
            linhasItens.forEach(linha => {
                const totalCell = linha.querySelector('.item-total');
                if (totalCell) {
                    const valor = parseFloat(totalCell.textContent.replace('R$', '').replace(/\./g, '').replace(',', '.')) || 0;
                    valorTotal += valor;
                }
            });
            pedidoAtual.valor = valorTotal;
            
            // Adicionar à coluna de negociação
            if (!dadosVendas.negociacao) {
                dadosVendas.negociacao = [];
            }
            dadosVendas.negociacao.push(pedidoAtual);
            
            // Re-renderizar kanban
            renderKanban();
            
            // Fechar modal
            fecharModalEditar();
            
            showNotification(`Pedido Nº ${pedidoAtual.id} criado com sucesso!`, 'success');
            
            // TODO: Salvar no backend
            // await criarPedidoAPI(pedidoAtual);
        }
        
        // ========================================
        // MODAL ANEXOS
        // ========================================
        let anexosPedido = {};

        function verAnexos() {
            if (!pedidoAtual) return;
            
            // Carregar anexos do pedido
            const anexos = anexosPedido[pedidoAtual.id] || [];
            renderizarAnexos(anexos);
            
            document.getElementById('modal-anexos').classList.add('active');
        }

        function fecharModalAnexos() {
            document.getElementById('modal-anexos').classList.remove('active');
        }

        function renderizarAnexos(anexos) {
            const container = document.getElementById('lista-anexos-container');
            
            if (anexos.length === 0) {
                container.innerHTML = '<p style="color: #888; font-size: 13px;">Nenhum anexo encontrado para este pedido.</p>';
                return;
            }
            
            container.innerHTML = anexos.map((anexo, idx) => `
                <div class="anexo-item">
                    <i class="fas ${getIconeArquivo(anexo.tipo)}"></i>
                    <div class="anexo-info">
                        <div class="anexo-nome">${anexo.nome}</div>
                        <div class="anexo-tamanho">${anexo.tamanho}</div>
                    </div>
                    <div class="anexo-actions">
                        <button onclick="downloadAnexo(${idx})" title="Baixar"><i class="fas fa-download"></i></button>
                        <button class="delete" onclick="excluirAnexo(${idx})" title="Excluir"><i class="fas fa-trash"></i></button>
                    </div>
                </div>
            `).join('');
        }

        function getIconeArquivo(tipo) {
            const icones = {
                'pdf': 'fa-file-pdf',
                'doc': 'fa-file-word',
                'docx': 'fa-file-word',
                'xls': 'fa-file-excel',
                'xlsx': 'fa-file-excel',
                'jpg': 'fa-file-image',
                'jpeg': 'fa-file-image',
                'png': 'fa-file-image',
                'default': 'fa-file'
            };
            return icones[tipo] || icones['default'];
        }

        function processarAnexos(files) {
            if (!pedidoAtual) return;
            
            if (!anexosPedido[pedidoAtual.id]) {
                anexosPedido[pedidoAtual.id] = [];
            }
            
            Array.from(files).forEach(file => {
                const extensao = file.name.split('.').pop().toLowerCase();
                anexosPedido[pedidoAtual.id].push({
                    nome: file.name,
                    tipo: extensao,
                    tamanho: formatarTamanhoArquivo(file.size),
                    data: new Date().toLocaleString('pt-BR')
                });
            });
            
            renderizarAnexos(anexosPedido[pedidoAtual.id]);
            showNotification(`${files.length} arquivo(s) anexado(s)!`, 'success');
        }

        function formatarTamanhoArquivo(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }

        function downloadAnexo(idx) {
            showNotification('Iniciando download...', 'info');
        }

        function excluirAnexo(idx) {
            if (!pedidoAtual) return;
            if (confirm('Tem certeza que deseja excluir este anexo?')) {
                anexosPedido[pedidoAtual.id].splice(idx, 1);
                renderizarAnexos(anexosPedido[pedidoAtual.id]);
                showNotification('Anexo excluído!', 'success');
            }
        }

        // Drag and drop para anexos
        document.addEventListener('DOMContentLoaded', function() {
            const uploadArea = document.getElementById('anexos-upload-area');
            if (uploadArea) {
                uploadArea.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    uploadArea.classList.add('dragover');
                });
                uploadArea.addEventListener('dragleave', () => {
                    uploadArea.classList.remove('dragover');
                });
                uploadArea.addEventListener('drop', (e) => {
                    e.preventDefault();
                    uploadArea.classList.remove('dragover');
                    processarAnexos(e.dataTransfer.files);
                });
            }
        });
        
        // ========================================
        // MODAL CONFIRMAÇÃO ALTERAÇÕES NÃO SALVAS
        // ========================================
        
        // Função showToast para compatibilidade
        function showToast(message, type = 'info') {
            if (typeof showNotification === 'function') {
                showNotification(message, type);
            } else {
                console.log(`[${type}] ${message}`);
            }
        }
        
        let alteracoesNaoSalvas = [];
        let onConfirmCallback = null;
        let onCancelCallback = null;
        let formOriginalData = {};

        // Rastrear alterações em formulários
        function rastrearAlteracoes(formId) {
            const form = document.getElementById(formId);
            if (!form) return;
            
            // Salvar estado original
            const inputs = form.querySelectorAll('input, select, textarea');
            formOriginalData[formId] = {};
            inputs.forEach(input => {
                const name = input.name || input.id;
                if (name) {
                    formOriginalData[formId][name] = input.type === 'checkbox' ? input.checked : input.value;
                }
            });
            
            // Adicionar listeners para detectar mudanças
            inputs.forEach(input => {
                input.addEventListener('change', () => marcarAlteracao(formId, input));
                input.addEventListener('input', () => marcarAlteracao(formId, input));
            });
        }

        function marcarAlteracao(formId, input) {
            const name = input.name || input.id;
            const label = input.closest('.form-group')?.querySelector('label')?.textContent || name;
            const valorOriginal = formOriginalData[formId]?.[name];
            const valorAtual = input.type === 'checkbox' ? input.checked : input.value;
            
            // Verificar se o valor mudou
            if (valorOriginal !== valorAtual) {
                // Adicionar à lista se não existir
                const existe = alteracoesNaoSalvas.find(a => a.campo === name);
                if (!existe) {
                    alteracoesNaoSalvas.push({
                        campo: name,
                        label: label,
                        de: valorOriginal,
                        para: valorAtual
                    });
                } else {
                    existe.para = valorAtual;
                }
            } else {
                // Remover da lista se voltou ao original
                alteracoesNaoSalvas = alteracoesNaoSalvas.filter(a => a.campo !== name);
            }
        }

        function temAlteracoesNaoSalvas() {
            return alteracoesNaoSalvas.length > 0;
        }

        function limparAlteracoes() {
            alteracoesNaoSalvas = [];
        }

        // Mostrar modal de confirmação
        function mostrarConfirmacaoAlteracoes(onConfirm, onCancel) {
            if (!temAlteracoesNaoSalvas()) {
                if (onConfirm) onConfirm();
                return;
            }
            
            onConfirmCallback = onConfirm;
            onCancelCallback = onCancel;
            
            // Preencher lista de alterações
            const lista = document.getElementById('alteracoes-itens');
            lista.innerHTML = alteracoesNaoSalvas.map(alt => `
                <li><i class="fas fa-edit"></i> ${alt.label}</li>
            `).join('');
            
            // Esconder lista inicialmente
            document.getElementById('lista-alteracoes').classList.remove('show');
            
            document.getElementById('modal-confirmar-alteracoes').classList.add('active');
        }

        function toggleListaAlteracoes() {
            document.getElementById('lista-alteracoes').classList.toggle('show');
        }

        function confirmarDesprezarAlteracoes() {
            // Fechar o modal de confirmação
            document.getElementById('modal-confirmar-alteracoes').classList.remove('active');
            limparAlteracoes();
            
            // Fechar todos os modais abertos (modal principal de edição/orçamento)
            document.querySelectorAll('.modal-overlay.active, .modal-overlay[style*="display: flex"], .modal-overlay[style*="display: block"]').forEach(modal => {
                modal.classList.remove('active');
                modal.style.display = 'none';
            });
            
            // Executar callback de confirmação
            if (onConfirmCallback) onConfirmCallback();
            onConfirmCallback = null;
            onCancelCallback = null;
            
            // Restaurar scroll do body
            document.body.style.overflow = '';
        }

        function cancelarDesprezarAlteracoes() {
            document.getElementById('modal-confirmar-alteracoes').classList.remove('active');
            if (onCancelCallback) onCancelCallback();
            onConfirmCallback = null;
            onCancelCallback = null;
        }

        // Interceptar fechamento de modais
        function fecharModalComVerificacao(modalId, fecharFn) {
            if (temAlteracoesNaoSalvas()) {
                mostrarConfirmacaoAlteracoes(() => {
                    fecharFn();
                });
            } else {
                fecharFn();
            }
        }

        // Interceptar navegação
        window.addEventListener('beforeunload', function(e) {
            if (temAlteracoesNaoSalvas()) {
                e.preventDefault();
                e.returnValue = 'Você tem alterações não salvas. Deseja sair?';
                return e.returnValue;
            }
        });

        // Fechar modal de confirmação ao clicar fora
        document.addEventListener('DOMContentLoaded', function() {
            const modalConfirm = document.getElementById('modal-confirmar-alteracoes');
            if (modalConfirm) {
                modalConfirm.addEventListener('click', function(e) {
                    if (e.target === this) {
                        cancelarDesprezarAlteracoes();
                    }
                });
            }
            
            // Event listeners para os botões do modal de confirmação
            const btnSim = document.getElementById('btn-confirmar-sim');
            const btnNao = document.getElementById('btn-confirmar-nao');
            
            if (btnSim) {
                btnSim.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('Botão SIM clicado');
                    confirmarDesprezarAlteracoes();
                });
            }
            
            if (btnNao) {
                btnNao.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('Botão NÃO clicado');
                    cancelarDesprezarAlteracoes();
                });
            }
        });
        
        // ========================================
        // MODAL CONFIGURAÇÃO ETAPAS KANBAN
        // ========================================
        // CONFIGURAÇÃO DE ETAPAS DO KANBAN
        // ========================================
        let etapasKanban = [
            { id: 'orcamento', nome: 'Orçamento', status: 'orcamento' },
            { id: 'analise', nome: 'Análise de Crédito', status: 'analise' },
            { id: 'aprovado', nome: 'Pedido Aprovado', status: 'aprovado' },
            { id: 'faturar', nome: 'Faturar', status: 'faturar' },
            { id: 'faturado', nome: 'Faturado', status: 'faturado', destaque: true },
            { id: 'recibo', nome: 'Recibo', status: 'recibo' }
        ];

        let etapasTemp = []; // Cópia temporária para edição
        let draggedEtapa = null;

        function abrirModalEtapas() {
            // Criar cópia para edição
            etapasTemp = JSON.parse(JSON.stringify(etapasKanban));
            renderizarEtapas();
            document.getElementById('modal-etapas-kanban').classList.add('active');
        }

        function renderizarEtapas() {
            const container = document.getElementById('etapas-container');
            const ordinais = ['Primeira', 'Segunda', 'Terceira', 'Quarta', 'Quinta', 'Sexta', 'Sétima', 'Oitava', 'Nona', 'Décima'];
            
            container.innerHTML = etapasTemp.map((etapa, index) => `
                <div class="etapa-item ${etapa.destaque ? 'etapa-destaque' : ''}" 
                     data-index="${index}" 
                     draggable="true"
                     ondragstart="handleEtapaDragStart(event)"
                     ondragend="handleEtapaDragEnd(event)"
                     ondragover="handleEtapaDragOver(event)"
                     ondrop="handleEtapaDrop(event)">
                    <div class="etapa-item-header">
                        <span class="etapa-item-number">
                            <i class="fas fa-grip-vertical"></i>
                            ${ordinais[index] || (index + 1) + 'ª'} Etapa
                        </span>
                        <div class="etapa-item-actions">
                            ${etapasTemp.length > 2 ? `
                                <button type="button" class="btn-remover" onclick="removerEtapa(${index})" title="Remover etapa">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            ` : ''}
                        </div>
                    </div>
                    <input type="text" 
                           value="${etapa.nome}" 
                           placeholder="Nome da etapa"
                           onchange="atualizarNomeEtapa(${index}, this.value)"
                           data-etapa-index="${index}">
                </div>
            `).join('');
            
            atualizarContadorEtapas();
        }

        function atualizarContadorEtapas() {
            const counter = document.getElementById('etapas-counter');
            const total = etapasTemp.length;
            counter.textContent = `${total} etapa${total !== 1 ? 's' : ''} configurada${total !== 1 ? 's' : ''}`;
        }

        function atualizarNomeEtapa(index, novoNome) {
            if (etapasTemp[index]) {
                etapasTemp[index].nome = novoNome.trim() || etapasTemp[index].nome;
            }
        }

        function adicionarNovaEtapa() {
            if (etapasTemp.length >= 10) {
                showNotification('Máximo de 10 etapas permitidas!', 'warning');
                return;
            }
            
            const novoId = 'etapa_' + Date.now();
            const novaEtapa = {
                id: novoId,
                nome: 'Nova Etapa',
                status: novoId,
                destaque: false
            };
            
            etapasTemp.push(novaEtapa);
            renderizarEtapas();
            
            // Focar no novo input
            setTimeout(() => {
                const inputs = document.querySelectorAll('.etapa-item input');
                const ultimoInput = inputs[inputs.length - 1];
                if (ultimoInput) {
                    ultimoInput.focus();
                    ultimoInput.select();
                }
            }, 100);
            
            showNotification('Nova etapa adicionada!', 'success');
        }

        function removerEtapa(index) {
            if (etapasTemp.length <= 2) {
                showNotification('É necessário ter pelo menos 2 etapas!', 'warning');
                return;
            }
            
            const etapa = etapasTemp[index];
            
            // Confirmar remoção
            if (confirm(`Deseja remover a etapa "${etapa.nome}"?`)) {
                etapasTemp.splice(index, 1);
                renderizarEtapas();
                showNotification('Etapa removida!', 'info');
            }
        }

        // Drag and Drop para reordenar etapas (funções específicas para não conflitar com Kanban)
        function handleEtapaDragStart(e) {
            draggedEtapa = e.target.closest('.etapa-item');
            if (draggedEtapa) {
                draggedEtapa.classList.add('dragging');
            }
            e.dataTransfer.effectAllowed = 'move';
        }

        function handleEtapaDragEnd(e) {
            if (draggedEtapa) {
                draggedEtapa.classList.remove('dragging');
            }
            document.querySelectorAll('.etapa-item').forEach(item => {
                item.classList.remove('drag-over');
            });
            draggedEtapa = null;
        }

        function handleEtapaDragOver(e) {
            e.preventDefault();
            const target = e.target.closest('.etapa-item');
            if (target && target !== draggedEtapa) {
                target.classList.add('drag-over');
            }
        }

        function handleEtapaDrop(e) {
            e.preventDefault();
            const target = e.target.closest('.etapa-item');
            
            if (target && draggedEtapa && target !== draggedEtapa) {
                const fromIndex = parseInt(draggedEtapa.dataset.index);
                const toIndex = parseInt(target.dataset.index);
                
                // Reordenar array
                const [movedItem] = etapasTemp.splice(fromIndex, 1);
                etapasTemp.splice(toIndex, 0, movedItem);
                
                renderizarEtapas();
            }
            
            target?.classList.remove('drag-over');
        }

        function fecharModalEtapas() {
            document.getElementById('modal-etapas-kanban').classList.remove('active');
        }

        function confirmarEtapas() {
            // Atualizar valores dos inputs antes de salvar
            document.querySelectorAll('.etapa-item input').forEach((input, index) => {
                if (etapasTemp[index]) {
                    etapasTemp[index].nome = input.value.trim() || etapasTemp[index].nome;
                }
            });
            
            // Validar que todas as etapas têm nome
            const etapaSemNome = etapasTemp.find(e => !e.nome || e.nome.trim() === '');
            if (etapaSemNome) {
                showNotification('Todas as etapas precisam ter um nome!', 'warning');
                return;
            }
            
            // Salvar etapas
            etapasKanban = JSON.parse(JSON.stringify(etapasTemp));
            
            // Reconstruir o Kanban Board completamente
            reconstruirKanbanBoard();
            
            // Fechar modal
            fecharModalEtapas();
            
            // Notificação de sucesso
            showNotification('Etapas do processo atualizadas com sucesso!', 'success');
            
            // Salvar no localStorage para persistência
            localStorage.setItem('etapasKanban', JSON.stringify(etapasKanban));
        }

        // Cores para as colunas do Kanban (rotativas)
        const coresKanban = [
            '#94a3b8', // cinza
            '#f59e0b', // amarelo
            '#10b981', // verde claro
            '#f97316', // laranja
            '#22c55e', // verde
            '#06b6d4', // ciano
            '#8b5cf6', // roxo
            '#ec4899', // rosa
            '#ef4444', // vermelho
            '#14b8a6'  // teal
        ];

        function reconstruirKanbanBoard() {
            const kanbanBoard = document.getElementById('kanban-board');
            if (!kanbanBoard) return;
            
            // Guardar os cards existentes por status antes de reconstruir
            const cardsExistentes = {};
            document.querySelectorAll('.kanban-column').forEach(coluna => {
                const status = coluna.dataset.status;
                const content = coluna.querySelector('.kanban-column-content');
                if (content) {
                    cardsExistentes[status] = content.innerHTML;
                }
            });
            
            // Limpar o board
            kanbanBoard.innerHTML = '';
            
            // Reconstruir colunas baseado nas etapas
            etapasKanban.forEach((etapa, index) => {
                const cor = coresKanban[index % coresKanban.length];
                const isFirstColumn = index === 0;
                const hasFooter = etapa.footer || isFirstColumn;
                
                // Recuperar cards existentes ou usar vazio
                const cardsHtml = cardsExistentes[etapa.status] || '';
                const hasCards = cardsHtml && cardsHtml.trim() !== '' && !cardsHtml.includes('empty-column');
                
                const colunaHtml = `
                    <div class="kanban-column" data-status="${etapa.status}">
                        <div class="kanban-column-header">
                            <div>
                                <div class="column-title">${etapa.nome}</div>
                                <div class="column-count" id="count-${etapa.status}">${hasCards ? 'Carregando...' : 'Nenhum registro'}</div>
                            </div>
                            <div class="column-indicator" style="background: ${cor};"></div>
                        </div>
                        <div class="kanban-column-content" id="col-${etapa.status}">
                            ${cardsHtml || `
                                <div class="empty-column">
                                    <i class="fas fa-inbox"></i>
                                    <p>Nenhum registro</p>
                                </div>
                            `}
                        </div>
                        ${isFirstColumn ? `
                            <div class="kanban-column-footer">
                                <button class="btn-new-card" onclick="novoOrcamento()">
                                    <i class="fas fa-plus"></i> Novo Orçamento
                                </button>
                            </div>
                        ` : ''}
                    </div>
                `;
                
                kanbanBoard.insertAdjacentHTML('beforeend', colunaHtml);
            });
            
            // Reinicializar drag and drop para cards
            inicializarDragDropCards();
            
            // Atualizar contadores
            atualizarContadoresKanban();
        }

        function atualizarTitulosKanban() {
            // Atualizar cada coluna baseado nas etapas ou reconstruir se necessário
            const colunasAtuais = document.querySelectorAll('.kanban-column').length;
            
            if (colunasAtuais !== etapasKanban.length) {
                // Número de colunas diferente, reconstruir
                reconstruirKanbanBoard();
            } else {
                // Apenas atualizar títulos e reordenar se necessário
                const kanbanBoard = document.getElementById('kanban-board');
                const colunasEl = Array.from(document.querySelectorAll('.kanban-column'));
                
                // Verificar se precisa reordenar
                let precisaReordenar = false;
                etapasKanban.forEach((etapa, index) => {
                    if (colunasEl[index]?.dataset.status !== etapa.status) {
                        precisaReordenar = true;
                    }
                });
                
                if (precisaReordenar) {
                    reconstruirKanbanBoard();
                } else {
                    // Apenas atualizar títulos
                    etapasKanban.forEach((etapa, index) => {
                        const coluna = document.querySelector(`.kanban-column[data-status="${etapa.status}"]`);
                        if (coluna) {
                            const titulo = coluna.querySelector('.column-title');
                            if (titulo) {
                                titulo.textContent = etapa.nome;
                            }
                            // Atualizar cor do indicador
                            const indicator = coluna.querySelector('.column-indicator');
                            if (indicator) {
                                indicator.style.background = coresKanban[index % coresKanban.length];
                            }
                        }
                    });
                }
            }
        }

        function inicializarDragDropCards() {
            // Reinicializar eventos de drag/drop para os cards do kanban
            document.querySelectorAll('.kanban-column-content').forEach(content => {
                content.addEventListener('dragover', handleCardDragOver);
                content.addEventListener('dragleave', handleCardDragLeave);
                content.addEventListener('drop', handleCardDrop);
            });
            
            document.querySelectorAll('.kanban-card').forEach(card => {
                card.setAttribute('draggable', 'true');
                card.addEventListener('dragstart', handleCardDragStart);
                card.addEventListener('dragend', handleCardDragEnd);
            });
        }

        function atualizarContadoresKanban() {
            // Atualizar contagem de cards em cada coluna
            etapasKanban.forEach(etapa => {
                const content = document.getElementById(`col-${etapa.status}`);
                const counter = document.getElementById(`count-${etapa.status}`);
                if (content && counter) {
                    const cards = content.querySelectorAll('.kanban-card');
                    const total = cards.length;
                    if (total === 0) {
                        counter.textContent = 'Nenhum registro';
                    } else if (total === 1) {
                        counter.textContent = '1 registro';
                    } else {
                        counter.textContent = `${total} registros`;
                    }
                }
            });
        }

        // Funções de Drag/Drop para cards (se não existirem)
        function handleCardDragOver(e) {
            e.preventDefault();
            e.currentTarget.classList.add('drag-over');
        }

        function handleCardDragLeave(e) {
            e.currentTarget.classList.remove('drag-over');
        }

        function handleCardDrop(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('drag-over');
            // Implementar lógica de mover card entre colunas
        }

        function handleCardDragStart(e) {
            e.target.classList.add('dragging');
            e.dataTransfer.setData('text/plain', e.target.dataset.id);
        }

        function handleCardDragEnd(e) {
            e.target.classList.remove('dragging');
            document.querySelectorAll('.kanban-column-content').forEach(col => {
                col.classList.remove('drag-over');
            });
        }

        // Função para compatibilidade com código legado
        function getEtapaByStatus(status) {
            return etapasKanban.find(e => e.status === status) || null;
        }

        // Carregar etapas salvas ao iniciar
        document.addEventListener('DOMContentLoaded', function() {
            const etapasSalvas = localStorage.getItem('etapasKanban');
            if (etapasSalvas) {
                try {
                    const parsed = JSON.parse(etapasSalvas);
                    // Verificar se é o formato novo (array) ou antigo (objeto)
                    if (Array.isArray(parsed)) {
                        etapasKanban = parsed;
                    } else {
                        // Converter formato antigo para novo
                        etapasKanban = [
                            { id: 'orcamento', nome: parsed.orcamento || 'Orçamento', status: 'orcamento' },
                            { id: 'analise', nome: parsed.analise || 'Análise de Crédito', status: 'analise' },
                            { id: 'aprovado', nome: parsed.aprovado || 'Pedido Aprovado', status: 'aprovado' },
                            { id: 'faturar', nome: parsed.faturar || 'Faturar', status: 'faturar' },
                            { id: 'faturado', nome: parsed.faturado || 'Faturado', status: 'faturado', destaque: true },
                            { id: 'recibo', nome: parsed.recibo || 'Recibo', status: 'recibo' }
                        ];
                    }
                    // Reconstruir o kanban com as etapas salvas
                    reconstruirKanbanBoard();
                } catch (e) {
                    console.error('Erro ao carregar etapas salvas:', e);
                }
            }
            
            // Fechar modal ao clicar fora
            document.getElementById('modal-etapas-kanban').addEventListener('click', function(e) {
                if (e.target === this) fecharModalEtapas();
            });
            
            // Inicializar drag/drop para cards existentes
            inicializarDragDropCards();
        });
        
        // ========================================
        // MODAL FILTROS KANBAN
        // ========================================
        const filtrosState = {
            dataInclusao: 'tudo',
            dataPrevisao: 'tudo',
            dataFaturamento: 'ultimos-30',
            vendedor: 'todos',
            vendedorNome: 'Todos os Vendedores',
            projeto: 'todos',
            projetoNome: 'Todos os Projetos',
            exibirCancelados: false,
            exibirDenegados: false,
            exibirEncerrados: false
        };

        // Abrir modal de filtros
        function abrirModalFiltros() {
            document.getElementById('modal-filtros-kanban').classList.add('active');
        }

        // Fechar modal de filtros
        function fecharModalFiltros() {
            document.getElementById('modal-filtros-kanban').classList.remove('active');
        }

        // Desfazer filtros (restaurar padrões)
        function desfazerFiltros() {
            document.getElementById('filtro-data-inclusao').value = 'tudo';
            document.getElementById('filtro-data-previsao').value = 'tudo';
            document.getElementById('filtro-data-faturamento').value = 'ultimos-30';
            document.getElementById('filtro-vendedor').value = '';
            document.getElementById('filtro-vendedor').placeholder = 'Todos os Vendedores';
            document.getElementById('filtro-projeto').value = '';
            document.getElementById('filtro-projeto').placeholder = 'Todos os Projetos';
            document.getElementById('toggle-cancelados').checked = false;
            document.getElementById('toggle-denegados').checked = false;
            document.getElementById('toggle-encerrados').checked = false;
            
            // Atualizar estado
            filtrosState.dataInclusao = 'tudo';
            filtrosState.dataPrevisao = 'tudo';
            filtrosState.dataFaturamento = 'ultimos-30';
            filtrosState.vendedor = 'todos';
            filtrosState.vendedorNome = 'Todos os Vendedores';
            filtrosState.projeto = 'todos';
            filtrosState.projetoNome = 'Todos os Projetos';
            filtrosState.exibirCancelados = false;
            filtrosState.exibirDenegados = false;
            filtrosState.exibirEncerrados = false;
            
            // Atualizar link de filtro
            const filterLink = document.getElementById('filter-toggle');
            if (filterLink) {
                filterLink.textContent = 'Exibindo tudo';
                filterLink.style.color = '';
            }
            
            showToast('Filtros restaurados', 'info');
            
            // Recarregar Kanban sem filtros
            carregarDadosKanban(filtrosState);
        }

        // Aplicar filtros
        function aplicarFiltros() {
            filtrosState.dataInclusao = document.getElementById('filtro-data-inclusao').value;
            filtrosState.dataPrevisao = document.getElementById('filtro-data-previsao').value;
            filtrosState.dataFaturamento = document.getElementById('filtro-data-faturamento').value;
            filtrosState.exibirCancelados = document.getElementById('toggle-cancelados').checked;
            filtrosState.exibirDenegados = document.getElementById('toggle-denegados').checked;
            filtrosState.exibirEncerrados = document.getElementById('toggle-encerrados').checked;
            
            // Atualizar texto do link de filtro
            const filterLink = document.getElementById('filter-toggle');
            if (filterLink) {
                const filtrosAtivos = [];
                if (filtrosState.dataInclusao !== 'tudo') filtrosAtivos.push('Data Inclusão');
                if (filtrosState.dataPrevisao !== 'tudo') filtrosAtivos.push('Data Previsão');
                if (filtrosState.vendedor !== 'todos') filtrosAtivos.push(filtrosState.vendedorNome);
                if (filtrosState.projeto !== 'todos') filtrosAtivos.push('Projeto');
                if (filtrosState.exibirCancelados) filtrosAtivos.push('Cancelados');
                if (filtrosState.exibirDenegados) filtrosAtivos.push('Denegados');
                if (filtrosState.exibirEncerrados) filtrosAtivos.push('Encerrados');
                
                if (filtrosAtivos.length > 0) {
                    filterLink.textContent = `Filtrado: ${filtrosAtivos.join(', ')}`;
                    filterLink.style.color = '#f97316';
                } else {
                    filterLink.textContent = 'Exibindo tudo';
                    filterLink.style.color = '';
                }
            }
            
            fecharModalFiltros();
            showToast('Aplicando filtros...', 'info');
            
            // Recarregar o Kanban com os filtros aplicados
            carregarDadosKanban(filtrosState);
        }

        // Modal Selecionar Vendedor
        async function abrirModalVendedor() {
            document.getElementById('modal-selecionar-vendedor').classList.add('active');
            
            // Carregar vendedores da API
            try {
                const resp = await fetch('/api/vendas/vendedores', { credentials: 'include' });
                if (resp.ok) {
                    const vendedores = await resp.json();
                    const lista = document.getElementById('vendedor-list');
                    if (lista && vendedores.length > 0) {
                        lista.innerHTML = `
                            <div class="vendedor-item ${filtrosState.vendedor === 'todos' ? 'selected' : ''}" data-id="todos">Todos os Vendedores</div>
                            ${vendedores.map(v => `
                                <div class="vendedor-item ${filtrosState.vendedor == v.id ? 'selected' : ''}" data-id="${v.id}">${v.nome}</div>
                            `).join('')}
                        `;
                        
                        // Adicionar eventos de click
                        lista.querySelectorAll('.vendedor-item').forEach(item => {
                            item.addEventListener('click', function() {
                                selecionarVendedor(this);
                            });
                        });
                    }
                }
            } catch (err) {
                console.error('Erro ao carregar vendedores:', err);
            }
        }

        function fecharModalVendedor() {
            document.getElementById('modal-selecionar-vendedor').classList.remove('active');
        }

        // Selecionar vendedor da lista
        function selecionarVendedor(item) {
            const vendedorId = item.dataset.id;
            const vendedorNome = item.textContent.trim();
            
            // Atualizar estado
            filtrosState.vendedor = vendedorId;
            filtrosState.vendedorNome = vendedorNome;
            
            // Atualizar input
            const inputVendedor = document.getElementById('filtro-vendedor');
            if (vendedorId === 'todos') {
                inputVendedor.value = '';
                inputVendedor.placeholder = 'Todos os Vendedores';
            } else {
                inputVendedor.value = vendedorNome;
            }
            
            // Marcar como selecionado
            document.querySelectorAll('.vendedor-item').forEach(el => el.classList.remove('selected'));
            item.classList.add('selected');
            
            fecharModalVendedor();
        }

        // Modal Selecionar Projeto
        function abrirModalProjeto() {
            // Mesma lógica do vendedor, pode ser implementado depois
            showToast('Seleção de projetos em desenvolvimento', 'info');
        }

        // Inicializar eventos do modal de filtros
        document.addEventListener('DOMContentLoaded', function() {
            // Click no link "Exibindo tudo" para abrir modal
            const filterToggle = document.getElementById('filter-toggle');
            if (filterToggle) {
                filterToggle.addEventListener('click', function(e) {
                    e.preventDefault();
                    abrirModalFiltros();
                });
            }
            
            // Busca de vendedor
            const buscaVendedor = document.getElementById('busca-vendedor');
            if (buscaVendedor) {
                buscaVendedor.addEventListener('input', function() {
                    const termo = this.value.toLowerCase();
                    document.querySelectorAll('.vendedor-item').forEach(item => {
                        const nome = item.textContent.toLowerCase();
                        item.style.display = nome.includes(termo) ? 'block' : 'none';
                    });
                });
            }
            
            // Fechar modais ao clicar fora
            document.getElementById('modal-filtros-kanban').addEventListener('click', function(e) {
                if (e.target === this) fecharModalFiltros();
            });
            
            document.getElementById('modal-selecionar-vendedor').addEventListener('click', function(e) {
                if (e.target === this) fecharModalVendedor();
            });
        });
        
        // ========================================
        // MODAL EMAILS ENVIADOS
        // ========================================
        let emailsPedido = {};

        function verEmailsEnviados() {
            if (!pedidoAtual) return;
            
            // Carregar emails do pedido (simular dados)
            if (!emailsPedido[pedidoAtual.id]) {
                emailsPedido[pedidoAtual.id] = [
                    {
                        destinatario: 'cliente@empresa.com',
                        assunto: `Orçamento Nº ${pedidoAtual.id} - Aluforce`,
                        data: '15/12/2025 14:30',
                        status: 'lido'
                    }
                ];
            }
            
            renderizarEmails(emailsPedido[pedidoAtual.id]);
            document.getElementById('modal-emails').classList.add('active');
        }

        function fecharModalEmails() {
            document.getElementById('modal-emails').classList.remove('active');
        }

        function renderizarEmails(emails) {
            const container = document.getElementById('emails-lista');
            
            if (emails.length === 0) {
                container.innerHTML = '<p style="color: #888; font-size: 13px; text-align: center; padding: 20px;">Nenhum email enviado para este pedido.</p>';
                return;
            }
            
            container.innerHTML = emails.map(email => `
                <div class="email-item">
                    <div class="email-header">
                        <span class="email-destinatario"><i class="fas fa-user"></i> ${email.destinatario}</span>
                        <span class="email-data">${email.data}</span>
                    </div>
                    <div class="email-assunto">${email.assunto}</div>
                    <span class="email-status ${email.status}">
                        <i class="fas ${email.status === 'lido' ? 'fa-check-double' : 'fa-check'}"></i>
                        ${email.status === 'lido' ? 'Lido' : 'Enviado'}
                    </span>
                </div>
            `).join('');
        }

        function abrirEnviarEmail() {
            fecharModalEmails();
            // Ir para a aba de email no modal principal
            switchModalTab('email');
        }
        
        // ========================================
        // MODAL HISTÓRICO
        // ========================================
        // MODAL HISTÓRICO - PROFISSIONAL
        // ========================================
        async function verHistorico() {
            if (!pedidoAtual) return;
            
            const container = document.getElementById('historico-timeline');
            container.innerHTML = '<div class="historico-empty"><i class="fas fa-spinner fa-spin"></i><p>Carregando histórico...</p></div>';
            document.getElementById('modal-historico').classList.add('active');
            
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`/api/vendas/pedidos/${pedidoAtual.id}/historico`, {
                    headers: { 'Authorization': `Bearer ${token}` },
                    credentials: 'include'
                });
                
                if (response.ok) {
                    const historico = await response.json();
                    renderizarHistoricoPro(historico);
                } else {
                    // Se não tiver histórico na API, mostrar histórico simulado
                    renderizarHistoricoSimulado();
                }
            } catch (error) {
                console.error('Erro ao carregar histórico:', error);
                renderizarHistoricoSimulado();
            }
        }

        function fecharModalHistorico() {
            document.getElementById('modal-historico').classList.remove('active');
        }

        function renderizarHistoricoPro(historico) {
            const container = document.getElementById('historico-timeline');
            
            if (!historico || historico.length === 0) {
                container.innerHTML = `
                    <div class="historico-empty">
                        <i class="fas fa-clock"></i>
                        <p>Nenhum histórico registrado para este pedido.</p>
                    </div>
                `;
                return;
            }
            
            // Ordenar por data (mais recente primeiro)
            const historicoOrdenado = [...historico].sort((a, b) => 
                new Date(b.created_at) - new Date(a.created_at)
            );
            
            container.innerHTML = historicoOrdenado.map(item => {
                const data = new Date(item.created_at);
                const dataFormatada = data.toLocaleDateString('pt-BR') + ' às ' + data.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                const tipoClasse = getTipoClasse(item.action);
                const badge = getBadgeHtml(item.action);
                
                return `
                    <div class="historico-item-pro tipo-${tipoClasse}">
                        <div class="historico-header-pro">
                            ${badge}
                            <span class="historico-data-pro">${dataFormatada}</span>
                        </div>
                        <div class="historico-descricao-pro">${item.descricao || item.action}</div>
                        <div class="historico-usuario-pro">
                            <i class="fas fa-user-circle"></i>
                            ${item.user_name || 'Sistema'}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderizarHistoricoSimulado() {
            const historico = [
                {
                    created_at: new Date().toISOString(),
                    user_name: localStorage.getItem('userName') || 'Usuário',
                    action: 'criacao',
                    descricao: 'Pedido criado no sistema'
                }
            ];
            
            // Adicionar evento de status se existir
            if (pedidoAtual.status) {
                historico.push({
                    created_at: new Date(Date.now() - 3600000).toISOString(),
                    user_name: 'Sistema',
                    action: 'status',
                    descricao: `Status atual: ${pedidoAtual.status}`
                });
            }
            
            renderizarHistoricoPro(historico);
        }

        function getTipoClasse(action) {
            const tipos = {
                'faturamento': 'faturamento',
                'faturar': 'faturamento',
                'status': 'status',
                'status_alterado': 'status',
                'edicao': 'edicao',
                'item_added': 'edicao',
                'item_updated': 'edicao',
                'item_deleted': 'edicao',
                'criacao': 'criacao',
                'pedido_criado': 'criacao'
            };
            return tipos[action] || 'edicao';
        }

        function getBadgeHtml(action) {
            const badges = {
                'faturamento': '<span class="historico-badge badge-faturamento"><i class="fas fa-check-circle"></i> Faturamento</span>',
                'faturar': '<span class="historico-badge badge-faturamento"><i class="fas fa-check-circle"></i> Faturamento</span>',
                'status': '<span class="historico-badge badge-status"><i class="fas fa-exchange-alt"></i> Etapa</span>',
                'status_alterado': '<span class="historico-badge badge-status"><i class="fas fa-exchange-alt"></i> Etapa</span>',
                'edicao': '<span class="historico-badge badge-edicao"><i class="fas fa-edit"></i> Edição</span>',
                'item_added': '<span class="historico-badge badge-item"><i class="fas fa-plus"></i> Item</span>',
                'item_updated': '<span class="historico-badge badge-item"><i class="fas fa-edit"></i> Item</span>',
                'item_deleted': '<span class="historico-badge badge-item"><i class="fas fa-trash"></i> Item</span>',
                'criacao': '<span class="historico-badge badge-criacao"><i class="fas fa-file-alt"></i> Criação</span>',
                'pedido_criado': '<span class="historico-badge badge-criacao"><i class="fas fa-file-alt"></i> Criação</span>'
            };
            return badges[action] || '<span class="historico-badge badge-edicao"><i class="fas fa-info"></i> Alteração</span>';
        }

        // Registrar histórico localmente (quando API não disponível)
        async function registrarHistoricoLocal(action, descricao) {
            if (!pedidoAtual) return;
            
            try {
                const token = localStorage.getItem('token');
                await fetch(`/api/vendas/pedidos/${pedidoAtual.id}/historico`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({ action, descricao })
                });
            } catch (error) {
                console.warn('Erro ao registrar histórico:', error);
            }
        }
        
        // ========================================
        // MODAL TAREFAS
        // ========================================
        let tarefasPedido = {};

        function verTarefas() {
            if (!pedidoAtual) return;
            
            // Carregar tarefas do pedido
            if (!tarefasPedido[pedidoAtual.id]) {
                tarefasPedido[pedidoAtual.id] = [
                    { id: 1, texto: 'Confirmar pagamento com cliente', concluida: true },
                    { id: 2, texto: 'Aguardar aprovação de crédito', concluida: false },
                    { id: 3, texto: 'Enviar documentação fiscal', concluida: false }
                ];
            }
            
            renderizarTarefas(tarefasPedido[pedidoAtual.id]);
            document.getElementById('modal-tarefas').classList.add('active');
        }

        function fecharModalTarefas() {
            document.getElementById('modal-tarefas').classList.remove('active');
        }

        function renderizarTarefas(tarefas) {
            const container = document.getElementById('tarefas-lista');
            
            if (tarefas.length === 0) {
                container.innerHTML = '<p style="color: #888; font-size: 13px; text-align: center; padding: 20px;">Nenhuma tarefa cadastrada.</p>';
                return;
            }
            
            container.innerHTML = tarefas.map((tarefa, idx) => `
                <div class="tarefa-item ${tarefa.concluida ? 'concluida' : ''}">
                    <input type="checkbox" class="tarefa-checkbox" ${tarefa.concluida ? 'checked' : ''} onchange="toggleTarefa(${idx})">
                    <span class="tarefa-texto">${tarefa.texto}</span>
                    <button class="tarefa-delete" onclick="excluirTarefa(${idx})"><i class="fas fa-trash"></i></button>
                </div>
            `).join('');
        }

        function adicionarTarefa() {
            if (!pedidoAtual) return;
            
            const input = document.getElementById('input-nova-tarefa');
            const texto = input.value.trim();
            
            if (!texto) {
                showNotification('Digite a descrição da tarefa', 'warning');
                return;
            }
            
            if (!tarefasPedido[pedidoAtual.id]) {
                tarefasPedido[pedidoAtual.id] = [];
            }
            
            tarefasPedido[pedidoAtual.id].push({
                id: Date.now(),
                texto: texto,
                concluida: false
            });
            
            input.value = '';
            renderizarTarefas(tarefasPedido[pedidoAtual.id]);
            showNotification('Tarefa adicionada!', 'success');
        }

        function toggleTarefa(idx) {
            if (!pedidoAtual) return;
            tarefasPedido[pedidoAtual.id][idx].concluida = !tarefasPedido[pedidoAtual.id][idx].concluida;
            renderizarTarefas(tarefasPedido[pedidoAtual.id]);
        }

        function excluirTarefa(idx) {
            if (!pedidoAtual) return;
            tarefasPedido[pedidoAtual.id].splice(idx, 1);
            renderizarTarefas(tarefasPedido[pedidoAtual.id]);
            showNotification('Tarefa removida!', 'success');
        }
        
        // ========================================
        // MODAL PEDIDO PARCIAL
        // ========================================
        function pedidoParcial() {
            if (!pedidoAtual) return;
            
            // Mostrar itens do pedido para seleção parcial
            const container = document.getElementById('itens-parcial-lista');
            
            // Simular itens do pedido
            const itens = [
                { codigo: 'ITEM001', nome: pedidoAtual.cliente + ' - Produto 1', qtd: 5, qtdDisp: 5 },
                { codigo: 'ITEM002', nome: pedidoAtual.cliente + ' - Produto 2', qtd: 3, qtdDisp: 3 }
            ];
            
            container.innerHTML = itens.map((item, idx) => `
                <div class="item-parcial">
                    <input type="checkbox" class="item-parcial-checkbox" id="item-parcial-${idx}" checked>
                    <div class="item-parcial-info">
                        <div class="item-parcial-nome">${item.codigo} - ${item.nome}</div>
                        <div class="item-parcial-qtd-original">Qtd Original: ${item.qtd} | Disponível: ${item.qtdDisp}</div>
                    </div>
                    <input type="number" class="item-parcial-qtd-input" value="${item.qtdDisp}" min="0" max="${item.qtdDisp}">
                </div>
            `).join('');
            
            document.getElementById('modal-pedido-parcial').classList.add('active');
        }

        function fecharModalPedidoParcial() {
            document.getElementById('modal-pedido-parcial').classList.remove('active');
        }

        function gerarPedidoParcial() {
            showNotification('Pedido parcial gerado com sucesso!', 'success');
            fecharModalPedidoParcial();
        }
        
        function cancelarPedido() {
            if (!pedidoAtual) return;
            
            const confirmar = confirm(`Tem certeza que deseja cancelar o Orçamento Nº ${pedidoAtual.id}?\n\nO pedido será marcado como cancelado.`);
            if (!confirmar) return;
            
            // Atualizar status do pedido
            pedidoAtual.status = 'Cancelado';
            pedidoAtual.statusAnterior = pedidoAtual.status;
            
            // Re-renderizar kanban
            renderKanban();
            
            // Fechar modal
            fecharModalEditar();
            showNotification(`Orçamento Nº ${pedidoAtual.id} cancelado!`, 'warning');
        }

        // Função Incluir (Criar novo pedido a partir do modal)
        function incluirPedido() {
            // Abrir modal de novo orçamento
            novoOrcamento();
        }
        
        function adicionarItem() {
            // Abre modal para adicionar novo item ao pedido
            novoItemPedido();
        }
        
        // ========================================
        // AUTOCOMPLETE DE PRODUTOS - API REAL
        // ========================================
        let produtoSelecionadoAutoComplete = null;
        let autocompleteTimeout = null;
        let autocompleteSelectedIndex = -1;

        // Inicializar autocomplete
        function initProdutoAutocomplete() {
            const input = document.getElementById('item-pedido-produto');
            const dropdown = document.getElementById('produto-autocomplete-dropdown');
            
            if (!input || !dropdown) return;

            // Evento de digitação
            input.addEventListener('input', function(e) {
                const termo = e.target.value.trim();
                
                // Limpar timeout anterior
                if (autocompleteTimeout) clearTimeout(autocompleteTimeout);
                
                // Resetar seleção
                autocompleteSelectedIndex = -1;
                
                if (termo.length < 2) {
                    dropdown.classList.remove('active');
                    return;
                }
                
                // Debounce de 300ms
                autocompleteTimeout = setTimeout(() => {
                    buscarProdutosAutocomplete(termo);
                }, 300);
            });

            // Navegação com teclado
            input.addEventListener('keydown', function(e) {
                const items = dropdown.querySelectorAll('.autocomplete-item');
                
                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    autocompleteSelectedIndex = Math.min(autocompleteSelectedIndex + 1, items.length - 1);
                    atualizarSelecaoAutocomplete(items);
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    autocompleteSelectedIndex = Math.max(autocompleteSelectedIndex - 1, 0);
                    atualizarSelecaoAutocomplete(items);
                } else if (e.key === 'Enter') {
                    e.preventDefault();
                    if (autocompleteSelectedIndex >= 0 && items[autocompleteSelectedIndex]) {
                        items[autocompleteSelectedIndex].click();
                    }
                } else if (e.key === 'Escape') {
                    dropdown.classList.remove('active');
                }
            });

            // Fechar dropdown ao clicar fora
            document.addEventListener('click', function(e) {
                if (!input.contains(e.target) && !dropdown.contains(e.target)) {
                    dropdown.classList.remove('active');
                }
            });
        }

        // Atualizar item selecionado visualmente
        function atualizarSelecaoAutocomplete(items) {
            items.forEach((item, idx) => {
                item.classList.toggle('selected', idx === autocompleteSelectedIndex);
            });
            if (items[autocompleteSelectedIndex]) {
                items[autocompleteSelectedIndex].scrollIntoView({ block: 'nearest' });
            }
        }

        // Buscar produtos via API
        async function buscarProdutosAutocomplete(termo) {
            const dropdown = document.getElementById('produto-autocomplete-dropdown');
            
            try {
                // Tentar obter token de várias fontes (múltiplas tentativas)
                let token = localStorage.getItem('authToken') || 
                            localStorage.getItem('token') || 
                            sessionStorage.getItem('authToken') ||
                            sessionStorage.getItem('token');
                
                // Também tenta buscar do cookie
                if (!token) {
                    const cookies = document.cookie.split(';');
                    for (let cookie of cookies) {
                        const [name, value] = cookie.trim().split('=');
                        if (name === 'authToken' || name === 'token') {
                            token = decodeURIComponent(value);
                            break;
                        }
                    }
                }
                
                // Verificar se existe usuário logado
                const userData = localStorage.getItem('user') || localStorage.getItem('userData');
                const isUserLogged = !!userData;
                
                // Fazer requisição mesmo sem token (servidor verifica cookie)
                const headers = {
                    'Content-Type': 'application/json'
                };
                
                if (token) {
                    headers['Authorization'] = `Bearer ${token}`;
                }
                
                const response = await fetch(`/api/vendas/produtos/autocomplete/${encodeURIComponent(termo)}`, {
                    headers,
                    credentials: 'include'
                });
                
                if (response.ok) {
                    const produtos = await response.json();
                    renderizarAutocomplete(produtos);
                } else if (response.status === 401) {
                    showNotification('Sessão expirada. Faça login novamente.', 'error');
                    dropdown.innerHTML = '<div class="autocomplete-no-results">Sessão expirada</div>';
                    dropdown.classList.add('active');
                } else {
                    dropdown.innerHTML = '<div class="autocomplete-no-results">Erro ao buscar produtos</div>';
                    dropdown.classList.add('active');
                }
            } catch (error) {
                console.error('Erro no autocomplete:', error);
                dropdown.innerHTML = '<div class="autocomplete-no-results">Erro de conexão</div>';
                dropdown.classList.add('active');
            }
        }

        // Renderizar lista de autocomplete
        function renderizarAutocomplete(produtos) {
            const dropdown = document.getElementById('produto-autocomplete-dropdown');
            
            if (produtos.length === 0) {
                dropdown.innerHTML = '<div class="autocomplete-no-results"><i class="fas fa-search"></i> Nenhum produto encontrado</div>';
                dropdown.classList.add('active');
                return;
            }
            
            dropdown.innerHTML = produtos.map((p, idx) => `
                <div class="autocomplete-item" data-idx="${idx}" onclick="selecionarProdutoAutocomplete(${idx})">
                    <span class="autocomplete-item-code">${p.codigo || ''}</span>
                    <span class="autocomplete-item-desc">${p.descricao || ''}</span>
                    <span class="autocomplete-item-info">
                        <span><i class="fas fa-box"></i> Estoque: ${formatarQuantidade(p.estoque_atual || 0)} ${p.unidade || 'M'}</span>
                        <span><i class="fas fa-tag"></i> ${formatarMoeda(p.preco_venda || 0)}</span>
                        <span><i class="fas fa-warehouse"></i> ${p.local_estoque || 'PADRAO'}</span>
                    </span>
                </div>
            `).join('');
            
            // Guardar produtos no DOM para seleção
            dropdown.produtosData = produtos;
            dropdown.classList.add('active');
        }

        // Selecionar produto do autocomplete
        function selecionarProdutoAutocomplete(idx) {
            const dropdown = document.getElementById('produto-autocomplete-dropdown');
            const input = document.getElementById('item-pedido-produto');
            const produto = dropdown.produtosData[idx];
            
            if (!produto) return;
            
            // Preencher dados do produto selecionado
            produtoSelecionadoAutoComplete = produto;
            input.value = `${produto.codigo} - ${produto.descricao}`;
            
            // Preencher preço
            const precoInput = document.getElementById('item-pedido-preco');
            if (precoInput) {
                precoInput.value = formatarDecimal(produto.preco_venda || 0);
            }
            
            // Atualizar cálculos
            atualizarCalculosItem();
            
            // Fechar dropdown
            dropdown.classList.remove('active');
            
            // Focus no campo quantidade
            const qtdInput = document.getElementById('item-pedido-quantidade');
            if (qtdInput) qtdInput.focus();
        }

        // Atualizar valores calculados
        function atualizarCalculosItem() {
            const quantidade = parseFloat(document.getElementById('item-pedido-quantidade')?.value) || 0;
            const preco = parseDecimal(document.getElementById('item-pedido-preco')?.value);
            const descontoPct = parseFloat(document.getElementById('item-pedido-desconto-pct')?.value?.replace(',', '.')) || 0;
            
            const valorMercadoria = quantidade * preco;
            const valorDesconto = valorMercadoria * (descontoPct / 100);
            const totalItem = valorMercadoria - valorDesconto;
            
            // Atualizar exibição
            document.getElementById('calc-valor-mercadoria').textContent = formatarMoeda(valorMercadoria);
            document.getElementById('calc-valor-desconto').textContent = formatarMoeda(valorDesconto);
            document.getElementById('calc-total-item').textContent = formatarMoeda(totalItem);
            
            // Calcular total do pedido (itens existentes + este item)
            const totalExistente = itensPedidoAtual.reduce((sum, item) => {
                const qtd = parseFloat(item.quantidade) || 0;
                const prc = parseFloat(item.preco_unitario) || 0;
                const desc = parseFloat(item.desconto) || 0;
                return sum + (qtd * prc - desc);
            }, 0);
            
            document.getElementById('calc-total-pedido').textContent = formatarMoeda(totalExistente + totalItem);
        }

        // Toggle observações
        function toggleObservacoesItem() {
            const container = document.getElementById('item-observacoes-container');
            if (container) {
                container.style.display = container.style.display === 'none' ? 'block' : 'none';
            }
        }

        // Pesquisar produto (abre modal de pesquisa avançada)
        function abrirPesquisaProduto() {
            showNotification('Funcionalidade de pesquisa avançada em desenvolvimento', 'info');
        }

        // Inicializar eventos ao carregar a página
        document.addEventListener('DOMContentLoaded', function() {
            initProdutoAutocomplete();
            
            // Eventos de cálculo ao alterar valores
            ['item-pedido-quantidade', 'item-pedido-preco', 'item-pedido-desconto-pct'].forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    el.addEventListener('input', atualizarCalculosItem);
                    el.addEventListener('change', atualizarCalculosItem);
                }
            });
        });
        
        // ========================================
        // CRUD ITENS DO PEDIDO
        // ========================================
        let itensPedidoAtual = [];
        let itemSelecionado = null;
        let itemSelecionadoIdx = null;
        let modoEdicaoItem = false;

        // Carregar itens do pedido da API
        async function carregarItensPedido(pedidoId) {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`/api/vendas/pedidos/${pedidoId}/itens`, {
                    headers: { 'Authorization': `Bearer ${token}` },
                    credentials: 'include'
                });
                if (response.ok) {
                    itensPedidoAtual = await response.json();
                } else {
                    itensPedidoAtual = [];
                }
            } catch (error) {
                console.error('Erro ao carregar itens:', error);
                itensPedidoAtual = [];
            }
            renderizarTabelaItens();
        }

        // Renderizar tabela de itens
        function renderizarTabelaItens() {
            const tbody = document.getElementById('itens-pedido-tbody');
            const paginationInfo = document.getElementById('pagination-info');
            
            if (!tbody) return;
            
            if (itensPedidoAtual.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; color: #888; padding: 40px;">
                            <i class="fas fa-box-open" style="font-size: 32px; margin-bottom: 10px; display: block;"></i>
                            Nenhum item adicionado. Clique em "Novo Item" para adicionar.
                        </td>
                    </tr>
                `;
                paginationInfo.textContent = '0 registros';
                return;
            }
            
            tbody.innerHTML = itensPedidoAtual.map((item, idx) => `
                <tr data-index="${idx}" data-id="${item.id}" onclick="selecionarItemTabela(${idx})" ondblclick="editarItemPorIndice(${idx})">
                    <td class="produto-code">${item.codigo || ''}</td>
                    <td class="produto-desc">${item.descricao || ''}</td>
                    <td>${formatarQuantidade(item.quantidade)} ${item.unidade || 'M'}</td>
                    <td>${formatarQuantidade(item.quantidade_parcial)} ${item.unidade || 'M'}</td>
                    <td>${item.local_estoque || 'PADRAO'}</td>
                    <td>${formatarMoeda(item.preco_unitario)}</td>
                </tr>
            `).join('');
            
            paginationInfo.textContent = `1 - ${itensPedidoAtual.length} de ${itensPedidoAtual.length} registros`;
        }

        function formatarQuantidade(valor) {
            return parseFloat(valor || 0).toLocaleString('pt-BR', { minimumFractionDigits: 0, maximumFractionDigits: 3 });
        }

        // Selecionar item na tabela
        function selecionarItemTabela(idx) {
            // Remover seleção anterior
            document.querySelectorAll('#itens-pedido-tbody tr').forEach(tr => tr.classList.remove('selected'));
            
            // Adicionar seleção
            const tr = document.querySelector(`#itens-pedido-tbody tr[data-index="${idx}"]`);
            if (tr) {
                tr.classList.add('selected');
                itemSelecionadoIdx = idx;
                itemSelecionado = itensPedidoAtual[idx];
            }
        }

        // Adicionar novo item
        function adicionarItem() {
            if (!pedidoAtual) {
                showNotification('Nenhum pedido selecionado', 'error');
                return;
            }
            
            modoEdicaoItem = false;
            itemSelecionado = null;
            produtoSelecionadoAutoComplete = null;
            
            // Limpar campos do novo modal
            document.getElementById('item-pedido-id').value = '';
            document.getElementById('item-pedido-produto').value = '';
            document.getElementById('item-pedido-cfop').value = '';
            document.getElementById('item-pedido-quantidade').value = '1';
            document.getElementById('item-pedido-preco').value = '0,00';
            document.getElementById('item-pedido-tabela-preco').value = '';
            document.getElementById('item-pedido-desconto-pct').value = '0';
            document.getElementById('item-pedido-estoque').value = 'PADRAO - Local de Estoque Padrão';
            document.getElementById('item-pedido-cenario').value = 'Padrão';
            document.getElementById('item-pedido-npc').value = '';
            document.getElementById('item-pedido-item-npc').value = '0';
            document.getElementById('item-pedido-observacoes').value = '';
            
            // Limpar checkboxes
            document.getElementById('item-nao-gerar-saida').checked = false;
            document.getElementById('item-nao-gerar-conta').checked = false;
            document.getElementById('item-continuar-incluindo').checked = true;
            
            // Esconder observações
            document.getElementById('item-observacoes-container').style.display = 'none';
            
            // Resetar cálculos
            document.getElementById('calc-valor-mercadoria').textContent = 'R$ 0,00';
            document.getElementById('calc-valor-desconto').textContent = 'R$ 0,00';
            document.getElementById('calc-ipi').textContent = 'R$ 0,00';
            document.getElementById('calc-icms-st').textContent = 'R$ 0,00';
            document.getElementById('calc-total-item').textContent = 'R$ 0,00';
            
            // Atualizar total do pedido existente
            const totalExistente = itensPedidoAtual.reduce((sum, item) => {
                const qtd = parseFloat(item.quantidade) || 0;
                const prc = parseFloat(item.preco_unitario) || 0;
                const desc = parseFloat(item.desconto) || 0;
                return sum + (qtd * prc - desc);
            }, 0);
            document.getElementById('calc-total-pedido').textContent = formatarMoeda(totalExistente);
            
            document.getElementById('modal-item-titulo').textContent = 'Novo Item de Pedido de Venda';
            document.getElementById('modal-item-pedido').classList.add('active');
            
            // Focar no campo produto
            setTimeout(() => {
                document.getElementById('item-pedido-produto').focus();
            }, 100);
        }

        // Editar item selecionado
        function editarItemSelecionado() {
            if (itemSelecionadoIdx === null || !itemSelecionado) {
                showNotification('Selecione um item na tabela para editar', 'info');
                return;
            }
            editarItemPorIndice(itemSelecionadoIdx);
        }

        // Editar item por índice (duplo clique)
        function editarItemPorIndice(idx) {
            const item = itensPedidoAtual[idx];
            if (!item) return;
            
            modoEdicaoItem = true;
            itemSelecionado = item;
            produtoSelecionadoAutoComplete = {
                id: item.produto_id,
                codigo: item.codigo,
                descricao: item.descricao,
                preco_venda: item.preco_unitario,
                unidade: item.unidade
            };
            
            // Preencher campos do novo modal
            document.getElementById('item-pedido-id').value = item.id;
            document.getElementById('item-pedido-produto').value = `${item.codigo || ''} - ${item.descricao || ''}`;
            document.getElementById('item-pedido-cfop').value = item.cfop || '';
            document.getElementById('item-pedido-quantidade').value = item.quantidade || 1;
            document.getElementById('item-pedido-preco').value = formatarDecimal(item.preco_unitario);
            document.getElementById('item-pedido-tabela-preco').value = item.tabela_preco || '';
            document.getElementById('item-pedido-desconto-pct').value = item.desconto_pct || '0';
            document.getElementById('item-pedido-estoque').value = item.local_estoque || 'PADRAO - Local de Estoque Padrão';
            document.getElementById('item-pedido-cenario').value = item.cenario_fiscal || 'Padrão';
            document.getElementById('item-pedido-npc').value = item.numero_pedido_compra || '';
            document.getElementById('item-pedido-item-npc').value = item.item_pedido_compra || '0';
            document.getElementById('item-pedido-observacoes').value = item.observacoes || '';
            
            // Atualizar cálculos
            atualizarCalculosItem();
            
            document.getElementById('modal-item-titulo').textContent = 'Editar Item de Pedido de Venda';
            document.getElementById('modal-item-pedido').classList.add('active');
        }

        function formatarDecimal(valor) {
            return parseFloat(valor || 0).toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        function parseDecimal(str) {
            if (!str) return 0;
            return parseFloat(str.replace(/\./g, '').replace(',', '.')) || 0;
        }

        // Fechar modal de item
        function fecharModalItemPedido() {
            document.getElementById('modal-item-pedido').classList.remove('active');
            document.getElementById('produto-autocomplete-dropdown').classList.remove('active');
        }

        // Salvar item (criar ou atualizar)
        async function salvarItemPedido() {
            // Obter dados do produto selecionado
            const produtoInput = document.getElementById('item-pedido-produto').value.trim();
            
            // Extrair código e descrição do input
            let codigo = '';
            let descricao = '';
            
            if (produtoSelecionadoAutoComplete) {
                codigo = produtoSelecionadoAutoComplete.codigo;
                descricao = produtoSelecionadoAutoComplete.descricao;
            } else if (produtoInput.includes(' - ')) {
                const parts = produtoInput.split(' - ');
                codigo = parts[0].trim();
                descricao = parts.slice(1).join(' - ').trim();
            } else {
                codigo = produtoInput;
                descricao = produtoInput;
            }
            
            const quantidade = parseFloat(document.getElementById('item-pedido-quantidade').value) || 1;
            const precoUnitario = parseDecimal(document.getElementById('item-pedido-preco').value);
            const descontoPct = parseFloat(document.getElementById('item-pedido-desconto-pct')?.value?.replace(',', '.')) || 0;
            const desconto = (quantidade * precoUnitario) * (descontoPct / 100); // Calcular valor do desconto
            const localEstoque = document.getElementById('item-pedido-estoque').value;
            const cfop = document.getElementById('item-pedido-cfop').value;
            const cenarioFiscal = document.getElementById('item-pedido-cenario').value;
            const observacoes = document.getElementById('item-pedido-observacoes').value;
            const unidade = produtoSelecionadoAutoComplete?.unidade || 'M';
            
            if (!codigo && !produtoInput) {
                showNotification('Selecione um produto', 'warning');
                document.getElementById('item-pedido-produto').focus();
                return;
            }
            
            const token = localStorage.getItem('token');
            const itemData = {
                codigo,
                descricao,
                quantidade,
                quantidade_parcial: 0,
                preco_unitario: precoUnitario,
                desconto,
                desconto_pct: descontoPct,
                unidade,
                local_estoque: localEstoque,
                cfop,
                cenario_fiscal: cenarioFiscal,
                observacoes,
                produto_id: produtoSelecionadoAutoComplete?.id || null
            };
            
            try {
                let response;
                if (modoEdicaoItem && itemSelecionado) {
                    // Atualizar item existente
                    response = await fetch(`/api/vendas/pedidos/${pedidoAtual.id}/itens/${itemSelecionado.id}`, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        credentials: 'include',
                        body: JSON.stringify(itemData)
                    });
                } else {
                    // Criar novo item
                    response = await fetch(`/api/vendas/pedidos/${pedidoAtual.id}/itens`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        credentials: 'include',
                        body: JSON.stringify(itemData)
                    });
                }
                
                if (response.ok) {
                    showNotification(modoEdicaoItem ? 'Item atualizado com sucesso!' : 'Item adicionado com sucesso!', 'success');
                    
                    // Verificar se deve continuar incluindo
                    const continuarIncluindo = document.getElementById('item-continuar-incluindo').checked;
                    
                    if (continuarIncluindo && !modoEdicaoItem) {
                        // Limpar formulário e manter modal aberto
                        produtoSelecionadoAutoComplete = null;
                        document.getElementById('item-pedido-produto').value = '';
                        document.getElementById('item-pedido-quantidade').value = '1';
                        document.getElementById('item-pedido-preco').value = '0,00';
                        document.getElementById('item-pedido-desconto-pct').value = '0';
                        document.getElementById('item-pedido-produto').focus();
                        
                        // Recarregar itens para atualizar total
                        await carregarItensPedido(pedidoAtual.id);
                        atualizarCalculosItem();
                    } else {
                        fecharModalItemPedido();
                        // Recarregar itens
                        await carregarItensPedido(pedidoAtual.id);
                    }
                    
                    // Atualizar total no modal
                    atualizarTotalModalEditar();
                } else {
                    // Tratar erros de autenticação
                    if (response.status === 401 || response.status === 403) {
                        const errorText = await response.text();
                        try {
                            const errorJson = JSON.parse(errorText);
                            showNotification(errorJson.message || 'Erro de autenticação. Faça login novamente.', 'error');
                        } catch {
                            showNotification('Sessão expirada. Faça login novamente.', 'error');
                        }
                        // Redirecionar para login se token inválido/expirado
                        if (response.status === 401) {
                            setTimeout(() => { window.location.href = '/login.html'; }, 2000);
                        }
                        return;
                    }
                    const error = await response.json();
                    showNotification(error.message || 'Erro ao salvar item', 'error');
                }
            } catch (error) {
                console.error('Erro ao salvar item:', error);
                showNotification('Erro de conexão ao salvar item', 'error');
            }
        }

        // Excluir item selecionado
        async function excluirItemSelecionado() {
            if (itemSelecionadoIdx === null || !itemSelecionado) {
                showNotification('Selecione um item na tabela para excluir', 'warning');
                return;
            }
            
            const confirmar = confirm(`Deseja realmente excluir o item "${itemSelecionado.codigo}"?\n\nEsta ação não pode ser desfeita.`);
            if (!confirmar) return;
            
            const token = localStorage.getItem('token');
            
            try {
                const response = await fetch(`/api/vendas/pedidos/${pedidoAtual.id}/itens/${itemSelecionado.id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` },
                    credentials: 'include'
                });
                
                if (response.ok || response.status === 204) {
                    showNotification('Item excluído com sucesso!', 'success');
                    itemSelecionado = null;
                    itemSelecionadoIdx = null;
                    // Recarregar itens
                    await carregarItensPedido(pedidoAtual.id);
                    // Atualizar total no modal
                    atualizarTotalModalEditar();
                } else {
                    const error = await response.json();
                    showNotification(error.message || 'Erro ao excluir item', 'error');
                }
            } catch (error) {
                console.error('Erro ao excluir item:', error);
                showNotification('Erro de conexão ao excluir item', 'error');
            }
        }

        // Atualizar totais no modal de editar
        function atualizarTotalModalEditar() {
            const totalItens = itensPedidoAtual.reduce((sum, item) => {
                return sum + ((parseFloat(item.quantidade) || 0) * (parseFloat(item.preco_unitario) || 0) - (parseFloat(item.desconto) || 0));
            }, 0);
            
            const valorTotalInput = document.getElementById('edit-valor-total');
            const totalMercadoriasInput = document.getElementById('edit-total-mercadorias');
            
            if (valorTotalInput) valorTotalInput.value = formatarMoeda(totalItens);
            if (totalMercadoriasInput) totalMercadoriasInput.value = formatarMoeda(totalItens);
            
            // Atualizar o valor no pedidoAtual
            if (pedidoAtual) {
                pedidoAtual.valor = totalItens;
            }
        }

        // Fechar modal de item ao clicar fora
        document.addEventListener('DOMContentLoaded', function() {
            const modalItemPedido = document.getElementById('modal-item-pedido');
            if (modalItemPedido) {
                modalItemPedido.addEventListener('click', function(e) {
                    if (e.target === this) fecharModalItemPedido();
                });
            }
        });
        
        function excluirPedido() {
            if (!pedidoAtual) {
                showNotification('Nenhum pedido selecionado', 'error');
                return;
            }
            
            const confirmar = confirm(`Tem certeza que deseja excluir o Orçamento Nº ${pedidoAtual.id}?\n\nEsta ação não pode ser desfeita.`);
            if (!confirmar) return;
            
            // Remover da lista
            const coluna = pedidoAtual._coluna;
            const idx = dadosVendas[coluna].findIndex(p => p.id === pedidoAtual.id);
            if (idx !== -1) {
                dadosVendas[coluna].splice(idx, 1);
            }
            
            // Re-renderizar kanban
            renderKanban();
            
            // Fechar modal e notificar
            fecharModalEditar();
            showNotification('Pedido excluído com sucesso!', 'success');
            
            // TODO: Excluir no backend via API
            // excluirPedidoAPI(pedidoAtual.id);
        }
        
        // Fechar modal ao clicar fora
        document.getElementById('modal-editar-pedido').addEventListener('click', function(e) {
            if (e.target === this) {
                fecharModalEditar();
            }
        });
        
        // Fechar modal com ESC
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                fecharModalEditar();
            }
        });

        // ========================================
        // AÇÕES - NOVO ORÇAMENTO (MODAL PROFISSIONAL)
        // ========================================
        
        // Dados temporários dos itens do orçamento
        let itensOrcamento = [];
        let clienteSelecionadoId = null;
        let vendedoresLista = [];
        
        // ========================================
        // AUTOCOMPLETE DE CLIENTES/EMPRESAS
        // ========================================
        let debounceTimerCliente = null;
        
        document.getElementById('novo-cliente').addEventListener('input', function(e) {
            const query = e.target.value.trim();
            
            // Limpar timer anterior
            if (debounceTimerCliente) clearTimeout(debounceTimerCliente);
            
            if (query.length < 1) {
                document.getElementById('dropdown-clientes').style.display = 'none';
                return;
            }
            
            // Aguardar 300ms antes de buscar
            debounceTimerCliente = setTimeout(() => buscarClientesAPI(query), 300);
        });
        
        async function buscarClientesAPI(query) {
            try {
                const resp = await fetch(`/api/vendas/empresas/search?q=${encodeURIComponent(query)}`, { credentials: 'include' });
                if (!resp.ok) throw new Error('Erro na busca');
                
                const empresas = await resp.json();
                const dropdown = document.getElementById('dropdown-clientes');
                
                if (empresas.length === 0) {
                    dropdown.innerHTML = '<div style="padding: 12px; color: #999; text-align: center;">Nenhuma empresa encontrada</div>';
                } else {
                    dropdown.innerHTML = empresas.map(emp => `
                        <div class="dropdown-item" onclick="selecionarCliente(${emp.id}, '${emp.nome_fantasia.replace(/'/g, "\\'")}', '${emp.cnpj || ''}')" 
                             style="padding: 10px 12px; cursor: pointer; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;"
                             onmouseover="this.style.background='#f5f5f5'" onmouseout="this.style.background='#fff'">
                            <span style="font-weight: 500;">${emp.nome_fantasia}</span>
                            <span style="font-size: 11px; color: #888;">${emp.cnpj || ''}</span>
                        </div>
                    `).join('');
                }
                
                dropdown.style.display = 'block';
            } catch (err) {
                console.error('Erro ao buscar clientes:', err);
            }
        }
        
        function selecionarCliente(id, nome, cnpj) {
            document.getElementById('novo-cliente').value = nome;
            document.getElementById('novo-cliente-id').value = id;
            clienteSelecionadoId = id;
            document.getElementById('dropdown-clientes').style.display = 'none';
            
            // Atualizar avatar com primeira letra
            const avatar = document.querySelector('.orcamento-cliente-avatar i');
            if (avatar) {
                avatar.className = 'fas fa-building';
                avatar.style.color = '#f97316';
            }
        }
        
        function buscarClientes() {
            const query = document.getElementById('novo-cliente').value.trim();
            if (query.length >= 1) {
                buscarClientesAPI(query);
            } else {
                buscarClientesAPI(''); // Buscar todos
            }
        }
        
        function consultarCredito() {
            if (!clienteSelecionadoId) {
                showToast('Selecione um cliente primeiro', 'warning');
                return;
            }
            showToast('Consulta de crédito em desenvolvimento', 'info');
        }
        
        // Fechar dropdown ao clicar fora
        document.addEventListener('click', function(e) {
            const dropdown = document.getElementById('dropdown-clientes');
            const input = document.getElementById('novo-cliente');
            if (!dropdown.contains(e.target) && e.target !== input) {
                dropdown.style.display = 'none';
            }
            
            const dropdownVend = document.getElementById('dropdown-vendedores');
            const inputVend = document.getElementById('novo-vendedor');
            if (dropdownVend && !dropdownVend.contains(e.target) && e.target !== inputVend && !e.target.closest('.btn-input-action')) {
                dropdownVend.style.display = 'none';
            }
        });
        
        // ========================================
        // DROPDOWN DE VENDEDORES
        // ========================================
        async function carregarVendedores() {
            try {
                const resp = await fetch('/api/vendas/vendedores', { credentials: 'include' });
                if (resp.ok) {
                    vendedoresLista = await resp.json();
                }
            } catch (err) {
                console.error('Erro ao carregar vendedores:', err);
            }
        }
        
        function toggleDropdownVendedores() {
            const dropdown = document.getElementById('dropdown-vendedores');
            
            if (dropdown.style.display === 'block') {
                dropdown.style.display = 'none';
                return;
            }
            
            // Renderizar lista
            if (vendedoresLista.length === 0) {
                dropdown.innerHTML = '<div style="padding: 12px; color: #999; text-align: center;">Carregando...</div>';
                carregarVendedores().then(() => renderDropdownVendedores());
            } else {
                renderDropdownVendedores();
            }
            
            dropdown.style.display = 'block';
        }
        
        function renderDropdownVendedores() {
            const dropdown = document.getElementById('dropdown-vendedores');
            const vendedorAtualId = document.getElementById('novo-vendedor-id').value;
            
            dropdown.innerHTML = vendedoresLista.map(v => `
                <div class="dropdown-item ${v.id == vendedorAtualId ? 'selected' : ''}" 
                     onclick="selecionarVendedorOrcamento(${v.id}, '${v.nome.replace(/'/g, "\\'")}')"
                     style="padding: 10px 12px; cursor: pointer; border-bottom: 1px solid #eee; ${v.id == vendedorAtualId ? 'background: #fff7ed;' : ''}"
                     onmouseover="this.style.background='#f5f5f5'" onmouseout="this.style.background='${v.id == vendedorAtualId ? '#fff7ed' : '#fff'}'">
                    <i class="fas fa-user" style="color: #f97316; margin-right: 8px;"></i>
                    ${v.nome}
                </div>
            `).join('');
        }
        
        function selecionarVendedorOrcamento(id, nome) {
            document.getElementById('novo-vendedor').value = nome;
            document.getElementById('novo-vendedor-id').value = id;
            document.getElementById('dropdown-vendedores').style.display = 'none';
        }
        
        // ========================================
        // FUNÇÕES DO CENÁRIO FISCAL E IMPOSTOS
        // ========================================
        
        // Variável para armazenar os dados de impostos calculados
        let impostosCalculados = null;
        
        // Cenários fiscais padrão (fallback)
        const cenariosFiscais = {
            venda_normal: {
                codigo: 'venda_normal',
                nome: 'Venda Normal (Dentro do Estado)',
                icms_aliquota: 18.00,
                icms_reducao_base: 0,
                icms_st_aliquota: 0,
                icms_st_mva: 0,
                ipi_aliquota: 0,
                pis_aliquota: 1.65,
                cofins_aliquota: 7.60,
                iss_aliquota: 0,
                cst_icms: '00',
                cst_ipi: '50',
                cst_pis: '01',
                cst_cofins: '01',
                calcula_icms_st: false,
                destaca_impostos: true
            },
            venda_fora_estado: {
                codigo: 'venda_fora_estado',
                nome: 'Venda Fora do Estado',
                icms_aliquota: 12.00,
                icms_reducao_base: 0,
                icms_st_aliquota: 0,
                icms_st_mva: 0,
                ipi_aliquota: 0,
                pis_aliquota: 1.65,
                cofins_aliquota: 7.60,
                iss_aliquota: 0,
                cst_icms: '00',
                cst_ipi: '50',
                cst_pis: '01',
                cst_cofins: '01',
                calcula_icms_st: false,
                destaca_impostos: true
            },
            venda_zona_franca: {
                codigo: 'venda_zona_franca',
                nome: 'Venda Zona Franca',
                icms_aliquota: 0,
                icms_reducao_base: 0,
                icms_st_aliquota: 0,
                icms_st_mva: 0,
                ipi_aliquota: 0,
                pis_aliquota: 1.65,
                cofins_aliquota: 7.60,
                iss_aliquota: 0,
                cst_icms: '40',
                cst_ipi: '52',
                cst_pis: '01',
                cst_cofins: '01',
                calcula_icms_st: false,
                destaca_impostos: true
            },
            exportacao: {
                codigo: 'exportacao',
                nome: 'Exportação',
                icms_aliquota: 0,
                icms_reducao_base: 0,
                icms_st_aliquota: 0,
                icms_st_mva: 0,
                ipi_aliquota: 0,
                pis_aliquota: 0,
                cofins_aliquota: 0,
                iss_aliquota: 0,
                cst_icms: '41',
                cst_ipi: '52',
                cst_pis: '08',
                cst_cofins: '08',
                calcula_icms_st: false,
                destaca_impostos: false
            },
            simples_nacional: {
                codigo: 'simples_nacional',
                nome: 'Simples Nacional',
                icms_aliquota: 0,
                icms_reducao_base: 0,
                icms_st_aliquota: 0,
                icms_st_mva: 0,
                ipi_aliquota: 0,
                pis_aliquota: 0,
                cofins_aliquota: 0,
                iss_aliquota: 0,
                cst_icms: '102',
                cst_ipi: '53',
                cst_pis: '49',
                cst_cofins: '49',
                calcula_icms_st: false,
                destaca_impostos: false
            },
            industrializacao: {
                codigo: 'industrializacao',
                nome: 'Industrialização (com IPI)',
                icms_aliquota: 18.00,
                icms_reducao_base: 0,
                icms_st_aliquota: 0,
                icms_st_mva: 0,
                ipi_aliquota: 5.00,
                pis_aliquota: 1.65,
                cofins_aliquota: 7.60,
                iss_aliquota: 0,
                cst_icms: '00',
                cst_ipi: '50',
                cst_pis: '01',
                cst_cofins: '01',
                calcula_icms_st: false,
                destaca_impostos: true
            },
            revenda: {
                codigo: 'revenda',
                nome: 'Revenda de Mercadorias',
                icms_aliquota: 18.00,
                icms_reducao_base: 0,
                icms_st_aliquota: 0,
                icms_st_mva: 0,
                ipi_aliquota: 0,
                pis_aliquota: 1.65,
                cofins_aliquota: 7.60,
                iss_aliquota: 0,
                cst_icms: '00',
                cst_ipi: '53',
                cst_pis: '01',
                cst_cofins: '01',
                calcula_icms_st: false,
                destaca_impostos: true
            }
        };
        
        function aplicarCenarioFiscal() {
            const cenario = document.getElementById('novo-cenario-fiscal').value;
            
            if (!cenario) return;
            
            // Também atualizar o select na aba de impostos
            const selectImpostos = document.getElementById('impostos-cenario-fiscal');
            if (selectImpostos && selectImpostos.value !== cenario) {
                selectImpostos.value = cenario;
            }
            
            // Carregar configurações do cenário
            carregarCenarioFiscal();
            
            showToast(`Cenário fiscal aplicado: ${cenario.replace(/_/g, ' ')}`, 'info');
            calcularTotaisOrcamento();
        }
        
        // Carregar cenário fiscal e preencher campos de impostos
        async function carregarCenarioFiscal() {
            const cenarioCodigo = document.getElementById('impostos-cenario-fiscal')?.value || 
                                  document.getElementById('novo-cenario-fiscal')?.value;
            
            if (!cenarioCodigo) return;
            
            let cenario = cenariosFiscais[cenarioCodigo];
            
            // Tentar buscar do servidor
            try {
                const response = await fetch(`/api/vendas/impostos/cenarios/${cenarioCodigo}`, {
                    credentials: 'include'
                });
                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.cenario) {
                        cenario = data.cenario;
                    }
                }
            } catch (error) {
                console.log('Usando cenário fiscal local');
            }
            
            if (!cenario) return;
            
            // Preencher campos de ICMS
            const icmsCst = document.getElementById('impostos-icms-cst');
            const icmsAliquota = document.getElementById('impostos-icms-aliquota');
            const icmsReducao = document.getElementById('impostos-icms-reducao');
            
            if (icmsCst) icmsCst.value = cenario.cst_icms || '00';
            if (icmsAliquota) icmsAliquota.value = formatarNumero(cenario.icms_aliquota || 0);
            if (icmsReducao) icmsReducao.value = formatarNumero(cenario.icms_reducao_base || 0);
            
            // Preencher campos de ICMS ST
            const icmsStAliquota = document.getElementById('impostos-icms-st-aliquota');
            const icmsStMva = document.getElementById('impostos-icms-st-mva');
            const icmsStAtivo = document.getElementById('impostos-icms-st-ativo');
            
            if (icmsStAtivo) {
                icmsStAtivo.checked = cenario.calcula_icms_st || cenario.icms_st_aliquota > 0;
                toggleICMSST();
            }
            if (icmsStAliquota) icmsStAliquota.value = formatarNumero(cenario.icms_st_aliquota || 0);
            if (icmsStMva) icmsStMva.value = formatarNumero(cenario.icms_st_mva || 0);
            
            // Preencher campos de IPI
            const ipiCst = document.getElementById('impostos-ipi-cst');
            const ipiAliquota = document.getElementById('impostos-ipi-aliquota');
            const ipiAtivo = document.getElementById('impostos-ipi-ativo');
            
            if (ipiAtivo) {
                ipiAtivo.checked = cenario.ipi_aliquota > 0;
                toggleIPI();
            }
            if (ipiCst) ipiCst.value = cenario.cst_ipi || '50';
            if (ipiAliquota) ipiAliquota.value = formatarNumero(cenario.ipi_aliquota || 0);
            
            // Preencher campos de PIS
            const pisCst = document.getElementById('impostos-pis-cst');
            const pisAliquota = document.getElementById('impostos-pis-aliquota');
            
            if (pisCst) pisCst.value = cenario.cst_pis || '01';
            if (pisAliquota) pisAliquota.value = formatarNumero(cenario.pis_aliquota || 0);
            
            // Preencher campos de COFINS
            const cofinsCst = document.getElementById('impostos-cofins-cst');
            const cofinsAliquota = document.getElementById('impostos-cofins-aliquota');
            
            if (cofinsCst) cofinsCst.value = cenario.cst_cofins || '01';
            if (cofinsAliquota) cofinsAliquota.value = formatarNumero(cenario.cofins_aliquota || 0);
            
            // Preencher campos de ISS
            const issAliquota = document.getElementById('impostos-iss-aliquota');
            const issAtivo = document.getElementById('impostos-iss-ativo');
            
            if (issAtivo) {
                issAtivo.checked = cenario.iss_aliquota > 0;
                toggleISS();
            }
            if (issAliquota) issAliquota.value = formatarNumero(cenario.iss_aliquota || 0);
            
            // Destacar impostos
            const destacar = document.getElementById('impostos-destacar-nf');
            if (destacar) destacar.checked = cenario.destaca_impostos !== false;
            
            // Sincronizar com o select principal
            const selectPrincipal = document.getElementById('novo-cenario-fiscal');
            if (selectPrincipal && selectPrincipal.value !== cenarioCodigo) {
                selectPrincipal.value = cenarioCodigo;
            }
            
            // Calcular impostos automaticamente
            calcularImpostos();
        }
        
        // Toggle ICMS ST
        function toggleICMSST() {
            const ativo = document.getElementById('impostos-icms-st-ativo')?.checked || false;
            const aliquota = document.getElementById('impostos-icms-st-aliquota');
            const mva = document.getElementById('impostos-icms-st-mva');
            
            if (aliquota) aliquota.disabled = !ativo;
            if (mva) mva.disabled = !ativo;
            
            if (!ativo) {
                if (aliquota) aliquota.value = '0,00';
                if (mva) mva.value = '0,00';
            }
        }
        
        // Toggle IPI
        function toggleIPI() {
            const ativo = document.getElementById('impostos-ipi-ativo')?.checked || false;
            const cst = document.getElementById('impostos-ipi-cst');
            const aliquota = document.getElementById('impostos-ipi-aliquota');
            
            if (cst) cst.disabled = !ativo;
            if (aliquota) aliquota.disabled = !ativo;
            
            if (!ativo) {
                if (aliquota) aliquota.value = '0,00';
            }
        }
        
        // Toggle ISS
        function toggleISS() {
            const ativo = document.getElementById('impostos-iss-ativo')?.checked || false;
            const aliquota = document.getElementById('impostos-iss-aliquota');
            
            if (aliquota) aliquota.disabled = !ativo;
            
            if (!ativo) {
                if (aliquota) aliquota.value = '0,00';
            }
        }
        
        // Função utilitária para formatar número
        function formatarNumero(valor, decimais = 2) {
            return parseFloat(valor || 0).toFixed(decimais).replace('.', ',');
        }
        
        // Função utilitária para parsear número brasileiro
        function parsearNumero(str) {
            if (!str) return 0;
            return parseFloat(str.toString().replace(/\./g, '').replace(',', '.')) || 0;
        }
        
        // Calcular impostos
        async function calcularImpostos() {
            // Obter valores
            const valorProdutos = parsearNumero(document.getElementById('novo-total-mercadorias')?.value || '0');
            const valorDesconto = parsearNumero(document.getElementById('novo-desconto')?.value || '0');
            const valorFrete = parsearNumero(document.getElementById('novo-frete')?.value || '0');
            const valorSeguro = parsearNumero(document.getElementById('novo-seguro')?.value || '0');
            const outrasDespesas = parsearNumero(document.getElementById('novo-outras-despesas')?.value || '0');
            
            // Obter alíquotas dos campos
            const icmsAliquota = parsearNumero(document.getElementById('impostos-icms-aliquota')?.value || '0');
            const icmsReducao = parsearNumero(document.getElementById('impostos-icms-reducao')?.value || '0');
            const icmsStAliquota = parsearNumero(document.getElementById('impostos-icms-st-aliquota')?.value || '0');
            const icmsStMva = parsearNumero(document.getElementById('impostos-icms-st-mva')?.value || '0');
            const ipiAliquota = parsearNumero(document.getElementById('impostos-ipi-aliquota')?.value || '0');
            const pisAliquota = parsearNumero(document.getElementById('impostos-pis-aliquota')?.value || '0');
            const cofinsAliquota = parsearNumero(document.getElementById('impostos-cofins-aliquota')?.value || '0');
            const issAliquota = parsearNumero(document.getElementById('impostos-iss-aliquota')?.value || '0');
            
            const cenarioCodigo = document.getElementById('impostos-cenario-fiscal')?.value || 'venda_normal';
            
            // Calcular localmente para atualização imediata
            let baseICMS = valorProdutos - valorDesconto;
            if (icmsReducao > 0) {
                baseICMS = baseICMS * (1 - icmsReducao / 100);
            }
            
            const baseIPI = valorProdutos;
            const valorIPI = ipiAliquota > 0 ? baseIPI * (ipiAliquota / 100) : 0;
            const valorICMS = icmsAliquota > 0 ? baseICMS * (icmsAliquota / 100) : 0;
            
            let baseICMSST = 0;
            let valorICMSST = 0;
            if (icmsStAliquota > 0 && icmsStMva > 0) {
                baseICMSST = (valorProdutos + valorIPI) * (1 + icmsStMva / 100);
                valorICMSST = (baseICMSST * (icmsStAliquota / 100)) - valorICMS;
                if (valorICMSST < 0) valorICMSST = 0;
            }
            
            const basePISCOFINS = valorProdutos - valorDesconto + valorFrete + valorSeguro + outrasDespesas;
            const valorPIS = pisAliquota > 0 ? basePISCOFINS * (pisAliquota / 100) : 0;
            const valorCOFINS = cofinsAliquota > 0 ? basePISCOFINS * (cofinsAliquota / 100) : 0;
            
            const baseISS = valorProdutos - valorDesconto;
            const valorISS = issAliquota > 0 ? baseISS * (issAliquota / 100) : 0;
            
            const totalImpostos = valorICMS + valorICMSST + valorIPI + valorPIS + valorCOFINS + valorISS;
            const totalNF = valorProdutos + valorIPI + valorICMSST + valorFrete + valorSeguro + outrasDespesas - valorDesconto;
            
            // Armazenar resultados
            impostosCalculados = {
                cenario_codigo: cenarioCodigo,
                bases: {
                    icms: baseICMS,
                    icms_st: baseICMSST,
                    ipi: baseIPI,
                    pis: basePISCOFINS,
                    cofins: basePISCOFINS,
                    iss: baseISS
                },
                valores: {
                    icms: valorICMS,
                    icms_st: valorICMSST,
                    ipi: valorIPI,
                    pis: valorPIS,
                    cofins: valorCOFINS,
                    iss: valorISS
                },
                totais: {
                    produtos: valorProdutos,
                    desconto: valorDesconto,
                    frete: valorFrete,
                    seguro: valorSeguro,
                    outras_despesas: outrasDespesas,
                    impostos: totalImpostos,
                    nota_fiscal: totalNF
                }
            };
            
            // Atualizar campos na interface
            atualizarCamposImpostos();
            
            showToast('Impostos calculados com sucesso!', 'success');
        }
        
        // Atualizar quando alíquotas mudam
        function atualizarImpostos() {
            // Recalcular sem mostrar toast
            calcularImpostosSilencioso();
        }
        
        function calcularImpostosSilencioso() {
            // Mesma lógica do calcularImpostos, mas sem toast
            const valorProdutos = parsearNumero(document.getElementById('novo-total-mercadorias')?.value || '0');
            const valorDesconto = parsearNumero(document.getElementById('novo-desconto')?.value || '0');
            const valorFrete = parsearNumero(document.getElementById('novo-frete')?.value || '0');
            const valorSeguro = parsearNumero(document.getElementById('novo-seguro')?.value || '0');
            const outrasDespesas = parsearNumero(document.getElementById('novo-outras-despesas')?.value || '0');
            
            const icmsAliquota = parsearNumero(document.getElementById('impostos-icms-aliquota')?.value || '0');
            const icmsReducao = parsearNumero(document.getElementById('impostos-icms-reducao')?.value || '0');
            const icmsStAliquota = parsearNumero(document.getElementById('impostos-icms-st-aliquota')?.value || '0');
            const icmsStMva = parsearNumero(document.getElementById('impostos-icms-st-mva')?.value || '0');
            const ipiAliquota = parsearNumero(document.getElementById('impostos-ipi-aliquota')?.value || '0');
            const pisAliquota = parsearNumero(document.getElementById('impostos-pis-aliquota')?.value || '0');
            const cofinsAliquota = parsearNumero(document.getElementById('impostos-cofins-aliquota')?.value || '0');
            const issAliquota = parsearNumero(document.getElementById('impostos-iss-aliquota')?.value || '0');
            
            let baseICMS = valorProdutos - valorDesconto;
            if (icmsReducao > 0) {
                baseICMS = baseICMS * (1 - icmsReducao / 100);
            }
            
            const baseIPI = valorProdutos;
            const valorIPI = ipiAliquota > 0 ? baseIPI * (ipiAliquota / 100) : 0;
            const valorICMS = icmsAliquota > 0 ? baseICMS * (icmsAliquota / 100) : 0;
            
            let baseICMSST = 0;
            let valorICMSST = 0;
            if (icmsStAliquota > 0 && icmsStMva > 0) {
                baseICMSST = (valorProdutos + valorIPI) * (1 + icmsStMva / 100);
                valorICMSST = (baseICMSST * (icmsStAliquota / 100)) - valorICMS;
                if (valorICMSST < 0) valorICMSST = 0;
            }
            
            const basePISCOFINS = valorProdutos - valorDesconto + valorFrete + valorSeguro + outrasDespesas;
            const valorPIS = pisAliquota > 0 ? basePISCOFINS * (pisAliquota / 100) : 0;
            const valorCOFINS = cofinsAliquota > 0 ? basePISCOFINS * (cofinsAliquota / 100) : 0;
            
            const baseISS = valorProdutos - valorDesconto;
            const valorISS = issAliquota > 0 ? baseISS * (issAliquota / 100) : 0;
            
            const totalImpostos = valorICMS + valorICMSST + valorIPI + valorPIS + valorCOFINS + valorISS;
            const totalNF = valorProdutos + valorIPI + valorICMSST + valorFrete + valorSeguro + outrasDespesas - valorDesconto;
            
            impostosCalculados = {
                cenario_codigo: document.getElementById('impostos-cenario-fiscal')?.value || 'venda_normal',
                bases: { icms: baseICMS, icms_st: baseICMSST, ipi: baseIPI, pis: basePISCOFINS, cofins: basePISCOFINS, iss: baseISS },
                valores: { icms: valorICMS, icms_st: valorICMSST, ipi: valorIPI, pis: valorPIS, cofins: valorCOFINS, iss: valorISS },
                totais: { produtos: valorProdutos, desconto: valorDesconto, frete: valorFrete, seguro: valorSeguro, outras_despesas: outrasDespesas, impostos: totalImpostos, nota_fiscal: totalNF }
            };
            
            atualizarCamposImpostos();
        }
        
        // Atualizar campos visuais dos impostos
        function atualizarCamposImpostos() {
            if (!impostosCalculados) return;
            
            // ICMS
            const icmsBase = document.getElementById('impostos-icms-base');
            const icmsValor = document.getElementById('impostos-icms-valor');
            if (icmsBase) icmsBase.value = formatarNumero(impostosCalculados.bases.icms);
            if (icmsValor) icmsValor.value = formatarNumero(impostosCalculados.valores.icms);
            
            // ICMS ST
            const icmsStBase = document.getElementById('impostos-icms-st-base');
            const icmsStValor = document.getElementById('impostos-icms-st-valor');
            if (icmsStBase) icmsStBase.value = formatarNumero(impostosCalculados.bases.icms_st);
            if (icmsStValor) icmsStValor.value = formatarNumero(impostosCalculados.valores.icms_st);
            
            // IPI
            const ipiBase = document.getElementById('impostos-ipi-base');
            const ipiValor = document.getElementById('impostos-ipi-valor');
            if (ipiBase) ipiBase.value = formatarNumero(impostosCalculados.bases.ipi);
            if (ipiValor) ipiValor.value = formatarNumero(impostosCalculados.valores.ipi);
            
            // PIS
            const pisBase = document.getElementById('impostos-pis-base');
            const pisValor = document.getElementById('impostos-pis-valor');
            if (pisBase) pisBase.value = formatarNumero(impostosCalculados.bases.pis);
            if (pisValor) pisValor.value = formatarNumero(impostosCalculados.valores.pis);
            
            // COFINS
            const cofinsBase = document.getElementById('impostos-cofins-base');
            const cofinsValor = document.getElementById('impostos-cofins-valor');
            if (cofinsBase) cofinsBase.value = formatarNumero(impostosCalculados.bases.cofins);
            if (cofinsValor) cofinsValor.value = formatarNumero(impostosCalculados.valores.cofins);
            
            // ISS
            const issBase = document.getElementById('impostos-iss-base');
            const issValor = document.getElementById('impostos-iss-valor');
            if (issBase) issBase.value = formatarNumero(impostosCalculados.bases.iss);
            if (issValor) issValor.value = formatarNumero(impostosCalculados.valores.iss);
            
            // Resumo
            const totalProdutos = document.getElementById('impostos-total-produtos');
            const totalImpostos = document.getElementById('impostos-total-impostos');
            const totalFrete = document.getElementById('impostos-total-frete');
            const totalNf = document.getElementById('impostos-total-nf');
            
            if (totalProdutos) totalProdutos.textContent = `R$ ${formatarNumero(impostosCalculados.totais.produtos)}`;
            if (totalImpostos) totalImpostos.textContent = `R$ ${formatarNumero(impostosCalculados.totais.impostos)}`;
            if (totalFrete) totalFrete.textContent = `R$ ${formatarNumero(impostosCalculados.totais.frete + impostosCalculados.totais.outras_despesas)}`;
            if (totalNf) totalNf.textContent = `R$ ${formatarNumero(impostosCalculados.totais.nota_fiscal)}`;
            
            // Atualizar campos de totais no cabeçalho do modal
            const totalIpiHeader = document.getElementById('novo-total-ipi');
            const totalIcmsHeader = document.getElementById('novo-total-icms');
            
            if (totalIpiHeader) totalIpiHeader.value = formatarNumero(impostosCalculados.valores.ipi);
            if (totalIcmsHeader) totalIcmsHeader.value = formatarNumero(impostosCalculados.valores.icms_st);
        }
        
        // ========================================
        // FUNÇÕES DE PARCELAS
        // ========================================
        function sincronizarParcelasAba() {
            const parcelas = document.getElementById('novo-parcelas').value;
            const selectQtd = document.getElementById('novo-qtd-parcelas');
            
            const parcelasMap = {
                'a_vista': '1',
                '30': '1',
                '30_60': '2',
                '30_60_90': '3',
                'personalizado': '1'
            };
            
            if (selectQtd && parcelasMap[parcelas]) {
                selectQtd.value = parcelasMap[parcelas];
                gerarTabelaParcelas();
            }
        }
        
        function novoOrcamento() {
            // Usar o mesmo modal de Novo Pedido
            abrirModalNovoPedido();
        }
        
        function fecharModalNovoOrcamento() {
            if (temAlteracoesNaoSalvas()) {
                mostrarConfirmacaoAlteracoes(() => {
                    document.getElementById('modal-novo-orcamento').classList.remove('active');
                });
            } else {
                document.getElementById('modal-novo-orcamento').classList.remove('active');
            }
        }
        
        // Sistema de Abas do Orçamento
        function ativarAbaOrcamento(tabId) {
            // Desativar todas as abas
            document.querySelectorAll('.orcamento-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.orcamento-tab-content').forEach(content => content.classList.remove('active'));
            
            // Ativar aba selecionada
            document.querySelector(`.orcamento-tab[data-tab="${tabId}"]`).classList.add('active');
            document.getElementById(`tab-${tabId}`).classList.add('active');
        }
        
        // Inicializar eventos das abas
        document.querySelectorAll('.orcamento-tab').forEach(tab => {
            tab.addEventListener('click', function() {
                ativarAbaOrcamento(this.dataset.tab);
            });
        });
        
        // Renderizar tabela de itens
        function renderTabelaItens() {
            const tbody = document.getElementById('tbody-itens-orcamento');
            const emptyState = document.getElementById('empty-itens');
            const paginacao = document.querySelector('.paginacao-info');
            
            if (itensOrcamento.length === 0) {
                tbody.innerHTML = '';
                emptyState.style.display = 'flex';
                paginacao.textContent = 'Nenhum registro encontrado';
            } else {
                emptyState.style.display = 'none';
                paginacao.textContent = `1 a ${itensOrcamento.length} de ${itensOrcamento.length} registros`;
                
                tbody.innerHTML = itensOrcamento.map((item, idx) => `
                    <tr data-index="${idx}" onclick="selecionarItemOrcamento(${idx})">
                        <td class="produto-code">${item.codigo}</td>
                        <td class="produto-desc">${item.descricao}</td>
                        <td>${item.quantidade}</td>
                        <td>${item.qtdPendente || item.quantidade}</td>
                        <td>${item.localEstoque}</td>
                        <td>R$ ${item.precoUnitario.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</td>
                        <td>R$ ${(item.quantidade * item.precoUnitario).toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</td>
                    </tr>
                `).join('');
            }
            
            calcularTotaisOrcamento();
        }
        
        function selecionarItemOrcamento(idx) {
            document.querySelectorAll('.orcamento-tabela tbody tr').forEach(tr => tr.classList.remove('selected'));
            const row = document.querySelector(`.orcamento-tabela tbody tr[data-index="${idx}"]`);
            if (row) row.classList.add('selected');
        }
        
        // Calcular totais
        function calcularTotaisOrcamento() {
            const totalMercadorias = itensOrcamento.reduce((sum, item) => sum + (item.quantidade * item.precoUnitario), 0);
            const desconto = parseFloat(document.getElementById('novo-desconto').value.replace(',', '.')) || 0;
            const totalIpi = totalMercadorias * 0.05; // Exemplo: 5% de IPI
            const totalIcms = 0; // ICMS ST zerado por padrão
            const valorTotal = totalMercadorias - desconto + totalIpi + totalIcms;
            
            document.getElementById('novo-total-mercadorias').value = totalMercadorias.toLocaleString('pt-BR', { minimumFractionDigits: 2 });
            document.getElementById('novo-total-ipi').value = totalIpi.toLocaleString('pt-BR', { minimumFractionDigits: 2 });
            document.getElementById('novo-total-icms').value = totalIcms.toLocaleString('pt-BR', { minimumFractionDigits: 2 });
            document.getElementById('novo-valor-total').value = valorTotal.toLocaleString('pt-BR', { minimumFractionDigits: 2 });
        }
        
        // Modal Adicionar Item
        function adicionarItemOrcamento() {
            document.getElementById('item-produto').value = '';
            document.getElementById('item-quantidade').value = 1;
            document.getElementById('item-preco').value = '';
            document.getElementById('item-estoque').value = 'principal';
            document.getElementById('modal-adicionar-item').classList.add('active');
        }
        
        function fecharModalAdicionarItem() {
            document.getElementById('modal-adicionar-item').classList.remove('active');
        }
        
        function confirmarAdicionarItem() {
            const produto = document.getElementById('item-produto').value.trim();
            const quantidade = parseInt(document.getElementById('item-quantidade').value) || 1;
            const preco = parseFloat(document.getElementById('item-preco').value.replace(',', '.')) || 0;
            const estoque = document.getElementById('item-estoque').value;
            
            if (!produto) {
                showNotification('Por favor, informe o produto.', 'warning');
                return;
            }
            if (preco <= 0) {
                showNotification('Por favor, informe um preço válido.', 'warning');
                return;
            }
            
            const estoqueLabels = {
                'principal': 'Estoque Principal',
                'secundario': 'Estoque Secundário',
                'expedição': 'Expedição'
            };
            
            // Gerar código de produto
            const codigo = 'PROD' + String(Math.floor(Math.random() * 9000) + 1000);
            
            itensOrcamento.push({
                codigo: codigo,
                descricao: produto,
                quantidade: quantidade,
                qtdPendente: quantidade,
                localEstoque: estoqueLabels[estoque] || estoque,
                precoUnitario: preco
            });
            
            renderTabelaItens();
            fecharModalAdicionarItem();
            showNotification('Item adicionado ao orçamento!', 'success');
        }
        
        // Evento desconto
        document.getElementById('novo-desconto').addEventListener('input', calcularTotaisOrcamento);
        
        // ========================================
        // FUNÇÕES ADICIONAIS DO MODAL ORÇAMENTO (ESTILO OMIE)
        // ========================================
        
        // Refazer parcelas
        function refazerParcelas() {
            const valorTotal = parseFloat(document.getElementById('novo-valor-total')?.value?.replace('.', '').replace(',', '.')) || 0;
            const tbody = document.getElementById('tbody-parcelas');
            const emptyState = document.getElementById('empty-parcelas');
            
            if (valorTotal <= 0) {
                tbody.innerHTML = '';
                emptyState.style.display = 'block';
                document.getElementById('novo-valor-total-receber').value = '0,00';
                showNotification('Adicione itens ao pedido para gerar parcelas', 'warning');
                return;
            }
            
            emptyState.style.display = 'none';
            const dataVencimento = new Date();
            dataVencimento.setDate(dataVencimento.getDate() + 30);
            
            tbody.innerHTML = `
                <tr ondblclick="editarParcela(1)">
                    <td><span class="status-badge pendente" style="font-size: 11px; padding: 2px 8px;">Pendente</span></td>
                    <td>1/1</td>
                    <td>${dataVencimento.toLocaleDateString('pt-BR')}</td>
                    <td style="text-align: right;">R$ ${valorTotal.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
                    <td style="text-align: right;">100,00%</td>
                    <td>-</td>
                    <td>-</td>
                    <td><input type="checkbox" disabled></td>
                </tr>
            `;
            
            document.getElementById('novo-valor-total-receber').value = valorTotal.toLocaleString('pt-BR', {minimumFractionDigits: 2});
            showNotification('Parcelas recalculadas!', 'success');
        }
        
        // Editar parcela (duplo clique)
        function editarParcela(numeroParcela) {
            showNotification('Função de edição de parcela em desenvolvimento', 'info');
        }
        
        // Navegar para próximo orçamento
        function navegarProximoOrcamento() {
            showNotification('Navegação entre registros em desenvolvimento', 'info');
        }
        
        // Modais auxiliares do orçamento
        
        // === NFs RELACIONADAS ===
        let nfsRelacionadas = [];
        
        function abrirModalNFsRelacionadas() {
            document.getElementById('modal-nfs-relacionadas').classList.add('active');
        }
        
        function fecharModalNFsRelacionadas() {
            document.getElementById('modal-nfs-relacionadas').classList.remove('active');
        }
        
        function adicionarNFRelacionada() {
            const numero = document.getElementById('nf-relacionada-numero').value.trim();
            const serie = document.getElementById('nf-relacionada-serie').value.trim();
            const chave = document.getElementById('nf-relacionada-chave').value.trim();
            
            if (!numero || !chave) {
                showNotification('Preencha o número e a chave de acesso', 'error');
                return;
            }
            
            if (chave.length !== 44) {
                showNotification('A chave de acesso deve ter 44 dígitos', 'error');
                return;
            }
            
            nfsRelacionadas.push({ numero, serie, chave });
            renderizarNFsRelacionadas();
            
            document.getElementById('nf-relacionada-numero').value = '';
            document.getElementById('nf-relacionada-serie').value = '';
            document.getElementById('nf-relacionada-chave').value = '';
        }
        
        function renderizarNFsRelacionadas() {
            const lista = document.getElementById('nfs-relacionadas-lista');
            if (nfsRelacionadas.length === 0) {
                lista.innerHTML = `<tr><td colspan="4" style="padding: 30px; text-align: center; color: #999;"><i class="fas fa-file-invoice" style="font-size: 32px; margin-bottom: 8px; opacity: 0.5;"></i><p style="margin: 0;">Nenhuma NF relacionada</p></td></tr>`;
                return;
            }
            lista.innerHTML = nfsRelacionadas.map((nf, i) => `
                <tr style="border-bottom: 1px solid #e2e8f0;">
                    <td style="padding: 12px;">${nf.numero}</td>
                    <td style="padding: 12px;">${nf.serie || '-'}</td>
                    <td style="padding: 12px; font-family: monospace; font-size: 11px;">${nf.chave}</td>
                    <td style="padding: 12px; text-align: center;"><button onclick="removerNFRelacionada(${i})" style="background: #fee2e2; color: #ef4444; border: none; padding: 6px 10px; border-radius: 4px; cursor: pointer;"><i class="fas fa-trash"></i></button></td>
                </tr>
            `).join('');
        }
        
        function removerNFRelacionada(index) {
            nfsRelacionadas.splice(index, 1);
            renderizarNFsRelacionadas();
        }
        
        function salvarNFsRelacionadas() {
            showNotification(`${nfsRelacionadas.length} NF(s) relacionada(s) salva(s)`, 'success');
            fecharModalNFsRelacionadas();
        }
        
        // === INFO FISCO ===
        let infoFisco = '';
        
        function abrirModalInfoFisco() {
            document.getElementById('modal-info-fisco').classList.add('active');
            document.getElementById('info-fisco-texto').value = infoFisco;
        }
        
        function fecharModalInfoFisco() {
            document.getElementById('modal-info-fisco').classList.remove('active');
        }
        
        function salvarInfoFisco() {
            infoFisco = document.getElementById('info-fisco-texto').value;
            showNotification('Informações do fisco salvas', 'success');
            fecharModalInfoFisco();
        }
        
        // === CAMPOS OBS NF-e ===
        let camposObsNFe = [];
        
        function abrirModalCamposObsNFe() {
            document.getElementById('modal-campos-obs-nfe').classList.add('active');
            renderizarCamposObs();
        }
        
        function fecharModalCamposObsNFe() {
            document.getElementById('modal-campos-obs-nfe').classList.remove('active');
        }
        
        function adicionarCampoObs() {
            const campo = document.getElementById('obs-campo').value.trim();
            const valor = document.getElementById('obs-valor').value.trim();
            
            if (!campo || !valor) {
                showNotification('Preencha o nome do campo e o valor', 'error');
                return;
            }
            
            camposObsNFe.push({ campo, valor });
            renderizarCamposObs();
            
            document.getElementById('obs-campo').value = '';
            document.getElementById('obs-valor').value = '';
        }
        
        function renderizarCamposObs() {
            const lista = document.getElementById('campos-obs-lista');
            if (camposObsNFe.length === 0) {
                lista.innerHTML = `<div style="padding: 20px; text-align: center; color: #999; background: #f8fafc; border-radius: 8px;"><i class="fas fa-list" style="font-size: 24px; margin-bottom: 8px; opacity: 0.5;"></i><p style="margin: 0; font-size: 13px;">Nenhum campo adicional</p></div>`;
                return;
            }
            lista.innerHTML = camposObsNFe.map((obs, i) => `
                <div style="display: flex; align-items: center; gap: 12px; padding: 10px; background: #f8fafc; border-radius: 6px; margin-bottom: 8px;">
                    <strong style="min-width: 120px; color: #475569;">${obs.campo}:</strong>
                    <span style="flex: 1; color: #666;">${obs.valor}</span>
                    <button onclick="removerCampoObs(${i})" style="background: #fee2e2; color: #ef4444; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer;"><i class="fas fa-times"></i></button>
                </div>
            `).join('');
        }
        
        function removerCampoObs(index) {
            camposObsNFe.splice(index, 1);
            renderizarCamposObs();
        }
        
        function salvarCamposObsNFe() {
            showNotification(`${camposObsNFe.length} campo(s) adicional(is) salvo(s)`, 'success');
            fecharModalCamposObsNFe();
        }
        
        // === ENDEREÇO DE ENTREGA ===
        let enderecoEntrega = {};
        
        function abrirModalEnderecoEntrega() {
            document.getElementById('modal-endereco-entrega').classList.add('active');
        }
        
        function fecharModalEnderecoEntrega() {
            document.getElementById('modal-endereco-entrega').classList.remove('active');
        }
        
        function toggleEnderecoEntrega() {
            const usarMesmo = document.getElementById('usar-endereco-cliente').checked;
            document.getElementById('form-endereco-entrega').style.display = usarMesmo ? 'none' : 'block';
        }
        
        async function buscarCepEntrega() {
            const cep = document.getElementById('entrega-cep').value.replace(/\D/g, '');
            if (cep.length !== 8) return;
            
            try {
                const response = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
                const data = await response.json();
                if (!data.erro) {
                    document.getElementById('entrega-logradouro').value = data.logradouro || '';
                    document.getElementById('entrega-bairro').value = data.bairro || '';
                    document.getElementById('entrega-cidade').value = data.localidade || '';
                    document.getElementById('entrega-uf').value = data.uf || '';
                }
            } catch (e) {
                console.error('Erro ao buscar CEP:', e);
            }
        }
        
        function salvarEnderecoEntrega() {
            const usarMesmo = document.getElementById('usar-endereco-cliente').checked;
            if (!usarMesmo) {
                enderecoEntrega = {
                    cep: document.getElementById('entrega-cep').value,
                    logradouro: document.getElementById('entrega-logradouro').value,
                    numero: document.getElementById('entrega-numero').value,
                    complemento: document.getElementById('entrega-complemento').value,
                    bairro: document.getElementById('entrega-bairro').value,
                    cidade: document.getElementById('entrega-cidade').value,
                    uf: document.getElementById('entrega-uf').value
                };
            }
            showNotification('Endereço de entrega salvo', 'success');
            fecharModalEnderecoEntrega();
        }
        
        // === ICMS TRANSPORTE ===
        let icmsTransporte = {};
        
        function abrirModalICMSTransporte() {
            document.getElementById('modal-icms-transporte').classList.add('active');
        }
        
        function fecharModalICMSTransporte() {
            document.getElementById('modal-icms-transporte').classList.remove('active');
        }
        
        function salvarICMSTransporte() {
            icmsTransporte = {
                valorServico: document.getElementById('icms-valor-servico').value,
                baseCalculo: document.getElementById('icms-base-calculo').value,
                aliquota: document.getElementById('icms-aliquota').value,
                valorRetido: document.getElementById('icms-valor-retido').value,
                cfop: document.getElementById('icms-cfop').value,
                codMunicipio: document.getElementById('icms-cod-municipio').value
            };
            showNotification('ICMS Transporte salvo', 'success');
            fecharModalICMSTransporte();
        }
        
        // === AGROPECUÁRIA (placeholder) ===
        function abrirModalAgropecuaria() {
            showNotification('Modal de dados agropecuários disponível em breve', 'info');
        }
        
        // Verificar conta corrente para aba email
        function verificarContaCorrenteEmail() {
            const contaCorrente = document.getElementById('novo-conta-corrente')?.value;
            const aviso = document.getElementById('aviso-conta-corrente');
            
            if (aviso) {
                aviso.style.display = contaCorrente ? 'none' : 'block';
            }
        }
        
        // Event listener para conta corrente
        document.getElementById('novo-conta-corrente')?.addEventListener('change', verificarContaCorrenteEmail);
        
        // Abrir WhatsApp com dados do orçamento
        function abrirWhatsAppOrcamento() {
            const cliente = document.getElementById('novo-cliente')?.value || '';
            const valorTotal = document.getElementById('novo-valor-total')?.value || '0,00';
            
            const mensagem = encodeURIComponent(`Olá! Segue informações do orçamento:\n\nCliente: ${cliente}\nValor Total: R$ ${valorTotal}\n\nAgradecemos a preferência!`);
            window.open(`https://wa.me/?text=${mensagem}`, '_blank');
        }
        
        // Mostrar barra de informação do orçamento
        function mostrarInfoBarOrcamento(texto) {
            const bar = document.getElementById('orcamento-info-bar');
            const text = document.getElementById('orcamento-info-text');
            if (bar && text) {
                text.textContent = texto;
                bar.style.display = 'block';
            }
        }
        
        // Ocultar barra de informação
        function ocultarInfoBarOrcamento() {
            const bar = document.getElementById('orcamento-info-bar');
            if (bar) {
                bar.style.display = 'none';
            }
        }
        
        // Salvar Orçamento
        async function salvarNovoOrcamento() {
            const cliente = document.getElementById('novo-cliente').value.trim();
            const clienteId = document.getElementById('novo-cliente-id').value;
            const valorTotal = parseFloat(document.getElementById('novo-valor-total').value.replace('.', '').replace(',', '.')) || 0;
            const parcelas = document.getElementById('novo-parcelas').value;
            const vendedorId = document.getElementById('novo-vendedor-id').value;
            const vendedorNome = document.getElementById('novo-vendedor').value.trim();
            const transportadora = document.getElementById('novo-transportadora')?.value?.trim() || '';
            const observacoes = document.getElementById('novo-observacoes').value.trim();
            const cenarioFiscal = document.getElementById('novo-cenario-fiscal').value || document.getElementById('impostos-cenario-fiscal')?.value;
            const previsaoFaturamento = document.getElementById('novo-previsao-faturamento').value;
            const frete = parseFloat(document.getElementById('novo-frete')?.value?.replace(',', '.')) || 0;
            const departamento = document.getElementById('novo-departamento')?.value || '';
            
            // Validação
            if (!cliente) {
                showNotification('Por favor, informe o nome do cliente.', 'warning');
                document.getElementById('novo-cliente').focus();
                return;
            }
            if (!vendedorId) {
                showNotification('Por favor, selecione um vendedor.', 'warning');
                return;
            }
            if (itensOrcamento.length === 0) {
                showNotification('Adicione pelo menos um item ao orçamento.', 'warning');
                ativarAbaOrcamento('itens');
                return;
            }
            
            // Mapear parcelas
            const parcelasMap = {
                'a_vista': 'À Vista',
                '30': '30 dias',
                '30_60': '30/60 dias',
                '30_60_90': '30/60/90 dias',
                'personalizado': 'Personalizado'
            };
            
            // Calcular impostos se não foram calculados ainda
            if (!impostosCalculados) {
                calcularImpostosSilencioso();
            }
            
            try {
                // Salvar no backend via API
                const token = localStorage.getItem('token');
                const response = await fetch('/api/vendas/pedidos', {
                    method: 'POST',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': token ? `Bearer ${token}` : ''
                    },
                    body: JSON.stringify({
                        empresa_id: clienteId || null,
                        cliente_nome: cliente.toUpperCase(),
                        vendedor_id: vendedorId,
                        valor: valorTotal,
                        status: 'orcamento',
                        condicao_pagamento: parcelasMap[parcelas] || parcelas,
                        cenario_fiscal: cenarioFiscal,
                        previsao_faturamento: previsaoFaturamento,
                        frete: frete,
                        departamento: departamento,
                        observacoes: observacoes,
                        total_impostos: impostosCalculados?.totais?.impostos || 0,
                        itens: itensOrcamento.map(item => ({
                            codigo: item.codigo,
                            descricao: item.descricao,
                            quantidade: item.quantidade,
                            preco_unitario: item.precoUnitario,
                            unidade: item.unidade || 'UN',
                            local_estoque: item.localEstoque || 'PADRÃO'
                        }))
                    })
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'Erro ao salvar orçamento');
                }
                
                const novoOrc = await response.json();
                
                // Salvar impostos do pedido se houver dados calculados
                if (impostosCalculados && novoOrc.id) {
                    try {
                        await fetch(`/api/vendas/pedidos/${novoOrc.id}/impostos`, {
                            method: 'POST',
                            credentials: 'include',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': token ? `Bearer ${token}` : ''
                            },
                            body: JSON.stringify({
                                impostos: impostosCalculados,
                                cenario_codigo: cenarioFiscal
                            })
                        });
                    } catch (impError) {
                        console.log('Impostos salvos localmente, tabela não disponível:', impError.message);
                    }
                }
                
                // Adicionar na coluna de orçamento para visualização imediata
                const pedidoLocal = {
                    id: novoOrc.id || novoOrc.insertId,
                    cliente: cliente.toUpperCase(),
                    status: 'Aguardando aprovação',
                    valor: valorTotal,
                    parcelas: parcelasMap[parcelas] || parcelas,
                    origem: 'Sistema',
                    vendedor: vendedorNome,
                    vendedor_id: vendedorId,
                    transportadora: transportadora || null,
                    mensagem: observacoes || null,
                    itens: [...itensOrcamento],
                    impostos: impostosCalculados
                };
                
                dadosVendas.orcamento.unshift(pedidoLocal);
                
                // Re-renderizar kanban
                renderKanban();
                
                // Fechar modal e notificar
                document.getElementById('modal-novo-orcamento').classList.remove('active');
                
                // Limpar dados de impostos calculados
                impostosCalculados = null;
                
                showNotification(`Orçamento Nº ${pedidoLocal.id} criado com sucesso!`, 'success');
                
            } catch (error) {
                console.error('Erro ao salvar orçamento:', error);
                showNotification(error.message || 'Erro ao salvar orçamento. Tente novamente.', 'error');
            }
        }
        
        // Eventos do modal novo orçamento
        document.getElementById('modal-novo-orcamento').addEventListener('click', function(e) {
            if (e.target === this) fecharModalNovoOrcamento();
        });
        
        // Eventos do modal adicionar item
        document.getElementById('modal-adicionar-item').addEventListener('click', function(e) {
            if (e.target === this) fecharModalAdicionarItem();
        });

        // ========================================
        // FUNÇÕES DA ABA PARCELAS
        // ========================================
        function atualizarParcelas() {
            const forma = document.getElementById('novo-forma-pagamento').value;
            const selectParcelas = document.getElementById('novo-qtd-parcelas');
            
            // Se for à vista (dinheiro, PIX, débito), limitar a 1 parcela
            if (['dinheiro', 'pix', 'cartao_debito'].includes(forma)) {
                selectParcelas.value = '1';
                selectParcelas.disabled = true;
            } else {
                selectParcelas.disabled = false;
            }
            
            gerarTabelaParcelas();
        }
        
        function gerarTabelaParcelas() {
            const qtdParcelas = parseInt(document.getElementById('novo-qtd-parcelas').value) || 1;
            const forma = document.getElementById('novo-forma-pagamento').value;
            const intervalo = parseInt(document.getElementById('novo-intervalo-parcelas').value) || 30;
            const primeiroVencimento = document.getElementById('novo-primeiro-vencimento').value;
            const valorTotal = parseFloat(document.getElementById('novo-valor-total').value.replace('.', '').replace(',', '.')) || 0;
            
            const tbody = document.getElementById('tbody-parcelas');
            const valorParcela = valorTotal / qtdParcelas;
            
            const formaLabels = {
                'dinheiro': 'Dinheiro',
                'pix': 'PIX',
                'cartao_credito': 'Cartão Crédito',
                'cartao_debito': 'Cartão Débito',
                'boleto': 'Boleto',
                'transferencia': 'Transferência',
                'cheque': 'Cheque',
                'crediario': 'Crediário'
            };
            
            let html = '';
            let dataBase = primeiroVencimento ? new Date(primeiroVencimento + 'T00:00:00') : new Date();
            
            for (let i = 1; i <= qtdParcelas; i++) {
                const dataVencimento = new Date(dataBase);
                dataVencimento.setDate(dataBase.getDate() + (intervalo * (i - 1)));
                
                const dataFormatada = dataVencimento.toLocaleDateString('pt-BR');
                
                html += `
                    <tr>
                        <td>${i}/${qtdParcelas}</td>
                        <td>${dataFormatada}</td>
                        <td>R$ ${valorParcela.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</td>
                        <td>${formaLabels[forma] || '-'}</td>
                        <td><span class="status-badge pendente">Pendente</span></td>
                    </tr>
                `;
            }
            
            tbody.innerHTML = html || '<tr><td colspan="5" style="text-align: center; color: #999;">Nenhuma parcela</td></tr>';
        }
        
        // Inicializar data do primeiro vencimento
        document.addEventListener('DOMContentLoaded', function() {
            const hoje = new Date();
            hoje.setDate(hoje.getDate() + 30); // 30 dias a partir de hoje
            const primeiroVenc = document.getElementById('novo-primeiro-vencimento');
            if (primeiroVenc) {
                primeiroVenc.value = hoje.toISOString().split('T')[0];
            }
        });
        
        // Eventos para atualizar parcelas
        document.getElementById('novo-primeiro-vencimento')?.addEventListener('change', gerarTabelaParcelas);
        document.getElementById('novo-intervalo-parcelas')?.addEventListener('change', gerarTabelaParcelas);
        
        // ========================================
        // FUNÇÕES DA ABA E-MAIL
        // ========================================
        function enviarEmailOrcamento() {
            const email = document.getElementById('novo-email-cliente').value.trim();
            const assunto = document.getElementById('novo-email-assunto').value.trim();
            const mensagem = document.getElementById('novo-email-mensagem').value.trim();
            
            if (!email) {
                showNotification('Por favor, informe o e-mail do destinatário.', 'warning');
                return;
            }
            
            if (!assunto) {
                showNotification('Por favor, informe o assunto do e-mail.', 'warning');
                return;
            }
            
            // Simular envio
            showNotification('E-mail enviado com sucesso para ' + email, 'success');
            
            // TODO: Integrar com API de envio de e-mail
        }
        
        function visualizarEmailOrcamento() {
            const assunto = document.getElementById('novo-email-assunto').value.trim() || 'Orçamento';
            const mensagem = document.getElementById('novo-email-mensagem').value.trim() || 'Sem mensagem personalizada.';
            
            // Abrir preview simples
            const previewContent = `
                <div style="padding: 20px; font-family: Arial, sans-serif;">
                    <h3 style="color: #333; border-bottom: 2px solid #f97316; padding-bottom: 10px;">${assunto}</h3>
                    <div style="white-space: pre-wrap; color: #555; line-height: 1.6;">${mensagem}</div>
                    <div style="margin-top: 20px; padding: 15px; background: #f5f5f5; border-radius: 8px;">
                        <p style="margin: 0; font-size: 12px; color: #888;">
                            <i class="fas fa-paperclip"></i> Anexo: Orçamento.pdf
                        </p>
                    </div>
                </div>
            `;
            
            showNotification('Visualização de e-mail aberta!', 'info');
        }

        // ========================================
        // AÇÕES - FATURAR TODOS
        // ========================================
        function faturarTodos() {
            const cards = document.getElementById('col-faturar').querySelectorAll('.kanban-card');
            const count = cards.length;
            
            if (count === 0) {
                showNotification('Não há pedidos para faturar', 'warning');
                return;
            }
            
            // Atualizar info do modal
            document.getElementById('faturar-info').textContent = 
                `Você está prestes a faturar ${count} pedido${count > 1 ? 's' : ''}.`;
            
            // Calcular total
            let total = 0;
            dadosVendas.faturar.forEach(p => total += p.valor);
            document.getElementById('faturar-total').textContent = `Total: R$ ${total.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}`;
            
            // Listar pedidos com design premium
            let listaHTML = '';
            dadosVendas.faturar.forEach((p, index) => {
                listaHTML += `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 14px 16px; background: ${index % 2 === 0 ? '#ffffff' : '#f9fafb'}; border-bottom: 1px solid #f3f4f6; transition: background 0.2s;">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <div style="width: 32px; height: 32px; background: linear-gradient(135deg, #dbeafe, #bfdbfe); border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                                <i class="fas fa-file-alt" style="font-size: 14px; color: #2563eb;"></i>
                            </div>
                            <div>
                                <div style="font-weight: 600; color: #1f2937; font-size: 14px;">Nº ${p.id}</div>
                                <div style="font-size: 12px; color: #6b7280;">${p.cliente.substring(0, 28)}${p.cliente.length > 28 ? '...' : ''}</div>
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-weight: 700; color: #059669; font-size: 14px;">R$ ${p.valor.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</div>
                        </div>
                    </div>
                `;
            });
            document.getElementById('faturar-lista').innerHTML = listaHTML || '<p style="text-align: center; color: #999; padding: 20px;">Nenhum pedido</p>';
            
            // Abrir modal
            document.getElementById('modal-faturar-todos').classList.add('active');
        }
        
        function fecharModalFaturar() {
            document.getElementById('modal-faturar-todos').classList.remove('active');
        }
        
        function confirmarFaturarTodos() {
            const pedidosParaFaturar = [...dadosVendas.faturar];
            const count = pedidosParaFaturar.length;
            
            if (count === 0) {
                fecharModalFaturar();
                return;
            }
            
            // Mover pedidos para coluna "faturado"
            pedidosParaFaturar.forEach(pedido => {
                // Gerar número de NF fictício
                const nfNumero = String(Math.floor(Math.random() * 900000) + 100000).padStart(8, '0');
                pedido.status = 'Faturado';
                pedido.nf = nfNumero;
                
                // Adicionar na coluna faturado
                dadosVendas.faturado.unshift(pedido);
            });
            
            // Limpar coluna faturar
            dadosVendas.faturar = [];
            
            // Re-renderizar kanban
            renderKanban();
            
            // Fechar modal e notificar
            fecharModalFaturar();
            showNotification(`${count} pedido${count > 1 ? 's' : ''} faturado${count > 1 ? 's' : ''} com sucesso!`, 'success');
            
            // TODO: Salvar no backend via API
            // faturarPedidosAPI(pedidosParaFaturar);
        }
        
        // Eventos do modal faturar
        document.getElementById('modal-faturar-todos').addEventListener('click', function(e) {
            if (e.target === this) fecharModalFaturar();
        });

        // ========================================
        // AÇÕES - COMUNICAR SEFAZ
        // ========================================
        function comunicarSefaz() {
            const notasFaturadas = dadosVendas.faturado.filter(p => p.nf);
            const count = notasFaturadas.length;
            
            if (count === 0) {
                showNotification('Não há notas fiscais para transmitir', 'warning');
                return;
            }
            
            // Reset do modal
            document.getElementById('sefaz-loading').style.display = 'none';
            document.getElementById('sefaz-inicial').style.display = 'block';
            document.getElementById('sefaz-resultado').style.display = 'none';
            document.getElementById('btn-transmitir-sefaz').style.display = 'inline-flex';
            
            // Atualizar info
            document.getElementById('sefaz-info').textContent = 
                `${count} nota${count > 1 ? 's' : ''} fiscal${count > 1 ? 'is' : ''} pronta${count > 1 ? 's' : ''} para transmissão.`;
            
            // Listar notas
            let listaHTML = '';
            notasFaturadas.forEach(p => {
                listaHTML += `
                    <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #e5e5e5;">
                        <span><i class="fas fa-file-invoice" style="color: #06b6d4; margin-right: 8px;"></i> NF ${p.nf}</span>
                        <span>${p.cliente.substring(0, 25)}${p.cliente.length > 25 ? '...' : ''}</span>
                    </div>
                `;
            });
            document.getElementById('sefaz-lista').innerHTML = listaHTML;
            
            // Abrir modal
            document.getElementById('modal-sefaz').classList.add('active');
        }
        
        function fecharModalSefaz() {
            document.getElementById('modal-sefaz').classList.remove('active');
        }
        
        function transmitirSefaz() {
            // Esconder tela inicial, mostrar loading
            document.getElementById('sefaz-inicial').style.display = 'none';
            document.getElementById('sefaz-loading').style.display = 'block';
            document.getElementById('btn-transmitir-sefaz').style.display = 'none';
            
            // Simular transmissão (2-3 segundos)
            setTimeout(() => {
                const notasFaturadas = dadosVendas.faturado.filter(p => p.nf);
                const count = notasFaturadas.length;
                
                // Esconder loading, mostrar resultado
                document.getElementById('sefaz-loading').style.display = 'none';
                document.getElementById('sefaz-resultado').style.display = 'block';
                document.getElementById('sefaz-resultado-info').textContent = 
                    `${count} nota${count > 1 ? 's' : ''} fiscal${count > 1 ? 'is' : ''} transmitida${count > 1 ? 's' : ''} com sucesso para a SEFAZ!`;
                
                // Marcar notas como transmitidas (adicionar protocolo fictício)
                notasFaturadas.forEach(p => {
                    p.protocolo = 'SEFAZ-' + Date.now() + '-' + p.id;
                    if (!p.mensagem) {
                        p.mensagem = 'NF-e autorizada pela SEFAZ';
                    }
                });
                
                // Re-renderizar para atualizar visual
                renderKanban();
                
                showNotification(`Transmissão SEFAZ concluída! ${count} NF-e${count > 1 ? 's' : ''} autorizadas.`, 'success');
                
                // TODO: Enviar para SEFAZ real via API
                // transmitirSefazAPI(notasFaturadas);
            }, 2500);
        }
        
        // Eventos do modal SEFAZ
        document.getElementById('modal-sefaz').addEventListener('click', function(e) {
            if (e.target === this) fecharModalSefaz();
        });

        function toggleChat() {
            showNotification('Assistente Bob será aberto em breve!', 'info');
        }

        // ========================================
        // PESQUISA
        // ========================================
        document.getElementById('search-input').addEventListener('input', function(e) {
            const termo = e.target.value.toLowerCase();
            const cards = document.querySelectorAll('.kanban-card');
            
            cards.forEach(card => {
                const titulo = card.querySelector('.card-title').textContent.toLowerCase();
                const numero = card.querySelector('.card-number').textContent.toLowerCase();
                
                if (titulo.includes(termo) || numero.includes(termo)) {
                    card.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            });
        });

        // ========================================
        // NOTIFICAÇÕES
        // ========================================
        function showNotification(message, type = 'info') {
            const colors = {
                info: '#3b82f6',
                success: '#22c55e',
                warning: '#f59e0b',
                error: '#ef4444'
            };

            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 70px;
                right: 20px;
                background: ${colors[type]};
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                font-size: 14px;
                font-weight: 500;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 10000;
                animation: slideIn 0.3s ease;
            `;
            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // Adicionar keyframes
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
        `;
        document.head.appendChild(style);

        // ========================================
        // CARREGAR DADOS DO USUÁRIO LOGADO
        // ========================================
        // Mapeamento de avatares por nome de usuário
        const avatarNameMap = {
            'clemerson': '/avatars/Clemerson.webp',
            'isabela': '/avatars/Isabela.webp',
            'thaina': '/avatars/Thaina.webp',
            'thiago': '/avatars/Thiago.webp',
            'nicolas': '/avatars/NicolasDaniel.webp',
            'nicolasdaniel': '/avatars/NicolasDaniel.webp',
            'rh': '/avatars/Rh.webp',
            'admin': '/avatars/admin.webp',
            'ti': '/avatars/TI.webp',
            'tialuforce': '/avatars/TI.webp',
            'antonio': '/avatars/Antonio.webp',
            'andreia': '/avatars/Andreia.webp',
            'guilherme': '/avatars/Guilherme.webp'
        };

        function getAvatarFromEmail(email, nome) {
            if (!email) return null;
            const username = email.split('@')[0].split('.')[0].toLowerCase();
            if (avatarNameMap[username]) return avatarNameMap[username];
            // Tentar pelo primeiro nome
            if (nome) {
                const firstName = nome.split(' ')[0].toLowerCase();
                if (avatarNameMap[firstName]) return avatarNameMap[firstName];
            }
            return null;
        }

        // Variável global do usuário logado
        let usuarioLogado = {
            id: null,
            nome: '',
            email: '',
            role: '',
            isAdmin: false
        };
        
        // Lista de admins por email/nome
        const ADMINS_EMAILS = ['ti@aluforce.ind.br', 'andreia@aluforce.ind.br', 'douglas@aluforce.ind.br'];
        const ADMINS_NOMES = ['antonio egidio', 'andreia', 'douglas'];
        
        function verificarSeAdmin(user) {
            if (!user) return false;
            // Verificar pelo role
            if (user.role === 'admin' || user.is_admin === 1 || user.is_admin === true) return true;
            // Verificar pelo email
            if (user.email && ADMINS_EMAILS.includes(user.email.toLowerCase())) return true;
            // Verificar pelo nome
            if (user.nome) {
                const nomeMin = user.nome.toLowerCase();
                for (const adminNome of ADMINS_NOMES) {
                    if (nomeMin.includes(adminNome)) return true;
                }
            }
            return false;
        }

        async function carregarUsuarioLogado() {
            try {
                const response = await fetch('/api/me', { credentials: 'include' });
                if (response.ok) {
                    const user = await response.json();
                    
                    // Armazenar dados do usuário
                    usuarioLogado.id = user.id;
                    usuarioLogado.nome = user.nome || '';
                    usuarioLogado.email = user.email || '';
                    usuarioLogado.role = user.role || '';
                    // Usar isAdmin da API ou calcular localmente como fallback
                    usuarioLogado.isAdmin = user.isAdmin === true || verificarSeAdmin(user);
                    
                    console.log('👤 Usuário logado:', usuarioLogado.nome, '| Admin:', usuarioLogado.isAdmin, '| ID:', usuarioLogado.id);
                    
                    // Usar apelido se disponível, senão primeiro nome
                    const userName = user.apelido || user.nome || 'Usuário';
                    const primeiroNome = user.apelido || (user.nome ? user.nome.split(' ')[0] : 'Usuário');
                    
                    // Prioridade: avatar > foto > foto_perfil_url > mapeamento por email/nome
                    let userAvatar = user.avatar || user.foto || user.foto_perfil_url;
                    if (!userAvatar || userAvatar === '/avatars/default.webp') {
                        userAvatar = getAvatarFromEmail(user.email, userName);
                    }
                    
                    // Atualizar saudação dinâmica baseada na hora
                    const greetingTextEl = document.getElementById('greeting-text');
                    if (greetingTextEl) {
                        const hour = new Date().getHours();
                        let greeting = 'Bom dia';
                        if (hour >= 12 && hour < 18) greeting = 'Boa tarde';
                        else if (hour >= 18 || hour < 5) greeting = 'Boa noite';
                        greetingTextEl.textContent = greeting;
                    }
                    
                    // Atualizar nome na saudação
                    const userNameEl = document.getElementById('user-name');
                    if (userNameEl) {
                        userNameEl.textContent = primeiroNome;
                    }
                    
                    // Atualizar avatar/foto
                    const userPhotoEl = document.getElementById('user-photo');
                    const userInitialEl = document.getElementById('user-initial');
                    
                    if (userAvatar && userPhotoEl) {
                        userPhotoEl.src = userAvatar;
                        userPhotoEl.onload = () => {
                            userPhotoEl.classList.add('visible');
                            userPhotoEl.style.display = 'block';
                            if (userInitialEl) userInitialEl.style.display = 'none';
                        };
                        userPhotoEl.onerror = () => {
                            userPhotoEl.style.display = 'none';
                            if (userInitialEl) {
                                userInitialEl.textContent = userName.charAt(0).toUpperCase();
                                userInitialEl.style.display = 'flex';
                            }
                        };
                    } else if (userInitialEl) {
                        userInitialEl.textContent = userName.charAt(0).toUpperCase();
                        userInitialEl.style.display = 'flex';
                        if (userPhotoEl) userPhotoEl.style.display = 'none';
                    }
                    
                    console.log('👤 Usuário Vendas:', primeiroNome, '| Foto:', userAvatar ? 'Sim' : 'Não');
                }
            } catch (error) {
                console.error('Erro ao carregar usuário:', error);
            }
        }

        // ========================================
        // FUNÇÕES DO MODAL NOVO CLIENTE
        // ========================================
        
        // Estado inicial do formulário para detectar alterações
        let clienteEstadoInicial = {};
        let clienteHaAlteracoes = false;
        
        function abrirModalNovoCliente() {
            document.getElementById('modal-novo-cliente').classList.add('active');
            limparFormularioCliente();
            // Salva estado inicial após limpar
            setTimeout(() => {
                clienteEstadoInicial = capturarEstadoCliente();
                clienteHaAlteracoes = false;
            }, 100);
        }

        function fecharModalNovoCliente() {
            document.getElementById('modal-novo-cliente').classList.remove('active');
            clienteHaAlteracoes = false;
        }
        
        // Verificar alterações antes de fechar
        function verificarAlteracoesCliente() {
            const estadoAtual = capturarEstadoCliente();
            const alteracoes = detectarAlteracoesCliente(clienteEstadoInicial, estadoAtual);
            
            if (alteracoes.length > 0) {
                mostrarPopupAlteracoes(alteracoes, () => fecharModalNovoCliente());
            } else {
                fecharModalNovoCliente();
            }
        }
        
        function capturarEstadoCliente() {
            return {
                cnpj: document.getElementById('cliente-cnpj')?.value || document.getElementById('manual-cnpj')?.value || '',
                razaoSocial: document.getElementById('cliente-razao-social')?.value || document.getElementById('manual-razao-social')?.value || '',
                fantasia: document.getElementById('cliente-fantasia')?.value || document.getElementById('manual-fantasia')?.value || '',
                ie: document.getElementById('cliente-ie')?.value || document.getElementById('manual-ie')?.value || '',
                cep: document.getElementById('cliente-cep')?.value || document.getElementById('manual-cep')?.value || '',
                logradouro: document.getElementById('cliente-logradouro')?.value || document.getElementById('manual-logradouro')?.value || '',
                numero: document.getElementById('cliente-numero')?.value || document.getElementById('manual-numero')?.value || '',
                bairro: document.getElementById('cliente-bairro')?.value || document.getElementById('manual-bairro')?.value || '',
                cidade: document.getElementById('cliente-cidade')?.value || document.getElementById('manual-cidade')?.value || '',
                uf: document.getElementById('cliente-uf')?.value || document.getElementById('manual-uf')?.value || '',
                telefone: document.getElementById('cliente-telefone')?.value || document.getElementById('manual-telefone')?.value || '',
                email: document.getElementById('cliente-email')?.value || document.getElementById('manual-email')?.value || ''
            };
        }
        
        function detectarAlteracoesCliente(inicial, atual) {
            const alteracoes = [];
            const labels = {
                cnpj: 'CNPJ/CPF',
                razaoSocial: 'Razão Social',
                fantasia: 'Nome Fantasia',
                ie: 'Inscrição Estadual',
                cep: 'CEP',
                logradouro: 'Logradouro',
                numero: 'Número',
                bairro: 'Bairro',
                cidade: 'Cidade',
                uf: 'UF',
                telefone: 'Telefone',
                email: 'E-mail'
            };
            
            for (const key in labels) {
                if (inicial[key] !== atual[key]) {
                    alteracoes.push(`${labels[key]}: "${inicial[key] || '(vazio)'}" → "${atual[key] || '(vazio)'}"`);
                }
            }
            
            return alteracoes;
        }

        function limparFormularioCliente() {
            const campos = ['cliente-cnpj', 'cliente-tipo-pessoa', 'cliente-situacao', 'cliente-razao-social', 
                           'cliente-fantasia', 'cliente-ie', 'cliente-im', 'cliente-cep', 'cliente-logradouro',
                           'cliente-numero', 'cliente-complemento', 'cliente-bairro', 'cliente-cidade', 'cliente-uf',
                           'cliente-telefone', 'cliente-celular', 'cliente-email', 'cliente-contato-nome',
                           'cliente-contato-cargo', 'cliente-observacoes'];
            campos.forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    if (el.tagName === 'SELECT') {
                        el.selectedIndex = 0;
                    } else {
                        el.value = '';
                    }
                }
            });
            document.getElementById('cnpj-resultado').style.display = 'none';
            document.getElementById('cnpj-loading').style.display = 'none';
        }

        // Consulta CNPJ na API ReceitaWS (gratuita)
        async function consultarCNPJ() {
            const cnpjInput = document.getElementById('cliente-cnpj');
            const cnpj = cnpjInput.value.replace(/\D/g, '');
            
            if (cnpj.length !== 14) {
                showNotification('CNPJ deve ter 14 dígitos', 'error');
                return;
            }
            
            const loadingEl = document.getElementById('cnpj-loading');
            const resultadoEl = document.getElementById('cnpj-resultado');
            
            loadingEl.style.display = 'block';
            resultadoEl.style.display = 'none';
            
            try {
                // API gratuita ReceitaWS
                const response = await fetch(`https://receitaws.com.br/v1/cnpj/${cnpj}`, {
                    headers: { 'Accept': 'application/json' }
                });
                
                if (!response.ok) throw new Error('CNPJ não encontrado');
                
                const dados = await response.json();
                
                if (dados.status === 'ERROR') {
                    throw new Error(dados.message || 'CNPJ não encontrado');
                }
                
                // Preencher formulário
                document.getElementById('cliente-razao-social').value = dados.nome || '';
                document.getElementById('cliente-fantasia').value = dados.fantasia || '';
                document.getElementById('cliente-logradouro').value = dados.logradouro || '';
                document.getElementById('cliente-numero').value = dados.numero || '';
                document.getElementById('cliente-complemento').value = dados.complemento || '';
                document.getElementById('cliente-bairro').value = dados.bairro || '';
                document.getElementById('cliente-cidade').value = dados.municipio || '';
                document.getElementById('cliente-uf').value = dados.uf || '';
                document.getElementById('cliente-cep').value = dados.cep ? dados.cep.replace(/\D/g, '') : '';
                document.getElementById('cliente-telefone').value = dados.telefone ? dados.telefone.split('/')[0].trim() : '';
                document.getElementById('cliente-email').value = dados.email || '';
                
                // Mostrar resultado
                document.getElementById('cnpj-info').textContent = 
                    `${dados.nome} - ${dados.situacao || 'Situação não informada'}`;
                resultadoEl.style.display = 'block';
                
                showNotification('Dados preenchidos automaticamente!', 'success');
                
            } catch (error) {
                showNotification(error.message || 'Erro ao consultar CNPJ', 'error');
            } finally {
                loadingEl.style.display = 'none';
            }
        }

        // Consulta CEP via ViaCEP
        async function consultarCEP() {
            const cepInput = document.getElementById('cliente-cep');
            const cep = cepInput.value.replace(/\D/g, '');
            
            if (cep.length !== 8) {
                showNotification('CEP deve ter 8 dígitos', 'error');
                return;
            }
            
            try {
                const response = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
                const dados = await response.json();
                
                if (dados.erro) {
                    throw new Error('CEP não encontrado');
                }
                
                document.getElementById('cliente-logradouro').value = dados.logradouro || '';
                document.getElementById('cliente-bairro').value = dados.bairro || '';
                document.getElementById('cliente-cidade').value = dados.localidade || '';
                document.getElementById('cliente-uf').value = dados.uf || '';
                
                showNotification('Endereço preenchido!', 'success');
                
            } catch (error) {
                showNotification(error.message || 'Erro ao consultar CEP', 'error');
            }
        }
        
        // Funções para expandir/contrair seções do modal de cliente
        function expandirPesquisaCNPJ() {
            const elemento = document.getElementById('pesquisa-cnpj-expandido');
            if (elemento.style.display === 'none') {
                // Esconde outros expandidos
                document.getElementById('pesquisa-google-expandido').style.display = 'none';
                document.getElementById('insercao-manual-expandido').style.display = 'none';
                elemento.style.display = 'block';
            } else {
                elemento.style.display = 'none';
            }
        }
        
        function expandirPesquisaGoogle() {
            const elemento = document.getElementById('pesquisa-google-expandido');
            if (elemento.style.display === 'none') {
                // Esconde outros expandidos
                document.getElementById('pesquisa-cnpj-expandido').style.display = 'none';
                document.getElementById('insercao-manual-expandido').style.display = 'none';
                elemento.style.display = 'block';
            } else {
                elemento.style.display = 'none';
            }
        }
        
        function expandirInsercaoManual() {
            const elemento = document.getElementById('insercao-manual-expandido');
            if (elemento.style.display === 'none') {
                // Esconde outros expandidos
                document.getElementById('pesquisa-cnpj-expandido').style.display = 'none';
                document.getElementById('pesquisa-google-expandido').style.display = 'none';
                elemento.style.display = 'block';
            } else {
                elemento.style.display = 'none';
            }
        }
        
        // Pesquisa Atômica - Busca no banco de dados
        async function pesquisarAtomico() {
            const termo = document.getElementById('pesquisa-atomica').value.trim();
            if (!termo) {
                showNotification('Digite algo para pesquisar', 'error');
                return;
            }
            
            showNotification('Pesquisando... Aguarde', 'info');
            
            try {
                // Buscar clientes no banco de dados
                const response = await fetch(`/api/vendas/clientes?search=${encodeURIComponent(termo)}`, {
                    credentials: 'include'
                });
                
                if (!response.ok) throw new Error('Erro na pesquisa');
                
                const result = await response.json();
                const clientes = result.clientes || result.data || result || [];
                
                if (clientes.length === 0) {
                    showNotification('Nenhum cliente encontrado. Tente buscar por CNPJ/CPF para consultar na Receita.', 'warning');
                    return;
                }
                
                // Mostrar resultados para seleção
                exibirResultadosPesquisa(clientes);
                showNotification(`${clientes.length} cliente(s) encontrado(s)!`, 'success');
                
            } catch (error) {
                console.error('Erro na pesquisa:', error);
                showNotification('Erro ao pesquisar. Tente novamente.', 'error');
            }
        }
        
        // Exibir resultados da pesquisa de clientes
        function exibirResultadosPesquisa(clientes) {
            // Verificar se já existe o container de resultados
            let resultadosDiv = document.getElementById('resultados-pesquisa-cliente');
            
            if (!resultadosDiv) {
                // Criar container de resultados
                resultadosDiv = document.createElement('div');
                resultadosDiv.id = 'resultados-pesquisa-cliente';
                resultadosDiv.style.cssText = 'margin-top: 16px; background: #fff; border: 2px solid #3b82f6; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 12px rgba(59,130,246,0.15);';
                
                // Inserir após a pesquisa inteligente
                const pesquisaDiv = document.querySelector('.cliente-opcao-pesquisa');
                pesquisaDiv.parentNode.insertBefore(resultadosDiv, pesquisaDiv.nextSibling);
            }
            
            resultadosDiv.innerHTML = `
                <div style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 14px 20px; display: flex; justify-content: space-between; align-items: center;">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-check-circle" style="font-size: 18px;"></i>
                        <span style="font-weight: 600;">${clientes.length} resultado(s) encontrado(s)</span>
                    </div>
                    <button onclick="document.getElementById('resultados-pesquisa-cliente').remove()" style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 12px;">
                        <i class="fas fa-times"></i> Fechar
                    </button>
                </div>
                <div style="max-height: 300px; overflow-y: auto;">
                    ${clientes.map(c => `
                        <div class="resultado-cliente-item" onclick="selecionarClientePesquisa(${c.id})" 
                             style="padding: 14px 20px; border-bottom: 1px solid #e2e8f0; cursor: pointer; transition: all 0.2s; display: flex; justify-content: space-between; align-items: center;"
                             onmouseover="this.style.background='#f0f9ff'" onmouseout="this.style.background='white'">
                            <div>
                                <div style="font-weight: 600; color: #1e293b; margin-bottom: 4px;">${c.razao_social || c.nome || 'Sem nome'}</div>
                                <div style="font-size: 12px; color: #64748b;">
                                    ${c.cnpj || c.cpf || '-'} • ${c.cidade || ''}${c.uf ? '/' + c.uf : ''}
                                </div>
                            </div>
                            <button style="background: linear-gradient(135deg, #3b82f6, #1d4ed8); color: white; border: none; padding: 8px 16px; border-radius: 8px; font-size: 12px; font-weight: 500; cursor: pointer;">
                                <i class="fas fa-check"></i> Selecionar
                            </button>
                        </div>
                    `).join('')}
                </div>
            `;
            
            resultadosDiv.style.display = 'block';
        }
        
        // Selecionar cliente da pesquisa
        async function selecionarClientePesquisa(clienteId) {
            try {
                const response = await fetch(`/api/vendas/clientes/${clienteId}`, {
                    credentials: 'include'
                });
                
                if (!response.ok) throw new Error('Erro ao carregar cliente');
                
                const cliente = await response.json();
                
                // Preencher formulário ou usar diretamente
                if (cliente) {
                    // Fechar modal e selecionar cliente
                    fecharModalNovoCliente();
                    
                    // Se existir função para definir cliente no pedido
                    if (typeof setClienteNoPedido === 'function') {
                        setClienteNoPedido(cliente);
                    } else {
                        // Disparar evento ou salvar no localStorage
                        localStorage.setItem('clienteSelecionado', JSON.stringify(cliente));
                        showNotification(`Cliente "${cliente.razao_social || cliente.nome}" selecionado!`, 'success');
                        
                        // Atualizar campo de cliente se existir
                        const clienteInput = document.getElementById('cliente-nome') || document.querySelector('[data-cliente-nome]');
                        if (clienteInput) {
                            clienteInput.value = cliente.razao_social || cliente.nome || '';
                            clienteInput.dataset.clienteId = cliente.id;
                        }
                    }
                }
            } catch (error) {
                console.error('Erro ao selecionar cliente:', error);
                showNotification('Erro ao selecionar cliente', 'error');
            }
        }
        
        // Pesquisa no Google
        function pesquisarGoogle() {
            const termo = document.getElementById('pesquisa-google').value.trim();
            if (!termo) {
                showNotification('Digite algo para pesquisar', 'error');
                return;
            }
            
            // Abrir pesquisa do Google em nova aba
            const url = `https://www.google.com/search?q=${encodeURIComponent(termo)}`;
            window.open(url, '_blank');
        }
        
        // Consultar CEP no formulário manual
        async function consultarCEPManual() {
            const cepInput = document.getElementById('manual-cep');
            const cep = cepInput.value.replace(/\D/g, '');
            
            if (cep.length !== 8) {
                showNotification('CEP deve ter 8 dígitos', 'error');
                return;
            }
            
            try {
                const response = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
                const dados = await response.json();
                
                if (dados.erro) {
                    throw new Error('CEP não encontrado');
                }
                
                document.getElementById('manual-logradouro').value = dados.logradouro || '';
                document.getElementById('manual-bairro').value = dados.bairro || '';
                document.getElementById('manual-cidade').value = dados.localidade || '';
                document.getElementById('manual-uf').value = dados.uf || '';
                
                showNotification('Endereço preenchido!', 'success');
                
            } catch (error) {
                showNotification(error.message || 'Erro ao consultar CEP', 'error');
            }
        }
        
        // Salvar cliente do formulário manual
        async function salvarClienteManual() {
            const cliente = {
                cnpj_cpf: document.getElementById('manual-cnpj')?.value || '',
                razao_social: document.getElementById('manual-razao-social')?.value || '',
                nome_fantasia: document.getElementById('manual-fantasia')?.value || '',
                ie: document.getElementById('manual-ie')?.value || '',
                cep: document.getElementById('manual-cep')?.value || '',
                logradouro: document.getElementById('manual-logradouro')?.value || '',
                numero: document.getElementById('manual-numero')?.value || '',
                complemento: document.getElementById('manual-complemento')?.value || '',
                bairro: document.getElementById('manual-bairro')?.value || '',
                cidade: document.getElementById('manual-cidade')?.value || '',
                uf: document.getElementById('manual-uf')?.value || '',
                telefone: document.getElementById('manual-telefone')?.value || '',
                celular: document.getElementById('manual-celular')?.value || '',
                email: document.getElementById('manual-email')?.value || '',
                contato_nome: document.getElementById('manual-contato-nome')?.value || '',
                contato_cargo: document.getElementById('manual-contato-cargo')?.value || '',
                observacoes: document.getElementById('manual-observacoes')?.value || ''
            };

            if (!cliente.razao_social) {
                showNotification('Razão Social é obrigatória', 'error');
                return;
            }

            try {
                const response = await fetch('/api/vendas/clientes', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(cliente)
                });

                if (response.ok) {
                    showNotification('Cliente cadastrado com sucesso!', 'success');
                    clienteHaAlteracoes = false;
                    fecharModalNovoCliente();
                } else {
                    const err = await response.json();
                    throw new Error(err.message || 'Erro ao salvar');
                }
            } catch (error) {
                showNotification(error.message || 'Erro ao salvar cliente', 'error');
            }
        }

        // Formatadores
        function formatarCNPJ(input) {
            let value = input.value.replace(/\D/g, '');
            if (value.length > 14) value = value.slice(0, 14);
            
            if (value.length > 12) {
                value = value.replace(/^(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})$/, '$1.$2.$3/$4-$5');
            } else if (value.length > 8) {
                value = value.replace(/^(\d{2})(\d{3})(\d{3})(\d+)$/, '$1.$2.$3/$4');
            } else if (value.length > 5) {
                value = value.replace(/^(\d{2})(\d{3})(\d+)$/, '$1.$2.$3');
            } else if (value.length > 2) {
                value = value.replace(/^(\d{2})(\d+)$/, '$1.$2');
            }
            input.value = value;
        }

        function formatarCEP(input) {
            let value = input.value.replace(/\D/g, '');
            if (value.length > 8) value = value.slice(0, 8);
            if (value.length > 5) {
                value = value.replace(/^(\d{5})(\d+)$/, '$1-$2');
            }
            input.value = value;
        }

        function formatarTelefone(input) {
            let value = input.value.replace(/\D/g, '');
            if (value.length > 11) value = value.slice(0, 11);
            
            if (value.length > 10) {
                value = value.replace(/^(\d{2})(\d{5})(\d{4})$/, '($1) $2-$3');
            } else if (value.length > 6) {
                value = value.replace(/^(\d{2})(\d{4})(\d+)$/, '($1) $2-$3');
            } else if (value.length > 2) {
                value = value.replace(/^(\d{2})(\d+)$/, '($1) $2');
            }
            input.value = value;
        }

        function formatarMoedaInput(input) {
            let value = input.value.replace(/\D/g, '');
            value = (parseInt(value || '0') / 100).toLocaleString('pt-BR', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
            input.value = value;
        }

        // Salvar novo cliente
        async function salvarNovoCliente() {
            const cliente = {
                cnpj: document.getElementById('cliente-cnpj').value.replace(/\D/g, ''),
                tipo_pessoa: document.getElementById('cliente-tipo-pessoa').value,
                situacao: document.getElementById('cliente-situacao').value,
                razao_social: document.getElementById('cliente-razao-social').value,
                nome_fantasia: document.getElementById('cliente-fantasia').value,
                inscricao_estadual: document.getElementById('cliente-ie').value,
                inscricao_municipal: document.getElementById('cliente-im').value,
                cep: document.getElementById('cliente-cep').value.replace(/\D/g, ''),
                logradouro: document.getElementById('cliente-logradouro').value,
                numero: document.getElementById('cliente-numero').value,
                complemento: document.getElementById('cliente-complemento').value,
                bairro: document.getElementById('cliente-bairro').value,
                cidade: document.getElementById('cliente-cidade').value,
                uf: document.getElementById('cliente-uf').value,
                telefone: document.getElementById('cliente-telefone').value,
                celular: document.getElementById('cliente-celular').value,
                email: document.getElementById('cliente-email').value,
                contato_nome: document.getElementById('cliente-contato-nome').value,
                contato_cargo: document.getElementById('cliente-contato-cargo').value,
                observacoes: document.getElementById('cliente-observacoes').value
            };

            // Validações básicas
            if (!cliente.razao_social) {
                showNotification('Razão Social é obrigatória', 'error');
                return;
            }

            try {
                const response = await fetch('/api/vendas/clientes', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(cliente)
                });

                if (response.ok) {
                    showNotification('Cliente cadastrado com sucesso!', 'success');
                    fecharModalNovoCliente();
                } else {
                    const err = await response.json();
                    throw new Error(err.message || 'Erro ao salvar');
                }
            } catch (error) {
                showNotification(error.message || 'Erro ao salvar cliente', 'error');
            }
        }

        // ========================================
        // FUNÇÕES DO MODAL NOVO PRODUTO - ESTILO OMIE
        // ========================================
        
        // Estado inicial do formulário para detectar alterações
        let produtoEstadoInicial = {};
        let produtoHaAlteracoes = false;
        let modalOrigemProduto = null;
        
        function abrirModalNovoProduto() {
            document.getElementById('modal-novo-produto').classList.add('active');
            limparFormularioProduto();
            // Salva estado inicial após limpar
            setTimeout(() => {
                produtoEstadoInicial = capturarEstadoProduto();
                produtoHaAlteracoes = false;
            }, 100);
        }

        function fecharModalNovoProduto() {
            document.getElementById('modal-novo-produto').classList.remove('active');
            produtoHaAlteracoes = false;
        }
        
        // Verificar alterações antes de fechar
        function verificarAlteracoesProduto() {
            const estadoAtual = capturarEstadoProduto();
            const alteracoes = detectarAlteracoesProduto(produtoEstadoInicial, estadoAtual);
            
            if (alteracoes.length > 0) {
                modalOrigemProduto = 'produto';
                mostrarPopupAlteracoes(alteracoes, () => fecharModalNovoProduto());
            } else {
                fecharModalNovoProduto();
            }
        }
        
        function capturarEstadoProduto() {
            return {
                descricao: document.getElementById('produto-descricao')?.value || '',
                codigo: document.getElementById('produto-codigo')?.value || '',
                ean: document.getElementById('produto-ean')?.value || '',
                unidade: document.getElementById('produto-unidade')?.value || '',
                precoVenda: document.getElementById('produto-preco-venda')?.value || '',
                ncm: document.getElementById('produto-ncm')?.value || '',
                familia: document.getElementById('produto-familia')?.value || '',
                precoCusto: document.getElementById('produto-preco-custo')?.value || '',
                observacoes: document.getElementById('produto-observacoes')?.value || ''
            };
        }
        
        function detectarAlteracoesProduto(inicial, atual) {
            const alteracoes = [];
            const labels = {
                descricao: 'Descrição do Produto',
                codigo: 'Código do Produto',
                ean: 'Código EAN',
                unidade: 'Unidade',
                precoVenda: 'Preço de Venda',
                ncm: 'Código NCM',
                familia: 'Família de Produto',
                precoCusto: 'Preço de Custo',
                observacoes: 'Observações'
            };
            
            for (const key in labels) {
                if (inicial[key] !== atual[key]) {
                    alteracoes.push(`${labels[key]}: "${inicial[key] || '(vazio)'}" → "${atual[key] || '(vazio)'}"`);
                }
            }
            
            return alteracoes;
        }
        
        // Popup de confirmação de alterações
        function mostrarPopupAlteracoes(alteracoes, callbackSim) {
            const lista = document.getElementById('alteracoes-itens');
            lista.innerHTML = alteracoes.map(a => `<li>${a}</li>`).join('');
            
            window.callbackDesprezarAlteracoes = callbackSim;
            document.getElementById('modal-confirmar-alteracoes').classList.add('active');
        }
        
        function toggleListaAlteracoes() {
            const lista = document.getElementById('lista-alteracoes');
            lista.classList.toggle('show');
        }
        
        function confirmarDesprezarAlteracoes() {
            // Fechar o modal de confirmação
            document.getElementById('modal-confirmar-alteracoes').classList.remove('active');
            document.getElementById('lista-alteracoes').classList.remove('show');
            
            // Limpar alterações pendentes
            limparAlteracoes();
            
            // Fechar o modal principal de edição (Orçamento)
            const modalEditar = document.getElementById('modal-editar');
            if (modalEditar) {
                modalEditar.classList.remove('active');
                modalEditar.style.display = 'none';
            }
            
            // Fechar qualquer outro modal aberto
            document.querySelectorAll('.modal-overlay.active').forEach(modal => {
                if (modal.id !== 'modal-confirmar-alteracoes') {
                    modal.classList.remove('active');
                    modal.style.display = 'none';
                }
            });
            
            // Executar callback se existir
            if (window.callbackDesprezarAlteracoes) {
                window.callbackDesprezarAlteracoes();
                window.callbackDesprezarAlteracoes = null;
            }
            
            // Restaurar scroll do body
            document.body.style.overflow = '';
        }
        
        function cancelarDesprezarAlteracoes() {
            document.getElementById('modal-confirmar-alteracoes').classList.remove('active');
            document.getElementById('lista-alteracoes').classList.remove('show');
        }

        function limparFormularioProduto() {
            // Limpar campos básicos
            const campos = ['produto-descricao', 'produto-ean', 'produto-ncm', 'produto-familia',
                           'produto-preco-custo', 'produto-observacoes'];
            campos.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.value = '';
            });
            
            // Reset dos valores padrão
            const precoVenda = document.getElementById('produto-preco-venda');
            if (precoVenda) precoVenda.value = '0,000000';
            
            const codigo = document.getElementById('produto-codigo');
            if (codigo) codigo.value = 'PRD' + String(Math.floor(Math.random() * 100000)).padStart(5, '0');
            
            const unidade = document.getElementById('produto-unidade');
            if (unidade) unidade.selectedIndex = 0;
            
            // Reset imagem
            const preview = document.getElementById('produto-imagem-preview');
            const icon = document.getElementById('produto-imagem-icon');
            if (preview) {
                preview.style.display = 'none';
                preview.src = '';
            }
            if (icon) icon.style.display = 'block';
            
            // Reset toggles
            document.querySelectorAll('.toggle-switch-produto').forEach(toggle => {
                toggle.removeAttribute('data-active');
            });
            const firstToggle = document.querySelector('.toggle-switch-produto');
            if (firstToggle) firstToggle.setAttribute('data-active', 'true');
            
            // Reset abas - voltar para Estoque
            mudarAbaProduto('estoque', document.querySelector('.produto-tab'));
        }
        
        // Preview de imagem do produto
        function previewImagemProduto(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = document.getElementById('produto-imagem-preview');
                    const icon = document.getElementById('produto-imagem-icon');
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                    icon.style.display = 'none';
                };
                reader.readAsDataURL(input.files[0]);
            }
        }
        
        // Toggle de definição do produto (Simples/Kit/Com Variações)
        function toggleDefinicaoProduto(element, tipo) {
            // Remove active de todos
            document.querySelectorAll('.toggle-switch-produto').forEach(toggle => {
                toggle.removeAttribute('data-active');
            });
            // Ativa o clicado
            element.setAttribute('data-active', 'true');
        }
        
        // Toggle controle de lote
        function toggleControleLote(element) {
            const isActive = element.getAttribute('data-active') === 'true';
            element.setAttribute('data-active', !isActive);
        }
        
        // Mudar abas do produto
        function mudarAbaProduto(tabId, btnElement) {
            // Esconde todas as abas
            document.querySelectorAll('.produto-tab-panel').forEach(panel => {
                panel.style.display = 'none';
            });
            
            // Remove active de todos os botões
            document.querySelectorAll('.produto-tab').forEach(btn => {
                btn.classList.remove('active');
                btn.style.color = '#666';
                btn.style.borderBottomColor = 'transparent';
            });
            
            // Mostra a aba selecionada
            const panel = document.getElementById('tab-' + tabId);
            if (panel) panel.style.display = 'block';
            
            // Ativa o botão
            if (btnElement) {
                btnElement.classList.add('active');
                btnElement.style.color = '#f97316';
                btnElement.style.borderBottomColor = '#f97316';
            }
        }
        
        // Formatar moeda no produto
        function formatarMoedaProduto(input) {
            let valor = input.value.replace(/\D/g, '');
            valor = (parseFloat(valor) / 1000000).toFixed(6);
            input.value = valor.replace('.', ',');
        }

        async function salvarNovoProduto() {
            const produto = {
                codigo: document.getElementById('produto-codigo')?.value || '',
                descricao: document.getElementById('produto-descricao')?.value || '',
                ncm: document.getElementById('produto-ncm')?.value || '',
                ean: document.getElementById('produto-ean')?.value || '',
                unidade: document.getElementById('produto-unidade')?.value || '',
                preco_venda: parseFloat(document.getElementById('produto-preco-venda')?.value.replace(/\./g, '').replace(',', '.')) || 0,
                familia: document.getElementById('produto-familia')?.value || '',
                preco_custo: parseFloat(document.getElementById('produto-preco-custo')?.value.replace(/\./g, '').replace(',', '.')) || 0,
                observacoes: document.getElementById('produto-observacoes')?.value || ''
            };

            if (!produto.descricao) {
                showNotification('Descrição é obrigatória', 'error');
                return;
            }

            try {
                const response = await fetch('/api/vendas/produtos', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(produto)
                });

                if (response.ok) {
                    showNotification('Produto cadastrado com sucesso!', 'success');
                    produtoHaAlteracoes = false;
                    fecharModalNovoProduto();
                } else {
                    const err = await response.json();
                    throw new Error(err.message || 'Erro ao salvar');
                }
            } catch (error) {
                showNotification(error.message || 'Erro ao salvar produto', 'error');
            }
        }

        // ========================================
        // SISTEMA DE NOTIFICAÇÕES (CONECTADO À API)
        // ========================================
        
        // Array de notificações (carregado do servidor)
        let notificacoes = [];
        let filtroAtual = 'todas';
        
        // Carregar notificações do servidor
        async function carregarNotificacoes() {
            try {
                const filter = filtroAtual === 'nao-lidas' ? 'unread' : 
                              filtroAtual === 'importantes' ? 'important' : 'all';
                const response = await fetch(`/api/notifications?filter=${filter}`);
                if (response.ok) {
                    const data = await response.json();
                    notificacoes = (data.notifications || []).map(n => ({
                        id: n.id,
                        tipo: n.type || 'info',
                        icone: getIconePorTipo(n.type || 'info'),
                        titulo: n.title,
                        mensagem: n.message,
                        tempo: new Date(n.createdAt),
                        lida: n.read,
                        importante: n.important,
                        data: n.data
                    }));
                    atualizarContador(data.unreadCount);
                    renderizarNotificacoes();
                }
            } catch (error) {
                console.error('Erro ao carregar notificações:', error);
            }
        }
        
        // Inicializar sistema de notificações
        function inicializarNotificacoes() {
            carregarNotificacoes();
            
            // Atualizar notificações a cada 30 segundos
            setInterval(carregarNotificacoes, 30000);
            
            // Fechar painel ao clicar fora
            document.addEventListener('click', function(e) {
                const container = document.querySelector('.notification-container');
                const panel = document.getElementById('notification-panel');
                if (container && !container.contains(e.target) && panel.classList.contains('active')) {
                    panel.classList.remove('active');
                }
            });
            
            // Conectar via Socket.IO para notificações em tempo real
            if (window.io) {
                const socket = io();
                socket.on('notification', (notif) => {
                    adicionarNotificacao(notif.type, notif.title, notif.message, notif.important, notif.data);
                    // Mostrar toast
                    showNotification(notif.title + ': ' + notif.message, notif.type === 'error' ? 'error' : 'info');
                });
            }
        }
        
        // Toggle do painel de notificações
        function toggleNotificacoes() {
            const panel = document.getElementById('notification-panel');
            panel.classList.toggle('active');
            
            if (panel.classList.contains('active')) {
                carregarNotificacoes();
            }
        }
        
        // Renderizar lista de notificações
        function renderizarNotificacoes() {
            const lista = document.getElementById('notification-list');
            
            if (notificacoes.length === 0) {
                lista.innerHTML = `
                    <div class="notification-empty">
                        <i class="fas fa-bell-slash"></i>
                        <p>Nenhuma notificação ${filtroAtual === 'nao-lidas' ? 'não lida' : filtroAtual === 'importantes' ? 'importante' : ''}</p>
                    </div>
                `;
                return;
            }
            
            lista.innerHTML = notificacoes.map(notif => `
                <div class="notification-item ${notif.lida ? '' : 'unread'} ${notif.importante ? 'important' : ''}" 
                     onclick="marcarComoLida(${notif.id})">
                    <div class="notification-icon ${notif.tipo}">
                        <i class="fas ${notif.icone}"></i>
                    </div>
                    <div class="notification-content">
                        <div class="notification-title">
                            ${notif.titulo}
                            ${!notif.lida ? '<span class="badge-new">NOVO</span>' : ''}
                        </div>
                        <div class="notification-message">${notif.mensagem}</div>
                        <div class="notification-time">
                            <i class="far fa-clock"></i>
                            ${formatarTempoRelativo(notif.tempo)}
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        // Formatar tempo relativo (ex: "há 5 minutos")
        function formatarTempoRelativo(data) {
            const agora = new Date();
            const diff = agora - data;
            const minutos = Math.floor(diff / 60000);
            const horas = Math.floor(diff / 3600000);
            const dias = Math.floor(diff / 86400000);
            
            if (minutos < 1) return 'Agora mesmo';
            if (minutos < 60) return `há ${minutos} minuto${minutos > 1 ? 's' : ''}`;
            if (horas < 24) return `há ${horas} hora${horas > 1 ? 's' : ''}`;
            if (dias < 7) return `há ${dias} dia${dias > 1 ? 's' : ''}`;
            return data.toLocaleDateString('pt-BR');
        }
        
        // Filtrar notificações
        function filtrarNotificacoes(filtro, btn) {
            filtroAtual = filtro;
            
            // Atualizar tabs
            document.querySelectorAll('.notif-tab').forEach(t => t.classList.remove('active'));
            btn.classList.add('active');
            
            carregarNotificacoes();
        }
        
        // Marcar notificação como lida
        async function marcarComoLida(id) {
            try {
                await fetch(`/api/notifications/${id}/read`, { method: 'POST' });
                const notif = notificacoes.find(n => n.id === id);
                if (notif) {
                    notif.lida = true;
                    renderizarNotificacoes();
                    const naoLidas = notificacoes.filter(n => !n.lida).length;
                    atualizarContador(naoLidas);
                }
                
                // Se tiver dados do pedido, abrir o pedido
                if (notif && notif.data && notif.data.pedido_id) {
                    abrirDetalhesPedido(notif.data.pedido_id);
                }
            } catch (error) {
                console.error('Erro ao marcar como lida:', error);
            }
        }
        
        // Marcar todas como lidas
        async function marcarTodasLidas() {
            try {
                await fetch('/api/notifications/read-all', { method: 'POST' });
                notificacoes.forEach(n => n.lida = true);
                renderizarNotificacoes();
                atualizarContador(0);
                showNotification('Todas as notificações foram marcadas como lidas', 'success');
            } catch (error) {
                showNotification('Erro ao marcar notificações', 'error');
            }
        }
        
        // Limpar todas as notificações
        async function limparNotificacoes() {
            if (confirm('Deseja realmente limpar todas as notificações?')) {
                try {
                    for (const notif of notificacoes) {
                        await fetch(`/api/notifications/${notif.id}`, { method: 'DELETE' });
                    }
                    notificacoes = [];
                    renderizarNotificacoes();
                    atualizarContador(0);
                    showNotification('Notificações limpas', 'info');
                } catch (error) {
                    showNotification('Erro ao limpar notificações', 'error');
                }
            }
        }
        
        // Atualizar contador de notificações não lidas
        function atualizarContador(count) {
            const naoLidas = count !== undefined ? count : notificacoes.filter(n => !n.lida).length;
            const badge = document.getElementById('notification-count');
            
            if (naoLidas > 0) {
                badge.textContent = naoLidas > 99 ? '99+' : naoLidas;
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }
        }
        
        // Ver histórico completo
        function verTodasNotificacoes() {
            showNotification('Abrindo histórico completo de notificações...', 'info');
            // Poderia redirecionar para uma página dedicada
        }
        
        // Adicionar nova notificação localmente (para real-time)
        function adicionarNotificacao(tipo, titulo, mensagem, importante = false, data = {}) {
            const novaNotif = {
                id: Date.now(),
                tipo: tipo,
                icone: getIconePorTipo(tipo),
                titulo: titulo,
                mensagem: mensagem,
                tempo: new Date(),
                lida: false,
                importante: importante,
                data: data
            };
            
            notificacoes.unshift(novaNotif);
            renderizarNotificacoes();
            const naoLidas = notificacoes.filter(n => !n.lida).length;
            atualizarContador(naoLidas);
            
            // Efeito visual no badge
            const badge = document.getElementById('notification-count');
            badge.style.animation = 'none';
            setTimeout(() => badge.style.animation = '', 10);
        }
        
        function getIconePorTipo(tipo) {
            const icones = {
                'success': 'fa-check-circle',
                'warning': 'fa-exclamation-triangle',
                'error': 'fa-times-circle',
                'info': 'fa-info-circle',
                'order': 'fa-shopping-cart',
                'payment': 'fa-dollar-sign',
                'stock': 'fa-boxes'
            };
            return icones[tipo] || 'fa-bell';
        }
        
        // Criar notificação no servidor (chamado de outras partes do código)
        async function criarNotificacaoServidor(tipo, titulo, mensagem, data = {}) {
            try {
                await fetch('/api/notifications', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ type: tipo, title: titulo, message: mensagem, data })
                });
            } catch (error) {
                console.error('Erro ao criar notificação:', error);
            }
        }

        // ========================================
        // FUNÇÕES DE EXPORTAÇÃO
        // ========================================
        function abrirModalExportar() {
            document.getElementById('modal-exportar').classList.add('active');
            
            // Definir datas padrão (último mês)
            const hoje = new Date();
            const mesPassado = new Date(hoje.getFullYear(), hoje.getMonth() - 1, 1);
            document.getElementById('export-data-inicio').value = mesPassado.toISOString().split('T')[0];
            document.getElementById('export-data-fim').value = hoje.toISOString().split('T')[0];
            
            // Eventos de seleção visual
            document.querySelectorAll('.opcao-export input').forEach(radio => {
                radio.addEventListener('change', function() {
                    document.querySelectorAll('.opcao-export-content').forEach(c => {
                        c.style.borderColor = '#e5e5e5';
                        c.style.background = 'white';
                    });
                    this.parentElement.querySelector('.opcao-export-content').style.borderColor = '#10b981';
                    this.parentElement.querySelector('.opcao-export-content').style.background = '#f0fdf4';
                });
            });
        }

        function fecharModalExportar() {
            document.getElementById('modal-exportar').classList.remove('active');
        }

        async function executarExportacao() {
            const formato = document.querySelector('input[name="formato-export"]:checked').value;
            const exportPedidos = document.getElementById('export-pedidos').checked;
            const exportClientes = document.getElementById('export-clientes').checked;
            const exportProdutos = document.getElementById('export-produtos').checked;
            const dataInicio = document.getElementById('export-data-inicio').value;
            const dataFim = document.getElementById('export-data-fim').value;

            if (!exportPedidos && !exportClientes && !exportProdutos) {
                showNotification('Selecione pelo menos um tipo de dados', 'error');
                return;
            }

            showNotification(`Preparando exportação em ${formato.toUpperCase()}...`, 'info');

            try {
                if (formato === 'excel') {
                    await exportarParaExcel(exportPedidos, exportClientes, exportProdutos, dataInicio, dataFim);
                } else {
                    await exportarParaPDF(exportPedidos, exportClientes, exportProdutos, dataInicio, dataFim);
                }
                
                fecharModalExportar();
                showNotification('Exportação concluída!', 'success');
            } catch (error) {
                showNotification('Erro na exportação: ' + error.message, 'error');
            }
        }

        async function exportarParaExcel(pedidos, clientes, produtos, dataInicio, dataFim) {
            // Coletar dados
            const dados = [];
            
            if (pedidos && window.dadosVendas) {
                const todosPedidos = [
                    ...window.dadosVendas.orcamento || [],
                    ...window.dadosVendas.analise || [],
                    ...window.dadosVendas.aprovado || [],
                    ...window.dadosVendas.faturar || [],
                    ...window.dadosVendas.faturado || [],
                    ...window.dadosVendas.recibo || []
                ];
                
                dados.push({
                    sheetName: 'Pedidos',
                    headers: ['ID', 'Cliente', 'Valor', 'Status', 'Data'],
                    rows: todosPedidos.map(p => [p.id, p.cliente, p.valor, p.status || '-', new Date().toLocaleDateString()])
                });
            }

            // Gerar arquivo CSV (simplificado - para Excel completo use SheetJS)
            let csvContent = '';
            dados.forEach(sheet => {
                csvContent += `\n=== ${sheet.sheetName} ===\n`;
                csvContent += sheet.headers.join(';') + '\n';
                sheet.rows.forEach(row => {
                    csvContent += row.join(';') + '\n';
                });
            });

            // Download
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `vendas_export_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
            URL.revokeObjectURL(url);
        }

        async function exportarParaPDF(pedidos, clientes, produtos, dataInicio, dataFim) {
            // Para PDF completo, usar jsPDF ou API do servidor
            // Simplificado: Abrir página de impressão
            const conteudo = [];
            
            if (pedidos && window.dadosVendas) {
                const todosPedidos = [
                    ...window.dadosVendas.orcamento || [],
                    ...window.dadosVendas.analise || [],
                    ...window.dadosVendas.aprovado || [],
                    ...window.dadosVendas.faturar || [],
                    ...window.dadosVendas.faturado || []
                ];
                
                conteudo.push(`<h2>Relatório de Pedidos</h2>`);
                conteudo.push(`<p>Período: ${dataInicio} a ${dataFim}</p>`);
                conteudo.push(`<table border="1" cellpadding="8" cellspacing="0" style="width:100%; border-collapse: collapse;">`);
                conteudo.push(`<tr style="background:#f5f5f5;"><th>ID</th><th>Cliente</th><th>Valor</th><th>Status</th></tr>`);
                
                todosPedidos.forEach(p => {
                    conteudo.push(`<tr><td>${p.id}</td><td>${p.cliente}</td><td>R$ ${(p.valor || 0).toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td><td>${p.status || '-'}</td></tr>`);
                });
                
                conteudo.push(`</table>`);
            }

            // Abrir janela de impressão
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
                    <title>Relatório de Vendas - ALUFORCE</title>
                    <style>
                        body { font-family: Arial, sans-serif; padding: 20px; }
                        h1 { color: #f97316; }
                        table { margin-top: 20px; }
                        th { background: #f97316; color: white; }
                    </style>
                    <script src="/js/anti-copy-protection.js"></script>
    <link rel="stylesheet" href="/css/popup-confirmacao.css">`n</head>
                <body>
                    <h1>ALUFORCE - Vendas</h1>
                    <p>Gerado em: ${new Date().toLocaleString('pt-BR')}</p>
                    ${conteudo.join('')}
                    <script src="/js/popup-confirmacao.js"></script>`n</body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }

        // Eventos dos modais de exportação
        document.getElementById('modal-exportar')?.addEventListener('click', function(e) {
            if (e.target === this) fecharModalExportar();
        });

        document.getElementById('modal-novo-cliente')?.addEventListener('click', function(e) {
            if (e.target === this) fecharModalNovoCliente();
        });

        document.getElementById('modal-novo-produto')?.addEventListener('click', function(e) {
            if (e.target === this) fecharModalNovoProduto();
        });

        // ========================================
        // INIT
        // ========================================
        document.addEventListener('DOMContentLoaded', () => {
            // Carregar dados do usuário logado via API
            carregarUsuarioLogado();

            // Carregar dados do Kanban da API e renderizar
            carregarDadosKanban();
            
            // Inicializar sistema de notificações
            inicializarNotificacoes();
            
            // Verificar se deve abrir modal de novo orçamento (vindo de outra página)
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('novo') === 'true') {
                // Limpar parâmetro da URL sem recarregar
                window.history.replaceState({}, document.title, window.location.pathname);
                // Aguardar um pouco para garantir que tudo está carregado
                setTimeout(() => {
                    novoOrcamento();
                }, 500);
            }
        });
    </script>
    
    <!-- Font Awesome para ícones do chat/suporte -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    
    <!-- Sistema de Chat e Suporte (widgets condicionais por usuário) -->
    <script src="/js/chat-suporte-widgets.js?v=20260103"></script>
    
    <!-- Sistema de Monitoramento de Conexão -->
    <script src="../../_shared/connection-monitor.js?v=20251223"></script>
    <script src="/js/popup-confirmacao.js"></script>`n</body>
</html>

