<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <link rel="icon" type="image/x-icon" href="/favicon-aluforce.webp">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>ALUFORCE - Planejamento e Controle da Produção</title>
    
    <!-- CSP Fix - Converter onclick inline para addEventListener -->
    <link rel="stylesheet" href="../_shared/modern-saas.css?v=3.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <style>
        /* ============================================
           VARIíVEIS CSS - DESIGN SYSTEM ALUFORCE
           ============================================ */
        :root {
            /* Cores Primárias - Vermelho */
            --primary-50: #fef2f2;
            --primary-100: #fee2e2;
            --primary-200: #fecaca;
            --primary-300: #fca5a5;
            --primary-400: #f87171;
            --primary-500: #ef4444;
            --primary-600: #dc2626;
            --primary-700: #b91c1c;
            --primary-800: #991b1b;
            --primary-900: #7f1d1d;
            
            /* Cores de Estado */
            --success-500: #10b981;
            --success-600: #059669;
            --warning-500: #f59e0b;
            --warning-600: #d97706;
            --danger-500: #ef4444;
            --danger-600: #dc2626;
            --info-500: #06b6d4;
            --info-600: #0891b2;
            
            /* Neutros */
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
            --gray-500: #6b7280;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --gray-900: #111827;
            
            /* Dark Theme */
            --dark-bg: #0f172a;
            --dark-surface: #1e293b;
            --dark-border: #334155;
            
            /* Spacing */
            --space-1: 0.25rem;
            --space-2: 0.5rem;
            --space-3: 0.75rem;
            --space-4: 1rem;
            --space-5: 1.25rem;
            --space-6: 1.5rem;
            --space-8: 2rem;
            --space-10: 2.5rem;
            --space-12: 3rem;
            
            /* Border Radius */
            --radius-sm: 0.375rem;
            --radius-md: 0.5rem;
            --radius-lg: 0.75rem;
            --radius-xl: 1rem;
            --radius-2xl: 1.5rem;
            
            /* Shadows */
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
            
            /* Transitions */
            --transition-fast: 150ms cubic-bezier(0.4, 0, 0.2, 1);
            --transition-base: 200ms cubic-bezier(0.4, 0, 0.2, 1);
            --transition-slow: 300ms cubic-bezier(0.4, 0, 0.2, 1);
            
            /* Layout */
            --sidebar-width: 56px;
            --header-height: 56px;
        }

        /* ============================================
           RESET E BASE
           ============================================ */
        *, *::before, *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html {
            font-size: 16px;
            scroll-behavior: smooth;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--gray-50);
            color: var(--gray-900);
            line-height: 1.5;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* ============================================
           APP CONTAINER - LAYOUT PRINCIPAL
           ============================================ */
        .app-container {
            display: flex;
            min-height: 100vh;
        }

        /* ============================================
           SIDEBAR - ESTILO INSTITUCIONAL
           ============================================ */
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            width: var(--sidebar-width);
            height: 100vh;
            background: linear-gradient(180deg, var(--dark-bg) 0%, #0c1222 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: var(--space-4) 0;
            z-index: 1000;
            border-right: 1px solid var(--dark-border);
        }

        .sidebar-logo {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #dc2626, #b91c1c);
            border-radius: var(--radius-lg);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: var(--space-6);
            cursor: pointer;
            transition: all var(--transition-base);
            text-decoration: none;
        }

        .sidebar-logo:hover {
            transform: scale(1.05);
            box-shadow: 0 0 20px rgba(220, 38, 38, 0.4);
        }

        .sidebar-logo i {
            color: white;
            font-size: 18px;
        }

        .sidebar-nav {
            display: flex;
            flex-direction: column;
            gap: var(--space-2);
            flex: 1;
            width: 100%;
            padding: 0 8px;
            align-items: center;
        }

        .sidebar-btn {
            width: 40px;
            height: 40px;
            border: none;
            background: transparent;
            color: var(--gray-400);
            border-radius: var(--radius-lg);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: all var(--transition-base);
            position: relative;
            text-decoration: none;
        }

        .sidebar-btn:hover {
            background: rgba(255, 255, 255, 0.08);
            color: white;
        }

        .sidebar-btn.active {
            background: linear-gradient(135deg, var(--primary-500), var(--primary-600));
            color: white;
            box-shadow: 0 4px 12px rgba(220, 38, 38, 0.3);
        }

        .sidebar-btn::after {
            content: attr(title);
            position: absolute;
            left: 54px;
            background: var(--gray-900);
            color: white;
            padding: 6px 12px;
            border-radius: var(--radius-md);
            font-size: 12px;
            font-weight: 500;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: all var(--transition-base);
            z-index: 1001;
        }

        .sidebar-btn:hover::after {
            opacity: 1;
        }

        .sidebar-divider {
            width: 32px;
            height: 1px;
            background: var(--dark-border);
            margin: var(--space-4) auto;
        }

        .sidebar-bottom {
            margin-top: auto;
            display: flex;
            flex-direction: column;
            gap: var(--space-2);
            padding: 0 8px;
            width: 100%;
            align-items: center;
        }

        /* ============================================
           HEADER - ESTILO INSTITUCIONAL
           ============================================ */
        .header {
            position: fixed;
            top: 0;
            left: var(--sidebar-width);
            right: 0;
            height: 56px;
            background: var(--dark-bg);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            z-index: 999;
            border-bottom: 1px solid var(--dark-border);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .header-brand {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .header-brand img {
            height: 22px;
            object-fit: contain;
        }

        .header-brand-divider {
            color: var(--gray-600);
            font-weight: 300;
        }

        .header-brand-module {
            color: var(--gray-400);
            font-size: 14px;
            font-weight: 500;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }

        .header-btn {
            width: 36px;
            height: 36px;
            border: none;
            background: transparent;
            color: var(--gray-400);
            border-radius: var(--radius-md);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            transition: all var(--transition-base);
            position: relative;
        }

        .header-btn:hover {
            background: rgba(255, 255, 255, 0.08);
            color: white;
        }

        .header-btn .notification-badge {
            position: absolute;
            top: 4px;
            right: 4px;
            min-width: 16px;
            height: 16px;
            background: var(--danger-500);
            color: white;
            font-size: 10px;
            font-weight: 600;
            border-radius: 999px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 4px;
        }

        .header-user {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            margin-left: var(--space-4);
            padding-left: var(--space-4);
            border-left: 1px solid var(--dark-border);
        }

        .header-user-info {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
        }

        .header-user-greeting {
            font-size: 11px;
            color: var(--gray-500);
        }

        .header-user-name {
            font-size: 13px;
            font-weight: 600;
            color: white;
        }

        .header-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-500), var(--primary-600));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            overflow: hidden;
            transition: all var(--transition-base);
        }

        .header-avatar:hover {
            transform: scale(1.05);
            box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.3);
        }

        .header-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* User greeting e avatar - estilo Omie */
        .user-greeting {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
            color: #8b8b9a;
            margin-left: 12px;
            padding-left: 12px;
            border-left: 1px solid rgba(255,255,255,0.1);
        }
        
        .user-greeting strong {
            color: white;
        }
        
        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-500), var(--primary-600));
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            margin-left: 12px;
        }
        
        .user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .user-avatar span {
            color: white;
            font-weight: 600;
            font-size: 14px;
        }

        /* ============================================
           NOTIFICATION PANEL - PADRÃO VENDAS
           ============================================ */
        .notification-container {
            position: relative;
        }

        .notification-panel {
            position: fixed;
            top: 60px;
            right: 20px;
            width: 360px;
            max-height: 480px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            z-index: 99999;
            display: none;
            overflow: hidden;
        }

        .notification-panel.active {
            display: block;
        }

        .notification-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            background: linear-gradient(135deg, var(--primary-500), var(--primary-600));
            color: white;
        }

        .notification-header h3 {
            margin: 0;
            font-size: 16px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .notification-actions {
            display: flex;
            gap: 8px;
        }

        .notification-actions button {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .notification-actions button:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .notification-list {
            max-height: 340px;
            overflow-y: auto;
        }

        .notification-item {
            display: flex;
            gap: 12px;
            padding: 14px 20px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: all 0.2s;
        }

        .notification-item:hover {
            background: #f8f8f8;
        }

        .notification-empty {
            padding: 40px 20px;
            text-align: center;
            color: #888;
        }

        .notification-empty i {
            font-size: 40px;
            margin-bottom: 12px;
            color: #10b981;
        }

        .notification-empty p {
            margin: 0;
            font-size: 14px;
        }

        /* ============================================
           MAIN AREA - PADRÃO VENDAS
           ============================================ */
        .main-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            margin-left: var(--sidebar-width);
            min-height: 100vh;
        }

        /* ============================================
           MAIN CONTENT AREA
           ============================================ */
        .main-content {
            flex: 1;
            overflow-y: auto;
            background: var(--gray-50);
            margin-top: var(--header-height);
            min-height: calc(100vh - var(--header-height));
        }

        .page-content {
            padding: var(--space-8);
            max-width: 1600px;
            margin: 0 auto;
        }

        /* ============================================
           PAGE HEADER
           ============================================ */
        .page-header {
            margin-bottom: var(--space-8);
        }

        .page-header-top {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            margin-bottom: var(--space-6);
        }

        .page-title-wrapper {
            display: flex;
            align-items: center;
            gap: var(--space-4);
        }

        .page-icon {
            width: 56px;
            height: 56px;
            border-radius: var(--radius-xl);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
        }

        .page-icon.blue { background: linear-gradient(135deg, var(--primary-500), var(--primary-600)); }
        .page-icon.green { background: linear-gradient(135deg, var(--success-500), var(--success-600)); }
        .page-icon.orange { background: linear-gradient(135deg, var(--warning-500), var(--warning-600)); }
        .page-icon.red { background: linear-gradient(135deg, var(--danger-500), var(--danger-600)); }
        .page-icon.cyan { background: linear-gradient(135deg, var(--info-500), var(--info-600)); }
        .page-icon.purple { background: linear-gradient(135deg, #8b5cf6, #7c3aed); }

        .page-title {
            font-size: 28px;
            font-weight: 700;
            color: var(--gray-900);
            margin: 0 0 var(--space-1) 0;
        }

        .page-subtitle {
            font-size: 14px;
            color: var(--gray-500);
            margin: 0;
        }

        .page-actions {
            display: flex;
            gap: var(--space-3);
        }

        /* ============================================
           BUTTONS
           ============================================ */
        .btn {
            display: inline-flex;
            align-items: center;
            gap: var(--space-2);
            padding: var(--space-3) var(--space-5);
            font-size: 14px;
            font-weight: 600;
            border-radius: var(--radius-lg);
            border: none;
            cursor: pointer;
            transition: all var(--transition-base);
            text-decoration: none;
            white-space: nowrap;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-500), var(--primary-600));
            color: white;
            box-shadow: 0 4px 14px rgba(220, 38, 38, 0.25);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(220, 38, 38, 0.35);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success-500), var(--success-600));
            color: white;
            box-shadow: 0 4px 14px rgba(16, 185, 129, 0.25);
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.35);
        }

        .btn-secondary {
            background: white;
            color: var(--gray-700);
            border: 1px solid var(--gray-300);
        }

        .btn-secondary:hover {
            background: var(--gray-50);
            border-color: var(--gray-400);
        }

        .btn-outline {
            background: transparent;
            color: var(--primary-600);
            border: 2px solid var(--primary-500);
        }

        .btn-outline:hover {
            background: var(--primary-50);
        }

        .btn-sm {
            padding: var(--space-2) var(--space-3);
            font-size: 13px;
        }

        .btn-lg {
            padding: var(--space-4) var(--space-6);
            font-size: 15px;
        }

        /* ============================================
           CARDS
           ============================================ */
        .card {
            background: white;
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--gray-200);
            transition: all var(--transition-base);
            overflow: hidden;
        }

        .card:hover {
            box-shadow: var(--shadow-md);
        }

        .card-header {
            padding: var(--space-5) var(--space-6);
            border-bottom: 1px solid var(--gray-100);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .card-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--gray-900);
            display: flex;
            align-items: center;
            gap: var(--space-3);
        }

        .card-title i {
            color: var(--primary-500);
        }

        .card-body {
            padding: var(--space-6);
        }

        .card-footer {
            padding: var(--space-4) var(--space-6);
            border-top: 1px solid var(--gray-100);
            background: var(--gray-50);
        }

        /* ============================================
           STATS CARDS
           ============================================ */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: var(--space-6);
            margin-bottom: var(--space-8);
        }

        @media (max-width: 1200px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 640px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }

        .stat-card {
            background: white;
            border-radius: var(--radius-xl);
            padding: var(--space-6);
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--gray-200);
            display: flex;
            align-items: center;
            gap: var(--space-5);
            transition: all var(--transition-base);
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
        }

        .stat-card.blue::before { background: linear-gradient(180deg, var(--primary-400), var(--primary-600)); }
        .stat-card.green::before { background: linear-gradient(180deg, var(--success-400), var(--success-600)); }
        .stat-card.orange::before { background: linear-gradient(180deg, var(--warning-400), var(--warning-600)); }
        .stat-card.red::before { background: linear-gradient(180deg, var(--danger-400), var(--danger-600)); }
        .stat-card.cyan::before { background: linear-gradient(180deg, var(--info-400), var(--info-600)); }
        .stat-card.purple::before { background: linear-gradient(180deg, #a78bfa, #7c3aed); }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }

        .stat-icon {
            width: 56px;
            height: 56px;
            border-radius: var(--radius-lg);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
            flex-shrink: 0;
        }

        .stat-icon.blue { background: linear-gradient(135deg, var(--primary-500), var(--primary-600)); }
        .stat-icon.green { background: linear-gradient(135deg, var(--success-500), var(--success-600)); }
        .stat-icon.orange { background: linear-gradient(135deg, var(--warning-500), var(--warning-600)); }
        .stat-icon.red { background: linear-gradient(135deg, var(--danger-500), var(--danger-600)); }
        .stat-icon.cyan { background: linear-gradient(135deg, var(--info-500), var(--info-600)); }
        .stat-icon.purple { background: linear-gradient(135deg, #8b5cf6, #7c3aed); }

        .stat-content {
            flex: 1;
        }

        .stat-label {
            font-size: 13px;
            font-weight: 500;
            color: var(--gray-500);
            margin-bottom: var(--space-1);
        }

        .stat-value {
            font-size: 28px;
            font-weight: 700;
            color: var(--gray-900);
            line-height: 1.2;
        }

        .stat-trend {
            display: flex;
            align-items: center;
            gap: var(--space-1);
            font-size: 12px;
            font-weight: 600;
            margin-top: var(--space-2);
        }

        .stat-trend.up { color: var(--success-600); }
        .stat-trend.down { color: var(--danger-600); }
        .stat-trend.neutral { color: var(--gray-500); }

        /* ============================================
           CONTENT GRID
           ============================================ */
        .content-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--space-6);
        }

        @media (max-width: 1024px) {
            .content-grid {
                grid-template-columns: 1fr;
            }
        }

        .content-grid-3 {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: var(--space-6);
        }

        @media (max-width: 1200px) {
            .content-grid-3 {
                grid-template-columns: 1fr 1fr;
            }
        }

        @media (max-width: 768px) {
            .content-grid-3 {
                grid-template-columns: 1fr;
            }
        }

        /* ============================================
           QUICK ACTIONS
           ============================================ */
        .quick-actions-list {
            display: flex;
            flex-direction: column;
            gap: var(--space-3);
        }

        .quick-action-btn {
            display: flex;
            align-items: center;
            gap: var(--space-4);
            padding: var(--space-4);
            background: var(--gray-50);
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-lg);
            cursor: pointer;
            transition: all var(--transition-base);
            text-align: left;
            width: 100%;
        }

        .quick-action-btn:hover {
            background: white;
            border-color: var(--primary-300);
            box-shadow: var(--shadow-md);
            transform: translateX(4px);
        }

        .quick-action-icon {
            width: 44px;
            height: 44px;
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: white;
            flex-shrink: 0;
        }

        .quick-action-content {
            flex: 1;
        }

        .quick-action-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--gray-900);
            margin-bottom: 2px;
        }

        .quick-action-desc {
            font-size: 12px;
            color: var(--gray-500);
        }

        .quick-action-btn i.fa-chevron-right {
            color: var(--gray-400);
            font-size: 12px;
            transition: transform var(--transition-base);
        }

        .quick-action-btn:hover i.fa-chevron-right {
            transform: translateX(4px);
            color: var(--primary-500);
        }

        /* ============================================
           TABLES
           ============================================ */
        .table-container {
            overflow-x: auto;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table thead th {
            background: var(--gray-50);
            padding: var(--space-3) var(--space-4);
            text-align: left;
            font-size: 12px;
            font-weight: 600;
            color: var(--gray-600);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            border-bottom: 2px solid var(--gray-200);
        }

        .data-table tbody td {
            padding: var(--space-4);
            border-bottom: 1px solid var(--gray-100);
            font-size: 14px;
            color: var(--gray-700);
        }

        .data-table tbody tr:hover {
            background: var(--gray-50);
        }

        .data-table tbody tr:last-child td {
            border-bottom: none;
        }

        /* ============================================
           BADGES
           ============================================ */
        .badge {
            display: inline-flex;
            align-items: center;
            padding: var(--space-1) var(--space-3);
            font-size: 11px;
            font-weight: 600;
            border-radius: 999px;
            text-transform: uppercase;
            letter-spacing: 0.025em;
        }

        .badge-primary { background: var(--primary-100); color: var(--primary-700); }
        .badge-success { background: #dcfce7; color: #166534; }
        .badge-warning { background: #fef3c7; color: #92400e; }
        .badge-danger { background: #fee2e2; color: #991b1b; }
        .badge-info { background: #cffafe; color: #155e75; }
        .badge-gray { background: var(--gray-100); color: var(--gray-700); }

        /* Status Badges para Ordens Recentes */
        .status-badge {
            display: inline-flex;
            align-items: center;
            padding: 4px 10px;
            font-size: 11px;
            font-weight: 600;
            border-radius: 999px;
            text-transform: uppercase;
            letter-spacing: 0.025em;
        }
        .status-badge.gray { background: var(--gray-100); color: var(--gray-700); }
        .status-badge.blue { background: #dbeafe; color: #1e40af; }
        .status-badge.yellow { background: #fef3c7; color: #92400e; }
        .status-badge.orange { background: #fed7aa; color: #c2410c; }
        .status-badge.green { background: #dcfce7; color: #166534; }
        .status-badge.purple { background: #ede9fe; color: #6d28d9; }
        .status-badge.red { background: #fee2e2; color: #991b1b; }

        /* ============================================
           ALERTS
           ============================================ */
        .alert-item {
            display: flex;
            align-items: center;
            gap: var(--space-4);
            padding: var(--space-4);
            background: white;
            border-radius: var(--radius-lg);
            border-left: 4px solid;
            margin-bottom: var(--space-3);
            transition: all var(--transition-base);
        }

        .alert-item:hover {
            box-shadow: var(--shadow-md);
        }

        .alert-item.warning {
            border-color: var(--warning-500);
            background: linear-gradient(90deg, #fffbeb, white);
        }

        .alert-item.danger {
            border-color: var(--danger-500);
            background: linear-gradient(90deg, #fef2f2, white);
        }

        .alert-item.info {
            border-color: var(--info-500);
            background: linear-gradient(90deg, #ecfeff, white);
        }

        .alert-item.success {
            border-color: var(--success-500);
            background: linear-gradient(90deg, #f0fdf4, white);
        }

        .alert-icon {
            width: 40px;
            height: 40px;
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            flex-shrink: 0;
        }

        .alert-item.warning .alert-icon { background: var(--warning-100); color: var(--warning-600); }
        .alert-item.danger .alert-icon { background: var(--danger-100); color: var(--danger-600); }
        .alert-item.info .alert-icon { background: var(--info-100); color: var(--info-600); }
        .alert-item.success .alert-icon { background: var(--success-100); color: var(--success-600); }

        .alert-content {
            flex: 1;
        }

        .alert-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--gray-900);
            margin-bottom: 2px;
        }

        .alert-desc {
            font-size: 12px;
            color: var(--gray-500);
        }

        /* ============================================
           EMPTY STATE
           ============================================ */
        .empty-state {
            text-align: center;
            padding: var(--space-12) var(--space-6);
        }

        .empty-state-icon {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: var(--gray-100);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            color: var(--gray-400);
            margin: 0 auto var(--space-6);
        }

        .empty-state-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--gray-900);
            margin-bottom: var(--space-2);
        }

        .empty-state-desc {
            font-size: 14px;
            color: var(--gray-500);
            max-width: 320px;
            margin: 0 auto;
        }

        /* ============================================
           VIEWS - PíGINA ESCONDIDA
           ============================================ */
        .view {
            display: none;
        }

        .view.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ============================================
           SEARCH BAR
           ============================================ */
        .search-bar {
            display: flex;
            gap: var(--space-4);
            margin-bottom: var(--space-6);
        }

        .search-input-wrapper {
            position: relative;
            flex: 1;
        }

        .search-input-wrapper i {
            position: absolute;
            left: var(--space-4);
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray-400);
        }

        .search-input {
            width: 100%;
            padding: var(--space-3) var(--space-4) var(--space-3) var(--space-10);
            font-size: 14px;
            border: 1px solid var(--gray-300);
            border-radius: var(--radius-lg);
            background: white;
            transition: all var(--transition-base);
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary-500);
            box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.1);
        }

        .filter-select {
            padding: var(--space-3) var(--space-4);
            font-size: 14px;
            border: 1px solid var(--gray-300);
            border-radius: var(--radius-lg);
            background: white;
            min-width: 180px;
            cursor: pointer;
        }

        .filter-select:focus {
            outline: none;
            border-color: var(--primary-500);
        }

        /* ============================================
           TABS
           ============================================ */
        .tabs {
            display: flex;
            gap: var(--space-1);
            padding: var(--space-1);
            background: var(--gray-100);
            border-radius: var(--radius-lg);
            margin-bottom: var(--space-6);
        }

        .tab-btn {
            flex: 1;
            padding: var(--space-3) var(--space-4);
            font-size: 14px;
            font-weight: 500;
            color: var(--gray-600);
            background: transparent;
            border: none;
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all var(--transition-base);
        }

        .tab-btn:hover {
            color: var(--gray-900);
        }

        .tab-btn.active {
            background: white;
            color: var(--primary-600);
            box-shadow: var(--shadow-sm);
        }

        /* ============================================
           MODAL - FIX OVERLAY
           ============================================ */
        body.modal-open {
            overflow: hidden;
        }

        /* ============================================
           MODAL
           ============================================ */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            padding: var(--space-6);
        }

        .modal-overlay.active {
            display: flex;
            animation: fadeIn 0.2s ease;
        }

        .modal {
            background: white;
            border-radius: var(--radius-2xl);
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow: hidden;
            box-shadow: var(--shadow-xl);
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from { transform: translateY(-20px) scale(0.95); opacity: 0; }
            to { transform: translateY(0) scale(1); opacity: 1; }
        }

        .modal-header {
            padding: var(--space-6);
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .modal-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--gray-900);
        }

        .modal-close {
            width: 32px;
            height: 32px;
            border: none;
            background: var(--gray-100);
            color: var(--gray-500);
            border-radius: var(--radius-md);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--transition-base);
        }

        .modal-close:hover {
            background: var(--gray-200);
            color: var(--gray-700);
        }

        .modal-body {
            padding: var(--space-6);
            overflow-y: auto;
            max-height: calc(90vh - 180px);
        }

        .modal-footer {
            padding: var(--space-4) var(--space-6);
            border-top: 1px solid var(--gray-200);
            display: flex;
            gap: var(--space-3);
            justify-content: flex-end;
            background: #fafafa;
            border-radius: 0 0 16px 16px;
        }

        /* ============================================
           FORM SECTIONS
           ============================================ */
        .form-section {
            margin-top: 24px;
            padding-top: 24px;
            border-top: 1px solid var(--gray-200);
        }

        .form-section-title {
            font-size: 15px;
            font-weight: 600;
            color: var(--gray-800);
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .form-section-title i {
            color: var(--primary-500);
        }

        .form-row-2 {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
        }

        @media (max-width: 768px) {
            .form-row-2 {
                grid-template-columns: 1fr;
            }
        }

        /* ============================================
           MODAL NOVA ORDEM DE PRODUÇÃO - ESTILO MODERNO
           ============================================ */
        #modal-nova-ordem {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            right: 0 !important;
            bottom: 0 !important;
            z-index: 99999 !important;
        }

        .modal-op-wrapper {
            display: flex;
            width: 95%;
            max-width: 1200px;
            max-height: 92vh;
            background: white;
            border-radius: 16px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            animation: modalSlideIn 0.3s ease;
            overflow: hidden;
        }

        .modal-op-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            min-width: 0;
        }

        .modal-op-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 24px;
            background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);
            color: white;
        }

        .modal-op-title {
            font-size: 18px;
            font-weight: 600;
            color: white;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .modal-op-close {
            background: rgba(255,255,255,0.15);
            border: none;
            font-size: 14px;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 8px;
            transition: all 0.2s;
        }

        .modal-op-close:hover {
            background: rgba(255,255,255,0.25);
        }

        .modal-op-body {
            flex: 1;
            padding: 24px;
            overflow-y: auto;
            background: #f8f9fa;
        }

        .modal-op-section {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        }

        .modal-op-product-row {
            display: flex;
            align-items: flex-end;
            gap: 16px;
            flex-wrap: wrap;
        }

        .modal-op-avatar {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, #dc2626, #991b1b);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 16px;
            flex-shrink: 0;
        }

        .modal-op-product-field {
            flex: 1;
            min-width: 200px;
        }

        .modal-op-label {
            display: block;
            font-size: 13px;
            font-weight: 500;
            color: #64748b;
            margin-bottom: 6px;
        }

        .modal-op-label i {
            font-size: 11px;
            color: #94a3b8;
            margin-left: 4px;
        }

        .modal-op-input-lg {
            width: 100%;
            padding: 12px 16px;
            font-size: 14px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            background: white;
            transition: all 0.2s;
        }

        .modal-op-input-lg:focus {
            outline: none;
            border-color: #dc2626;
            box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.1);
        }

        .modal-op-date-field {
            min-width: 180px;
        }

        .modal-op-input-date {
            width: 100%;
            padding: 12px 16px;
            font-size: 14px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            background: white;
            cursor: pointer;
        }

        .modal-op-values-row {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }

        .modal-op-value-field {
            flex: 1;
            min-width: 140px;
            background: white;
            border-radius: 10px;
            padding: 14px 16px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        }

        .modal-op-value-field label {
            display: block;
            font-size: 12px;
            font-weight: 500;
            color: #64748b;
            margin-bottom: 6px;
        }

        .modal-op-value-field input,
        .modal-op-value-field select {
            width: 100%;
            padding: 8px 0;
            font-size: 15px;
            font-weight: 600;
            color: #1e293b;
            border: none;
            background: transparent;
        }

        .modal-op-value-field input:focus,
        .modal-op-value-field select:focus {
            outline: none;
        }

        /* Abas */
        .modal-op-tabs {
            display: flex;
            gap: 0;
            background: white;
            border-radius: 12px 12px 0 0;
            border-bottom: 2px solid #e2e8f0;
            overflow-x: auto;
        }

        .modal-op-tab {
            padding: 14px 20px;
            font-size: 14px;
            font-weight: 500;
            color: #64748b;
            background: transparent;
            border: none;
            cursor: pointer;
            position: relative;
            transition: all 0.2s;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .modal-op-tab:hover {
            color: #1e293b;
            background: #f8fafc;
        }

        .modal-op-tab.active {
            color: #dc2626;
        }

        .modal-op-tab.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 2px;
            background: #dc2626;
        }

        .modal-op-tab-content {
            background: white;
            border-radius: 0 0 12px 12px;
            min-height: 300px;
        }

        .modal-op-tab-pane {
            display: none;
        }

        .modal-op-tab-pane.active {
            display: block;
        }

        .modal-op-tab-actions {
            display: flex;
            gap: 10px;
            padding: 16px 20px;
            border-bottom: 1px solid #f1f5f9;
        }

        .modal-op-btn-action {
            padding: 8px 16px;
            font-size: 13px;
            font-weight: 600;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
        }

        .modal-op-btn-action.add {
            background: #dc2626;
            color: white;
        }

        .modal-op-btn-action.add:hover {
            background: #b91c1c;
        }

        .modal-op-btn-action.edit {
            background: #10b981;
            color: white;
        }

        .modal-op-btn-action.edit:hover {
            background: #059669;
        }

        .modal-op-btn-action.delete {
            background: #ef4444;
            color: white;
        }

        .modal-op-btn-action.delete:hover {
            background: #dc2626;
        }

        .modal-op-table-container {
            overflow-x: auto;
        }

        .modal-op-table {
            width: 100%;
            border-collapse: collapse;
        }

        .modal-op-table thead {
            background: #f8fafc;
        }

        .modal-op-table th {
            padding: 12px 16px;
            text-align: left;
            font-size: 13px;
            font-weight: 600;
            color: #475569;
            border-bottom: 1px solid #e2e8f0;
            white-space: nowrap;
        }

        .modal-op-table tbody tr {
            border-bottom: 1px solid #f1f5f9;
        }

        .modal-op-table tbody tr:hover {
            background: #f8fafc;
        }

        .modal-op-table td {
            padding: 12px 16px;
            font-size: 14px;
            color: #334155;
        }

        /* Campos inline editáveis na tabela de produtos */
        .embalagem-inline-select {
            width: 100%;
            padding: 6px 8px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 13px;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
        }
        .embalagem-inline-select:hover {
            border-color: #3b82f6;
        }
        .embalagem-inline-select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.1);
        }
        
        .lances-inline-input {
            width: 100%;
            padding: 6px 8px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 13px;
            transition: all 0.2s;
        }
        .lances-inline-input:hover {
            border-color: #3b82f6;
        }
        .lances-inline-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.1);
        }
        .lances-inline-input::placeholder {
            color: #94a3b8;
            font-size: 12px;
        }

        .modal-op-empty-row td {
            text-align: center;
            padding: 48px 16px;
            color: #94a3b8;
        }

        .modal-op-empty-row i {
            font-size: 32px;
            display: block;
            margin-bottom: 12px;
        }

        .modal-op-info-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
            padding: 20px;
        }

        .modal-op-info-field {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .modal-op-info-field label {
            font-size: 13px;
            font-weight: 500;
            color: #64748b;
        }

        .modal-op-info-field input,
        .modal-op-info-field select,
        .modal-op-info-field textarea {
            padding: 12px 16px;
            font-size: 14px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            background: white;
        }

        .modal-op-info-field input:focus,
        .modal-op-info-field select:focus,
        .modal-op-info-field textarea:focus {
            outline: none;
            border-color: #dc2626;
            box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.1);
        }

        /* ===== Autocomplete Styles ===== */
        .autocomplete-container {
            position: relative;
            width: 100%;
        }
        
        .autocomplete-container input {
            width: 100%;
            padding-right: 40px;
        }
        
        .autocomplete-dropdown {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            max-height: 300px;
            overflow-y: auto;
            background: white;
            border: 1px solid #e2e8f0;
            border-top: none;
            border-radius: 0 0 8px 8px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            z-index: 1000;
        }
        
        .autocomplete-item {
            padding: 12px 16px;
            cursor: pointer;
            border-bottom: 1px solid #f1f5f9;
            transition: all 0.15s ease;
        }
        
        .autocomplete-item:last-child {
            border-bottom: none;
        }
        
        .autocomplete-item:hover {
            background: linear-gradient(135deg, #fef2f2, #fee2e2);
        }
        
        .autocomplete-item.no-results {
            color: #94a3b8;
            text-align: center;
            cursor: default;
        }
        
        .autocomplete-item.no-results:hover {
            background: white;
        }
        
        .autocomplete-item-main {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 4px;
        }
        
        .autocomplete-item-main i {
            color: #dc2626;
            font-size: 14px;
        }
        
        .autocomplete-nome {
            font-weight: 600;
            color: #1e293b;
            font-size: 14px;
        }
        
        .autocomplete-item-info {
            display: flex;
            gap: 16px;
            padding-left: 24px;
        }
        
        .autocomplete-cnpj {
            font-size: 12px;
            color: #64748b;
            font-family: 'Monaco', 'Consolas', monospace;
        }
        
        .autocomplete-cidade {
            font-size: 12px;
            color: #94a3b8;
        }

        /* ===== Selects de Vendedor e Frete ===== */
        .op-select-vendedor,
        .op-select-frete {
            width: 100%;
            padding: 10px 12px;
            font-size: 15px;
            font-weight: 600;
            color: #1e293b;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23475569' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            padding-right: 36px;
        }
        
        .op-select-vendedor:focus,
        .op-select-frete:focus {
            outline: none;
            border-color: #dc2626;
            box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.1);
        }
        
        .op-select-vendedor:hover,
        .op-select-frete:hover {
            border-color: #cbd5e1;
        }

        /* ===== Modal de Produto ===== */
        #modal-produto-op {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            z-index: 10000;
            align-items: center;
            justify-content: center;
        }
        
        #modal-produto-op.active {
            display: flex;
        }
        
        .modal-produto-container {
            background: white;
            border-radius: 16px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25);
            overflow: hidden;
            animation: modalSlideIn 0.3s ease;
        }
        
        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-20px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        
        .modal-produto-header {
            background: linear-gradient(135deg, #dc2626, #991b1b);
            color: white;
            padding: 20px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-produto-header h3 {
            margin: 0;
            font-size: 18px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .modal-produto-header h3 i {
            font-size: 20px;
        }
        
        .modal-produto-close {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 36px;
            height: 36px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        
        .modal-produto-close:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .modal-produto-body {
            padding: 24px;
        }
        
        .modal-produto-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .modal-produto-field {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .modal-produto-field.full-width {
            grid-column: span 2;
        }
        
        .modal-produto-field label {
            font-size: 13px;
            font-weight: 600;
            color: #475569;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .modal-produto-field label i {
            color: #dc2626;
            font-size: 12px;
        }
        
        .modal-produto-field label .required {
            color: #dc2626;
        }
        
        .modal-produto-field input,
        .modal-produto-field select {
            padding: 12px 16px;
            font-size: 14px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            transition: all 0.2s;
        }
        
        .modal-produto-field input:focus,
        .modal-produto-field select:focus {
            outline: none;
            border-color: #dc2626;
            box-shadow: 0 0 0 4px rgba(220, 38, 38, 0.1);
        }
        
        .modal-produto-field input::placeholder {
            color: #94a3b8;
        }
        
        .modal-produto-field select {
            background: white;
            cursor: pointer;
        }
        
        .modal-produto-total {
            padding: 12px 16px;
            font-size: 18px;
            font-weight: 700;
            color: #059669;
            background: linear-gradient(135deg, #ecfdf5, #d1fae5);
            border: 2px solid #a7f3d0;
            border-radius: 10px;
            text-align: center;
        }
        
        .modal-produto-footer {
            padding: 16px 24px;
            background: #f8fafc;
            border-top: 1px solid #e2e8f0;
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }
        
        .modal-produto-footer .btn-cancelar {
            padding: 12px 24px;
            font-size: 14px;
            font-weight: 600;
            color: #64748b;
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
        }
        
        .modal-produto-footer .btn-cancelar:hover {
            background: #f1f5f9;
            border-color: #cbd5e1;
        }
        
        .modal-produto-footer .btn-salvar {
            padding: 12px 32px;
            font-size: 14px;
            font-weight: 600;
            color: white;
            background: linear-gradient(135deg, #dc2626, #b91c1c);
            border: none;
            border-radius: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
            box-shadow: 0 4px 12px rgba(220, 38, 38, 0.3);
        }
        
        .modal-produto-footer .btn-salvar:hover {
            background: linear-gradient(135deg, #b91c1c, #991b1b);
            transform: translateY(-1px);
            box-shadow: 0 6px 16px rgba(220, 38, 38, 0.4);
        }
        
        /* Estilos adicionais para tabela de produtos */
        .prod-codigo-cell {
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 12px;
            background: #f1f5f9;
            padding: 4px 8px;
            border-radius: 4px;
            color: #475569;
        }
        
        .text-center { text-align: center; }
        .text-right { text-align: right; }
        .font-semibold { font-weight: 600; }

        .modal-op-obs-field {
            padding: 20px;
        }

        .modal-op-obs-field label {
            display: block;
            font-size: 13px;
            font-weight: 500;
            color: #64748b;
            margin-bottom: 8px;
        }

        .modal-op-obs-field textarea {
            width: 100%;
            padding: 14px 16px;
            font-size: 14px;
            font-family: inherit;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            resize: vertical;
            min-height: 150px;
        }

        .modal-op-obs-field textarea:focus {
            outline: none;
            border-color: #dc2626;
            box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.1);
        }

        /* Sidebar */
        .modal-op-sidebar {
            width: 150px;
            background: #f8fafc;
            border-left: 1px solid #e2e8f0;
            padding: 16px 12px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            overflow-y: auto;
            flex-shrink: 0;
        }

        .modal-op-sidebar-btn {
            width: 100%;
            padding: 10px 12px;
            font-size: 12px;
            font-weight: 500;
            color: #475569;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
            text-align: left;
        }

        .modal-op-sidebar-btn:hover {
            background: #f1f5f9;
            border-color: #cbd5e1;
        }

        .modal-op-sidebar-btn i {
            font-size: 14px;
            width: 18px;
            text-align: center;
        }

        .modal-op-sidebar-btn.primary {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            color: white;
            border: none;
            font-weight: 600;
        }

        .modal-op-sidebar-btn.primary:hover {
            background: linear-gradient(135deg, #b91c1c 0%, #991b1b 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(220, 38, 38, 0.3);
        }

        .modal-op-sidebar-btn.highlight {
            background: linear-gradient(135deg, #16a34a 0%, #15803d 100%);
            color: white;
            border: none;
        }

        .modal-op-sidebar-btn.highlight:hover {
            background: linear-gradient(135deg, #15803d 0%, #166534 100%);
        }

        .modal-op-sidebar-btn.outline {
            background: white;
            color: #dc2626;
            border: 1px solid #dc2626;
        }

        .modal-op-sidebar-btn.outline:hover {
            background: #fef2f2;
        }

        .modal-op-sidebar-btn.danger {
            color: #dc2626;
        }

        .modal-op-sidebar-btn.danger:hover {
            background: #fef2f2;
            border-color: #fecaca;
        }

        /* Responsivo Modal OP */
        @media (max-width: 1024px) {
            .modal-op-wrapper {
                flex-direction: column;
                max-height: 95vh;
            }

            .modal-op-sidebar {
                width: 100%;
                flex-direction: row;
                flex-wrap: wrap;
                padding: 12px 16px;
                border-left: none;
                border-top: 1px solid #e2e8f0;
                justify-content: center;
            }

            .modal-op-sidebar-btn {
                width: auto;
                padding: 8px 14px;
            }

            .modal-op-product-row {
                flex-direction: column;
                align-items: stretch;
            }

            .modal-op-values-row {
                flex-direction: column;
            }

            .modal-op-value-field {
                min-width: 100%;
            }

            .modal-op-info-grid {
                grid-template-columns: 1fr;
            }
        }

        /* ============================================
           FORMS
           ============================================ */
        .form-group {
            margin-bottom: var(--space-5);
        }

        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: var(--gray-700);
            margin-bottom: var(--space-2);
        }

        .form-label .required {
            color: var(--danger-500);
            margin-left: 2px;
        }

        .form-input {
            width: 100%;
            padding: var(--space-3) var(--space-4);
            font-size: 14px;
            border: 1px solid var(--gray-300);
            border-radius: var(--radius-lg);
            background: white;
            transition: all var(--transition-base);
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary-500);
            box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.1);
        }

        .form-input::placeholder {
            color: var(--gray-400);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--space-4);
        }

        .form-row-3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: var(--space-4);
        }

        @media (max-width: 640px) {
            .form-row, .form-row-3 {
                grid-template-columns: 1fr;
            }
        }

        /* ============================================
           LOADING & SKELETON
           ============================================ */
        .skeleton {
            background: linear-gradient(90deg, var(--gray-200) 25%, var(--gray-100) 50%, var(--gray-200) 75%);
            background-size: 200% 100%;
            animation: skeleton-loading 1.5s infinite;
            border-radius: var(--radius-md);
        }

        @keyframes skeleton-loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid var(--gray-200);
            border-top-color: var(--primary-500);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* ============================================
           RESPONSIVE HELPERS
           ============================================ */
        @media (max-width: 768px) {
            .page-content {
                padding: var(--space-4);
            }

            .page-header-top {
                flex-direction: column;
                gap: var(--space-4);
            }

            .page-actions {
                width: 100%;
            }

            .page-actions .btn {
                flex: 1;
            }

            .header-user-info {
                display: none;
            }
        }

        /* ============================================
           DARK MODE
           ============================================ */
        body.dark-mode {
            --gray-50: #1e293b;
            --gray-100: #334155;
            --gray-200: #475569;
            --gray-300: #64748b;
            --gray-400: #94a3b8;
            --gray-500: #cbd5e1;
            --gray-600: #e2e8f0;
            --gray-700: #f1f5f9;
            --gray-800: #f8fafc;
            --gray-900: #ffffff;
        }

        body.dark-mode {
            background: var(--dark-bg);
        }

        body.dark-mode .main-content {
            background: var(--dark-bg);
        }

        body.dark-mode .card,
        body.dark-mode .stat-card {
            background: var(--dark-surface);
            border-color: var(--dark-border);
        }

        body.dark-mode .form-input,
        body.dark-mode .search-input,
        body.dark-mode .filter-select {
            background: var(--dark-surface);
            border-color: var(--dark-border);
            color: white;
        }

        /* ============================================
           ANIMAÇÕES
           ============================================ */
        .animate-pulse {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .animate-bounce {
            animation: bounce 1s infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(-5%); }
            50% { transform: translateY(0); }
        }

        /* ============================================
           MODAL DE CONFIRMAÇÃO PROFISSIONAL
           ============================================ */
        .confirm-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(15, 23, 42, 0.7);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 99999;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .confirm-modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .confirm-modal {
            background: white;
            border-radius: 16px;
            width: 90%;
            max-width: 420px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            transform: scale(0.9) translateY(20px);
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            overflow: hidden;
        }

        .confirm-modal-overlay.active .confirm-modal {
            transform: scale(1) translateY(0);
        }

        .confirm-modal-header {
            padding: 24px 24px 0;
            display: flex;
            align-items: flex-start;
            gap: 16px;
        }

        .confirm-modal-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .confirm-modal-icon.warning {
            background: linear-gradient(135deg, #fef3c7, #fde68a);
            color: #d97706;
        }

        .confirm-modal-icon.danger {
            background: linear-gradient(135deg, #fee2e2, #fecaca);
            color: #dc2626;
        }

        .confirm-modal-icon.info {
            background: linear-gradient(135deg, #dbeafe, #bfdbfe);
            color: #2563eb;
        }

        .confirm-modal-icon.success {
            background: linear-gradient(135deg, #d1fae5, #a7f3d0);
            color: #059669;
        }

        .confirm-modal-icon i {
            font-size: 24px;
        }

        .confirm-modal-text {
            flex: 1;
        }

        .confirm-modal-title {
            font-size: 18px;
            font-weight: 600;
            color: #1f2937;
            margin: 0 0 8px;
        }

        .confirm-modal-message {
            font-size: 14px;
            color: #6b7280;
            margin: 0;
            line-height: 1.5;
        }

        .confirm-modal-body {
            padding: 20px 24px;
        }

        .confirm-modal-footer {
            padding: 16px 24px 24px;
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .confirm-modal-btn {
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .confirm-modal-btn-cancel {
            background: #f3f4f6;
            color: #4b5563;
        }

        .confirm-modal-btn-cancel:hover {
            background: #e5e7eb;
        }

        .confirm-modal-btn-confirm {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
            box-shadow: 0 4px 14px rgba(220, 38, 38, 0.4);
        }

        .confirm-modal-btn-confirm:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 20px rgba(220, 38, 38, 0.5);
        }

        .confirm-modal-btn-danger {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
            box-shadow: 0 4px 14px rgba(239, 68, 68, 0.4);
        }

        .confirm-modal-btn-danger:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 20px rgba(239, 68, 68, 0.5);
        }

        .confirm-modal-btn-warning {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
            box-shadow: 0 4px 14px rgba(245, 158, 11, 0.4);
        }

        .confirm-modal-btn-warning:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 20px rgba(245, 158, 11, 0.5);
        }
    </style>
    
    `n</head>
<body>
    <!-- Modal de Confirmação Profissional -->
    <div id="confirm-modal-overlay" class="confirm-modal-overlay">
        <div class="confirm-modal">
            <div class="confirm-modal-header">
                <div id="confirm-modal-icon" class="confirm-modal-icon warning">
                    <i id="confirm-modal-icon-i" class="fas fa-exclamation-triangle"></i>
                </div>
                <div class="confirm-modal-text">
                    <h3 id="confirm-modal-title" class="confirm-modal-title">Confirmar ação</h3>
                    <p id="confirm-modal-message" class="confirm-modal-message">Tem certeza que deseja continuar?</p>
                </div>
            </div>
            <div class="confirm-modal-footer">
                <button id="confirm-modal-cancel" class="confirm-modal-btn confirm-modal-btn-cancel">
                    <i class="fas fa-times"></i> Cancelar
                </button>
                <button id="confirm-modal-confirm" class="confirm-modal-btn confirm-modal-btn-confirm">
                    <i class="fas fa-check"></i> Confirmar
                </button>
            </div>
        </div>
    </div>

    <div class="app-container">
        <!-- Sidebar -->
        <nav class="sidebar">
            <a href="/dashboard" class="sidebar-logo" title="Painel Principal">
                <i class="fas fa-home"></i>
            </a>
            
            <div class="sidebar-nav">
                <a href="index.html" class="sidebar-btn active" title="Dashboard" data-view="view-dashboard">
                    <i class="fas fa-tachometer-alt"></i>
                </a>
                <a href="index.html" class="sidebar-btn" title="Produtos e Estoque" data-view="view-produtos" onclick="localStorage.setItem('pcp-view','produtos')">
                    <i class="fas fa-boxes"></i>
                </a>
                <a href="index.html" class="sidebar-btn" title="Ordem de Compra" data-view="view-ordem-compra" onclick="localStorage.setItem('pcp-view','ordem-compra')">
                    <i class="fas fa-shopping-cart"></i>
                </a>
                <a href="ordens-producao.html" class="sidebar-btn" title="Ordens de Produção">
                    <i class="fas fa-clipboard-list"></i>
                </a>
                <a href="index.html" class="sidebar-btn" title="Programação de Faturamento" data-view="view-faturamento" onclick="localStorage.setItem('pcp-view','faturamento')">
                    <i class="fas fa-file-invoice-dollar"></i>
                </a>
            </div>
            
            <div class="sidebar-bottom">
                <button class="sidebar-btn" title="Configurações" id="btn-config">
                    <i class="fas fa-cog"></i>
                </button>
            </div>
        </nav>

        <!-- Main Area -->
        <div class="main-area">
            <!-- Header -->
            <header class="header">
    <link rel="icon" type="image/x-icon" href="/favicon-aluforce.webp">
                <div class="header-left">
                    <div class="header-brand">
                        <img src="/Logo Monocromatico - Branco - Aluforce.webp" alt="ALUFORCE" style="height: 20px;">
                        <span style="color: #4b5563; font-size: 12px;">|</span>
                        <span style="color: #9ca3af; font-size: 13px; font-weight: 500;" id="current-view-title">PCP</span>
                    </div>
                </div>
                
                <div class="header-right">
                    <button class="header-btn" title="Atualizar" onclick="location.reload()">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                    <button class="header-btn" title="Notificações" onclick="toggleNotificacoes()">
                        <i class="fas fa-bell"></i>
                        <span class="notification-badge" id="notification-count" style="display: none;">0</span>
                    </button>
                    
                    <div class="user-greeting">
                        <span><span id="greeting-text">Bom dia</span>, <strong id="user-name">Usuário</strong></span>
                    </div>
                    
                    <div class="user-avatar" id="user-avatar">
                        <img src="avatars/default.webp" alt="" id="user-photo">
                        <span id="user-initials" style="display:none;align-items:center;justify-content:center;width:100%;height:100%;color:white;font-weight:600;font-size:14px;border-radius:50%;">U</span>
                    </div>
                </div>
            </header>

            <!-- Notification Panel -->
            <div class="notification-panel" id="notification-panel">
                <div class="notification-header">
                    <h3><i class="fas fa-bell"></i> Notificações</h3>
                    <div class="notification-actions">
                        <button onclick="marcarTodasLidas()" title="Marcar todas como lidas">
                            <i class="fas fa-check-double"></i>
                        </button>
                        <button onclick="limparNotificacoes()" title="Limpar todas">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </div>
                </div>
                
                <!-- Filtros de Notificações -->
                <div class="notification-tabs" style="display: flex; gap: 4px; padding: 8px 12px; border-bottom: 1px solid var(--dark-border);">
                    <button class="notif-tab active" onclick="filtrarNotificacoesPCP('todas', this)" style="padding: 6px 12px; background: rgba(220, 38, 38, 0.2); color: #dc2626; border: none; border-radius: 6px; font-size: 12px; font-weight: 500; cursor: pointer;">Todas</button>
                    <button class="notif-tab" onclick="filtrarNotificacoesPCP('nao-lidas', this)" style="padding: 6px 12px; background: transparent; color: var(--gray-400); border: none; border-radius: 6px; font-size: 12px; cursor: pointer;">Não lidas</button>
                    <button class="notif-tab" onclick="filtrarNotificacoesPCP('sistema', this)" style="padding: 6px 12px; background: transparent; color: var(--gray-400); border: none; border-radius: 6px; font-size: 12px; cursor: pointer;">Sistema</button>
                </div>
                
                <div class="notification-list" id="notification-list">
                    <div class="notification-empty">
                        <i class="fas fa-check-circle"></i>
                        <p>Nenhuma notificação</p>
                    </div>
                </div>
                
                <!-- Footer -->
                <div style="padding: 12px; border-top: 1px solid var(--dark-border); display: flex; gap: 8px;">
                    <button onclick="marcarTodasLidas()" style="flex: 1; padding: 8px; background: transparent; border: 1px solid var(--dark-border); color: var(--gray-400); border-radius: 6px; font-size: 12px; cursor: pointer;">
                        <i class="fas fa-check"></i> Marcar todas como lidas
                    </button>
                    <button onclick="limparNotificacoes()" style="flex: 1; padding: 8px; background: #dc2626; border: none; color: white; border-radius: 6px; font-size: 12px; cursor: pointer;">
                        <i class="fas fa-trash-alt"></i> Limpar tudo
                    </button>
                </div>
            </div>

            <!-- MAIN CONTENT -->
            <div class="main-content">
                <!-- ============================================
                     VIEW: DASHBOARD
                     ============================================ -->
                <div id="view-dashboard" class="view active">
                    <div class="page-content">
                        <!-- Stats Cards -->
                        <div class="stats-grid">
                            <div class="stat-card blue">
                                <div class="stat-icon blue">
                            <i class="fas fa-boxes"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-label">Total de Produtos</div>
                            <div class="stat-value" id="stat-produtos">0</div>
                            <div class="stat-trend up">
                                <i class="fas fa-arrow-up"></i> Ativos no sistema
                            </div>
                        </div>
                    </div>

                    <div class="stat-card green">
                        <div class="stat-icon green">
                            <i class="fas fa-clipboard-check"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-label">Ordens em Produção</div>
                            <div class="stat-value" id="stat-ordens">0</div>
                            <div class="stat-trend neutral">
                                <i class="fas fa-clock"></i> Em andamento
                            </div>
                        </div>
                    </div>

                    <div class="stat-card orange">
                        <div class="stat-icon orange">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-label">Estoque Baixo</div>
                            <div class="stat-value" id="stat-estoque-baixo">0</div>
                            <div class="stat-trend down">
                                <i class="fas fa-arrow-down"></i> Requer atenção
                            </div>
                        </div>
                    </div>

                    <div class="stat-card cyan">
                        <div class="stat-icon cyan">
                            <i class="fas fa-truck"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-label">Entregas Pendentes</div>
                            <div class="stat-value" id="stat-entregas">0</div>
                            <div class="stat-trend neutral">
                                <i class="fas fa-clock"></i> Esta semana
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Content Grid -->
                <div class="content-grid">
                    <!-- Quick Actions Card -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <i class="fas fa-bolt"></i> Ações Rápidas
                            </h3>
                        </div>
                        <div class="card-body">
                            <div class="quick-actions-list">
                                <button class="quick-action-btn" id="btn-quick-nova-ordem">
                                    <div class="quick-action-icon" style="background: linear-gradient(135deg, var(--primary-500), var(--primary-600));">
                                        <i class="fas fa-plus-circle"></i>
                                    </div>
                                    <div class="quick-action-content">
                                        <div class="quick-action-title">Nova Ordem de Produção</div>
                                        <div class="quick-action-desc">Criar uma nova ordem de Produção</div>
                                    </div>
                                    <i class="fas fa-chevron-right"></i>
                                </button>

                                <button class="quick-action-btn" onclick="abrirNovoProdutoPCP()">
                                    <div class="quick-action-icon" style="background: linear-gradient(135deg, var(--success-500), var(--success-600));">
                                        <i class="fas fa-box-open"></i>
                                    </div>
                                    <div class="quick-action-content">
                                        <div class="quick-action-title">Cadastrar Produto</div>
                                        <div class="quick-action-desc">Adicionar novo item ao catálogo</div>
                                    </div>
                                    <i class="fas fa-chevron-right"></i>
                                </button>

                                <button class="quick-action-btn" onclick="navigateTo('relatorios')">
                                    <div class="quick-action-icon" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed);">
                                        <i class="fas fa-chart-bar"></i>
                                    </div>
                                    <div class="quick-action-content">
                                        <div class="quick-action-title">Relatórios</div>
                                        <div class="quick-action-desc">Visualizar relatórios e análises</div>
                                    </div>
                                    <i class="fas fa-chevron-right"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Alerts Card -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <i class="fas fa-exclamation-triangle"></i> Alertas do Sistema
                            </h3>
                            <span class="badge badge-danger" id="alerts-count">0</span>
                        </div>
                        <div class="card-body" id="alerts-container">
                            <div class="empty-state">
                                <div class="empty-state-icon">
                                    <i class="fas fa-check-circle"></i>
                                </div>
                                <h4 class="empty-state-title">Tudo certo!</h4>
                                <p class="empty-state-desc">Não há alertas no momento.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Recent Orders -->
                <div class="card" style="margin-top: var(--space-6);">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-clipboard-list"></i> Ordens Recentes
                        </h3>
                        <button class="btn btn-sm btn-secondary" onclick="abrirModalTodasOrdens()">
                            Ver Todas <i class="fas fa-arrow-right"></i>
                        </button>
                    </div>
                    <div class="card-body" style="padding: 0;">
                        <div class="table-container">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Código</th>
                                        <th>Cliente/Empresa</th>
                                        <th>Valor</th>
                                        <th>Status</th>
                                        <th>Data</th>
                                        <th>Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="recent-orders-table">
                                    <tr>
                                        <td colspan="6" style="text-align: center; padding: 40px;">
                                            <div class="loading-spinner" style="margin: 0 auto;"></div>
                                            <p style="margin-top: 16px; color: var(--gray-500);">Carregando ordens...</p>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ============================================
             VIEW: PRODUTOS E ESTOQUE (UNIFICADA)
             ============================================ -->
        <div id="view-produtos" class="view">
            <div class="page-content">
                <div class="page-header">
                    <div class="page-header-top">
                        <div class="page-title-wrapper">
                            <div class="page-icon green">
                                <i class="fas fa-boxes"></i>
                            </div>
                            <div>
                                <h1 class="page-title">PCP | Produtos e Estoque</h1>
                                <p class="page-subtitle">Gestão unificada de produtos e controle de estoque</p>
                            </div>
                        </div>
                        <div class="page-actions">
                            <button class="btn btn-secondary" onclick="exportarProdutos()">
                                <i class="fas fa-download"></i> Exportar
                            </button>
                            <button class="btn btn-success" onclick="abrirNovoProdutoPCP()">
                                <i class="fas fa-plus"></i> Novo Produto
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Stats Cards Produtos -->
                <div class="stats-grid">
                    <div class="stat-card blue">
                        <div class="stat-icon blue">
                            <i class="fas fa-box"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-label">Total de Produtos</div>
                            <div class="stat-value" id="produtos-total">0</div>
                            <div class="stat-trend up">
                                <i class="fas fa-check"></i> Cadastrados
                            </div>
                        </div>
                    </div>

                    <div class="stat-card green">
                        <div class="stat-icon green">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-label">Estoque Normal</div>
                            <div class="stat-value" id="produtos-normal">0</div>
                            <div class="stat-trend up">
                                <i class="fas fa-thumbs-up"></i> Saudável
                            </div>
                        </div>
                    </div>

                    <div class="stat-card orange">
                        <div class="stat-icon orange">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-label">Estoque Baixo</div>
                            <div class="stat-value" id="produtos-baixo">0</div>
                            <div class="stat-trend down">
                                <i class="fas fa-arrow-down"></i> Atenção
                            </div>
                        </div>
                    </div>

                    <div class="stat-card red">
                        <div class="stat-icon red">
                            <i class="fas fa-times-circle"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-label">Nível Crítico</div>
                            <div class="stat-value" id="produtos-critico">0</div>
                            <div class="stat-trend down">
                                <i class="fas fa-exclamation"></i> Urgente
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tabs de Navegação -->
                <div class="tabs">
                    <button class="tab-btn active" data-tab="todos">
                        <i class="fas fa-list"></i> Todos os Produtos
                    </button>
                    <button class="tab-btn" data-tab="estoque-baixo">
                        <i class="fas fa-exclamation-triangle"></i> Estoque Baixo
                    </button>
                    <button class="tab-btn" data-tab="movimentacoes">
                        <i class="fas fa-exchange-alt"></i> Movimentações
                    </button>
                    <button class="tab-btn" data-tab="categorias">
                        <i class="fas fa-tags"></i> Categorias
                    </button>
                </div>

                <!-- Barra de Busca -->
                <div class="search-bar">
                    <div class="search-input-wrapper">
                        <i class="fas fa-search"></i>
                        <input type="text" class="search-input" id="search-produtos" placeholder="Buscar por código, nome, SKU ou GTIN...">
                    </div>
                    <select class="filter-select" id="filter-categoria">
                        <option value="">Todas as Categorias</option>
                        <option value="cabos">Cabos</option>
                        <option value="fios">Fios</option>
                        <option value="acessorios">Acessórios</option>
                        <option value="conexoes">Conexões</option>
                    </select>
                    <select class="filter-select" id="filter-estoque">
                        <option value="">Todos os Status</option>
                        <option value="normal">Estoque Normal</option>
                        <option value="baixo">Estoque Baixo</option>
                        <option value="critico">Nível Crítico</option>
                    </select>
                    <button class="btn btn-primary" onclick="buscarProdutos()">
                        <i class="fas fa-search"></i> Buscar
                    </button>
                </div>

                <!-- Tabela de Produtos -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-table"></i> Catálogo de Produtos
                        </h3>
                        <div style="display: flex; gap: 8px;">
                            <button class="btn btn-sm btn-secondary view-toggle active" data-view="table">
                                <i class="fas fa-table"></i>
                            </button>
                            <button class="btn btn-sm btn-secondary view-toggle" data-view="cards">
                                <i class="fas fa-th-large"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-body" style="padding: 0;">
                        <div class="table-container" id="produtos-table-container">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Código</th>
                                        <th>Nome / Descrição</th>
                                        <th>SKU</th>
                                        <th>Categoria</th>
                                        <th>Estoque</th>
                                        <th>Mínimo</th>
                                        <th>Preço</th>
                                        <th>Status</th>
                                        <th>Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="produtos-table-body">
                                    <tr>
                                        <td colspan="9" style="text-align: center; padding: 60px;">
                                            <div class="loading-spinner" style="margin: 0 auto;"></div>
                                            <p style="margin-top: 16px; color: var(--gray-500);">Carregando produtos...</p>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Grid View (hidden by default) -->
                        <div class="products-grid" id="produtos-grid-container" style="display: none; padding: 24px; display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px;">
                            <!-- Cards serão inseridos via JS -->
                        </div>
                    </div>
                    <div class="card-footer">
                        <div style="display: flex; align-items: center; justify-content: space-between;">
                            <span style="font-size: 14px; color: var(--gray-500);">
                                Mostrando <strong id="produtos-showing">0</strong> de <strong id="produtos-total-count">0</strong> produtos
                            </span>
                            <div class="pagination" id="produtos-pagination">
                                <!-- Paginação será inserida via JS -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ============================================
             VIEW: ORDEM DE COMPRA
             ============================================ -->
        <div id="view-ordem-compra" class="view">
            <div class="page-content">
                <div class="page-header" style="margin-bottom: 20px;">
                    <div class="page-header-top" style="justify-content: flex-end;">
                        <div class="page-actions">
                            <button class="btn btn-primary" id="btn-nova-oc" onclick="abrirModalNovaOC()">
                                <i class="fas fa-plus"></i> Nova OC
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Stats Cards OC -->
                <div class="stats-grid">
                    <div class="stat-card" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);">
                        <div class="stat-icon" style="background: rgba(255,255,255,0.2);">
                            <i class="fas fa-file-alt" style="color: white;"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-label" style="color: rgba(255,255,255,0.9);">OCs Abertas</div>
                            <div class="stat-value" id="oc-abertas" style="color: white;">0</div>
                        </div>
                    </div>

                    <div class="stat-card" style="background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);">
                        <div class="stat-icon" style="background: rgba(255,255,255,0.2);">
                            <i class="fas fa-check-double" style="color: white;"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-label" style="color: rgba(255,255,255,0.9);">Aprovadas</div>
                            <div class="stat-value" id="oc-aprovadas" style="color: white;">0</div>
                        </div>
                    </div>

                    <div class="stat-card" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
                        <div class="stat-icon" style="background: rgba(255,255,255,0.2);">
                            <i class="fas fa-hourglass-half" style="color: white;"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-label" style="color: rgba(255,255,255,0.9);">Aguardando</div>
                            <div class="stat-value" id="oc-aguardando" style="color: white;">0</div>
                        </div>
                    </div>

                    <div class="stat-card" style="background: linear-gradient(135deg, #0891b2 0%, #0e7490 100%);">
                        <div class="stat-icon" style="background: rgba(255,255,255,0.2);">
                            <i class="fas fa-dollar-sign" style="color: white;"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-label" style="color: rgba(255,255,255,0.9);">Valor Total</div>
                            <div class="stat-value" id="oc-valor" style="color: white;">R$ 0</div>
                        </div>
                    </div>
                </div>

                <!-- Tabela de OCs -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-list-alt"></i> Ordens de Compra
                        </h3>
                    </div>
                    <div class="card-body" style="padding: 0;">
                        <div class="table-container">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Nº OC</th>
                                        <th>FORNECEDOR</th>
                                        <th>DATA</th>
                                        <th>PREVISÃO ENTREGA</th>
                                        <th>VALOR TOTAL</th>
                                        <th>STATUS</th>
                                        <th>AÇÕES</th>
                                    </tr>
                                </thead>
                                <tbody id="oc-table-body">
                                    <!-- Carregado via JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal Nova OC (usa o mesmo modal de Compras) -->
        <div class="modal-overlay" id="modalNovaOC">
            <div class="modal" style="max-width: 700px;">
                <div class="modal-header" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed);">
                    <h2><i class="fas fa-shopping-cart"></i> Nova Ordem de Compra - PCP</h2>
                    <button class="modal-close" onclick="fecharModalNovaOC()"><i class="fas fa-times"></i></button>
                </div>
                <div class="modal-body" style="padding: 24px;">
                    <form id="formNovaOC">
                        <!-- Seção: Informações do Fornecedor -->
                        <div style="background: #f8fafc; border-radius: 12px; padding: 20px; margin-bottom: 20px; border: 1px solid #e2e8f0;">
                            <h3 style="margin: 0 0 16px; font-size: 14px; font-weight: 600; color: #475569; display: flex; align-items: center; gap: 8px;">
                                <i class="fas fa-building" style="color: #8b5cf6;"></i> Dados do Fornecedor
                            </h3>
                            <div class="form-group" style="margin-bottom: 0;">
                                <label style="font-weight: 500; color: #334155;">Fornecedor <span style="color: #ef4444;">*</span></label>
                                <select id="ocSelectFornecedor" required style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #cbd5e1; font-size: 14px;">
                                    <option value="">Selecione o fornecedor...</option>
                                </select>
                            </div>
                            <div id="ocInfoFornecedor" style="display: none; margin-top: 12px; padding: 12px; background: #fff; border-radius: 8px; border: 1px solid #e2e8f0;">
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 13px;">
                                    <div><strong style="color: #64748b;">CNPJ:</strong> <span id="ocFornCnpj">-</span></div>
                                    <div><strong style="color: #64748b;">Telefone:</strong> <span id="ocFornTelefone">-</span></div>
                                    <div><strong style="color: #64748b;">Email:</strong> <span id="ocFornEmail">-</span></div>
                                    <div><strong style="color: #64748b;">Cidade:</strong> <span id="ocFornCidade">-</span></div>
                                </div>
                            </div>
                        </div>

                        <!-- Seção: Itens do Pedido -->
                        <div style="background: #f8fafc; border-radius: 12px; padding: 20px; margin-bottom: 20px; border: 1px solid #e2e8f0;">
                            <h3 style="margin: 0 0 16px; font-size: 14px; font-weight: 600; color: #475569; display: flex; align-items: center; gap: 8px;">
                                <i class="fas fa-boxes" style="color: #10b981;"></i> Itens da Compra
                            </h3>
                            <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 12px;">
                                <div class="form-group">
                                    <label style="font-weight: 500; color: #334155;">Material <span style="color: #ef4444;">*</span></label>
                                    <select id="ocSelectMaterial" required style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #cbd5e1; font-size: 14px;">
                                        <option value="">Selecione o material...</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label style="font-weight: 500; color: #334155;">Quantidade <span style="color: #ef4444;">*</span></label>
                                    <input type="number" id="ocInputQuantidade" min="1" placeholder="0" required style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #cbd5e1; font-size: 14px; box-sizing: border-box;">
                                </div>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 12px;">
                                <div class="form-group">
                                    <label style="font-weight: 500; color: #334155;">Valor Unitário <span style="color: #ef4444;">*</span></label>
                                    <div style="position: relative;">
                                        <span style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #64748b; font-weight: 500;">R$</span>
                                        <input type="text" id="ocInputValorUnitario" placeholder="0,00" required style="width: 100%; padding: 12px 12px 12px 40px; border-radius: 8px; border: 1px solid #cbd5e1; font-size: 14px; box-sizing: border-box;">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label style="font-weight: 500; color: #334155;">Prazo de Entrega <span style="color: #ef4444;">*</span></label>
                                    <input type="date" id="ocInputPrazoEntrega" required style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #cbd5e1; font-size: 14px; box-sizing: border-box;">
                                </div>
                            </div>
                        </div>

                        <!-- Seção: Condições -->
                        <div style="background: #f8fafc; border-radius: 12px; padding: 20px; margin-bottom: 20px; border: 1px solid #e2e8f0;">
                            <h3 style="margin: 0 0 16px; font-size: 14px; font-weight: 600; color: #475569; display: flex; align-items: center; gap: 8px;">
                                <i class="fas fa-credit-card" style="color: #f59e0b;"></i> Condições de Pagamento
                            </h3>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                                <div class="form-group">
                                    <label style="font-weight: 500; color: #334155;">Forma de Pagamento</label>
                                    <select id="ocSelectPagamento" style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #cbd5e1; font-size: 14px;">
                                        <option value="">Selecione...</option>
                                        <option value="avista">À Vista</option>
                                        <option value="boleto">Boleto Bancário</option>
                                        <option value="pix">PIX</option>
                                        <option value="deposito">Depósito Bancário</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label style="font-weight: 500; color: #334155;">Prazo de Pagamento</label>
                                    <select id="ocSelectPrazoPagamento" style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #cbd5e1; font-size: 14px;">
                                        <option value="">Selecione...</option>
                                        <option value="avista">À Vista</option>
                                        <option value="7dias">7 Dias</option>
                                        <option value="15dias">15 Dias</option>
                                        <option value="30dias">30 Dias</option>
                                        <option value="30-60">30/60 Dias</option>
                                        <option value="30-60-90">30/60/90 Dias</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Seção: Observações -->
                        <div class="form-group">
                            <label style="font-weight: 500; color: #334155;">Observações</label>
                            <textarea id="ocInputObservacoes" rows="3" placeholder="Informações adicionais sobre a OC..." style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #cbd5e1; font-size: 14px; resize: vertical; box-sizing: border-box;"></textarea>
                        </div>

                        <!-- Resumo do Pedido -->
                        <div id="ocResumoPedido" style="display: none; background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); border-radius: 12px; padding: 16px; color: white;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <span style="font-size: 13px; opacity: 0.9;">Valor Total Estimado</span>
                                    <div style="font-size: 24px; font-weight: 700;" id="ocValorTotalPedido">R$ 0,00</div>
                                </div>
                                <i class="fas fa-calculator" style="font-size: 32px; opacity: 0.5;"></i>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer" style="display: flex; justify-content: space-between; align-items: center; padding: 16px 24px; background: #f8fafc; border-top: 1px solid #e2e8f0;">
                    <button class="btn btn-secondary" onclick="fecharModalNovaOC()" style="padding: 12px 20px;">
                        <i class="fas fa-times"></i> Cancelar
                    </button>
                    <button class="btn btn-primary" onclick="salvarOCPCP()" style="padding: 12px 24px; background: linear-gradient(135deg, #8b5cf6, #7c3aed);">
                        <i class="fas fa-save"></i> Criar Ordem de Compra
                    </button>
                </div>
            </div>
        </div>

        <!-- ============================================
             VIEW: FATURAMENTO
             ============================================ -->
        <div id="view-faturamento" class="view">
            <div class="page-content">
                <div class="page-header">
                    <div class="page-header-top">
                        <div class="page-title-wrapper">
                            <div class="page-icon cyan">
                                <i class="fas fa-file-invoice-dollar"></i>
                            </div>
                            <div>
                                <h1 class="page-title">PCP | Programação de Faturamento</h1>
                                <p class="page-subtitle">Controle de faturamento e expedição</p>
                            </div>
                        </div>
                        <div class="page-actions">
                            <button class="btn btn-primary" id="btn-novo-faturamento">
                                <i class="fas fa-plus"></i> Novo Faturamento
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Stats Cards Faturamento -->
                <div class="stats-grid">
                    <div class="stat-card blue">
                        <div class="stat-icon blue">
                            <i class="fas fa-calendar-alt"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-label">Programados</div>
                            <div class="stat-value" id="fat-programados">0</div>
                        </div>
                    </div>

                    <div class="stat-card green">
                        <div class="stat-icon green">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-label">Faturados</div>
                            <div class="stat-value" id="fat-emitidos">0</div>
                        </div>
                    </div>

                    <div class="stat-card orange">
                        <div class="stat-icon orange">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-label">Pendentes</div>
                            <div class="stat-value" id="fat-pendentes">0</div>
                        </div>
                    </div>

                    <div class="stat-card red">
                        <div class="stat-icon red">
                            <i class="fas fa-times-circle"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-label">Cancelados</div>
                            <div class="stat-value" id="fat-cancelados">0</div>
                        </div>
                    </div>
                </div>

                <!-- Tabs Faturamento -->
                <div class="tabs">
                    <button class="tab-btn active" data-tab-fat="todos">
                        <i class="fas fa-list"></i> Todos
                    </button>
                    <button class="tab-btn" data-tab-fat="programados">
                        <i class="fas fa-clock"></i> Programados
                    </button>
                    <button class="tab-btn" data-tab-fat="emitidos">
                        <i class="fas fa-check-circle"></i> Emitidos
                    </button>
                    <button class="tab-btn" data-tab-fat="cancelados">
                        <i class="fas fa-times-circle"></i> Cancelados
                    </button>
                </div>

                <!-- Lista de Faturamentos -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-file-invoice"></i> Lista de Faturamentos
                        </h3>
                    </div>
                    <div class="card-body" style="padding: 0;">
                        <div class="table-container">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>NÂº Pedido</th>
                                        <th>Cliente</th>
                                        <th>Data Programada</th>
                                        <th>Valor</th>
                                        <th>Status</th>
                                        <th>Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="faturamento-table-body">
                                    <tr>
                                        <td colspan="6" style="text-align: center; padding: 60px;">
                                            <div class="loading-spinner" style="margin: 0 auto;"></div>
                                            <p style="margin-top: 16px; color: var(--gray-500);">Carregando faturamentos...</p>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ============================================
             VIEW: RELATí“RIOS
             ============================================ -->
        <div id="view-relatorios" class="view">
            <div class="page-content">
                <div class="page-header">
                    <div class="page-header-top">
                        <div class="page-title-wrapper">
                            <div class="page-icon purple">
                                <i class="fas fa-chart-bar"></i>
                            </div>
                            <div>
                                <h1 class="page-title">PCP | Relatórios</h1>
                                <p class="page-subtitle">Análises e relatórios do sistema PCP</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Grid de Relatórios -->
                <div class="content-grid-3">
                    <div class="card" style="cursor: pointer;" onclick="gerarRelatorio('producao')">
                        <div class="card-body" style="text-align: center; padding: 40px;">
                            <div style="width: 64px; height: 64px; background: linear-gradient(135deg, var(--primary-500), var(--primary-600)); border-radius: 16px; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px;">
                                <i class="fas fa-industry" style="font-size: 28px; color: white;"></i>
                            </div>
                            <h3 style="font-size: 18px; font-weight: 600; margin-bottom: 8px;">Relatório de Produção</h3>
                            <p style="font-size: 14px; color: var(--gray-500);">Análise detalhada da Produção por período</p>
                        </div>
                    </div>

                    <div class="card" style="cursor: pointer;" onclick="gerarRelatorio('estoque')">
                        <div class="card-body" style="text-align: center; padding: 40px;">
                            <div style="width: 64px; height: 64px; background: linear-gradient(135deg, var(--success-500), var(--success-600)); border-radius: 16px; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px;">
                                <i class="fas fa-boxes" style="font-size: 28px; color: white;"></i>
                            </div>
                            <h3 style="font-size: 18px; font-weight: 600; margin-bottom: 8px;">Relatório de Estoque</h3>
                            <p style="font-size: 14px; color: var(--gray-500);">Posição atual e movimentações</p>
                        </div>
                    </div>

                    <div class="card" style="cursor: pointer;" onclick="gerarRelatorio('materiais')">
                        <div class="card-body" style="text-align: center; padding: 40px;">
                            <div style="width: 64px; height: 64px; background: linear-gradient(135deg, var(--warning-500), var(--warning-600)); border-radius: 16px; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px;">
                                <i class="fas fa-cubes" style="font-size: 28px; color: white;"></i>
                            </div>
                            <h3 style="font-size: 18px; font-weight: 600; margin-bottom: 8px;">Relatório de Materiais</h3>
                            <p style="font-size: 14px; color: var(--gray-500);">Consumo e necessidades de materiais</p>
                        </div>
                    </div>

                    <div class="card" style="cursor: pointer;" onclick="gerarRelatorio('entregas')">
                        <div class="card-body" style="text-align: center; padding: 40px;">
                            <div style="width: 64px; height: 64px; background: linear-gradient(135deg, var(--info-500), var(--info-600)); border-radius: 16px; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px;">
                                <i class="fas fa-truck" style="font-size: 28px; color: white;"></i>
                            </div>
                            <h3 style="font-size: 18px; font-weight: 600; margin-bottom: 8px;">Relatório de Entregas</h3>
                            <p style="font-size: 14px; color: var(--gray-500);">Prazos e performance de entregas</p>
                        </div>
                    </div>

                    <div class="card" style="cursor: pointer;" onclick="gerarRelatorio('compras')">
                        <div class="card-body" style="text-align: center; padding: 40px;">
                            <div style="width: 64px; height: 64px; background: linear-gradient(135deg, #8b5cf6, #7c3aed); border-radius: 16px; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px;">
                                <i class="fas fa-shopping-cart" style="font-size: 28px; color: white;"></i>
                            </div>
                            <h3 style="font-size: 18px; font-weight: 600; margin-bottom: 8px;">Relatório de Compras</h3>
                            <p style="font-size: 14px; color: var(--gray-500);">Análise de compras e fornecedores</p>
                        </div>
                    </div>

                    <div class="card" style="cursor: pointer;" onclick="gerarRelatorio('kpis')">
                        <div class="card-body" style="text-align: center; padding: 40px;">
                            <div style="width: 64px; height: 64px; background: linear-gradient(135deg, var(--danger-500), var(--danger-600)); border-radius: 16px; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px;">
                                <i class="fas fa-tachometer-alt" style="font-size: 28px; color: white;"></i>
                            </div>
                            <h3 style="font-size: 18px; font-weight: 600; margin-bottom: 8px;">KPIs de Performance</h3>
                            <p style="font-size: 14px; color: var(--gray-500);">Indicadores chave de desempenho</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
            </div> <!-- Fecha main-content -->
        </div> <!-- Fecha main-area -->
    </div> <!-- Fecha app-container -->

    <!-- ============================================
         MODAIS
         ============================================ -->
    
    <!-- Modal: Nova Ordem de Produção -->
    <div class="modal-overlay" id="modal-nova-ordem">
        <div class="modal-op-wrapper">
            <!-- írea Principal do Modal -->
            <div class="modal-op-main">
                <!-- Header do Modal -->
                <div class="modal-op-header">
                    <h3 class="modal-op-title">Nova Ordem de Produção</h3>
                    <button class="modal-op-close" onclick="hideModal('modal-nova-ordem')">
                        Fechar <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <!-- Conteúdo do Modal -->
                <div class="modal-op-body">
                    <!-- Seção: Dados da OP -->
                    <div class="modal-op-section">
                        <div class="modal-op-product-row">
                            <div class="modal-op-avatar">
                                <span>OP</span>
                            </div>
                            <div class="modal-op-product-field">
                                <label class="modal-op-label">Número da OP <i class="fas fa-hashtag"></i></label>
                                <input type="text" class="modal-op-input-lg" id="op-numero" placeholder="OP Nº 2025/00001">
                            </div>
                            <div class="modal-op-product-field" style="max-width: 180px;">
                                <label class="modal-op-label">Nº Orçamento</label>
                                <input type="text" class="modal-op-input-lg" id="op-orcamento" placeholder="ORC-2025-001">
                            </div>
                            <div class="modal-op-date-field">
                                <label class="modal-op-label">Data Liberação <i class="fas fa-calendar"></i></label>
                                <input type="date" class="modal-op-input-date" id="op-data-liberacao">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Seção: Vendedor e Frete -->
                    <div class="modal-op-values-row">
                        <div class="modal-op-value-field" style="flex: 2;">
                            <label>Vendedor</label>
                            <select id="op-vendedor" class="op-select-vendedor">
                                <option value="">Selecione o vendedor...</option>
                                <option value="Augusto Ladeira">Augusto Ladeira</option>
                                <option value="Fabiola Souza">Fabiola Souza</option>
                                <option value="Fabiano Marques">Fabiano Marques</option>
                                <option value="Renata Nascimento">Renata Nascimento</option>
                                <option value="Andreia Trovão">Andreia Trovão</option>
                            </select>
                        </div>
                        <div class="modal-op-value-field">
                            <label>Prazo Entrega</label>
                            <input type="text" id="op-prazo-entrega" placeholder="Ex: 15 dias úteis">
                        </div>
                        <div class="modal-op-value-field">
                            <label>Tipo Frete</label>
                            <select id="op-tipo-frete" class="op-select-frete">
                                <option value="CIF">CIF</option>
                                <option value="FOB">FOB</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Abas -->
                    <div class="modal-op-tabs">
                        <button class="modal-op-tab active" data-tab="cliente" onclick="switchOPTab('cliente')">
                            <i class="fas fa-user-tie"></i> Dados do Cliente
                        </button>
                        <button class="modal-op-tab" data-tab="transportadora" onclick="switchOPTab('transportadora')">
                            <i class="fas fa-truck"></i> Transportadora
                        </button>
                        <button class="modal-op-tab" data-tab="produtos" onclick="switchOPTab('produtos')">
                            <i class="fas fa-boxes"></i> Produtos
                        </button>
                        <button class="modal-op-tab" data-tab="pagamento" onclick="switchOPTab('pagamento')">
                            <i class="fas fa-credit-card"></i> Pagamento
                        </button>
                        <button class="modal-op-tab" data-tab="entrega" onclick="switchOPTab('entrega')">
                            <i class="fas fa-shipping-fast"></i> Entrega
                        </button>
                        <button class="modal-op-tab" data-tab="obs" onclick="switchOPTab('obs')">
                            <i class="fas fa-sticky-note"></i> Observações
                        </button>
                    </div>
                    
                    <!-- Conteíºdo das Abas -->
                    <div class="modal-op-tab-content">
                        <!-- Aba: Dados do Cliente -->
                        <div class="modal-op-tab-pane active" id="op-tab-cliente">
                            <div class="modal-op-info-grid">
                                <div class="modal-op-info-field" style="grid-column: span 2; position: relative;">
                                    <label>Razão Social / Nome do Cliente <span style="color: #dc2626;">*</span></label>
                                    <div class="autocomplete-container">
                                        <input type="text" id="op-cliente" placeholder="Digite para buscar..." autocomplete="off" oninput="buscarClientesAutocomplete(this.value)" onfocus="buscarClientesAutocomplete(this.value)">
                                        <div class="autocomplete-dropdown" id="op-cliente-dropdown"></div>
                                    </div>
                                    <input type="hidden" id="op-cliente-id">
                                </div>
                                <div class="modal-op-info-field">
                                    <label>CNPJ / CPF</label>
                                    <input type="text" id="op-cliente-cnpj" placeholder="00.000.000/0001-00">
                                </div>
                                <div class="modal-op-info-field">
                                    <label>Contato</label>
                                    <input type="text" id="op-cliente-contato" placeholder="Nome do contato">
                                </div>
                                <div class="modal-op-info-field">
                                    <label>Telefone</label>
                                    <input type="text" id="op-cliente-fone" placeholder="(00) 00000-0000">
                                </div>
                                <div class="modal-op-info-field">
                                    <label>E-mail</label>
                                    <input type="email" id="op-cliente-email" placeholder="email@empresa.com.br">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Aba: Transportadora -->
                        <div class="modal-op-tab-pane" id="op-tab-transportadora">
                            <div class="modal-op-info-grid">
                                <div class="modal-op-info-field" style="grid-column: span 2; position: relative;">
                                    <label>Nome da Transportadora</label>
                                    <div class="autocomplete-container">
                                        <input type="text" id="op-transportadora-nome" placeholder="Digite para buscar..." autocomplete="off" oninput="buscarTransportadorasAutocomplete(this.value)" onfocus="buscarTransportadorasAutocomplete(this.value)">
                                        <div class="autocomplete-dropdown" id="op-transportadora-dropdown"></div>
                                    </div>
                                    <input type="hidden" id="op-transportadora-id">
                                </div>
                                <div class="modal-op-info-field">
                                    <label>CNPJ</label>
                                    <input type="text" id="op-transportadora-cnpj" placeholder="00.000.000/0001-00">
                                </div>
                                <div class="modal-op-info-field">
                                    <label>Telefone</label>
                                    <input type="text" id="op-transportadora-fone" placeholder="(00) 0000-0000">
                                </div>
                                <div class="modal-op-info-field">
                                    <label>CEP</label>
                                    <input type="text" id="op-transportadora-cep" placeholder="00000-000">
                                </div>
                                <div class="modal-op-info-field">
                                    <label>E-mail NF-e</label>
                                    <input type="email" id="op-transportadora-email" placeholder="nfe@transportadora.com.br">
                                </div>
                                <div class="modal-op-info-field" style="grid-column: span 2;">
                                    <label>Endereço Completo</label>
                                    <input type="text" id="op-transportadora-endereco" placeholder="Rua, número, bairro - Cidade/UF">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Aba: Produtos -->
                        <div class="modal-op-tab-pane" id="op-tab-produtos">
                            <div class="modal-op-tab-actions">
                                <button type="button" class="modal-op-btn-action add" onclick="adicionarProdutoOP()">
                                    <i class="fas fa-plus"></i> Adicionar Produto
                                </button>
                                <button type="button" class="modal-op-btn-action edit" onclick="editarProdutoOP()">
                                    <i class="fas fa-pencil-alt"></i> Editar
                                </button>
                                <button type="button" class="modal-op-btn-action delete" onclick="removerProdutoOP()">
                                    <i class="fas fa-trash"></i> Remover
                                </button>
                            </div>
                            <div class="modal-op-table-container">
                                <!-- Tabela conforme template Excel: Cod | Produto | Embalagem | Lance(s) | Qtd | V.Un | V.Total -->
                                <table class="modal-op-table">
                                    <thead>
                                        <tr>
                                            <th style="width: 30px;"><input type="checkbox" id="op-select-all-produtos"></th>
                                            <th style="width: 80px;">Código</th>
                                            <th>Produto</th>
                                            <th style="width: 90px;">Embalagem</th>
                                            <th style="width: 90px;">Lance(s)</th>
                                            <th style="width: 60px;">Qtd</th>
                                            <th style="width: 90px;">V. Un. R$</th>
                                            <th style="width: 100px;">V. Total R$</th>
                                        </tr>
                                    </thead>
                                    <tbody id="op-produtos-tbody">
                                        <tr class="modal-op-empty-row">
                                            <td colspan="8">
                                                <i class="fas fa-boxes"></i>
                                                <span>Nenhum produto adicionado</span>
                                            </td>
                                        </tr>
                                    </tbody>
                                    <tfoot>
                                        <tr style="background: #f1f5f9; font-weight: 600;">
                                            <td colspan="7" style="text-align: right; padding: 12px 16px;">Total do Pedido:</td>
                                            <td id="op-produtos-total" style="padding: 12px 16px;">R$ 0,00</td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                        </div>
                        
                        <!-- Aba: Pagamento -->
                        <div class="modal-op-tab-pane" id="op-tab-pagamento">
                            <!-- Título da Seção -->
                            <div style="background: linear-gradient(135deg, #fef3c7, #fde68a); padding: 12px 16px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #f59e0b;">
                                <h4 style="margin: 0; color: #92400e; font-size: 14px; display: flex; align-items: center; gap: 8px;">
                                    <i class="fas fa-file-invoice-dollar"></i>
                                    CONDIÇÕES DE PAGAMENTO
                                </h4>
                            </div>
                            
                            <!-- Tabela de Formas de Pagamento -->
                            <div style="background: white; border: 2px solid #e2e8f0; border-radius: 12px; overflow: hidden; margin-bottom: 20px;">
                                <!-- Header da Tabela -->
                                <div style="display: grid; grid-template-columns: 2fr 1fr 2fr 1.5fr; background: #fef3c7; padding: 12px 16px; border-bottom: 2px solid #e2e8f0;">
                                    <span style="font-weight: 700; color: #1e293b; font-size: 12px; text-transform: uppercase;">Formas de Pagamento</span>
                                    <span style="font-weight: 700; color: #1e293b; font-size: 12px; text-transform: uppercase; text-align: center;">%</span>
                                    <span style="font-weight: 700; color: #1e293b; font-size: 12px; text-transform: uppercase;">Método de Pagamento</span>
                                    <span style="font-weight: 700; color: #1e293b; font-size: 12px; text-transform: uppercase; text-align: right;">Valor R$</span>
                                </div>
                                
                                <!-- Linha 1: À Vista / Entrada -->
                                <div style="display: grid; grid-template-columns: 2fr 1fr 2fr 1.5fr; padding: 12px 16px; border-bottom: 1px solid #f1f5f9; align-items: center; gap: 12px;">
                                    <select id="op-forma-pagamento-1" style="padding: 10px 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 13px; background: #fefce8;" onchange="calcularValoresPagamento()">
                                        <option value="A_VISTA">À VISTA</option>
                                        <option value="ENTRADA">ENTRADA</option>
                                        <option value="ANTECIPADO">ANTECIPADO</option>
                                    </select>
                                    <div style="position: relative;">
                                        <input type="number" id="op-percent-1" value="100" min="0" max="100" style="width: 100%; padding: 10px 30px 10px 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; font-weight: 600; text-align: center; background: #fefce8;" onchange="calcularValoresPagamento()">
                                        <span style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); color: #64748b; font-weight: 600;">%</span>
                                    </div>
                                    <select id="op-metodo-pagamento-1" style="padding: 10px 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 13px; background: white;">
                                        <option value="BOLETO">BOLETO</option>
                                        <option value="TRANSFERENCIA">TRANSFERÊNCIA</option>
                                        <option value="PIX">PIX</option>
                                        <option value="DEPOSITO">DEPÓSITO</option>
                                        <option value="CARTAO">CARTÃO</option>
                                        <option value="FATURAMENTO">FATURAMENTO</option>
                                    </select>
                                    <div style="text-align: right;">
                                        <span id="op-valor-pagamento-1" style="font-size: 15px; font-weight: 700; color: #16a34a;">R$ 0,00</span>
                                    </div>
                                </div>
                                
                                <!-- Linha 2: Entrega / Parcela -->
                                <div style="display: grid; grid-template-columns: 2fr 1fr 2fr 1.5fr; padding: 12px 16px; border-bottom: 1px solid #f1f5f9; align-items: center; gap: 12px;">
                                    <select id="op-forma-pagamento-2" style="padding: 10px 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 13px; background: white;" onchange="calcularValoresPagamento()">
                                        <option value="">Selecione...</option>
                                        <option value="ENTREGA">ENTREGA</option>
                                        <option value="PARCELA_1">PARCELA 1</option>
                                        <option value="PARCELADO">PARCELADO</option>
                                    </select>
                                    <div style="position: relative;">
                                        <input type="number" id="op-percent-2" value="0" min="0" max="100" style="width: 100%; padding: 10px 30px 10px 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; font-weight: 600; text-align: center;" onchange="calcularValoresPagamento()">
                                        <span style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); color: #64748b; font-weight: 600;">%</span>
                                    </div>
                                    <select id="op-metodo-pagamento-2" style="padding: 10px 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 13px; background: white;">
                                        <option value="">-</option>
                                        <option value="BOLETO">BOLETO</option>
                                        <option value="TRANSFERENCIA">TRANSFERÊNCIA</option>
                                        <option value="PIX">PIX</option>
                                        <option value="DEPOSITO">DEPÓSITO</option>
                                        <option value="FATURAMENTO">FATURAMENTO</option>
                                    </select>
                                    <div style="text-align: right;">
                                        <span id="op-valor-pagamento-2" style="font-size: 15px; font-weight: 700; color: #64748b;">R$ 0,00</span>
                                    </div>
                                </div>
                                
                                <!-- Linha 3: Adicional (opcional) -->
                                <div style="display: grid; grid-template-columns: 2fr 1fr 2fr 1.5fr; padding: 12px 16px; align-items: center; gap: 12px;">
                                    <select id="op-forma-pagamento-3" style="padding: 10px 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 13px; background: white;" onchange="calcularValoresPagamento()">
                                        <option value="">Selecione...</option>
                                        <option value="PARCELA_2">PARCELA 2</option>
                                        <option value="PARCELA_3">PARCELA 3</option>
                                        <option value="SALDO">SALDO</option>
                                    </select>
                                    <div style="position: relative;">
                                        <input type="number" id="op-percent-3" value="0" min="0" max="100" style="width: 100%; padding: 10px 30px 10px 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; font-weight: 600; text-align: center;" onchange="calcularValoresPagamento()">
                                        <span style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); color: #64748b; font-weight: 600;">%</span>
                                    </div>
                                    <select id="op-metodo-pagamento-3" style="padding: 10px 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 13px; background: white;">
                                        <option value="">-</option>
                                        <option value="BOLETO">BOLETO</option>
                                        <option value="TRANSFERENCIA">TRANSFERÊNCIA</option>
                                        <option value="PIX">PIX</option>
                                        <option value="DEPOSITO">DEPÓSITO</option>
                                        <option value="FATURAMENTO">FATURAMENTO</option>
                                    </select>
                                    <div style="text-align: right;">
                                        <span id="op-valor-pagamento-3" style="font-size: 15px; font-weight: 700; color: #64748b;">R$ 0,00</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Resumo e Total -->
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                                <!-- Percentual Total -->
                                <div style="background: #f8fafc; border: 2px solid #e2e8f0; border-radius: 12px; padding: 16px;">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <span style="font-size: 13px; color: #64748b; font-weight: 600;">Total Percentual:</span>
                                        <span id="op-percent-total" style="font-size: 20px; font-weight: 700; color: #1e293b;">100%</span>
                                    </div>
                                    <div id="op-percent-alert" style="display: none; margin-top: 8px; padding: 8px 12px; background: #fef2f2; border-radius: 6px; color: #dc2626; font-size: 12px;">
                                        <i class="fas fa-exclamation-triangle"></i> O percentual deve totalizar 100%
                                    </div>
                                </div>
                                
                                <!-- Valor Total -->
                                <div style="background: linear-gradient(135deg, #dcfce7, #bbf7d0); border: 2px solid #86efac; border-radius: 12px; padding: 16px;">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <span style="font-size: 13px; color: #166534; font-weight: 600;">Valor Total $:</span>
                                        <span id="op-valor-total-pagamento" style="font-size: 20px; font-weight: 700; color: #16a34a;">R$ 0,00</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Condições Adicionais -->
                            <div style="margin-top: 20px;">
                                <label style="display: block; font-size: 13px; font-weight: 600; color: #374151; margin-bottom: 8px;">
                                    <i class="fas fa-info-circle" style="color: #64748b;"></i> Condições de Pagamento (Observações)
                                </label>
                                <input type="text" id="op-condicoes-pagamento" placeholder="Ex: 28 dias após o faturamento, 30/60/90 dias, etc." style="width: 100%; padding: 12px 16px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 14px;">
                            </div>
                        </div>
                        
                        <!-- Aba: Entrega -->
                        <div class="modal-op-tab-pane" id="op-tab-entrega">
                            <div class="modal-op-info-grid">
                                <div class="modal-op-info-field">
                                    <label>Data PreVisão de Entrega</label>
                                    <input type="date" id="op-data-entrega">
                                </div>
                                <div class="modal-op-info-field">
                                    <label>Quantidade de Volumes</label>
                                    <input type="text" id="op-qtd-volumes" placeholder="Ex: 15 volumes">
                                </div>
                                <div class="modal-op-info-field" style="grid-column: span 2;">
                                    <label>Tipo de Embalagem</label>
                                    <input type="text" id="op-tipo-embalagem" placeholder="Ex: Embalagem industrial anti-corrosão">
                                </div>
                                <div class="modal-op-info-field" style="grid-column: span 2;">
                                    <label>Observações de Entrega</label>
                                    <textarea id="op-obs-entrega" rows="4" style="width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 8px; resize: vertical;" placeholder="Horário de entrega, contato no local, instruções especiais..."></textarea>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Aba: Observações -->
                        <div class="modal-op-tab-pane" id="op-tab-obs">
                            <div class="modal-op-obs-field">
                                <label>Observações Gerais da Ordem de Produção</label>
                                <textarea id="op-observacoes" rows="8" placeholder="Informações adicionais, especificações técnicas, instruções especiais..."></textarea>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Sidebar de Ações -->
            <div class="modal-op-sidebar">
                <button type="button" class="modal-op-sidebar-btn primary" onclick="salvarOrdemProducao()">
                    <i class="fas fa-save"></i> Salvar
                </button>
                <button type="button" class="modal-op-sidebar-btn highlight" onclick="gerarExcelOP()">
                    <i class="fas fa-file-excel"></i> Gerar Excel
                </button>
                <button type="button" class="modal-op-sidebar-btn" onclick="imprimirOP()">
                    <i class="fas fa-print"></i> Imprimir
                </button>
                <button type="button" class="modal-op-sidebar-btn" onclick="duplicarOP()">
                    <i class="fas fa-copy"></i> Duplicar
                </button>
                <button type="button" class="modal-op-sidebar-btn" onclick="buscarClienteOP()">
                    <i class="fas fa-search"></i> Buscar Cliente
                </button>
                <button type="button" class="modal-op-sidebar-btn" onclick="buscarTransportadoraOP()">
                    <i class="fas fa-truck-loading"></i> Buscar Transp.
                </button>
                <button type="button" class="modal-op-sidebar-btn outline" onclick="limparFormOP()">
                    <i class="fas fa-eraser"></i> Limpar
                </button>
                <button type="button" class="modal-op-sidebar-btn danger" onclick="hideModal('modal-nova-ordem')">
                    <i class="fas fa-times"></i> Cancelar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal: Adicionar/Editar Produto da OP -->
    <div class="modal-overlay" id="modal-produto-op">
        <div class="modal-produto-container" style="max-width: 700px;">
            <div class="modal-produto-header">
                <h3 id="modal-produto-titulo"><i class="fas fa-box"></i> Adicionar Produto</h3>
                <button class="modal-produto-close" onclick="fecharModalProduto()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-produto-body">
                <!-- Info sobre o catálogo -->
                <div style="background: #e3f2fd; padding: 10px 15px; border-radius: 8px; margin-bottom: 15px; font-size: 13px; color: #1565c0;">
                    <i class="fas fa-info-circle"></i> Digite o código do produto do catálogo Aluforce. A descrição será preenchida automaticamente.
                </div>
                
                <div class="modal-produto-grid">
                    <!-- Código com Autocomplete -->
                    <div class="modal-produto-field" style="position: relative;">
                        <label><i class="fas fa-barcode"></i> Código do Produto <span class="required">*</span></label>
                        <input type="text" id="prod-codigo" placeholder="Ex: TRN10, DUN16, TRI25..." 
                               autocomplete="off" oninput="buscarProdutoCatalogo(this.value)">
                        <div id="prod-codigo-autocomplete" class="autocomplete-dropdown" style="display: none;"></div>
                    </div>
                    
                    <!-- Descrição (readonly - preenchida pelo VLOOKUP no Excel) -->
                    <div class="modal-produto-field" style="position: relative;">
                        <label><i class="fas fa-tag"></i> Descrição <small style="color:#666;">(automático)</small></label>
                        <input type="text" id="prod-descricao" readonly 
                               style="background: #f5f5f5; color: #666;" 
                               placeholder="Preenchido automaticamente pelo código">
                    </div>
                    
                    <!-- Embalagem -->
                    <div class="modal-produto-field">
                        <label><i class="fas fa-box-open"></i> Embalagem</label>
                        <select id="prod-embalagem">
                            <option value="">Selecione...</option>
                            <option value="Bobina">Bobina</option>
                            <option value="Rolo">Rolo</option>
                            <option value="Lance">Lance</option>
                            <option value="Caixa">Caixa</option>
                        </select>
                    </div>
                    
                    <!-- Lance(s) -->
                    <div class="modal-produto-field">
                        <label><i class="fas fa-ruler"></i> Lance(s)</label>
                        <input type="text" id="prod-lances" placeholder="Ex: 1x100" value="1x100">
                    </div>
                    
                    <!-- P. LÍQUIDO (Peso Líquido) -->
                    <div class="modal-produto-field">
                        <label><i class="fas fa-weight-hanging"></i> P. Líquido (kg)</label>
                        <input type="text" id="prod-peso-liquido" placeholder="Ex: 25.5">
                    </div>
                    
                    <!-- LOTE -->
                    <div class="modal-produto-field">
                        <label><i class="fas fa-layer-group"></i> Lote</label>
                        <input type="text" id="prod-lote" placeholder="Ex: LOT2025-001">
                    </div>
                    
                    <!-- Quantidade -->
                    <div class="modal-produto-field">
                        <label><i class="fas fa-sort-numeric-up"></i> Quantidade <span class="required">*</span></label>
                        <input type="number" id="prod-quantidade" min="1" value="1" oninput="calcularPreviewTotal()">
                    </div>
                    
                    <!-- Valor Unitário -->
                    <div class="modal-produto-field">
                        <label><i class="fas fa-dollar-sign"></i> Valor Unitário (R$)</label>
                        <input type="number" id="prod-valor" step="0.01" min="0" placeholder="0,00" oninput="calcularPreviewTotal()">
                    </div>
                    
                    <!-- Total Preview -->
                    <div class="modal-produto-field">
                        <label><i class="fas fa-calculator"></i> Total</label>
                        <div class="modal-produto-total" id="prod-total-preview">R$ 0,00</div>
                    </div>
                </div>
            </div>
            <div class="modal-produto-footer">
                <button type="button" class="btn-cancelar" onclick="fecharModalProduto()">
                    <i class="fas fa-times"></i> Cancelar
                </button>
                <button type="button" class="btn-salvar" onclick="salvarProdutoModal()">
                    <i class="fas fa-check"></i> Confirmar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal: Novo/Editar Produto - Estilo OMIE -->
    <div class="modal-overlay" id="modal-novo-produto">
        <div class="modal-content-omie" style="max-width: 1200px; border-radius: 0; height: 95vh; display: flex; flex-direction: column;">
            <!-- Header -->
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 16px 24px; border-bottom: 1px solid #e5e5e5; background: white; flex-shrink: 0;">
                <h2 id="modal-novo-produto-titulo" style="color: #333; font-size: 20px; font-weight: 400; margin: 0;">Incluir Produto</h2>
                <button class="close-btn" onclick="fecharModalProdutoPCP()" style="color: #666; background: none; border: none; font-size: 14px; cursor: pointer;">
                    Fechar <i class="fas fa-times"></i>
                </button>
            </div>
            
            <!-- Container Principal -->
            <div style="display: flex; flex: 1; overflow: hidden;">
                <!-- írea Principal -->
                <div style="flex: 1; padding: 24px; overflow-y: auto; background: #fafafa;">
                    <!-- Seção Superior: Imagem + Dados Básicos -->
                    <div style="display: flex; gap: 24px; margin-bottom: 24px;">
                        <!-- Upload de Imagem -->
                        <div style="flex-shrink: 0;">
                            <div id="pcp-produto-imagem-container" style="width: 100px; height: 100px; border: 2px dashed #ddd; border-radius: 8px; display: flex; flex-direction: column; align-items: center; justify-content: center; background: #f8f8f8; cursor: pointer; position: relative;" onclick="document.getElementById('pcp-produto-imagem-input').click()">
                                <img id="pcp-produto-imagem-preview" src="" style="display: none; width: 100%; height: 100%; object-fit: cover; border-radius: 6px;">
                                <i class="fas fa-image" id="pcp-produto-imagem-icon" style="font-size: 32px; color: #ccc;"></i>
                            </div>
                            <input type="file" id="pcp-produto-imagem-input" accept="image/*" style="display: none;" onchange="previewImagemProdutoPCP(this)">
                            <a href="#" onclick="document.getElementById('pcp-produto-imagem-input').click(); return false;" style="display: block; text-align: center; margin-top: 8px; font-size: 12px; color: #f97316;">
                                <i class="fas fa-pencil-alt"></i> Alterar
                            </a>
                            <p style="text-align: center; font-size: 11px; color: #999; margin-top: 4px;">Nenhuma<br>imagem</p>
                        </div>
                        
                        <!-- Dados Básicos -->
                        <div style="flex: 1;">
                            <input type="hidden" id="pcp-produto-id">
                            <div style="margin-bottom: 16px;">
                                <label style="display: block; font-size: 12px; color: #f97316; margin-bottom: 4px;">Descrição do Produto <span style="color: #dc2626;">*</span></label>
                                <input type="text" id="pcp-produto-descricao" placeholder="Preencha aqui a Descrição do Produto" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                                <div>
                                    <label style="display: block; font-size: 12px; color: #f97316; margin-bottom: 4px;">Código do Produto <span style="color: #dc2626;">*</span></label>
                                    <div style="position: relative;">
                                        <input type="text" id="pcp-produto-codigo" placeholder="Ex: PRD00001" style="width: 100%; padding: 12px; padding-right: 36px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                                        <i class="fas fa-info-circle" style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); color: #999; cursor: help;" title="Código íºnico do produto"></i>
                                    </div>
                                </div>
                                <div>
                                    <label style="display: block; font-size: 12px; color: #f97316; margin-bottom: 4px;">SKU</label>
                                    <input type="text" id="pcp-produto-sku" placeholder="SKU do produto" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                                </div>
                                <div>
                                    <label style="display: block; font-size: 12px; color: #f97316; margin-bottom: 4px;">Código EAN (GTIN)</label>
                                    <div style="position: relative;">
                                        <input type="text" id="pcp-produto-ean" placeholder="Opcional" style="width: 100%; padding: 12px; padding-right: 36px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                                        <i class="fas fa-barcode" style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); color: #999;"></i>
                                    </div>
                                </div>
                                <div>
                                    <label style="display: block; font-size: 12px; color: #f97316; margin-bottom: 4px;">Unidade</label>
                                    <select id="pcp-produto-unidade" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                                        <option value="">Selecione a unidade</option>
                                        <option value="UN">UN - Unidade</option>
                                        <option value="M">M - Metro</option>
                                        <option value="M2">MÂ² - Metro Quadrado</option>
                                        <option value="KG">KG - Quilograma</option>
                                        <option value="CX">CX - Caixa</option>
                                        <option value="PC">PC - Peça</option>
                                        <option value="RL">RL - Rolo</option>
                                        <option value="LT">LT - Litro</option>
                                    </select>
                                </div>
                                <div>
                                    <label style="display: block; font-size: 12px; color: #f97316; margin-bottom: 4px;">Preço Unitário de Venda</label>
                                    <input type="text" id="pcp-produto-preco" value="0,00" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; text-align: right;">
                                </div>
                                <div>
                                    <label style="display: block; font-size: 12px; color: #f97316; margin-bottom: 4px;">Código NCM</label>
                                    <div style="position: relative;">
                                        <input type="text" id="pcp-produto-ncm" placeholder="00000000" style="width: 100%; padding: 12px; padding-left: 36px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                                        <i class="fas fa-search" style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #999;"></i>
                                    </div>
                                </div>
                                <div>
                                    <label style="display: block; font-size: 12px; color: #f97316; margin-bottom: 4px;">Categoria</label>
                                    <select id="pcp-produto-categoria" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                                        <option value="GERAL">Geral</option>
                                        <option value="CABOS">Cabos</option>
                                        <option value="FIOS">Fios</option>
                                        <option value="ACESSORIOS">Acessórios</option>
                                        <option value="CONEXOES">Conexões</option>
                                        <option value="FERRAMENTAS">Ferramentas</option>
                                        <option value="MATERIA_PRIMA">Matéria Prima</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Definição do Produto -->
                        <div style="flex-shrink: 0; width: 180px;">
                            <h4 style="font-size: 13px; color: #333; margin: 0 0 16px 0; font-weight: 500;">Definição do Produto</h4>
                            
                            <div style="display: flex; flex-direction: column; gap: 12px;">
                                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                    <div class="toggle-switch-pcp" data-active="true" onclick="toggleDefinicaoProdutoPCP(this, 'simples')">
                                        <div class="toggle-slider"></div>
                                    </div>
                                    <span style="font-size: 13px; color: #333;">Simples</span>
                                    <i class="fas fa-info-circle" style="color: #999; font-size: 12px;"></i>
                                </label>
                                
                                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                    <div class="toggle-switch-pcp" onclick="toggleDefinicaoProdutoPCP(this, 'kit')">
                                        <div class="toggle-slider"></div>
                                    </div>
                                    <span style="font-size: 13px; color: #333;">Kit</span>
                                    <i class="fas fa-info-circle" style="color: #999; font-size: 12px;"></i>
                                </label>
                                
                                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                    <div class="toggle-switch-pcp" onclick="toggleDefinicaoProdutoPCP(this, 'variacoes')">
                                        <div class="toggle-slider"></div>
                                    </div>
                                    <span style="font-size: 13px; color: #333;">Com Variações</span>
                                    <i class="fas fa-info-circle" style="color: #999; font-size: 12px;"></i>
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Abas -->
                    <div style="border-bottom: 1px solid #e5e5e5; margin-bottom: 20px;">
                        <div style="display: flex; gap: 0; flex-wrap: wrap;">
                            <button class="pcp-produto-tab active" onclick="mudarAbaProdutoPCP('estoque', this)" style="padding: 12px 20px; background: none; border: none; border-bottom: 2px solid #f97316; color: #f97316; font-size: 13px; font-weight: 500; cursor: pointer;">Estoque</button>
                            <button class="pcp-produto-tab" onclick="mudarAbaProdutoPCP('custo', this)" style="padding: 12px 20px; background: none; border: none; border-bottom: 2px solid transparent; color: #666; font-size: 13px; cursor: pointer;">Custo do Estoque</button>
                            <button class="pcp-produto-tab" onclick="mudarAbaProdutoPCP('fornecedores', this)" style="padding: 12px 20px; background: none; border: none; border-bottom: 2px solid transparent; color: #666; font-size: 13px; cursor: pointer;">Fornecedores</button>
                            <button class="pcp-produto-tab" onclick="mudarAbaProdutoPCP('adicionais', this)" style="padding: 12px 20px; background: none; border: none; border-bottom: 2px solid transparent; color: #666; font-size: 13px; cursor: pointer;">Informações Adicionais</button>
                            <button class="pcp-produto-tab" onclick="mudarAbaProdutoPCP('observacoes', this)" style="padding: 12px 20px; background: none; border: none; border-bottom: 2px solid transparent; color: #666; font-size: 13px; cursor: pointer;">Observações</button>
                        </div>
                    </div>
                    
                    <!-- Conteíºdo das Abas -->
                    <div id="pcp-produto-tab-content">
                        <!-- Aba Estoque -->
                        <div id="pcp-tab-estoque" class="pcp-produto-tab-panel">
                            <h4 style="font-size: 14px; color: #333; margin: 0 0 8px 0; font-weight: 600;">Controle de Estoque</h4>
                            <p style="font-size: 12px; color: #666; margin: 0 0 16px 0;">Gerencie os níveis de estoque deste produto.</p>
                            
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-bottom: 20px;">
                                <div>
                                    <label style="display: block; font-size: 12px; color: #666; margin-bottom: 4px;">Estoque Atual</label>
                                    <input type="number" id="pcp-produto-estoque" value="0" step="0.01" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                                </div>
                                <div>
                                    <label style="display: block; font-size: 12px; color: #666; margin-bottom: 4px;">Estoque Mínimo</label>
                                    <input type="number" id="pcp-produto-estoque-minimo" value="0" step="1" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                                </div>
                                <div>
                                    <label style="display: block; font-size: 12px; color: #666; margin-bottom: 4px;">Local de Estoque</label>
                                    <select id="pcp-produto-local-estoque" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                                        <option value="PRINCIPAL">Estoque Principal</option>
                                        <option value="SECUNDARIO">Estoque Secundário</option>
                                        <option value="RESERVA">Reserva</option>
                                    </select>
                                </div>
                            </div>
                            
                            <!-- Tabela de Estoque -->
                            <div style="background: white; border: 1px solid #e5e5e5; border-radius: 8px; overflow: hidden;">
                                <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
                                    <thead>
                                        <tr style="background: #f8f8f8;">
                                            <th style="padding: 12px 16px; text-align: left; font-weight: 500; color: #333; border-bottom: 1px solid #e5e5e5;">Local</th>
                                            <th style="padding: 12px 16px; text-align: right; font-weight: 500; color: #333; border-bottom: 1px solid #e5e5e5;">Disponível</th>
                                            <th style="padding: 12px 16px; text-align: right; font-weight: 500; color: #333; border-bottom: 1px solid #e5e5e5;">Reservado</th>
                                            <th style="padding: 12px 16px; text-align: right; font-weight: 500; color: #333; border-bottom: 1px solid #e5e5e5;">Mínimo</th>
                                        </tr>
                                    </thead>
                                    <tbody id="pcp-tabela-estoque-body">
                                        <tr>
                                            <td colspan="4" style="padding: 40px; text-align: center; color: #999;">
                                                <i class="fas fa-inbox" style="font-size: 32px; margin-bottom: 8px; display: block;"></i>
                                                Nenhum registro de estoque
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <!-- Aba Custo -->
                        <div id="pcp-tab-custo" class="pcp-produto-tab-panel" style="display: none;">
                            <h4 style="font-size: 14px; color: #333; margin: 0 0 16px 0;">Custo do Estoque</h4>
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px;">
                                <div>
                                    <label style="display: block; font-size: 12px; color: #666; margin-bottom: 4px;">Preço de Custo (R$)</label>
                                    <input type="text" id="pcp-produto-preco-custo" value="0,00" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                                </div>
                                <div>
                                    <label style="display: block; font-size: 12px; color: #666; margin-bottom: 4px;">CMC Médio (R$)</label>
                                    <input type="text" id="pcp-produto-cmc" value="0,00" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;" readonly>
                                </div>
                                <div>
                                    <label style="display: block; font-size: 12px; color: #666; margin-bottom: 4px;">Margem (%)</label>
                                    <input type="text" id="pcp-produto-margem" value="0,00" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;" readonly>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Aba Fornecedores -->
                        <div id="pcp-tab-fornecedores" class="pcp-produto-tab-panel" style="display: none;">
                            <h4 style="font-size: 14px; color: #333; margin: 0 0 16px 0;">Fornecedores</h4>
                            <p style="color: #666; font-size: 13px;">Nenhum fornecedor vinculado a este produto.</p>
                            <button style="padding: 10px 20px; background: #f97316; color: white; border: none; border-radius: 6px; cursor: pointer; margin-top: 12px;">
                                <i class="fas fa-plus"></i> Adicionar Fornecedor
                            </button>
                        </div>
                        
                        <!-- Aba Informações Adicionais -->
                        <div id="pcp-tab-adicionais" class="pcp-produto-tab-panel" style="display: none;">
                            <h4 style="font-size: 14px; color: #333; margin: 0 0 16px 0;">Informações Adicionais</h4>
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px;">
                                <div>
                                    <label style="display: block; font-size: 12px; color: #666; margin-bottom: 4px;">Peso Bruto (kg)</label>
                                    <input type="number" id="pcp-produto-peso-bruto" placeholder="0.00" step="0.001" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                                </div>
                                <div>
                                    <label style="display: block; font-size: 12px; color: #666; margin-bottom: 4px;">Peso Líquido (kg)</label>
                                    <input type="number" id="pcp-produto-peso-liquido" placeholder="0.00" step="0.001" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                                </div>
                                <div>
                                    <label style="display: block; font-size: 12px; color: #666; margin-bottom: 4px;">Altura (cm)</label>
                                    <input type="number" id="pcp-produto-altura" placeholder="0.00" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                                </div>
                                <div>
                                    <label style="display: block; font-size: 12px; color: #666; margin-bottom: 4px;">Largura (cm)</label>
                                    <input type="number" id="pcp-produto-largura" placeholder="0.00" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                                </div>
                                <div>
                                    <label style="display: block; font-size: 12px; color: #666; margin-bottom: 4px;">Comprimento (cm)</label>
                                    <input type="number" id="pcp-produto-comprimento" placeholder="0.00" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Aba Observações -->
                        <div id="pcp-tab-observacoes" class="pcp-produto-tab-panel" style="display: none;">
                            <h4 style="font-size: 14px; color: #333; margin: 0 0 16px 0;">Observações</h4>
                            <textarea id="pcp-produto-observacoes" placeholder="Observações sobre o produto..." style="width: 100%; min-height: 150px; padding: 12px; border: 1px solid #ddd; border-radius: 6px; resize: vertical;"></textarea>
                        </div>
                    </div>
                </div>
                
                <!-- Sidebar Direita - Ações -->
                <div style="width: 140px; background: #f8f8f8; border-left: 1px solid #e5e5e5; padding: 20px 16px; display: flex; flex-direction: column; flex-shrink: 0;">
                    <button onclick="salvarProdutoPCP()" style="display: flex; align-items: center; gap: 8px; padding: 12px 16px; background: white; border: 1px solid #e5e5e5; border-radius: 6px; cursor: pointer; font-size: 13px; color: #333; margin-bottom: 12px;">
                        <i class="fas fa-save" style="color: #f97316;"></i> Salvar
                    </button>
                    <button onclick="limparFormProdutoPCP()" style="display: flex; align-items: center; gap: 8px; padding: 12px 16px; background: white; border: 1px solid #e5e5e5; border-radius: 6px; cursor: pointer; font-size: 13px; color: #333; margin-bottom: 12px;">
                        <i class="fas fa-eraser" style="color: #999;"></i> Limpar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Todas as Ordens Recentes -->
    <div class="modal-overlay" id="modal-todas-ordens">
        <div class="modal" style="max-width: 1100px; border-radius: 16px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #dc2626, #ef4444); border-radius: 16px 16px 0 0; padding: 20px 24px;">
                <h2 style="color: white; font-size: 18px; font-weight: 600; display: flex; align-items: center; gap: 10px; margin: 0;">
                    <i class="fas fa-clipboard-list"></i> Todas as Ordens de Produção
                </h2>
                <button onclick="fecharModalTodasOrdens()" style="width: 36px; height: 36px; border: none; background: rgba(255,255,255,0.2); border-radius: 8px; color: white; cursor: pointer; font-size: 16px;">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body" style="padding: 24px; max-height: 70vh; overflow-y: auto;">
                <!-- Filtros -->
                <div style="display: flex; gap: 12px; margin-bottom: 20px; flex-wrap: wrap;">
                    <div style="flex: 1; min-width: 250px;">
                        <input type="text" id="filtro-ordem-busca" placeholder="Buscar por código ou cliente..." 
                               style="width: 100%; padding: 10px 14px; border: 1px solid #e5e5e5; border-radius: 8px; font-size: 14px;" 
                               oninput="filtrarOrdensModal()">
                    </div>
                    <select id="filtro-ordem-status" onchange="filtrarOrdensModal()" 
                            style="padding: 10px 14px; border: 1px solid #e5e5e5; border-radius: 8px; font-size: 14px; min-width: 180px;">
                        <option value="">Todos os Status</option>
                        <option value="orcamento">Orçamento</option>
                        <option value="analise_credito">Análise de Crédito</option>
                        <option value="pedido_aprovado">Pedido Aprovado</option>
                        <option value="faturar">A Faturar</option>
                        <option value="faturado">Faturado</option>
                        <option value="entregue">Entregue</option>
                    </select>
                    <button onclick="exportarOrdensExcel()" class="btn btn-secondary" style="padding: 10px 16px;">
                        <i class="fas fa-file-excel"></i> Exportar
                    </button>
                </div>
                
                <!-- Tabela de Ordens -->
                <div style="border: 1px solid #e5e5e5; border-radius: 12px; overflow: hidden;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: #f8f9fa;">
                                <th style="padding: 14px 16px; text-align: left; font-size: 12px; font-weight: 600; color: #666; border-bottom: 1px solid #e5e5e5;">Código</th>
                                <th style="padding: 14px 16px; text-align: left; font-size: 12px; font-weight: 600; color: #666; border-bottom: 1px solid #e5e5e5;">Cliente/Empresa</th>
                                <th style="padding: 14px 16px; text-align: left; font-size: 12px; font-weight: 600; color: #666; border-bottom: 1px solid #e5e5e5;">Produto</th>
                                <th style="padding: 14px 16px; text-align: left; font-size: 12px; font-weight: 600; color: #666; border-bottom: 1px solid #e5e5e5;">Valor</th>
                                <th style="padding: 14px 16px; text-align: center; font-size: 12px; font-weight: 600; color: #666; border-bottom: 1px solid #e5e5e5;">Status</th>
                                <th style="padding: 14px 16px; text-align: center; font-size: 12px; font-weight: 600; color: #666; border-bottom: 1px solid #e5e5e5;">Data</th>
                                <th style="padding: 14px 16px; text-align: center; font-size: 12px; font-weight: 600; color: #666; border-bottom: 1px solid #e5e5e5;">Ações</th>
                            </tr>
                        </thead>
                        <tbody id="tabela-todas-ordens">
                            <tr><td colspan="7" style="padding: 40px; text-align: center; color: #999;">Carregando ordens...</td></tr>
                        </tbody>
                    </table>
                </div>
                
                <!-- Paginação -->
                <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 16px; padding-top: 16px; border-top: 1px solid #e5e5e5;">
                    <span style="font-size: 13px; color: #666;" id="info-paginacao-ordens">Mostrando 0 de 0 ordens</span>
                    <div style="display: flex; gap: 4px;" id="paginacao-ordens-btns"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Confirmação Customizado -->
    <div class="modal-overlay" id="modal-confirmacao-pcp" style="z-index: 10002;">
        <div style="background: white; border-radius: 12px; max-width: 400px; width: 90%; box-shadow: 0 20px 50px rgba(0,0,0,0.3); overflow: hidden;">
            <div style="padding: 24px 24px 16px; text-align: center;">
                <div id="confirmacao-icon" style="width: 60px; height: 60px; margin: 0 auto 16px; border-radius: 50%; display: flex; align-items: center; justify-content: center; background: #fef3c7;">
                    <i class="fas fa-exclamation-triangle" style="font-size: 28px; color: #f59e0b;"></i>
                </div>
                <h3 id="confirmacao-titulo" style="margin: 0 0 8px; font-size: 18px; color: #333;">Confirmar Ação</h3>
                <p id="confirmacao-mensagem" style="margin: 0; color: #666; font-size: 14px;">Você tem certeza que deseja continuar?</p>
            </div>
            <div style="display: flex; gap: 12px; padding: 16px 24px 24px; justify-content: center;">
                <button id="confirmacao-btn-cancelar" onclick="fecharConfirmacaoPCP(false)" style="flex: 1; padding: 12px 24px; background: #f3f4f6; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 500; color: #666; transition: all 0.2s;">
                    Cancelar
                </button>
                <button id="confirmacao-btn-confirmar" onclick="fecharConfirmacaoPCP(true)" style="flex: 1; padding: 12px 24px; background: linear-gradient(135deg, #f97316, #ea580c); border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 500; color: white; transition: all 0.2s;">
                    Confirmar
                </button>
            </div>
        </div>
    </div>

    <!-- Estilos do Modal Produto PCP -->
    <style>
        .modal-content-omie {
            background: white;
            animation: slideUp 0.3s ease;
        }
        @keyframes slideUp {
            from { transform: translateY(30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .toggle-switch-pcp {
            width: 44px;
            height: 24px;
            background: #ddd;
            border-radius: 12px;
            position: relative;
            cursor: pointer;
            transition: all 0.3s;
        }
        .toggle-switch-pcp[data-active="true"] {
            background: #f97316;
        }
        .toggle-switch-pcp .toggle-slider {
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            position: absolute;
            top: 2px;
            left: 2px;
            transition: all 0.3s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .toggle-switch-pcp[data-active="true"] .toggle-slider {
            left: 22px;
        }
        .pcp-produto-tab.active {
            color: #f97316 !important;
            border-bottom-color: #f97316 !important;
        }
        #modal-confirmacao-pcp .modal-overlay {
            backdrop-filter: blur(4px);
        }
        #confirmacao-btn-cancelar:hover {
            background: #e5e7eb;
        }
        #confirmacao-btn-confirmar:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(249, 115, 22, 0.4);
        }
    </style>

    <!-- SCRIPTS -->
    <script>
        // ============================================
        // NAVEGAÇÃO ENTRE VIEWS
        // ============================================
        function navigateTo(viewName) {
            // Esconde todas as views
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            
            // Mostra a view selecionada
            const view = document.getElementById('view-' + viewName);
            if (view) {
                view.classList.add('active');
            }
            
            // Atualiza botões da sidebar
            document.querySelectorAll('.sidebar-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.view === viewName) {
                    btn.classList.add('active');
                }
            });

            // Carregar dados específicos da view
            if (viewName === 'produtos') {
                buscarProdutos();
            } else if (viewName === 'materiais') {
                if (typeof carregarMateriais === 'function') carregarMateriais();
            }
        }

        // Alias para navigateTo (compatibilidade com novo padrão sidebar)
        function showView(viewId) {
            // Remove prefixo 'view-' se existir
            const cleanViewName = viewId.replace('view-', '');
            
            // Esconde todas as views
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            
            // Mostra a view selecionada
            const view = document.getElementById('view-' + cleanViewName);
            if (view) {
                view.classList.add('active');
            }
            
            // Atualiza estado ativo dos botões da sidebar
            document.querySelectorAll('.sidebar-nav .sidebar-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Marca o botão correto como ativo baseado no data-view
            document.querySelectorAll('.sidebar-nav .sidebar-btn[data-view]').forEach(btn => {
                if (btn.dataset.view === viewId || btn.dataset.view === 'view-' + cleanViewName) {
                    btn.classList.add('active');
                }
            });

            // Atualiza o título do header
            const viewTitles = {
                'dashboard': 'Módulo PCP',
                'produtos': 'PCP | Produtos e Estoque',
                'ordem-compra': 'PCP | Ordem de Compra',
                'faturamento': 'PCP | Programação de Faturamento',
                'materiais': 'PCP | Gestão de Materiais'
            };
            const titleEl = document.getElementById('current-view-title');
            if (titleEl && viewTitles[cleanViewName]) {
                titleEl.textContent = viewTitles[cleanViewName];
            }

            // Carregar dados específicos da view
            if (cleanViewName === 'produtos') {
                buscarProdutos();
            } else if (cleanViewName === 'materiais') {
                if (typeof carregarMateriais === 'function') carregarMateriais();
            }
        }

        // ============================================
        // MODAL: TODAS AS ORDENS DE PRODUÇÃO
        // ============================================
        let todasOrdens = [];
        let ordensFiltradasModal = [];
        let paginaAtualOrdens = 1;
        const ordensPorPagina = 10;

        function abrirModalTodasOrdens() {
            document.getElementById('modal-todas-ordens').classList.add('active');
            carregarTodasOrdens();
        }

        function fecharModalTodasOrdens() {
            document.getElementById('modal-todas-ordens').classList.remove('active');
        }

        async function carregarTodasOrdens() {
            const tbody = document.getElementById('tabela-todas-ordens');
            tbody.innerHTML = '<tr><td colspan="7" style="padding: 40px; text-align: center; color: #999;"><i class="fas fa-spinner fa-spin"></i> Carregando ordens...</td></tr>';
            
            try {
                // Buscar pedidos do módulo Vendas (mesma fonte do Ordens Recentes)
                const response = await fetch('/api/vendas/pedidos?limit=100', { credentials: 'include' });
                if (!response.ok) throw new Error('Erro ao carregar pedidos');
                
                const pedidos = await response.json();
                
                // Mapear pedidos para o formato esperado pelo modal
                todasOrdens = pedidos.map(pedido => ({
                    id: pedido.id,
                    codigo: `#${pedido.id}`,
                    cliente: pedido.empresa_nome || 'Não informado',
                    produto: pedido.produto_nome || pedido.descricao || '-',
                    valor: pedido.valor || 0,
                    status: pedido.status || 'orcamento',
                    data: pedido.created_at
                }));
                
                ordensFiltradasModal = [...todasOrdens];
                renderizarOrdensModal();
                
            } catch (error) {
                console.error('Erro ao carregar ordens:', error);
                tbody.innerHTML = '<tr><td colspan="7" style="padding: 40px; text-align: center; color: #999;"><i class="fas fa-exclamation-triangle" style="color: #ef4444;"></i> Erro ao carregar ordens. <button onclick="carregarTodasOrdens()" style="color: #3b82f6; background: none; border: none; cursor: pointer; text-decoration: underline;">Tentar novamente</button></td></tr>';
            }
        }

        function filtrarOrdensModal() {
            const busca = document.getElementById('filtro-ordem-busca').value.toLowerCase();
            const status = document.getElementById('filtro-ordem-status').value;
            
            ordensFiltradasModal = todasOrdens.filter(ordem => {
                const matchBusca = !busca || 
                    ordem.codigo.toLowerCase().includes(busca) || 
                    ordem.cliente.toLowerCase().includes(busca) ||
                    (ordem.produto && ordem.produto.toLowerCase().includes(busca));
                const matchStatus = !status || ordem.status === status;
                return matchBusca && matchStatus;
            });
            
            paginaAtualOrdens = 1;
            renderizarOrdensModal();
        }

        function renderizarOrdensModal() {
            const tbody = document.getElementById('tabela-todas-ordens');
            const inicio = (paginaAtualOrdens - 1) * ordensPorPagina;
            const fim = inicio + ordensPorPagina;
            const ordensPagina = ordensFiltradasModal.slice(inicio, fim);
            
            // Mapeamento de status igual ao Ordens Recentes
            const statusConfig = {
                'orcamento': { cor: '#64748b', bg: '#f1f5f9', texto: 'Orçamento' },
                'analise_credito': { cor: '#f59e0b', bg: '#fef3c7', texto: 'Análise Crédito' },
                'pedido_aprovado': { cor: '#3b82f6', bg: '#dbeafe', texto: 'Pedido Aprovado' },
                'aprovado': { cor: '#3b82f6', bg: '#dbeafe', texto: 'Pedido Aprovado' },
                'faturar': { cor: '#f97316', bg: '#ffedd5', texto: 'A Faturar' },
                'faturado': { cor: '#22c55e', bg: '#dcfce7', texto: 'Faturado' },
                'entregue': { cor: '#8b5cf6', bg: '#ede9fe', texto: 'Entregue' },
                'cancelado': { cor: '#ef4444', bg: '#fee2e2', texto: 'Cancelado' }
            };
            
            if (ordensPagina.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="padding: 40px; text-align: center; color: #999;"><i class="fas fa-inbox" style="font-size: 32px; margin-bottom: 10px; display: block;"></i>Nenhuma ordem encontrada</td></tr>';
            } else {
                tbody.innerHTML = ordensPagina.map(ordem => {
                    const st = statusConfig[ordem.status] || statusConfig.orcamento;
                    
                    // Pedidos faturar ou faturado podem gerar OP (mesma lógica do Ordens Recentes)
                    const podeGerarOP = ordem.status === 'faturado' || ordem.status === 'faturar';
                    const botaoAcao = podeGerarOP 
                        ? `<button onclick="abrirOrdemProducaoDePedido(${ordem.id})" style="width: 32px; height: 32px; border: none; border-radius: 6px; background: #22c55e; color: white; cursor: pointer;" title="Gerar Ordem de Produção">
                            <i class="fas fa-industry"></i>
                           </button>`
                        : `<button onclick="visualizarPedido(${ordem.id})" style="width: 32px; height: 32px; border: none; border-radius: 6px; background: #f1f5f9; color: #64748b; cursor: pointer;" title="Visualizar Pedido">
                            <i class="fas fa-eye"></i>
                           </button>`;
                    
                    return `
                        <tr style="border-bottom: 1px solid #f1f5f9;">
                            <td style="padding: 14px 16px; font-weight: 600; color: #dc2626;">${ordem.codigo}</td>
                            <td style="padding: 14px 16px;">${ordem.cliente}</td>
                            <td style="padding: 14px 16px; color: #666;">${ordem.produto || '-'}</td>
                            <td style="padding: 14px 16px; font-weight: 600;">R$ ${parseFloat(ordem.valor || 0).toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
                            <td style="padding: 14px 16px; text-align: center;">
                                <span style="padding: 4px 12px; border-radius: 20px; font-size: 11px; font-weight: 600; background: ${st.bg}; color: ${st.cor};">${st.texto}</span>
                            </td>
                            <td style="padding: 14px 16px; text-align: center; color: #666;">${formatarDataBR(ordem.data)}</td>
                            <td style="padding: 14px 16px; text-align: center;">
                                ${botaoAcao}
                            </td>
                        </tr>
                    `;
                }).join('');
            }
            
            // Atualizar informação de paginação
            const total = ordensFiltradasModal.length;
            const mostrando = Math.min(fim, total);
            document.getElementById('info-paginacao-ordens').textContent = `Mostrando ${inicio + 1}-${mostrando} de ${total} ordens`;
            
            // Renderizar botões de paginação
            const totalPaginas = Math.ceil(total / ordensPorPagina);
            const btnContainer = document.getElementById('paginacao-ordens-btns');
            btnContainer.innerHTML = '';
            
            if (totalPaginas > 1) {
                // Anterior
                const btnPrev = document.createElement('button');
                btnPrev.innerHTML = '<i class="fas fa-chevron-left"></i>';
                btnPrev.style.cssText = 'width: 32px; height: 32px; border: 1px solid #e5e5e5; background: white; border-radius: 6px; cursor: pointer;';
                btnPrev.disabled = paginaAtualOrdens === 1;
                btnPrev.onclick = () => { paginaAtualOrdens--; renderizarOrdensModal(); };
                btnContainer.appendChild(btnPrev);
                
                // Páginas
                for (let i = 1; i <= Math.min(totalPaginas, 5); i++) {
                    const btn = document.createElement('button');
                    btn.textContent = i;
                    btn.style.cssText = `width: 32px; height: 32px; border: 1px solid ${i === paginaAtualOrdens ? '#dc2626' : '#e5e5e5'}; background: ${i === paginaAtualOrdens ? '#dc2626' : 'white'}; color: ${i === paginaAtualOrdens ? 'white' : '#333'}; border-radius: 6px; cursor: pointer; margin: 0 2px;`;
                    btn.onclick = () => { paginaAtualOrdens = i; renderizarOrdensModal(); };
                    btnContainer.appendChild(btn);
                }
                
                // Próximo
                const btnNext = document.createElement('button');
                btnNext.innerHTML = '<i class="fas fa-chevron-right"></i>';
                btnNext.style.cssText = 'width: 32px; height: 32px; border: 1px solid #e5e5e5; background: white; border-radius: 6px; cursor: pointer;';
                btnNext.disabled = paginaAtualOrdens === totalPaginas;
                btnNext.onclick = () => { paginaAtualOrdens++; renderizarOrdensModal(); };
                btnContainer.appendChild(btnNext);
            }
        }

        function formatarDataBR(data) {
            if (!data) return '-';
            const d = new Date(data);
            return d.toLocaleDateString('pt-BR');
        }

        function visualizarOrdem(id) {
            const ordem = todasOrdens.find(o => o.id === id);
            if (ordem) {
                alert(`Detalhes da Ordem ${ordem.codigo}\\n\\nCliente: ${ordem.cliente}\\nProduto: ${ordem.produto || '-'}\\nValor: R$ ${parseFloat(ordem.valor).toLocaleString('pt-BR', {minimumFractionDigits: 2})}\\nStatus: ${ordem.status}\\nData: ${formatarDataBR(ordem.data)}`);
            }
        }

        function editarOrdemProducao(id) {
            mostrarNotificacao('Funcionalidade de edição em desenvolvimento', 'info');
        }

        function exportarOrdensExcel() {
            mostrarNotificacao('Exportando ordens para Excel...', 'success');
        }

        // Fechar modal ao clicar fora
        document.getElementById('modal-todas-ordens')?.addEventListener('click', function(e) {
            if (e.target === this) fecharModalTodasOrdens();
        });

        // ============================================
        // NOTIFICAÇÕES - PADRÃO VENDAS
        // ============================================
        function toggleNotificacoes() {
            const panel = document.getElementById('notification-panel');
            if (panel) {
                panel.classList.toggle('active');
            }
        }

        function marcarTodasLidas() {
            console.log('Marcando todas notificações como lidas');
            notificacoesPCP.forEach(n => n.lida = true);
            salvarNotificacoesPCP();
            renderizarNotificacoesPCP();
            atualizarBadgeNotificacoes();
        }

        function limparNotificacoes() {
            console.log('Limpando todas notificações');
            const list = document.getElementById('notification-list');
            if (list) {
                list.innerHTML = `
                    <div class="notification-empty">
                        <i class="fas fa-check-circle"></i>
                        <p>Nenhuma notificação</p>
                    </div>
                `;
            }
            marcarTodasLidas();
            // Limpar do localStorage também
            localStorage.removeItem('pcp_notificacoes');
        }

        // Dados de notificações do PCP
        let notificacoesPCP = [];
        let filtroAtualPCP = 'todas';
        
        // Carregar notificações salvas
        function carregarNotificacoesPCP() {
            try {
                const salvas = localStorage.getItem('pcp_notificacoes');
                if (salvas) {
                    notificacoesPCP = JSON.parse(salvas);
                }
            } catch(e) {
                console.error('Erro ao carregar notificações:', e);
            }
        }
        
        // Salvar notificações
        function salvarNotificacoesPCP() {
            try {
                localStorage.setItem('pcp_notificacoes', JSON.stringify(notificacoesPCP));
            } catch(e) {
                console.error('Erro ao salvar notificações:', e);
            }
        }
        
        // Adicionar nova notificação
        function adicionarNotificacaoPCP(titulo, mensagem, tipo = 'info', origem = 'usuario') {
            const notif = {
                id: Date.now(),
                titulo: titulo,
                mensagem: mensagem,
                tipo: tipo, // info, success, warning, error
                origem: origem, // usuario, sistema
                lida: false,
                data: new Date().toISOString()
            };
            notificacoesPCP.unshift(notif);
            salvarNotificacoesPCP();
            renderizarNotificacoesPCP();
            atualizarBadgeNotificacoes();
        }
        
        // Filtrar notificações
        function filtrarNotificacoesPCP(filtro, btnElement) {
            filtroAtualPCP = filtro;
            
            // Atualizar tabs ativas
            document.querySelectorAll('.notif-tab').forEach(tab => {
                tab.classList.remove('active');
                tab.style.background = 'transparent';
                tab.style.color = 'var(--gray-400)';
            });
            
            if (btnElement) {
                btnElement.classList.add('active');
                btnElement.style.background = 'rgba(220, 38, 38, 0.2)';
                btnElement.style.color = '#dc2626';
            }
            
            renderizarNotificacoesPCP();
        }
        
        // Renderizar lista de notificações
        function renderizarNotificacoesPCP() {
            const list = document.getElementById('notification-list');
            if (!list) return;
            
            let notifsFiltradas = [...notificacoesPCP];
            
            // Aplicar filtro
            if (filtroAtualPCP === 'nao-lidas') {
                notifsFiltradas = notifsFiltradas.filter(n => !n.lida);
            } else if (filtroAtualPCP === 'sistema') {
                notifsFiltradas = notifsFiltradas.filter(n => n.origem === 'sistema');
            }
            
            if (notifsFiltradas.length === 0) {
                list.innerHTML = `
                    <div class="notification-empty">
                        <i class="fas fa-check-circle"></i>
                        <p>${filtroAtualPCP === 'nao-lidas' ? 'Todas notificações foram lidas' : 
                            filtroAtualPCP === 'sistema' ? 'Nenhuma notificação do sistema' : 
                            'Nenhuma notificação'}</p>
                    </div>
                `;
                return;
            }
            
            const iconesPorTipo = {
                info: 'fa-info-circle',
                success: 'fa-check-circle',
                warning: 'fa-exclamation-triangle',
                error: 'fa-times-circle'
            };
            
            const coresPorTipo = {
                info: '#3b82f6',
                success: '#22c55e',
                warning: '#f59e0b',
                error: '#ef4444'
            };
            
            list.innerHTML = notifsFiltradas.map(notif => {
                const dataFormatada = new Date(notif.data).toLocaleString('pt-BR', {
                    day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit'
                });
                
                return `
                    <div class="notification-item ${notif.lida ? 'read' : ''}" 
                         style="padding: 12px; border-bottom: 1px solid var(--dark-border); cursor: pointer; ${!notif.lida ? 'background: rgba(220, 38, 38, 0.05);' : ''}"
                         onclick="marcarNotificacaoLida(${notif.id})">
                        <div style="display: flex; align-items: flex-start; gap: 12px;">
                            <div style="width: 32px; height: 32px; border-radius: 50%; background: ${coresPorTipo[notif.tipo]}20; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                                <i class="fas ${iconesPorTipo[notif.tipo]}" style="color: ${coresPorTipo[notif.tipo]}; font-size: 14px;"></i>
                            </div>
                            <div style="flex: 1; min-width: 0;">
                                <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 8px;">
                                    <span style="font-weight: 500; color: var(--gray-100); font-size: 13px;">${notif.titulo}</span>
                                    ${!notif.lida ? '<div style="width: 6px; height: 6px; background: #dc2626; border-radius: 50%; flex-shrink: 0;"></div>' : ''}
                                </div>
                                <p style="color: var(--gray-400); font-size: 12px; margin: 4px 0; line-height: 1.4;">${notif.mensagem}</p>
                                <span style="color: var(--gray-500); font-size: 11px;">${dataFormatada}</span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Marcar notificação como lida
        function marcarNotificacaoLida(id) {
            const notif = notificacoesPCP.find(n => n.id === id);
            if (notif) {
                notif.lida = true;
                salvarNotificacoesPCP();
                renderizarNotificacoesPCP();
                atualizarBadgeNotificacoes();
            }
        }
        
        // Atualizar badge de contagem
        function atualizarBadgeNotificacoes() {
            const badge = document.getElementById('notification-count');
            const naoLidas = notificacoesPCP.filter(n => !n.lida).length;
            
            if (badge) {
                if (naoLidas > 0) {
                    badge.textContent = naoLidas > 99 ? '99+' : naoLidas;
                    badge.style.display = 'flex';
                } else {
                    badge.style.display = 'none';
                }
            }
        }
        
        // Inicializar sistema de notificações
        carregarNotificacoesPCP();
        renderizarNotificacoesPCP();
        atualizarBadgeNotificacoes();
        
        // Expor função para outros módulos
        window.adicionarNotificacaoPCP = adicionarNotificacaoPCP;

        // Fechar painel de notificações ao clicar fora
        document.addEventListener('click', function(e) {
            const panel = document.getElementById('notification-panel');
            const btn = document.querySelector('.header-btn[title="Notificações"]');
            if (panel && panel.classList.contains('active')) {
                if (!panel.contains(e.target) && !btn?.contains(e.target)) {
                    panel.classList.remove('active');
                }
            }
        });

        // Event listeners para navegação via sidebar (previne reload e usa showView)
        document.querySelectorAll('.sidebar-nav .sidebar-btn[data-view]').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.preventDefault();
                showView(btn.dataset.view);
            });
        });

        // ============================================
        // DARK MODE
        // ============================================
        const darkModeBtn = document.getElementById('btn-dark-mode');
        darkModeBtn?.addEventListener('click', () => {
            document.body.classList.toggle('dark-mode');
            const icon = darkModeBtn.querySelector('i');
            icon.classList.toggle('fa-moon');
            icon.classList.toggle('fa-sun');
            localStorage.setItem('darkMode', document.body.classList.contains('dark-mode'));
        });

        // Carregar preferência salva
        if (localStorage.getItem('darkMode') === 'true') {
            document.body.classList.add('dark-mode');
            const icon = darkModeBtn?.querySelector('i');
            if (icon) {
                icon.classList.remove('fa-moon');
                icon.classList.add('fa-sun');
            }
        }

        // ============================================
        // MODAIS
        // ============================================
        function showModal(modalId) {
            const overlay = document.getElementById(modalId);
            if (overlay) {
                document.body.classList.add('modal-open');
                overlay.classList.add('active');
                // Força o modal para o final do body para evitar problemas de stacking context
                document.body.appendChild(overlay);
            }
        }

        function hideModal(modalId) {
            const overlay = document.getElementById(modalId);
            if (overlay) {
                overlay.classList.remove('active');
                document.body.classList.remove('modal-open');
            }
        }

        // Fechar modal ao clicar fora
        document.querySelectorAll('.modal-overlay').forEach(overlay => {
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                    overlay.classList.remove('active');
                }
            });
        });

        // ============================================
        // REFRESH
        // ============================================
        document.getElementById('btn-refresh')?.addEventListener('click', () => {
            location.reload();
        });

        // ============================================
        // SISTEMA DE NOTIFICAÇÕES
        // ============================================
        function showNotification(message, type = 'info') {
            // Remover notificação anterior se existir
            const oldNotif = document.querySelector('.pcp-notification');
            if (oldNotif) oldNotif.remove();
            
            const notification = document.createElement('div');
            notification.className = `pcp-notification pcp-notification-${type}`;
            
            const icons = {
                'success': 'fa-check-circle',
                'error': 'fa-times-circle',
                'warning': 'fa-exclamation-triangle',
                'info': 'fa-info-circle'
            };
            
            notification.innerHTML = `
                <i class="fas ${icons[type] || icons.info}"></i>
                <span>${message}</span>
                <button onclick="this.parentElement.remove()" style="background:none;border:none;color:inherit;cursor:pointer;margin-left:auto;">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            // Estilos inline
            notification.style.cssText = `
                position: fixed;
                top: 80px;
                right: 20px;
                padding: 16px 20px;
                border-radius: 12px;
                display: flex;
                align-items: center;
                gap: 12px;
                font-size: 14px;
                font-weight: 500;
                z-index: 10001;
                box-shadow: 0 10px 25px rgba(0,0,0,0.15);
                animation: slideIn 0.3s ease;
                max-width: 400px;
            `;
            
            const colors = {
                'success': { bg: '#dcfce7', color: '#166534', border: '#22c55e' },
                'error': { bg: '#fee2e2', color: '#991b1b', border: '#ef4444' },
                'warning': { bg: '#fef3c7', color: '#92400e', border: '#f59e0b' },
                'info': { bg: '#dbeafe', color: '#1e40af', border: '#3b82f6' }
            };
            
            const colorConfig = colors[type] || colors.info;
            notification.style.background = colorConfig.bg;
            notification.style.color = colorConfig.color;
            notification.style.borderLeft = `4px solid ${colorConfig.border}`;
            
            document.body.appendChild(notification);
            
            // Auto-remover após 5 segundos
            setTimeout(() => notification.remove(), 5000);
        }

        // ============================================
        // MODAL NOVA ORDEM DE PRODUÇÃO
        // ============================================
        
        // Alternar entre abas
        function switchOPTab(tabName) {
            // Remove active de todas as abas
            document.querySelectorAll('.modal-op-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.modal-op-tab-pane').forEach(pane => {
                pane.classList.remove('active');
            });
            
            // Ativa a aba selecionada
            document.querySelector(`.modal-op-tab[data-tab="${tabName}"]`)?.classList.add('active');
            document.getElementById(`op-tab-${tabName}`)?.classList.add('active');
        }

        // Buscar produto
        function buscarProdutoOP() {
            const produto = document.getElementById('op-produto')?.value;
            console.log('Buscando produto:', produto);
            // TODO: Implementar busca de produto via API
            showNotification('Funcionalidade de busca em desenvolvimento.', 'info');
        }

        // Salvar ordem de Produção
        function salvarOrdemProducao() {
            const dados = coletarDadosOP();
            
            // Validação básica
            if (!dados.cliente && (!dados.produtos || dados.produtos.length === 0)) {
                showNotification('Por favor, informe o cliente ou adicione produtos.', 'warning');
                switchOPTab('cliente');
                document.getElementById('op-cliente')?.focus();
                return;
            }
            
            console.log(' Salvando ordem de Produção:', dados);
            console.log(' Quantidade de produtos:', dados.produtos?.length || 0);
            
            // Salvar via API
            fetch('/api/pcp/ordens-kanban', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify(dados)
            })
            .then(response => {
                if (response.ok) {
                    return response.json();
                }
                throw new Error('Falha na API');
            })
            .then(novaOrdem => {
                showNotification('Ordem de Produção criada com sucesso!', 'success');
                hideModal('modal-nova-ordem');
                
                // Adicionar notificação ao painel
                adicionarNotificacaoPCP(
                    'Ordem de Produção Criada',
                    `OP ${novaOrdem.numero || 'Nova'} criada para ${dados.cliente || 'cliente'}`,
                    'success',
                    'usuario'
                );
                
                // Sincronizar com localStorage para a página de Kanban
                sincronizarOrdemLocalStorage(novaOrdem);
                
                // Atualizar dashboard se necessário
                if (typeof loadDashboardData === 'function') {
                    loadDashboardData();
                }
            })
            .catch(error => {
                console.log('API Não disponível, salvando localmente:', error);
                salvarOPLocal(dados);
            });
        }
        
        // Sincronizar ordem com localStorage (para página Kanban)
        function sincronizarOrdemLocalStorage(ordem) {
            try {
                const ordensLocais = JSON.parse(localStorage.getItem('ordensProducao') || '[]');
                
                // Formatar ordem para o padrão do Kanban
                const ordemFormatada = {
                    id: ordem.id || Date.now(),
                    numero: ordem.numero || `OP Nº ${new Date().getFullYear()}/${String(ordensLocais.length + 1).padStart(5, '0')}`,
                    status: ordem.statusKanban || 'a_produzir',
                    statusTexto: ordem.statusTexto || 'Nova',
                    produto: ordem.produto || ordem.cliente || 'Produto',
                    descricao: ordem.descricao || '',
                    codigo: ordem.codigo || '',
                    dataConclusao: ordem.dataConclusao || ordem.data_previsao_entrega,
                    quantidade: parseFloat(ordem.quantidade) || 0,
                    produzido: 0,
                    unidade: ordem.unidade || 'M'
                };
                
                ordensLocais.unshift(ordemFormatada);
                localStorage.setItem('ordensProducao', JSON.stringify(ordensLocais));
                console.log(' Ordem sincronizada com localStorage:', ordemFormatada.numero);
            } catch (e) {
                console.warn('Erro ao sincronizar localStorage:', e);
            }
        }

        // Coletar todos os dados do formulário
        function coletarDadosOP() {
            const clienteNome = document.getElementById('op-cliente')?.value || '';
            const clienteCnpj = document.getElementById('op-cliente-cnpj')?.value || '';
            const clienteContato = document.getElementById('op-cliente-contato')?.value || '';
            const clienteFone = document.getElementById('op-cliente-fone')?.value || '';
            const clienteEmail = document.getElementById('op-cliente-email')?.value || '';
            const tipoFrete = document.getElementById('op-tipo-frete')?.value || 'CIF';
            const transpNome = document.getElementById('op-transportadora-nome')?.value || '';
            const transpCnpj = document.getElementById('op-transportadora-cnpj')?.value || '';
            const transpFone = document.getElementById('op-transportadora-fone')?.value || '';
            const transpCep = document.getElementById('op-transportadora-cep')?.value || '';
            const transpEmail = document.getElementById('op-transportadora-email')?.value || '';
            const transpEndereco = document.getElementById('op-transportadora-endereco')?.value || '';
            const observacoes = document.getElementById('op-observacoes')?.value || '';
            
            return {
                // Dados da OP
                numero_sequencial: document.getElementById('op-numero')?.value?.replace(/\D/g, '') || '',
                numero_orcamento: document.getElementById('op-orcamento')?.value || '',
                num_orcamento: document.getElementById('op-orcamento')?.value || '', // Alias
                data_liberacao: document.getElementById('op-data-liberacao')?.value || new Date().toLocaleDateString('pt-BR'),
                
                // Vendedor
                vendedor: document.getElementById('op-vendedor')?.value || '',
                prazo_entrega: document.getElementById('op-prazo-entrega')?.value || '',
                tipo_frete: tipoFrete,
                frete: tipoFrete, // Alias
                
                // Cliente (com aliases para compatibilidade)
                cliente: clienteNome,
                cpf_cnpj: clienteCnpj,
                cliente_cpf_cnpj: clienteCnpj, // Alias
                contato_cliente: clienteContato,
                contato: clienteContato, // Alias
                fone_cliente: clienteFone,
                telefone: clienteFone, // Alias
                email_cliente: clienteEmail,
                email: clienteEmail, // Alias
                email_nfe: clienteEmail, // Alias para NF-e
                
                // Transportadora (com aliases)
                transportadora_nome: transpNome,
                transportadora_cpf_cnpj: transpCnpj,
                transportadora_fone: transpFone,
                transportadora_cep: transpCep,
                transportadora_email_nfe: transpEmail,
                transportadora_endereco: transpEndereco,
                // Objeto transportadora para compatibilidade
                transportadora: {
                    nome: transpNome,
                    cpf_cnpj: transpCnpj,
                    fone: transpFone,
                    cep: transpCep,
                    email_nfe: transpEmail,
                    endereco: transpEndereco
                },
                
                // Produtos
                produtos: produtosOP,
                
                // Pagamento - Múltiplas formas com percentuais
                formas_pagamento: [
                    {
                        forma: document.getElementById('op-forma-pagamento-1')?.value || 'A_VISTA',
                        percentual: parseFloat(document.getElementById('op-percent-1')?.value) || 0,
                        metodo: document.getElementById('op-metodo-pagamento-1')?.value || 'BOLETO',
                        valor: parseMoeda(document.getElementById('op-valor-pagamento-1')?.textContent || '0')
                    },
                    {
                        forma: document.getElementById('op-forma-pagamento-2')?.value || '',
                        percentual: parseFloat(document.getElementById('op-percent-2')?.value) || 0,
                        metodo: document.getElementById('op-metodo-pagamento-2')?.value || '',
                        valor: parseMoeda(document.getElementById('op-valor-pagamento-2')?.textContent || '0')
                    },
                    {
                        forma: document.getElementById('op-forma-pagamento-3')?.value || '',
                        percentual: parseFloat(document.getElementById('op-percent-3')?.value) || 0,
                        metodo: document.getElementById('op-metodo-pagamento-3')?.value || '',
                        valor: parseMoeda(document.getElementById('op-valor-pagamento-3')?.textContent || '0')
                    }
                ].filter(p => p.forma && p.percentual > 0),
                // Campos de compatibilidade (primeira forma de pagamento)
                forma_pagamento: document.getElementById('op-forma-pagamento-1')?.value || 'A_VISTA',
                metodo_pagamento: document.getElementById('op-metodo-pagamento-1')?.value || 'BOLETO',
                percentual_pagamento: parseFloat(document.getElementById('op-percent-1')?.value) || 100,
                condicoes_pagamento: document.getElementById('op-condicoes-pagamento')?.value || '',
                
                // Entrega
                data_previsao_entrega: document.getElementById('op-data-entrega')?.value || '',
                qtd_volumes: document.getElementById('op-qtd-volumes')?.value || '',
                tipo_embalagem_entrega: document.getElementById('op-tipo-embalagem')?.value || '',
                observacoes_entrega: document.getElementById('op-obs-entrega')?.value || '',
                
                // Observações (com aliases)
                observacoes_pedido: observacoes,
                observacoes: observacoes // Alias
            };
        }

        // Salvar OP localmente (fallback)
        function salvarOPLocal(dados) {
            const ordensLocais = JSON.parse(localStorage.getItem('ordensProducao') || '[]');
            
            // Criar ordem no formato do Kanban
            const novaOrdem = {
                id: Date.now(),
                numero: `OP Nº ${new Date().getFullYear()}/${String(ordensLocais.length + 1).padStart(5, '0')}`,
                status: 'a_produzir',
                statusTexto: 'Nova',
                produto: dados.produtos?.[0]?.descricao || dados.cliente || 'Produto',
                descricao: dados.produtos?.[0]?.descricao || '',
                codigo: dados.produtos?.[0]?.codigo || '',
                dataConclusao: dados.data_previsao_entrega || dados.prazo_entrega,
                quantidade: parseFloat(dados.produtos?.[0]?.quantidade) || 0,
                produzido: 0,
                unidade: dados.produtos?.[0]?.unidade || 'M',
                cliente: dados.cliente,
                vendedor: dados.vendedor,
                observacoes: dados.observacoes_pedido
            };
            
            ordensLocais.unshift(novaOrdem);
            localStorage.setItem('ordensProducao', JSON.stringify(ordensLocais));
            showNotification('Ordem salva localmente!', 'success');
            hideModal('modal-nova-ordem');
            
            // Adicionar notificação ao painel
            adicionarNotificacaoPCP(
                'Ordem de Produção Salva',
                `${novaOrdem.numero} salva localmente para ${dados.cliente || 'cliente'}`,
                'success',
                'usuario'
            );
            
            console.log(' Ordem salva localmente:', novaOrdem.numero);
        }

        // ============================================
        // CATíLOGO DE PRODUTOS ALUFORCE
        // (Mesmo catálogo do template Excel N18:O174)
        // ============================================
        const catalogoProdutos = [
            { codigo: 'DUN10', descricao: 'ALUFORCE CB DUPLEX 10mmÂ² NEUTRO NÚ' },
            { codigo: 'DUN16', descricao: 'ALUFORCE CB DUPLEX 16mmÂ² NEUTRO NÚ' },
            { codigo: 'DUN25', descricao: 'ALUFORCE CB DUPLEX 25mmÂ² NEUTRO NÚ' },
            { codigo: 'DUN35', descricao: 'ALUFORCE CB DUPLEX 35mmÂ² NEUTRO NÚ' },
            { codigo: 'DUN50', descricao: 'ALUFORCE CB DUPLEX 50mmÂ² NEUTRO NÚ' },
            { codigo: 'DUI10', descricao: 'ALUFORCE CB DUPLEX 10mmÂ² NEUTRO ISOLADO' },
            { codigo: 'DUI16', descricao: 'ALUFORCE CB DUPLEX 16mmÂ² NEUTRO ISOLADO' },
            { codigo: 'DUI25', descricao: 'ALUFORCE CB DUPLEX 25mmÂ² NEUTRO ISOLADO' },
            { codigo: 'DUI35', descricao: 'ALUFORCE CB DUPLEX 35mmÂ² NEUTRO ISOLADO' },
            { codigo: 'DUI50', descricao: 'ALUFORCE CB DUPLEX 50mmÂ² NEUTRO ISOLADO' },
            { codigo: 'TRN10', descricao: 'ALUFORCE CB TRIPLEX 10mmÂ² NEUTRO NÚ' },
            { codigo: 'TRN16', descricao: 'ALUFORCE CB TRIPLEX 16mmÂ² NEUTRO NÚ' },
            { codigo: 'TRN25', descricao: 'ALUFORCE CB TRIPLEX 25mmÂ² NEUTRO NÚ' },
            { codigo: 'TRN35', descricao: 'ALUFORCE CB TRIPLEX 35mmÂ² NEUTRO NÚ' },
            { codigo: 'TRN50', descricao: 'ALUFORCE CB TRIPLEX 50mmÂ² NEUTRO NÚ' },
            { codigo: 'TRN50/35', descricao: 'ALUFORCE CB TRIPLEX 50mmÂ² + 35mmÂ² NEUTRO NÚ' },
            { codigo: 'TRN70', descricao: 'ALUFORCE CB TRIPLEX 70mmÂ² NEUTRO NÚ' },
            { codigo: 'TRN95', descricao: 'ALUFORCE CB TRIPLEX 95mmÂ² NEUTRO NÚ' },
            { codigo: 'TRN95/70', descricao: 'ALUFORCE CB TRIPLEX 95mmÂ² + 70mmÂ² NEUTRO NÚ' },
            { codigo: 'TRN120', descricao: 'ALUFORCE CB TRIPLEX 120mmÂ² NEUTRO NÚ' },
            { codigo: 'TRN120/70', descricao: 'ALUFORCE CB TRIPLEX 120mmÂ² + 70mmÂ² NEUTRO NÚ' },
            { codigo: 'TRN120/95', descricao: 'ALUFORCE CB TRIPLEX 120mmÂ² + 95mmÂ² NEUTRO NÚ' },
            { codigo: 'TRN150', descricao: 'ALUFORCE CB TRIPLEX 150mmÂ² NEUTRO NÚ' },
            { codigo: 'TRN150/95', descricao: 'ALUFORCE CB TRIPLEX 150mmÂ² + 95mmÂ² NEUTRO NÚ' },
            { codigo: 'TRN150/120', descricao: 'ALUFORCE CB TRIPLEX 150mmÂ² + 120mmÂ² NEUTRO NÚ' },
            { codigo: 'TRN185', descricao: 'ALUFORCE CB TRIPLEX 185mmÂ² NEUTRO NÚ' },
            { codigo: 'TRN185/120', descricao: 'ALUFORCE CB TRIPLEX 185mmÂ² + 120mmÂ² NEUTRO NÚ' },
            { codigo: 'TRN185/150', descricao: 'ALUFORCE CB TRIPLEX 185mmÂ² + 150mmÂ² NEUTRO NÚ' },
            { codigo: 'TRI10', descricao: 'ALUFORCE CB TRIPLEX 10mmÂ² NEUTRO ISOLADO' },
            { codigo: 'TRI16', descricao: 'ALUFORCE CB TRIPLEX 16mmÂ² NEUTRO ISOLADO' },
            { codigo: 'TRI25', descricao: 'ALUFORCE CB TRIPLEX 25mmÂ² NEUTRO ISOLADO' },
            { codigo: 'TRI35', descricao: 'ALUFORCE CB TRIPLEX 35mmÂ² NEUTRO ISOLADO' },
            { codigo: 'TRI50', descricao: 'ALUFORCE CB TRIPLEX 50mmÂ² NEUTRO ISOLADO' },
            { codigo: 'TRI50/35', descricao: 'ALUFORCE CB TRIPLEX 50mmÂ² + 35mmÂ² NEUTRO ISOLADO' },
            { codigo: 'TRI70', descricao: 'ALUFORCE CB TRIPLEX 70mmÂ² NEUTRO ISOLADO' },
            { codigo: 'TRI95', descricao: 'ALUFORCE CB TRIPLEX 95mmÂ² NEUTRO ISOLADO' },
            { codigo: 'TRI95/70', descricao: 'ALUFORCE CB TRIPLEX 95mmÂ² + 70mmÂ² NEUTRO ISOLADO' },
            { codigo: 'TRI120', descricao: 'ALUFORCE CB TRIPLEX 120mmÂ² NEUTRO ISOLADO' },
            { codigo: 'TRI120/70', descricao: 'ALUFORCE CB TRIPLEX 120mmÂ² + 70mmÂ² NEUTRO ISOLADO' },
            { codigo: 'TRI120/95', descricao: 'ALUFORCE CB TRIPLEX 120mmÂ² + 95mmÂ² NEUTRO ISOLADO' },
            { codigo: 'TRI150', descricao: 'ALUFORCE CB TRIPLEX 150mmÂ² NEUTRO ISOLADO' },
            { codigo: 'TRI150/95', descricao: 'ALUFORCE CB TRIPLEX 150mmÂ² + 95mmÂ² NEUTRO ISOLADO' },
            { codigo: 'TRI150/120', descricao: 'ALUFORCE CB TRIPLEX 150mmÂ² + 120mmÂ² NEUTRO ISOLADO' },
            { codigo: 'TRI185', descricao: 'ALUFORCE CB TRIPLEX 185mmÂ² NEUTRO ISOLADO' },
            { codigo: 'TRI185/120', descricao: 'ALUFORCE CB TRIPLEX 185mmÂ² + 120mmÂ² NEUTRO ISOLADO' },
            { codigo: 'TRI185/150', descricao: 'ALUFORCE CB TRIPLEX 185mmÂ² + 150mmÂ² NEUTRO ISOLADO' },
            { codigo: 'QDN10', descricao: 'ALUFORCE CB QUAD 10mmÂ² NEUTRO NÚ' },
            { codigo: 'QDN16', descricao: 'ALUFORCE CB QUAD 16mmÂ² NEUTRO NÚ' },
            { codigo: 'QDN25', descricao: 'ALUFORCE CB QUAD 25mmÂ² NEUTRO NÚ' },
            { codigo: 'QDN35', descricao: 'ALUFORCE CB QUAD 35mmÂ² NEUTRO NÚ' },
            { codigo: 'QDN35/70', descricao: 'ALUFORCE CB QUAD 35mmÂ² + 70mmÂ² NEUTRO NÚ' },
            { codigo: 'QDI10', descricao: 'ALUFORCE CB QUAD 10mmÂ² NEUTRO ISOLADO' },
            { codigo: 'QDI16', descricao: 'ALUFORCE CB QUAD 16mmÂ² NEUTRO ISOLADO' },
            { codigo: 'QDI25', descricao: 'ALUFORCE CB QUAD 25mmÂ² NEUTRO ISOLADO' },
            { codigo: 'QDI35', descricao: 'ALUFORCE CB QUAD 35mmÂ² NEUTRO ISOLADO' }
        ];

        // Buscar produto no catálogo
        function buscarProdutoCatalogo(termo) {
            const dropdown = document.getElementById('prod-codigo-autocomplete');
            if (!termo || termo.length < 1) {
                dropdown.style.display = 'none';
                return;
            }
            
            const termoUpper = termo.toUpperCase();
            const resultados = catalogoProdutos.filter(p => 
                p.codigo.toUpperCase().includes(termoUpper) || 
                p.descricao.toUpperCase().includes(termoUpper)
            ).slice(0, 10);
            
            if (resultados.length === 0) {
                dropdown.style.display = 'none';
                return;
            }
            
            dropdown.innerHTML = resultados.map(p => `
                <div class="autocomplete-item" onclick="selecionarProdutoCatalogo('${p.codigo}', '${p.descricao.replace(/'/g, "\\'")}')">
                    <strong>${p.codigo}</strong>
                    <span>${p.descricao}</span>
                </div>
            `).join('');
            dropdown.style.display = 'block';
        }
        
        // Selecionar produto do catálogo
        function selecionarProdutoCatalogo(codigo, descricao) {
            document.getElementById('prod-codigo').value = codigo;
            document.getElementById('prod-descricao').value = descricao;
            document.getElementById('prod-codigo-autocomplete').style.display = 'none';
            document.getElementById('prod-quantidade').focus();
        }

        // Array para armazenar produtos da OP
        let produtosOP = [];
        let produtoEditandoIndex = -1;

        // Abrir modal de adicionar produto
        function adicionarProdutoOP() {
            produtoEditandoIndex = -1;
            document.getElementById('modal-produto-titulo').textContent = 'Adicionar Produto';
            document.getElementById('prod-codigo').value = '';
            document.getElementById('prod-descricao').value = '';
            document.getElementById('prod-embalagem').value = '';
            document.getElementById('prod-lances').value = '1x100';
            document.getElementById('prod-peso-liquido').value = '';
            document.getElementById('prod-lote').value = '';
            document.getElementById('prod-quantidade').value = '1';
            document.getElementById('prod-valor').value = '';
            document.getElementById('prod-total-preview').textContent = 'R$ 0,00';
            document.getElementById('prod-codigo-autocomplete').style.display = 'none';
            document.getElementById('modal-produto-op').classList.add('active');
            document.getElementById('prod-codigo').focus();
        }

        // Salvar produto do modal
        function salvarProdutoModal() {
            const codigo = document.getElementById('prod-codigo').value.trim().toUpperCase();
            const descricao = document.getElementById('prod-descricao').value.trim();
            const embalagem = document.getElementById('prod-embalagem').value.trim();
            const lances = document.getElementById('prod-lances').value.trim();
            const pesoLiquido = document.getElementById('prod-peso-liquido').value.trim();
            const lote = document.getElementById('prod-lote').value.trim();
            const quantidade = parseFloat(document.getElementById('prod-quantidade').value) || 1;
            const valorUnitario = parseFloat(document.getElementById('prod-valor').value) || 0;
            
            if (!codigo) {
                showNotification('Informe o código do produto', 'error');
                document.getElementById('prod-codigo').focus();
                return;
            }
            
            // Verificar se código existe no catálogo
            const produtoCatalogo = catalogoProdutos.find(p => p.codigo === codigo);
            const descricaoFinal = produtoCatalogo ? produtoCatalogo.descricao : descricao;
            
            const produto = {
                codigo,
                descricao: descricaoFinal,
                embalagem,
                lances,
                peso_liquido: pesoLiquido,
                lote: lote,
                quantidade,
                valor_unitario: valorUnitario,
                total: quantidade * valorUnitario
            };
            
            if (produtoEditandoIndex >= 0) {
                produtosOP[produtoEditandoIndex] = produto;
                showNotification('Produto atualizado!', 'success');
            } else {
                produtosOP.push(produto);
                showNotification('Produto adicionado!', 'success');
            }
            
            fecharModalProduto();
            atualizarTabelaProdutosOP();
            calcularValoresPagamento(); // Atualizar valores de pagamento
        }

        // Fechar modal de produto
        function fecharModalProduto() {
            document.getElementById('modal-produto-op').classList.remove('active');
            produtoEditandoIndex = -1;
        }

        // Calcular preview do total
        function calcularPreviewTotal() {
            const quantidade = parseFloat(document.getElementById('prod-quantidade').value) || 0;
            const valor = parseFloat(document.getElementById('prod-valor').value) || 0;
            const total = quantidade * valor;
            document.getElementById('prod-total-preview').textContent = `R$ ${total.toFixed(2)}`;
        }

        // Calcular valores de pagamento baseado nos percentuais
        function calcularValoresPagamento() {
            // Calcular total dos produtos
            let totalProdutos = 0;
            produtosOP.forEach(p => {
                totalProdutos += (p.quantidade || 0) * (p.valor_unitario || 0);
            });
            
            // Obter percentuais
            const percent1 = parseFloat(document.getElementById('op-percent-1')?.value) || 0;
            const percent2 = parseFloat(document.getElementById('op-percent-2')?.value) || 0;
            const percent3 = parseFloat(document.getElementById('op-percent-3')?.value) || 0;
            const totalPercent = percent1 + percent2 + percent3;
            
            // Calcular valores
            const valor1 = (totalProdutos * percent1) / 100;
            const valor2 = (totalProdutos * percent2) / 100;
            const valor3 = (totalProdutos * percent3) / 100;
            
            // Atualizar valores na tela
            const formatMoeda = (valor) => valor.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            
            document.getElementById('op-valor-pagamento-1').textContent = formatMoeda(valor1);
            document.getElementById('op-valor-pagamento-2').textContent = formatMoeda(valor2);
            document.getElementById('op-valor-pagamento-3').textContent = formatMoeda(valor3);
            
            // Cores baseadas no valor
            document.getElementById('op-valor-pagamento-1').style.color = valor1 > 0 ? '#16a34a' : '#64748b';
            document.getElementById('op-valor-pagamento-2').style.color = valor2 > 0 ? '#16a34a' : '#64748b';
            document.getElementById('op-valor-pagamento-3').style.color = valor3 > 0 ? '#16a34a' : '#64748b';
            
            // Atualizar total percentual
            document.getElementById('op-percent-total').textContent = totalPercent + '%';
            document.getElementById('op-percent-total').style.color = totalPercent === 100 ? '#16a34a' : '#dc2626';
            
            // Mostrar/ocultar alerta
            const alertEl = document.getElementById('op-percent-alert');
            if (alertEl) {
                alertEl.style.display = totalPercent !== 100 ? 'block' : 'none';
            }
            
            // Atualizar valor total
            document.getElementById('op-valor-total-pagamento').textContent = formatMoeda(totalProdutos);
        }
        
        // Função auxiliar para converter moeda para número
        function parseMoeda(valor) {
            if (typeof valor === 'number') return valor;
            if (!valor) return 0;
            return parseFloat(String(valor).replace(/[^\d,.-]/g, '').replace(',', '.')) || 0;
        }

        // Atualizar tabela de produtos
        // Estrutura conforme template Excel: Cod | Produto | Embalagem | Lance(s) | Qtd | V.Un | V.Total
        function atualizarTabelaProdutosOP() {
            const tbody = document.getElementById('op-produtos-tbody');
            if (!tbody) return;
            
            if (produtosOP.length === 0) {
                tbody.innerHTML = `
                    <tr class="modal-op-empty-row">
                        <td colspan="8">
                            <i class="fas fa-boxes"></i>
                            <span>Nenhum produto adicionado</span>
                        </td>
                    </tr>
                `;
                document.getElementById('op-produtos-total').textContent = 'R$ 0,00';
                return;
            }
            
            let html = '';
            let totalGeral = 0;
            
            produtosOP.forEach((prod, index) => {
                totalGeral += prod.total;
                html += `
                    <tr>
                        <td><input type="checkbox" class="op-produto-check" data-index="${index}"></td>
                        <td><span class="prod-codigo-cell">${prod.codigo}</span></td>
                        <td title="${prod.descricao}">${prod.descricao || '(VLOOKUP)'}</td>
                        <td>
                            <select class="embalagem-inline-select" data-index="${index}" onchange="atualizarEmbalagemProduto(${index}, this.value)">
                                <option value="">-</option>
                                <option value="Bobina" ${prod.embalagem === 'Bobina' ? 'selected' : ''}>Bobina</option>
                                <option value="Rolo" ${prod.embalagem === 'Rolo' ? 'selected' : ''}>Rolo</option>
                                <option value="Lance" ${prod.embalagem === 'Lance' ? 'selected' : ''}>Lance</option>
                                <option value="Caixa" ${prod.embalagem === 'Caixa' ? 'selected' : ''}>Caixa</option>
                                <option value="Fardo" ${prod.embalagem === 'Fardo' ? 'selected' : ''}>Fardo</option>
                            </select>
                        </td>
                        <td>
                            <input type="text" class="lances-inline-input" value="${prod.lances || ''}" 
                                   placeholder="Ex: 1x1000" data-index="${index}"
                                   onchange="atualizarLancesProduto(${index}, this.value)">
                        </td>
                        <td class="text-center">${prod.quantidade}</td>
                        <td class="text-right">R$ ${prod.valor_unitario.toFixed(2)}</td>
                        <td class="text-right font-semibold">R$ ${prod.total.toFixed(2)}</td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
            document.getElementById('op-produtos-total').textContent = `R$ ${totalGeral.toFixed(2)}`;
        }

        // Atualizar embalagem de um produto inline
        function atualizarEmbalagemProduto(index, valor) {
            if (produtosOP[index]) {
                produtosOP[index].embalagem = valor;
            }
        }

        // Atualizar lances de um produto inline
        function atualizarLancesProduto(index, valor) {
            if (produtosOP[index]) {
                produtosOP[index].lances = valor;
            }
        }

        // Editar produto selecionado
        function editarProdutoOP() {
            const checkboxes = document.querySelectorAll('.op-produto-check:checked');
            if (checkboxes.length === 0) {
                showNotification('Selecione um produto para editar', 'warning');
                return;
            }
            if (checkboxes.length > 1) {
                showNotification('Selecione apenas um produto para editar', 'warning');
                return;
            }
            
            const index = parseInt(checkboxes[0].dataset.index);
            const prod = produtosOP[index];
            
            produtoEditandoIndex = index;
            document.getElementById('modal-produto-titulo').textContent = 'Editar Produto';
            document.getElementById('prod-codigo').value = prod.codigo;
            document.getElementById('prod-descricao').value = prod.descricao || '';
            document.getElementById('prod-embalagem').value = prod.embalagem || '';
            document.getElementById('prod-lances').value = prod.lances || '1x100';
            document.getElementById('prod-peso-liquido').value = prod.peso_liquido || '';
            document.getElementById('prod-lote').value = prod.lote || '';
            document.getElementById('prod-quantidade').value = prod.quantidade;
            document.getElementById('prod-valor').value = prod.valor_unitario;
            calcularPreviewTotal();
            document.getElementById('modal-produto-op').classList.add('active');
        }

        // Remover produto selecionado
        async function removerProdutoOP() {
            const checkboxes = document.querySelectorAll('.op-produto-check:checked');
            if (checkboxes.length === 0) {
                showNotification('Selecione um produto para remover', 'warning');
                return;
            }
            
            const confirmado = await mostrarConfirmacaoPCP(
                'Remover Produtos',
                `Remover ${checkboxes.length} produto(s) selecionado(s)?`,
                'danger'
            );
            if (!confirmado) return;
            
            const indices = Array.from(checkboxes).map(cb => parseInt(cb.dataset.index)).sort((a, b) => b - a);
            indices.forEach(i => produtosOP.splice(i, 1));
            
            showNotification(`${indices.length} produto(s) removido(s)`, 'success');
            atualizarTabelaProdutosOP();
        }

        // Gerar Excel da OP
        function gerarExcelOP() {
            const dados = coletarDadosOP();
            
            if (!dados.cliente) {
                showNotification('Preencha pelo menos os dados do cliente', 'warning');
                switchOPTab('cliente');
                return;
            }
            
            console.log('Gerando Excel com dados:', dados);
            
            // Chamar API para gerar Excel
            fetch('/api/gerar-ordem-excel', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(dados)
            })
            .then(response => {
                if (response.ok) {
                    return response.blob();
                }
                throw new Error('Erro ao gerar Excel');
            })
            .then(blob => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                // Formatar nome do cliente para nome de arquivo válido
                const nomeCliente = (dados.cliente || 'Cliente').replace(/[/\\:*?"<>|]/g, '_').trim();
                a.download = `Ordem de Produção - ${nomeCliente} - ERP.xlsx`;
                a.click();
                window.URL.revokeObjectURL(url);
                showNotification('Excel gerado com sucesso!', 'success');
            })
            .catch(error => {
                console.error('Erro:', error);
                alert('Erro ao gerar Excel. Verifique se a API está disponível.');
            });
        }

        // Cache de clientes para autocomplete
        let clientesCache = [];
        let autocompleteTimeout = null;
        
        // Buscar clientes para autocomplete
        async function buscarClientesAutocomplete(termo) {
            const dropdown = document.getElementById('op-cliente-dropdown');
            if (!dropdown) return;
            
            // Limpar timeout anterior
            if (autocompleteTimeout) {
                clearTimeout(autocompleteTimeout);
            }
            
            // Se campo vazio, mostrar íºltimos clientes ou esconder
            if (!termo || termo.length < 1) {
                if (clientesCache.length > 0) {
                    renderizarDropdownClientes(clientesCache.slice(0, 10));
                } else {
                    dropdown.style.display = 'none';
                }
                return;
            }
            
            // Debounce de 200ms
            autocompleteTimeout = setTimeout(async () => {
                try {
                    // Primeiro tenta buscar do cache
                    if (clientesCache.length > 0) {
                        const filtrados = clientesCache.filter(c => 
                            (c.nome && c.nome.toLowerCase().includes(termo.toLowerCase())) ||
                            (c.razao_social && c.razao_social.toLowerCase().includes(termo.toLowerCase())) ||
                            (c.nome_fantasia && c.nome_fantasia.toLowerCase().includes(termo.toLowerCase())) ||
                            (c.cnpj_cpf && c.cnpj_cpf.includes(termo))
                        );
                        renderizarDropdownClientes(filtrados.slice(0, 10));
                        return;
                    }
                    
                    // Se Não tem cache, busca da API
                    await carregarClientesParaCache();
                    buscarClientesAutocomplete(termo);
                } catch (error) {
                    console.error('Erro no autocomplete:', error);
                }
            }, 200);
        }
        
        // Carregar clientes para cache
        async function carregarClientesParaCache() {
            try {
                const response = await fetch('/api/vendas/clientes', {
                    headers: {
                        'Authorization': 'Bearer ' + (localStorage.getItem('token') || sessionStorage.getItem('token'))
                    }
                });
                const data = await response.json();
                if (data.success && data.clientes) {
                    clientesCache = data.clientes;
                }
            } catch (error) {
                console.error('Erro ao carregar clientes:', error);
                // Tentar API alternativa
                try {
                    const response2 = await fetch('/api/clientes');
                    const data2 = await response2.json();
                    if (Array.isArray(data2)) {
                        clientesCache = data2;
                    } else if (data2.clientes) {
                        clientesCache = data2.clientes;
                    }
                } catch (e) {
                    console.error('Erro na API alternativa:', e);
                }
            }
        }
        
        // Renderizar dropdown de clientes
        function renderizarDropdownClientes(clientes) {
            const dropdown = document.getElementById('op-cliente-dropdown');
            if (!dropdown) return;
            
            if (clientes.length === 0) {
                dropdown.innerHTML = '<div class="autocomplete-item no-results"><i class="fas fa-search"></i> Nenhum cliente encontrado</div>';
                dropdown.style.display = 'block';
                return;
            }
            
            let html = '';
            clientes.forEach(cliente => {
                const nome = cliente.razao_social || cliente.nome || cliente.nome_fantasia || 'Sem nome';
                const cnpj = cliente.cnpj_cpf || cliente.cnpj || '';
                const cidade = cliente.cidade ? `${cliente.cidade}/${cliente.estado || ''}` : '';
                
                html += `
                    <div class="autocomplete-item" onclick="selecionarClienteOP(${cliente.id})">
                        <div class="autocomplete-item-main">
                            <i class="fas fa-building"></i>
                            <span class="autocomplete-nome">${nome}</span>
                        </div>
                        <div class="autocomplete-item-info">
                            ${cnpj ? `<span class="autocomplete-cnpj">${cnpj}</span>` : ''}
                            ${cidade ? `<span class="autocomplete-cidade">${cidade}</span>` : ''}
                        </div>
                    </div>
                `;
            });
            
            dropdown.innerHTML = html;
            dropdown.style.display = 'block';
        }
        
        // Selecionar cliente do autocomplete
        function selecionarClienteOP(clienteId) {
            const cliente = clientesCache.find(c => c.id === clienteId);
            if (!cliente) return;
            
            // Preencher campos
            document.getElementById('op-cliente').value = cliente.razao_social || cliente.nome || cliente.nome_fantasia || '';
            document.getElementById('op-cliente-id').value = cliente.id;
            document.getElementById('op-cliente-cnpj').value = cliente.cnpj_cpf || cliente.cnpj || '';
            document.getElementById('op-cliente-contato').value = cliente.contato || '';
            document.getElementById('op-cliente-fone').value = cliente.telefone || '';
            document.getElementById('op-cliente-email').value = cliente.email || '';
            
            // Esconder dropdown
            document.getElementById('op-cliente-dropdown').style.display = 'none';
            
            // Feedback visual
            const inputCliente = document.getElementById('op-cliente');
            inputCliente.style.borderColor = '#10b981';
            inputCliente.style.backgroundColor = '#f0fdf4';
            setTimeout(() => {
                inputCliente.style.borderColor = '';
                inputCliente.style.backgroundColor = '';
            }, 1500);
        }
        
        // índice do item selecionado no dropdown
        let autocompleteIndex = -1;
        
        // Fechar dropdown ao clicar fora
        document.addEventListener('click', function(e) {
            const dropdown = document.getElementById('op-cliente-dropdown');
            const input = document.getElementById('op-cliente');
            if (dropdown && !dropdown.contains(e.target) && e.target !== input) {
                dropdown.style.display = 'none';
                autocompleteIndex = -1;
            }
        });
        
        // Navegação com teclado no autocomplete
        document.addEventListener('keydown', function(e) {
            const dropdown = document.getElementById('op-cliente-dropdown');
            const input = document.getElementById('op-cliente');
            
            if (!dropdown || dropdown.style.display === 'none') return;
            if (document.activeElement !== input) return;
            
            const items = dropdown.querySelectorAll('.autocomplete-item:not(.no-results)');
            if (items.length === 0) return;
            
            if (e.key === 'ArrowDown') {
                e.preventDefault();
                autocompleteIndex = Math.min(autocompleteIndex + 1, items.length - 1);
                highlightAutocompleteItem(items);
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                autocompleteIndex = Math.max(autocompleteIndex - 1, 0);
                highlightAutocompleteItem(items);
            } else if (e.key === 'Enter' && autocompleteIndex >= 0) {
                e.preventDefault();
                items[autocompleteIndex].click();
                autocompleteIndex = -1;
            } else if (e.key === 'Escape') {
                dropdown.style.display = 'none';
                autocompleteIndex = -1;
            }
        });
        
        // Destacar item selecionado
        function highlightAutocompleteItem(items) {
            items.forEach((item, i) => {
                if (i === autocompleteIndex) {
                    item.style.background = 'linear-gradient(135deg, #fef2f2, #fee2e2)';
                    item.scrollIntoView({ block: 'nearest' });
                } else {
                    item.style.background = '';
                }
            });
        }
        
        // Buscar cliente (botão sidebar)
        function buscarClienteOP() {
            const input = document.getElementById('op-cliente');
            if (input) {
                input.focus();
                buscarClientesAutocomplete('');
            }
        }

        // Cache de transportadoras para autocomplete
        let transportadorasCache = [];
        let autocompleteTranspTimeout = null;
        let autocompleteTranspIndex = -1;
        
        // Buscar transportadoras para autocomplete
        async function buscarTransportadorasAutocomplete(termo) {
            const dropdown = document.getElementById('op-transportadora-dropdown');
            if (!dropdown) return;
            
            // Limpar timeout anterior
            if (autocompleteTranspTimeout) {
                clearTimeout(autocompleteTranspTimeout);
            }
            
            // Se campo vazio, mostrar íºltimas transportadoras ou esconder
            if (!termo || termo.length < 1) {
                if (transportadorasCache.length > 0) {
                    renderizarDropdownTransportadoras(transportadorasCache.slice(0, 10));
                } else {
                    dropdown.style.display = 'none';
                }
                return;
            }
            
            // Debounce de 200ms
            autocompleteTranspTimeout = setTimeout(async () => {
                try {
                    // Primeiro tenta buscar do cache
                    if (transportadorasCache.length > 0) {
                        const filtrados = transportadorasCache.filter(t => 
                            (t.nome && t.nome.toLowerCase().includes(termo.toLowerCase())) ||
                            (t.razao_social && t.razao_social.toLowerCase().includes(termo.toLowerCase())) ||
                            (t.nome_fantasia && t.nome_fantasia.toLowerCase().includes(termo.toLowerCase())) ||
                            (t.cnpj && t.cnpj.includes(termo))
                        );
                        renderizarDropdownTransportadoras(filtrados.slice(0, 10));
                        return;
                    }
                    
                    // Se Não tem cache, busca da API
                    await carregarTransportadorasParaCache();
                    buscarTransportadorasAutocomplete(termo);
                } catch (error) {
                    console.error('Erro no autocomplete de transportadoras:', error);
                }
            }, 200);
        }
        
        // Carregar transportadoras para cache
        async function carregarTransportadorasParaCache() {
            try {
                const response = await fetch('/api/transportadoras');
                const data = await response.json();
                if (Array.isArray(data)) {
                    transportadorasCache = data;
                } else if (data.transportadoras) {
                    transportadorasCache = data.transportadoras;
                } else if (data.success && data.data) {
                    transportadorasCache = data.data;
                }
                console.log('Transportadoras carregadas:', transportadorasCache.length);
            } catch (error) {
                console.error('Erro ao carregar transportadoras:', error);
            }
        }
        
        // Renderizar dropdown de transportadoras
        function renderizarDropdownTransportadoras(transportadoras) {
            const dropdown = document.getElementById('op-transportadora-dropdown');
            if (!dropdown) return;
            
            if (transportadoras.length === 0) {
                dropdown.innerHTML = '<div class="autocomplete-item no-results"><i class="fas fa-search"></i> Nenhuma transportadora encontrada</div>';
                dropdown.style.display = 'block';
                return;
            }
            
            let html = '';
            transportadoras.forEach(transp => {
                const nome = transp.razao_social || transp.nome || transp.nome_fantasia || 'Sem nome';
                const cnpj = transp.cnpj || transp.cnpj_cpf || '';
                const cidade = transp.cidade ? `${transp.cidade}/${transp.estado || ''}` : '';
                
                html += `
                    <div class="autocomplete-item" onclick="selecionarTransportadoraOP(${transp.id})">
                        <div class="autocomplete-item-main">
                            <i class="fas fa-truck"></i>
                            <span class="autocomplete-nome">${nome}</span>
                        </div>
                        <div class="autocomplete-item-info">
                            ${cnpj ? `<span class="autocomplete-cnpj">${cnpj}</span>` : ''}
                            ${cidade ? `<span class="autocomplete-cidade">${cidade}</span>` : ''}
                        </div>
                    </div>
                `;
            });
            
            dropdown.innerHTML = html;
            dropdown.style.display = 'block';
        }
        
        // Selecionar transportadora do autocomplete
        function selecionarTransportadoraOP(transpId) {
            const transp = transportadorasCache.find(t => t.id === transpId);
            if (!transp) return;
            
            // Preencher campos
            document.getElementById('op-transportadora-nome').value = transp.razao_social || transp.nome || transp.nome_fantasia || '';
            document.getElementById('op-transportadora-id').value = transp.id;
            document.getElementById('op-transportadora-cnpj').value = transp.cnpj || transp.cnpj_cpf || '';
            document.getElementById('op-transportadora-fone').value = transp.telefone || transp.fone || '';
            document.getElementById('op-transportadora-cep').value = transp.cep || '';
            document.getElementById('op-transportadora-email').value = transp.email || '';
            
            // Montar endereço completo
            let endereco = transp.endereco || '';
            if (!endereco && transp.bairro) {
                endereco = `${transp.bairro}, ${transp.cidade || ''}/${transp.estado || ''}`;
            } else if (!endereco && transp.cidade) {
                endereco = `${transp.cidade}/${transp.estado || ''}`;
            }
            document.getElementById('op-transportadora-endereco').value = endereco;
            
            // Esconder dropdown
            document.getElementById('op-transportadora-dropdown').style.display = 'none';
            
            // Feedback visual
            const inputTransp = document.getElementById('op-transportadora-nome');
            inputTransp.style.borderColor = '#10b981';
            inputTransp.style.backgroundColor = '#f0fdf4';
            setTimeout(() => {
                inputTransp.style.borderColor = '';
                inputTransp.style.backgroundColor = '';
            }, 1500);
        }
        
        // Fechar dropdown de transportadora ao clicar fora
        document.addEventListener('click', function(e) {
            const dropdown = document.getElementById('op-transportadora-dropdown');
            const input = document.getElementById('op-transportadora-nome');
            if (dropdown && !dropdown.contains(e.target) && e.target !== input) {
                dropdown.style.display = 'none';
                autocompleteTranspIndex = -1;
            }
        });
        
        // Navegação com teclado no autocomplete de transportadora
        document.addEventListener('keydown', function(e) {
            const dropdown = document.getElementById('op-transportadora-dropdown');
            const input = document.getElementById('op-transportadora-nome');
            
            if (!dropdown || dropdown.style.display === 'none') return;
            if (document.activeElement !== input) return;
            
            const items = dropdown.querySelectorAll('.autocomplete-item:not(.no-results)');
            if (items.length === 0) return;
            
            if (e.key === 'ArrowDown') {
                e.preventDefault();
                autocompleteTranspIndex = Math.min(autocompleteTranspIndex + 1, items.length - 1);
                highlightAutocompleteTranspItem(items);
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                autocompleteTranspIndex = Math.max(autocompleteTranspIndex - 1, 0);
                highlightAutocompleteTranspItem(items);
            } else if (e.key === 'Enter' && autocompleteTranspIndex >= 0) {
                e.preventDefault();
                items[autocompleteTranspIndex].click();
                autocompleteTranspIndex = -1;
            } else if (e.key === 'Escape') {
                dropdown.style.display = 'none';
                autocompleteTranspIndex = -1;
            }
        });
        
        // Destacar item selecionado na transportadora
        function highlightAutocompleteTranspItem(items) {
            items.forEach((item, i) => {
                if (i === autocompleteTranspIndex) {
                    item.style.background = 'linear-gradient(135deg, #fef2f2, #fee2e2)';
                    item.scrollIntoView({ block: 'nearest' });
                } else {
                    item.style.background = '';
                }
            });
        }
        
        // Buscar transportadora (botão sidebar)
        function buscarTransportadoraOP() {
            const input = document.getElementById('op-transportadora-nome');
            if (input) {
                switchOPTab('transportadora');
                setTimeout(() => {
                    input.focus();
                    buscarTransportadorasAutocomplete('');
                }, 100);
            }
        }

        // Limpar formulário
        async function limparFormOP() {
            const confirmado = await mostrarConfirmacaoPCP(
                'Limpar Formulário',
                'Limpar todos os campos do formulário?',
                'warning'
            );
            if (!confirmado) return;
            
            // Limpar todos os inputs
            document.querySelectorAll('#modal-nova-ordem input, #modal-nova-ordem textarea, #modal-nova-ordem select').forEach(el => {
                if (el.type === 'checkbox') {
                    el.checked = false;
                } else if (el.tagName === 'SELECT') {
                    el.selectedIndex = 0;
                } else {
                    el.value = '';
                }
            });
            
            // Limpar produtos
            produtosOP = [];
            atualizarTabelaProdutosOP();
            
            // Reiniciar com número da OP
            gerarNumeroOP();
            
            // Voltar para primeira aba
            switchOPTab('cliente');
        }

        // Funções da sidebar mantidas
        function imprimirOP() {
            // Coletar dados da OP para gerar visualização
            const dados = coletarDadosOP();
            
            // Criar conteíºdo HTML para impressão
            let produtosHTML = '';
            let totalGeral = 0;
            
            if (dados.produtos && dados.produtos.length > 0) {
                dados.produtos.forEach((prod, index) => {
                    const total = prod.total || (prod.quantidade * prod.valor_unitario);
                    totalGeral += total;
                    produtosHTML += `
                        <tr>
                            <td style="padding: 8px; border: 1px solid #ddd;">${index + 1}</td>
                            <td style="padding: 8px; border: 1px solid #ddd;">${prod.codigo}</td>
                            <td style="padding: 8px; border: 1px solid #ddd;">${prod.descricao || ''}</td>
                            <td style="padding: 8px; border: 1px solid #ddd;">${prod.embalagem || '-'}</td>
                            <td style="padding: 8px; border: 1px solid #ddd;">${prod.lances || '-'}</td>
                            <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">${prod.quantidade}</td>
                            <td style="padding: 8px; border: 1px solid #ddd; text-align: right;">R$ ${(prod.valor_unitario || 0).toFixed(2)}</td>
                            <td style="padding: 8px; border: 1px solid #ddd; text-align: right; font-weight: bold;">R$ ${total.toFixed(2)}</td>
                        </tr>
                    `;
                });
            } else {
                produtosHTML = '<tr><td colspan="8" style="padding: 20px; text-align: center; color: #666;">Nenhum produto adicionado</td></tr>';
            }
            
            const printContent = `
                <!DOCTYPE html>
                <html>
                <head>
    <link rel="icon" type="image/x-icon" href="/favicon-aluforce.webp">
                    <title>Ordem de Produção - ${dados.numero_sequencial || 'Nova'}</title>
                    <style>
                        @media print {
                            body { margin: 0; padding: 15mm; }
                            .no-print { display: none !important; }
                        }
                        body {
                            font-family: Arial, sans-serif;
                            font-size: 12px;
                            line-height: 1.4;
                            color: #333;
                            background: white;
                        }
                        .header {
                            display: flex;
                            justify-content: space-between;
                            align-items: flex-start;
                            border-bottom: 3px solid #1a365d;
                            padding-bottom: 15px;
                            margin-bottom: 20px;
                        }
                        .logo-area {
                            display: flex;
                            align-items: center;
                            gap: 15px;
                        }
                        .logo-area img {
                            height: 60px;
                        }
                        .company-info {
                            font-size: 11px;
                        }
                        .company-name {
                            font-size: 18px;
                            font-weight: bold;
                            color: #1a365d;
                        }
                        .op-number {
                            text-align: right;
                        }
                        .op-number h1 {
                            font-size: 24px;
                            color: #1a365d;
                            margin: 0;
                        }
                        .op-number p {
                            margin: 5px 0;
                            font-size: 13px;
                        }
                        .section {
                            margin-bottom: 20px;
                        }
                        .section-title {
                            background: #1a365d;
                            color: white;
                            padding: 8px 12px;
                            font-weight: bold;
                            font-size: 13px;
                            margin-bottom: 10px;
                        }
                        .info-grid {
                            display: grid;
                            grid-template-columns: repeat(4, 1fr);
                            gap: 10px;
                            padding: 10px;
                            background: #f8f9fa;
                            border: 1px solid #ddd;
                        }
                        .info-item {
                            padding: 5px;
                        }
                        .info-label {
                            font-weight: bold;
                            font-size: 10px;
                            color: #666;
                            text-transform: uppercase;
                        }
                        .info-value {
                            font-size: 12px;
                            margin-top: 3px;
                        }
                        table {
                            width: 100%;
                            border-collapse: collapse;
                            font-size: 11px;
                        }
                        th {
                            background: #1a365d;
                            color: white;
                            padding: 10px 8px;
                            text-align: left;
                            font-weight: bold;
                        }
                        .total-row {
                            background: #e8f4f8;
                            font-weight: bold;
                        }
                        .total-row td {
                            padding: 12px 8px !important;
                            border: 2px solid #1a365d !important;
                        }
                        .cobranca-section {
                            background: #fff3cd;
                            border: 2px solid #ffc107;
                            padding: 15px;
                            margin-top: 20px;
                        }
                        .cobranca-title {
                            font-weight: bold;
                            font-size: 14px;
                            margin-bottom: 10px;
                            color: #856404;
                        }
                        .footer {
                            margin-top: 30px;
                            display: grid;
                            grid-template-columns: 1fr 1fr 1fr;
                            gap: 20px;
                        }
                        .signature-box {
                            border-top: 1px solid #333;
                            padding-top: 10px;
                            text-align: center;
                            font-size: 11px;
                        }
                        .obs-section {
                            margin-top: 20px;
                            padding: 10px;
                            background: #f0f0f0;
                            border: 1px solid #ddd;
                        }
                        .print-btn {
                            position: fixed;
                            top: 20px;
                            right: 20px;
                            background: #1a365d;
                            color: white;
                            border: none;
                            padding: 12px 24px;
                            font-size: 14px;
                            cursor: pointer;
                            border-radius: 5px;
                            display: flex;
                            align-items: center;
                            gap: 8px;
                        }
                        .print-btn:hover {
                            background: #2d4a7c;
                        }
                    </style>
                    
    `n</head>
                <body>
                    <button class="print-btn no-print" onclick="window.print()">
                         Imprimir
                    </button>
                    
                    <div class="header">
                        <div class="logo-area">
                            <div>
                                <div class="company-name">ALUFORCE</div>
                                <div class="company-info">
                                    Cabos de Alumínio e Condutores Elétricos<br>
                                    CNPJ: 00.000.000/0001-00
                                </div>
                            </div>
                        </div>
                        <div class="op-number">
                            <h1>ORDEM DE PRODUÇÃO</h1>
                            <p><strong>OP Nº:</strong> ${dados.numero_sequencial || 'N/A'}</p>
                            <p><strong>Orçamento:</strong> ${dados.numero_orcamento || 'N/A'}</p>
                            <p><strong>Data Liberação:</strong> ${dados.data_liberacao || new Date().toLocaleDateString('pt-BR')}</p>
                        </div>
                    </div>
                    
                    <div class="section">
                        <div class="section-title">DADOS DO CLIENTE</div>
                        <div class="info-grid">
                            <div class="info-item" style="grid-column: span 2;">
                                <div class="info-label">Cliente</div>
                                <div class="info-value">${dados.cliente || ''}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">CNPJ/CPF</div>
                                <div class="info-value">${dados.cpf_cnpj || ''}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Vendedor</div>
                                <div class="info-value">${dados.vendedor || ''}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Contato</div>
                                <div class="info-value">${dados.contato_cliente || ''}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Telefone</div>
                                <div class="info-value">${dados.fone_cliente || ''}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">E-mail</div>
                                <div class="info-value">${dados.email_cliente || ''}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Tipo Frete</div>
                                <div class="info-value">${dados.tipo_frete || ''}</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="section">
                        <div class="section-title">TRANSPORTADORA</div>
                        <div class="info-grid">
                            <div class="info-item" style="grid-column: span 2;">
                                <div class="info-label">Razão Social</div>
                                <div class="info-value">${dados.transportadora_nome || ''}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">CNPJ</div>
                                <div class="info-value">${dados.transportadora_cpf_cnpj || ''}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Telefone</div>
                                <div class="info-value">${dados.transportadora_fone || ''}</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="section">
                        <div class="section-title">PRODUTOS</div>
                        <table>
                            <thead>
                                <tr>
                                    <th style="width: 30px;">Item</th>
                                    <th style="width: 80px;">Código</th>
                                    <th>Descrição</th>
                                    <th style="width: 80px;">Embalagem</th>
                                    <th style="width: 80px;">Lance(s)</th>
                                    <th style="width: 50px;">Qtd</th>
                                    <th style="width: 80px;">V. Unitário</th>
                                    <th style="width: 90px;">V. Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${produtosHTML}
                            </tbody>
                            <tfoot>
                                <tr class="total-row">
                                    <td colspan="7" style="text-align: right; padding: 8px;">TOTAL DO PEDIDO:</td>
                                    <td style="text-align: right; padding: 8px;">R$ ${totalGeral.toFixed(2)}</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                    
                    <div class="cobranca-section">
                        <div class="cobranca-title"> Dados para Cobrança:</div>
                        <div class="info-grid" style="background: transparent; border: none;">
                            <div class="info-item">
                                <div class="info-label">Forma de Pagamento</div>
                                <div class="info-value">${dados.forma_pagamento || ''}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Método</div>
                                <div class="info-value">${dados.metodo_pagamento || ''}</div>
                            </div>
                            <div class="info-item" style="grid-column: span 2;">
                                <div class="info-label">Condições</div>
                                <div class="info-value">${dados.condicoes_pagamento || ''}</div>
                            </div>
                            <div class="info-item" style="grid-column: span 2;">
                                <div class="info-label">E-mail NF-e</div>
                                <div class="info-value">${dados.email_cliente || dados.transportadora?.email_nfe || ''}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Prazo Entrega</div>
                                <div class="info-value">${dados.prazo_entrega || ''}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">PreVisão Entrega</div>
                                <div class="info-value">${dados.data_previsao_entrega || ''}</div>
                            </div>
                        </div>
                    </div>
                    
                    ${dados.observacoes ? `
                    <div class="obs-section">
                        <strong>Observações:</strong><br>
                        ${dados.observacoes}
                    </div>
                    ` : ''}
                    
                    <div class="footer">
                        <div class="signature-box">
                            Responsável Vendas
                        </div>
                        <div class="signature-box">
                            Responsável PCP
                        </div>
                        <div class="signature-box">
                            Responsável Produção
                        </div>
                    </div>
                    `n</body>
                </html>
            `;
            
            // Abrir janela de impressão
            const printWindow = window.open('', '_blank', 'width=900,height=700');
            printWindow.document.write(printContent);
            printWindow.document.close();
        }

        function duplicarOP() {
            alert('Duplicar ordem de Produção - Em desenvolvimento');
        }

        // Inicializar data padrão ao abrir o modal
        function initModalNovaOrdem() {
            const hoje = new Date();
            const dataFormatada = hoje.toISOString().split('T')[0];
            
            const inputData = document.getElementById('op-data-liberacao');
            if (inputData && !inputData.value) {
                inputData.value = dataFormatada;
            }
            
            // Gerar número da OP
            gerarNumeroOP();
            
            // Pré-carregar clientes para autocomplete
            if (clientesCache.length === 0) {
                carregarClientesParaCache();
            }
            
            // Pré-carregar transportadoras para autocomplete
            if (transportadorasCache.length === 0) {
                carregarTransportadorasParaCache();
            }
        }

        // Observer para quando o modal for aberto
        const modalNovaOrdem = document.getElementById('modal-nova-ordem');
        if (modalNovaOrdem) {
            const observer = new MutationObserver((mutations) => {
                mutations.forEach((mutation) => {
                    if (mutation.attributeName === 'class' && modalNovaOrdem.classList.contains('active')) {
                        initModalNovaOrdem();
                    }
                });
            });
            observer.observe(modalNovaOrdem, { attributes: true });
        }

        // ============================================
        // FUNÇÃO BUSCAR PRODUTOS - View Produtos e Estoque
        // ============================================
        async function buscarProdutos(page = 1, limit = 50) {
            const searchInput = document.getElementById('search-produtos');
            const categoriaSelect = document.getElementById('filter-categoria');
            const estoqueSelect = document.getElementById('filter-estoque');

            const query = searchInput ? searchInput.value.trim() : '';
            const categoria = categoriaSelect ? categoriaSelect.value : '';
            const estoque = estoqueSelect ? estoqueSelect.value : '';

            const params = new URLSearchParams();
            if (query) params.append('q', query);
            if (categoria) params.append('categoria', categoria);
            if (estoque) params.append('estoque', estoque);
            params.append('page', page);
            params.append('limit', limit);

            const tableBody = document.getElementById('produtos-table-body');
            
            // Mostrar loading
            if (tableBody) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="9" style="text-align: center; padding: 60px;">
                            <div class="loading-spinner" style="margin: 0 auto;"></div>
                            <p style="margin-top: 16px; color: var(--gray-500);">Carregando produtos...</p>
                        </td>
                    </tr>
                `;
            }

            try {
                const response = await fetch(`/api/pcp/produtos?${params.toString()}`);
                const body = await response.json();
                const produtos = body.produtos || body.rows || (Array.isArray(body) ? body : []);
                const total = Number(body.total || produtos.length);
                const stats = body.stats || {};

                // Atualizar contadores
                const produtosTotal = document.getElementById('produtos-total');
                const produtosNormal = document.getElementById('produtos-normal');
                const produtosBaixo = document.getElementById('produtos-baixo');
                const produtosCritico = document.getElementById('produtos-critico');
                const produtosShowing = document.getElementById('produtos-showing');
                const produtosTotalCount = document.getElementById('produtos-total-count');

                if (produtosTotal) produtosTotal.textContent = stats.total_produtos || total;
                if (produtosNormal) produtosNormal.textContent = stats.com_estoque || 0;
                if (produtosBaixo) produtosBaixo.textContent = stats.estoque_baixo || 0;
                if (produtosCritico) produtosCritico.textContent = stats.critico || 0;
                if (produtosShowing) produtosShowing.textContent = produtos.length;
                if (produtosTotalCount) produtosTotalCount.textContent = total;

                // Calcular estatísticas se Não vieram da API
                if (!stats.total_produtos) {
                    let estoqueBaixo = 0, estoqueCritico = 0, estoqueNormal = 0;
                    produtos.forEach(p => {
                        const qtd = Number(p.estoque_atual || p.quantidade || p.estoque || 0);
                        const min = Number(p.estoque_minimo || 10);
                        if (qtd <= 0) estoqueCritico++;
                        else if (qtd <= min) estoqueBaixo++;
                        else estoqueNormal++;
                    });
                    if (produtosNormal) produtosNormal.textContent = estoqueNormal;
                    if (produtosBaixo) produtosBaixo.textContent = estoqueBaixo;
                    if (produtosCritico) produtosCritico.textContent = estoqueCritico;
                }

                // Renderizar tabela
                if (!tableBody) return;

                if (produtos.length === 0) {
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="9" style="text-align: center; padding: 60px;">
                                <i class="fas fa-inbox" style="font-size: 48px; color: var(--gray-400); margin-bottom: 16px;"></i>
                                <p style="color: var(--gray-500);">Nenhum produto encontrado</p>
                            </td>
                        </tr>
                    `;
                    return;
                }

                tableBody.innerHTML = produtos.map(p => {
                    const codigo = p.codigo || p.codigo_produto || p.id || '';
                    const descricao = p.nome || p.descricao || p.descricao_produto || '';
                    const sku = p.sku || '-';
                    const categoria = p.categoria || '-';
                    const estoque = Number(p.estoque_atual || p.quantidade || p.estoque || 0);
                    const minimo = Number(p.estoque_minimo || 10);
                    const preco = Number(p.preco_venda || p.preco_custo || p.preco || 0);
                    
                    let status = 'Normal';
                    let statusClass = 'success';
                    if (estoque <= 0) {
                        status = 'Crítico';
                        statusClass = 'danger';
                    } else if (estoque <= minimo) {
                        status = 'Baixo';
                        statusClass = 'warning';
                    }

                    return `
                        <tr data-id="${p.id}">
                            <td><strong>${codigo}</strong></td>
                            <td>${descricao}</td>
                            <td><span class="badge">${sku}</span></td>
                            <td>${categoria}</td>
                            <td>${estoque.toFixed(2)}</td>
                            <td>${minimo}</td>
                            <td>R$ ${preco.toFixed(2)}</td>
                            <td><span class="badge badge-${statusClass}">${status}</span></td>
                            <td>
                                <button class="btn btn-sm btn-secondary" onclick="editarProduto(${p.id})" title="Editar">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="excluirProduto(${p.id})" title="Excluir">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                }).join('');

            } catch (error) {
                console.error('Erro ao buscar produtos:', error);
                if (tableBody) {
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="9" style="text-align: center; padding: 60px;">
                                <i class="fas fa-exclamation-triangle" style="font-size: 48px; color: var(--danger); margin-bottom: 16px;"></i>
                                <p style="color: var(--gray-500);">Erro ao carregar produtos</p>
                                <button class="btn btn-primary" onclick="buscarProdutos()" style="margin-top: 16px;">
                                    <i class="fas fa-redo"></i> Tentar novamente
                                </button>
                            </td>
                        </tr>
                    `;
                }
            }
        }

        // Disponibilizar globalmente
        window.buscarProdutos = buscarProdutos;
        window.abrirNovoProdutoPCP = abrirNovoProdutoPCP;
        window.editarProduto = editarProduto;
        window.excluirProduto = excluirProduto;
        window.salvarProdutoPCP = salvarProdutoPCP;
        window.fecharModalProdutoPCP = fecharModalProdutoPCP;
        window.limparFormProdutoPCP = limparFormProdutoPCP;
        window.mudarAbaProdutoPCP = mudarAbaProdutoPCP;
        window.toggleDefinicaoProdutoPCP = toggleDefinicaoProdutoPCP;
        window.previewImagemProdutoPCP = previewImagemProdutoPCP;
        window.mostrarConfirmacaoPCP = mostrarConfirmacaoPCP;
        window.fecharConfirmacaoPCP = fecharConfirmacaoPCP;

        // ============================================
        // FUNÇÕES DO MODAL NOVA ORDEM DE PRODUÇÃO
        // Expor funções para onclick no HTML
        // ============================================
        window.adicionarProdutoOP = adicionarProdutoOP;
        window.editarProdutoOP = editarProdutoOP;
        window.removerProdutoOP = removerProdutoOP;
        window.salvarProdutoModal = salvarProdutoModal;
        window.fecharModalProduto = fecharModalProduto;
        window.calcularPreviewTotal = calcularPreviewTotal;
        window.buscarProdutoCatalogo = buscarProdutoCatalogo;
        window.selecionarProdutoCatalogo = selecionarProdutoCatalogo;
        window.atualizarTabelaProdutosOP = atualizarTabelaProdutosOP;
        window.atualizarEmbalagemProduto = atualizarEmbalagemProduto;
        window.atualizarLancesProduto = atualizarLancesProduto;
        window.gerarExcelOP = gerarExcelOP;
        window.buscarClientesAutocomplete = buscarClientesAutocomplete;
        window.selecionarClienteOP = selecionarClienteOP;
        window.buscarTransportadorasAutocomplete = buscarTransportadorasAutocomplete;
        window.selecionarTransportadoraOP = selecionarTransportadoraOP;
        window.buscarClienteOP = buscarClienteOP;
        window.buscarTransportadoraOP = buscarTransportadoraOP;
        window.limparFormOP = limparFormOP;
        window.imprimirOP = imprimirOP;
        window.duplicarOP = duplicarOP;
        window.switchOPTab = switchOPTab;
        window.salvarOrdemProducao = salvarOrdemProducao;
        window.gerarNumeroOP = gerarNumeroOP;
        window.initModalNovaOrdem = initModalNovaOrdem;

        // ============================================
        // MODAL PRODUTO PCP - Funções
        // ============================================
        
        // Variável para callback de confirmação
        let confirmacaoCallback = null;
        
        // Mostrar modal de confirmação customizado
        function mostrarConfirmacaoPCP(titulo, mensagem, tipo = 'warning') {
            return new Promise((resolve) => {
                const modal = document.getElementById('modal-confirmacao-pcp');
                const iconDiv = document.getElementById('confirmacao-icon');
                const tituloEl = document.getElementById('confirmacao-titulo');
                const mensagemEl = document.getElementById('confirmacao-mensagem');
                const btnConfirmar = document.getElementById('confirmacao-btn-confirmar');
                
                tituloEl.textContent = titulo;
                mensagemEl.textContent = mensagem;
                
                // Configurar ícone e cores baseado no tipo
                const configs = {
                    'warning': { icon: 'fa-exclamation-triangle', bg: '#fef3c7', color: '#f59e0b', btnBg: 'linear-gradient(135deg, #f59e0b, #d97706)' },
                    'danger': { icon: 'fa-trash-alt', bg: '#fee2e2', color: '#dc2626', btnBg: 'linear-gradient(135deg, #dc2626, #b91c1c)' },
                    'info': { icon: 'fa-info-circle', bg: '#dbeafe', color: '#3b82f6', btnBg: 'linear-gradient(135deg, #3b82f6, #2563eb)' },
                    'success': { icon: 'fa-check-circle', bg: '#dcfce7', color: '#16a34a', btnBg: 'linear-gradient(135deg, #16a34a, #15803d)' }
                };
                
                const config = configs[tipo] || configs.warning;
                iconDiv.style.background = config.bg;
                iconDiv.innerHTML = `<i class="fas ${config.icon}" style="font-size: 28px; color: ${config.color};"></i>`;
                btnConfirmar.style.background = config.btnBg;
                
                confirmacaoCallback = resolve;
                modal.classList.add('active');
            });
        }
        
        // Fechar modal de confirmação
        function fecharConfirmacaoPCP(resultado) {
            const modal = document.getElementById('modal-confirmacao-pcp');
            modal.classList.remove('active');
            if (confirmacaoCallback) {
                confirmacaoCallback(resultado);
                confirmacaoCallback = null;
            }
        }
        
        // Abrir modal para novo produto
        function abrirNovoProdutoPCP() {
            limparFormProdutoPCP(true); // Limpar sem confirmação
            document.getElementById('modal-novo-produto-titulo').textContent = 'Incluir Produto';
            document.getElementById('pcp-produto-id').value = '';
            showModal('modal-novo-produto');
        }
        
        // Editar produto existente
        async function editarProduto(produtoId) {
            try {
                showNotification('Carregando dados do produto...', 'info');
                
                const response = await fetch(`/api/pcp/produtos/${produtoId}`, { credentials: 'include' });
                if (!response.ok) throw new Error('Produto Não encontrado');
                
                const produto = await response.json();
                console.log('Dados do produto carregados:', produto);
                
                // Limpar formulário primeiro (sem confirmação)
                limparFormProdutoPCP(true);
                
                // Alterar título
                document.getElementById('modal-novo-produto-titulo').textContent = 'Editar Produto';
                
                // Preencher campos
                document.getElementById('pcp-produto-id').value = produto.id || '';
                document.getElementById('pcp-produto-codigo').value = produto.codigo || '';
                document.getElementById('pcp-produto-descricao').value = produto.nome || produto.descricao || '';
                document.getElementById('pcp-produto-sku').value = produto.sku || '';
                document.getElementById('pcp-produto-ean').value = produto.gtin || produto.ean || '';
                document.getElementById('pcp-produto-ncm').value = produto.ncm || '';
                
                // Preço - verificar ambos os campos possíveis
                const preco = produto.preco_venda || produto.preco || 0;
                document.getElementById('pcp-produto-preco').value = parseFloat(preco).toFixed(2).replace('.', ',');
                
                // Unidade - verificar ambos os campos possíveis
                const unidadeSelect = document.getElementById('pcp-produto-unidade');
                const unidadeValue = produto.unidade_medida || produto.unidade;
                if (unidadeSelect && unidadeValue) {
                    for (let opt of unidadeSelect.options) {
                        if (opt.value === unidadeValue || opt.value === unidadeValue.toUpperCase()) {
                            opt.selected = true;
                            break;
                        }
                    }
                }
                
                // Categoria
                const categoriaSelect = document.getElementById('pcp-produto-categoria');
                if (categoriaSelect && produto.categoria) {
                    for (let opt of categoriaSelect.options) {
                        if (opt.value === produto.categoria || opt.value === produto.categoria.toUpperCase()) {
                            opt.selected = true;
                            break;
                        }
                    }
                }
                
                // Estoque - verificar ambos os campos possíveis (estoque_atual ou estoque)
                const estoqueAtual = produto.estoque_atual !== undefined ? produto.estoque_atual : (produto.estoque || 0);
                document.getElementById('pcp-produto-estoque').value = estoqueAtual;
                document.getElementById('pcp-produto-estoque-minimo').value = produto.estoque_minimo || 0;
                
                // Observações
                if (produto.observacoes) {
                    document.getElementById('pcp-produto-observacoes').value = produto.observacoes;
                }
                
                console.log('Campos preenchidos - Estoque:', estoqueAtual, 'Preço:', preco);
                
                // Abrir modal na aba de estoque
                mudarAbaProdutoPCP('estoque', document.querySelector('.pcp-produto-tab'));
                showModal('modal-novo-produto');
                
            } catch (error) {
                console.error('Erro ao carregar produto:', error);
                showNotification('Erro ao carregar dados do produto', 'error');
            }
        }
        
        // Excluir produto
        async function excluirProduto(produtoId) {
            const confirmado = await mostrarConfirmacaoPCP(
                'Excluir Produto',
                'Tem certeza que deseja excluir este produto? Esta ação Não pode ser desfeita.',
                'danger'
            );
            
            if (!confirmado) return;
            
            try {
                const response = await fetch(`/api/pcp/produtos/${produtoId}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });
                
                if (response.ok) {
                    showNotification('Produto excluído com sucesso!', 'success');
                    buscarProdutos(); // Recarregar lista
                } else {
                    const error = await response.json();
                    showNotification(error.message || 'Erro ao excluir produto', 'error');
                }
            } catch (error) {
                console.error('Erro ao excluir produto:', error);
                showNotification('Erro ao excluir produto', 'error');
            }
        }
        
        // Salvar produto (novo ou edição)
        async function salvarProdutoPCP() {
            const produtoId = document.getElementById('pcp-produto-id').value;
            const codigo = document.getElementById('pcp-produto-codigo').value.trim();
            const descricao = document.getElementById('pcp-produto-descricao').value.trim();
            
            if (!codigo || !descricao) {
                showNotification('Código e descrição são obrigatórios!', 'warning');
                return;
            }
            
            // Pegar valores de estoque
            const estoqueInput = document.getElementById('pcp-produto-estoque');
            const estoqueMinimoInput = document.getElementById('pcp-produto-estoque-minimo');
            const precoInput = document.getElementById('pcp-produto-preco');
            
            const estoqueValue = estoqueInput ? parseFloat(estoqueInput.value) : 0;
            const estoqueMinimoValue = estoqueMinimoInput ? parseInt(estoqueMinimoInput.value) : 0;
            const precoValue = precoInput ? parseFloat(precoInput.value.replace(',', '.')) : 0;
            
            console.log('Salvando produto - Estoque:', estoqueValue, 'Estoque Mínimo:', estoqueMinimoValue, 'Preço:', precoValue);
            
            const dados = {
                codigo: codigo,
                nome: descricao,
                descricao: descricao,
                sku: document.getElementById('pcp-produto-sku').value.trim() || `SKU-${codigo}`,
                gtin: document.getElementById('pcp-produto-ean').value.trim(),
                unidade: document.getElementById('pcp-produto-unidade').value,
                ncm: document.getElementById('pcp-produto-ncm').value.trim(),
                categoria: document.getElementById('pcp-produto-categoria').value,
                preco: precoValue,
                preco_venda: precoValue,
                estoque: estoqueValue,
                estoque_minimo: estoqueMinimoValue,
                estoque_maximo: 0,
                observacoes: document.getElementById('pcp-produto-observacoes').value.trim()
            };
            
            console.log('Dados a enviar:', dados);
            
            try {
                const url = produtoId ? `/api/pcp/produtos/${produtoId}` : '/api/pcp/produtos';
                const method = produtoId ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(dados),
                    credentials: 'include'
                });
                
                if (response.ok) {
                    showNotification(produtoId ? 'Produto atualizado com sucesso!' : 'Produto cadastrado com sucesso!', 'success');
                    fecharModalProdutoPCP();
                    buscarProdutos(); // Recarregar lista
                } else {
                    const error = await response.json();
                    showNotification(error.message || 'Erro ao salvar produto', 'error');
                }
            } catch (error) {
                console.error('Erro ao salvar produto:', error);
                showNotification('Erro ao salvar produto', 'error');
            }
        }
        
        // Fechar modal de produto
        function fecharModalProdutoPCP() {
            hideModal('modal-novo-produto');
        }
        
        // Limpar formulário do produto
        async function limparFormProdutoPCP(semConfirmacao = false) {
            if (!semConfirmacao) {
                const confirmado = await mostrarConfirmacaoPCP(
                    'Limpar Formulário',
                    'Limpar todos os campos do formulário?',
                    'warning'
                );
                if (!confirmado) return;
            }
            
            document.getElementById('pcp-produto-id').value = '';
            document.getElementById('pcp-produto-codigo').value = '';
            document.getElementById('pcp-produto-descricao').value = '';
            document.getElementById('pcp-produto-sku').value = '';
            document.getElementById('pcp-produto-ean').value = '';
            document.getElementById('pcp-produto-ncm').value = '';
            document.getElementById('pcp-produto-preco').value = '0,00';
            document.getElementById('pcp-produto-unidade').selectedIndex = 0;
            document.getElementById('pcp-produto-categoria').selectedIndex = 0;
            document.getElementById('pcp-produto-estoque').value = '0';
            document.getElementById('pcp-produto-estoque-minimo').value = '0';
            document.getElementById('pcp-produto-observacoes').value = '';
            
            // Limpar preview de imagem
            const preview = document.getElementById('pcp-produto-imagem-preview');
            const icon = document.getElementById('pcp-produto-imagem-icon');
            if (preview) preview.style.display = 'none';
            if (icon) icon.style.display = 'block';
        }
        
        // Mudar aba do modal de produto
        function mudarAbaProdutoPCP(aba, btn) {
            // Remover active de todas as abas
            document.querySelectorAll('.pcp-produto-tab').forEach(t => {
                t.classList.remove('active');
                t.style.borderBottomColor = 'transparent';
                t.style.color = '#666';
            });
            
            // Esconder todos os painéis
            document.querySelectorAll('.pcp-produto-tab-panel').forEach(p => p.style.display = 'none');
            
            // Ativar aba clicada
            if (btn) {
                btn.classList.add('active');
                btn.style.borderBottomColor = '#f97316';
                btn.style.color = '#f97316';
            }
            
            // Mostrar painel correspondente
            const painel = document.getElementById(`pcp-tab-${aba}`);
            if (painel) painel.style.display = 'block';
        }
        
        // Toggle definição do produto
        function toggleDefinicaoProdutoPCP(el, tipo) {
            document.querySelectorAll('.toggle-switch-pcp').forEach(t => {
                t.removeAttribute('data-active');
            });
            el.setAttribute('data-active', 'true');
        }
        
        // Preview de imagem do produto
        function previewImagemProdutoPCP(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = document.getElementById('pcp-produto-imagem-preview');
                    const icon = document.getElementById('pcp-produto-imagem-icon');
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                    icon.style.display = 'none';
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        // ============================================
        // FUNÇÕES ORDEM DE COMPRA - PCP
        // ============================================
        let ocFornecedoresCache = [];
        let ocMateriaisCache = [];

        async function carregarOCFornecedores() {
            try {
                const response = await fetch('/api/compras/fornecedores', { credentials: 'include' });
                const result = await response.json();
                ocFornecedoresCache = result.fornecedores || result.data || result || [];
                
                const select = document.getElementById('ocSelectFornecedor');
                if (select) {
                    select.innerHTML = '<option value="">Selecione o fornecedor...</option>';
                    ocFornecedoresCache.forEach(f => {
                        select.innerHTML += `<option value="${f.id}">${f.razao_social || f.nome || f.nome_fantasia}</option>`;
                    });
                }
            } catch (error) {
                console.error('Erro ao carregar fornecedores:', error);
            }
        }

        async function carregarOCMateriais() {
            try {
                const response = await fetch('/api/compras/materiais', { credentials: 'include' });
                const result = await response.json();
                ocMateriaisCache = result.materiais || result.data || result || [];
                
                const select = document.getElementById('ocSelectMaterial');
                if (select) {
                    select.innerHTML = '<option value="">Selecione o material...</option>';
                    ocMateriaisCache.forEach(m => {
                        const preco = m.custo_unitario ? ` - R$ ${parseFloat(m.custo_unitario).toFixed(2)}` : '';
                        select.innerHTML += `<option value="${m.id}" data-preco="${m.custo_unitario || 0}">${m.descricao || m.nome}${preco}</option>`;
                    });
                }
            } catch (error) {
                console.error('Erro ao carregar materiais:', error);
            }
        }

        function exibirOCInfoFornecedor() {
            const select = document.getElementById('ocSelectFornecedor');
            const infoDiv = document.getElementById('ocInfoFornecedor');
            const fornecedor = ocFornecedoresCache.find(f => f.id == select.value);
            
            if (fornecedor) {
                document.getElementById('ocFornCnpj').textContent = fornecedor.cnpj || '-';
                document.getElementById('ocFornTelefone').textContent = fornecedor.telefone || '-';
                document.getElementById('ocFornEmail').textContent = fornecedor.email || '-';
                document.getElementById('ocFornCidade').textContent = (fornecedor.cidade || '-') + (fornecedor.estado ? '/' + fornecedor.estado : '');
                infoDiv.style.display = 'block';
            } else {
                infoDiv.style.display = 'none';
            }
        }

        function preencherOCValorMaterial() {
            const select = document.getElementById('ocSelectMaterial');
            const option = select.options[select.selectedIndex];
            const preco = parseFloat(option?.dataset?.preco || 0);
            
            if (preco > 0) {
                document.getElementById('ocInputValorUnitario').value = preco.toFixed(2).replace('.', ',');
                atualizarOCValorTotal();
            }
        }

        function atualizarOCValorTotal() {
            const quantidade = parseFloat(document.getElementById('ocInputQuantidade')?.value) || 0;
            const valorStr = document.getElementById('ocInputValorUnitario')?.value || '0';
            const valorUnitario = parseFloat(valorStr.replace(/\./g, '').replace(',', '.')) || 0;
            
            const total = quantidade * valorUnitario;
            const resumoDiv = document.getElementById('ocResumoPedido');
            const valorTotalSpan = document.getElementById('ocValorTotalPedido');
            
            if (total > 0) {
                valorTotalSpan.textContent = 'R$ ' + total.toLocaleString('pt-BR', { minimumFractionDigits: 2 });
                resumoDiv.style.display = 'block';
            } else {
                resumoDiv.style.display = 'none';
            }
        }

        function abrirModalNovaOC() {
            carregarOCFornecedores();
            carregarOCMateriais();
            document.getElementById('formNovaOC').reset();
            document.getElementById('ocInfoFornecedor').style.display = 'none';
            document.getElementById('ocResumoPedido').style.display = 'none';
            document.getElementById('modalNovaOC').classList.add('active');
            
            const hoje = new Date().toISOString().split('T')[0];
            document.getElementById('ocInputPrazoEntrega').min = hoje;
            
            // Event listeners
            document.getElementById('ocSelectFornecedor').onchange = exibirOCInfoFornecedor;
            document.getElementById('ocSelectMaterial').onchange = preencherOCValorMaterial;
            document.getElementById('ocInputQuantidade').oninput = atualizarOCValorTotal;
            document.getElementById('ocInputValorUnitario').oninput = atualizarOCValorTotal;
        }

        function fecharModalNovaOC() {
            document.getElementById('modalNovaOC').classList.remove('active');
        }

        async function salvarOCPCP() {
            const fornecedorId = document.getElementById('ocSelectFornecedor').value;
            const materialId = document.getElementById('ocSelectMaterial').value;
            const quantidade = document.getElementById('ocInputQuantidade').value;
            const valorStr = document.getElementById('ocInputValorUnitario').value;
            const prazoEntrega = document.getElementById('ocInputPrazoEntrega').value;
            const pagamento = document.getElementById('ocSelectPagamento').value;
            const prazoPagamento = document.getElementById('ocSelectPrazoPagamento').value;
            const observacoes = document.getElementById('ocInputObservacoes').value;

            if (!fornecedorId || !materialId || !quantidade || !valorStr || !prazoEntrega) {
                showToast('Preencha todos os campos obrigatórios', 'warning');
                return;
            }

            const valorUnitario = parseFloat(valorStr.replace(/\./g, '').replace(',', '.'));
            const valorTotal = parseFloat(quantidade) * valorUnitario;

            try {
                const response = await fetch('/api/compras/pedidos', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({
                        fornecedor_id: parseInt(fornecedorId),
                        data_entrega_prevista: prazoEntrega,
                        valor_total: valorTotal,
                        observacoes: observacoes + ' [Origem: PCP]',
                        condicao_pagamento: prazoPagamento,
                        forma_pagamento: pagamento,
                        origem: 'PCP',
                        itens: [{
                            material_id: parseInt(materialId),
                            quantidade: parseInt(quantidade),
                            valor_unitario: valorUnitario,
                            valor_total: valorTotal
                        }]
                    })
                });

                const result = await response.json();

                if (response.ok) {
                    showToast('Ordem de compra criada com sucesso!', 'success');
                    fecharModalNovaOC();
                    carregarOCsPCP(); // Recarregar lista
                    
                    // Adicionar notificação
                    adicionarNotificacaoPCP(
                        'Ordem de Compra Criada',
                        `OC #${result.id || 'Nova'} criada - R$ ${valorTotal.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}`,
                        'success',
                        'usuario'
                    );
                } else {
                    throw new Error(result.error || 'Erro ao criar OC');
                }
            } catch (error) {
                console.error('Erro:', error);
                showToast(error.message || 'Erro ao criar ordem de compra', 'error');
            }
        }

        async function carregarOCsPCP() {
            try {
                const response = await fetch('/api/compras/pedidos', { credentials: 'include' });
                const result = await response.json();
                const pedidos = result.pedidos || result.data || result || [];
                
                // Filtrar apenas pedidos do PCP ou mostrar todos
                const tbody = document.getElementById('oc-table-body');
                
                // Calcular estatísticas
                let abertas = 0, aprovadas = 0, aguardando = 0, valorTotal = 0;
                
                pedidos.forEach(p => {
                    valorTotal += parseFloat(p.valor_total || 0);
                    if (p.status === 'pendente') abertas++;
                    else if (p.status === 'aprovado') aprovadas++;
                    else if (p.status === 'parcial') aguardando++;
                });
                
                document.getElementById('oc-abertas').textContent = abertas;
                document.getElementById('oc-aprovadas').textContent = aprovadas;
                document.getElementById('oc-aguardando').textContent = aguardando;
                document.getElementById('oc-valor').textContent = 'R$ ' + valorTotal.toLocaleString('pt-BR', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
                
                if (pedidos.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="7" style="text-align: center; padding: 60px;">
                                <div class="empty-state">
                                    <div class="empty-state-icon"><i class="fas fa-shopping-cart"></i></div>
                                    <h4 class="empty-state-title">Nenhuma OC encontrada</h4>
                                    <p class="empty-state-desc">Clique em "Nova OC" para criar uma ordem de compra.</p>
                                </div>
                            </td>
                        </tr>`;
                } else {
                    tbody.innerHTML = pedidos.map(p => {
                        const statusColors = {
                            'pendente': '#f59e0b',
                            'aprovado': '#22c55e',
                            'parcial': '#3b82f6',
                            'recebido': '#10b981',
                            'cancelado': '#ef4444'
                        };
                        const statusLabel = {
                            'pendente': 'Pendente',
                            'aprovado': 'Aprovado',
                            'parcial': 'Parcial',
                            'recebido': 'Recebido',
                            'cancelado': 'Cancelado'
                        };
                        return `
                            <tr>
                                <td><strong>#${p.numero_pedido || p.id}</strong></td>
                                <td>${p.fornecedor_nome || p.fornecedor || '-'}</td>
                                <td>${p.data_pedido ? new Date(p.data_pedido).toLocaleDateString('pt-BR') : '-'}</td>
                                <td>${p.data_entrega_prevista ? new Date(p.data_entrega_prevista).toLocaleDateString('pt-BR') : '-'}</td>
                                <td>R$ ${parseFloat(p.valor_total || 0).toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</td>
                                <td><span style="background: ${statusColors[p.status] || '#64748b'}; color: white; padding: 4px 12px; border-radius: 20px; font-size: 12px;">${statusLabel[p.status] || p.status}</span></td>
                                <td>
                                    <button class="btn btn-icon" title="Visualizar" onclick="visualizarOC(${p.id})"><i class="fas fa-eye"></i></button>
                                    <button class="btn btn-icon" title="Editar" onclick="editarOC(${p.id})"><i class="fas fa-edit"></i></button>
                                </td>
                            </tr>
                        `;
                    }).join('');
                }
            } catch (error) {
                console.error('Erro ao carregar OCs:', error);
            }
        }

        function visualizarOC(id) {
            showToast('Visualizando OC #' + id, 'info');
        }

        function editarOC(id) {
            showToast('Editando OC #' + id, 'info');
        }

        // ============================================
        // INICIALIZAÇÃO
        // ============================================
        document.addEventListener('DOMContentLoaded', () => {
            console.log('PCP Module Initialized');
            // Carregar dados do usuário logado
            carregarDadosUsuario();
            // Carregar dados iniciais aqui
            loadDashboardData();
            // Carregar OCs
            carregarOCsPCP();
            
            // Configurar Event Listeners dos botões (remover onclick inline para evitar CSP)
            const btnNovaOrdem = document.getElementById('btn-nova-ordem');
            const btnQuickNovaOrdem = document.getElementById('btn-quick-nova-ordem');
            const btnAtualizarDashboard = document.getElementById('btn-atualizar-dashboard');
            const btnNovoFaturamento = document.getElementById('btn-novo-faturamento');
            
            if (btnNovaOrdem) btnNovaOrdem.addEventListener('click', () => showModal('modal-nova-ordem'));
            if (btnQuickNovaOrdem) btnQuickNovaOrdem.addEventListener('click', () => showModal('modal-nova-ordem'));
            if (btnAtualizarDashboard) btnAtualizarDashboard.addEventListener('click', () => location.reload());
            if (btnNovoFaturamento) btnNovoFaturamento.addEventListener('click', () => showModal('modal-novo-faturamento'));
            
            // Verificar se há uma view salva (navegação da sidebar de outra página)
            const savedView = localStorage.getItem('pcp-view');
            if (savedView) {
                localStorage.removeItem('pcp-view'); // Limpar para próximas navegações
                setTimeout(() => {
                    navigateTo(savedView);
                }, 100);
            }
        });

        // Mapeamento de avatares por nome de usuário
        const avatarNameMap = {
            'clemerson': '/avatars/Clemerson.webp',
            'isabela': '/avatars/Isabela.webp',
            'thaina': '/avatars/Thaina.webp',
            'thiago': '/avatars/Thiago.webp',
            'nicolas': '/avatars/NicolasDaniel.webp',
            'nicolasdaniel': '/avatars/NicolasDaniel.webp',
            'rh': '/avatars/Rh.webp',
            'admin': '/avatars/admin.webp',
            'ti': '/avatars/TI.webp',
            'tialuforce': '/avatars/TI.webp',
            'antonio': '/avatars/Antonio.webp',
            'andreia': '/avatars/Andreia.webp',
            'guilherme': '/avatars/Guilherme.webp',
            'marcelo': '/avatars/Marcelo.webp'
        };

        function getAvatarFromEmail(email, nome) {
            if (!email) return null;
            const username = email.split('@')[0].split('.')[0].toLowerCase();
            if (avatarNameMap[username]) return avatarNameMap[username];
            if (nome) {
                const firstName = nome.split(' ')[0].toLowerCase();
                if (avatarNameMap[firstName]) return avatarNameMap[firstName];
            }
            return null;
        }

        // Função para carregar dados do usuário logado
        async function carregarDadosUsuario() {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch('/api/me', {
                    credentials: 'include',
                    headers: token ? { 'Authorization': `Bearer ${token}` } : {}
                });
                
                if (response.ok) {
                    const user = await response.json();
                    console.log('Dados do usuário recebidos:', user);
                    
                    // Atualizar saudação dinâmica baseada na hora
                    const greetingTextEl = document.getElementById('greeting-text');
                    if (greetingTextEl) {
                        const hour = new Date().getHours();
                        let greeting = 'Bom dia';
                        if (hour >= 12 && hour < 18) greeting = 'Boa tarde';
                        else if (hour >= 18 || hour < 5) greeting = 'Boa noite';
                        greetingTextEl.textContent = greeting;
                    }
                    
                    // Usar apelido se disponível, senão primeiro nome
                    const userName = user.apelido || user.nome || 'Usuário';
                    const primeiroNome = user.apelido || (user.nome ? user.nome.split(' ')[0] : 'Usuário');
                    const nomeCompleto = user.nome || user.name || 'Usuário';
                    
                    // Atualizar nome no header
                    const userNameEl = document.getElementById('user-name');
                    if (userNameEl) {
                        userNameEl.textContent = primeiroNome;
                    }
                    
                    // Atualizar avatar/foto
                    const userPhotoEl = document.getElementById('user-photo');
                    const userInitialsEl = document.getElementById('user-initials');
                    const userAvatarDiv = document.getElementById('user-avatar');
                    
                    // Prioridade: avatarNameMap > foto_perfil_url > avatar > fallback por iniciais
                    let fotoUrl = getAvatarFromEmail(user.email, nomeCompleto);
                    if (!fotoUrl) {
                        fotoUrl = user.foto_perfil_url || user.avatar || user.foto;
                    }
                    
                    if (fotoUrl && fotoUrl !== '/avatars/default.webp' && userPhotoEl) {
                        // Tem foto - mostrar imagem
                        userPhotoEl.src = fotoUrl;
                        userPhotoEl.style.display = 'block';
                        userPhotoEl.onerror = function() {
                            // Se a imagem falhar, mostrar iniciais
                            this.style.display = 'none';
                            mostrarIniciaisAvatar(nomeCompleto, userAvatarDiv, userInitialsEl);
                        };
                        if (userInitialsEl) userInitialsEl.style.display = 'none';
                        console.log('Avatar carregado:', fotoUrl);
                    } else {
                        // Sem foto - gerar avatar com iniciais
                        mostrarIniciaisAvatar(nomeCompleto, userAvatarDiv, userInitialsEl);
                        if (userPhotoEl) userPhotoEl.style.display = 'none';
                    }
                    
                    // Salvar dados do usuário no localStorage para uso em outras partes
                    localStorage.setItem('userData', JSON.stringify({
                        nome: nomeCompleto,
                        email: user.email,
                        avatar: fotoUrl,
                        setor: user.setor
                    }));
                    
                    console.log('Usuário carregado:', primeiroNome, 'Avatar:', fotoUrl ? fotoUrl : 'Iniciais');
                } else {
                    console.warn('Falha ao carregar usuário, status:', response.status);
                    carregarUsuarioLocalStorage();
                }
            } catch (error) {
                console.error('Erro ao carregar dados do usuário:', error);
                carregarUsuarioLocalStorage();
            }
        }
        
        // Função para mostrar iniciais como avatar
        function mostrarIniciaisAvatar(nomeCompleto, avatarDiv, iniciaisEl) {
            const iniciais = nomeCompleto.split(' ').slice(0, 2).map(n => n[0]).join('').toUpperCase() || 'U';
            const cores = ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#06b6d4'];
            const corIndex = nomeCompleto.charCodeAt(0) % cores.length;
            const cor = cores[corIndex];
            
            if (iniciaisEl) {
                iniciaisEl.textContent = iniciais;
                iniciaisEl.style.display = 'flex';
                iniciaisEl.style.background = cor;
            } else if (avatarDiv) {
                avatarDiv.innerHTML = `<span style="display:flex;align-items:center;justify-content:center;width:100%;height:100%;background:${cor};color:white;font-weight:600;border-radius:50%;">${iniciais}</span>`;
            }
        }
        
        // Função para carregar usuário do localStorage como fallback
        function carregarUsuarioLocalStorage() {
            try {
                const userData = JSON.parse(localStorage.getItem('userData') || '{}');
                if (userData.nome) {
                    const userNameEl = document.getElementById('user-name');
                    if (userNameEl) userNameEl.textContent = userData.nome.split(' ')[0];
                    if (userData.avatar) {
                        const userPhotoEl = document.getElementById('user-photo');
                        if (userPhotoEl) {
                            userPhotoEl.src = userData.avatar;
                            userPhotoEl.style.display = 'block';
                        }
                    }
                }
            } catch (e) { console.warn('Não foi possível carregar dados do localStorage'); }
        }

        // Função para carregar Ordens Recentes (do módulo Vendas)
        async function carregarOrdensRecentes() {
            const tbody = document.getElementById('recent-orders-table');
            if (!tbody) return;
            
            try {
                const response = await fetch('/api/vendas/pedidos?limit=10', { credentials: 'include' });
                if (!response.ok) throw new Error('Erro ao carregar pedidos');
                
                const pedidos = await response.json();
                
                // Mapeamento de status para exibição
                const statusLabels = {
                    'orcamento': { label: 'Orçamento', class: 'status-badge gray' },
                    'aprovado': { label: 'Aprovado', class: 'status-badge blue' },
                    'analise_credito': { label: 'Análise de Crédito', class: 'status-badge yellow' },
                    'faturar': { label: 'A Faturar', class: 'status-badge orange' },
                    'faturado': { label: 'Faturado', class: 'status-badge green' },
                    'entregue': { label: 'Entregue', class: 'status-badge purple' },
                    'cancelado': { label: 'Cancelado', class: 'status-badge red' }
                };
                
                if (pedidos.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="6" style="text-align: center; padding: 40px;">
                                <div class="empty-state-icon"><i class="fas fa-clipboard-list"></i></div>
                                <p style="margin-top: 16px; color: var(--gray-500);">Nenhuma ordem encontrada</p>
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                tbody.innerHTML = pedidos.map(pedido => {
                    const statusInfo = statusLabels[pedido.status] || { label: pedido.status, class: 'status-badge gray' };
                    const data = pedido.created_at ? new Date(pedido.created_at).toLocaleDateString('pt-BR') : '-';
                    const valor = pedido.valor ? `R$ ${parseFloat(pedido.valor).toLocaleString('pt-BR', { minimumFractionDigits: 2 })}` : '-';
                    
                    // Pedidos faturado ou faturar podem gerar OP
                    const podeGerarOP = pedido.status === 'faturado' || pedido.status === 'faturar';
                    const acaoBotao = podeGerarOP 
                        ? `onclick="abrirOrdemProducaoDePedido(${pedido.id})" title="Gerar Ordem de Produção"`
                        : `onclick="visualizarPedido(${pedido.id})" title="Visualizar Pedido"`;
                    const iconeBotao = podeGerarOP ? 'fa-industry' : 'fa-eye';
                    const classeBotao = podeGerarOP ? 'btn btn-sm btn-success' : 'btn btn-sm btn-secondary';
                    
                    return `
                        <tr>
                            <td><strong>#${pedido.id}</strong></td>
                            <td>${pedido.empresa_nome || 'Não informado'}</td>
                            <td>${valor}</td>
                            <td><span class="${statusInfo.class}">${statusInfo.label}</span></td>
                            <td>${data}</td>
                            <td>
                                <div class="table-actions">
                                    <button class="${classeBotao}" ${acaoBotao}>
                                        <i class="fas ${iconeBotao}"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                }).join('');
                
            } catch (error) {
                console.error('Erro ao carregar ordens recentes:', error);
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 40px;">
                            <div class="empty-state-icon"><i class="fas fa-exclamation-triangle" style="color: var(--red-500);"></i></div>
                            <p style="margin-top: 16px; color: var(--gray-500);">Erro ao carregar ordens</p>
                            <button class="btn btn-sm btn-primary" onclick="carregarOrdensRecentes()" style="margin-top: 12px;">
                                <i class="fas fa-sync-alt"></i> Tentar Novamente
                            </button>
                        </td>
                    </tr>
                `;
            }
        }
        
        // Função para visualizar pedido do Vendas
        function visualizarPedido(pedidoId) {
            // Redirecionar para o módulo de Vendas com o pedido selecionado
            window.location.href = `/modules/Vendas/index.html?pedido=${pedidoId}`;
        }
        
        // Função para abrir modal de Nova OP com dados do pedido de Vendas
        async function abrirOrdemProducaoDePedido(pedidoId) {
            try {
                // Mostrar loading
                showNotification('Carregando dados do pedido...', 'info');
                
                // Buscar dados do pedido
                const pedidoResponse = await fetch(`/api/vendas/pedidos/${pedidoId}`, { credentials: 'include' });
                if (!pedidoResponse.ok) throw new Error('Erro ao buscar pedido');
                const pedido = await pedidoResponse.json();
                
                // Buscar itens do pedido
                const itensResponse = await fetch(`/api/vendas/pedidos/${pedidoId}/itens`, { credentials: 'include' });
                const itens = itensResponse.ok ? await itensResponse.json() : [];
                
                // Buscar dados da empresa (cliente)
                let empresa = null;
                if (pedido.empresa_id) {
                    const empresaResponse = await fetch(`/api/vendas/empresas/${pedido.empresa_id}`, { credentials: 'include' });
                    if (empresaResponse.ok) {
                        empresa = await empresaResponse.json();
                    }
                }
                
                // Limpar formulário primeiro
                limparFormOP();
                
                // Gerar número da OP
                gerarNumeroOP();
                
                // Preencher número do orçamento/pedido
                const opOrcamento = document.getElementById('op-orcamento');
                if (opOrcamento) opOrcamento.value = `P-${pedidoId}`;
                
                // Preencher data de liberação (data atual)
                const opDataLiberacao = document.getElementById('op-data-liberacao');
                if (opDataLiberacao) opDataLiberacao.value = new Date().toISOString().split('T')[0];
                
                // Preencher vendedor (usa vendedor_nome que vem do pedido)
                const opVendedor = document.getElementById('op-vendedor');
                if (opVendedor && pedido.vendedor_nome) {
                    const vendedorNome = pedido.vendedor_nome;
                    let optionFound = false;
                    for (let option of opVendedor.options) {
                        if (option.value === vendedorNome || option.text === vendedorNome) {
                            option.selected = true;
                            optionFound = true;
                            break;
                        }
                    }
                    if (!optionFound && vendedorNome) {
                        const newOption = new Option(vendedorNome, vendedorNome, true, true);
                        opVendedor.add(newOption);
                    }
                }
                
                // Preencher dados do cliente
                if (empresa) {
                    const opCliente = document.getElementById('op-cliente');
                    const opClienteId = document.getElementById('op-cliente-id');
                    const opClienteCnpj = document.getElementById('op-cliente-cnpj');
                    const opClienteContato = document.getElementById('op-cliente-contato');
                    const opClienteFone = document.getElementById('op-cliente-fone');
                    const opClienteEmail = document.getElementById('op-cliente-email');
                    
                    if (opCliente) opCliente.value = empresa.razao_social || empresa.nome_fantasia || '';
                    if (opClienteId) opClienteId.value = empresa.id || '';
                    if (opClienteCnpj) opClienteCnpj.value = empresa.cnpj || '';
                    if (opClienteContato) opClienteContato.value = empresa.contato || empresa.responsavel || '';
                    if (opClienteFone) opClienteFone.value = empresa.telefone || '';
                    if (opClienteEmail) opClienteEmail.value = empresa.email || '';
                }
                
                // Preencher produtos na tabela
                if (itens && itens.length > 0) {
                    // Limpar e popular o array produtosOP
                    produtosOP = itens.map(item => ({
                        codigo: item.codigo || '',
                        descricao: item.descricao || item.produto || '',
                        embalagem: item.embalagem || '',
                        lances: item.lances || '',
                        quantidade: parseFloat(item.quantidade) || 1,
                        valor_unitario: parseFloat(item.preco_unitario) || 0,
                        total: parseFloat(item.total) || (parseFloat(item.preco_unitario) * parseFloat(item.quantidade)) || 0
                    }));
                    
                    // Usar função padrão para renderizar a tabela com campos editáveis
                    atualizarTabelaProdutosOP();
                }
                
                // Preencher condições de pagamento (se houver no pedido)
                if (pedido.condicoes_pagamento) {
                    const opCondicoesPagamento = document.getElementById('op-condicoes-pagamento');
                    if (opCondicoesPagamento) opCondicoesPagamento.value = pedido.condicoes_pagamento;
                }
                
                // Preencher observações (se houver descrição do pedido)
                if (pedido.descricao) {
                    const opObservacoes = document.getElementById('op-observacoes');
                    if (opObservacoes) opObservacoes.value = `Pedido #${pedidoId}\n\n${pedido.descricao}`;
                }
                
                // Abrir na aba da Transportadora (que precisa ser preenchida)
                switchOPTab('transportadora');
                
                // Abrir modal
                showModal('modal-nova-ordem');
                
                showNotification('Dados do pedido carregados! Complete os dados da transportadora.', 'success');
                
            } catch (error) {
                console.error('Erro ao carregar pedido:', error);
                showNotification('Erro ao carregar dados do pedido: ' + error.message, 'error');
            }
        }

        // Função placeholder para carregar dados
        async function loadDashboardData() {
            console.log('Loading dashboard data...');
            
            // Carregar contadores do dashboard
            try {
                const response = await fetch('/api/pcp/dashboard', {
                    credentials: 'include'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('Dashboard data:', data);
                    
                    // Atualizar contadores
                    const statProdutos = document.getElementById('stat-produtos');
                    const statOrdens = document.getElementById('stat-ordens');
                    const statEstoqueBaixo = document.getElementById('stat-estoque-baixo');
                    const statEntregas = document.getElementById('stat-entregas');
                    
                    if (statProdutos) statProdutos.textContent = data.totalProdutos || 0;
                    if (statOrdens) statOrdens.textContent = data.ordensEmProducao || 0;
                    if (statEstoqueBaixo) statEstoqueBaixo.textContent = data.estoqueBaixo || 0;
                    if (statEntregas) statEntregas.textContent = data.entregasPendentes || 0;
                } else {
                    console.warn('Erro ao carregar dashboard:', response.status);
                }
            } catch (error) {
                console.error('Erro ao carregar contadores:', error);
            }
            
            // Gerar número da OP automaticamente
            gerarNumeroOP();
            // Carregar Ordens Recentes do Vendas
            carregarOrdensRecentes();
        }

        // Gerar número da OP
        function gerarNumeroOP() {
            const ano = new Date().getFullYear();
            const numero = String(Math.floor(Math.random() * 99999) + 1).padStart(5, '0');
            const inputNumero = document.getElementById('op-numero');
            if (inputNumero) {
                inputNumero.value = `OP Nº ${ano}/${numero}`;
            }
        }

        // Criar Ordem de Produção
        async function criarOrdemProducao(event) {
            event.preventDefault();
            
            const dados = {
                numero: document.getElementById('op-numero')?.value,
                dataConclusao: document.getElementById('op-data-conclusao')?.value,
                codigoProduto: document.getElementById('op-codigo-produto')?.value,
                nomeProduto: document.getElementById('op-nome-produto')?.value,
                descricao: document.getElementById('op-descricao')?.value,
                quantidade: document.getElementById('op-quantidade')?.value,
                unidade: document.getElementById('op-unidade')?.value,
                prioridade: document.getElementById('op-prioridade')?.value,
                responsavel: document.getElementById('op-responsavel')?.value,
                observacoes: document.getElementById('op-observacoes')?.value,
                status: 'a_produzir'
            };

            try {
                const response = await fetch('/api/pcp/ordens', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(dados)
                });

                if (response.ok) {
                    showNotification('Ordem de Produção criada com sucesso!', 'success');
                    hideModal('modal-nova-ordem');
                    // Limpar formulário
                    document.getElementById('form-nova-ordem')?.reset();
                    gerarNumeroOP();
                    // Recarregar dados
                    loadDashboardData();
                } else {
                    const error = await response.json();
                    showNotification(error.message || 'Erro ao criar ordem de Produção', 'error');
                }
            } catch (error) {
                console.error('Erro:', error);
                // Salvar localmente se API Não disponível
                const ordensLocais = JSON.parse(localStorage.getItem('ordensProducao') || '[]');
                dados.id = Date.now();
                ordensLocais.push(dados);
                localStorage.setItem('ordensProducao', JSON.stringify(ordensLocais));
                showNotification('Ordem de Produção salva localmente!', 'success');
                hideModal('modal-nova-ordem');
                document.getElementById('form-nova-ordem')?.reset();
                gerarNumeroOP();
            }
        }
    </script>
    
    <!-- Sistema de Confirmação Modal -->
    <script src="js/confirm-modal.js?v=20251223"></script>
    
    <!-- Sistema de Monitoramento de Conexão -->
    <script src="../_shared/connection-monitor.js?v=20251223"></script>
    `n</body>
</html>



