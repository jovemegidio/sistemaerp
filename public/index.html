<!DOCTYPE html>
<html lang="pt-br">
<head>
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>ALUFORCE: Painel de Controle </title>
    
    
    <!-- Fonte Poppins para Flat Design -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    
    <!-- Configuração do Sistema (GitHub Pages / Railway) -->
    <script src="js/config.js"></script>
    <script src="js/responsive-loader.js"></script>
    
    <script>
    // Função para configurar avatar
    function setupAvatar(firstName, email, avatarElement) {
        if (!avatarElement) return;
        
        // Tenta usar a primeira letra do nome como fallback
        var initials = firstName ? firstName.substring(0, 1).toUpperCase() : 'U';
        avatarElement.textContent = initials;
        
        // Determinar nome do arquivo do avatar baseado no email ou nome
        let avatarFileName = '';
        
        // Mapeamento especial para nomes de arquivo de avatar baseado no email
        if (email) {
            const emailUser = email.split('@')[0].toLowerCase();
            const emailAvatarMap = {
                'ti': 'TI',
                'tialuforce': 'TI',
                'antonio': 'Antonio',
                'clemerson': 'Clemerson',
                'isabela': 'Isabela',
                'thaina': 'Thaina',
                'thiago': 'Thiago',
                'nicolas': 'NicolasDaniel',
                'nicolasdaniel': 'NicolasDaniel',
                'admin': 'admin',
                'joao': 'joao',
                'maria': 'maria',
                'rh': 'Rh',
                'andreia': 'Andreia',
                'guilherme': 'Guilherme',
                'clemerson.silva': 'Clemerson',
                'thaina.souza': 'Thaina'
            };
            
            avatarFileName = emailAvatarMap[emailUser] || firstName;
        } else {
            avatarFileName = firstName;
        }
        
        const avatarFormats = ['webp', 'svg', 'jpg', 'png'];
        let formatIndex = 0;
        
        function tryNextFormat() {
            if (formatIndex >= avatarFormats.length) {
                return;
            }
            
            const format = avatarFormats[formatIndex];
            const avatarPath = `/avatars/${avatarFileName}.${format}`;
            
            const img = new Image();
            img.onload = function() {
                avatarElement.innerHTML = `<img src="${avatarPath}" alt="${firstName}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">`;
            };
            img.onerror = function() {
                formatIndex++;
                tryNextFormat();
            };
            img.src = avatarPath;
        }
        
        tryNextFormat();
    }
    
    // Função para configurar dropdown do usuário
    function setupUserDropdown(firstName, email) {
        var dropdownName = document.querySelector('.dropdown-user-name');
        var dropdownEmail = document.querySelector('.dropdown-user-email');
        
        if (dropdownName) dropdownName.textContent = firstName || 'Usuário';
        if (dropdownEmail) dropdownEmail.textContent = email || '';
    }

    // Verificação de autenticação obrigatória via cookie
    document.addEventListener('DOMContentLoaded', async function() {
        const dashboard = document.getElementById('dashboard-area');
        try {
            const resp = await fetch('/api/me', { credentials: 'include' });
            if (!resp.ok) throw new Error('Não autenticado');
            const user = await resp.json();
            if (dashboard) dashboard.style.display = 'block';
            // Salva dados do usuário localmente para personalização
            localStorage.setItem('userData', JSON.stringify(user));
            // Update UI immediately with authenticated user
            if (typeof updateUserUI === 'function') updateUserUI(user);
        } catch (e) {
            // Redirecionar para a tela de login se não autenticado
            console.log('🔥”’ Não autenticado - redirecionando para login...');
            localStorage.removeItem('userData');
            localStorage.removeItem('authToken');
            sessionStorage.removeItem('userData');
            sessionStorage.removeItem('authToken');
            window.location.href = '/login.html';
        }
    });

    // Update UI function to apply user data to greeting, avatar and dropdown
    function updateUserUI(user) {
        try {
            if (!user) return;
            
            // Get existing userData from localStorage to preserve fields
            let existingData = null;
            try {
                const stored = localStorage.getItem('userData');
                if (stored) existingData = JSON.parse(stored);
            } catch (e) {}
            
            // Merge new data with existing data (preserve existing fields)
            const mergedUser = Object.assign({}, existingData, user);
            
            // Save merged data to localStorage
            localStorage.setItem('userData', JSON.stringify(mergedUser));
            
            // Extract name - try multiple fields
            const fullName = mergedUser.nome || mergedUser.nome_completo || mergedUser.email || 'Usuário';
            const firstName = fullName.split(' ')[0] || 'Usuário';
            const displayName = mergedUser.apelido || firstName;
            
            // Update greeting premium (usa apelido se disponível)
            const greetingName = document.getElementById('greeting-name');
            if (greetingName) greetingName.textContent = displayName;
            
            // Inicializar saudação premium
            if (typeof initPremiumGreeting === 'function') initPremiumGreeting();
            
            // Update user name in header
            const userName = document.querySelector('.user-name');
            if (userName) userName.textContent = displayName;
            
            // Setup avatar (header e dropdown)
            const userAvatar = document.querySelector('.user-avatar-header');
            const dropdownAvatar = document.querySelector('.dropdown-avatar');
            
            if (userAvatar) setupAvatar(firstName, mergedUser.email, userAvatar);
            if (dropdownAvatar) setupAvatar(firstName, mergedUser.email, dropdownAvatar);
            
            // Setup dropdown
            setupUserDropdown(firstName, mergedUser.email || '');
            
            // Aplicar permissões de acesso aos módulos
            applyModulePermissions(mergedUser);
        } catch (err) { 
            console.error('updateUserUI error', err); 
        }
    }
    
    // Função para aplicar permissões aos módulos
    function applyModulePermissions(user) {
        if (!user) {
            console.log('âš ï¸ Nenhum usuário fornecido para applyModulePermissions');
            return;
        }
        
        console.log('🔥” DEBUG - Dados do usuário:', user);
        
        // Mapear áreas permitidas
        let allowedAreas = user.permissoes || user.areas || [];
        
        // Se permissoes for string JSON, parse
        if (typeof allowedAreas === 'string') {
            try {
                allowedAreas = JSON.parse(allowedAreas);
            } catch (e) {
                console.error('Erro ao parsear permissoes:', e);
                allowedAreas = [];
            }
        }
        
        // Garantir que é array
        if (!Array.isArray(allowedAreas)) {
            allowedAreas = [];
        }
        
        // Verificação aprimorada de admin (múltiplos campos possíveis)
        const isAdmin = user.is_admin === 1 || 
                       user.is_admin === true || 
                       user.is_admin === '1' ||
                       user.admin === 1 ||
                       user.admin === true ||
                       user.role === 'admin' ||
                       user.role === 'administrador';
        
        console.log('🔥” DEBUG - Áreas permitidas:', allowedAreas);
        console.log('🔥” DEBUG - Á‰ admin?', isAdmin);
        console.log('🔥” DEBUG - user.is_admin:', user.is_admin);
        console.log('🔥” DEBUG - user.admin:', user.admin);
        console.log('🔥” DEBUG - user.role:', user.role);
        
        // Se for admin, permite tudo
        if (isAdmin) {
            console.log('🔥‘‘ Usuário é administrador - acesso total liberado');
            // Mostrar todos os cards
            document.querySelectorAll('.module-card').forEach(card => {
                card.style.display = '';
                card.style.opacity = '1';
            });
            return;
        }
        
        // Lista de todos os módulos possíveis
        const allModules = {
            'compras': '.compras-card',
            'nfe': '.nfe-card',
            'vendas': '.vendas-card',
            'pcp': '.pcp-card',
            'financeiro': '.financeiro-card',
            'rh': '.rh-card',
            'ti': '.ti-card'
        };
        
        // Ocultar módulos não permitidos
        let visibleCount = 0;
        for (const [area, selector] of Object.entries(allModules)) {
            const moduleCard = document.querySelector(selector);
            if (moduleCard) {
                const hasAccess = allowedAreas.includes(area);
                console.log(`🔥” Módulo ${area}: ${hasAccess ? '✅ PERMITIDO' : 'âŒ BLOQUEADO'}`);
                
                if (hasAccess) {
                    moduleCard.style.display = '';
                    moduleCard.style.opacity = '1';
                    visibleCount++;
                } else {
                    moduleCard.style.display = 'none';
                }
            }
        }
        
        console.log(`✅ Total de módulos visíveis: ${visibleCount}/${Object.keys(allModules).length}`);
    }
    </script>
    <!-- Favicon -->
    
    
    
    
    
    <!-- CSS Crítico - Carrega primeiro -->
    <link rel="stylesheet" href="css/style.css?v=2025010320">
    <link rel="stylesheet" href="css/flat-design.css?v=2025010320">
    <link rel="stylesheet" href="css/cards-solid.css?v=2025010320">
    <link rel="stylesheet" href="css/backgrounds.css?v=2025010320">
    <link rel="stylesheet" href="css/greeting-premium.css?v=2025010320">
    
    <!-- Font Awesome - Carregamento Crítico para Ícones -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" crossorigin="anonymous">
    
    <!-- CSS Secundário - Carregamento Diferido -->
    <link rel="stylesheet" href="css/modal-configuracoes.css?v=2026010301">
    <link rel="stylesheet" href="css/config-modals.css?v=2025010320">
    <link rel="stylesheet" href="css/config-modals-professional.css?v=2025010320">
    <link rel="stylesheet" href="css/notifications-panel.css?v=2025010320">
    <link rel="stylesheet" href="css/profile-modal-modern.css?v=2025010320" media="print" onload="this.media='all'">
    <link rel="stylesheet" href="css/omie-settings.css" media="print" onload="this.media='all'">
    <link rel="stylesheet" href="css/preferences-modal.css" media="print" onload="this.media='all'">
    <link rel="stylesheet" href="css/chat-widget.css?v=2025010320" media="print" onload="this.media='all'">
    <link rel="stylesheet" href="css/preferences-modal-v3.css?v=2025010320" media="print" onload="this.media='all'">
    <link rel="stylesheet" href="css/kpis-executivo.css?v=2025010320" media="print" onload="this.media='all'">
    
    <!-- CSS Responsivo Global -->
    <link rel="stylesheet" href="css/responsive.css?v=2026010401">
    
    <!-- JavaScript Essencial -->
    <script src="js/permissions.js" defer></script>
    <script src="js/background-manager.js" defer></script>
    
    <!-- JavaScript Não-Crítico - Carregamento Diferido -->
    <script src="js/chat-widget.js?v=20251208autologin" defer></script>
    <script src="js/profile-manager.js" defer></script>
    <script src="js/admin-permissions.js" defer></script>
    <script src="js/omie-settings.js" defer></script>
    <script src="js/preferences-manager.js" defer></script>
    <script src="js/company-settings.js" defer></script>
    <script src="js/header-controls.js" defer></script>
    <script src="js/profile-modal.js" defer></script>
    <script src="js/confirm-modal.js" defer></script>
    <script src="js/notifications-manager.js" defer></script>
    <script src="js/config-modals.js" defer></script>
    <script src="js/greeting-premium.js?v=2025121601" defer></script>
    <script src="js/kpis-executivo.js?v=2025121901" defer></script>
    <script src="js/anti-copy-protection.js"></script>
    <link rel="stylesheet" href="css/popup-confirmacao.css">`n</head>
<body>
    <div id="notification-area" style="position:fixed;top:20px;right:20px;z-index:1000;max-width:320px;"></div>
    
    <!-- Profile Modal -->
    <div id="profile-modal" class="profile-modal" aria-hidden="true">
        <div class="profile-modal-card">
            <div class="profile-modal-header">
                <h3>Meu Perfil</h3>
                <button id="profile-modal-close" class="profile-modal-close" aria-label="Fechar">&times;</button>
            </div>
            <form id="profile-form" class="profile-modal-body">
                <!-- Avatar Section -->
                <div class="profile-avatar-section">
                    <div class="profile-avatar-wrapper">
                        <div class="profile-avatar-preview" onclick="document.getElementById('profile-avatar-input').click()">
                            <img id="profile-avatar-img" src="avatars/default.webp" alt="Avatar" onerror="this.onerror=null; this.style.display='none'; this.nextElementSibling.style.display='flex';">
                            <div class="profile-avatar-fallback" style="display:none;">
                                <i class="fas fa-user"></i>
                            </div>
                            <div class="profile-avatar-overlay">
                                <i class="fas fa-camera"></i>
                                <span>Alterar</span>
                            </div>
                        </div>
                        <input type="file" id="profile-avatar-input" accept="image/jpeg,image/png,image/gif,image/webp" style="display: none;">
                        <button type="button" id="profile-avatar-btn" class="btn-avatar-upload">
                            <i class="fas fa-camera"></i> Escolher Foto
                        </button>
                        <div class="profile-avatar-info">
                            <small>JPG, PNG, GIF ou WEBP (Máx: 2MB)</small>
                        </div>
                    </div>
                </div>

                <!-- Personal Info Section -->
                <div class="profile-section">
                    <h4 class="profile-section-title">
                        <i class="fas fa-user-circle"></i> Informações Pessoais
                    </h4>
                    <div class="profile-row">
                        <div class="profile-col">
                            <label>E-mail <span class="required">*</span></label>
                            <input id="profile-email" type="email" readonly />
                        </div>
                        <div class="profile-col">
                            <label>Nome Completo <span class="required">*</span></label>
                            <input id="profile-nome" type="text" required placeholder="Seu nome completo" />
                        </div>
                    </div>
                    <div class="profile-row">
                        <div class="profile-col">
                            <label>Apelido</label>
                            <input id="profile-apelido" type="text" placeholder="Como gosta de ser chamado" />
                        </div>
                        <div class="profile-col">
                            <label>Telefone</label>
                            <input id="profile-telefone" type="tel" placeholder="(00) 00000-0000" />
                        </div>
                    </div>
                    <div class="profile-row">
                        <div class="profile-col">
                            <label>Data de Nascimento</label>
                            <input id="profile-data-nascimento" type="date" />
                        </div>
                        <div class="profile-col">
                            <label>Departamento</label>
                            <input id="profile-departamento" type="text" readonly placeholder="Seu departamento" />
                        </div>
                    </div>
                </div>

                <!-- Additional Info Section -->
                <div class="profile-section">
                    <h4 class="profile-section-title">
                        <i class="fas fa-info-circle"></i> Informações Adicionais
                    </h4>
                    <div class="profile-row">
                        <div class="profile-col full">
                            <label>Bio / Notas</label>
                            <textarea id="profile-bio" rows="3" placeholder="Conte um pouco sobre você, suas habilidades e experiências..."></textarea>
                        </div>
                    </div>
                </div>

                <!-- Security Section -->
                <div class="profile-section">
                    <h4 class="profile-section-title">
                        <i class="fas fa-shield-alt"></i> Segurança
                    </h4>
                    <div class="profile-row">
                        <div class="profile-col full">
                            <button type="button" id="profile-change-password" class="btn-secondary btn-security">
                                <i class="fas fa-key"></i> Alterar Senha
                            </button>
                        </div>
                    </div>
                </div>

                <div class="profile-actions">
                    <button type="button" id="profile-cancel" class="btn-ghost">
                        <i class="fas fa-times"></i> Cancelar
                    </button>
                    <button type="button" id="profile-save" class="btn-primary">
                        <i class="fas fa-check"></i> Salvar Alterações
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Preferences Modal (Para todos os usuários) -->
    <div id="preferences-modal" class="settings-modal" aria-hidden="true">
        <div class="settings-modal-card preferences-modal">
            <div class="settings-modal-header">
                <div class="pref-search-wrapper">
                    <span class="pref-search-icon"><i class="fas fa-cog"></i></span>
                    <input type="text" class="pref-search-input" placeholder="Buscar configuração..." id="pref-search">
                </div>
                <button id="preferences-modal-close" class="settings-modal-close" aria-label="Fechar">&times;</button>
            </div>
            <div class="settings-modal-body">
                <!-- Aparência -->
                <div class="settings-section">
                    <h4 class="settings-section-title">
                        <i class="fas fa-palette"></i> Aparência
                    </h4>
                    <div class="settings-items-container">
                        <div class="settings-item">
                            <div class="settings-item-info">
                                <div class="settings-item-label">Modo Escuro</div>
                                <div class="settings-item-description">Alterna entre tema claro e escuro</div>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" id="setting-dark-mode">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        <div class="settings-item">
                            <div class="settings-item-info">
                                <div class="settings-item-label">Tamanho da Fonte</div>
                                <div class="settings-item-description">Ajuste o tamanho do texto do sistema</div>
                            </div>
                            <select class="settings-select" id="setting-font-size">
                                <option value="small">Pequeno (90%)</option>
                                <option value="medium" selected>Médio (100%)</option>
                                <option value="large">Grande (110%)</option>
                                <option value="xlarge">Extra Grande (120%)</option>
                            </select>
                        </div>
                        <div class="settings-item">
                            <div class="settings-item-info">
                                <div class="settings-item-label">Contraste Automático</div>
                                <div class="settings-item-description">Ajusta texto/ícones conforme o fundo</div>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" id="setting-auto-contrast" checked>
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Notificações -->
                <div class="settings-section">
                    <h4 class="settings-section-title">
                        <i class="fas fa-bell"></i> Notificações
                    </h4>
                    <div class="settings-items-container">
                        <div class="settings-item">
                            <div class="settings-item-info">
                                <div class="settings-item-label">Notificações Desktop</div>
                                <div class="settings-item-description">Receba alertas na área de trabalho</div>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" id="setting-desktop-notifications" checked>
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        <div class="settings-item">
                            <div class="settings-item-info">
                                <div class="settings-item-label">Som de Notificação</div>
                                <div class="settings-item-description">Reproduzir som ao receber notificações</div>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" id="setting-notification-sound" checked>
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Sistema -->
                <div class="settings-section">
                    <h4 class="settings-section-title">
                        <i class="fas fa-cog"></i> Sistema
                    </h4>
                    <div class="settings-items-container">
                        <div class="settings-item">
                            <div class="settings-item-info">
                                <div class="settings-item-label">Idioma</div>
                                <div class="settings-item-description">Selecione o idioma do sistema</div>
                            </div>
                            <select class="settings-select" id="setting-language">
                                <option value="pt-BR" selected>Português (Brasil)</option>
                                <option value="en-US">English (US)</option>
                                <option value="es-ES">Español</option>
                            </select>
                        </div>
                        <div class="settings-item">
                            <div class="settings-item-info">
                                <div class="settings-item-label">Atualização Automática</div>
                                <div class="settings-item-description">Verificar atualizações automaticamente</div>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" id="setting-auto-update" checked>
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Performance -->
                <div class="settings-section">
                    <h4 class="settings-section-title">
                        <i class="fas fa-tachometer-alt"></i> Performance
                    </h4>
                    <div class="settings-items-container">
                        <div class="settings-item">
                            <div class="settings-item-info">
                                <div class="settings-item-label">Animações</div>
                                <div class="settings-item-description">Habilitar animações e transições</div>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" id="setting-animations" checked>
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        <div class="settings-item">
                            <div class="settings-item-info">
                                <div class="settings-item-label">Cache Local</div>
                                <div class="settings-item-description">Armazenar dados localmente para melhor desempenho</div>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" id="setting-cache" checked>
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Ações (Hidden - Auto save) -->
                <div class="preferences-actions">
                    <button id="preferences-save" class="btn-primary">
                        <i class="fas fa-save"></i> Salvar Preferências
                    </button>
                    <button id="preferences-reset" class="btn-secondary">
                        <i class="fas fa-undo"></i> Restaurar Padrões
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Dashboard Area (hidden until login) -->
    <div id="dashboard-area" class="dashboard-area" style="display:none;">
        <!-- Header -->
        <header class="main-header" style="background: linear-gradient(135deg, #1a1f2e 0%, #2d3548 100%) !important; backdrop-filter: none !important;">
    <link rel="icon" type="image/x-icon" href="favicon.ico">
            <div class="header-content">
                <div class="header-left">
                    <div class="logo-section">
                        <img src="images/Logo Monocromatico - Branco - Aluforce.png" alt="ALUFORCE" class="header-logo">
                    </div>
                </div>
                <div class="header-right">
                    <div class="header-icons">
                        <button class="header-icon-btn" title="Indicadores do Dia" id="kpis-modal-toggle">
                            <i class="fas fa-chart-pie"></i>
                        </button>
                        <div class="header-search-wrapper">
                            <button class="header-icon-btn" title="Buscar" id="search-btn">
                                <i class="fas fa-search"></i>
                            </button>
                            <div id="header-search-container" class="header-search-container" aria-hidden="true">
                                <input id="header-search-input" type="search" placeholder="O que você deseja pesquisar?" autocomplete="off" />
                                <div id="header-search-results" class="header-search-results" aria-live="polite"></div>
                            </div>
                        </div>
                        <button class="header-icon-btn" title="Configurações" id="settings-btn">
                            <i class="fas fa-cog"></i>
                        </button>
                        <button class="header-icon-btn notification-btn" title="Notificações" id="notifications-btn">
                            <i class="fas fa-bell"></i>
                            <span class="notification-dot">3</span>
                        </button>
                        <button class="header-icon-btn" title="Ajuda" id="help-btn">
                            <i class="fas fa-question-circle"></i>
                        </button>
                        <div class="user-profile-header" id="user-profile">
                            <span class="user-name">Usuário</span>
                            <div class="user-avatar-header">U</div>
                            <!-- Menu Dropdown do Usuário -->
                            <div class="user-dropdown-menu" id="user-dropdown">
                                <div class="dropdown-header">
                                    <div class="dropdown-avatar">U</div>
                                    <div class="dropdown-info">
                                        <span class="dropdown-user-name">Usuário</span>
                                        <span class="dropdown-user-email">usuario@aluforce.ind.br</span>
                                    </div>
                                </div>
                                <hr class="dropdown-divider">
                                <div class="dropdown-options">
                                    <div class="dropdown-item" id="profile-option">
                                        <i class="fas fa-user"></i>
                                        <span>Meu Perfil</span>
                                    </div>
                                    <div class="dropdown-item" id="preferences-option">
                                        <i class="fas fa-sliders-h"></i>
                                        <span>Preferências</span>
                                    </div>
                                    <div class="dropdown-item" id="settings-option" style="display: none;">
                                        <i class="fas fa-cog"></i>
                                        <span>Configurações</span>
                                    </div>
                                    <div class="dropdown-item" id="help-option" style="display: none;">
                                        <i class="fas fa-question-circle"></i>
                                        <span>Ajuda</span>
                                    </div>
                                    <hr class="dropdown-divider">
                                    <div class="dropdown-item logout-item" id="logout-option">
                                        <i class="fas fa-sign-out-alt"></i>
                                        <span>Sair</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="main-dashboard">
            <!-- Greeting Section - Premium -->
            <div class="greeting-section-premium">
                <div class="greeting-date-badge">
                    <i class="fas fa-calendar-alt"></i>
                    <span id="current-date">Carregando...</span>
                </div>
                <div class="greeting-main">
                    <span class="greeting-time-label" id="greeting-time-label">Bom dia</span>
                    <h1 class="greeting-title-premium" id="greeting-name">Usuário</h1>
                </div>
                <p class="greeting-subtitle-premium" id="greeting-message">Pronto para mais um dia produtivo?</p>
                <div class="greeting-stats">
                    <div class="greeting-stat-item">
                        <i class="fas fa-clock"></i>
                        <span id="current-time">--:--</span>
                    </div>
                    <div class="greeting-stat-divider"></div>
                    <div class="greeting-stat-item">
                        <i class="fas fa-building"></i>
                        <span>Aluforce</span>
                    </div>
                </div>
            </div>

            <!-- Modal de KPIs Executivos -->
            <div class="kpis-modal-overlay" id="kpis-modal-overlay" style="display: none;">
                <div class="kpis-modal-container">
                    <div class="kpis-modal-header">
                        <h2 class="kpis-title"><i class="fas fa-chart-pie"></i> Indicadores do Dia</h2>
                        <div class="kpis-modal-actions">
                            <select id="kpis-periodo" class="kpis-periodo-select">
                                <option value="7">Últimos 7 dias</option>
                                <option value="30" selected>Últimos 30 dias</option>
                                <option value="90">Últimos 90 dias</option>
                            </select>
                            <button class="kpis-refresh-btn" onclick="carregarKPIs()" title="Atualizar">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                            <button class="kpis-modal-close" id="kpis-modal-close" title="Fechar">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                
                <!-- Resumo Financeiro -->
                <div class="kpis-resumo-financeiro">
                    <div class="kpi-card kpi-receitas">
                        <div class="kpi-icon"><i class="fas fa-arrow-up"></i></div>
                        <div class="kpi-content">
                            <span class="kpi-label">Receitas</span>
                            <span class="kpi-value" id="kpi-receitas">R$ 0,00</span>
                            <span class="kpi-trend up" id="kpi-receitas-trend">+0%</span>
                        </div>
                    </div>
                    <div class="kpi-card kpi-despesas">
                        <div class="kpi-icon"><i class="fas fa-arrow-down"></i></div>
                        <div class="kpi-content">
                            <span class="kpi-label">Despesas</span>
                            <span class="kpi-value" id="kpi-despesas">R$ 0,00</span>
                            <span class="kpi-trend down" id="kpi-despesas-trend">-0%</span>
                        </div>
                    </div>
                    <div class="kpi-card kpi-lucro">
                        <div class="kpi-icon"><i class="fas fa-balance-scale"></i></div>
                        <div class="kpi-content">
                            <span class="kpi-label">Resultado</span>
                            <span class="kpi-value" id="kpi-lucro">R$ 0,00</span>
                            <span class="kpi-trend" id="kpi-margem">Margem: 0%</span>
                        </div>
                    </div>
                    <div class="kpi-card kpi-faturamento">
                        <div class="kpi-icon"><i class="fas fa-file-invoice-dollar"></i></div>
                        <div class="kpi-content">
                            <span class="kpi-label">Faturado</span>
                            <span class="kpi-value" id="kpi-faturamento">R$ 0,00</span>
                            <span class="kpi-trend" id="kpi-nfes">0 NF-e emitidas</span>
                        </div>
                    </div>
                </div>

                <!-- KPIs por Módulo -->
                <div class="kpis-modulos-grid">
                    <!-- Vendas -->
                    <div class="kpi-modulo-card" data-modulo="vendas">
                        <div class="kpi-modulo-header vendas">
                            <i class="fas fa-chart-line"></i>
                            <span>Vendas</span>
                        </div>
                        <div class="kpi-modulo-body">
                            <div class="kpi-mini"><span class="kpi-mini-value" id="kpi-vendas-pedidos">0</span><span class="kpi-mini-label">Pedidos</span></div>
                            <div class="kpi-mini"><span class="kpi-mini-value" id="kpi-vendas-conversao">0%</span><span class="kpi-mini-label">Conversão</span></div>
                            <div class="kpi-mini"><span class="kpi-mini-value" id="kpi-vendas-ticket">R$ 0</span><span class="kpi-mini-label">Ticket Médio</span></div>
                        </div>
                    </div>
                    
                    <!-- Compras -->
                    <div class="kpi-modulo-card" data-modulo="compras">
                        <div class="kpi-modulo-header compras">
                            <i class="fas fa-shopping-bag"></i>
                            <span>Compras</span>
                        </div>
                        <div class="kpi-modulo-body">
                            <div class="kpi-mini"><span class="kpi-mini-value" id="kpi-compras-pedidos">0</span><span class="kpi-mini-label">Pedidos</span></div>
                            <div class="kpi-mini"><span class="kpi-mini-value" id="kpi-compras-pendentes">0</span><span class="kpi-mini-label">Pendentes</span></div>
                            <div class="kpi-mini"><span class="kpi-mini-value" id="kpi-compras-economia">R$ 0</span><span class="kpi-mini-label">Economia</span></div>
                        </div>
                    </div>
                    
                    <!-- Produção -->
                    <div class="kpi-modulo-card" data-modulo="pcp">
                        <div class="kpi-modulo-header pcp">
                            <i class="fas fa-industry"></i>
                            <span>Produção</span>
                        </div>
                        <div class="kpi-modulo-body">
                            <div class="kpi-mini"><span class="kpi-mini-value" id="kpi-pcp-ordens">0</span><span class="kpi-mini-label">Ordens</span></div>
                            <div class="kpi-mini"><span class="kpi-mini-value" id="kpi-pcp-eficiencia">0%</span><span class="kpi-mini-label">Eficiência</span></div>
                            <div class="kpi-mini"><span class="kpi-mini-value" id="kpi-pcp-estoque">0</span><span class="kpi-mini-label">Alertas Estoque</span></div>
                        </div>
                    </div>
                    
                    <!-- RH -->
                    <div class="kpi-modulo-card" data-modulo="rh">
                        <div class="kpi-modulo-header rh">
                            <i class="fas fa-user-tie"></i>
                            <span>RH</span>
                        </div>
                        <div class="kpi-modulo-body">
                            <div class="kpi-mini"><span class="kpi-mini-value" id="kpi-rh-funcionarios">0</span><span class="kpi-mini-label">Funcionários</span></div>
                            <div class="kpi-mini"><span class="kpi-mini-value" id="kpi-rh-ferias">0</span><span class="kpi-mini-label">Em Férias</span></div>
                            <div class="kpi-mini"><span class="kpi-mini-value" id="kpi-rh-aniversarios">0</span><span class="kpi-mini-label">Aniversários</span></div>
                        </div>
                    </div>
                </div>

                    <!-- Alertas -->
                    <div class="kpis-alertas" id="kpis-alertas">
                        <!-- Alertas serão inseridos via JavaScript -->
                    </div>
                </div>
            </div>

            <!-- Modules Grid -->
            <div class="modules-container">
                <div class="modules-grid">
                <a href="modules/Compras/index.html" class="module-card compras-card" data-area="compras">
                    <div class="module-icon">
                        <i class="fas fa-shopping-cart"></i>
                    </div>
                    <div class="module-text">
                        <span class="module-title">Compras</span>
                        <span class="module-desc">Gestão de pedidos e fornecedores</span>
                    </div>
                </a>
                <a href="modules/Vendas/index.html" class="module-card vendas-card" data-area="vendas">
                    <div class="module-icon">
                        <i class="fas fa-store"></i>
                    </div>
                    <div class="module-text">
                        <span class="module-title">Vendas</span>
                        <span class="module-desc">Orçamentos e pedidos de venda</span>
                    </div>
                </a>
                <a href="modules/NFe/index.html" class="module-card nfe-card" data-area="nfe">
                    <div class="module-icon">
                        <i class="fas fa-file-invoice"></i>
                    </div>
                    <div class="module-text">
                        <span class="module-title">NF-e & Logística</span>
                        <span class="module-desc">Notas fiscais e expedição</span>
                    </div>
                </a>
                <a href="modules/PCP/index.html" class="module-card pcp-card" data-area="pcp">
                    <div class="module-icon">
                        <i class="fas fa-cogs"></i>
                    </div>
                    <div class="module-text">
                        <span class="module-title">Planejamento e Controle de Produção</span>
                        <span class="module-desc">Gestão da produção industrial</span>
                    </div>
                </a>
                    
                <a href="modules/Financeiro/index.html" class="module-card financeiro-card" data-area="financeiro">
                    <div class="module-icon">
                        <i class="fas fa-dollar-sign"></i>
                    </div>
                    <div class="module-text">
                        <span class="module-title">Financeiro</span>
                        <span class="module-desc">Contas a pagar e receber</span>
                    </div>
                </a>
                    
                <a href="modules/RH/index.html" class="module-card rh-card" data-area="rh">
                    <div class="module-icon">
                        <i class="fas fa-users"></i>
                    </div>
                    <div class="module-text">
                        <span class="module-title">Recursos Humanos</span>
                        <span class="module-desc">Gestão de colaboradores</span>
                    </div>
                </a>
                </div>
            </div>
        </main>
    </div>

    <!-- Scripts externos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="socket.io/socket.io.js"></script>
    
    <!-- Scripts do sistema -->
    <script src="js/background-manager.js"></script>
    <script src="js/header-controls.js"></script>
    <script src="js/admin-permissions.js"></script>
    
    <!-- Carregar modais de forma assíncrona -->
    <script>
        // Flag para indicar que os modais foram carregados
        window.configModalsReady = false;
        
        // Carregar modais base
        fetch('/config-modals.html')
        .then(response => {
            if (!response.ok) throw new Error('Erro ao carregar config-modals.html');
            return response.text();
        })
        .then(html => {
            const container = document.createElement('div');
            container.id = 'config-modals-container';
            container.innerHTML = html;
            document.body.appendChild(container);
            console.log('✅ Modais de configuração carregados');
            
            // Inicializar CompanySettings se disponível
            if (typeof CompanySettings !== 'undefined') {
                CompanySettings.init();
                console.log('✅ CompanySettings inicializado');
            }
            
            window.configModalsReady = true;
        })
        .catch(err => console.error('❌ Erro ao carregar modais:', err));

        // Carregar modais estendidos
        fetch('/config-modals-extended.html')
        .then(response => {
            if (!response.ok) throw new Error('Erro ao carregar config-modals-extended.html');
            return response.text();
        })
        .then(html => {
            const container = document.createElement('div');
            container.id = 'config-modals-extended-container';
            container.innerHTML = html;
            document.body.appendChild(container);
            console.log('✅ Modais estendidos carregados');
        })
        .catch(err => console.error('❌ Erro ao carregar modais estendidos:', err));
    </script>

    <!-- Modal de Configurações do Sistema -->
    <div id="modal-configuracoes" class="modal-config">
        <div class="modal-config-content">
            <!-- Header do Modal -->
            <div class="modal-config-header">
                <div class="modal-config-brand">
                    <img src="images/Logo Monocromatico - Azul - Aluforce.webp" alt="Aluforce" class="modal-config-logo" onerror="this.style.display='none'">
                    <span class="modal-config-title">Configurações do Sistema</span>
                </div>
                <div class="modal-config-search">
                    <i class="fas fa-search"></i>
                    <input type="text" placeholder="Buscar configuração..." id="config-search-input">
                </div>
                <button class="modal-config-settings-btn modal-config-tooltip" data-tooltip="Atalhos" title="Configurações gerais">
                    <i class="fas fa-cog"></i>
                </button>
                <button class="modal-config-close modal-config-tooltip" data-tooltip="Fechar (ESC)" id="btn-fechar-config" title="Fechar">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <!-- Abas de navegação -->
            <div class="modal-config-tabs">
                <button class="modal-config-tab active" data-tab="principais">Principais</button>
                <button class="modal-config-tab" data-tab="recursos-humanos">Recursos Humanos</button>
                <button class="modal-config-tab" data-tab="financas">Finanças</button>
                <button class="modal-config-tab" data-tab="clientes-fornecedores">Clientes e Fornecedores</button>
                <button class="modal-config-tab" data-tab="venda-produtos">Venda de Produtos</button>
                <button class="modal-config-tab" data-tab="venda-servicos">Venda de Serviços</button>
            </div>

            <!-- Conteúdo das Abas -->
            <div class="modal-config-body">
                <!-- Aba Principais -->
                <div class="modal-config-tab-content active" id="tab-principais">
                    <div class="modal-config-grid">
                        <div class="modal-config-card" onclick="abrirConfiguracao('empresa')" tabindex="0">
                            <div class="modal-config-card-icon blue">
                                <i class="fas fa-building"></i>
                            </div>
                            <div class="modal-config-card-content">
                                <h3>Dados da Minha Empresa</h3>
                                <p class="modal-config-card-subtitle">Informações cadastrais e dados fiscais</p>
                            </div>
                        </div>

                        <div class="modal-config-card" onclick="abrirConfiguracao('categorias')" tabindex="0">
                            <div class="modal-config-card-icon blue">
                                <i class="fas fa-folder"></i>
                            </div>
                            <div class="modal-config-card-content">
                                <h3>Categorias</h3>
                                <p class="modal-config-card-subtitle">Organize produtos e serviços por categoria</p>
                            </div>
                        </div>

                        <div class="modal-config-card" onclick="abrirConfiguracao('departamentos')" tabindex="0">
                            <div class="modal-config-card-icon blue">
                                <i class="fas fa-sitemap"></i>
                            </div>
                            <div class="modal-config-card-content">
                                <h3>Departamentos</h3>
                                <p class="modal-config-card-subtitle">Estrutura organizacional da empresa</p>
                            </div>
                        </div>

                        <div class="modal-config-card" onclick="abrirConfiguracao('projetos')" tabindex="0">
                            <div class="modal-config-card-icon blue">
                                <i class="fas fa-project-diagram"></i>
                            </div>
                            <div class="modal-config-card-content">
                                <h3>Projetos</h3>
                                <p class="modal-config-card-subtitle">Gestão e acompanhamento de projetos</p>
                            </div>
                        </div>

                        <div class="modal-config-card" onclick="abrirConfiguracao('certificado-digital')" tabindex="0">
                            <div class="modal-config-card-icon red">
                                <i class="fas fa-certificate"></i>
                            </div>
                            <div class="modal-config-card-content">
                                <h3>Certificado Digital (Modelo A1)</h3>
                                <p class="modal-config-card-subtitle">Upload e validação do certificado</p>
                            </div>
                        </div>

                        <div class="modal-config-card" onclick="abrirConfiguracao('importacao-nfe')" tabindex="0">
                            <div class="modal-config-card-icon teal">
                                <i class="fas fa-file-invoice"></i>
                            </div>
                            <div class="modal-config-card-content">
                                <h3>Importação da NF-e do Fornecedor</h3>
                                <p class="modal-config-card-subtitle">Configurações de importação automática</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Aba Recursos Humanos -->
                <div class="modal-config-tab-content" id="tab-recursos-humanos">
                    <div class="modal-config-grid">
                        <div class="modal-config-card" onclick="abrirConfiguracao('funcionarios')">
                            <div class="modal-config-card-icon green">
                                <i class="fas fa-users"></i>
                            </div>
                            <div class="modal-config-card-content">
                                <h3>Gestão de Funcionários</h3>
                                <p class="modal-config-card-subtitle">Cadastro e gerenciamento de colaboradores</p>
                            </div>
                        </div>

                        <div class="modal-config-card" onclick="abrirConfiguracao('cargos')">
                            <div class="modal-config-card-icon green">
                                <i class="fas fa-id-badge"></i>
                            </div>
                            <div class="modal-config-card-content">
                                <h3>Cargos e Funções</h3>
                                <p class="modal-config-card-subtitle">Definir hierarquia organizacional</p>
                            </div>
                        </div>

                        <div class="modal-config-card" onclick="abrirConfiguracao('folha-pagamento')">
                            <div class="modal-config-card-icon green">
                                <i class="fas fa-money-check-alt"></i>
                            </div>
                            <div class="modal-config-card-content">
                                <h3>Folha de Pagamento</h3>
                                <p class="modal-config-card-subtitle">Configurações de salários e benefícios</p>
                            </div>
                        </div>

                        <div class="modal-config-card" onclick="abrirConfiguracao('ponto-eletronico')">
                            <div class="modal-config-card-icon green">
                                <i class="fas fa-clock"></i>
                            </div>
                            <div class="modal-config-card-content">
                                <h3>Ponto Eletrônico</h3>
                                <p class="modal-config-card-subtitle">Controle de jornada de trabalho</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Aba Finanças -->
                <div class="modal-config-tab-content" id="tab-financas">
                    <div class="modal-config-grid">
                        <div class="modal-config-card" onclick="abrirConfiguracao('financas')">
                            <div class="modal-config-card-icon orange">
                                <i class="fas fa-dollar-sign"></i>
                            </div>
                            <div class="modal-config-card-content">
                                <h3>Configurações Gerais</h3>
                                <p class="modal-config-card-subtitle">Juros, multas e cobrança</p>
                            </div>
                        </div>

                        <div class="modal-config-card" onclick="abrirConfiguracao('plano-contas')">
                            <div class="modal-config-card-icon orange">
                                <i class="fas fa-list-alt"></i>
                            </div>
                            <div class="modal-config-card-content">
                                <h3>Plano de Contas</h3>
                                <p class="modal-config-card-subtitle">Estrutura contábil da empresa</p>
                            </div>
                        </div>

                        <div class="modal-config-card" onclick="abrirConfiguracao('contas-bancarias')">
                            <div class="modal-config-card-icon orange">
                                <i class="fas fa-university"></i>
                            </div>
                            <div class="modal-config-card-content">
                                <h3>Contas Bancárias</h3>
                                <p class="modal-config-card-subtitle">Gestão de contas e conciliação</p>
                            </div>
                        </div>

                        <div class="modal-config-card" onclick="abrirConfiguracao('formas-pagamento')">
                            <div class="modal-config-card-icon orange">
                                <i class="fas fa-credit-card"></i>
                            </div>
                            <div class="modal-config-card-content">
                                <h3>Formas de Pagamento</h3>
                                <p class="modal-config-card-subtitle">Configurar métodos de pagamento</p>
                            </div>
                        </div>

                        <div class="modal-config-card" onclick="abrirConfiguracao('impostos')">
                            <div class="modal-config-card-icon orange">
                                <i class="fas fa-percent"></i>
                            </div>
                            <div class="modal-config-card-content">
                                <h3>Configuração de Impostos</h3>
                                <p class="modal-config-card-subtitle">Alíquotas e regimes tributários</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Aba Clientes e Fornecedores -->
                <div class="modal-config-tab-content" id="tab-clientes-fornecedores">
                    <div class="modal-config-grid">
                        <div class="modal-config-card" onclick="abrirConfiguracao('clientes-fornecedores')">
                            <div class="modal-config-card-icon purple">
                                <i class="fas fa-cogs"></i>
                            </div>
                            <div class="modal-config-card-content">
                                <h3>Configurações Gerais</h3>
                                <p class="modal-config-card-subtitle">Validações, crédito e tags</p>
                            </div>
                        </div>

                        <div class="modal-config-card" onclick="abrirConfiguracao('grupos-clientes')">
                            <div class="modal-config-card-icon purple">
                                <i class="fas fa-layer-group"></i>
                            </div>
                            <div class="modal-config-card-content">
                                <h3>Grupos de Clientes</h3>
                                <p class="modal-config-card-subtitle">Segmentação de clientes</p>
                            </div>
                        </div>

                        <div class="modal-config-card" onclick="abrirConfiguracao('regioes-venda')">
                            <div class="modal-config-card-icon purple">
                                <i class="fas fa-map-marked-alt"></i>
                            </div>
                            <div class="modal-config-card-content">
                                <h3>Regiões de Venda</h3>
                                <p class="modal-config-card-subtitle">Territórios e áreas de atuação</p>
                            </div>
                        </div>

                        <div class="modal-config-card" onclick="abrirConfiguracao('tipos-fornecedor')">
                            <div class="modal-config-card-icon purple">
                                <i class="fas fa-truck"></i>
                            </div>
                            <div class="modal-config-card-content">
                                <h3>Tipos de Fornecedor</h3>
                                <p class="modal-config-card-subtitle">Categorização de fornecedores</p>
                            </div>
                        </div>

                        <div class="modal-config-card" onclick="abrirConfiguracao('condicoes-pagamento')">
                            <div class="modal-config-card-icon purple">
                                <i class="fas fa-handshake"></i>
                            </div>
                            <div class="modal-config-card-content">
                                <h3>Condições de Pagamento</h3>
                                <p class="modal-config-card-subtitle">Prazos e condições comerciais</p>
                            </div>
                        </div>

                        <div class="modal-config-card" onclick="abrirConfiguracao('compradores')">
                            <div class="modal-config-card-icon purple">
                                <i class="fas fa-shopping-cart"></i>
                            </div>
                            <div class="modal-config-card-content">
                                <h3>Compradores</h3>
                                <p class="modal-config-card-subtitle">Equipe de compras e suprimentos</p>
                            </div>
                        </div>

                        <div class="modal-config-card" onclick="abrirConfiguracao('clientes-fornecedores')">
                            <div class="modal-config-card-icon purple">
                                <i class="fas fa-cog"></i>
                            </div>
                            <div class="modal-config-card-content">
                                <h3>Configurações Gerais</h3>
                                <p class="modal-config-card-subtitle">Validações e controles</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Aba Venda de Produtos -->
                <div class="modal-config-tab-content" id="tab-venda-produtos">
                    <div class="modal-config-grid">
                        <div class="modal-config-card" onclick="abrirConfiguracao('venda-produtos')">
                            <div class="modal-config-card-icon teal">
                                <i class="fas fa-cogs"></i>
                            </div>
                            <div class="modal-config-card-content">
                                <h3>Configurações Gerais</h3>
                                <p class="modal-config-card-subtitle">Etapas, preços e estoque</p>
                            </div>
                        </div>

                        <div class="modal-config-card" onclick="abrirConfiguracao('familias-produtos')">
                            <div class="modal-config-card-icon teal">
                                <i class="fas fa-boxes"></i>
                            </div>
                            <div class="modal-config-card-content">
                                <h3>Famílias de Produtos</h3>
                                <p class="modal-config-card-subtitle">Organização por categorias</p>
                            </div>
                        </div>

                        <div class="modal-config-card" onclick="abrirConfiguracao('caracteristicas-produtos')">
                            <div class="modal-config-card-icon teal">
                                <i class="fas fa-tags"></i>
                            </div>
                            <div class="modal-config-card-content">
                                <h3>Características de Produtos</h3>
                                <p class="modal-config-card-subtitle">Atributos e especificações</p>
                            </div>
                        </div>

                        <div class="modal-config-card" onclick="abrirConfiguracao('vendedores')">
                            <div class="modal-config-card-icon teal">
                                <i class="fas fa-user-tie"></i>
                            </div>
                            <div class="modal-config-card-content">
                                <h3>Vendedores</h3>
                                <p class="modal-config-card-subtitle">Equipe de vendas e comissões</p>
                            </div>
                        </div>

                        <div class="modal-config-card" onclick="abrirConfiguracao('tabelas-preco')">
                            <div class="modal-config-card-icon teal">
                                <i class="fas fa-dollar-sign"></i>
                            </div>
                            <div class="modal-config-card-content">
                                <h3>Tabelas de Preço</h3>
                                <p class="modal-config-card-subtitle">Precificação e descontos</p>
                            </div>
                        </div>

                        <div class="modal-config-card" onclick="abrirConfiguracao('unidades-medida')">
                            <div class="modal-config-card-icon teal">
                                <i class="fas fa-ruler"></i>
                            </div>
                            <div class="modal-config-card-content">
                                <h3>Unidades de Medida</h3>
                                <p class="modal-config-card-subtitle">Conversões e padrões</p>
                            </div>
                        </div>

                        <div class="modal-config-card" onclick="abrirConfiguracao('ncm')">
                            <div class="modal-config-card-icon teal">
                                <i class="fas fa-barcode"></i>
                            </div>
                            <div class="modal-config-card-content">
                                <h3>Códigos NCM</h3>
                                <p class="modal-config-card-subtitle">Nomenclatura Comum do Mercosul</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Aba Venda de Serviços -->
                <div class="modal-config-tab-content" id="tab-venda-servicos">
                    <div class="modal-config-grid">
                        <div class="modal-config-card" onclick="abrirConfiguracao('venda-servicos')">
                            <div class="modal-config-card-icon red">
                                <i class="fas fa-cogs"></i>
                            </div>
                            <div class="modal-config-card-content">
                                <h3>Configurações Gerais</h3>
                                <p class="modal-config-card-subtitle">Etapas de OS e numeração</p>
                            </div>
                        </div>

                        <div class="modal-config-card" onclick="abrirConfiguracao('tipos-servico')">
                            <div class="modal-config-card-icon red">
                                <i class="fas fa-concierge-bell"></i>
                            </div>
                            <div class="modal-config-card-content">
                                <h3>Tipos de Serviço</h3>
                                <p class="modal-config-card-subtitle">Categorias de serviços prestados</p>
                            </div>
                        </div>

                        <div class="modal-config-card" onclick="abrirConfiguracao('contratos')">
                            <div class="modal-config-card-icon red">
                                <i class="fas fa-file-contract"></i>
                            </div>
                            <div class="modal-config-card-content">
                                <h3>Modelos de Contrato</h3>
                                <p class="modal-config-card-subtitle">Templates e cláusulas padrão</p>
                            </div>
                        </div>

                        <div class="modal-config-card" onclick="abrirConfiguracao('sla')">
                            <div class="modal-config-card-icon red">
                                <i class="fas fa-stopwatch"></i>
                            </div>
                            <div class="modal-config-card-content">
                                <h3>SLA de Atendimento</h3>
                                <p class="modal-config-card-subtitle">Níveis de serviço acordados</p>
                            </div>
                        </div>

                        <div class="modal-config-card" onclick="abrirConfiguracao('nfse')">
                            <div class="modal-config-card-icon red">
                                <i class="fas fa-file-invoice-dollar"></i>
                            </div>
                            <div class="modal-config-card-content">
                                <h3>NFS-e</h3>
                                <p class="modal-config-card-subtitle">Nota Fiscal de Serviços Eletrônica</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Footer do Modal -->
            <div class="modal-config-footer">
                <a href="#" class="modal-config-footer-link" onclick="abrirSobreLancamentos(event)">
                    <i class="fas fa-info-circle"></i>
                    Sobre os Lançamentos
                </a>
                <a href="#" class="modal-config-footer-link" onclick="abrirHistoricoAlteracoes(event)">
                    <i class="fas fa-history"></i>
                    Histórico de alterações
                </a>
            </div>
        </div>
    </div>

    <script>
        // Funções do Modal de Configurações - Premium Version
        function abrirModalConfig() {
            console.log('🔧 Abrindo modal de configurações...');
            const modal = document.getElementById('modal-configuracoes');
            console.log('Modal encontrado:', modal);
            
            if (modal) {
                // Adiciona modal à tela
                modal.classList.add('active');
                modal.style.display = 'flex';
                document.body.style.overflow = 'hidden';
                console.log('✅ Modal ativado');
                
                // Inicializa tabs
                if (typeof initModalConfigTabs === 'function') {
                    initModalConfigTabs();
                }
                
                // Focus no primeiro elemento interativo
                setTimeout(() => {
                    const firstTab = modal.querySelector('.modal-config-tab');
                    if (firstTab) {
                        firstTab.focus();
                    }
                }, 100);

                // Adiciona classe para animação de entrada dos cards
                setTimeout(() => {
                    const cards = modal.querySelectorAll('.modal-config-card');
                    cards.forEach((card, index) => {
                        setTimeout(() => {
                            card.style.animation = 'slideInCard 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards';
                            card.style.opacity = '1';
                        }, index * 50);
                    });
                }, 200);
            } else {
                console.error('❌ Modal não encontrado! ID: modal-configuracoes');
                alert('Erro: Modal de configurações não encontrado');
            }
        }

        // Adiciona estilos de animação para cards
        const cardAnimStyle = document.createElement('style');
        cardAnimStyle.textContent = `
            .modal-config-card {
                opacity: 0;
            }
            
            .modal-config.active .modal-config-card {
                opacity: 1;
            }

            @keyframes slideInCard {
                from {
                    opacity: 0;
                    transform: translateY(20px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }
        `;
        document.head.appendChild(cardAnimStyle);

        // Função global para fechar o modal de configurações
        window.fecharModalConfig = function() {
            console.log('🔴 fecharModalConfig executado');
            const modal = document.getElementById('modal-configuracoes');
            if (modal) {
                console.log('✅ Modal encontrado, fechando...');
                // Adiciona animação de saída
                const content = modal.querySelector('.modal-config-content');
                if (content) {
                    content.style.animation = 'slideDown 0.3s cubic-bezier(0.4, 0, 0.2, 1)';
                }
                
                setTimeout(() => {
                    modal.classList.remove('active');
                    modal.style.display = 'none';
                    document.body.style.overflow = '';
                    if (content) {
                        content.style.animation = '';
                    }
                }, 280);
            } else {
                console.log('❌ Modal não encontrado');
            }
        }

        function initModalConfigTabs() {
            const tabs = document.querySelectorAll('.modal-config-tab');
            const tabContents = document.querySelectorAll('.modal-config-tab-content');

            tabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    const targetTab = this.getAttribute('data-tab');

                    // Remove active de todas as tabs
                    tabs.forEach(t => t.classList.remove('active'));
                    tabContents.forEach(content => content.classList.remove('active'));

                    // Adiciona active na tab clicada com delay suave
                    this.classList.add('active');
                    
                    setTimeout(() => {
                        const targetContent = document.getElementById('tab-' + targetTab);
                        if (targetContent) {
                            targetContent.classList.add('active');
                        }
                    }, 50);
                });

                // Adiciona suporte para navegação por teclado
                tab.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        this.click();
                    }
                });
            });

            // Adiciona suporte para swipe em mobile
            let touchStartX = 0;
            let touchEndX = 0;
            const tabsContainer = document.querySelector('.modal-config-tabs');
            
            if (tabsContainer) {
                tabsContainer.addEventListener('touchstart', function(e) {
                    touchStartX = e.changedTouches[0].screenX;
                }, { passive: true });

                tabsContainer.addEventListener('touchend', function(e) {
                    touchEndX = e.changedTouches[0].screenX;
                    handleSwipe();
                }, { passive: true });
            }

            function handleSwipe() {
                const swipeThreshold = 50;
                const activeTab = document.querySelector('.modal-config-tab.active');
                
                if (!activeTab) return;
                
                if (touchEndX < touchStartX - swipeThreshold) {
                    // Swipe left - próxima tab
                    const nextTab = activeTab.nextElementSibling;
                    if (nextTab && nextTab.classList.contains('modal-config-tab')) {
                        nextTab.click();
                    }
                }
                
                if (touchEndX > touchStartX + swipeThreshold) {
                    // Swipe right - tab anterior
                    const prevTab = activeTab.previousElementSibling;
                    if (prevTab && prevTab.classList.contains('modal-config-tab')) {
                        prevTab.click();
                    }
                }
            }
        }

        // Adiciona animação keyframe para saída
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideDown {
                from {
                    opacity: 1;
                    transform: translateY(0) scale(1);
                }
                to {
                    opacity: 0;
                    transform: translateY(40px) scale(0.96);
                }
            }
        `;
        document.head.appendChild(style);

        // ============================================
        // EVENT LISTENERS - CSP Compliant
        // ============================================
        document.addEventListener('DOMContentLoaded', function() {
            // Botão de Configurações
            const settingsBtn = document.getElementById('settings-btn');
            if (settingsBtn) {
                settingsBtn.addEventListener('click', function() {
                    abrirModalConfig();
                });
                console.log('✅ Event listener do botão de configurações adicionado');
            }
            
            // Botão de Fechar Modal de Configurações - usar event delegation no documento
            document.addEventListener('click', function(e) {
                const btnFechar = e.target.closest('#btn-fechar-config');
                if (btnFechar) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('🔴 Botão fechar clicado');
                    fecharModalConfig();
                }
            }, true); // Capture phase para garantir que captura o evento
            
            // Botão de Ajuda
            const helpBtn = document.getElementById('help-btn');
            if (helpBtn) {
                helpBtn.addEventListener('click', function() {
                    window.location.href = '/ajuda/index.html';
                });
            }
            
            // Fechar modal ao clicar fora
            const modalConfig = document.getElementById('modal-configuracoes');
            if (modalConfig) {
                modalConfig.addEventListener('click', function(e) {
                    if (e.target === modalConfig) {
                        fecharModalConfig();
                    }
                });
            }
            
            // Fechar com ESC
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    const modalConfig = document.getElementById('modal-configuracoes');
                    if (modalConfig && modalConfig.classList.contains('active')) {
                        fecharModalConfig();
                    }
                }
            });
            
            // Event delegation para cards de configuração
            // Isso funciona mesmo com onclick no HTML (captura antes do CSP bloquear)
            document.addEventListener('click', function(e) {
                const card = e.target.closest('.modal-config-card');
                if (card) {
                    // Extrai o tipo do onclick attribute
                    const onclickAttr = card.getAttribute('onclick');
                    if (onclickAttr) {
                        const match = onclickAttr.match(/abrirConfiguracao\(['"]([^'"]+)['"]\)/);
                        if (match && match[1]) {
                            e.preventDefault();
                            e.stopPropagation();
                            console.log('📋 Card clicado via delegation:', match[1]);
                            if (typeof abrirConfiguracao === 'function') {
                                abrirConfiguracao(match[1]);
                            }
                        }
                    }
                }
            }, true); // Capture phase
        });

        // Função abrirConfiguracao agora está em /js/config-modals.js
        // Mantida aqui apenas para referência/fallback
        if (typeof window.abrirConfiguracao !== 'function') {
            window.abrirConfiguracao = function(tipo) {
                console.log('Abrindo configuração:', tipo);
                alert('Configuração "' + tipo + '" será implementada em breve!');
            };
        }

        function abrirSobreLancamentos(event) {
            event.preventDefault();
            const modal = document.getElementById('modal-sobre-lancamentos');
            if (modal) {
                modal.style.display = 'flex';
                document.body.style.overflow = 'hidden';
            }
        }

        function abrirHistoricoAlteracoes(event) {
            event.preventDefault();
            const modal = document.getElementById('modal-historico-alteracoes');
            if (modal) {
                modal.style.display = 'flex';
                document.body.style.overflow = 'hidden';
                carregarHistoricoAlteracoes();
            }
        }
        
        // Função para carregar histórico do servidor
        async function carregarHistoricoAlteracoes() {
            try {
                const response = await fetch('/api/audit-log?limite=50');
                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.logs) {
                        renderizarHistorico(data.logs);
                    }
                }
            } catch (error) {
                console.log('Usando dados de exemplo do histórico');
            }
        }
        
        function renderizarHistorico(logs) {
            const container = document.getElementById('historico-container');
            if (!container || !logs.length) return;
            
            container.innerHTML = logs.map(log => {
                const initials = (log.usuario || 'US').substring(0, 2).toUpperCase();
                const badgeClass = getBadgeClass(log.acao);
                
                return `
                    <div class="historico-item">
                        <div class="historico-avatar" style="background: ${getAvatarGradient(log.usuario)}">${initials}</div>
                        <div class="historico-content">
                            <div class="historico-header">
                                <span class="historico-usuario">${log.usuario || 'Usuário'}</span>
                                <span class="historico-badge ${badgeClass}"><i class="${getActionIcon(log.acao)}"></i> ${log.acao}</span>
                                <span class="historico-modulo">${log.modulo || 'Sistema'}</span>
                            </div>
                            <p class="historico-descricao">${log.descricao || ''}</p>
                            <div class="historico-detalhes">
                                <span class="historico-time"><i class="fas fa-clock"></i> ${formatarDataHora(log.data)}</span>
                                <span class="historico-ip"><i class="fas fa-globe"></i> ${log.ip || '-'}</span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function getBadgeClass(acao) {
            const classes = {
                'Criou': 'badge-criar',
                'Editou': 'badge-editar',
                'Excluiu': 'badge-excluir',
                'Login': 'badge-login',
                'Configurou': 'badge-config',
                'Perfil': 'badge-perfil'
            };
            return classes[acao] || 'badge-editar';
        }
        
        function getActionIcon(acao) {
            const icons = {
                'Criou': 'fas fa-plus',
                'Editou': 'fas fa-edit',
                'Excluiu': 'fas fa-trash',
                'Login': 'fas fa-sign-in-alt',
                'Configurou': 'fas fa-cog',
                'Perfil': 'fas fa-user'
            };
            return icons[acao] || 'fas fa-edit';
        }
        
        function getAvatarGradient(nome) {
            const colors = [
                'linear-gradient(135deg, #3498db, #2980b9)',
                'linear-gradient(135deg, #e74c3c, #c0392b)',
                'linear-gradient(135deg, #2ecc71, #27ae60)',
                'linear-gradient(135deg, #f39c12, #e67e22)',
                'linear-gradient(135deg, #9b59b6, #8e44ad)',
                'linear-gradient(135deg, #1abc9c, #16a085)'
            ];
            const index = (nome || '').length % colors.length;
            return colors[index];
        }
        
        function formatarDataHora(data) {
            if (!data) return '-';
            const d = new Date(data);
            return d.toLocaleDateString('pt-BR') + ' ' + d.toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit'});
        }
        
        function filtrarHistorico() {
            // Implementar filtros
            carregarHistoricoAlteracoes();
        }
        
        function exportarHistorico() {
            alert('Exportando histórico para Excel...');
        }
        
        // Funções auxiliares para tree view
        function toggleTreeItem(header) {
            const children = header.parentElement.querySelector('.tree-children');
            const toggle = header.querySelector('.tree-toggle');
            
            if (children) {
                const isVisible = children.style.display !== 'none';
                children.style.display = isVisible ? 'none' : 'block';
                toggle.classList.toggle('expanded', !isVisible);
            }
        }
        
        function expandirTodos() {
            document.querySelectorAll('.tree-children').forEach(el => el.style.display = 'block');
            document.querySelectorAll('.tree-toggle').forEach(el => el.classList.add('expanded'));
        }
        
        function recolherTodos() {
            document.querySelectorAll('.tree-children').forEach(el => el.style.display = 'none');
            document.querySelectorAll('.tree-toggle').forEach(el => el.classList.remove('expanded'));
        }
        
        // Função global para fechar modais
        function fecharModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = 'none';
                document.body.style.overflow = 'auto';
            }
        }

        // Funcionalidade de Busca
        function initConfigSearch() {
            const searchInput = document.getElementById('config-search-input');
            if (!searchInput) return;

            searchInput.addEventListener('input', function(e) {
                const searchTerm = e.target.value.toLowerCase().trim();
                const allCards = document.querySelectorAll('.modal-config-card');
                let hasResults = false;

                allCards.forEach(card => {
                    const title = card.querySelector('h3')?.textContent.toLowerCase() || '';
                    const subtitle = card.querySelector('.modal-config-card-subtitle')?.textContent.toLowerCase() || '';
                    const matches = title.includes(searchTerm) || subtitle.includes(searchTerm);

                    if (searchTerm === '' || matches) {
                        card.style.display = 'flex';
                        hasResults = true;
                        
                        // Destaca o termo encontrado
                        if (searchTerm && matches) {
                            card.style.animation = 'highlightCard 0.5s ease';
                        }
                    } else {
                        card.style.display = 'none';
                    }
                });

                // Mostra mensagem se não houver resultados
                const tabContents = document.querySelectorAll('.modal-config-tab-content.active');
                tabContents.forEach(content => {
                    let emptyState = content.querySelector('.modal-config-empty-search');
                    
                    if (!hasResults && searchTerm) {
                        if (!emptyState) {
                            emptyState = document.createElement('div');
                            emptyState.className = 'modal-config-empty-search';
                            emptyState.innerHTML = `
                                <div class="modal-config-empty">
                                    <i class="fas fa-search modal-config-empty-icon"></i>
                                    <h4 class="modal-config-empty-title">Nenhum resultado encontrado</h4>
                                    <p class="modal-config-empty-text">Tente buscar com outros termos ou navegue pelas abas</p>
                                </div>
                            `;
                            content.appendChild(emptyState);
                        }
                        emptyState.style.display = 'block';
                    } else if (emptyState) {
                        emptyState.style.display = 'none';
                    }
                });
            });

            // Limpa busca ao trocar de aba
            const tabs = document.querySelectorAll('.modal-config-tab');
            tabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    searchInput.value = '';
                    const allCards = document.querySelectorAll('.modal-config-card');
                    allCards.forEach(card => {
                        card.style.display = 'flex';
                    });
                    const emptyStates = document.querySelectorAll('.modal-config-empty-search');
                    emptyStates.forEach(state => state.style.display = 'none');
                });
            });
        }

        // Adiciona animação de destaque
        const highlightStyle = document.createElement('style');
        highlightStyle.textContent = `
            @keyframes highlightCard {
                0%, 100% { transform: scale(1); }
                50% { transform: scale(1.02); }
            }
        `;
        document.head.appendChild(highlightStyle);

        // Fechar modal ao clicar fora
        document.addEventListener('click', function(e) {
            const modal = document.getElementById('modal-configuracoes');
            if (modal && e.target === modal) {
                fecharModalConfig();
            }
        });

        // Fechar modal com ESC
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                fecharModalConfig();
            }
        });

        // Inicializa busca quando o modal abre
        document.addEventListener('DOMContentLoaded', function() {
            const modal = document.getElementById('modal-configuracoes');
            if (modal) {
                const observer = new MutationObserver(function(mutations) {
                    mutations.forEach(function(mutation) {
                        if (mutation.attributeName === 'class') {
                            if (modal.classList.contains('active')) {
                                initConfigSearch();
                            }
                        }
                    });
                });
                observer.observe(modal, { attributes: true });
            }
        });
    </script>

    <!-- Chat Widget Bob AI -->
    <script src="js/chat-widget.js?v=20251208autologin"></script>
    
    <!-- Sistema de Chat e Suporte (widgets condicionais por usuário) -->
    <script src="js/chat-suporte-widgets.js?v=20260103"></script>
    
    <!-- Sistema de Monitoramento de Conexão -->
    <script src="modules/_shared/connection-monitor.js?v=20251223"></script>
    <script src="js/popup-confirmacao.js"></script>`n</body>

</html>
<script>
// --- Código movido do final do arquivo para dentro de <script> ---
// Autenticação e funcionalidades
document.addEventListener('DOMContentLoaded', function() {
    // A autenticação já foi feita no script do <head>
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    // Aqui apenas aplicamos as funcionalidades
    var dashboard = document.getElementById('dashboard-area');
    if (dashboard) dashboard.style.display = 'block';
    // ...existing code...
    // Função para configurar avatar
    function setupAvatar(firstName, avatarElement) {
        if (!avatarElement) return;
        
        // Tenta usar a primeira letra do nome
        var initials = firstName.substring(0, 1).toUpperCase();
        avatarElement.textContent = initials;
        
        // Se houver avatar salvo no userData, usa ele
        var userData = localStorage.getItem('userData');
        if (userData) {
            try {
                var user = JSON.parse(userData);
                
                // Tentar carregar avatar baseado no nome ou email
                let avatarFileName = firstName;
                
                // Nomes especiais
                const nomesEspeciais = {
                    'ti': 'TI',
                    'tialuforce': 'TI',
                    'antonio': 'Antonio',
                    'admin': 'admin',
                    'rh': 'Rh',
                    'andreia': 'Andreia',
                    'guilherme': 'Guilherme',
                    'clemerson': 'Clemerson',
                    'isabela': 'Isabela',
                    'thaina': 'Thaina',
                    'thiago': 'Thiago'
                };
                
                const nomeKey = firstName.toLowerCase();
                if (nomesEspeciais[nomeKey]) {
                    avatarFileName = nomesEspeciais[nomeKey];
                }
                
                // Verificar se user.avatar existe no objeto
                if (user.avatar) {
                    avatarElement.innerHTML = `<img src="${user.avatar}" alt="${firstName}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">`;
                } else {
                    // Tentar carregar avatar por nome com webp prioritário
                    const avatarPath = `/avatars/${avatarFileName}.webp`;
                    const img = new Image();
                    img.onload = function() {
                        avatarElement.innerHTML = `<img src="${avatarPath}" alt="${firstName}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">`;
                    };
                    img.onerror = function() {
                        // Mantém as iniciais se não encontrar o avatar
                        console.log('Avatar não encontrado, usando iniciais');
                    };
                    img.src = avatarPath;
                }
            } catch (e) {
                console.log('Erro ao carregar avatar:', e);
            }
        }
    }
    // Função para configurar dropdown do usuário
    function setupUserDropdown(firstName, email) {
        var dropdownName = document.querySelector('.dropdown-user-name');
        var dropdownEmail = document.querySelector('.dropdown-user-email');
        
        console.log('🔧 Setup Dropdown - Nome:', firstName, 'Email:', email);
        console.log('🔧 Elementos encontrados:', {
            dropdownName: !!dropdownName,
            dropdownEmail: !!dropdownEmail
        });
        
        if (dropdownName) {
            dropdownName.textContent = firstName || 'Usuário';
            console.log('✅ Nome atualizado no dropdown:', dropdownName.textContent);
        }
        if (dropdownEmail) {
            dropdownEmail.textContent = email || '';
            console.log('✅ Email atualizado no dropdown:', dropdownEmail.textContent);
        }
    }
    // Personalização do nome do usuário e avatar
    var userData = localStorage.getItem('userData');
    if (userData) {
        try {
            var user = JSON.parse(userData);
            var nome = (user.nome || '').trim();
            var parts = nome.split(/\s+/).filter(Boolean);
            // Controle de acesso por usuário
            var firstName = parts[0] || 'Admin';
            var displayName = parts.length > 1 ? parts[0] + ' ' + parts[parts.length - 1] : firstName;
            // Aplicar controle de permissões por área
            if (window.UserPermissions) {
                applyUserPermissions(firstName);
            }
            var greetingTitle = document.querySelector('.greeting-title');
            var userName = document.querySelector('.user-name');
            var userAvatar = document.querySelector('.user-avatar-header');
            // Atualizar saudação
            if (greetingTitle) {
                greetingTitle.textContent = 'Olá, ' + firstName + '!';
            }
            // Atualizar nome do usuário no header
            if (userName) {
                userName.textContent = firstName;
            }
            // Configurar avatar
            if (userAvatar) {
                setupAvatar(firstName, user.email, userAvatar);
            }
            // Configurar dropdown do usuário
            setupUserDropdown(firstName, user.email);
            // Salvar informações do último acesso
            try {
                var agora = new Date();
                var dataFormatada = agora.toLocaleDateString('pt-BR');
                var horaFormatada = agora.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                var ultimoAcesso = dataFormatada + ' Á s ' + horaFormatada;
                user.last_login = ultimoAcesso;
                localStorage.setItem('userData', JSON.stringify(user));
                sessionStorage.setItem('userData', JSON.stringify(user));
            } catch (e) { 
                console.log('Erro ao salvar último acesso'); 
            }
            // Função para aplicar controle de permissões por usuário
            function applyUserPermissions(userName) {
                if (!window.UserPermissions) return;
                console.log('🔥” Aplicando permissÁµes para usuário:', userName);
                // Obter áreas permitidas para o usuário
                var userAreas = window.UserPermissions.getUserAreas(userName);
                var isAdmin = window.UserPermissions.isAdmin(userName);
                console.log('🔥“‹ Áreas disponíveis:', userAreas);
                console.log('🔥‘‘ Admin:', isAdmin);
                // Verificar cada card de módulo
                var cards = document.querySelectorAll('.module-card[data-area]');
                var visibleCount = 0;
                cards.forEach(function(card) {
                    var area = card.getAttribute('data-area');
                    if (area) {
                        // Verificar se o usuário tem acesso Á  área
                        var hasAccess = window.UserPermissions.hasAccess(userName, area);
                        if (!hasAccess) {
                            card.style.display = 'none';
                            console.log('âŒ Acesso negado:', area);
                        } else {
                            card.style.display = '';
                            visibleCount++;
                            // Configurar URL específica para RH baseado no tipo de usuário
                            if (area === 'rh') {
                                var rhType = window.UserPermissions.getRHType(userName);
                                var rhURL = rhType === 'areaadm' ? '/modules/RH/public/areaadm.html' : '/modules/RH/public/funcionario.html';
                                card.href = rhURL;
                                console.log('✅ Acesso concedido:', area, '(' + rhURL + ')');
                            } else {
                                console.log('✅ Acesso concedido:', area);
                            }
                        }
                    }
                });
                console.log('🔥“Š Total de módulos visíveis:', visibleCount + '/' + cards.length);
            }
        } catch (e) {
            console.log('Erro ao processar dados do usuário:', e);
            // Fallback para dados padrão
            setDefaultUserData();
        }
    } else {
        // Se não há dados do usuário, usar padrão
        setDefaultUserData();
    }
    // Função para definir dados padrão do usuário
    function setDefaultUserData() {
        var greetingTitle = document.querySelector('.greeting-title');
        var userName = document.querySelector('.user-name');
        var userAvatar = document.querySelector('.user-avatar-header');
        if (greetingTitle) {
            greetingTitle.textContent = 'Olá, Admin!';
        }
        if (userName) {
            userName.textContent = 'Admin';
        }
        if (userAvatar) {
            userAvatar.textContent = 'A';
        }
    }
    
    // Função para controlar dropdown do usuário
    function initializeUserDropdown() {
        const userProfile = document.getElementById('user-profile');
        const userDropdown = document.getElementById('user-dropdown');
        
        if (userProfile && userDropdown) {
            // Adicionar evento de clique no perfil do usuário
            userProfile.addEventListener('click', function(e) {
                e.stopPropagation();
                userDropdown.classList.toggle('show');
                console.log('🔥–±ï¸ Dropdown toggled, show:', userDropdown.classList.contains('show'));
            });
            
            // Fechar dropdown ao clicar fora
            document.addEventListener('click', function(e) {
                if (!userProfile.contains(e.target)) {
                    userDropdown.classList.remove('show');
                }
            });
            
            console.log('✅ Dropdown do usuário inicializado');
        } else {
            console.warn('âš ï¸ Elementos do dropdown não encontrados');
        }
    }
    
    // Inicializar dropdown após carregar a página
    initializeUserDropdown();
    
    // NOTA: Funcionalidades dos botões do header foram movidas para /js/header-controls.js
    // ...existing code...
});

// ...restante do código movido do final do arquivo...
</script>

