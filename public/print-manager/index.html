<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <!-- Configuração Global -->
    <script src="../js/config.js"></script>
    <link rel="icon" type="image/x-icon" href="../favicon-aluforce.webp">
    
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciaçãor de Impresso - ALUFORCE v2.0</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #2c5aa0;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
            --info-color: #17a2b8;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .print-manager-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            min-height: 90vh;
        }

        .sidebar {
            background: rgba(44, 90, 160, 0.1);
            border-radius: 15px 0 0 15px;
            border-right: 1px solid rgba(0, 0, 0, 0.1);
        }

        .main-content {
            border-radius: 0 15px 15px 0;
        }

        .printer-card {
            background: white;
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 1rem;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .printer-card:hover {
            border-color: var(--primary-color);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
        }

        .printer-card.default {
            border-color: var(--success-color);
            background: rgba(40, 167, 69, 0.05);
        }

        .printer-card.offline {
            border-color: var(--danger-color);
            background: rgba(220, 53, 69, 0.05);
        }

        .queue-item {
            background: white;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 0.5rem;
            border-left: 4px solid var(--info-color);
            transition: all 0.3s ease;
        }

        .queue-item.processing {
            border-left-color: var(--warning-color);
            background: rgba(255, 193, 7, 0.05);
            animation: pulse 2s infinite;
        }

        .queue-item.completed {
            border-left-color: var(--success-color);
            background: rgba(40, 167, 69, 0.05);
        }

        .queue-item.failed {
            border-left-color: var(--danger-color);
            background: rgba(220, 53, 69, 0.05);
        }

        .status-badge {
            border-radius: 20px;
            padding: 0.25rem 0.75rem;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .status-pending { background: var(--info-color); color: white; }
        .status-processing { background: var(--warning-color); color: black; }
        .status-completed { background: var(--success-color); color: white; }
        .status-failed { background: var(--danger-color); color: white; }
        .status-cancelled { background: #6c757d; color: white; }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .metric-card {
            background: linear-gradient(135deg, var(--primary-color), #3d7acc);
            color: white;
            border-radius: 10px;
            padding: 1.5rem;
            text-align: center;
        }

        .metric-value {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }

        .metric-label {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .btn-print {
            background: linear-gradient(135deg, var(--success-color), #34ce57);
            border: none;
            color: white;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .btn-print:hover {
            background: linear-gradient(135deg, #34ce57, var(--success-color));
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(40, 167, 69, 0.3);
        }

        .progress-bar-custom {
            height: 8px;
            border-radius: 4px;
            background: #e9ecef;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, var(--success-color), #34ce57);
            transition: width 0.3s ease;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .nav-pills .nav-link {
            border-radius: 10px;
            margin-right: 0.5rem;
            color: var(--primary-color);
        }

        .nav-pills .nav-link.active {
            background: var(--primary-color);
            color: white;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        .drag-drop-zone {
            border: 2px dashed #dee2e6;
            border-radius: 10px;
            padding: 2rem;
            text-align: center;
            background: rgba(248, 249, 250, 0.5);
            transition: all 0.3s ease;
        }

        .drag-drop-zone:hover {
            border-color: var(--primary-color);
            background: rgba(44, 90, 160, 0.05);
        }

        .drag-drop-zone.dragover {
            border-color: var(--success-color);
            background: rgba(40, 167, 69, 0.1);
        }

        .print-settings {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 1rem;
        }
    </style></head>
<body>
    <div class="container-fluid py-4">
        <div class="print-manager-container">
            <div class="row h-100">
                <!-- Sidebar -->
                <div class="col-lg-3 sidebar p-4">
                    <h3 class="mb-4">
                        <i class="fas fa-print text-primary"></i>
                        Gerenciaçãor de Impresso
                    </h3>

                    <!-- Navegao -->
                    <ul class="nav nav-pills flex-column mb-4">
                        <li class="nav-item">
                            <a class="nav-link active" href="#" onclick="showTab('queue')">
                                <i class="fas fa-list"></i> Fila de Impresso
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" onclick="showTab('printers')">
                                <i class="fas fa-printer"></i> Impressoras
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" onclick="showTab('print')">
                                <i class="fas fa-plus-circle"></i> Nova Impresso
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" onclick="showTab('history')">
                                <i class="fas fa-history"></i> Histrico
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" onclick="showTab('settings')">
                                <i class="fas fa-cog"></i> Configuraes
                            </a>
                        </li>
                    </ul>

                    <!-- Status do Sistema -->
                    <div class="print-settings">
                        <h6>Status do Sistema</h6>
                        <div class="d-flex align-items-center mb-2">
                            <div class="status-indicator bg-success rounded-circle me-2" style="width: 12px; height: 12px;"></div>
                            <small>Sistema Online</small>
                        </div>
                        <div class="d-flex align-items-center mb-2">
                            <div class="status-indicator bg-warning rounded-circle me-2" style="width: 12px; height: 12px;"></div>
                            <small id="queueCount">0 itens na fila</small>
                        </div>
                        <div class="d-flex align-items-center">
                            <div class="status-indicator bg-info rounded-circle me-2" style="width: 12px; height: 12px;"></div>
                            <small id="printerCount">0 impressoras detectadas</small>
                        </div>
                    </div>

                    <!-- Aes Rpidas -->
                    <div class="print-settings">
                        <h6>Aes Rpidas</h6>
                        <button class="btn btn-print btn-sm w-100 mb-2" onclick="refreshQueue()">
                            <i class="fas fa-sync"></i> Atualizar Fila
                        </button>
                        <button class="btn btn-outline-warning btn-sm w-100 mb-2" onclick="pauseQueue()">
                            <i class="fas fa-pause"></i> Pausar Fila
                        </button>
                        <button class="btn btn-outline-danger btn-sm w-100" onclick="clearQueue()">
                            <i class="fas fa-trash"></i> Limpar Fila
                        </button>
                    </div>
                </div>

                <!-- Contedo Principal -->
                <div class="col-lg-9 main-content p-4">
                    <!-- Mtricas -->
                    <div class="metrics-grid">
                        <div class="metric-card">
                            <div class="metric-value" id="totalJobs">0</div>
                            <div class="metric-label">
                                <i class="fas fa-file"></i> Total de Jobs
                            </div>
                        </div>
                        <div class="metric-card" style="background: linear-gradient(135deg, var(--success-color), #34ce57);">
                            <div class="metric-value" id="completedJobs">0</div>
                            <div class="metric-label">
                                <i class="fas fa-check-circle"></i> Concludos
                            </div>
                        </div>
                        <div class="metric-card" style="background: linear-gradient(135deg, var(--warning-color), #ffca2c);">
                            <div class="metric-value" id="pendingJobs">0</div>
                            <div class="metric-label">
                                <i class="fas fa-clock"></i> Pendentes
                            </div>
                        </div>
                        <div class="metric-card" style="background: linear-gradient(135deg, var(--danger-color), #e74c3c);">
                            <div class="metric-value" id="failedJobs">0</div>
                            <div class="metric-label">
                                <i class="fas fa-exclamation-triangle"></i> Falhas
                            </div>
                        </div>
                    </div>

                    <!-- Aba Fila de Impresso -->
                    <div id="tab-queue" class="tab-content active">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h4>Fila de Impresso</h4>
                            <button class="btn btn-outline-primary" onclick="refreshQueue()">
                                <i class="fas fa-sync"></i> Atualizar
                            </button>
                        </div>

                        <div id="queueList">
                            <!-- Itens da fila sero carregaçãos aqui -->
                        </div>
                    </div>

                    <!-- Aba Impressoras -->
                    <div id="tab-printers" class="tab-content">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h4>Impressoras Disponveis</h4>
                            <button class="btn btn-outline-primary" onclick="detectPrinters()">
                                <i class="fas fa-search"></i> Detectar Impressoras
                            </button>
                        </div>

                        <div id="printersList">
                            <!-- Lista de impressoras ser carregada aqui -->
                        </div>
                    </div>

                    <!-- Aba Nova Impresso -->
                    <div id="tab-print" class="tab-content">
                        <h4 class="mb-4">Nova Impresso</h4>

                        <!-- Zona de Upload -->
                        <div class="drag-drop-zone mb-4" id="dropZone">
                            <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                            <h5>Arraste arquivos aqui ou clique para selecionar</h5>
                            <p class="text-muted">Suporte para Excel (.xlsx), PDF e imagens</p>
                            <input type="file" id="fileInput" class="d-none" multiple accept=".xlsx,.xls,.pdf,.jpg,.png">
                        </div>

                        <!-- Configuraes de Impresso -->
                        <div class="print-settings">
                            <h6>Configuraes de Impresso</h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <label class="form-label">Impressora:</label>
                                    <select class="form-select" id="printerSelect">
                                        <option value="">Selecione uma impressora</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Nmero de Cpias:</label>
                                    <input type="number" class="form-control" id="copies" value="1" min="1" max="10">
                                </div>
                            </div>
                            <div class="row mt-3">
                                <div class="col-md-6">
                                    <label class="form-label">Tamanho do Papel:</label>
                                    <select class="form-select" id="paperSize">
                                        <option value="A4">A4</option>
                                        <option value="A3">A3</option>
                                        <option value="Letter">Carta</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Orientao:</label>
                                    <select class="form-select" id="orientation">
                                        <option value="portrait">Retrato</option>
                                        <option value="landscape">Paisagem</option>
                                    </select>
                                </div>
                            </div>
                            <div class="row mt-3">
                                <div class="col-md-6">
                                    <label class="form-label">Modo de Cor:</label>
                                    <select class="form-select" id="colorMode">
                                        <option value="color">Colorido</option>
                                        <option value="mono">Preto e Branco</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Prioridade:</label>
                                    <select class="form-select" id="priority">
                                        <option value="normal">Normal</option>
                                        <option value="high">Alta</option>
                                        <option value="low">Baixa</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Lista de Arquivos Selecionaçãos -->
                        <div id="selectedFiles" class="mt-4">
                            <!-- Arquivos selecionaçãos aparecero aqui -->
                        </div>

                        <!-- Boto de Impresso -->
                        <button class="btn btn-print btn-lg w-100 mt-4" onclick="startPrinting()" disabled id="printButton">
                            <i class="fas fa-print"></i> Adicionar  Fila de Impresso
                        </button>
                    </div>

                    <!-- Aba Histrico -->
                    <div id="tab-history" class="tab-content">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h4>Histrico de Impresses</h4>
                            <div>
                                <select class="form-select d-inline-block w-auto me-2" id="historyFilter">
                                    <option value="all">Todos</option>
                                    <option value="completed">Concludos</option>
                                    <option value="failed">Falhas</option>
                                    <option value="cancelled">Cancelados</option>
                                </select>
                                <button class="btn btn-outline-secondary" onclick="exportHistory()">
                                    <i class="fas fa-download"></i> Exportar
                                </button>
                            </div>
                        </div>

                        <div id="historyList">
                            <!-- Histrico ser carregação aqui -->
                        </div>
                    </div>

                    <!-- Aba Configuraes -->
                    <div id="tab-settings" class="tab-content">
                        <h4 class="mb-4">Configuraes do Sistema</h4>

                        <div class="print-settings">
                            <h6>Impressora Padro</h6>
                            <div class="row">
                                <div class="col-md-8">
                                    <select class="form-select" id="defaultPrinter">
                                        <option value="">Selecione impressora padro</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <button class="btn btn-primary w-100" onclick="setDefaultPrinter()">
                                        <i class="fas fa-save"></i> Salvar
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="print-settings">
                            <h6>Configuraes de PDF</h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <label class="form-label">Qualidade PDF:</label>
                                    <select class="form-select" id="pdfQuality">
                                        <option value="high">Alta</option>
                                        <option value="medium">Mdia</option>
                                        <option value="low">Baixa</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Timeout (segundos):</label>
                                    <input type="number" class="form-control" id="pdfTimeout" value="30" min="10" max="120">
                                </div>
                            </div>
                        </div>

                        <div class="print-settings">
                            <h6>Configuraes da Fila</h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <label class="form-label">Intervalo de Processamento:</label>
                                    <select class="form-select" id="queueInterval">
                                        <option value="5000">5 segundos</option>
                                        <option value="10000">10 segundos</option>
                                        <option value="30000">30 segundos</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Mximo de Tentativas:</label>
                                    <input type="number" class="form-control" id="maxRetries" value="3" min="1" max="10">
                                </div>
                            </div>
                        </div>

                        <button class="btn btn-success w-100 mt-4" onclick="saveSettings()">
                            <i class="fas fa-save"></i> Salvar Configuraes
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Estação global
        let printSystemState = {
            queue: [],
            history: [],
            printers: [],
            selectedFiles: [],
            settings: {
                defaultPrinter: null,
                queueInterval: 5000,
                maxRetries: 3
            }
        };

        // Configurao da API
        const apiConfig = {
            baseUrl: window.location.origin,
            endpoints: {
                queue: '/api/print/queue',
                printers: '/api/print/printers',
                print: '/api/print/add',
                cancel: '/api/print/cancel',
                settings: '/api/print/settings',
                stats: '/api/print/stats'
            }
        };

        document.addEventListener('DOMContentLoaded', function() {
            initializePrintManager();
            setupEventListeners();
            loadInitialData();
            
            // Atualizar dados a cada 10 segundos
            setInterval(refreshData, 10000);
        });

        function initializePrintManager() {
            console.log(' Inicializando Gerenciaçãor de Impresso...');
            
            // Configurar drag and drop
            setupDragAndDrop();
            
            console.log(' Gerenciaçãor de Impresso inicialização');
        }

        function setupEventListeners() {
            // Upload de arquivos
            document.getElementById('fileInput').addEventListener('change', handleFileSelect);
            
            // Filtro de histrico
            document.getElementById('historyFilter').addEventListener('change', filterHistory);
        }

        function setupDragAndDrop() {
            const dropZone = document.getElementById('dropZone');
            
            dropZone.addEventListener('click', () => {
                document.getElementById('fileInput').click();
            });

            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.classList.add('dragover');
            });

            dropZone.addEventListener('dragleave', () => {
                dropZone.classList.remove('dragover');
            });

            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('dragover');
                
                const files = Array.from(e.dataTransfer.files);
                handleFileSelection(files);
            });
        }

        function handleFileSelect(event) {
            const files = Array.from(event.target.files);
            handleFileSelection(files);
        }

        function handleFileSelection(files) {
            printSystemState.selectedFiles = files;
            displaySelectedFiles();
            updatePrintButton();
        }

        function displaySelectedFiles() {
            const container = document.getElementById('selectedFiles');
            container.innerHTML = '';

            if (printSystemState.selectedFiles.length === 0) {
                container.innerHTML = '<p class="text-muted">Nenhum arquivo selecionação</p>';
                return;
            }

            container.innerHTML = '<h6>Arquivos Selecionaçãos:</h6>';

            printSystemState.selectedFiles.forEach((file, index) => {
                const fileCard = document.createElement('div');
                fileCard.className = 'queue-item';
                fileCard.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <strong>${file.name}</strong>
                            <small class="text-muted d-block">${formatFileSize(file.size)} - ${file.type}</small>
                        </div>
                        <button class="btn btn-sm btn-outline-danger" onclick="removeFile(${index})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                container.appendChild(fileCard);
            });
        }

        function removeFile(index) {
            printSystemState.selectedFiles.splice(index, 1);
            displaySelectedFiles();
            updatePrintButton();
        }

        function updatePrintButton() {
            const button = document.getElementById('printButton');
            const hasFiles = printSystemState.selectedFiles.length > 0;
            const hasPrinter = document.getElementById('printerSelect').value !== '';
            
            button.disabled = !hasFiles || !hasPrinter;
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        async function loadInitialData() {
            try {
                await Promise.all([
                    loadQueue(),
                    loadPrinters(),
                    loadHistory(),
                    loadStats()
                ]);
            } catch (error) {
                console.error('Erro ao carregar dados iniciais:', error);
            }
        }

        async function loadQueue() {
            try {
                const response = await fetch(apiConfig.baseUrl + apiConfig.endpoints.queue);
                const data = await response.json();
                
                if (data.success) {
                    printSystemState.queue = data.queue;
                    displayQueue();
                    updateQueueCount();
                }
            } catch (error) {
                console.error('Erro ao carregar fila:', error);
            }
        }

        async function loadPrinters() {
            try {
                const response = await fetch(apiConfig.baseUrl + apiConfig.endpoints.printers);
                const data = await response.json();
                
                if (data.success) {
                    printSystemState.printers = data.printers;
                    displayPrinters();
                    updatePrinterSelects();
                    updatePrinterCount();
                }
            } catch (error) {
                console.error('Erro ao carregar impressoras:', error);
            }
        }

        async function loadHistory() {
            try {
                const response = await fetch(apiConfig.baseUrl + apiConfig.endpoints.queue + '/history');
                const data = await response.json();
                
                if (data.success) {
                    printSystemState.history = data.history;
                    displayHistory();
                }
            } catch (error) {
                console.error('Erro ao carregar histrico:', error);
            }
        }

        async function loadStats() {
            try {
                const response = await fetch(apiConfig.baseUrl + apiConfig.endpoints.stats);
                const data = await response.json();
                
                if (data.success) {
                    updateMetrics(data.stats);
                }
            } catch (error) {
                console.error('Erro ao carregar estatsticas:', error);
            }
        }

        function displayQueue() {
            const container = document.getElementById('queueList');
            container.innerHTML = '';

            if (printSystemState.queue.length === 0) {
                container.innerHTML = '<p class="text-muted">Fila de impresso vazia</p>';
                return;
            }

            printSystemState.queue.forEach(job => {
                const queueItem = document.createElement('div');
                queueItem.className = `queue-item ${job.status}`;
                queueItem.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <strong>${job.metadata.documentName}</strong>
                            <small class="text-muted d-block">
                                ${job.printer}  ${job.copies} cpia(s)  ${job.paperSize}
                            </small>
                            <small class="text-muted">
                                ${new Date(job.createdAt).toLocaleString('pt-BR')}
                            </small>
                        </div>
                        <div class="text-end">
                            <span class="status-badge status-${job.status}">${getStatusText(job.status)}</span>
                            ${job.status === 'pending'  
                                `<button class="btn btn-sm btn-outline-danger ms-2" onclick="cancelJob('${job.id}')">
                                    <i class="fas fa-times"></i>
                                </button>` : ''
                            }
                        </div>
                    </div>
                    ${job.status === 'processing' ? '<div class="progress-bar-custom mt-2"><div class="progress-fill" style="width: 50%"></div></div>' : ''
                    }
                `;
                container.appendChild(queueItem);
            });
        }

        function displayPrinters() {
            const container = document.getElementById('printersList');
            container.innerHTML = '';

            printSystemState.printers.forEach(printer => {
                const printerCard = document.createElement('div');
                printerCard.className = `printer-card ${printer.isDefault ? 'default' : ''} ${printer.status !== 'IDLE'  'offline' : ''}`;
                printerCard.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6>${printer.name}</h6>
                            <small class="text-muted">${printer.status}</small>
                            ${printer.isDefault ? '<span class="badge bg-success ms-2">Padro</span>' : ''}
                        </div>
                        <div>
                            ${!printer.isDefault  
                                `<button class="btn btn-sm btn-outline-primary" onclick="setAsDefault('${printer.name}')">
                                    <i class="fas fa-star"></i> Definir como Padro
                                </button>` : ''
                            }
                        </div>
                    </div>
                `;
                container.appendChild(printerCard);
            });
        }

        function displayHistory() {
            const container = document.getElementById('historyList');
            const filter = document.getElementById('historyFilter').value;
            
            let filteredHistory = printSystemState.history;
            if (filter !== 'all') {
                filteredHistory = printSystemState.history.filter(job => job.status === filter);
            }

            container.innerHTML = '';

            if (filteredHistory.length === 0) {
                container.innerHTML = '<p class="text-muted">Nenhum item no histrico</p>';
                return;
            }

            filteredHistory.slice(0, 50).forEach(job => { // Mostrar apenas ltimos 50
                const historyItem = document.createElement('div');
                historyItem.className = `queue-item ${job.status}`;
                historyItem.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <strong>${job.metadata.documentName}</strong>
                            <small class="text-muted d-block">
                                ${job.printer}  ${job.copies} cpia(s)
                            </small>
                            <small class="text-muted">
                                ${new Date(job.createdAt).toLocaleString('pt-BR')}
                            </small>
                        </div>
                        <div class="text-end">
                            <span class="status-badge status-${job.status}">${getStatusText(job.status)}</span>
                            ${job.error ? `<small class="text-danger d-block">${job.error}</small>` : ''}
                        </div>
                    </div>
                `;
                container.appendChild(historyItem);
            });
        }

        function updatePrinterSelects() {
            const selects = ['printerSelect', 'defaultPrinter'];
            
            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                const currentValue = select.value;
                
                select.innerHTML = '<option value="">Selecione uma impressora</option>';
                
                printSystemState.printers.forEach(printer => {
                    const option = document.createElement('option');
                    option.value = printer.name;
                    option.textContent = `${printer.name} (${printer.status})`;
                    if (printer.isDefault) option.textContent += ' - Padro';
                    select.appendChild(option);
                });
                
                select.value = currentValue;
            });

            updatePrintButton();
        }

        function updateMetrics(stats) {
            document.getElementById('totalJobs').textContent = stats.total || 0;
            document.getElementById('completedJobs').textContent = stats.completed || 0;
            document.getElementById('pendingJobs').textContent = stats.pending || 0;
            document.getElementById('failedJobs').textContent = stats.failed || 0;
        }

        function updateQueueCount() {
            document.getElementById('queueCount').textContent = 
                `${printSystemState.queue.length} itens na fila`;
        }

        function updatePrinterCount() {
            document.getElementById('printerCount').textContent = 
                `${printSystemState.printers.length} impressoras detectadas`;
        }

        function getStatusText(status) {
            const statusTexts = {
                'pending': 'Pendente',
                'processing': 'Processando',
                'completed': 'Concludo',
                'failed': 'Falhou',
                'cancelled': 'Cancelação'
            };
            return statusTexts[status] || status;
        }

        function showTab(tabName) {
            // Esconder todas as abas
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });

            // Remover active de todos os links
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });

            // Mostrar aba selecionada
            document.getElementById(ab-${tabName}`).classList.add('active');
            event.target.classList.add('active');
        }

        async function startPrinting() {
            if (printSystemState.selectedFiles.length === 0) {
                alert('Selecione pelo menos um arquivo para imprimir');
                return;
            }

            const settings = {
                printer: document.getElementById('printerSelect').value,
                copies: parseInt(document.getElementById('copies').value),
                paperSize: document.getElementById('paperSize').value,
                orientation: document.getElementById('orientation').value,
                colorMode: document.getElementById('colorMode').value,
                priority: document.getElementById('priority').value
            };

            try {
                for (const file of printSystemState.selectedFiles) {
                    const formData = new FormData();
                    formData.append('file', file);
                    formData.append('settings', JSON.stringify(settings));

                    const response = await fetch(apiConfig.baseUrl + apiConfig.endpoints.print, {
                        method: 'POST',
                        body: formData
                    });

                    const result = await response.json();
                    
                    if (!result.success) {
                        throw new Error(`Erro ao imprimir ${file.name}: ${result.error}`);
                    }
                }

                alert(`${printSystemState.selectedFiles.length} arquivo(s) adicionação(s)  fila de impresso!`);
                
                // Limpar seleo
                printSystemState.selectedFiles = [];
                document.getElementById('fileInput').value = '';
                displaySelectedFiles();
                updatePrintButton();
                
                // Atualizar fila
                await loadQueue();

            } catch (error) {
                alert('Erro ao adicionar  fila: ' + error.message);
                console.error('Erro na impresso:', error);
            }
        }

        async function cancelJob(jobId) {
            if (!confirm('Tem certeza que deseja cancelar este job')) return;

            try {
                const response = await fetch(apiConfig.baseUrl + apiConfig.endpoints.cancel, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ jobId })
                });

                const result = await response.json();
                
                if (result.success) {
                    await loadQueue();
                } else {
                    alert('Erro ao cancelar job: ' + result.error);
                }
            } catch (error) {
                alert('Erro na comunicao: ' + error.message);
            }
        }

        async function refreshQueue() {
            await loadQueue();
            console.log('Fila atualizada');
        }

        async function refreshData() {
            await Promise.all([
                loadQueue(),
                loadStats()
            ]);
        }

        function filterHistory() {
            displayHistory();
        }

        // Funes de configurao
        async function setAsDefault(printerName) {
            try {
                const response = await fetch(apiConfig.baseUrl + apiConfig.endpoints.settings + '/default-printer', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ printerName })
                });

                const result = await response.json();
                
                if (result.success) {
                    await loadPrinters();
                } else {
                    alert('Erro ao definir impressora padro: ' + result.error);
                }
            } catch (error) {
                alert('Erro na comunicao: ' + error.message);
            }
        }

        async function detectPrinters() {
            try {
                const response = await fetch(apiConfig.baseUrl + apiConfig.endpoints.printers + '/detect', {
                    method: 'POST'
                });

                const result = await response.json();
                
                if (result.success) {
                    await loadPrinters();
                    alert(`${result.count} impressoras detectadas`);
                } else {
                    alert('Erro ao detectar impressoras: ' + result.error);
                }
            } catch (error) {
                alert('Erro na comunicao: ' + error.message);
            }
        }

        async function clearQueue() {
            if (!confirm('Tem certeza que deseja limpar toda a fila')) return;

            try {
                const response = await fetch(apiConfig.baseUrl + apiConfig.endpoints.queue + '/clear', {
                    method: 'POST'
                });

                const result = await response.json();
                
                if (result.success) {
                    await loadQueue();
                    alert(`${result.cancelledCount} jobs cancelados`);
                } else {
                    alert('Erro ao limpar fila: ' + result.error);
                }
            } catch (error) {
                alert('Erro na comunicao: ' + error.message);
            }
        }

        function exportHistory() {
            const data = printSystemState.history;
            const csv = convertToCSV(data);
            downloadCSV(csv, 'histrico-impressao.csv');
        }

        function convertToCSV(data) {
            if (data.length === 0) return '';

            const headers = ['Data', 'Documento', 'Impressora', 'Status', 'Cpias'];
            const rows = data.map(job => [
                new Date(job.createdAt).toLocaleString('pt-BR'),
                job.metadata.documentName,
                job.printer,
                getStatusText(job.status),
                job.copies
            ]);

            return [headers, ...rows].map(row => row.join(',')).join('\n');
        }

        function downloadCSV(csv, filename) {
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Carregamento inicial
        document.getElementById('printerSelect').addEventListener('change', updatePrintButton);
    </script></body>
</html>
