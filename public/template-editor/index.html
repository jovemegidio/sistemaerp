<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <link rel="icon" type="image/x-icon" href="/favicon-aluforce.webp">
    
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editor de Templates - ALUFORCE v2.0</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/spectrum-colorpicker2@2.0.10/dist/spectrum.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #2c5aa0;
            --secondary-color: #f8f9fa;
            --accent-color: #e83e8c;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .editor-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            min-height: 90vh;
        }

        .sidebar {
            background: rgba(44, 90, 160, 0.1);
            border-radius: 15px 0 0 15px;
            border-right: 1px solid rgba(0, 0, 0, 0.1);
        }

        .main-content {
            border-radius: 0 15px 15px 0;
        }

        .template-preview {
            background: white;
            border: 2px dashed #dee2e6;
            border-radius: 10px;
            min-height: 600px;
            position: relative;
            overflow: hidden;
        }

        .cell-editor {
            position: absolute;
            background: rgba(40, 167, 69, 0.1);
            border: 2px solid #28a745;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .cell-editor:hover {
            background: rgba(40, 167, 69, 0.2);
            transform: scale(1.02);
        }

        .cell-editor.selected {
            border-color: var(--accent-color);
            background: rgba(232, 62, 140, 0.1);
        }

        .properties-panel {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 1rem;
            border: 1px solid rgba(0, 0, 0, 0.1);
        }

        .template-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .template-card {
            background: white;
            border-radius: 10px;
            padding: 1rem;
            border: 2px solid transparent;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .template-card:hover {
            border-color: var(--primary-color);
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
        }

        .template-card.selected {
            border-color: var(--accent-color);
            background: rgba(232, 62, 140, 0.05);
        }

        .color-picker {
            width: 40px;
            height: 40px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }

        .btn-gradient {
            background: linear-gradient(135deg, var(--primary-color), #3d7acc);
            border: none;
            color: white;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .btn-gradient:hover {
            background: linear-gradient(135deg, #3d7acc, var(--primary-color));
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(44, 90, 160, 0.3);
        }

        .field-mapping {
            background: rgba(248, 249, 250, 0.8);
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
        }

        .mapping-tag {
            background: var(--primary-color);
            color: white;
            border-radius: 20px;
            padding: 0.25rem 0.75rem;
            font-size: 0.8rem;
            display: inline-block;
            margin: 0.2rem;
        }

        .excel-grid {
            display: grid;
            grid-template-columns: repeat(10, 60px);
            grid-template-rows: repeat(20, 30px);
            gap: 1px;
            background: #e9ecef;
            padding: 10px;
            border-radius: 8px;
            overflow: auto;
            max-height: 500px;
        }

        .excel-cell {
            background: white;
            border: 1px solid #dee2e6;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .excel-cell:hover {
            background: rgba(40, 167, 69, 0.1);
        }

        .excel-cell.mapped {
            background: rgba(40, 167, 69, 0.2);
            border-color: #28a745;
        }

        .excel-cell.selected {
            background: rgba(232, 62, 140, 0.2);
            border-color: var(--accent-color);
        }

        .progress-step {
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
            padding: 1rem;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.5);
        }

        .step-number {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 1rem;
        }

        .step-content {
            flex: 1;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .nav-pills .nav-link {
            border-radius: 10px;
            margin-right: 0.5rem;
        }

        .nav-pills .nav-link.active {
            background: var(--primary-color);
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .pulse { animation: pulse 2s infinite; }
    </style>
    
    `n    `n</head>
<body>
    <div class="container-fluid py-4">
        <div class="editor-container">
            <div class="row h-100">
                <!-- Sidebar -->
                <div class="col-lg-3 sidebar p-4">
                    <h3 class="mb-4">
                        <i class="fas fa-palette text-primary"></i>
                        Editor de Templates
                    </h3>

                    <!-- Navega��o por Abas -->
                    <ul class="nav nav-pills flex-column mb-4">
                        <li class="nav-item">
                            <a class="nav-link active" href="#" onclick="showTab('templates')">
                                <i class="fas fa-th-large"></i> Templates
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" onclick="showTab('mapping')">
                                <i class="fas fa-map-signs"></i> Mapeamento
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" onclick="showTab('styling')">
                                <i class="fas fa-paint-brush"></i> Estilo
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" onclick="showTab('preview')">
                                <i class="fas fa-eye"></i> Visualizar
                            </a>
                        </li>
                    </ul>

                    <!-- Aba Templates -->
                    <div id="tab-templates" class="tab-content active">
                        <h5>Selecionar Template Base</h5>
                        <div class="mb-3">
                            <select class="form-select" id="templateType">
                                <option value="ordem-produ��o">Ordem de Produ��o</option>
                                <option value="or�amento">Or�amento</option>
                                <option value="pedido-compras">Pedido de Compras</option>
                                <option value="nota-entrega">Nota de Entrega</option>
                            </select>
                        </div>
                        
                        <div id="templateList">
                            <!-- Templates ser�o carregados aqui -->
                        </div>

                        <button class="btn btn-gradient w-100 mt-3" onclick="createNewTemplate()">
                            <i class="fas fa-plus"></i> Novo Template
                        </button>
                    </div>

                    <!-- Aba Mapeamento -->
                    <div id="tab-mapping" class="tab-content">
                        <h5>Mapeamento de Campos</h5>
                        <small class="text-muted">Clique nas c�lulas para mapear os dados</small>
                        
                        <div class="mt-3">
                            <label class="form-label">Campo a Mapear:</label>
                            <select class="form-select" id="fieldToMap">
                                <option value="n�mero_orcamento">N�mero do Or�amento</option>
                                <option value="n�mero_pedido">N�mero do Pedido</option>
                                <option value="data_liberacao">Data de Libera��o</option>
                                <option value="vendedor">Vendedor</option>
                                <option value="cliente">Cliente</option>
                                <option value="total_geral">Total Geral</option>
                            </select>
                        </div>

                        <div class="mt-3" id="mappedFields">
                            <!-- Campos mapeados aparecer�o aqui -->
                        </div>

                        <button class="btn btn-outline-danger btn-sm w-100 mt-3" onclick="clearMapping()">
                            <i class="fas fa-trash"></i> Limpar Mapeamento
                        </button>
                    </div>

                    <!-- Aba Estilo -->
                    <div id="tab-styling" class="tab-content">
                        <h5>Personaliza��o Visual</h5>
                        
                        <div class="properties-panel">
                            <h6>Cores</h6>
                            <div class="mb-3">
                                <label class="form-label">Cor do Cabe�alho:</label>
                                <input type="color" class="color-picker" id="headerColor" value="#2c5aa0">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Cor do Texto:</label>
                                <input type="color" class="color-picker" id="textColor" value="#000000">
                            </div>
                        </div>

                        <div class="properties-panel">
                            <h6>Fonte</h6>
                            <div class="mb-3">
                                <label class="form-label">Fam�lia:</label>
                                <select class="form-select" id="fontFamily">
                                    <option value="Arial">Arial</option>
                                    <option value="Calibri">Calibri</option>
                                    <option value="Times New Roman">Times New Roman</option>
                                    <option value="Verdana">Verdana</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Tamanho:</label>
                                <input type="range" class="form-range" id="fontSize" min="8" max="20" value="10">
                                <small class="text-muted">Tamanho: <span id="fontSizeValue">10</span>pt</small>
                            </div>
                        </div>

                        <div class="properties-panel">
                            <h6>Logo da Empresa</h6>
                            <div class="mb-3">
                                <label class="form-label">Upload Logo:</label>
                                <input type="file" class="form-control" id="logoUpload" accept="image/*">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Posi��o:</label>
                                <select class="form-select" id="logoPosition">
                                    <option value="top-left">Superior Esquerda</option>
                                    <option value="top-right">Superior Direita</option>
                                    <option value="center">Centro</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Aba Preview -->
                    <div id="tab-preview" class="tab-content">
                        <h5>Visualiza��o</h5>
                        <p class="text-muted">Veja como seu template ficar�:</p>
                        
                        <button class="btn btn-gradient w-100 mb-3" onclick="generatePreview()">
                            <i class="fas fa-eye"></i> Gerar Preview
                        </button>

                        <button class="btn btn-success w-100 mb-3" onclick="saveTemplate()">
                            <i class="fas fa-save"></i> Salvar Template
                        </button>

                        <button class="btn btn-outline-primary w-100" onclick="exportTemplate()">
                            <i class="fas fa-download"></i> Exportar
                        </button>
                    </div>
                </div>

                <!-- �rea Principal -->
                <div class="col-lg-9 main-content p-4">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h4>
                            <span id="currentTemplateName">Novo Template</span>
                            <small class="text-muted" id="templateStatus">N�o salvo</small>
                        </h4>
                        <div>
                            <button class="btn btn-outline-secondary me-2" onclick="undoAction()">
                                <i class="fas fa-undo"></i> Desfazer
                            </button>
                            <button class="btn btn-outline-secondary" onclick="redoAction()">
                                <i class="fas fa-redo"></i> Refazer
                            </button>
                        </div>
                    </div>

                    <!-- �rea de Edi��o -->
                    <div class="template-preview" id="templatePreview">
                        <div class="excel-grid" id="excelGrid">
                            <!-- Grid do Excel ser� gerado aqui -->
                        </div>
                    </div>

                    <!-- Informa��es de Ajuda -->
                    <div class="mt-4">
                        <div class="alert alert-info">
                            <h6><i class="fas fa-info-circle"></i> Como usar o Editor:</h6>
                            <ol class="mb-0">
                                <li>Selecione um template base ou crie um novo</li>
                                <li>Use a aba "Mapeamento" para associar campos aos dados</li>
                                <li>Personalize cores e fontes na aba "Estilo"</li>
                                <li>Visualize o resultado na aba "Preview"</li>
                                <li>Salve seu template personalizado</li>
                            </ol>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/spectrum-colorpicker2@2.0.10/dist/spectrum.min.js"></script>
    <script>
        // Estado global do editor
        let editorState = {
            currentTemplate: null,
            cellMappings: {},
            styling: {
                headerColor: '#2c5aa0',
                textColor: '#000000',
                fontFamily: 'Arial',
                fontSize: 10
            },
            selectedCells: [],
            actionHistory: [],
            currentStep: 0
        };

        // Configura��o da API
        const apiConfig = {
            baseUrl: window.location.origin,
            endpoints: {
                listTemplates: '/api/templates/list',
                createTemplate: '/api/templates/create',
                updateTemplate: '/api/templates/update',
                deleteTemplate: '/api/templates/delete'
            }
        };

        document.addEventListener('DOMContentLoaded', function() {
            initializeEditor();
            generateExcelGrid();
            setupEventListeners();
            loadTemplates();
        });

        function initializeEditor() {
            // Configurar color pickers
            $('#headerColor').spectrum({
                color: editorState.styling.headerColor,
                change: function(color) {
                    editorState.styling.headerColor = color.toHexString();
                    updatePreview();
                }
            });

            $('#textColor').spectrum({
                color: editorState.styling.textColor,
                change: function(color) {
                    editorState.styling.textColor = color.toHexString();
                    updatePreview();
                }
            });

            // Configurar slider de fonte
            document.getElementById('fontSize').addEventListener('input', function() {
                editorState.styling.fontSize = parseInt(this.value);
                document.getElementById('fontSizeValue').textContent = this.value;
                updatePreview();
            });

            console.log('Editor inicializado com sucesso');
        }

        function generateExcelGrid() {
            const grid = document.getElementById('excelGrid');
            grid.innerHTML = '';

            // Gerar grid 10x20 (simplificado)
            for (let row = 1; row <= 20; row++) {
                for (let col = 1; col <= 10; col++) {
                    const cell = document.createElement('div');
                    cell.className = 'excel-cell';
                    cell.dataset.row = row;
                    cell.dataset.col = col;
                    cell.dataset.address = getExcelAddress(col, row);
                    cell.textContent = getExcelAddress(col, row);
                    
                    cell.addEventListener('click', function() {
                        selectCell(this);
                    });

                    grid.appendChild(cell);
                }
            }
        }

        function getExcelAddress(col, row) {
            const letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
            let colName = '';
            while (col > 0) {
                col--;
                colName = letters[col % 26] + colName;
                col = Math.floor(col / 26);
            }
            return colName + row;
        }

        function selectCell(cellElement) {
            // Limpar sele��o anterior se n�o estiver segurando Ctrl
            if (!event.ctrlKey) {
                document.querySelectorAll('.excel-cell.selected').forEach(cell => {
                    cell.classList.remove('selected');
                });
                editorState.selectedCells = [];
            }

            // Adicionar/remover c�lula da sele��o
            if (cellElement.classList.contains('selected')) {
                cellElement.classList.remove('selected');
                editorState.selectedCells = editorState.selectedCells.filter(
                    addr => addr !== cellElement.dataset.address
                );
            } else {
                cellElement.classList.add('selected');
                editorState.selectedCells.push(cellElement.dataset.address);
            }

            console.log('C�lulas selecionadas:', editorState.selectedCells);
        }

        function showTab(tabName) {
            // Esconder todas as abas
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });

            // Remover active de todos os links
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });

            // Mostrar aba selecionada
            document.getElementById(`tab-${tabName}`).classList.add('active');
            event.target.classList.add('active');
        }

        function mapFieldToCells() {
            const field = document.getElementById('fieldToMap').value;
            const selectedCells = editorState.selectedCells;

            if (selectedCells.length === 0) {
                alert('Selecione pelo menos uma c�lula para mapear');
                return;
            }

            // Adicionar mapeamento
            if (!editorState.cellMappings[field]) {
                editorState.cellMappings[field] = [];
            }

            selectedCells.forEach(cellAddr => {
                if (!editorState.cellMappings[field].includes(cellAddr)) {
                    editorState.cellMappings[field].push(cellAddr);
                }
            });

            // Atualizar visualiza��o
            updateMappingDisplay();
            updateCellsDisplay();

            // Limpar sele��o
            editorState.selectedCells = [];
            document.querySelectorAll('.excel-cell.selected').forEach(cell => {
                cell.classList.remove('selected');
            });

            console.log('Mapeamento atualizado:', editorState.cellMappings);
        }

        function updateMappingDisplay() {
            const container = document.getElementById('mappedFields');
            container.innerHTML = '';

            Object.entries(editorState.cellMappings).forEach(([field, cells]) => {
                const mappingDiv = document.createElement('div');
                mappingDiv.className = 'field-mapping';
                mappingDiv.innerHTML = `
                    <strong>${getFieldDisplayName(field)}</strong>
                    <div class="mt-2">
                        ${cells.map(cell => `<span class="mapping-tag">${cell}</span>`).join('')}
                    </div>
                    <button class="btn btn-sm btn-outline-danger mt-2" onclick="removeFieldMapping('${field}')">
                        <i class="fas fa-trash"></i> Remover
                    </button>
                `;
                container.appendChild(mappingDiv);
            });
        }

        function updateCellsDisplay() {
            // Resetar classes das c�lulas
            document.querySelectorAll('.excel-cell').forEach(cell => {
                cell.classList.remove('mapped');
            });

            // Marcar c�lulas mapeadas
            Object.values(editorState.cellMappings).flat().forEach(cellAddr => {
                const cell = document.querySelector(`[data-address="${cellAddr}"]`);
                if (cell) {
                    cell.classList.add('mapped');
                }
            });
        }

        function getFieldDisplayName(field) {
            const fieldNames = {
                'n�mero_orcamento': 'N�mero do Or�amento',
                'n�mero_pedido': 'N�mero do Pedido',
                'data_liberacao': 'Data de Libera��o',
                'vendedor': 'Vendedor',
                'cliente': 'Cliente',
                'total_geral': 'Total Geral'
            };
            return fieldNames[field] || field;
        }

        function removeFieldMapping(field) {
            delete editorState.cellMappings[field];
            updateMappingDisplay();
            updateCellsDisplay();
        }

        function clearMapping() {
            if (confirm('Tem certeza que deseja limpar todo o mapeamento?')) {
                editorState.cellMappings = {};
                updateMappingDisplay();
                updateCellsDisplay();
            }
        }

        function setupEventListeners() {
            // Mapear campo quando c�lula for clicada
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && editorState.selectedCells.length > 0) {
                    mapFieldToCells();
                }
            });

            // Auto-save durante edi��o
            setInterval(function() {
                if (editorState.currentTemplate) {
                    localStorage.setItem('template-editor-state', JSON.stringify(editorState));
                }
            }, 30000); // A cada 30 segundos
        }

        async function loadTemplates() {
            try {
                const response = await fetch(apiConfig.baseUrl + apiConfig.endpoints.listTemplates);
                const data = await response.json();
                
                if (data.success) {
                    displayTemplates(data.templates);
                } else {
                    console.error('Erro ao carregar templates:', data.error);
                }
            } catch (error) {
                console.error('Erro na comunica��o com API:', error);
            }
        }

        function displayTemplates(templates) {
            const container = document.getElementById('templateList');
            container.innerHTML = '';

            if (templates.length === 0) {
                container.innerHTML = '<p class="text-muted">Nenhum template encontrado.</p>';
                return;
            }

            templates.forEach(template => {
                const templateCard = document.createElement('div');
                templateCard.className = 'template-card';
                templateCard.innerHTML = `
                    <h6>${template.name}</h6>
                    <p class="text-muted small">${template.description}</p>
                    <div class="d-flex justify-content-between align-items-center">
                        <small class="text-muted">${template.company}</small>
                        ${template.isDefault ? '<span class="badge bg-primary">Padr�o</span>' : ''}
                    </div>
                `;
                
                templateCard.addEventListener('click', function() {
                    selectTemplate(template);
                });

                container.appendChild(templateCard);
            });
        }

        function selectTemplate(template) {
            // Remover sele��o anterior
            document.querySelectorAll('.template-card').forEach(card => {
                card.classList.remove('selected');
            });

            // Selecionar novo template
            event.currentTarget.classList.add('selected');
            editorState.currentTemplate = template;
            
            document.getElementById('currentTemplateName').textContent = template.name;
            document.getElementById('templateStatus').textContent = 'Template carregado';

            // Carregar configura��es do template
            if (template.customizations) {
                editorState.cellMappings = template.customizations.cellMappings || {};
                editorState.styling = { ...editorState.styling, ...template.customizations.styling };
                
                updateMappingDisplay();
                updateCellsDisplay();
                updatePreview();
            }

            console.log('Template selecionado:', template);
        }

        function createNewTemplate() {
            const templateName = prompt('Nome do novo template:');
            if (!templateName) return;

            editorState.currentTemplate = {
                id: null,
                name: templateName,
                description: 'Template personalizado',
                type: document.getElementById('templateType').value,
                isNew: true
            };

            document.getElementById('currentTemplateName').textContent = templateName;
            document.getElementById('templateStatus').textContent = 'Novo template (n�o salvo)';

            // Limpar estado
            editorState.cellMappings = {};
            updateMappingDisplay();
            updateCellsDisplay();

            console.log('Novo template criado:', editorState.currentTemplate);
        }

        function generatePreview() {
            const previewData = {
                n�mero_orcamento: 'ORC-PREVIEW-001',
                n�mero_pedido: 'PED-PREVIEW-001',
                data_liberacao: new Date().toLocaleDateString('pt-BR'),
                vendedor: 'Vendedor Exemplo',
                cliente: 'Cliente Preview Ltda',
                total_geral: 1500.00
            };

            // Simular preenchimento das c�lulas mapeadas
            Object.entries(editorState.cellMappings).forEach(([field, cells]) => {
                const value = previewData[field] || '[' + getFieldDisplayName(field) + ']';
                
                cells.forEach(cellAddr => {
                    const cell = document.querySelector(`[data-address="${cellAddr}"]`);
                    if (cell) {
                        cell.textContent = value;
                        cell.style.background = 'rgba(40, 167, 69, 0.2)';
                        cell.style.fontWeight = 'bold';
                    }
                });
            });

            alert('Preview gerado! As c�lulas mapeadas foram preenchidas com dados de exemplo.');
        }

        function updatePreview() {
            // Aplicar estilos em tempo real
            const cells = document.querySelectorAll('.excel-cell');
            cells.forEach(cell => {
                cell.style.fontFamily = editorState.styling.fontFamily;
                cell.style.fontSize = editorState.styling.fontSize + 'pt';
                cell.style.color = editorState.styling.textColor;
            });

            // Aplicar cor do cabe�alho (primeiras 3 linhas)
            for (let row = 1; row <= 3; row++) {
                const headerCells = document.querySelectorAll(`[data-row="${row}"]`);
                headerCells.forEach(cell => {
                    cell.style.backgroundColor = editorState.styling.headerColor + '20'; // 20% opacity
                });
            }
        }

        async function saveTemplate() {
            if (!editorState.currentTemplate) {
                alert('Nenhum template selecionado para salvar');
                return;
            }

            const templateData = {
                ...editorState.currentTemplate,
                customizations: {
                    cellMappings: editorState.cellMappings,
                    styling: editorState.styling,
                    layout: {}
                },
                lastModified: new Date().toISOString()
            };

            try {
                const endpoint = templateData.isNew ? 
                    apiConfig.endpoints.createTemplate : 
                    apiConfig.endpoints.updateTemplate;

                const response = await fetch(apiConfig.baseUrl + endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(templateData)
                });

                const result = await response.json();

                if (result.success) {
                    alert('Template salvo com sucesso!');
                    document.getElementById('templateStatus').textContent = 'Salvo';
                    
                    if (templateData.isNew) {
                        editorState.currentTemplate.id = result.templateId;
                        editorState.currentTemplate.isNew = false;
                    }
                } else {
                    alert('Erro ao salvar template: ' + result.error);
                }
            } catch (error) {
                alert('Erro na comunica��o com servidor: ' + error.message);
            }
        }

        function exportTemplate() {
            if (!editorState.currentTemplate) {
                alert('Nenhum template para exportar');
                return;
            }

            const exportData = {
                template: editorState.currentTemplate,
                cellMappings: editorState.cellMappings,
                styling: editorState.styling,
                exportedAt: new Date().toISOString(),
                version: '1.0.0'
            };

            const blob = new Blob([JSON.stringify(exportData, null, 2)], { 
                type: 'application/json' 
            });
            
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `template-${editorState.currentTemplate.name}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            console.log('Template exportado:', exportData);
        }

        function undoAction() {
            // Implementar sistema de desfazer
            console.log('Desfazer a��o');
        }

        function redoAction() {
            // Implementar sistema de refazer
            console.log('Refazer a��o');
        }

        // Carregar estado salvo ao inicializar
        window.addEventListener('load', function() {
            const savedState = localStorage.getItem('template-editor-state');
            if (savedState) {
                try {
                    const state = JSON.parse(savedState);
                    editorState = { ...editorState, ...state };
                    updateMappingDisplay();
                    updateCellsDisplay();
                    updatePreview();
                } catch (error) {
                    console.warn('Erro ao carregar estado salvo:', error);
                }
            }
        });
    </script>
    `n</body>
</html>
